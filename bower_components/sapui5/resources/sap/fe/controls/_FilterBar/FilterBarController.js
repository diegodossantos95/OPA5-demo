/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/SearchField","sap/m/Bar","sap/m/Label","sap/ui/mdc/FilterField","sap/ui/mdc/ODataSuggestProvider","sap/ui/mdc/OperatorSuggestProvider","sap/ui/mdc/FixedValueListProvider"],function(q,B,J,D,a,S,b,L,F,O,c,d){"use strict";var e=B.extend("sap.fe.controls._FilterBar.FilterBarController",{constructor:function(f){B.apply(this,arguments);this.oFilterBar=f;this.mValueListRequests={};this.mValueLists={};this.mSuggestionLists={};}});e.prototype.getQueryParameters=function(){var Q={},s,o;Q.conditionModel=this.getConditionModel();o=this.getSearchControl();if(o){s=o.getValue();Q["$search"]=s||undefined;}return Q;};e.prototype.handleValueHelpRequest=function(E){var f=E.getSource();var i=f.getId();var C=this.getConditionModel();var s=f.getFieldPath();var o=C.clone(s);var t=this;if(this.mValueLists[i]){this.mValueLists[i].then(function(v){v.getContent()[0].setModel(o,"cm");v.getContent()[0].setBindingContext(o.createBindingContext("/"),"cm");v.open();});}else{var r=new a({text:'{sap.fe.i18n>SAPFE_RESET}'});var T=new L();var v=new D({customHeader:new b({contentMiddle:[T],contentRight:[r]}),contentWidth:"75%",contentHeight:"75%",verticalScrolling:false,resizable:false,draggable:true,endButton:new a({text:'{sap.fe.i18n>SAPFE_CANCEL}',press:function(){v.getContent()[0].getModel("cm").destroy();v.close();}}),beginButton:new a({text:'{sap.fe.i18n>SAPFE_OK}',press:function(){var C=t.getConditionModel();var l=v.getContent()[0].getController().fieldPath;var V=v.getContent()[0].getModel("cm");C.merge(l,V);v.close();}})}).addStyleClass("sapUiNoContentPadding");f.addDependent(v);var g=f.getFilterOperatorConfig();var h=g.getOperatorsForType(f.getDataType());var j=[];h.forEach(function(l){var m=g.getOperator(l);if(m.showInSuggest!==undefined&&m.showInSuggest===false){return;}var n=m.textKey||"operators."+m.name+".longText";var p=m.getTypeText(n,f._getDataType().getName().toLowerCase());if(p===n){p=m.longText;}j.push({key:l,additionalText:p});},this);var k=new sap.ui.model.json.JSONModel();k.setData(j);v.open();this.mValueLists[i]=(this.mValueListRequests[i]||this.requestValueListMetadata(f)).then(function(V){var l=new J(V);l.setProperty("/title",f.getCustomData()[0].getValue());var m=sap.ui.view({viewName:"sap.fe.controls._ValueList.ValueList",type:"XML",height:"100%",async:true,preprocessors:{xml:{bindingContexts:{valueList:l.createBindingContext("/")},models:{valueList:l}}}});m.setModel(o,"cm");m.setModel(k,"om");m.setBindingContext(k.createBindingContext("/"),"om");m.setBindingContext(o.createBindingContext("/"),"cm");m.setModel(l,"valueList");m.setModel(V.$model);var n=new J();m.setModel(n,"oTempPrivate");m.getModel("oTempPrivate").setProperty("/FilterFieldType",f._getDataType());return m.loaded().then(function(m){r.attachPress(function(E){o=C.clone(s);m.getModel("cm").setData(o.getData());m.getController().updateTableSelections();});T.setText(m.getModel("valueList").getProperty("/title"));m.getController().fieldPath=s;v.removeAllContent();v.addContent(m);return Promise.resolve(v);});});}};e.prototype.handleSuggest=function(p,E){var i=E.getSource();var f=E.getSource().getParent();var s=this.getEntitySet();var m=f.getModel().getMetaModel();var o,g={},I=f.getId();var h=f.getCustomData()[2].getValue()==='true';if(!h){o=m.getObject("/"+s+"@Org.OData.Capabilities.V1.SearchRestrictions");if(!o||o.Searchable||o.Searchable===undefined){g={$search:E.getParameters().suggestValue};}else{return;}}if(this.mSuggestionLists[I]){if(!h){this.mSuggestionLists[I].then(function(){var j=i.getBinding("suggestionRows");j.changeParameters(g);});}}else{this.mSuggestionLists[I]=(this.mValueListRequests[I]||this.requestValueListMetadata(f)).then(function(v){v.SuggestBindingParameters=JSON.stringify(g);var V=new J(v);var j=sap.ui.view({viewName:"sap.fe.controls._ValueList.SuggestionList",type:"XML",async:true,preprocessors:{xml:{bindingContexts:{valueList:V.createBindingContext("/")},models:{valueList:V}}}});j.setModel(v.$model);return j.loaded().then(function(){p.setTable(j.getContent()[0]);if(v.__sapfe){if(v.__sapfe.keyPath){p.setKeyPath(v.__sapfe.keyPath);}if(v.__sapfe.descriptionPath){p.setDescriptionPath(v.__sapfe.descriptionPath);}}});});}};e.prototype.requestValueListMetadata=function(f){var t=this;this.mValueListRequests[f.getId()]=f.getModel().getMetaModel().requestValueListInfo('/'+this.getEntitySet()+'/'+f.getFieldPath().replace(/\*/g,'')).then(function(v){var p;if(v[""]){p=v[""].Parameters;var l=f.getModel().getMetaModel().getObject('/'+t.getEntitySet()+'/'+f.getFieldPath().replace(/\*/g,'')+"@sapui.name");for(var i=0;i<p.length;i++){if(p[i].LocalDataProperty&&p[i].LocalDataProperty.$PropertyPath===l){v[""].__sapfe={keyPath:p[i].ValueListProperty,descriptionPath:v[""].$model.getMetaModel().getObject("/"+v[""].CollectionPath+"/"+p[i].ValueListProperty+"@com.sap.vocabularies.Common.v1.Text/$Path")};break;}}return v[""];}else{throw("no unqualified value list found - currently qualified value lists are not considered");}},function(E){throw(E.message);});return this.mValueListRequests[f.getId()];};e.prototype.setFilterSummary=function(){var s=this.getSearchControl(),o=this.getDraftEditStateControl(),f,g="",h=[],i;var r=this.oFilterBar.getModel("sap.fe.i18n").getResourceBundle();if(s){f=s.getValue();}if(f){g=r.getText("SAPFE_FILTERBAR_SEARCHBY")+": "+f+((h.length>0)?" | ":"");}if(o&&o.getSelectedKey()!=='0'){h.push(r.getText("SAPFE_FILTERBAR_EDITING_STATUS"));}var j=this.getFilterFieldControls();for(i=0;i<j.length;i++){if(j[i].getConditions().length>0){h.push(j[i].getCustomData()[0].getValue());}}if(h.length>0){g+=r.getText("SAPFE_FILTERBAR_FILTERBY")+" ("+h.length+"): ";for(i=0;i<h.length;i++){g+=((i>0)?', ':'')+h[i];}}if(!g){g=r.getText("SAPFE_FILTERBAR_FILTERBYNONE");}this.oFilterBar.setFilterSummary(g);};e.prototype.getEntitySet=function(){return this.oFilterBar.getEntitySetContext().substr(1);};e.prototype.getConditionModel=function(){return this.oFilterBar.getModel(this.oFilterBar.getConditionModelName());};e.prototype.getDraftEditStateControl=function(){var C=this.oFilterBar.getInnerFilterBar().getContent();var f;for(var i=0;i<C.length;i++){f=C[i].getItems()[1];if(f.getBinding("items")&&f.getBinding("items").getPath()==="/editStates"&&f.getBinding("items").getModel()===f.getModel("$draft")){return f;}}};e.prototype.getSearchControl=function(){var C=this.oFilterBar.getInnerFilterBar().getContent();var f;for(var i=0;i<C.length;i++){f=C[i].getItems()[1];if(f instanceof S){return f;}}};e.prototype.getFilterFieldControls=function(){var C=this.oFilterBar.getInnerFilterBar().getContent();var f,g=[];for(var i=0;i<C.length;i++){f=C[i].getItems()[1];if(f instanceof F){g.push(f);}}return g;};e.prototype.getAppState=function(){var C=this.getConditionModel(),o=this.getDraftEditStateControl(),s=this.getSearchControl(),A={};if(C){A.conditionModel=C.serialize();}if(o){A.draftEditState=o.getSelectedKey();}if(s){A.search=s.getValue();}return A;};e.prototype.setAppState=function(A){var C=this.getConditionModel(),o=this.getDraftEditStateControl(),s=this.getSearchControl();if(A.conditionModel){if(C){C.parse(A.conditionModel);}else{throw("app state contains condition model state but condition model not yet set");}}if(A.draftEditState&&o){o.setSelectedKey(A.draftEditState);}if(A.search&&s){s.setValue(A.search);}};e.prototype.createSuggestProviders=function(){var f=this.getFilterFieldControls(),s,g,o;for(var i=0;i<f.length;i++){o=f[i];s=o.getCustomData()[1].getValue()==='true';g=o.getCustomData()[2].getValue()==='true';if(s){new O({control:o,enableFilterSuggest:false,suggest:this.handleSuggest.bind(this)});}else if(g){new d({control:o,enableFilterSuggest:true,suggest:this.handleSuggest.bind(this)});}}};return e;});
