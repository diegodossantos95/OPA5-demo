/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/ODataListBinding","sap/ui/model/odata/v4/Context","sap/ui/model/Filter","sap/ui/base/ManagedObject","sap/ui/model/ChangeReason","sap/ui/model/resource/ResourceModel","sap/fe/core/internal/testableHelper"],function(J,O,C,F,M,a,R,t){"use strict";var b="_$DraftModel";var A=false;var c=/( and )?\(*IsActiveEntity eq.*$/g;var p={};t.testableStatic(function(){A=true;},"addPrivateDataToModel");function s(w,K,x){var y=typeof w==="string"?w:w.getId(),P=p[y]=p[y]||{};P[K]=x;if(A&&!w[b]){w[b]=P;}}function g(w,K){var x=typeof w==="string"?w:w.getId();return p[x]&&p[x][K];}var E={ALL:"0",UNCHANGED:"1",OWN_DRAFT:"2",LOCKED:"3",UNSAVED_CHANGES:"4"};t.testableStatic(E,"EDITSTATE");function d(w){var x="";switch(w){case E.UNCHANGED:x="(IsActiveEntity eq true and HasDraftEntity eq false)";break;case E.OWN_DRAFT:x="(IsActiveEntity eq false)";break;case E.LOCKED:x="(IsActiveEntity eq true and SiblingEntity/IsActiveEntity eq null and DraftAdministrativeData/InProcessByUser ne '')";break;case E.UNSAVED_CHANGES:x="(IsActiveEntity eq true and SiblingEntity/IsActiveEntity eq null and DraftAdministrativeData/InProcessByUser eq '')";break;default:x="(IsActiveEntity eq false or SiblingEntity/IsActiveEntity eq null)";break;}return x;}t.testableStatic(d,"getFilterForEditState");function e(w){var x=w.getMetaModel(),y=g(w,"aEntitySets"),z=y?Promise.resolve(y):x&&x.requestObject("/").then(function(B){var P=[];Object.keys(B).forEach(function(G){var H=B[G],I;if(H.$kind==="EntitySet"){I=x.requestObject("/"+G+"@");P.push(I.then(function(K){var L={};L["@"]=K;L["@sapui.name"]=G;return L;}));}});return Promise.all(P);});return z;}function f(w,x){var y=w.getModel();return y.bindContext(x+"(...)",w);}function h(){if(!this.getProperty("IsActiveEntity")){var w=f(this,arguments[0]);return w.execute().then(function(){return w;});}else{throw new Error("The activation action cannot be executed on an active document");}}function i(w){if(!this.getProperty("IsActiveEntity")){var x=f(this,arguments[0]);w=arguments[1];if(typeof w==="undefined"){w="";}x.setParameter("SideEffectsQualifier",w);return x.execute().then(function(){return x;});}else{throw new Error("The preparation action cannot be executed on an active document");}}function j(){if(!this.getProperty("IsActiveEntity")){var w=f(this,arguments[0]);return w.execute().then(function(){return w;});}else{throw new Error("The validation function cannot be executed on an active document");}}function k(w){if(this.getProperty("IsActiveEntity")){var x=f(this,arguments[0]);w=arguments[1];x.setParameter("PreserveChanges",w);return x.execute().then(function(){return x;});}else{throw new Error("The edit action cannot be executed on a draft document");}}var o={"ActivationAction":h,"PreparationAction":i,"ValidationFunction":j,"EditAction":k};function l(w,x){var y=x["@"]["@com.sap.vocabularies.Common.v1.DraftRoot"];Object.keys(y).forEach(function(z){var B=y[z];w["executeDraft"+z]=o[z].bind(w,B);});}function m(w){return e(w).then(function(x){var y=x.filter(function(B){var G=B["@"]||{};return G.hasOwnProperty("@com.sap.vocabularies.Common.v1.DraftRoot")||G.hasOwnProperty("@com.sap.vocabularies.Common.v1.DraftNode");}),z=Array.isArray(y)&&y.length>0;if(z){s(w,"aEntitySets",x);s(w,"aDraftEntitySets",y);}return z;});}function n(w,x){var y=d(w,"");if(x){x="("+x+") and "+y;}else{x=y;}return x;}function _(w){var x={},L={},y=-1,z=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),B={"editStates":[{id:E.ALL,name:z.getText("SAPFE_DRAFT_ALL_FILTER")},{id:E.UNCHANGED,name:z.getText("SAPFE_DRAFT_UNCHANGED_FILTER")},{id:E.OWN_DRAFT,name:z.getText("SAPFE_DRAFT_OWN_DRAFT_FILTER")},{id:E.LOCKED,name:z.getText("SAPFE_DRAFT_LOCKED_FILTER")},{id:E.UNSAVED_CHANGES,name:z.getText("SAPFE_DRAFT_UNSAVED_CHANGES_FILTER")}],"entitySets":{}},I,G=g(w,"aDraftEntitySets");s(w,"mListBindings",L);t.testableStatic(function(w){return g(w,"mListBindings");},"getOverwrittenListBindings");G.forEach(function(H){B.entitySets[H["@sapui.name"]]={editState:"0"};});I=new J(B);s(w,"oDraftAccessModel",I);w.getDraftAccessModel=r;I.attachPropertyChange(function(H){var P=H.getParameters(),K=P&&(P.path.indexOf("/entitySets")===0?P.path.split("/")[2]:false);if(K){K="/"+K;Object.keys(L).forEach(function(N){var Q=L[N],S=Q.mParameters,T="",U="",V=[];if(Q instanceof O&&Q.getPath()===K){T=S["$filter"];if(T){V=T.match(c);if(Array.isArray(V)&&V[0]){U=V[0];T=T.replace(U,"");T=T.substr(1).slice(0,-1);}}S["$filter"]=n(P.value,T);Q.applyParameters(S);Q.reset(sap.ui.model.ChangeReason.Change);}});}});x.bindList=w.bindList;w.bindList=function(P,H,S,K,N){var Q=I.getObject("/entitySets"+P),T,U;if(Q){var V="";N=N||{};V=N.$expand;if(V){if(V.indexOf("DraftAdministrativeData")<0){V+=",DraftAdministrativeData";}}else{V="DraftAdministrativeData";}N.$expand=V;N.$filter=n(Q.editState,N.$filter);}arguments[4]=N;T=x.bindList.apply(this,arguments);if(Q){U=T.changeParameters;T.changeParameters=function(N){var Q=I.getObject("/entitySets"+P);N.$filter=n(Q.editState,N.$filter);return U.call(this,N);};L[++y]=T;T.destroy=(function(W){return function(){delete L[W];return O.prototype.destroy.apply(this,arguments);};})(y);}return T;};x.create=C.create;C.create=function(w,H,P,K,N){var Q=x.create.apply(null,arguments),S=false;if(g(w,"bUpgraded")&&P){G.forEach(function(T){var U=!S&&P.indexOf(T["@sapui.name"])===1;if(U){S=true;l(Q,T);}});}return Q;};x.modelDestroy=w.destroy;w.destroy=function(){delete p[this.getId()];return x.modelDestroy.apply(this,arguments);};s(w,"bUpgraded",true);}function u(w){return m(w).then(function(x){if(x){_(w);}else{throw new Error("The model is not draft enabled");}});}function q(w){return m(w).then(function(x){if(x){_(w);}return x;});}function r(){return g(this,"oDraftAccessModel");}var v={};var D={upgrade:u,upgradeOnDemand:q,isDraftModel:m,EDITSTATE:E};return D;},true);
