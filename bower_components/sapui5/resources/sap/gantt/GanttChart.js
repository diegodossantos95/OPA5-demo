/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/Device","sap/gantt/GanttChartBase","sap/ui/core/Core","sap/ui/table/TreeTable","sap/ui/table/Row","sap/gantt/misc/Utility","sap/ui/core/theming/Parameters","sap/gantt/shape/SelectedShape","sap/gantt/shape/ext/rls/SelectedRelationship","sap/gantt/drawer/ShapeInRow","sap/gantt/drawer/ShapeCrossRow","sap/gantt/drawer/CursorLine","sap/gantt/drawer/NowLine","sap/gantt/drawer/VerticalLine","sap/gantt/drawer/AdhocLine","sap/gantt/drawer/CalendarPattern","sap/gantt/drawer/ExpandedBackground","sap/gantt/config/TimeAxis","sap/gantt/misc/AxisTime","sap/gantt/misc/AxisOrdinal","sap/gantt/misc/Format","sap/gantt/eventHandler/AutoScrollHandler","sap/gantt/eventHandler/MouseWheelHandler","sap/gantt/eventHandler/TimePeriodZoomHandler","sap/gantt/axistime/AxisTimeStrategyBase","sap/gantt/axistime/ProportionZoomStrategy","sap/gantt/config/TimeHorizon","sap/gantt/misc/ShapeSelectionModel","sap/gantt/misc/ShapeManager","sap/gantt/shape/Group","sap/gantt/eventHandler/ShapeResizeHandler","sap/ui/thirdparty/d3"],function(q,D,G,C,T,R,U,P,S,a,b,c,e,N,V,A,f,E,h,m,n,F,o,M,p,r,s,t,u,v,w,z){"use strict";var B=G.extend("sap.gantt.GanttChart",{metadata:{aggregations:{_treeTable:{type:"sap.ui.table.TreeTable",multiple:false,visibility:"hidden"}}}});B.prototype.init=function(){G.prototype.init.apply(this,arguments);q.sap.measure.start("GanttChart init","GanttPerf:GanttChart init function");this._oTT=new T(this.getId()+"-table",{visibleRowCountMode:"Auto",minAutoRowCount:1,columnHeaderVisible:false});this._oTT.setUseFlatMode(true);this._bJSONTreeBinding=true;this._oRowStatusMap={};this._oTT._bVariableRowHeightEnabled=true;var d=this;this._oTT._collectRowHeights=function(H){var g=T.prototype._collectRowHeights.apply(this,arguments);if(H){return g;}d._aHeights=g;if(d._aHeights[0]!==undefined&&d._aHeights[0]!==0){d._iInferedBaseRowHeightOnTT=d._aHeights[0];}var j=d.getBaseRowHeight();var k=this.getFirstVisibleRow();var l=d._aHeights.length;var x=j;var y=d._getDrawingData([k,k+l-1]);if(y&&y.length>0){x=y[0].rowSpan*j;}for(var i=0;i<l;i++){var I=this.getContextByIndex(k+i);if(I){var J;if(d._bJSONTreeBinding){J=I.getObject();}else if(d._aFilteredRowData){J=d._aFilteredRowData[i];}var K=J?J.uid:undefined;if(K&&d._oRowStatusMap[K]){d._aHeights[i]=d._oRowStatusMap[K].visibleRowSpan*j;}else{d._aHeights[i]=x;}}else{d._aHeights[i]=j;}}return d._aHeights;};this._oColumn=new sap.ui.table.Column({template:new sap.m.Label()});this._oTT.addColumn(this._oColumn);this.setAggregation("_treeTable",this._oTT);this._oTT.attachEvent("_rowsUpdated",this._onTTRowUpdate.bind(this));this._oTT.attachRowSelectionChange(this._onRowSelectionChange,this);this._oTT.addEventDelegate({onAfterRendering:this._bindScrollLogicForTT},this);this._oTT.addEventDelegate({onAfterRendering:this._initialSvgDrawing},this);this._oShapeInRowDrawer=new b();this._oShapeCrossRowDrawer=new c();this._oCursorLineDrawer=new e();this._oCalendarPatternDrawer=new f();this._oExpandedBackgroundDrawer=new E();this._oAxisOrdinal=undefined;this._aFilteredRowData=undefined;this._oStatusSet=null;this._nLowerRange=0;this._nUpperRange=0;this._oShapeSelection=new u({selectionMode:this.getShapeSelectionMode(),ganttChart:this});this._oShapeManager=new v(this);this._bMouseDown=false;this._bDragging=false;this._bDragStart=false;this._oDraggingData=undefined;this._lastHoverRowIndex=undefined;this._oChartSchemesConfigMap={};this._oChartSchemesConfigMap[sap.gantt.config.DEFAULT_CHART_SCHEME_KEY]=sap.gantt.config.DEFAULT_CHART_SCHEME;this._oObjectTypesConfigMap={};this._oObjectTypesConfigMap[sap.gantt.config.DEFAULT_OBJECT_TYPE_KEY]=sap.gantt.config.DEFAULT_OBJECT_TYPE;this._fExtendFactor=0.382;this._setAxisTimeStrategy(new s());this._mTimeouts={};this._bSuppressSyncEvent=false;this._bSuppressSetVisibleHorizon=false;this._oAutoScrollHandler=new o();this._oMouseWheelHandler=new M(this);this._oTimePeriodZoomHandler=new p(this);this._oShapeResizeHandler=new z(this);this.setTableProperties(this.mDefaultTableProperties);q.sap.measure.end("GanttChart init");};B.prototype.setAxisTimeStrategy=function(d){this._setAxisTimeStrategy(d);this._oStatusSet=null;this._draw(true);return this;};B.prototype._setAxisTimeStrategy=function(d){this.setAggregation("axisTimeStrategy",d,true);this._createAxisTime(d);d.attachEvent("_redrawRequest",this._onRedrawRequest,this);};B.prototype._onRedrawRequest=function(d){var g=d.getParameter("forceUpdate");var i=d.getParameter("valueBeforeChange");if(d.getParameter("reasonCode")==="visibleHorizonUpdated"&&i){this._oLastVisibleHorizon=i;}this.redraw(g);};B.prototype.setTimeAxis=function(d){this.setProperty("timeAxis",d,true);if(d){var g=d.getZoomStrategy();this.setAxisTimeStrategy(new s({totalHorizon:d.getPlanHorizon(),visibleHorizon:d.getInitHorizon(),timeLineOption:g[d.getGranularity()],coarsestTimeLineOption:g[d.getCoarsestGranularity()],finestTimeLineOption:g[d.getFinestGranularity()],timeLineOptions:g}));}else{this.setAxisTimeStrategy(null);}};B.prototype.setLocale=function(l){this.setProperty("locale",l,true);var d=this.getAxisTime();if(d){d.setLocale(l);this._draw(true);}return this;};B.prototype.setChartSchemes=function(d){this.setProperty("chartSchemes",d,true);this._oChartSchemesConfigMap={};if(d){for(var i=0;i<d.length;i++){this._oChartSchemesConfigMap[d[i].getKey()]=d[i];}}this._draw(true);return this;};B.prototype.setObjectTypes=function(O){this.setProperty("objectTypes",O,true);this._oObjectTypesConfigMap={};if(O){for(var i=0;i<O.length;i++){this._oObjectTypesConfigMap[O[i].getKey()]=O[i];}}this._draw(true);return this;};B.prototype.setSelectionMode=function(d){this.setProperty("selectionMode",d,true);this.setShapeSelectionMode(d);switch(d){case sap.gantt.SelectionMode.Multiple:case sap.gantt.SelectionMode.MultiWithKeyboard:this.setTableProperties({selectionMode:sap.ui.table.SelectionMode.MultiToggle});break;case sap.gantt.SelectionMode.None:case sap.gantt.SelectionMode.Single:this.setTableProperties({selectionMode:d});break;}return this;};B.prototype.setShapeSelectionMode=function(d){this.setProperty("shapeSelectionMode",d,true);this._oShapeSelection.setSelectionMode(d);return this;};B.prototype.setTableProperties=function(d){G.prototype.setTableProperties.apply(this,arguments);this._oTT.setSelectionBehavior(sap.ui.table.SelectionBehavior.RowOnly);return this;};B.prototype._createAxisTime=function(d){if(d){d.createAxisTime(this.getLocale());this._nLowerRange=Math.ceil(this.getAxisTime().getViewRange()[0]);this._nUpperRange=Math.ceil(this.getAxisTime().getViewRange()[1]);}};B.prototype.setShapes=function(d){this.setProperty("shapes",d,true);if(d&&d.length>0){this._oShapeManager.instantiateShapes(d);this._draw(true);}return this;};B.prototype.setTimeZoomRate=function(d){this.setProperty("timeZoomRate",d,true);var g=this.getAxisTimeStrategy();if(g.onSetTimeZoomRate){g.onSetTimeZoomRate(d);}return this;};B.prototype.redraw=function(d){if(!this._initHorizonApplied){return;}if(d){this.resetWidthInfo();}this._draw(d);};B.prototype.resetWidthInfo=function(){this.getAxisTime().setViewOffset(0);this._oStatusSet=null;this._nLowerRange=Math.ceil(this.getAxisTime().getViewRange()[0]);this._nUpperRange=Math.ceil(this.getAxisTime().getViewRange()[1]);};B.prototype.updateRelationships=function(d){var g=this.getBinding("relationships");if(g){var i=g.getContexts(0,0);if(i&&i.length>0){this._aRelationshipsContexts=i;}}this._prepareRelationshipDataFromModel();};B.prototype.addRelationship=function(d){q.sap.log.error("The control manages the relationships aggregation. The method \"addRelationship\" cannot be used programmatically!");};B.prototype.insertRelationship=function(i,d){q.sap.log.error("The control manages the relationships aggregation. The method \"insertRelationship\" cannot be used programmatically!");};B.prototype.removeRelationship=function(d){q.sap.log.error("The control manages the relationships aggregation. The method \"removeRelationship\" cannot be used programmatically!");};B.prototype.getRelationships=function(){q.sap.log.error("The control manages the relationships aggregation. The method \"getRelationships\" cannot be used programmatically!");};B.prototype.destroyRelationships=function(){q.sap.log.error("The control manages the relationships aggregation. The method \"destroyRelationships\" cannot be used programmatically!");};B.prototype.indexOfRelationship=function(d){q.sap.log.error("The control manages the relationships aggregation. The method \"indexOfRelationship\" cannot be used programmatically!");};B.prototype.removeAllRelationships=function(){q.sap.log.error("The control manages the relationships aggregation. The method \"removeAllRelationships\" cannot be used programmatically!");};B.prototype._bindAggregation=function(d,g){if(d=="rows"&&g){var i=this.getModel(g.model);var j=this.getBindingContext(g.model);if(j&&i){g.path=i.resolve(g.path,j);}this._getConfiguredRowKeys(g);this._oTT.bindRows(g);this._bJSONTreeBinding=(i instanceof sap.ui.model.json.JSONModel);}else{return sap.ui.core.Control.prototype._bindAggregation.apply(this,arguments);}};B.prototype.onBeforeRendering=function(){this._bTableReady=false;this._iSvgHeight=0;this._detachEvents();};B.prototype._detachEvents=function(){var d=q(this.getDomSelectorById("svg-ctn"));var g=q(this.getDomSelectorById("header"));d.unbind("MozMousePixelScroll.sapUiTableMouseWheel",this._onMouseWheel);d.unbind("wheel.sapUiTableMouseWheel",this._onMouseWheel);g.unbind("MozMousePixelScroll.sapUiTableMouseWheel",this._onMouseWheel);g.unbind("wheel.sapUiTableMouseWheel",this._onMouseWheel);d.unbind("mouseleave",this._onSvgMouseLeave);d.unbind("mouseenter",this._onSvgMouseEnter);d.unbind("mousedown",this._onSvgMouseDown);d.unbind("mousemove",this._onSvgMouseMove);d.unbind("mouseup",this._onSvgMouseUp);d.unbind("dblclick",this._onSvgDoubleClick);q(document.body).unbind("keydown.ganttKeyboardEvent");if(D.support.touch){d.unbind("touchstart",this._onSvgTouchstart);d.unbind("touchend",this._onSvgTouchend);d.unbind("touchmove",this._onSvgTouchmove);g.unbind("touchstart",this._onSvgTouchstart);g.unbind("touchend",this._onSvgTouchend);g.unbind("touchmove",this._onSvgTouchmove);}this._oTimePeriodZoomHandler.detachEvents();};B.prototype.onAfterRendering=function(){this._attachEvents();};B.prototype._attachEvents=function(){var d=q(this.getDomSelectorById("svg-ctn"));var g=q(this.getDomSelectorById("header"));if(D.browser.firefox){d.bind("MozMousePixelScroll.sapUiTableMouseWheel",this._onMouseWheel.bind(this));g.bind("MozMousePixelScroll.sapUiTableMouseWheel",this._onMouseWheel.bind(this));}else{d.bind("wheel.sapUiTableMouseWheel",this._onMouseWheel.bind(this));g.bind("wheel.sapUiTableMouseWheel",this._onMouseWheel.bind(this));}d.bind("mouseenter",this._onSvgMouseEnter.bind(this));d.bind("mouseleave",this._onSvgMouseLeave.bind(this));d.bind("mousedown",this._onSvgMouseDown.bind(this));d.bind("mousemove",this._onSvgMouseMove.bind(this));d.bind("mouseup",this._onSvgMouseUp.bind(this));d.bind("dblclick",this._onSvgDoubleClick.bind(this));q(document.body).bind("keydown.ganttKeyboardEvent",this._onKeyDown.bind(this));if(D.support.touch){d.bind("touchstart",this._onSvgTouchstart.bind(this));d.bind("touchend",this._onSvgTouchend.bind(this));d.bind("touchmove",this._onSvgTouchmove.bind(this));g.bind("touchstart",this._onSvgTouchstart.bind(this));g.bind("touchend",this._onSvgTouchend.bind(this));g.bind("touchmove",this._onSvgTouchmove.bind(this));}this._oTimePeriodZoomHandler.attachEvents();};B.prototype._getMouseOrTouchPoint=function(d){if(d.targetTouches&&d.targetTouches.length>0){return d.targetTouches[d.targetTouches.length-1];}else if(d.changedTouches&&d.changedTouches.length>0){return d.changedTouches[d.changedTouches.length-1];}return{"pageX":d.pageX,"pageY":d.pageY};};B.prototype._onTouchScrollStart=function(d){if(D.system.combi||D.system.phone||D.system.tablet){this._aTouchStartPosition=null;this._bIsScrollVertical=null;var g=this._getMouseOrTouchPoint(d);this._aTouchStartPosition=[g.pageX,g.pageY];var i=this.getTTVsbDom();if(i){this._iTouchScrollTop=i.scrollTop;}var H=this.getTTHsbDom();if(H){this._iTouchScrollLeft=H.scrollLeft;}}};B.prototype._onTouchScroll=function(d){if((D.system.combi||D.system.phone||D.system.tablet)&&this._aTouchStartPosition){var g=this._getMouseOrTouchPoint(d);var i=(g.pageX-this._aTouchStartPosition[0]);var j=(g.pageY-this._aTouchStartPosition[1]);if(this._bIsScrollVertical==null){this._bIsScrollVertical=Math.abs(j)>Math.abs(i);}if(this._bIsScrollVertical){var k=sap.ui.table.SharedDomRef.VerticalScrollBar;var l=this._oTT.getDomRef(k);if(l){var x=this._iTouchScrollTop-j;if(x>0&&x<(this._oTT.getDomRef(k+"-content").clientHeight-l.clientHeight)-1){this._preventBubbleAndDefault(d);}l.scrollTop=x;}}else{var H=sap.ui.table.SharedDomRef.HorizontalScrollBar;var y=this._oTT.getDomRef(H);if(y){var I=this._iTouchScrollLeft-i;if(I>0&&I<(this._oTT.getDomRef(H+"-content").clientWidth-y.clientWidth)-1){this._preventBubbleAndDefault(d);}y.scrollLeft=I;}}this._bScrolling=true;}};B.prototype._onMouseWheel=function(d){var i=this._oMouseWheelHandler.handleEvent(d);if(i){this.fireEvent("_visibleHorizonUpdate",{reasonCode:"mouseWheelZoom",eventData:{originEvent:d}});}};B.prototype.syncMouseWheelZoom=function(d){this._bSuppressSyncEvent=true;this._oMouseWheelHandler.handleEvent(d.originEvent);};B.prototype.handleExpandChartChange=function(d,g,i){i=i?i:this._oTT.getSelectedIndices();if(i.length>0){this._updateRowStatusMap(d,g,i);this._oTT.updateRows();}};B.prototype.invertRowExpandStatus=function(d,g){d=d?d:this._oTT.getSelectedIndices();if(d.length>0&&g){for(var i=0;i<d.length;i++){var I=d[i];var j=this._ifRowExpanded(I,g);if(j!==null){this._updateRowStatusMap(!j,g,[I]);}}this._oTT.updateRows();}};B.prototype._ifRowExpanded=function(i,d){var g=this._oTT;var j=g.getBinding();var k=j.getContextByIndex(i);var l=null;if(k){var x=k.getObject();var y=x.uid;var H=this._getRowSpanWithData(x,d),I=H.name;if(y&&this._oRowStatusMap[y]&&this._oRowStatusMap[y][I]){l=true;}else{l=false;}}return l;};B.prototype._updateRowStatusMap=function(d,g,j){var k=this._oTT;var l=k.getBinding();for(var i=0;i<j.length;i++){var I=j[i];var x=l.getContextByIndex(I);if(x){var y;if(this._bJSONTreeBinding){y=x.getObject();}else{y=this._aFilteredRowData[I].data;}var H=y.uid;if(H){var J=this._getRowSpanWithData(y,g),K=J.name;if(d){if(this._oRowStatusMap[H]){this._oRowStatusMap[H][K]=J;}else{this._oRowStatusMap[H]={};this._oRowStatusMap[H][K]=J;}}else if(!d&&this._oRowStatusMap[H]){delete this._oRowStatusMap[H][K];delete this._oRowStatusMap[H].visibleRowSpan;if(q.isEmptyObject(this._oRowStatusMap[H])){delete this._oRowStatusMap[H];continue;}}this._getDrawingData([I,I]);}}}};B.prototype.isRowExpanded=function(){var d=!q.isEmptyObject(this._oRowStatusMap);return d;};B.prototype._getRowSpanWithData=function(d,g){var i=1,j=null,k=null,l=this.getRowTypeName();for(var x=0;x<g.length;x++){var y=g[x];var H;if(this._oChartSchemesConfigMap[y]&&this._oChartSchemesConfigMap[y].getModeKey()){H=this._oChartSchemesConfigMap[y].getModeKey();}else{H=this.getMode();}if(this._oObjectTypesConfigMap[d[l]]&&this._oObjectTypesConfigMap[d[l]].getExpandedChartSchemeKeys().length>0){var I=this._oObjectTypesConfigMap[d[l]].getExpandedChartSchemeKeys();if($.inArray(y,I)>-1){var J=this._collectDataNameForValidChartScheme(y,H);if(J){k=J.drawData;i+=J.rowSpan;j=y;}}}}return{rowSpan:i,name:j,data:k};};B.prototype._updateTableRowHeights=function(){if(this._aHeights){this._oTT._updateRowHeights(this._aHeights,false);}};B.prototype.notifySourceChange=function(){this._oTT.setFirstVisibleRow(0);this.resetRowStatusMap();};B.prototype.resetRowStatusMap=function(){this._oRowStatusMap={};};B.prototype._collectDataNameForValidChartScheme=function(d,g){if(this._oChartSchemesConfigMap[d]){var i=[];var j=this._oChartSchemesConfigMap[d].getShapeKeys();var k=this._oChartSchemesConfigMap[d].getRowSpan();var l=this._oChartSchemesConfigMap[d].getRowIndexName();var x=this._oShapeManager.mShapeConfig;q.each(j,function(K,y){if(x[y]){var H=x[y].getModeKeys();if((H&&H.length>0&&$.inArray(g,H)>-1)||H.length==0||g==sap.gantt.config.DEFAULT_MODE_KEY){i.push(x[y].getShapeDataName());}}});if(i.length>0&&k>=1){return{"drawData":i,"rowSpan":k,"rowIndexName":l};}}};B.prototype._composeParameterForClickPosition=function(d){var g=q(this.getDomSelectorById("svg"));var i=this._getMouseXPos(d);var j=this._getSvgCoodinateByDiv(g[0],i,d.pageY);var x=i-g.offset().left||d.offsetX;var y=d.pageY-g.offset().top||d.offsetY;if(!this._oAxisOrdinalOfVisibleRow){return null;}var k=this.getAxisTime().viewToTime(x);var l=this._oAxisOrdinalOfVisibleRow.viewToRowIndex(y,this._getVisibleRowCount())+this._oTT.getFirstVisibleRow();var H=U.getRowDatumByEventTarget(d.target);var L=H?H.objectInfoRef:null;var I=false;var J=this._oAxisOrdinal.viewToElementIndex(y);var K=this._aFilteredRowData[J];if(K&&K.index&&K.index!==0){I=true;}var O={"startTime":k,"svgPoint":j,"leadingRowNum":l,"leadingRowInfo":L,"rowIndex":J,"rowInfo":K,"isExpandedRow":I};return O;};B.prototype.getAllRowData=function(){var d=this._oTT.getBinding("rows");return this._getDrawingData([0,d.getLength()-1]);};B.prototype.getAllSelections=function(){var d=this.getSelectedRows();var g=this.getSelectedShapes();var i=this.getSelectedRelationships();var j={"rows":d,"shapes":g,"relationships":i};return j;};B.prototype.getSelectedRows=function(){var d=[];var g=this._oTT.getSelectedIndices();var k=this.getAllRowData();var l=[];for(var i=0;i<k.length;i++){if(k[i]&&!k[i].parentId){l.push(k[i]);}}for(var j=0;j<g.length;j++){if(g[j]>-1&&g[j]<l.length&&l[g[j]]){d.push(l[g[j]]);}}return d;};B.prototype.getSelectedShapes=function(){var d=this._oShapeSelection.getSelectedShapeDatum();var g={};d.forEach(function(i){var j=this._oShapeSelection.getRowDatumByShapeUid(i.uid,this),k=U.getShapeDataNameByUid(i.uid);var l=g[k]||[];l.push({"shapeUid":i.uid,"shapeData":i,"objectInfoRef":j});g[k]=l;}.bind(this));return g;};B.prototype.getSelectedRelationships=function(){return this._oShapeSelection.getSelectedRelationships();};B.prototype.getRowByShapeUid=function(d){return this._oShapeSelection.getRowDatumByShapeUid(d,this);};B.prototype.selectShapes=function(i,d){var g=this._oShapeSelection.selectShapes(i,d);if(g){this._drawSelectedShapes();}return this;};B.prototype.selectByUid=function(d){var g=d;var i=this._oShapeSelection.selectShapeByUid(d,this);if(i){this._drawSelectedShapes();}return this;};B.prototype.deselectShapes=function(i){var d=this._oShapeSelection.deselectShapes(i);if(d){this._drawSelectedShapes();}return this;};B.prototype.selectRowsAndShapes=function(d,g){if(!d||d.length===-1){this.deselectShapes();this.deselectRows();return this;}var j=[];var k=U.getRowDatumById(d,this.getId());q.each(k,function(_,x){var y=x.shapeData;for(var i=0;i<y.length;i++){var H=y[i];if(this.isShapeSelectable(H)){j.push(H.__id__);}}}.bind(this));this._oShapeSelection.selectUnderlyingTableRows(d,this._oTT);var l=this._oShapeSelection.selectShapes(j,g);if(l){this._drawSelectedShapes();}return this;};B.prototype.selectRelationships=function(i,d){var g=U.getShapeDatumById(i,this.getId());var j=this._oShapeSelection.selectRelationships(g,d);if(j){this._drawSelectedShapes();}return this;};B.prototype.deselectRelationships=function(i){var d=this._oShapeSelection.deselectRelationships(i);if(d){this._drawSelectedShapes();}return this;};B.prototype.selectRows=function(i,d){this._oShapeSelection.selectUnderlyingTableRows(i,this._oTT,d);return this;};B.prototype.deselectRows=function(i){this._oShapeSelection.deselectUnderlyingTableRows(i,this._oTT);return this;};B.prototype.expandToLevel=function(l){this._oTT.expandToLevel(l);return this;};B.prototype.expand=function(i){this._oTT.expand(i);return this;};B.prototype.collapse=function(i){this._oTT.collapse(i);return this;};B.prototype.getVisibleRowCount=function(){return this._oTT.getVisibleRowCount();};B.prototype._onRowSelectionChange=function(d){this.fireRowSelectionChange({originEvent:d});};B.prototype._selectionChange=function(d,g,i,j){var k=U.getRowDatumByEventTarget(j.target);var l=k?k.objectInfoRef:null;var x=this._oShapeSelection.changeShapeSelection(d,l,g,this._bDragging,this._oShapeResizeHandler.getIsResizing());return x;};B.prototype._syncTTSelection=function(d){q.sap.measure.start("GanttChart syncTTSelection","GanttPerf:GanttChart syncTTSelection function");var g=d.shiftKey;var i=d.ctrlKey;var j=q(this.getDomSelectorById("svg"))[0];var k=this._getSvgCoodinateByDiv(j,this._getMouseXPos(d),d.pageY);var l=parseInt(this._oAxisOrdinalOfVisibleRow.viewToElementIndex(k.y),10);if(l<0){return false;}var x=this._oTT.getRows();var I,y=d3.select("#"+x[l].getId());if(l<x.length&&y&&y.attr("data-sap-ui-rowindex")){I=this._oTT.getFirstVisibleRow()+parseInt(y.attr("data-sap-ui-rowindex"),10);}var H=this._oTT.getSelectionMode();if(I>=0&&H!==sap.ui.table.SelectionMode.None){if(H===sap.ui.table.SelectionMode.Single){if(!this._oTT.isIndexSelected(I)){this._oTT.setSelectedIndex(I);}else{this._oTT.clearSelection();}}else{i=true;if(g){var J=this._oTT.getSelectedIndex();if(J>=0){if(J<I){this._oTT.addSelectionInterval(J,I);}else{this._oTT.addSelectionInterval(I,J);}}else{this._oTT.setSelectedIndex(I);}}else if(!this._oTT.isIndexSelected(I)){if(i){this._oTT.addSelectionInterval(I,I);}else{this._oTT.setSelectedIndex(I);}}else if(i){this._oTT.removeSelectionInterval(I,I);}else if(this._oTT.getSelectedIndices().length>1){this._oTT.setSelectedIndex(I);}}}q.sap.measure.end("GanttChart syncTTSelection");};B.prototype._setEventStatus=function(d){switch(d){case"dragEnter":this._bDragStart=true;break;case"mouseDown":this._bMouseDown=true;this._bDragging=false;this._bDragStart=false;this._bScrolling=false;break;case"mouseUp":this._bMouseDown=false;this._bScrolling=false;break;case"shapeDragStart":this._bDragStart=true;break;case"shapeDragging":if(this._bDragStart){this._bDragging=true;}break;case"shapeDragEnd":this._bDragging=false;this._bDragStart=false;this._oDraggingData=undefined;break;case"dragLeave":this._bDragStart=false;break;default:break;}};B.prototype._handleShapeDragStart=function(d){var g=q(this.getDomSelectorById("svg"));var j=d3.select(d.target).datum();var k=d.target.getAttribute("class").split(" ")[0];var l=this._oShapeManager.isShapeDraggable(j,k);if(j&&l){var H=this._oShapeSelection.getRowDatumByShapeUid(j.uid,this);if(H){var x=this._getMouseXPos(d)-g.offset().left||d.offsetX;var y=d.pageY-g.offset().top||d.offsetY;var I,J;if(d.target.getAttribute("x")&&d.target.getAttribute("width")){I=parseInt(d.target.getAttribute("x"),10);J=parseInt(d.target.getAttribute("width"),10);}else if(j.startTime){var K=this.getAxisTime().timeToView(F.abapTimestampToDate(j.startTime));var L=this.getAxisTime().timeToView(F.abapTimestampToDate(j.endTime));if(C.getConfiguration().getRTL()){I=L;J=(K-L)>0?(K-L):1;}else{I=K;J=(L-K)>0?(L-K):1;}}else{I=x;J=1;}var O={"x":x,"y":y,"shapeX":I,"shapeWidth":J};var Q=[];Q.push({"shapeData":j,"objectInfo":H});var W=this._oShapeSelection.getSelectedShapeDatum();for(var i=0;i<W.length;i++){if(W[i].uid!==j.uid&&this._oShapeManager.isShapeDraggable(W[i])){Q.push({"shapeData":W[i],"objectInfo":this._oShapeSelection.getRowDatumByShapeUid(W[i].uid,this)});}}this._oDraggingData={"sourceShapeData":Q,"dragStartPoint":O,"sourceSvgId":this.getId(),"targetSvgId":this.getId(),"domObject":this._getDraggingDomObjs(d)};this._setEventStatus("shapeDragStart");q(document.body).unbind("mousemove.ganttChartDragDrop");q(document).unbind("mouseup.ganttChartDragDrop");q(document.body).bind("mousemove.ganttChartDragDrop",this._handleShapeDragging.bind(this));q(document).bind("mouseup.ganttChartDragDrop",this._handleShapeDragEnd.bind(this));}}};B.prototype._getDraggingDomObjs=function(d){var g=d3.select(d.target)[0][0];var i;if(g.parentElement){i=g.parentElement.getAttribute("class");}else if(g.parentNode){i=g.parentNode.getAttribute("class");}if(i){var j=i.split(" ")[0];if(sap.ui.getCore().byId(j)instanceof sap.gantt.shape.Group){return g.parentNode.childNodes;}}return[g];};B.prototype._handleShapeDragging=function(d){if(!D.support.touch&&(d.button!==0||d.buttons===0||d.ctrlKey)){return false;}var j=q(this.getDomSelectorById("svg"));var l=Math.abs((this._getMouseXPos(d)-j.offset().left||d.offsetX)-this._oDraggingData.dragStartPoint.x);var x=Math.abs((d.pageY-j.offset().top||d.offsetY)-this._oDraggingData.dragStartPoint.y);if(l>3||x>3){var y=d3.select("#dragDropShadow");var H=y[0];if(this._oDraggingData===undefined){if(!y.empty()){y.remove();}}else{var I=this._oDraggingData.dragStartPoint.shapeX;var J=this._oDraggingData.dragStartPoint.x;if(y.empty()||H===null){this._handleDragWithoutSelection(d);var K=this._oDraggingData.sourceShapeData.length;H=d3.select("body").append("div").attr("id","dragDropShadow");H.classed("sapGanttDraggingShadow",true);var L=[];var O=12;var Q=10;var W=12;for(var i=0;i<this._oDraggingData.domObject.length;i++){var X=d3.select(this._oDraggingData.domObject[i]);if(!X.empty()){var Y=parseInt(X.attr("width"),10);var Z=parseInt(X.attr("height"),10);var _=X.attr("transform");O=Y>O?Y:O;Q=Z>Q?Z:Q;var a1="";if(_){var b1=_.split(")");for(var c1=0;c1<b1.length-1;c1++){if(b1[c1].indexOf("translate")<0){a1=a1+b1[c1]+") ";}}a1.replace("))",")");}var d1=d3.select(this._oDraggingData.domObject[i].cloneNode()).classed("shadow",true).attr("fill-opacity","0.5").attr("x",0).attr("y",0).attr("transform",a1);L.push(d1);}}var g=H.append("svg").attr("id","dragDropShadowSvg").attr("width",O).append("g").attr("id","dragDropShadowSvgGroup");for(var k=0;k<L.length;k++){g.node().appendChild(L[k].node());}g.append("text").attr("x",O/2-W/2).attr("y",Q-W/2+4).attr("fill","blue").attr("font-size",W).text(function(){return K;});}var e1;if(this.getGhostAlignment()===sap.gantt.dragdrop.GhostAlignment.Start){e1=C.getConfiguration().getRTL()?(d.pageX-this._oDraggingData.dragStartPoint.shapeWidth):d.pageX;}else if(this.getGhostAlignment()===sap.gantt.dragdrop.GhostAlignment.None){e1=I+(this._getMouseXPos(d)-J);}else if(this.getGhostAlignment()===sap.gantt.dragdrop.GhostAlignment.End){e1=C.getConfiguration().getRTL()?d.pageX:(d.pageX-this._oDraggingData.dragStartPoint.shapeWidth);}var f1=d.pageY;d3.select("#dragDropShadow").style("left",e1+"px");d3.select("#dragDropShadow").style("top",f1+4+"px");q(document.body).addClass("sapGanttDraggingCursor");this._setEventStatus("shapeDragging");this._handleAutoScroll(d);}}};B.prototype._handleDragWithoutSelection=function(d){var g=this._oDraggingData.sourceShapeData[0];if(!this._oShapeSelection.isShapeSelected(g.shapeData.uid)){var i=false;if(!d.ctrlKey){this._oDraggingData.sourceShapeData.splice(1,this._oDraggingData.sourceShapeData.length-1);i=this._oShapeSelection.clearAllSelections();}this._oShapeSelection.selectByShapeData(g.shapeData);this._drawSelectedShapes();this.fireShapeSelectionChange({originEvent:d});if(i){this.fireRelationshipSelectionChange({originEvent:d});}}};B.prototype._handleAutoScroll=function(d){return this._oAutoScrollHandler.autoScroll(this,d);};B.prototype._handleShapeDragEnd=function(d){this._oAutoScrollHandler.stop();var g=d3.select("#dragDropShadow");if(!g.empty()){g.remove();}if(this._bDragging&&this._oDraggingData!==undefined){var i=this.getId();this._collectDraggingShapeData(this._oDraggingData,d);this.fireShapeDragEnd({originEvent:d,sourceSvgId:this._oDraggingData.sourceSvgId,targetSvgId:i,sourceShapeData:this._oDraggingData.sourceShapeData,targetData:this._oDraggingData.targetData});}q(document.body).unbind("mousemove.ganttChartDragDrop");q(document).unbind("mouseup.ganttChartDragDrop");q(document.body).removeClass("sapGanttDraggingCursor");this._setEventStatus("shapeDragEnd");};B.prototype._collectDraggingShapeData=function(d,g){var i=q(this.getDomSelectorById("svg"));var x=parseInt((this._getMouseXPos(g)-i.offset().left||g.offsetX),10);var j=d.dragStartPoint.x;var k=x-parseInt(j,10);var l;if(this.getGhostAlignment()===sap.gantt.dragdrop.GhostAlignment.Start){l=x;}else if(this.getGhostAlignment()===sap.gantt.dragdrop.GhostAlignment.None){l=parseInt(d.dragStartPoint.shapeX,10)+k;}else if(this.getGhostAlignment()===sap.gantt.dragdrop.GhostAlignment.End){l=x-parseInt(d.dragStartPoint.shapeWidth,10);}var y=l+parseInt(d.dragStartPoint.shapeWidth,10);var H,I;if(C.getConfiguration().getRTL()===true){H=this.getAxisTime().viewToTime(y).getTime();I=this.getAxisTime().viewToTime(l).getTime();}else{H=this.getAxisTime().viewToTime(l).getTime();I=this.getAxisTime().viewToTime(y).getTime();}var J=this._composeParameterForClickPosition(g);var K=J?J.rowInfo:undefined;d.targetData={"cursorTimestamp":this.getAxisTime().viewToTime(x).getTime(),"shapeTimestamp":{startTime:H,endTime:I},"mouseTimestamp":{startTime:H,endTime:I},"mode":this.getMode(),"objectInfo":K};};B.prototype.setDraggingData=function(d){this._oDraggingData=d;if(this._oDraggingData!==undefined){this._oDraggingData.targetSvgId=this.getId();q(document.body).unbind("mousemove.ganttChartDragDrop");q(document).unbind("mouseup.ganttChartDragDrop");q(document.body).bind("mousemove.ganttChartDragDrop",this._handleShapeDragging.bind(this));q(document).bind("mouseup.ganttChartDragDrop",this._handleShapeDragEnd.bind(this));this._setEventStatus("dragEnter");}};B.prototype._onSvgMouseEnter=function(d){if(d.button===0&&d.buttons!==0&&d.target&&(d.target.id===this.getId()+"-svg-ctn"||d.target.id===this.getId()+"-svg"||this._mouseInSvgCtn(d))){this.fireChartDragEnter({originEvent:d});}};B.prototype._onSvgMouseLeave=function(d){if(d.target&&(d.target.id===this.getId()+"-svg-ctn"||d.target.id===this.getId()+"-svg"||!this._mouseInSvgCtn(d))){if(this._bDragStart&&this._oDraggingData!==undefined){this._handleDragLeave(d);}this._destroyCursorLine();this._handleHoverLeave();}};B.prototype._mouseInSvgCtn=function(d){var g=q(this.getDomSelectorById("svg-ctn"));var i=g.width()-((C.getConfiguration().getRTL()||(q(this.getTTVsbDom()).css("display")=="none"))?0:q(this.getTTVsbDom()).width());var j=g.height();var k=g.offset();var l=this._getMouseXPos(d)-k.left;var x=(d.pageY||d.clientY)-k.top;if(x>=0&&x<j&&l>=0&&l<i){return true;}return false;};B.prototype._onSvgMouseDown=function(d){this._prepareSelection(d);this._prepareDragging(d);this._oShapeResizeHandler.handleShapeResize(d);};B.prototype._onSvgMouseMove=function(d){this._drawCursorLine(d);this._handleHover(d);};B.prototype._onSvgMouseUp=function(d){if(d.button==2){this._handleRightClick(d);}else if(d.button==0&&!this._bDragging&&this._bMouseDown&&!this._oShapeResizeHandler.getIsResizing()){this._handleSelectionChange(d);}};B.prototype._onSvgDoubleClick=function(d){if(!this._bDragging&&!d.ctrlKey&&!d.shiftKey&&!this._oShapeResizeHandler.getIsResizing()){var g=this._composeParameterForClickPosition(d);this.fireChartDoubleClick({objectInfo:g?g.rowInfo:undefined,leadingRowInfo:g?g.leadingRowInfo:undefined,timestamp:g?g.startTime.getTime():undefined,svgId:this.getId()+"-svg",svgCoordinate:g?g.svgPoint:undefined,effectingMode:this.getMode(),originEvent:d});}};B.prototype._onSvgTouchstart=function(d){this._prepareSelection(d);this._onTouchScrollStart(d);};B.prototype._onSvgTouchmove=function(d){this._onTouchScroll(d);};B.prototype._onSvgTouchend=function(d){if(!this._bScrolling){this._handleSelectionChange(d);}else{this._setEventStatus("mouseUp");}};B.prototype._onKeyDown=function(d){if(d.which===q.sap.KeyCodes.Z&&this._oTimePeriodZoomHandler.isTimePeriodZoomEnabled()){this._oTimePeriodZoomHandler.invertActiveStatus();}};B.prototype._preventBubbleAndDefault=function(d){d.preventDefault();d.stopPropagation();};B.prototype._prepareSelection=function(d){if(!D.support.touch&&d.button!==0){return false;}if(!this._bDragging&&!this._oShapeResizeHandler.getIsResizing()){this._setEventStatus("mouseDown");}};B.prototype._prepareDragging=function(d){if(d.button==0){if(this._oTimePeriodZoomHandler&&this._oTimePeriodZoomHandler.isActive()){this._oTimePeriodZoomHandler.handleDragStart(d);this._preventBubbleAndDefault(d);}else{var g=d3.select(d.target).data()[0];var i,j;if(d.target.getAttribute("class")){i=d.target.getAttribute("class").split(" ")[0];j=d3.select(d.target).classed("sapUiShapeResizingCursor");}if(!j&&i&&g&&this.isShapeSelectable(g,i)){if(this._bMouseDown){this._handleShapeDragStart(d);}this._preventBubbleAndDefault(d);}}}};B.prototype.syncTimePeriodZoomStatus=function(d){if(d){this._oTimePeriodZoomHandler.activate(true);}else{this._oTimePeriodZoomHandler.deactivate(true);}};B.prototype.syncTimePeriodZoomOperation=function(d,g,O){this._oTimePeriodZoomHandler.syncTimePeriodZoomOperation(d,g,O);};B.prototype._handleRightClick=function(d){var g=this._composeParameterForClickPosition(d);this.fireChartRightClick({objectInfo:g?g.rowInfo:undefined,leadingRowInfo:g?g.leadingRowInfo:undefined,timestamp:g?g.startTime.getTime():undefined,svgId:this.getId()+"-svg",svgCoordinate:g?g.svgPoint:undefined,effectingMode:this.getMode(),originEvent:d});};B.prototype._handleClick=function(d){var g=this._composeParameterForClickPosition(d);this.fireChartClick({objectInfo:g?g.rowInfo:undefined,leadingRowInfo:g?g.leadingRowInfo:undefined,timestamp:g?g.startTime.getTime():undefined,svgId:this.getId()+"-svg",svgCoordinate:g?g.svgPoint:undefined,effectingMode:this.getMode(),originEvent:d});};B.prototype._drawCursorLine=function(d){if(this.getEnableCursorLine()){var g=q(this.getDomSelectorById("svg"));var i=this._getSvgCoodinateByDiv(g[0],this._getMouseXPos(d),d.pageY||d.clientY);this._oCursorLineDrawer.drawSvg(d3.selectAll(".sapGanttChartSvg"),d3.selectAll(".sapGanttChartHeaderSvg"),this.getLocale(),i);}};B.prototype._destroyCursorLine=function(){if(this.getEnableCursorLine()){this._oCursorLineDrawer.destroySvg(d3.selectAll(".sapGanttChartSvg"),d3.selectAll(".sapGanttChartHeaderSvg"));}};B.prototype._handleHover=function(d){var g=this._composeParameterForClickPosition(d);var i=g?g.leadingRowNum-this._oTT.getFirstVisibleRow():-1;i=i<0?-1:i;var j=g?g.isExpandedRow:false;var k=d3.select(d.target).data()[0];if(k){var l=d.pageX-q(this.getDomSelectorById("svg")).offset().left||d.offsetX;this._oShapeResizeHandler.checkShapeResizable(k,d.target,g.svgPoint?g.svgPoint.x:l);}if(i>-1&&((k!==undefined&&k.uid!==this._lastHoverShapeUid)||(k===undefined&&this._lastHoverShapeUid!==undefined)||i!==this._lastHoverRowIndex)){this.fireChartMouseOver({objectInfo:g?g.rowInfo:undefined,leadingRowInfo:g?g.leadingRowInfo:undefined,timestamp:g?g.startTime.getTime():undefined,svgId:this.getId()+"-svg",svgCoordinate:g?g.svgPoint:undefined,effectingMode:this.getMode(),originEvent:d});if(k!==undefined){this._lastHoverShapeUid=k.uid;}else{this._lastHoverShapeUid=undefined;}}if(i>-1&&i!==this._lastHoverRowIndex){var x=this._oTT;var H=x.getRows()[i];if(H){x.$().find(".sapUiTableRowHvr").trigger("mouseout");if(!j){H.$().trigger("mouseover");}}}if(i!==this._lastHoverRowIndex){this._lastHoverRowIndex=i;}};B.prototype._handleDragLeave=function(d){this._oDraggingData.targetSvgId=undefined;this._setEventStatus("dragLeave");this.fireChartDragLeave({originEvent:d,draggingSource:this._oDraggingData});};B.prototype._handleHoverLeave=function(){var d=this._oTT;d.$().find(".sapUiTableRowHvr").trigger("mouseleave");this._lastHoverShapeUid=undefined;this._lastHoverRowIndex=-1;};B.prototype._handleSelectionChange=function(d){var g=d3.select(d.target).datum();var i;if(d.target.getAttribute("class")){i=d.target.getAttribute("class").split(" ")[0];}var j={};if(g!==undefined&&this.isShapeSelectable(g,i)){var k=d.ctrlKey||(D.os.name===sap.ui.Device.os.OS.MACINTOSH&&d.metaKey);j=this._selectionChange(g,k,d.shiftKey,d);}else{var l=this._composeParameterForClickPosition(d);if(l&&!l.isExpandedRow){if(this.getTableProperties().selectionBehavior!==sap.ui.table.SelectionBehavior.RowSelector){this._syncTTSelection(d);}}else{return null;}if(this.getShapeSelectionMode()!==sap.gantt.SelectionMode.MultiWithKeyboard){j.shapeSelectionChange=this._oShapeSelection.clearShapeSelection();j.relationshipSelectionChange=this._oShapeSelection.clearRelationshipSelection();}}if(j.shapeSelectionChange||j.relationshipSelectionChange){this._drawSelectedShapes();}this._setEventStatus("mouseUp");if(j.shapeSelectionChange){this.fireShapeSelectionChange({originEvent:d});}if(j.relationshipSelectionChange){this.fireRelationshipSelectionChange({originEvent:d});}this._handleClick(d);};B.prototype._bindScrollLogicForTT=function(){this._bindHorizontalScroll();this._bindVerticalScroll();};B.prototype._bindHorizontalScroll=function(){this._updateScrollLeft();var d=q(this.getTTHsbDom());d.unbind("scroll.sapUiTableHScroll");d.unbind("scroll.sapUiTableHScrollForGanttChart",this._onHSbScroll);d.bind("scroll.sapUiTableHScrollForGanttChart",q.proxy(this._onHSbScroll,this));};B.prototype._bindVerticalScroll=function(){var d=q(this.getTTVsbDom());d.unbind("scroll.sapUiTableVScrollForGanttChart",this._onVSbScroll);d.bind("scroll.sapUiTableVScrollForGanttChart",q.proxy(this._onVSbScroll,this));};B.prototype._getSvgHeight=function(){return this._oTT.$().find(".sapUiTableCCnt").height();};B.prototype._getRowHeights=function(){return this._aHeights;};B.prototype.setBaseRowHeight=function(d){this.setProperty("baseRowHeight",d,true);this._oTT.setRowHeight(d);return this;};B.prototype._setInferedBaseRowHeight=function(d){this._iInferedBaseRowHeight=d;};B.prototype.getBaseRowHeight=function(){return this._iInferedBaseRowHeight?this._iInferedBaseRowHeight:this._iInferedBaseRowHeightOnTT;};B.prototype._initialSvgDrawing=function(){if(this.getBaseRowHeight()&&this._iSvgHeight!=this._getSvgHeight()){this._iSvgHeight=this._getSvgHeight();this._bTableReady=true;this._onTTRowUpdate();}};B.prototype._onHSbScroll=function(d){if(this._initHorizonApplied){var i=this._getHSBScrollLeft();if(!this._bSuppressSetVisibleHorizon){var g=this._getScrollRateByScrollLeft(i);var j=this._getVisibleHorizonByScrollRate(g);this._updateVisibleHorizon(j);}this._bSuppressSetVisibleHorizon=false;if(!this._bSuppressSyncEvent){var k=this.getAxisTimeStrategy();var l=k.getVisibleHorizon();var x=this.getVisibleWidth();this.fireHorizontalScroll({scrollSteps:i,startTime:l.getStartTime(),endTime:l.getEndTime(),visibleWidth:x});}this._bSuppressSyncEvent=false;}};B.prototype._getScrollRateByScrollLeft=function(i){var H=this._oTT.$(sap.ui.table.SharedDomRef.HorizontalScrollBar+"-content");var d=H.width();var g=this.getVisibleWidth();var j=0;if(d!==g){if(C.getConfiguration().getRTL()===true&&D.browser.msie){j=(d-i-g)/(d-g);}else if(C.getConfiguration().getRTL()===true&&D.browser.safari){j=(d+i-g)/(d-g);}else{j=i/(d-g);}j=j<0?0:j;j=j>1?1:j;}return j;};B.prototype._getScrollRateByHorizon=function(d){var g=0;var i=this._nUpperRange-this._nLowerRange;var j=this.getVisibleWidth();if(this._initHorizonApplied&&i!==j){var k;if(C.getConfiguration().getRTL()){k=this.getAxisTime().timeToView(F.abapTimestampToDate(d.getEndTime()),true);g=k/(i-j);}else{k=this.getAxisTime().timeToView(F.abapTimestampToDate(d.getStartTime()),true);g=k/(i-j);}g=g<0?0:g;g=g>1?1:g;}return g;};B.prototype._getHSBScrollLeftByScrollRate=function(d){var H=this._oTT.$(sap.ui.table.SharedDomRef.HorizontalScrollBar+"-content");var g=H.width();var i=this.getVisibleWidth();var j=d*(g-i);if(C.getConfiguration().getRTL()&&D.browser.msie){j=g-i-j;}else if(C.getConfiguration().getRTL()&&D.browser.safari){j=0-(g-i-j);}return j;};B.prototype._getContentScrollLeftByScrollRate=function(d){var g=this._nUpperRange-this._nLowerRange;var i=this.getVisibleWidth();var j=d*(g-i);return j;};B.prototype._getVisibleHorizonByScrollRate=function(d){var g=this._getContentScrollLeftByScrollRate(d);var i=this.getAxisTimeStrategy().getTotalHorizon();var j;var k={};var l=C.getConfiguration().getRTL();if(d===0){k.startTime=l?undefined:i.getStartTime();k.endTime=l?i.getEndTime():undefined;}else if(d===1){k.startTime=l?i.getStartTime():undefined;k.endTime=l?undefined:i.getEndTime();}else{var x=this.getAxisTime().viewToTime(g,true);k.startTime=l?undefined:x;k.endTime=l?x:undefined;}j=new t(k);return j;};B.prototype.syncVisibleHorizon=function(d,i){this._bSuppressSyncEvent=true;var g;if(i!==undefined){var j=this.getVisibleWidth();g=U.calculateHorizonByWidth(d,i,j);}else{g=d;}this._updateVisibleHorizon(g);};B.prototype._onVSbScroll=function(){if(!this._mTimeouts._drawSvg){this.$().find(".sapGanttChartSvg").css("transform","translateY("+(-this._oTT.$().find(".sapUiTableCCnt").scrollTop())+"px)");}this.fireVerticalScroll({scrollSteps:this._oTT.getFirstVisibleRow(),scrollPosition:q(this.getTTVsbDom()).scrollTop()});};B.prototype._hSbScrollLeft=function(d){var g=q(this.getDomSelectorById("svg-ctn"));var i=q(this.getDomSelectorById("header"));var j;if(C.getConfiguration().getRTL()===true){if(!D.browser.safari){j=this._oStatusSet.aViewBoundary[1]-i.width()-d;if(j<0){j=0;}}else{j=0-d;}}else{j=d;}if(C.getConfiguration().getRTL()===true&&D.browser.firefox){if(Math.abs(g.scrollLeftRTL()-j)>1){g.scrollLeftRTL(j);}if(Math.abs(i.scrollLeftRTL()-j)>1){i.scrollLeftRTL(j);}}else{if(Math.abs(g.scrollLeft()-j)>1){g.scrollLeft(j);}if(Math.abs(i.scrollLeft()-j)>1){i.scrollLeft(j);}}};B.prototype.jumpToPosition=function(d){if(d instanceof Date){this._updateVisibleHorizon(new t({startTime:d}));}else if(d instanceof Array){this._updateVisibleHorizon(new t({startTime:d[0],endTime:d[1]}));}else if(d===undefined){this._updateVisibleHorizon(this.getAxisTimeStrategy().getTotalHorizon());}};B.prototype._updateVisibleHorizon=function(d){var g=this.getAxisTimeStrategy();var i=this.getVisibleWidth();g.updateGanttVisibleWidth(i);g.setVisibleHorizon(d);};B.prototype._onTTRowUpdate=function(){if(this._bTableReady){this._syncSvgHeightWithTT();this._syncSvgDataWithTT();this._draw(true);}};B.prototype._syncSvgHeightWithTT=function(){var d=this.$().find(".sapGanttChartSvgCtn");d.height(this._getSvgHeight());var g=this.$().find(".sapGanttChartSvg");g.height($(this._oTT.$().find(".sapUiTableCtrlRowScroll:not(.sapUiTableCHT)")).height());};B.prototype._syncSvgDataWithTT=function(){var d=this._oTT.getBinding("rows");if(!d){return false;}var i=this._oTT.getFirstVisibleRow();var g=this._getVisibleRowCount();this._aFilteredRowData=[];this._aNonVisibleShapeData=[];var _=[];var j=[];var k=[i,i+g-1];var I=this._aRelationshipsContexts&&this._aRelationshipsContexts.length>0;if(I){d.getContexts(0,0);if(i>0){_=this._getDrawingData([0,i-1]);}j=this._getDrawingData([i+g,d.getLength()-1]);d.getContexts(k[0],k[1]);}this._aFilteredRowData=this._getDrawingData(k);this._aNonVisibleShapeData=_.concat(j);var l=this.getBaseRowHeight();if(!l){l=0;}this._oAxisOrdinal=this._createAxisOrdinal(this._aFilteredRowData,l,0);this._cacheObjectPosition(this._aFilteredRowData,this._oAxisOrdinal);this._cacheObjectPosition(_,this._oAxisOrdinal,true);this._cacheObjectPosition(j,this._oAxisOrdinal,false);if(!this._aVisibleRange||this._aVisibleRange[0]!==k[0]||this._aVisibleRange[1]!==k[1]){this._aVisibleRange=k;return true;}return false;};B.prototype._cacheObjectPosition=function(d,g,l){if(d&&d.length>0){if(l===true){for(var i=0;i<d.length;i++){d[i].y=-100;d[i].rowHeight=g.getViewBandWidth();}}else if(l===false){for(var j=0;j<d.length;j++){d[j].y=g.getViewRange()[1]+100;d[j].rowHeight=g.getViewBandWidth();}}else{var x=[];var y=[];for(var k=0;k<d.length;k++){d[k].y=g.elementToView(d[k].uid);if(k>0){d[k-1].rowHeight=d[k].y-d[k-1].y;}if(d[k].visibleRowSpan){d[k].visibleRowHeight=d[k].visibleRowSpan*g.getViewBandWidth();x.push(d[k].uid);y.push(d[k].visibleRowSpan);}}d[d.length-1].rowHeight=g.getViewRange()[1]-d[d.length-1].y;this._oAxisOrdinalOfVisibleRow=new n(x,y,this.getBaseRowHeight(),0);}}};B.prototype._prepareRelationshipDataFromModel=function(){this._aRelationships=[];if(this._aRelationshipsContexts){for(var i=0;i<this._aRelationshipsContexts.length;i++){var d=this._aRelationshipsContexts[i].getObject();if(d!==undefined){this._aRelationships.push(d);}}}U.generateUidForRelationship(this._aRelationships,this.getRlsIdName());};B.prototype._createAxisOrdinal=function(d,i,g){var j=d.map(function(l){return l.uid;});var k=d.map(function(l){if(l.rowSpan){return l.rowSpan;}else{return 1;}});return new n(j,k,i,g);};B.prototype.getFilteredRowData=function(d){return this._aFilteredRowData;};B.prototype._getDrawingData=function(d){var g=function(h1,j1,l1,m1){if(!h1[j1]){h1.push({});}if(!h1[j1][l1]){h1[j1][l1]=[];}h1[j1][l1].push(m1);};var i,j,k,l,x,y;var H=this.getRowIdName();var I=this.getRowTypeName();var J=this._oTT.getBinding("rows");var K=this._oTT.getBindingInfo("rows");var L=[];if(J!==undefined){var O=J.getModel();var Q=this.getShapeDataNames();for(i=d[0];i<=d[1];i++){var W=this._oTT.getContextByIndex(i);if(!W){continue;}else{x=W.getObject();if(!x){continue;}}var X=1;y=this._oObjectTypesConfigMap[x[I]]?this._oObjectTypesConfigMap[x[I]].getMainChartSchemeKey():sap.gantt.config.DEFAULT_CHART_SCHEME_KEY;if(x[I]){var Y=this._oChartSchemesConfigMap[y];if(Y){X=Y.getRowSpan();}}var Z={"bindingObj":J,"bindingInfo":K,"contextObj":W,"data":x,"id":x[H],"type":x[I],"rowSpan":X,"chartScheme":y,"rowIndex":i,"index":0,"visibleRowSpan":X};L.push(Z);if(!this._bJSONTreeBinding){if(Q&&Q.length>0){for(j=0;j<Q.length;j++){var _;if(typeof Q[j]==="string"){_=Q[j];}else{_=Q[j].name;}var a1=W.getProperty(_);var b1;if(a1){Z.data[_]=[];for(k=0;k<a1.length;k++){var c1=a1[k];if(typeof c1==="string"){b1=O.getData("/"+c1);}else{b1=c1;}Z.data[_].push(b1);}}}}}U.generateRowUid([Z],this._oObjectTypesConfigMap,Q,undefined,H);var d1=x.uid;if(d1&&this._oRowStatusMap[d1]){for(y in this._oRowStatusMap[d1]){var e1;if(this._oChartSchemesConfigMap[y]&&this._oChartSchemesConfigMap[y].getModeKey()&&this._oChartSchemesConfigMap[y].getModeKey()!==sap.gantt.config.DEFAULT_MODE_KEY){e1=this._oChartSchemesConfigMap[y].getModeKey();}else{e1=this.getMode();}var f1=this._collectDataNameForValidChartScheme(y,e1);if(f1&&f1.drawData){var g1=0;var h1=[{}];for(j=0;j<f1.drawData.length;j++){if(!x[f1.drawData[j]]){continue;}for(k=0;k<x[f1.drawData[j]].length;k++){var i1=x[f1.drawData[j]][k][f1.rowIndexName];if(i1&&g1<i1){g1=i1;}}}if(g1>0){for(j=0;j<f1.drawData.length;j++){if(!x[f1.drawData[j]]){continue;}for(k=0;k<x[f1.drawData[j]].length;k++){var j1=x[f1.drawData[j]][k][f1.rowIndexName];if(j1){g(h1,j1,f1.drawData[j],x[f1.drawData[j]][k]);}else{for(l=1;l<=g1;l++){g(h1,l,f1.drawData[j],x[f1.drawData[j]][k]);}}}}for(j=1;j<=g1;j++){var k1={"bindingObj":J,"bindingInfo":K,"data":h1[j],"id":x[H],"type":x[I],"parentId":Z.id,"rowSpan":f1.rowSpan,"chartScheme":y,"rowIndex":i,"index":j,"icon":this._oChartSchemesConfigMap[y].getIcon(),"closeIcon":"./image/closeChart.png","name":this._oChartSchemesConfigMap[y].getName()};U.generateRowUid([k1],this._oObjectTypesConfigMap,Q,undefined,H);L.push(k1);Z.visibleRowSpan+=f1.rowSpan;}}}}this._oRowStatusMap[d1].visibleRowSpan=Z.visibleRowSpan;}}}return L;};B.prototype._prepareVerticalDrawingRange=function(){var d=this._oTT.getBinding("rows").getLength()-1;if(d<0){return[0,-1];}var g=this._oTT.getFirstVisibleRow();var i=g+this._getVisibleRowCount()-1;var j=g;var k=i<d?i:d;return[j,k];};B.prototype._prepareHorizontalDrawingRange=function(){var d=this._nUpperRange-this._nLowerRange;var g=this.getVisibleWidth();if(!this._oStatusSet){this._updateScrollWidth();}var i=this._getContentScrollLeft();if(this._oStatusSet){if((g>=d||(this._oStatusSet.aViewBoundary[0]<=i-this._oStatusSet.nOffset&&this._oStatusSet.aViewBoundary[1]>=i+g-this._oStatusSet.nOffset))){if(!this._mTimeouts._drawSvg){this._updateScrollLeft();this._scrollSvg();}return false;}}var j=g*(1+this._fExtendFactor*2);var k=i-g*this._fExtendFactor;if(k<this._nLowerRange){j+=k;k=0;}if(k+j>this._nUpperRange){j=this._nUpperRange-k;}this.getAxisTime().setViewOffset(k);if(j<0){return false;}this._oStatusSet={nWidth:j,nOffset:k,nScrollLeft:i,aViewBoundary:[0,j],aTimeBoundary:[this.getAxisTime().viewToTime(0),this.getAxisTime().viewToTime(j)],bRTL:C.getConfiguration().getRTL()};return true;};B.prototype._draw=function(d){if(!this._bTableReady){return;}var g=this._nUpperRange-this._nLowerRange;if(g<=2){return;}var i=this.getVisibleWidth();if(!i||i<=0||i>document.body.clientWidth){return;}var j=this.getAxisTimeStrategy().syncContext(i);this.fireEvent("_zoomInfoUpdated",j);if(j.axisTimeChanged){this.setProperty("timeZoomRate",this.getAxisTime().getZoomRate(),true);this.resetWidthInfo();}if(!this._prepareHorizontalDrawingRange()&&!d){return;}this._updateTableRowHeights();var k=this;this._mTimeouts._drawSvg=this._mTimeouts._drawSvg||window.setTimeout(function(){k._drawSvg();},0);};B.prototype.getVisibleWidth=function(){var d=q(this.getDomSelectorById("svg-ctn"));if(!d){return null;}var g=d.width()-((C.getConfiguration().getRTL())?0:q(this.getTTVsbDom()).width());if(!g||g<=0){return null;}return g;};B.prototype._updateScrollWidth=function(){var d=this._nUpperRange-this._nLowerRange;this._oColumn.setWidth((d-4)+"px");};B.prototype._updateScrollLeft=function(d){var g=q(this.getTTHsbDom());var i=this._calHSBScrollLeft();var j=this._getHSBScrollLeft(g);if(Math.abs(j-i)>1){this._bSuppressSetVisibleHorizon=!d;if((C.getConfiguration().getRTL()===true&&D.browser.firefox)){g.scrollLeftRTL(i);}else{g.scrollLeft(i);}}else if(this._forceHsbScrollSync(j,i)){this._bSuppressSetVisibleHorizon=!d;this._onHSbScroll();}};B.prototype._forceHsbScrollSync=function(d,g){if(this._oLastVisibleHorizon){var i=this.getAxisTimeStrategy().getVisibleHorizon();if(i&&(this._oLastVisibleHorizon.getStartTime()!=i.getStartTime()||this._oLastVisibleHorizon.getEndTime()!=i.getEndTime())){this._oLastVisibleHorizon=i;return true;}}return false;};B.prototype._calHSBScrollLeft=function(){var d=this.getAxisTimeStrategy().getVisibleHorizon();var g=this._getScrollRateByHorizon(d);var i=this._getHSBScrollLeftByScrollRate(g);return i;};B.prototype._getHSBScrollLeft=function(d){if(!d){d=q(this.getTTHsbDom());}return(C.getConfiguration().getRTL()===true&&D.browser.firefox)?d.scrollLeftRTL():d.scrollLeft();};B.prototype._scrollSvg=function(){var d=q(this.getDomSelectorById("svg"));var g=q(this.getDomSelectorById("header-svg"));if(Math.abs(this._oStatusSet.nWidth-d.width())>1){d.width(this._oStatusSet.nWidth+((C.getConfiguration().getRTL())?0:q(this.getTTVsbDom()).width()));}if(Math.abs(this._oStatusSet.nWidth-g.width())>1){g.width(this._oStatusSet.nWidth+((C.getConfiguration().getRTL())?0:q(this.getTTVsbDom()).width()));}var i=this.getVisibleWidth();var j=this._getContentScrollLeft();if(C.getConfiguration().getRTL()===true&&!D.browser.msie){this._hSbScrollLeft(this._oStatusSet.nOffset-j+this._oStatusSet.nWidth-i);}else{this._hSbScrollLeft(j-this._oStatusSet.nOffset);}};B.prototype._getContentScrollLeft=function(){var d=this.getAxisTimeStrategy().getVisibleHorizon();var g=this._getScrollRateByHorizon(d);var i=this._getContentScrollLeftByScrollRate(g);return i;};B.prototype._drawSvg=function(){q.sap.measure.start("GanttChart _drawSvg","GanttPerf:GanttChart _drawSvg function");if(!this._initHorizonApplied){this._prepareHorizontalDrawingRange();this._initHorizonApplied=true;this._updateScrollLeft(true);}else{this._updateScrollLeft();}q(this.getDomSelectorById("svg-ctn")).css("visibility","hidden");this._scrollSvg();q(this.getDomSelectorById("svg-ctn")).css("visibility","visible");this._sUiSizeMode=U.findSapUiSizeClass(this);this._drawCalendarPattern();this._drawHeader();this._drawNowLine();this._drawVerticalLine();this._drawExpandedBackground();this._drawShapes();this._drawSelectedShapes();this._drawAdhocLine();delete this._mTimeouts._drawSvg;this.$().find(".sapGanttChartSvg").css("transform","translateY("+(-this._oTT.$().find(".sapUiTableCCnt").scrollTop())+"px)");this.fireEvent("_shapesUpdated",{aSvg:q(this.getDomSelectorById("svg"))});q.sap.measure.end("GanttChart _drawSvg");};B.prototype._drawHeader=function(){var g=q(this.getDomRef()).find(".sapGanttChartHeader");var j=g.height();var H=d3.select(q(this.getDomRef()).find(".sapGanttChartHeaderSvg").get(0));H.attr("height",j);var k=j/5*2;var l=j/5*4;var x=j/5*4;var y=this.getAxisTimeStrategy();var L=this.getAxisTime().getTickTimeIntervalLabel(y.getTimeLineOption(),null,[0,this._oStatusSet.nWidth]);H.selectAll("g").remove();var I=H.append("g");I.selectAll("label0").data(L[0]).enter().append("text").classed("sapGanttTimeHeaderSvgText0",true).text(function(d){return d.label;}).attr("x",this._getXwithOffset).attr("y",function(d){return k;}).attr("text-anchor","start");I.selectAll("label1").data(L[1]).enter().append("text").classed("sapGanttTimeHeaderSvgText1",true).text(function(d){return d.label;}).attr("x",this._getXwithOffset).attr("y",function(d){return x;});if((D.browser.msie||D.browser.edge)&&C.getConfiguration().getRTL()){d3.selectAll(".sapGanttChartHeader .sapGanttTimeHeaderSvgText0").each(function(d,i){d3.select(this).attr("transform",function(d){var Q="translate("+(-U.calculateStringLength(d.label)*parseInt($(".sapGanttTimeHeaderSvgText0").css("font-size"),10)/2)+")";return Q;});});d3.selectAll(".sapGanttChartHeader .sapGanttTimeHeaderSvgText1").each(function(d,i){d3.select(this).attr("transform",function(d){var Q="translate("+(-U.calculateStringLength(d.label)*parseInt($(".sapGanttTimeHeaderSvgText1").css("font-size"),10)/2)+")";return Q;});});}var J="";for(var i=0;i<L[1].length;i++){var K=L[1][i];if(K){J+=" M"+" "+(K.value-1/2)+" "+l+" L"+" "+(K.value-1/2)+" "+j;}}var O="";for(var i=0;i<L[0].length;i++){var K=L[0][i];if(K){O+=" M"+" "+(K.value-1/2)+" 0"+" L"+" "+(K.value-1/2)+" "+j/2;}}I.append("path").classed("sapGanttTimeHeaderSvgPath",true).attr("d",J);I.append("path").classed("sapGanttTimeHeaderLargeIntervalSvgPath",true).attr("d",O);};B.prototype._getXwithOffset=function(d){var O=5;if(C.getConfiguration().getRTL()){return d.value-O;}else{return d.value+O;}};B.prototype._drawCalendarPattern=function(){var g=d3.select(this.getDomSelectorById("svg"));this._oCalendarPatternDrawer.drawSvg(g,this.getId(),this.getCalendarDef(),this._oStatusSet,this.getBaseRowHeight());};B.prototype._drawNowLine=function(){this._oNowlineDrawer=new N(this.getAxisTime());var g=d3.select(this.getDomSelectorById("header-svg")),d=d3.select(this.getDomSelectorById("svg"));if(this.getEnableNowLine()){this._oNowlineDrawer.drawSvg(d,g);}else{this._oNowlineDrawer.destroySvg(d,g);}};B.prototype._drawVerticalLine=function(){this._oVerticalLineDrawer=new V(this.getAxisTime());var g=d3.select(this.getDomSelectorById("svg"));if(this.getEnableVerticalLine()){this._oVerticalLineDrawer.drawSvg(g);}else{this._oVerticalLineDrawer.destroySvg(g);}};B.prototype._drawAdhocLine=function(){this._oAdhocLineDrawer=new A(this.getAxisTime());var g=d3.select(this.getDomSelectorById("svg"));if(this.getEnableAdhocLine()){this._oAdhocLineDrawer.drawSvg(g,this.getAdhocLines(),this._oStatusSet,this.getAdhocLineLayer());}else{this._oAdhocLineDrawer.destroySvg(g);}};B.prototype._drawExpandedBackground=function(){var d=d3.select(this.getDomSelectorById("svg"));if(!this._oTT||!this._oTT.getRows()||this._oTT.getRows().length<=0){return;}if(this._aFilteredRowData){var g=this._composeChartSchemeBackgroundConfig();this._oExpandedBackgroundDrawer.drawSvg(d,this._aFilteredRowData,g);}};B.prototype._composeChartSchemeBackgroundConfig=function(){var d=this._oChartSchemesConfigMap;var g={};if(d){for(var i in d){if(d[i].getHaveBackground()){g[i]=d[i].getBackgroundClass();}}}return g;};B.prototype._drawShapes=function(){var d=d3.select(this.getDomSelectorById("svg"));var g=this._oShapeManager.getAllShapeInstances();var j=this._oShapeManager.mShapeInstance;if(this._aFilteredRowData&&g&&g.length>0){this._oShapeManager.collectDataForAllShapeInstances(this._aFilteredRowData,this._oObjectTypesConfigMap,this._oChartSchemesConfigMap);var k=this.getAxisTime();var l=this._oShapeCrossRowDrawer.generateRelationshipDataSet(d,j,this._aNonVisibleShapeData,this.getShapeDataNames(),this._aRelationships,k,this._oAxisOrdinal);for(var i=0;i<g.length;i++){var x=g[i];switch(x.getCategory(null,k,this._oAxisOrdinal)){case sap.gantt.shape.ShapeCategory.InRowShape:this._oShapeInRowDrawer.drawSvg(d,x,k,this._oAxisOrdinal,this._oStatusSet);break;case sap.gantt.shape.ShapeCategory.Relationship:x.dataSet=this._oShapeManager.isRelationshipDisplayable(x)?l:[];this._oShapeCrossRowDrawer.drawSvg(d,x,k,this._oAxisOrdinal);break;default:break;}}}};B.prototype.getShapeInstance=function(d){return this._oShapeManager.mShapeInstance[d];};B.prototype._drawSelectedShapes=function(){var d=d3.select(this.getDomSelectorById("svg"));var g=this._oShapeManager.mShapeInstance;this._oShapeManager.collectDataForSelectedShapes(this._oShapeSelection,this._oObjectTypesConfigMap,this._oChartSchemesConfigMap);var i=this.getAxisTime();var j=this._oShapeCrossRowDrawer.generateRelationshipDataSet(d,g,this._aNonVisibleShapeData,this.getShapeDataNames(),this._oShapeSelection.getSelectedRelationships(),i,this._oAxisOrdinal);for(var k in g){var l=g[k].getAggregation("selectedShape");var x=l.getCategory(null,this._oAxisTime,this._oAxisOrdinal);switch(x){case sap.gantt.shape.ShapeCategory.InRowShape:this._oShapeInRowDrawer.drawSvg(d,l,i,this._oAxisOrdinal,this._oStatusSet);break;case sap.gantt.shape.ShapeCategory.Relationship:l.dataSet=j;this._oShapeCrossRowDrawer.drawSvg(d,l,i,this._oAxisOrdinal);break;default:break;}}};B.prototype._getSvgCoodinateByDiv=function(d,x,y){var g=d.createSVGPoint();g.x=x;g.y=y;g=g.matrixTransform(d.getScreenCTM().inverse());g.svgHeight=d.height.baseVal.value;g.svgId=this.getId()+"-svg";return g;};B.prototype.isShapeSelectable=function(d,g){return this._oShapeManager.isShapeSelectable(d,g);};B.prototype.getAxisOrdinal=function(){return this._oAxisOrdinal;};B.prototype.getAxisTime=function(){return this.getAxisTimeStrategy().getAxisTime();};B.prototype.ondblclick=function(d){return null;};B.prototype.onclick=function(d){return null;};B.prototype.getSapUiSizeClass=function(){return this._sUiSizeMode;};B.prototype.setFirstVisibleRow=function(i){this.setTableProperties({firstVisableRow:i});return this;};B.prototype._getVisibleRowCount=function(){return this._oTT.getVisibleRowCount()+1;};B.prototype._setLargeDataScrolling=function(l){if(this._oTT._setLargeDataScrolling){this._oTT._setLargeDataScrolling(!!l);}};B.prototype.exit=function(){this._detachEvents();this._cleanUpTimers();};B.prototype._cleanUpTimers=function(){for(var k in this._mTimeouts){if(this._mTimeouts[k]){clearTimeout(this._mTimeouts[k]);this._mTimeouts[k]=undefined;}}};B.prototype.getTTHsbDom=function(){return this._oTT.getDomRef(sap.ui.table.SharedDomRef.HorizontalScrollBar);};B.prototype.getTTVsbDom=function(){return this._oTT.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar);};B.prototype._getMouseXPos=function(d){if(D.browser.edge){return d.clientX;};return d.pageX;};return B;},true);
