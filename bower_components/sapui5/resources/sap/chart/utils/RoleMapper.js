/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/chart/data/TimeDimension','sap/chart/utils/MeasureSemanticsUtils','sap/chart/utils/ChartUtils','sap/chart/utils/DateFormatUtil','sap/chart/data/MeasureSemantics','sap/chart/ChartLog'],function(T,M,C,D,c,d){"use strict";function R(F){this._bTimeFed=false;}R.prototype.toFeedingId=function(o){if(o instanceof T&&!this._bTimeFed){this._bTimeFed=true;return"timeAxis";}else{return"@context";}};function e(a){return C.CONFIG.timeChartTypes.indexOf(a)>-1;}function s(S,m,o){var a={actualValues:[],targetValues:[]};jQuery.each(S,function(i,t){if(t.actual){a.actualValues.push(m[t.actual]);t.valueAxisID='actualValues';}if(t.projected){a.actualValues.push(m[t.projected]);t.valueAxisID='actualValues';}if(t.reference){if((t.actual||t.projected)){a.targetValues.push(m[t.reference]);t.valueAxisID='targetValues';}else{a.actualValues.push(m[t.reference]);t.valueAxisID='actualValues';}}});delete o["@semanticBulletMsrs"];jQuery.extend(o,a);}function f(S,m){var a=m["@semanticBulletMsrs"];if(a){var F={actualValues:[]};for(var i=0;i<a.length;i++){F.actualValues.push(a[i]);}for(var i=0;i<S.length;i++){S[i].valueAxisID='actualValues';}delete m["@semanticBulletMsrs"];jQuery.extend(m,F);}}R.semantics={hasSemanticMeasures:function(F){return Object.keys(F.msrs).some(function(k){var r=false;var m=F.msrs[k];r=m.some(function(a){if(a.getSemantics){var b=a.getSemantics();return b&&b!=='actual';}});return r;});},semanticPatternMsrs:function(F,g,I){var A=[],h=[],m={},j,k;var l=e(g)&&(F.dims.timeAxis&&F.dims.timeAxis.length===1);var n=['valueAxis','valueAxis2'];var o=Object.keys(F.msrs).sort(function(a,b){return n.indexOf(a)-n.indexOf(b);});var p=this.hasSemanticMeasures(F);o.forEach(function(a){var b=F.msrs[a],E;jQuery.extend(true,m,b.reduce(function(m,H){m[H.getName()]=H;return m;},{}));if(g&&g.indexOf('bullet')>-1&&F.invisibleMsrs){E=F.invisibleMsrs.filter(function(H){return H.getSemantics()==='actual'&&H.getSemanticallyRelatedMeasures();});}if(jQuery.isEmptyObject(F.dims)){k=new d('error','Semantic Pattern',"Semantic Pattern doesn't work when there is no dimension.");I=I||true;}else if(F.dims.color&&F.dims.color.length>0){k=new d('error','Semantic Pattern',"Semantic pattern doesn't work when there is series dimension.");I=I||true;}var G=M.getTuples(b,E,I);G.forEach(function(H){H.valueAxisID=a;});if(p&&I&&k){k.display();}A=A.concat(G);});if(g&&g.indexOf('bullet')>-1){l=l&&A.some(function(t){return t.actual&&t.projected;});j=A.some(function(t){return(t.actual&&t.projected)||(t.actual&&t.reference)||(t.projected&&t.reference);});if(j&&(!l)){s(A,m,F.msrs);}else{f(A,F.msrs);}}if((!I)&&l){var S=[];var q=function(a){var b=S.indexOf(a.getName())===-1;if(!b){h.push(a);}return b;};for(var i=0;i<A.length;i++){var t=A[i];var r=F.dims.timeAxis[0];var u=r.getProjectedValueStartTime();if(u){var v=r.getTimeUnit(),w;if(v==='fiscalyearperiod'||v==='fiscalyear'){w=u;}else{var x=D.getInstance(v);if(x){if(x.parse(u)){w=x.parse(u).getTime();}}else{w=new Date(u).getTime();}}if(w){var y=F.msrs[t.valueAxisID];if(t.actual&&t.projected){t.timeAxis=F.dims.timeAxis[0].getName();t.projectedValueStartTime=w;t.semanticMsrName=t.actual+"-"+t.projected;S.push(t.actual);S.push(t.projected);y.push(m[t.actual].clone().setName(t.semanticMsrName));}F.msrs[t.valueAxisID]=y.filter(q);}else{k=new d('error','Semantic Pattern',"The value of projectedValueStartTime is invalid.");k.display();}}}}if((A.length>0)&&(!I)){var z=[];var B=['actual','projected','semanticMsrName','reference'];A.forEach(function(a){for(var i=0;i<B.length;i++){if(a[B[i]]){z.push(a[B[i]]);}}});jQuery.each(F.msrs,function(E){F.msrs[E].sort(function(a,b){return z.indexOf(a.getName())-z.indexOf(b.getName());});});}return{semanticTuples:A,contexts:h};}};return R;});
