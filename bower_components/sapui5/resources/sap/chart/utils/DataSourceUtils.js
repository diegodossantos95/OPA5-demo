/*
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/chart/data/Dimension','sap/chart/data/TimeDimension','sap/chart/data/Measure','sap/chart/TimeUnitType'],function(D,T,M,a){"use strict";function g(i,B){var p=B.path;var n=(B.parameters||{}).entitySet;if(!n){n=p.split("/")[1];if(n.indexOf("(")!=-1){n=n.split("(")[0]+(i?"Results":"Set");}}return n;}function _(r,s,t){return"{/#"+r+"/"+s+"/@sap:"+t+"}";}function d(p,C){var f=D;if(p.type==="Edm.DateTime"&&p['sap:display-format']==="Date"){f=T;C.timeUnit=a.Date;}else if(p.type==="Edm.String"&&a[p['sap:semantics']]){f=T;C.timeUnit=p['sap:semantics'];}return f;}var b={getEntitySet:g.bind(null,true),deriveColumns:function(m,B){var r=m.getAnalyticalExtensions().findQueryResultByName(b.getEntitySet(B));if(!r){throw new Error("value of the \"isAnalytical\" property does not match the Data Service in use");}var R=r.getEntityType().getQName();R=R.slice(R.lastIndexOf(".")+1);var s=r.getEntityType().getSchema().namespace;var f=b.makeDimension.bind(this,R,s,r);var h=b.makeMeasure.bind(this,R);return{dimensions:jQuery.map(r.getAllDimensions(),f),measures:jQuery.map(r.getAllMeasures(),h)};},makeDimension:function(r,R,o,f){var s=f.getName();var C={name:s,label:_(r,s,"label"),textProperty:_(r,s,"text")};var A=b.ANNOTATION_ACCESS_TEMPLATE.replace(/%SCHEMANS/,R).replace(/%RESULTTYPE/,r).replace(/%DIMENSION/,s);var u=o.getModel().getODataModel().getMetaModel().getProperty(A);var h=d(u,C);return new h(C);},makeMeasure:function(r,m){return new M({name:m.getName(),label:_(r,m.getName(),"label")});},updateModel:function(C){function f(n,p,q){var t=n.getTextProperty(),j=[{name:n.getName(),grouped:false,inResult:!!p,visible:!q}];if(n.getDisplayText()&&t){j.push({name:t,grouped:false,inResult:!!p,visible:!q});}return j;}function h(n){var u=n.getUnitBinding(),j=[{name:n.getName(),total:false,inResult:false,visible:true}];if(u){j.push({name:u,total:false,inResult:false,visible:true});}return j;}var B=C.getBinding("data");if(!B){return;}var i=C._getVisibleDimensions(true);var m=C._getVisibleMeasures(true);var I=C._normalizeDorM(C.getInResultDimensions(),true);var j=i.reduce(function(j,n){return j.concat(f(n));},[]).concat(I.reduce(function(j,n){return j.concat(f(n,true,true));},[])).concat(m.reduce(function(j,n){return j.concat(h(n));},[]));var o=C._getCandidateColoringSetting();var k=o.additionalMeasures||[];var l=o.additionalDimensions||[];if(k.length){j=j.concat(C._normalizeDorM(k).reduce(function(n,p){return n.concat(h(p));},[]));}if(l.length){j=j.concat(C._normalizeDorM(l,true).reduce(function(n,p){return n.concat(f(p));},[]));}B.updateAnalyticalInfo(j);},ANNOTATION_ACCESS_TEMPLATE:"/dataServices/schema/[${"+"namespace"+"}==='%SCHEMANS']/entityType/[${"+"name"+"}==='%RESULTTYPE']/property/[${"+"name"+"}==='%DIMENSION']/"};var c={getEntitySet:g.bind(null,false),deriveColumns:function(m,B){var o=m.getMetaModel(),C={dimensions:[],measures:[]};if(o){var q=o.getODataEntitySet(c.getEntitySet(B)).entityType;var E=o.getODataEntityType(q);jQuery.each(E.property,function(i,p){var f=c.CLAZZ[p.type];if(!f){throw new Error("Unsupported type: "+p.type);}var h={name:p.name};if(p.hasOwnProperty("sap:label")){h.label=p["sap:label"];}if(f===M){C.measures.push(new f(h));}else{if(p.hasOwnProperty("sap:text")){h.textProperty=p["sap:text"];}f=d(p,h);C.dimensions.push(new f(h));}});}return C;},CLAZZ:{"Null":D,"Edm.Binary":D,"Edm.Boolean":D,"Edm.Byte":M,"Edm.DateTime":D,"Edm.Decimal":M,"Edm.Double":M,"Edm.Single":M,"Edm.Guid":D,"Edm.Int16":M,"Edm.Int32":M,"Edm.Int64":M,"Edm.SByte":M,"Edm.String":D,"Edm.Time":D,"Edm.DateTimeOffset":D},updateModel:function(C,f,m){if(C.getModel()instanceof sap.ui.model.odata.ODataModel){var h=f.reduce(function(h,o){if(o.getTextProperty()){return h.concat(o.getName(),o.getTextProperty());}else{return h.concat(o.getName());}},[]);var i=m.reduce(function(i,o){if(o.getUnitBinding()){return i.concat(o.getName(),o.getUnitBinding());}else{return i.concat(o.getName());}},[]);C._oBindingInfo.parameters=C._oBindingInfo.parameters||{};C._oBindingInfo.parameters.entitySet=c.getEntitySet(C._oBindingInfo);C._oBindingInfo.parameters.select=h.concat(i).join(",");C.bindData(C._oBindingInfo);if(C._isEnablePaging()&&C._getPagingController().getPagingSorters()){C.getBinding("data").sort(C._getPagingController().getPagingSorters());}}else{return;}}};function e(m){return function(i){var f=i?b:c;return f[m];};}return{deriveColumns:e("deriveColumns"),updateModel:e("updateModel"),getEntitySet:e("getEntitySet")};});
