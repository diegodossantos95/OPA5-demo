/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/viz/ui5/data/DimensionDefinition','sap/viz/ui5/data/MeasureDefinition','sap/viz/ui5/controls/common/feeds/FeedItem','sap/viz/ui5/controls/common/feeds/AnalysisObject','sap/chart/TimeUnitType','sap/chart/utils/DateFormatUtil','sap/chart/utils/ChartUtils','sap/chart/utils/RoleMapper','sap/chart/ChartLog'],function(D,M,F,A,T,a,C,R,b){"use strict";var s=function(){return sap.viz.vizservices.BVRService.suggestFeeds.apply(null,arguments);};var c=function(f,i){var r=sap.viz.vizservices.FeedService.validate(f,i);if(!r.valid){var k=r.results?r.results.bindings:null;if(k&&Object.keys(k).every(function(m){return k[m].allowMND&&(!k[m].missing||k[m].missing===1)&&!k[m].incorrect;})){return{valid:true};}}return r;};var _=[{"types":"*","toViz":{"category|category2":"categoryAxis","series":"color","axis1|axis2|axis3|axis4":"valueAxis"}},{"types":"column|bar|stacked_bar|stacked_column|line|combination|100_stacked_bar|100_stacked_column|stacked_combination|horizontal_stacked_combination","toViz":{}},{"types":"scatter|bubble|time_bubble|timeseries_scatter|timeseries_bubble","toViz":{"category|category2":"@context","axis1":"valueAxis","axis2":"valueAxis2"}},{"types":"bubble|time_bubble","toViz":{"axis3":"bubbleWidth"}},{"types":"pie|donut","toViz":{"category|series|category2":"color","axis1|axis2|axis3|axis4":"size"}},{"types":"bullet|vertical_bullet","toViz":{"axis1|axis2|axis3|axis4":"@semanticBulletMsrs"}},{"types":"dual_combination|dual_horizontal_combination|dual_stacked_bar|100_dual_stacked_bar|dual_stacked_column|100_dual_stacked_column|dual_bar|dual_column|dual_line|dual_stacked_combination|dual_horizontal_stacked_combination","toViz":{"axis1":"valueAxis","axis2|axis3|axis4":"valueAxis2"}},{"types":"timeseries_line|timeseries_column|timeseries_combination|timeseries_stacked_column|timeseries_100_stacked_column","toViz":{"category":"timeAxis"}},{"types":"timeseries_scatter","toViz":{"category":R,"axis2|axis3":false}},{"types":"timeseries_bubble","toViz":{"category":R,"axis2":false,"axis3":"bubbleWidth"}},{"types":"dual_timeseries_combination","toViz":{"category":"timeAxis","axis1":"valueAxis","axis2|axis3|axis4":"valueAxis2"}},{"types":"heatmap","toViz":{"category":"categoryAxis","category2|series":"categoryAxis2","axis1|axis2|axis3|axis4":"color"}},{"types":"waterfall|horizontal_waterfall","toViz":{"series":"waterfallType"}},{"types":"timeseries_bullet","toViz":{"category|series":"timeAxis","axis1|axis2|axis3|axis4":"@semanticBulletMsrs"}},{"types":"timeseries_waterfall","toViz":{"category|series":"timeAxis"}}].reduce(function(m,f){var i=Object.keys(f.toViz).reduce(function(i,k){k.split("|").forEach(function(r){i[r]=f.toViz[k];return i;});return i;},{});f.types.split("|").forEach(function(k){if(!m.hasOwnProperty(k)){m[k]=[];}m[k].push(i);});return m;},{});var d=Object.keys(_).reduce(function(m,f){if(f!=="*"){m[f]=jQuery.extend.apply(null,[true,{}].concat(_["*"].concat(_[f])));}return m;},{});function e(f,k,v){var i=(typeof k==="function")?k:function(o){return o[k];};return f.reduce(function(o,m){var n=i(m),r=(typeof v==="function")?v(m):m;if(n&&!o[n]){o[n]=[r];}else if(n){o[n].push(r);}return o;},{});}function g(m,f){var o={},r;f.forEach(function(v){var i=v._sFixedRole||v.getRole();if(m.hasOwnProperty(i)){var k=m[i];if(k){if(typeof k==="function"){if(!r){r=new k();}k=r.toFeedingId(v);}if(!o[k]){o[k]=[];}o[k].push(v);}}});return o;}var L={from:F.fromLightWeightFmt,build:function(o){var f=[];jQuery.each(o.dims,function(k,v){f.push({id:k,type:"Dimension",values:v.map(h("Dimension"))});});jQuery.each(o.msrs,function(k,v){f.push({id:k,type:"Measure",values:v.map(h("Measure"))});});return f;}};function h(f){return function(o){var i=o.getName();if(i==="MND"){return{id:"MND",type:"MND"};}var k={id:i,name:i,type:f};if(o instanceof sap.chart.data.TimeDimension){k.dataType="Date";}return k;};}function w(o,p){var n=o.getName(),f=o.getLabel(),i=o.getTextProperty(),k=o.getTextFormatter(),m=o.getDisplayText();var r={identity:n,name:f||n,value:"{"+n+"}"};if(typeof k==="function"){r.displayValue={formatter:k,parts:[{path:n,type:new sap.ui.model.type.String()}]};if(i){r.displayValue.parts.push({path:i,type:new sap.ui.model.type.String()});}}else if(m&&i){r.displayValue="{"+i+"}";}var v=new D(r);if(p&&o instanceof sap.chart.data.TimeDimension){var O=a.getInstance(o.getTimeUnit());if(O){var P=O.parse.bind(O);v.getBindingInfo("value").formatter=function(V){return P(V);};}v.setDataType("Date");v._setTimeUnit(o.getTimeUnit());}return v;}function j(m){var n=m.getName();var o=new M({identity:n,name:m.getLabel()||n,value:"{"+n+"}"});o._setUnitBinding(m.getUnitBinding());return o;}function l(f,i){var m=sap.viz.api.metadata.Viz.get("info/"+f),k=e(m.bindings,"role"),n=e(i,"id"),o=k["layout.category"]||[],S=k["mark.color"]||[];if(o.length===0){return[];}else{var O=[];jQuery.each(o.concat(S),function(r,v){var P=n[v.id];if(P&&P.length>0){jQuery.each(P[0].values,function(Q,V){O.push(V.id);});}});return O;}}function p(f){return C.CONFIG.timeChartTypes.indexOf(f)>-1;}function q(f){return f&&f.indexOf('bullet')>-1;}function t(i){jQuery.each(i,function(f,m){if(m&&(m.getSemantics&&m.getSemantics()!=='actual'||m.getSemanticallyRelatedMeasures&&!jQuery.isEmptyObject(m.getSemanticallyRelatedMeasures()))){new b('error','Semantic Pattern'," Semantic pattern rule defined in invisible measures doesn't work.").display();}});}function u(f,i,m,k,n){var r=d[f];var o={dims:g(r,i),msrs:g(r,m)};if(q(f)){o.invisibleMsrs=n;}else{t(n);}var v=null,S=null;if(o.dims["@context"]){v=o.dims["@context"];delete o.dims["@context"];}var O=false;if(!k){if(R.semantics.hasSemanticMeasures(o)){var P;if(C.CONFIG.nonSemanticPatternChartType.indexOf(f)===-1){P=new b('error','Semantic Pattern',"Semantic pattern doesn't work when there is dataPointStyle or seriesStyle defined.");O=true;}else{P=new b('error','Semantic Pattern',f+" doesn't support semantic pattern feature.");O=true;}P.display();}}S=R.semantics.semanticPatternMsrs(o,f,O);v=(v||[]).concat(S.contexts);var Q=L.build(o);Q.contexts=v;Q.semanticTuples=S.semanticTuples;return Q;}var I=[{chartTypes:"bar,column,line,combination,heatmap,bullet,vertical_bullet,stacked_bar,stacked_column,stacked_combination,horizontal_stacked_combination,dual_bar,dual_column,dual_line,dual_stacked_bar,dual_stacked_column,dual_combination,dual_horizontal_combination,dual_stacked_combination,dual_horizontal_stacked_combination,100_stacked_bar,100_stacked_column,100_dual_stacked_bar,100_dual_stacked_column,waterfall,horizontal_waterfall".split(","),feed:"categoryAxis"},{chartTypes:"donut,pie,scatter,bubble".split(","),feed:"color"}];function x(f,k,m){var i,n;for(i=0;i<I.length;i++){if(I[i].chartTypes.indexOf(f)!==-1){n=I[i].feed;break;}}var o=k.some(function(v){return v.id===n;});if(!o){var r=s("info/"+f,k,[{id:"MND",type:"MND"}]).feedItems;k.splice(0,k.length);r.forEach(function(v){if(v.values.length>0){k.push(v);}});k=H(f,k);}for(i=0;i<k.length;i++){if(k[i].id===n&&k[i].type==="Dimension"){k[i].values=k[i].values.concat(m.map(function(v){return{id:v.getName(),name:v.getName(),type:"Dimension",inResult:true};}));}}return c("info/"+f,k);}function y(f){f.forEach(function(o){o._sFixedRole=o.getRole();});}function z(f,i,k){i.forEach(function(o){o.values.forEach(function(m){var n=k.filter(function(n){return n.getName()===m.id;})[0];if(n){jQuery.each(d[f],function(r,v){if(v===o.id){n._sFixedRole=r;return false;}});}});});}function B(f,i){var k=f.indexOf('timeseries_bullet')===-1;if(!k){k=i.length>1&&i.every(function(m){return(m.actual&&m.reference)||(m.projected&&m.reference);});}return k;}function E(k,m,n,r,O,P){var Q=m.concat(n).concat(r);y(Q);var S=u(k,m,n,O,P);var V=c("info/"+k,S);var U=S.contexts,W=S.semanticTuples,X=[];if(!V.valid){S=J(k,V,S,m,n);V=c("info/"+k,S);z(k,S,Q);if(C.CONFIG.nonSemanticPatternChartType.indexOf(k)===-1&&O){if(B(k,W)){S=u(k,m,n,O);U=S.contexts;W=S.semanticTuples;}}}else{z(k,S,Q);}if(W){X=W.filter(function(f){return f.projectedValueStartTime;});}if(V.valid&&r&&r.length>0){var Y=e(m,function(o){return o.getName();});x(k,S,r.filter(function(o){return!Y[o.getName()];}));}var Z=S.reduce(function(i,f){f.values.forEach(function(v){i[v.id]=true;});return i;},{});var $=L.from(S);if(U){U.forEach(function(f){Z[f.getName()]=true;});$._context=U.map(function(f){var o=f.getName();var v=true;for(var i=0;i<X.length;i++){if(o===X[i].actual||o===X[i].projected){v=false;break;}}return{id:o,showInTooltip:v};});}$._unused=K(S,m,n).filter(function(f){return!Z[f];});$._def=N(m,V.valid?r:[],n,Z,W,p(k));$._order=l(k,S);$._valid=V.valid;$._semanticTuples=W;return $;}function G(f){return e(sap.viz.api.metadata.Viz.get("info/"+f).bindings,"id");}function H(f,i,m){m=m||G(f);i.forEach(function(o){o.type=m[o.id][0].type;});return i;}function J(f,V,i,m,n){var o=G(f),r=false,O=false;var P=V.results.bindings;Object.keys(P).forEach(function(k){if(!o[k]){return;}if(o[k][0].type==="Measure"){O=true;}if(o[k][0].type==="Dimension"&&!(P[k].allowMND&&(!P[k].missing||P[k].missing===1))){r=true;}});var Q=i.filter(function(k){return!((k.type==="Dimension")?r:O);}),S=Q.reduce(function(k,Y){(Y.values||[]).forEach(function(v){k[v.id]=true;});return k;},{});if(i.contexts){i.contexts.forEach(function(k){S[k.getName()]=true;});}var U=m.map(h("Dimension")),W=n.map(h("Measure"));var X=s("info/"+f,Q,U.concat(W).filter(function(k){return!S[k.id];})).feedItems;H(f,X,o);return X;}function K(i,k,m){var U=i.reduce(function(n,f){f.values.forEach(function(v){n[v.id]=true;});return n;},{});return k.concat(m).filter(function(n){return!U[n.getName()];}).map(function(n){return n.getName();});}function N(f,k,m,v,S,p){var o;if(p){var n;for(var i=0;i<f.length;i++){if(f[i]instanceof sap.chart.data.TimeDimension){n=f[i];break;}}o=a.getInstance(n.getTimeUnit());}return{dim:f.reduce(function(V,r){if(v[r.getName()]){V.push(w(r,p));}return V;},[]).concat(k.map(function(r){var O=w(r);O._setInResult(true);return O;})),msr:m.reduce(function(V,r){if(v[r.getName()]){V.push(j(r));}return V;},[]).concat((S||[]).reduce(function(r,O){if(O.timeAxis&&O.projectedValueStartTime){r.push(new M({identity:O.actual+"-"+O.projected,name:((O.labels&&O.labels.actual)||O.actual)+"-"+((O.labels&&O.labels.projected)||O.projected),value:{parts:[O.timeAxis,O.actual,O.projected],formatter:function(P){var Q=P,U;if(P&&P.length>1){var V=P[0];if(V){if(o){var W=o.parse(V);if(W){U=W.getTime();}}else{U=new Date(V).getTime();}if(U&&(U<O.projectedValueStartTime)){Q=P[1];}else{Q=P[2];}}}return Q;}}}));}return r;},[]))};}return{fit:E,compatible:function(f,i,m){var n="info/"+f,r={used:{},error:null,compatible:true};var O=u(f,i,m),V=c(n,O);if(!V.valid){O=J(f,V,O,i,m);V=c(n,O);r.needFix=true;}if(V.valid){r.used=e(O,function(o){return o.type;},function(o){return o.values.filter(function(v){return v.type==="Dimension"||v.type==="Measure";}).map(function(v){return v.id;});});jQuery.each(r.used,function(k,v){r.used[k]=v.reduce(function(o,U){return o.concat(U);},[]);});}else{r.compatible=false;var P=sap.viz.api.metadata.Viz.get(n).bindings,Q=e(P,"type",function(o){return o.id;}),S={dim:0,msr:0,time:0};jQuery.each(V.results.bindings,function(k,v){if(!v.missing){return;}if(Q.Dimension.indexOf(k)!==-1&&!(v.allowMND&&v.missing===1)){S[k==="timeAxis"?"time":"dim"]+=v.missing;}else if(Q.Measure.indexOf(k)!==-1){S.msr+=v.missing;}});r.error={missing:S};}return r;}};});
