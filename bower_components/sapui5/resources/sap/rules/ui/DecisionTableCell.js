/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/DecisionTableCellExpressionAdvanced","sap/rules/ui/type/DecisionTableCell","sap/rules/ui/DecisionTableCellExpressionBasic","sap/m/Popover"],function(q,l,D,a,b,P){"use strict";var c=sap.ui.core.Control.extend("sap.rules.ui.DecisionTableCell",{metadata:{library:"sap.rules.ui",properties:{valuePath:{type:"string",defaultValue:"",bindable:"bindable"},valueOnlyPath:{type:"string",defaultValue:"",bindable:"bindable"},headerValuePath:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperatorPath:{type:"string",defaultValue:"",bindable:"bindable"},typePath:{typePath:"string",bindable:"bindable"},valueStatePath:{type:"string",defaultValue:"null",bindable:"bindable"},valueStateTextPath:{type:"string",defaultValue:"null",bindable:"bindable"},valueModelName:{type:"string",defaultValue:"",bindable:"bindable"},displayModelName:{type:"string",defaultValue:"",bindable:"bindable"},editable:{type:"boolean",defaultValue:true},inFocus:{type:"boolean",defaultValue:false},decisionTableCellType:{type:"sap.rules.ui.type.DecisionTableCell",multiple:false}},aggregations:{_displayedControl:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,validateOnLoad:true,singularName:"expressionLanguage"}}}});c.prototype.onFocusIn=function(){var A=function(e){var d=e.getSource().getAggregation('content')[1];d.setVisible(true);var o=this.getAggregation("_displayedControl");o.setEnabled(false);}.bind(this);var B=function(e){var o=this.getAggregation("_displayedControl");o.setEnabled(true);}.bind(this);var f=function(e){if(this._oPopover){var d=this._oPopover.getAggregation('content')[1];if(d instanceof sap.rules.ui.ExpressionAdvanced){if(d.codeMirror){var E=d.codeMirror.getValue();d.setValue(E);}}this._oPopover.destroy();this._oPopover=null;var o=this.getAggregation("_displayedControl");o.focus();}}.bind(this);if(!this._oPopover){var v=this.getModel().getProperty(this.getValueOnlyPath());if(v){this._oPopover=sap.ui.xmlfragment("sap.rules.ui.fragments.DecisionTableCellExpressionBasic",this);}else{this._oPopover=sap.ui.xmlfragment("sap.rules.ui.fragments.DecisionTableCellExpressionAdvanced",this);}this._oPopover.attachAfterOpen(A);this._oPopover.attachBeforeClose(B);this._oPopover.attachAfterClose(f);this.addDependent(this._oPopover);var n=q.sap.byId(this.getId()).closest('td').width()*0.93;var w=n+"px";var s=this._oPopover.getAggregation('content')[0];s.setWidth(w);var d=this._oPopover.getAggregation('content')[1];d.setExpressionLanguage(this.getExpressionLanguage());this._bindPopOverFragment(d);var i=this.getAggregation("_displayedControl");this._oPopover.openBy(i);}};c.prototype.onBeforeRendering=function(){this._setDisplayedControl();};c.prototype.onAfterRendering=function(){};c.prototype.init=function(){};c.prototype._setDisplayedControl=function(){var d=this._createStaticControl();this.setAggregation("_displayedControl",d,true);};c.prototype._createStaticControl=function(){var e=this.getModel("dtModel").getProperty("/editable");var d=this.getAggregation("_displayedControl");if(d){d.destroy();}d=new sap.m.Input({editable:false,enabled:e});d.addDelegate({onclick:function(E){if(e){this.onFocusIn();}}.bind(this),onkeyup:function(E){if(E.keyCode===13&&e){this.onFocusIn();}else{return;}}.bind(this)});var v=this.getDisplayModelName()+">"+this.getValuePath();if(v&&v!=="null"){d.bindValue(v);d.bindProperty("tooltip",{path:v,formatter:function(V){return V;}});}var f=this.getValueStatePath();if(f&&f!=="null"){d.bindProperty("valueState",{path:f,formatter:function(V){var g=sap.ui.core.ValueState.None;if(V===sap.ui.core.ValueState.Error){g=sap.ui.core.ValueState.Error;}return g;}.bind(this)});}return d;};c.prototype._bindPopOverFragment=function(e){var d=this.getDisplayModelName()+">"+this.getValuePath();var v=this.getValueModelName()?this.getValueModelName()+">"+this.getValuePath():this.getValuePath();var f=this.getDisplayModelName()?this.getDisplayModelName()+">"+this.getHeaderValuePath():this.getHeaderValuePath();var g=this.getDisplayModelName()?this.getDisplayModelName()+">"+this.getFixedOperatorPath():this.getFixedOperatorPath();if(v&&v!=="null"){if(!this.getTypePath()){e.bindValue({parts:[{path:f},{path:g},{path:v},{path:d}],type:this.getDecisionTableCellType()});}else{e.bindValue({parts:[{path:v},{path:this.getTypePath()},{path:d}],type:this.getDecisionTableCellType()});}}if(this.getTypePath()){e.bindType(this.getTypePath());}if(f){e.bindHeaderValue(f);if(g){e.bindFixedOperator(g);}}};return c;},true);
