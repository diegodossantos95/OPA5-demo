/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/Utils","sap/rules/ui/ExpressionAdvanced"],function(q,l,U,E){"use strict";var D=E.extend("sap.rules.ui.DecisionTableCellExpressionAdvanced",{metadata:{library:"sap.rules.ui",properties:{headerValue:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperator:{type:"string",defaultValue:"",bindable:"bindable"},type:{type:"sap.rules.ui.ExpressionType",defaultValue:sap.rules.ui.ExpressionType.BooleanEnhanced,bindable:"bindable"}}}});D.prototype.validateExpression=function(){var e=this.codeMirror?this.codeMirror.getValue():this.getValue();if(e){var v=this.getHeaderValue()+" "+this.getFixedOperator()+" "+e;sap.rules.ui.ExpressionAdvanced.prototype.validateExpression.apply(this,[v]);}else{this.setValueStateText("");}};D.prototype.init=function(){sap.rules.ui.ExpressionAdvanced.prototype.init.apply(this,arguments);this.bFlagForChangeBeforeBlur=false;};D.prototype.onAfterRendering=function(){sap.rules.ui.ExpressionAdvanced.prototype.onAfterRendering.apply(this,arguments);this.codeMirror.options.fixedOperator=this.getFixedOperator();this.codeMirror.options.headerValue=this.getHeaderValue();this.codeMirror.options.filterOutStructuredCond=true;this.oDecisionTableCell=(this.getParent()&&this.getParent().getParent())?this.getParent().getParent():null;this._handleValidation();if(q.sap.byId(this.getId()).closest('td').next().width()){this._showPopUp();}if(this.oDecisionTableCell){var v=this.oDecisionTableCell.getValueStatePath();var d=this.oDecisionTableCell.getModel("dtModel");var o=this.oDecisionTableCell.getAggregation("_displayedControl");if(o){d.setProperty(v.slice(8),sap.ui.core.ValueState.None);}}this.createEventListeners();;};D.prototype._handleValidation=function(){this.validateExpression();this._showErrorMessage();if(this.getProperty("valueStateText")&&this.codeMirror){this.codeMirror.options.expressionEditor._showPopUp();}};D.prototype._processValidationResult=function(r){sap.rules.ui.ExpressionAdvanced.prototype._processValidationResult.apply(this,arguments);if(this.oDecisionTableCell){var v=this.oDecisionTableCell.getValueStateTextPath();var a=this.oDecisionTableCell.getValueStatePath();var d=this.oDecisionTableCell.getModel("dtModel");var o=this.oDecisionTableCell.getAggregation("_displayedControl");if(o&&r.status===sap.rules.ui.ValidationStatus.Error){var e=this.getValueStateText();d.setProperty(v.slice(8),e);if(!this.oDecisionTableCell._oPopover||!this.oDecisionTableCell._oPopover.isOpen()){d.setProperty(a.slice(8),sap.ui.core.ValueState.Error);}else{d.setProperty(a.slice(8),sap.ui.core.ValueState.None);}this.setProperty("valueStateText",e);}else if(o){d.setProperty(v.slice(8),"null");d.setProperty(a.slice(8),sap.ui.core.ValueState.None);this.setProperty("valueStateText","");}}};D.prototype.exit=function(){sap.rules.ui.ExpressionAdvanced.prototype.exit.apply(this,arguments);this._handleValidation();this._closePopUp();this.pop=null;var c=this.codeMirror;if(c&&c.state.completionActive){c.state.completionActive.onClose();}if(this.bFocusCellAfterEscape&&this.oDecisionTableCell){var h=this.oDecisionTableCell.getDomRef().parentElement.parentElement;if(h){q(h).focus();}}};D.prototype.getFormattingTokens=function(e){var s=this._liveValue;var h=this.getHeaderValue();var f=this.getFixedOperator();var t="All";var r=e.getDecisionTableCellTokens(h,f,s,t);var a;if(r.tokens&&r.tokens.cell){a=r.tokens.cell;this.setExpressionTokens(a);}};D.prototype.createEventListeners=function(){document.getElementById(this.getId()).addEventListener("keydown",function(e){var k=e.keyCode||e.charCode;if(k===8){this.bFlagForChangeBeforeBlur=true;}else if(k===27){this.bFocusCellAfterEscape=true;}}.bind(this),true);var c=('ontouchstart'in document.documentElement)?'touchstart':'mousedown';if(c==='touchstart'){document.addEventListener("mousedown",function(e){if(e.target.className.includes("CodeMirror-hint")){e.stopPropagation();}}.bind(this),true);document.addEventListener("touchstart",function(e){if(e.target.className.includes("CodeMirror-hint")){e.stopPropagation();}}.bind(this),true);}if(!(window.ActiveXObject)&&"ActiveXObject"in window){this.codeMirror.on("blur",function(a,e){this.bFlagForPreventBlurWhenPopOverOpen=true;}.bind(this));document.getElementById(this.getId()).addEventListener("mousedown",function(e){this.bFlagForChangeBeforeBlur=true;}.bind(this),true);}if((navigator.userAgent.toLowerCase().indexOf('firefox')>-1)){document.addEventListener("mousedown",function(e){this.bIsClickedOnTheAutoComplete=e.target.className.includes("CodeMirror-hint");}.bind(this),true);document.addEventListener("blur",function(e){if(this.bIsClickedOnTheAutoComplete||this.ValueHelpRequested===true){this.bIsClickedOnTheAutoComplete=false;e.stopPropagation();}}.bind(this),true);}};return D;},true);
