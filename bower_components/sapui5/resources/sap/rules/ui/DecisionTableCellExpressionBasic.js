/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/ExpressionBasic","sap/rules/ui/InstructionRenderer"],function(q,l,E,I){"use strict";var D=E.extend("sap.rules.ui.DecisionTableCellExpressionBasic",{metadata:{library:"sap.rules.ui",properties:{headerValue:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperator:{type:"string",defaultValue:"",bindable:"bindable"},type:{type:"sap.rules.ui.ExpressionType",defaultValue:sap.rules.ui.ExpressionType.BooleanEnhanced,bindable:"bindable"}}},_reload:function(){this.shouldReload=false;this.sHeaderValue=this.getHeaderValue();this.FixedOperatorValue=this.getFixedOperator();this.sCellValue=this.getValue();this.sValueFromSettings=(this.sHeaderValue+" "+this.FixedOperatorValue);this.sValue=(this.sValueFromSettings+this.sCellValue).trim();var e=sap.ui.getCore().byId(this.getExpressionLanguage());var s;if(!this.sHeaderValue&&!this.FixedOperatorValue){this.setProperty("value",this.sValue);sap.rules.ui.ExpressionBasic.prototype._reload.apply(this,arguments);return;}else{if(this.sHeaderValue&&this.FixedOperatorValue){s=e._getRightSuggestions(this.sHeaderValue,this.FixedOperatorValue,this.sCellValue,null,null);if(this._checkForValueHelpSuggestions(s)){return;}}else if(this.sHeaderValue&&!this.FixedOperatorValue){var t=e.validateExpression(this.sHeaderValue);if(t.status==="Error"){this.bReadOnly=true;this.bFlagForChange=true;s=[e._getLeftSuggestions("","")];}else{var c=this._getSubExpression(this.sCellValue);var a=(c[1])?c[1].exp:"";s=[e._getCompSuggestions(this.sHeaderValue,a,null)];if(a){var r;var b=(c[2])?c[2].exp:"";r=e._getRightSuggestions(this.sHeaderValue,a,b,null,null);s.push.apply(s,r);if(this._checkForValueHelpSuggestions(s)){return;}}}}this.instructions=this._createInstructions(s);var i=new I({instructions:this.instructions,useIndent:false,change:this._onChange.bind(this)});this.setAggregation("_instructionRenderer",i,true);}},_calculateOffSet:function(){if(!this.sHeaderValue&&!this.FixedOperatorValue){this.offSet=0;}else if(this.sHeaderValue&&this.FixedOperatorValue){this.offSet=2;}else{this.offSet=1;}},_onChangeByIndex:function(i,p){sap.rules.ui.ExpressionBasic.prototype._onChangeByIndex.apply(this,[this.offSet+i,this.sHeaderValue+this.FixedOperatorValue,i]);}});D.prototype.init=function(){};D.prototype.exit=function(){this._handleValidation();};D.prototype.validateExpression=function(){};D.prototype.onAfterRendering=function(){sap.rules.ui.ExpressionBasic.prototype.onAfterRendering.apply(this,arguments);this._calculateOffSet();this.oDecisionTableCell=(this.getParent()&&this.getParent().getParent())?this.getParent().getParent():null;var v=this.oDecisionTableCell.getValueStatePath();var d=this.oDecisionTableCell.getModel("dtModel");this.setProperty("valueStateText","");d.setProperty(v.slice(8),sap.ui.core.ValueState.None);this.createEventListeners();};D.prototype.onBeforeRendering=function(){sap.rules.ui.ExpressionBasic.prototype.onBeforeRendering.apply(this,arguments);};D.prototype._getSubExpression=function(e){var o=sap.ui.getCore().byId(this.getExpressionLanguage());return o._getSubExpressions(null,"dummy "+e);};D.prototype._handleValidation=function(){var e;var h=this.getHeaderValue();var F=this.getFixedOperator();var c=this.getValue();var a;if(!c){a=c;}else{a=h+" "+F+" "+c;}var b=sap.ui.getCore().byId(this.getExpressionLanguage());if(a){var r=b.validateExpression(a);if(r.deferredResult){r.deferredResult.done(function(r){if(this.oDecisionTableCell){var v=this.oDecisionTableCell.getValueStateTextPath();var d=this.oDecisionTableCell.getValueStatePath();var f=this.oDecisionTableCell.getModel("dtModel");if(r.status===sap.rules.ui.ValidationStatus.Error){e=r.errorDetails.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ");f.setProperty(v.slice(8),e);if(!this.oDecisionTableCell._oPopover||!this.oDecisionTableCell._oPopover.isOpen()){f.setProperty(d.slice(8),sap.ui.core.ValueState.Error);}else{f.setProperty(d.slice(8),sap.ui.core.ValueState.None);}this.setProperty("valueStateText",e);}else{this.setProperty("valueStateText","");f.setProperty(v.slice(8),"null");f.setProperty(d.slice(8),sap.ui.core.ValueState.None);}}}.bind(this));}var v=this.oDecisionTableCell.getValueStateTextPath();var d=this.oDecisionTableCell.getValueStatePath();var f=this.oDecisionTableCell.getModel("dtModel");if(r.status===sap.rules.ui.ValidationStatus.Error){e=r.errorDetails.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ");this.setProperty("valueStateText",e);f.setProperty(v.slice(8),e);f.setProperty(d.slice(8),sap.ui.core.ValueState.Error);}else{this.setProperty("valueStateText","");f.setProperty(v.slice(8),"null");f.setProperty(d.slice(8),sap.ui.core.ValueState.None);}}};D.prototype.createEventListeners=function(){var h=this.oDecisionTableCell.getDomRef().parentElement.parentElement;if(h){document.getElementById(this.getId()).addEventListener("keyup",function(e){if(e.keyCode===27){q(h).focus();}}.bind(this));}};return D;},true);
