jQuery.sap.declare("sap.rules.ui.parser.ruleBody.lib.ruleBodyConvertor");jQuery.sap.require("sap.rules.ui.parser.ruleBody.lib.ruleBodyValidator");jQuery.sap.require("sap.rules.ui.parser.ruleBody.lib.constants");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.constants");jQuery.sap.require("sap.rules.ui.parser.infrastructure.util.utilsBase");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.valueHelpValidator");jQuery.sap.require("sap.rules.ui.parser.ruleBody.lib.decisionTableCell");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.ASTConvertor");jQuery.sap.require("sap.rules.ui.parser.AST.lib.bundleAst");sap.rules.ui.parser.ruleBody.lib.ruleBodyConvertor=sap.rules.ui.parser.ruleBody.lib.ruleBodyConvertor||{};sap.rules.ui.parser.ruleBody.lib.ruleBodyConvertor.lib=(function(){var r=sap.rules.ui.parser.ruleBody.lib.ruleBodyValidator.lib;var c=sap.rules.ui.parser.ruleBody.lib.constants.lib;var p=sap.rules.ui.parser.businessLanguage.lib.constants.lib;var u=new sap.rules.ui.parser.infrastructure.util.utilsBase.lib.utilsBaseLib();var v=sap.rules.ui.parser.businessLanguage.lib.valueHelpValidator.lib;var d=sap.rules.ui.parser.ruleBody.lib.decisionTableCell.lib;var A=sap.rules.ui.parser.businessLanguage.lib.ASTConvertor.lib;var b=RulesAPI_Ast;var a=b.astOperations;function R(D){jQuery.sap.log.debug("CTOR - Rule Convertor");this.oDataRule=D;r.RuleBodyValidator.call(this);this.decisionTableData=D?JSON.parse(JSON.stringify(D)):null;this.ruleValueHelpInfoArray=[];this.needASTResult=false;}R.prototype=Object.create(r.RuleBodyValidator.prototype);R.prototype.constructor=R;R.prototype.getSerializedExpressionAndAST=function getSerializedExpressionAndAST(f,o){var g={};g.convertedData={};g.serializedData=f;if(this.needASTResult){var h=new A.ASTConvertor(o);g.convertedData.AST=h.getAST();g.convertedData.text=f;g.serializedData=d.serializeExpression(g.convertedData);}return g;};R.prototype.getConvertedData=function getConvertedData(f,g,h){f[h]=g;return f;};R.prototype.addParserResults=function addParserResults(f,g,s){var h={};h.status=s;if(g){h.converted=g;}u.setJsonValueAccordingPath(this.decisionTableData,f,c.decisionTableDataOutputPropEnum.parserResults,h);};R.prototype.hasParserConvertedExpression=function hasParserConvertedExpression(){if(this.currentParserResult.status===p.statusEnum.SUCCESS){if(!this.currentParserResult.hasOwnProperty(c.parserResultEnum.convertedExpression)){if(!this.flags[c.outputFlagsEnum.ASTOutput]){this.status=c.RULE_ERROR;}}else{return true;}}return false;};R.prototype.getParserConvertedExpression=function getParserConvertedExpression(){return this.currentParserResult[c.parserResultEnum.convertedExpression];};function m(f,g){var i=0;var j=0;var h=false;for(i=0;i<f.length;++i){h=false;for(j=0;j<g.length;++j){if(f[i]===g[j]){h=true;break;}}if(h===false){g.push(f[i]);}}}function e(f,g){var i=0;var h=-1;for(i=0;i<f.length;++i){h=v.getValueHelpIndexInInfoArray(f[i][p.propertiesEnum.id],g);if(h===-1){g.push(f[i]);}else{m(f[i][p.propertiesEnum.values],g[h][p.propertiesEnum.values]);}}}R.prototype.handleTextCondition=function handleTextCondition(f,g,h){r.RuleBodyValidator.prototype.handleTextCondition.call(this,f,g,h);if(this.status===c.RULE_SUCCESS&&this.hasParserConvertedExpression()){this.ruleBodyCopy.content.condition=this.getParserConvertedExpression();}};R.prototype.handleTextOutputParameter=function handleTextOutputParameter(f,g,h){r.RuleBodyValidator.prototype.handleTextOutputParameter.call(this,f,g,h);if(this.status===c.RULE_SUCCESS&&this.hasParserConvertedExpression()){f.content=this.getParserConvertedExpression();}};R.prototype.handleTextActionParameter=function handleTextActionParameter(f,g,i,h){r.RuleBodyValidator.prototype.handleTextActionParameter.call(this,f,g,i,h);if(this.status===c.RULE_SUCCESS&&this.hasParserConvertedExpression()){f.content=this.getParserConvertedExpression();}};R.prototype.handleDecisionTableCondition=function handleDecisionTableCondition(h,f,g,i){var j,k;var l={};var n={};i=r.RuleBodyValidator.prototype.handleDecisionTableCondition.call(this,h,f,g,i);if(this.hasParserConvertedExpression()&&this.invalidHeaders[h.colID]!==true){j=this.getParserConvertedExpression();var o=h.hasOwnProperty(c.afterConversionParts.fixedOperator)?h.fixedOperator.operator:null;k=this.splitDecisionTableCondition(h.convertedExpression,j,o);if(this.flags[c.outputFlagsEnum.oDataOutput]){if(this.needASTResult){var q=new A.ASTConvertor(this.currentParserResult.model);var s=q.getAST();if(h.AST){var t=a.split(h.AST,s,A.ASTConvertor.operatorsMap[o]);n.AST=t?t.rest:null;}else{n.AST=s;}n.text=k;k=d.serializeExpression(n);}l=this.getConvertedData(l,k,c.decisionTableExpressionParts.content);this.addParserResults(f.row[g].inputModelPath,l,this.currentParserResult.status);}else if(this.status===c.RULE_SUCCESS){h.expression=h.convertedExpression;f.row[g].content=k;}}else if(this.flags[c.outputFlagsEnum.oDataOutput]){this.addParserResults(f.row[g].inputModelPath,null,p.statusEnum.ERROR);}if(this.flags[c.outputFlagsEnum.ASTOutput]&&this.currentParserResult.status===p.statusEnum.SUCCESS){l=this.getConvertedData(l,this.currentParserResult.model,c.decisionTableExpressionParts.astOutput);this.addParserResults(f.row[g].inputModelPath,l,this.currentParserResult.status);}if(this.flags[p.propertiesEnum.valueHelp]&&this.flags[p.propertiesEnum.valueHelp].hasOwnProperty(p.propertiesEnum.collectInfo)&&(this.flags[p.propertiesEnum.valueHelp][p.propertiesEnum.collectInfo]===true)&&(this.currentParserResult.status===p.statusEnum.SUCCESS)&&this.currentParserResult[p.propertiesEnum.valueHelp]){e(this.currentParserResult[p.propertiesEnum.valueHelp][p.propertiesEnum.info],this.ruleValueHelpInfoArray);}return i;};R.prototype.handleDecisionTableActionParameter=function handleDecisionTableActionParameter(h,f,g,i){i=r.RuleBodyValidator.prototype.handleDecisionTableActionParameter.call(this,h,f,g,i);if(this.status===c.RULE_SUCCESS&&this.hasParserConvertedExpression()){f.row[g].content=this.getParserConvertedExpression();}return i;};R.prototype.handleDecisionTableOutputParameter=function handleDecisionTableOutputParameter(h,f,g,i){var j={};var k;var l;i=r.RuleBodyValidator.prototype.handleDecisionTableOutputParameter.call(this,h,f,g,i);if(this.hasParserConvertedExpression()&&this.invalidHeaders[h.colID]!==true){k=this.getParserConvertedExpression();if(this.flags[c.outputFlagsEnum.oDataOutput]){l=this.getSerializedExpressionAndAST(k,this.currentParserResult.model);k=l.serializedData;j=this.getConvertedData(j,k,c.decisionTableExpressionParts.content);this.addParserResults(f.row[g].inputModelPath,j,this.currentParserResult.status);}else if(this.status===c.RULE_SUCCESS){f.row[g].content=k;}}else if(this.flags[c.outputFlagsEnum.oDataOutput]){this.addParserResults(f.row[g].inputModelPath,null,p.statusEnum.ERROR);}if(this.flags[c.outputFlagsEnum.ASTOutput]&&this.currentParserResult.status===p.statusEnum.SUCCESS){j=this.getConvertedData(j,this.currentParserResult.model,c.decisionTableExpressionParts.astOutput);this.addParserResults(f.row[g].inputModelPath,j,this.currentParserResult.status);}return i;};R.prototype.handleConditionHeader=function handleConditionHeader(h){var f={};var g;var o={};r.RuleBodyValidator.prototype.handleConditionHeader.call(this,h);if(this.hasParserConvertedExpression()){g=this.getParserConvertedExpression();if(this.flags[c.outputFlagsEnum.oDataOutput]){h.convertedExpression=g;var i=this.getSerializedExpressionAndAST(g,this.currentParserResult.model);g=i.serializedData;f=this.getConvertedData(f,g,c.decisionTableExpressionParts.expression);if(this.needASTResult){h.AST=i.convertedData.AST;}if(h.hasOwnProperty(c.afterConversionParts.fixedOperator)){if(this.needASTResult){o.text=h.fixedOperator.operator;o.AST=h.fixedOperator.operator?a.buildOperator(A.ASTConvertor.operatorsMap[o.text]):null;g=d.serializeExpression(o);f=this.getConvertedData(f,g,c.decisionTableExpressionParts.fixedOperator);h.AST=i.convertedData.AST;}else if(this.needDeserializeInput){f=this.getConvertedData(f,h.fixedOperator.operator,c.decisionTableExpressionParts.fixedOperator);}}this.addParserResults(h.inputModelPath,f,this.currentParserResult.status);}else if(this.status===c.RULE_SUCCESS){h.convertedExpression=g;}}else if(this.flags[c.outputFlagsEnum.oDataOutput]){this.addParserResults(h.inputModelPath,null,this.currentParserResult.status);}if(this.flags[c.outputFlagsEnum.ASTOutput]&&this.currentParserResult.status===p.statusEnum.SUCCESS){f=this.getConvertedData(f,this.currentParserResult.model,c.decisionTableExpressionParts.astOutput);this.addParserResults(h.inputModelPath,f,this.currentParserResult.status);}if(this.flags[p.propertiesEnum.valueHelp]&&this.flags[p.propertiesEnum.valueHelp].hasOwnProperty(p.propertiesEnum.collectInfo)&&(this.flags[p.propertiesEnum.valueHelp][p.propertiesEnum.collectInfo]===true)&&(this.currentParserResult.status===p.statusEnum.SUCCESS)&&this.currentParserResult[p.propertiesEnum.valueHelp]){e(this.currentParserResult[p.propertiesEnum.valueHelp][p.propertiesEnum.info],this.ruleValueHelpInfoArray);}};R.prototype.finalizeResult=function finalizeResult(f){var i;if(!this.flags[c.outputFlagsEnum.oDataOutput]){for(i=0;i<f.content.headers.length;i++){if(f.content.headers[i].hasOwnProperty(c.parserResultEnum.convertedExpression)){delete f.content.headers[i].convertedExpression;}}}};R.prototype.initFlags=function initFlags(f){r.RuleBodyValidator.prototype.initFlags.call(this,f);if(f!==null&&f!==undefined){if(f.hasOwnProperty(c.outputFlagsEnum.conversionOutput)){this.flags[c.outputFlagsEnum.conversionOutput]=f[c.outputFlagsEnum.conversionOutput];}else if(f.hasOwnProperty(c.outputFlagsEnum.locale)&&f[c.outputFlagsEnum.locale].hasOwnProperty(c.localeEnum.convert)&&f[c.outputFlagsEnum.locale][c.localeEnum.convert]){this.flags[c.outputFlagsEnum.locale]=f[c.outputFlagsEnum.locale];}if(f.hasOwnProperty(p.propertiesEnum.termMode)&&f[p.propertiesEnum.termMode].hasOwnProperty(p.propertiesEnum.convert)&&f[p.propertiesEnum.termMode][p.propertiesEnum.convert]){this.flags[p.propertiesEnum.termMode]=f[p.propertiesEnum.termMode];}if(this.oDataRule){this.flags[c.outputFlagsEnum.oDataOutput]=true;}else{this.flags[c.outputFlagsEnum.oDataOutput]=false;}this.flags[c.outputFlagsEnum.ASTOutput]=f.hasOwnProperty(c.outputFlagsEnum.ASTOutput)?f[c.outputFlagsEnum.ASTOutput]:false;if(f&&f.hasOwnProperty(p.propertiesEnum.valueHelp)){this.flags[p.propertiesEnum.valueHelp]={};this.flags[p.propertiesEnum.valueHelp]=f[p.propertiesEnum.valueHelp];}}};R.prototype.convert=function convert(f,g,h,i,o,j,t){this.needASTResult=d.needASTResult(i,f.relVersion);var k=this.validateBusinessRule(f,g,h,i,o,j,t);if(this.ruleValueHelpInfoArray.length>0){k[p.propertiesEnum.valueHelp]={};k[p.propertiesEnum.valueHelp][p.propertiesEnum.info]=this.ruleValueHelpInfoArray;}if(this.flags[c.outputFlagsEnum.oDataOutput]){k.decisionTableData=this.decisionTableData;}else{if(this.status===c.RULE_SUCCESS){k.convertedRuleBody=this.ruleBodyCopy;}else{k.convertedRuleBody=null;}}return k;};return{RuleBodyConvertor:R};}());
