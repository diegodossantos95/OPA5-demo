jQuery.sap.declare("sap.rules.ui.parser.businessLanguage.lib.parsingBackendMediator");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.constants");jQuery.sap.require("sap.rules.ui.parser.resources.dependencies.lib.constantsBase");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.parseModel");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.parseUtils");jQuery.sap.require("sap.rules.ui.parser.resources.vocabulary.lib.parameterRuntimeServices");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.IDPLexer");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.IDPParser");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.autoCompleteUtils");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.parserTokens");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.antlr3_all_min");jQuery.sap.require("sap.rules.ui.parser.resources.vocabulary.lib.vocabularyDataProviderFactory");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.conversionUtils");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.valueHelpValidator");sap.rules.ui.parser.businessLanguage.lib.parsingBackendMediator=sap.rules.ui.parser.businessLanguage.lib.parsingBackendMediator||{};sap.rules.ui.parser.businessLanguage.lib.parsingBackendMediator.lib=(function(){var p=sap.rules.ui.parser.businessLanguage.lib.parseUtils.lib;var a=new p.parseUtilsLib();var c=sap.rules.ui.parser.businessLanguage.lib.constants.lib;var d=sap.rules.ui.parser.resources.dependencies.lib.constantsBase.lib;var b=sap.rules.ui.parser.businessLanguage.lib.parseModel.lib;var e=new b.parseModelLib();var f=sap.rules.ui.parser.resources.vocabulary.lib.parameterRuntimeServices;var g=sap.rules.ui.parser.businessLanguage.lib.autoCompleteUtils.lib;var h=new g.autoCompleteUtilsLib();var v=sap.rules.ui.parser.resources.vocabulary.lib.vocabularyDataProviderFactory.lib;var r=new v.vocaDataProviderFactoryLib();var I=sap.rules.ui.parser.businessLanguage.lib.IDPLexer.lib;var i=sap.rules.ui.parser.businessLanguage.lib.IDPParser.lib;var j=sap.rules.ui.parser.businessLanguage.lib.conversionUtils.lib;var k=new j.conversionUtilsLib();var o=sap.rules.ui.parser.businessLanguage.lib.antlr3_all_min.lib;var l=sap.rules.ui.parser.businessLanguage.lib.parserTokens.lib;var m=sap.rules.ui.parser.businessLanguage.lib.valueHelpValidator.lib;function q(){}q.prototype.getRELType=function getRELType(n,s){var t;t=(n===undefined||n===null)?c.TYPE_ALL:n;if(s!==null&&s!==undefined&&s[c.propertiesEnum.isCollection]===true){t=a.getCollectionRelTypeFromBusinessDT(t);}return t;};q.prototype.parseExpression=function(s,t,u,w,x,y,z){function C(E,z){var A="";var B=z&&z.hasOwnProperty(c.propertiesEnum.locale);var P=z&&z.hasOwnProperty(c.propertiesEnum.locale)&&z[c.propertiesEnum.locale].hasOwnProperty(c.propertiesEnum.convert)&&z[c.propertiesEnum.locale][c.propertiesEnum.convert].hasOwnProperty(c.propertiesEnum.source)&&z[c.propertiesEnum.locale][c.propertiesEnum.convert].hasOwnProperty(c.propertiesEnum.target)&&(z[c.propertiesEnum.locale][c.propertiesEnum.convert][c.propertiesEnum.source]===c.CODE_TEXT)&&(z[c.propertiesEnum.locale][c.propertiesEnum.convert][c.propertiesEnum.target]===c.DISPLAY_TEXT);if(!B||P){var Q=false;var R=false;var S="";var T='';if(typeof E!=='string'){A=E;}else{for(T in E){if(E.hasOwnProperty(T)){if(!E[T]){continue;}R=false;switch(E[T]){case"'":Q=!Q;break;case",":if(Q===false){R=true;}break;}if(R===true){S+=';';}else{S+=E[T];}}}A=S;}}else{A=E;}return A;}try{jQuery.sap.log.debug("ParsingBackendMediator expression to parse: "+s);var D=e.createModelManger();D.vocaRTServ=u;D.vocabulary=y;D.mode=t;D.paramServ=w;D.flags=(z===undefined||z===null)?{}:z;x=this.getRELType(x,z);s=C(s,z);var E=s;if(s!==null&&(s!==undefined)){s=s.toString();s=s.replace(/(\r\n|\n|\r)/gm," ");s=s.replace(/\\/g,"\\\\");}if(s===null||s===undefined||a.isBlank(s)){var F={};F.status=c.statusEnum.SUCCESS;if(t===c.TOKEN_TYPES||(D.flags.hasOwnProperty(c.propertiesEnum.tokens)&&D.flags[c.propertiesEnum.tokens]===true)){F.tokens=[];if(s!==null&&s!==undefined){var n=E.length;var G=new a.TokenInfo(E,c.tokenTypesEnum.whitespace,null,0,n);F.tokens.push(G);}}if(t===c.VALIDATE_MODE||t===c.PARSE_MODE){F.errorDetails=null;F.model=null;F.cursorPosition=null;F.actualReturnType=c.TYPE_ALL;if((D.flags.hasOwnProperty(c.propertiesEnum.conversionOutput)&&((D.flags[c.propertiesEnum.conversionOutput]===c.conversionOutputEnum.toKeys)||(D.flags[c.propertiesEnum.conversionOutput]===c.conversionOutputEnum.toDescriptions)))||(z&&z.hasOwnProperty(c.propertiesEnum.locale)&&z[c.propertiesEnum.locale].hasOwnProperty(c.propertiesEnum.convert))){F.convertedExpression=E;}return F;}else if(t===c.TOKEN_TYPES){return F;}}D.expression=s;var H=new o.antlr.runtime.ANTLRStringStream(s);var J=new I(H);J.displayRecognitionError=function(A,B){var P=J.getErrorHeader(B);var Q=J.getErrorMessage(B,A);a.handleWarning(P+" "+Q);};var K=new o.antlr.runtime.CommonTokenStream(J);var L=new i(K);L.mode=t;L.displayRecognitionError=function(A,B){var P=L.getErrorHeader(B);var Q=L.getErrorMessage(B,A);a.handleWarning(P+" "+Q);};var M={};var N={};switch(t){case c.AUTOCOMPLETE_MODE:case c.AUTOCOMPLETE_MODE_LOWERCASE:jQuery.sap.log.debug("mode autocomplete");M.suggs=JSON.parse(h.getNextSuggestions(s,J,L,u,x));if(D.flags.hasOwnProperty(c.propertiesEnum.tokens)&&D.flags[c.propertiesEnum.tokens]===true){M.tokens=a.buildTokenTypes(L,E,D);}jQuery.sap.log.debug("ParsingBackendMediator: autocomplete responseObject: "+M);return M;case c.PARSE_MODE:case c.VALIDATE_MODE:jQuery.sap.log.debug("mode validate");a.parseWithValidation(J,L,x,e.getModelManger());M=e.getModelManger().parseResult.getParseResults();if(D.flags.hasOwnProperty(c.propertiesEnum.tokens)&&D.flags[c.propertiesEnum.tokens]===true){M.tokens=a.buildTokenTypes(L,E,D);}if(D.flags.hasOwnProperty(c.propertiesEnum.valueHelp)&&(M.status===c.statusEnum.SUCCESS)){m.handleExternalValueHelp(L,E,D,M);}if(k.needsConversion(D)){N=M.tokens||a.buildTokenTypes(L,E,D);M.convertedExpression=k.convert(u,y,D,N,E);}if(D.flags.hasOwnProperty(c.propertiesEnum.rootObjectContext)&&D.flags[c.propertiesEnum.rootObjectContext]===true){M.rootObjectContext=null;if(M.status===c.statusEnum.SUCCESS){M.rootObjectContext={};M.rootObjectContext.name=D[c.propertiesEnum.rootObjectContext].name;M.rootObjectContext.associations=D[c.propertiesEnum.rootObjectContext].assocs;}}return M;case c.TOKEN_TYPES:jQuery.sap.log.debug("mode token types");a.parseWithValidation(J,L,x,e.getModelManger());M.tokens=a.buildTokenTypes(L,E,D);M.status=c.statusEnum.SUCCESS;return M;default:a.handleError("Unknown mode",null,e.getModelManger());M=e.getModelManger().parseResult.getParseResults();return M;}}catch(O){e.getModelManger().parseResult.status=c.statusEnum.ERROR;jQuery.sap.log.error("ParsingBackendMediator error: "+O);return e.getModelManger().parseResult.getParseResults();}};q.prototype.convertExpressionToKeys=function(n,s,t,u,w,x){var y={};if(x){y=x;}y[c.propertiesEnum.conversionOutput]=c.conversionOutputEnum.toKeys;return this.parseExpression(n,c.VALIDATE_MODE,s,t,u,w,y);};q.prototype.convertExpressionToDescriptions=function(n,s,t,u,w,x){var y={};if(x){y=x;}y[c.propertiesEnum.conversionOutput]=c.conversionOutputEnum.toDescriptions;return this.parseExpression(n,c.VALIDATE_MODE,s,t,u,w,y);};q.prototype.parseInputRT=function(n,s,t,u,w,x,y){var z=null;if(u){z=new f.ParameterRuntimeServices(u,t,x);}return this.parseExpression(n,s,t,z,w,x,y);};q.prototype.parseInput=function(n,s,t,u,w,x,y){var z=null;z=r.getVocabularyDataProvider();return this.parseInputRT(n,s,z,u,w,x,y);};q.prototype.isReservedWord=function(s){var n=e.getModelManger();n.clearModelData();n.parseResult.clear();s=s.split(' ')[0];var t=new o.antlr.runtime.ANTLRStringStream(s);var u=new I(t);var w=new o.antlr.runtime.CommonTokenStream(u);var x=new i(w);var y=true;x.reportError=function(A){if((x.input.tokens.length>0)&&(x.input.tokens[0].type===l.NAVIGATION||x.input.tokens[0].type===l.TYPEATTRIBUTE||x.input.tokens[0].type===l.INT||x.input.tokens[0].type===l.STRING||x.input.tokens[0].type===l.ANYCHAR||x.input.tokens[0].type===undefined||x.input.tokens[0].type===null)){y=false;}};u.reportError=function(A){if((x.input.tokens.length>0)&&(x.input.tokens[0].type===l.NAVIGATION||x.input.tokens[0].type===l.TYPEATTRIBUTE||x.input.tokens[0].type===l.INT||x.input.tokens[0].type===l.STRING||x.input.tokens[0].type===undefined||x.input.tokens[0].type===null)){y=false;}};x.dummyRule();return y;};q.prototype.validateAndGetExpressionActualReturnTypeRT=function(n,s,t,u,w,x){var y={type:null,dataObject:null,businessDataType:null,unknownTokens:{},isCollection:false,errorDetails:null,isValid:false,dependenciesOutput:{}};if(u===undefined){u=null;}var z;if(x){z=x;}else{z={};z[c.propertiesEnum.unknownTokens]=true;z[d.PROPERTY_NAME_DEPENDENCIES_OUTPUT]=true;}if(w!==undefined&&w===false){z[c.propertiesEnum.raiseError]=false;}var A=this.parseExpression(s,c.VALIDATE_MODE,n,u,c.TYPE_ALL,t,z);if(A.actualReturnType){jQuery.sap.log.debug(A.actualReturnType);}if(A.status===c.statusEnum.ERROR){y.errorDetails=A.errorDetails;y.unknownTokens=A[c.propertiesEnum.unknownTokens];return y;}y.type=A.actualReturnType;y.dataObject=(A.hasOwnProperty(c.attributesNamesEnum.dataObject)?A.dataObject:null);y.isValid=true;var B=a.getBusinessDTFromRelType(y.type);y.isCollection=B[c.propertiesEnum.isCollection];y.businessDataType=B[c.propertiesEnum.businessType];y.dependenciesOutput=(A.hasOwnProperty(d.PROPERTY_NAME_DEPENDENCIES_OUTPUT)?A.dependenciesOutput:{});if(A.hasOwnProperty(c.propertiesEnum.convertedExpression)){y.convertedExpression=A.convertedExpression;}return y;};q.prototype.validateAndGetExpressionActualReturnType=function(n,s,t,u,w,x){var y=null;var z=null;y=r.getVocabularyDataProvider();if(n){if(u){z=new f.ParameterRuntimeServices(u,y,t);}}return this.validateAndGetExpressionActualReturnTypeRT(y,s,t,z,w,x);};q.prototype.validateExpression=function(n,s,t,u,w,x){var y=this.parseInput(s,u,n,x,w,t);var z={status:y.status,errorDetails:y.errorDetails};return z;};q.prototype.validateAndGetExpressionModel=function(n,s,t,u,w,x){var y=this.parseInput(s,u,n,x,w,t);return y.model;};q.prototype.getRELDependencies=function(n,s,t,u){var w={};w[d.PROPERTY_NAME_DEPENDENCIES_OUTPUT]=true;var x=this.parseInput(s,c.VALIDATE_MODE,n,u,c.TYPE_ALL,t,w);return x[d.PROPERTY_NAME_DEPENDENCIES_OUTPUT];};q.prototype.handleParse=function(n){if(!n.hasOwnProperty("expression")){return e.getModelManger().parseResult.getParseResults();}if(!n.hasOwnProperty("vocabulary")){n.vocabulary=null;}if(!n.hasOwnProperty("mode")){n.mode=c.VALIDATE_MODE;}if(!n.hasOwnProperty("returnType")){n.returnType=c.TYPE_ALL;}if(!n.hasOwnProperty("parameters")){n.parameters=null;}if(!n.hasOwnProperty(c.propertiesEnum.flags)){n.flags={};}return this.parseInput(n.expression,n.mode,n.connection,n.parameters,n.returnType,n.vocabulary,n.flags);};return{parsingBackendMediatorLib:q};}());
