jQuery.sap.declare("sap.rules.ui.parser.businessLanguage.lib.parseModel");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.constants");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.entityModelConstractor");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.utils");jQuery.sap.require("sap.rules.ui.parser.resources.dependencies.lib.constantsBase");jQuery.sap.require("sap.rules.ui.parser.resources.vocabulary.lib.constantsBase");jQuery.sap.require("sap.rules.ui.parser.businessLanguage.lib.parseUtils");jQuery.sap.require("sap.rules.ui.parser.resources.dependencies.lib.objects");sap.rules.ui.parser.businessLanguage.lib.parseModel=sap.rules.ui.parser.businessLanguage.lib.parseModel||{};sap.rules.ui.parser.businessLanguage.lib.parseModel.lib=(function(){var u=new sap.rules.ui.parser.businessLanguage.lib.utils.lib();var c=sap.rules.ui.parser.businessLanguage.lib.constants.lib;var e=sap.rules.ui.parser.businessLanguage.lib.entityModelConstractor.lib;var v=sap.rules.ui.parser.resources.vocabulary.lib.constantsBase.lib;var d=sap.rules.ui.parser.resources.dependencies.lib.constantsBase.lib;var a=sap.rules.ui.parser.resources.dependencies.lib.objects.lib;var p=new sap.rules.ui.parser.businessLanguage.lib.parseUtils.lib.parseUtilsLib();function b(){}b.prototype.ModelManager=function(){var m=this;this.nextTokens=[];this.contextQueue=[];this.isInsideWhere=false;this.disableAliases=false;this.lastValueListAttribute=null;this.allContext=false;this.allTermContext=false;this.DFAFaildMode=false;this.terms=[];this.term=null;this.expression=null;this.vocaRTServ=null;this.actualReturnType=null;this.modelOutput=null;this.tokensContext=null;this.parseResult={status:c.statusEnum.SUCCESS,errorDetails:[],errorID:null,cursorPosition:0,actualReturnType:null,businessDataType:null,isCollection:false,clear:function(){this.errorDetails=[];this.errorID=null;this.cursorPosition=0;this.status=c.statusEnum.SUCCESS;this.actualReturnType=null;this.businessDataType=null;this.isCollection=false;},getParseResults:function(){var r;if(this.status===c.statusEnum.SUCCESS){var h=p.getBusinessDTFromRelType(m.actualReturnType);r={status:c.statusEnum.SUCCESS,errorDetails:null,errorID:null,model:m.modelOutput,cursorPosition:null,actualReturnType:m.actualReturnType,businessDataType:h[c.propertiesEnum.businessType],isCollection:h[c.propertiesEnum.isCollection]};if(m.actualReturnType===c.TYPE_COLLECTION){r.dataObject=m.dataObject;}}else{r={status:c.statusEnum.ERROR,errorDetails:this.getErrors(),errorID:this.errorID,model:null,cursorPosition:this.cursorPosition,actualReturnType:null,businessDataType:null,isCollection:false};if(this.hasOwnProperty(c.propertiesEnum.convertedExpression)){r.convertedExpression=null;}}if(m.hasOwnProperty(c.propertiesEnum.flags)&&m.flags.hasOwnProperty(d.PROPERTY_NAME_DEPENDENCIES_OUTPUT)&&m.flags[d.PROPERTY_NAME_DEPENDENCIES_OUTPUT]===true){r[d.PROPERTY_NAME_DEPENDENCIES_OUTPUT]=(this.status===c.statusEnum.ERROR)?null:m.getDependencies();}if(m.hasOwnProperty(c.propertiesEnum.flags)&&m.flags.hasOwnProperty(c.propertiesEnum.unknownTokens)&&m.flags[c.propertiesEnum.unknownTokens]===true){r[c.propertiesEnum.unknownTokens]=(this.status===c.statusEnum.ERROR&&m.hasOwnProperty(c.propertiesEnum.unknownTokens))?m[c.propertiesEnum.unknownTokens]:{};}return r;},getErrors:function(){var h="";var i=0;for(i;i<this.errorDetails.length;++i){h+=this.errorDetails[i]+"\n";}return h;}};this.popFromContextQueue=function(){this.contextQueue.pop();};this.pushToContextQueue=function(h){this.contextQueue.push(h);};this.clearTermsArray=function(){this.terms=[];};this.clearCurrentTerm=function(){this.term=null;};this.setCurrentTerm=function(t){if(this.term===null){this.term={};}this.term.text=t;this.term.whitechar='';};this.setCurrentTermWhiteChar=function(w){if(this.term===null){this.term={};this.term.text='';}this.term.whitechar=w;};this.getCurrentTerm=function(){if(this.term===null){return null;}return this.term.text;};this.getCurrentTermWhiteChar=function(){if(this.term===null){return'';}return this.term.whitechar;};this.setTokenContext=function(s,t,h){if(this.tokensContext===null){this.tokensContext={};}this.tokensContext[s]={token:t,dataObjectContext:h};};this.getTokenContext=function(s,t){if(this.tokensContext===null){return null;}var h=this.tokensContext[s];if(h&&h.token===t){return h.dataObjectContext;}return null;};var n={};this.dateTimeObjectsDictionary={};var f={};var g={};this.setDFAFailed=function(h){this.DFAFaildMode=h;};this.getDFAFailed=function(){return this.DFAFaildMode;};this.setLastValueListAttribute=function(h){this.lastValueListAttribute=h;};this.cleanValueListAttribute=function(){this.lastValueListAttribute=null;};this.getValueListAttribute=function(){return this.lastValueListAttribute;};this.setTermAllContext=function(){this.allTermContext=true;};this.setAllContext=function(){this.allContext=true;};this.cleanAllContext=function(){this.allTermContext=false;this.allContext=false;};this.isAllContext=function(){return this.allContext;};this.isTermAllContext=function(){return this.allTermContext;};this.setCurrentNavigationObject=function(h,i){f[h]=i;var j=this.contextQueue.length;if(j===0){return;}var k=this.contextQueue[j-1];if(k.root.isAlias||k.root.isParameter){return;}if(g.hasOwnProperty(k.navigation)===false){g[k.navigation]={};}g[k.navigation][h]=i;};this.getCurrentNavigationObject=function(h){if(f[h]===undefined){return null;}var i=this.contextQueue.length;if(i===0){return f[h];}var j=this.contextQueue[i-1];if(j.root.isAlias||j.root.isParameter){return f[h];}if(g.hasOwnProperty(j.navigation)===false){return f[h];}if(g[j.navigation][h]===undefined){return f[h];}return g[j.navigation][h];};this.getNavigationFromDictionary=function(h){return n[h];};this.addDateTimeObject=function(o,h){this.dateTimeObjectsDictionary[o]=h;};this.getDateTimeObject=function(o){if(this.dateTimeObjectsDictionary[o]===undefined){return null;}return this.dateTimeObjectsDictionary[o];};this.clearModelData=function(){this.allContext=false;this.allTermContext=false;this.lastValueListAttribute=null;this.DFAFaildMode=false;this.term=null;this.terms=[];this.vocabulary=null;this.vocaRTServ=null;this.expression=null;this.mode=null;this.paramServ=null;this.contextQueue=[];this.isInsideWhere=false;this.disableAliases=false;this[c.propertiesEnum.unknownTokens]={};this[c.propertiesEnum.rootObjectContext]={"name":null,"assocNames":{},"assocs":[]};n={};f={};this.modelOutput=null;this.actualReturnType=null;this.tokensContext=null;};this.clearTerm=function(){this.terms=[];};this.modelManagerOutput=function(h){if(arguments.length!==1){p.handleWarning("wrong number of arguments for output model");}var o=h.getType();if(o!==c.objectNamesEnum.model){p.handleWarning("failed to create the output Model, unexpected model type");}m.modelOutput=h;};this.addStatement=function(o){var h=o.constructor.name;if(!(h==="Statement"||h==="Operator")){p.handleWarning("failed to add "+o.toString()+" to statement array");}this.statementArray.push(o);};this.createWhereFilter=function(h){if(h!==null&&h.hasOwnProperty("selection")){var s=new e.SimpleStatementFilter(h);return s;}else{var i=new e.ComplexStatementFilter(h);return i;}};this.getDependencies=function(){var h=null;var k=null;var j,r,l,o,i;for(k in n){if(n.hasOwnProperty(k)){j=this.getCurrentNavigationObject(k);if(!j.isValid||j.isParameter){continue;}h=(h===null)?{}:h;r=j.root.name;if(j.root.isAlias){h[v.PROPERTY_NAME_ALIASES+"."+r]=new a.VocaAlias(r,j.root.vocabulary);}else{h[v.PROPERTY_NAME_DATA_OBJECTS+"."+r]=new a.VocaDOInfo(r,j.root.vocabulary);}l=r;o=j.associations.path;if(!u.isEmptyArray(o)){for(i=0;i<o.length;i++){h[v.PROPERTY_NAME_DATA_OBJECTS+"."+l+"."+v.PROPERTY_NAME_OM_ASSOCIATIONS+"."+o[i].name]=new a.VocaDOAssociation(l,o[i].name,o[i].vocabulary);l=o[i].object;}}if(j.attribute.isValid){h[v.PROPERTY_NAME_DATA_OBJECTS+"."+l+"."+v.PROPERTY_NAME_ATTRIBUTES+"."+j.attribute.name]=new a.VocaDOAttributes(l,j.attribute.name,j.attribute.vocabulary);}}}return h;};this.addNavigationToDictionary=function(h,j){var k=c.SIMPLE_SELECTION_VALUE_TYPE.COLLECTION.string;if(j.attribute.businessDataType!==null){k=j.attribute.businessDataType;}else if(j.root.isAlias&&j.root.businessDataType!==null){k=j.root.businessDataType;}var t=c.SIMPLE_SELECTION_VALUE_TYPE.getByValue("string",k);var l=function(w){var x=[];if(u.isEmptyArray(w)){return x;}var i;for(i=0;i<w.length;i++){x.push(w[i].name);}return x;};var o=u.getFixedParamName(h);var q={navigationPredicate:o,navigationFullPath:(j.isParameter)?o:j.navigation,rootObject:j.root.name,attribute:j.attribute.name,attributeType:t.value,associationsArray:l(j.associations.path),attributeMappingType:j.attribute.sourceType,attributeValueList:j.attribute.valueListName,isVocaRule:j.isVocaRule,isCollection:j.isCollection,isParameter:j.isParameter,isAlias:(j.isParameter)?false:j.root.isAlias,isDataObject:(j.isParameter)?j.isDataObject:null,dataObject:null,modifiers:(j.isParameter)?{}:j.modifiers};if(!q.isAlias&&!q.isParameter){var r=null;if(u.isEmptyArray(q.associationsArray)&&q.attributeType===c.SIMPLE_SELECTION_VALUE_TYPE.COLLECTION.string){r=q.rootObject;}else if(!u.isEmptyArray(q.associationsArray)){r=q.associationsArray[q.associationsArray.length-1];}if(q.attribute===null||q.attribute===undefined){this.dataObject=r;}q.dataObject=r;}var s=new e.NavigationPredicateDetails(q);n[h]=s;return s;};};b.prototype.getModelManger=function(){if(b.prototype.manager_singletonInstance){return b.prototype.manager_singletonInstance;}b.prototype.manager_singletonInstance=new this.ModelManager();return b.prototype.manager_singletonInstance;};b.prototype.createModelManger=function(){b.prototype.manager_singletonInstance=new this.ModelManager();b.prototype.manager_singletonInstance.clearModelData();return b.prototype.manager_singletonInstance;};b.prototype.validateNavigationRule=function(n){var f=this.getModelManger().getCurrentNavigationObject(n);var g=null;if(f.isValid||f.root.isValid){g=this.getModelManger().addNavigationToDictionary(n,f);if(g.getModifiers().hasOwnProperty("all")){this.getModelManger().setTermAllContext();}var h=g.getAttributeValueList();if(h){var i={};i.navPath=n;i.attributeValueList=f.attribute.valueListName;this.getModelManger().setLastValueListAttribute(i);}else{this.getModelManger().cleanValueListAttribute();}}else{p.handleWarning("general error in "+n);}return g;};return{parseModelLib:b};}());
