sap.ui.define(["sap/ui/core/Control","sap/ui/core/Item","sap/ui/core/ValueState","sap/m/Select","sap/m/Input","sap/m/Button","sap/m/SelectDialog","sap/m/StandardListItem","sap/m/Text","sap/m/DatePicker","sap/ui/model/type/Float","sap/ui/model/type/Date","sap/ui/model/type/Time","sap/ui/model/type/DateTime","sap/ui/core/HTML","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","./Utils","sap/m/DateTimePicker","sap/m/TimePicker","sap/rules/ui/providers/ValueHelpProvider","sap/ui/core/LocaleData"],function(C,a,V,S,I,B,b,c,T,D,d,f,g,h,H,J,F,j,U,k,l,m,L){"use strict";return C.extend("sap.rules.ui.InstructionRenderer",{metadata:{properties:{instructions:{type:"any"}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:true,visibility:"hidden"}},events:{"change":{}},publicMethods:["getTokensAndTexts","getExpression"]},init:function(){this.INTERNAL_MODEL="internal";this.TOKEN="token";this.TEXT="text";this.MODEL_INSTRUCTIONS="/instructions";this.LINE_GAP_CLASS="sapUiSmallMarginTop";this.TOKENS_GAP_CLASS="sapUiTinyMarginEnd";var e="'";var O="'";this.VALIDATION_REGEX="^["+O+"][^"+e+"]*["+O+"]$"+"|"+"^[^"+e+"]*$";this.lineBreakIndexes={start:{},end:{}};this._internalModel=new J({instructions:[]});this._internalModel.setSizeLimit(300);this.setModel(this._internalModel,this.INTERNAL_MODEL);},setInstructions:function(i){this.setProperty("instructions",i);this.destroyAggregation("_content");if(!i||!i.length){i=[];}this.getModel(this.INTERNAL_MODEL).setProperty(this.MODEL_INSTRUCTIONS,i);},setUseIndent:function(u){this.setProperty("useIndent",u,true);this.destroyAggregation("_content");},onBeforeRendering:function(){var e=this.getAggregation("_content");if(!e){var n=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);if(!n){return;}try{var o=this._createControls(n);for(var i=0,p=o.length;i<p;++i){this.addAggregation("_content",o[i],true);}}catch(q){console.error(q);}}},renderer:function(r,o){r.write("<div class='sapUiSizeCompact' ");r.writeControlData(o);r.write(">");var e=o.getAggregation("_content");if(e){if(o._getIndent()){r.write(o._getTableStart());}for(var i=0,n=e.length;i<n;++i){var p=o.lineBreakIndexes.start[i];var q=o.lineBreakIndexes.end[i];if(p&&o._getIndent()){r.write(o._getLogicalOperatorStart());}r.renderControl(e[i]);if(q&&o._getIndent()){r.write(o._getLogicalOperatorEnd());}}if(o._getIndent()){r.write(o._getTableEnd());}}r.write("</div>");},getTokensAndTexts:function(){var t=[];var e=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);for(var i=0,n=e.length;i<n;++i){var o=e[i];var p={text:o[this.TEXT],token:o[this.TOKEN]};t.push(p);}return t;},getExpression:function(){var e=[];var n=this._internalModel.getProperty(this.MODEL_INSTRUCTIONS);for(var i=0,o=n.length;i<o;++i){var p=n[i];var t=p[this.TOKEN];e.push(t);}var q=n[n.length-1].token;if(!q&&q!==0){e.pop(n.length-1);}return e.join(" ");},_onChange:function(o){var i=o.getSource().data("instructionNum");this.fireEvent("change",{instructionNum:i});},_createControls:function(e){this.lineBreakIndexes={start:{},end:{}};var n=[];var o=[];var i,p;var q;var r;var s;for(i=0,p=e.length;i<p;++i){q=e[i];r=this._getCreateFunction(q);if(r===null){var t=" ";this._showErrorMessage(t);o=[];break;}o.push(r);}for(i=0,p=o.length;i<p;++i){q=e[i];r=o[i];s=o[i+1];var u=this.MODEL_INSTRUCTIONS+"/"+i+"/";var v=this.INTERNAL_MODEL+">"+u;var w=r.apply(this,[q,s,u,v]);var x=w.controls;w.controls.forEach(function(y){y.data({instructionNum:i});if(y.attachChange){y.attachChange(this._onChange.bind(this));}}.bind(this));if(w.needLineBreak){this.lineBreakIndexes.start[n.length]=true;this.lineBreakIndexes.end[n.length+x.length-1]=true;}n.push.apply(n,x);}return n;},_getCreateFunction:function(i){var e=null;if(i.valueListObject){e=this._createValueListControl;}else if(i.visible===false){e=this._createHiddenControl;}else if(i.type&&i.type==="action"){e=this._createAddRepetitiveControl;}else if(i.tokenType=="ConjunctionOperator"&&!i.editable){e=this._createNonEditableLogicalOperator;}else if(i.tokenType=="ConjunctionOperator"&&i.editable){e=this._createEditableLogicalOperator;}else if(i.editable===false){e=this._createTextControl;}else if(i.businessDataType==="Number"){e=this._createNumberControl;}else if(i.businessDataType==="Date"){e=this._createDateControl;}else if(i.businessDataType==="Time"){e=this._createTimeControl;}else if(i.businessDataType==="Timestamp"){e=this._createDateTimeControl;}else if(i.businessDataType==="TimeSpan"){e=this._createNumberControl;}else if(i.businessDataType==="String"){e=this._createGeneralInputControl;}else if(i.businessDataType==="Boolean"){e=this._createBooleanSelectionControl;}else if(i.valueOptions&&i.valueOptions.type==="Set"){e=this._createSelectionControl;}return e;},_createHiddenControl:function(i,n,e,o){return[];},_createValueListControl:function(i,n,e,o){var p=new I({showValueHelp:true,valueHelpRequest:function(){if(p.oValueHelpDialogProvider&&p.oValueHelpDialogProvider._onInitialise){p.oValueHelpDialogProvider._onInitialise();}},value:{path:o+this.TEXT},change:function(q){var r=q.getSource().getParent();r._syncToken(e);},width:"auto"});var v=i.valueListAnnotation;if(v){p.oValueHelpDialogProvider=new m({annotation:v.primaryValueListAnnotation,additionalAnnotations:v.additionalAnnotations,control:p,model:i.valueListObject.model,preventInitialDataFetchInValueHelpDialog:false,supportMultiSelect:false,supportRanges:false,takeOverInputValue:false,fieldName:v.primaryValueListAnnotation.valueListTitle,title:v.primaryValueListAnnotation.valueListTitle,cursorPosition:0,bReplaceWord:false,businessDataType:"string",bAddSpace:false});var P=this.getParent().getParent();if(P instanceof sap.m.Popover){p.oValueHelpDialogProvider._popover=P;}}p.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[p],needLineBreak:false};},_createSelectionControl:function(i,n,e,o){var p=this.getParent();var q=new S({items:{path:o+"valueOptions/values",template:new a({key:"{"+this.INTERNAL_MODEL+">"+this.TOKEN+"}",text:"{"+this.INTERNAL_MODEL+">"+this.TEXT+"}"})},forceSelection:false,selectedKey:"{"+o+this.TOKEN+"}",width:"auto",change:function(r){},enabled:(p.bReadOnly&&p instanceof sap.rules.ui.DecisionTableCellExpressionBasic)?false:true});q.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[q],needLineBreak:false};},_createAddRepetitiveControl:function(i,n,e,o){var p=[];var q=new B({text:"",press:i.callback});q.setIcon("sap-icon://add");p.push(q);return{controls:p,needLineBreak:false};},_createTextControl:function(i,n,e,o){var p=[];var q=new T({text:"{"+o+this.TEXT+"}",width:"auto"}).addStyleClass("sapUiTinyMarginTop").addStyleClass("sapRULExpressionBasic");p.push(q);return{controls:p,needLineBreak:false};},_createNumberControl:function(i,n,e,o){var v=this._createValueRange(i);var p=new I({width:"auto",type:"Text",value:{path:o+this.TOKEN,type:new d({minIntegerDigits:0,minFractionDigits:0},v)},valueStateText:this._getValueStateText(v),change:function(q){}});p.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(p);return{controls:[p],needLineBreak:false};},_createDateControl:function(i,n,e,o){var v=this._createValueRange(i);this._removeTextSingleQuote(e);var p=new D({width:"auto",type:"Date",value:{path:o+this.TEXT},valueStateText:this._getValueStateText(v),change:function(q){var P=q.getSource().getParent();P._syncToken(e);}});p.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(p);return{controls:[p],needLineBreak:false};},_createTimeControl:function(i,n,e,o){var v=this._createValueRange(i);this._removeTextSingleQuote(e);var p=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var q=L.getInstance(p);var t=q.getTimePattern('medium');var r=new l({width:"auto",type:"Time",value:{path:o+this.TEXT},valueStateText:this._getValueStateText(v),change:function(s){var P=s.getSource().getParent();P._syncToken(e);},valueFormat:t});r.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(r);return{controls:[r],needLineBreak:false};},_createDateTimeControl:function(i,n,e,o){var v=this._createValueRange(i);this._removeTextSingleQuote(e);var p=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var q=L.getInstance(p);var r=q.getDatePattern('short');var t=q.getTimePattern('medium');var s=r+" "+t;var u=new k({width:"auto",value:{path:o+this.TEXT},valueStateText:this._getValueStateText(v),change:function(w){var P=w.getSource().getParent();P._syncToken(e);},valueFormat:s});u.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(u);return{controls:[u],needLineBreak:false};},_createGeneralInputControl:function(i,n,e,o){this._removeTextSingleQuote(e);var p=new I({value:{path:o+this.TEXT,type:new sap.ui.model.type.String(null,{search:this.VALIDATION_REGEX})},width:"auto",change:function(q){var r=q.getSource();var v=r.getValue();r.setValue(v.replace(/\'/g,""));var P=q.getSource().getParent();P._syncToken(e);}});p.addStyleClass(this.TOKENS_GAP_CLASS);this._attachValidationHandlers(p);return{controls:[p],needLineBreak:false};},_createBooleanSelectionControl:function(i,n,e,o){var p=new sap.m.Select({selectedKey:"{"+o+this.TOKEN+"}",width:"auto",items:[{text:"true",key:"true"},{text:"false",key:"false"}],forceSelection:false});p.addStyleClass(this.TOKENS_GAP_CLASS);return{controls:[p],needLineBreak:false};},_createNonEditableLogicalOperator:function(i,n,e,o){var p=this._createLineBreak();var q=[];var r=new H({content:"<B class='sapMText sapUiTinyMarginTop sapUiTinyMarginEnd'>"+i[this.TEXT]+"</B>"});if(!this._getIndent()){q.push(p);}q.push(r);return{controls:q,needLineBreak:true};},_createEditableLogicalOperator:function(i,n,e,o){var p=this._createLineBreak();var q=[];var r=new S({items:{path:o+"valueOptions/values",template:new a({key:"{"+this.INTERNAL_MODEL+">"+this.TOKEN+"}",text:"{"+this.INTERNAL_MODEL+">"+this.TEXT+"}"})},selectedKey:"{"+o+this.TOKEN+"}",width:"auto",change:function(s){}});r.addStyleClass(this.TOKENS_GAP_CLASS);if(!this._getIndent()){q.push(p);}q.push(r);return{controls:q,needLineBreak:true};},_createSpace:function(){var e=new H({content:'<span>&nbsp;</span>'});return e;},_createLineBreak:function(){var e=new H({content:'<DIV class="'+this.LINE_GAP_CLASS+'"></DIV>'});return e;},_getTableStart:function(){return'<table><td></td><td style="vertical-align:top;">';},_getTableEnd:function(){return'</td></tr></table>';},_getLogicalOperatorStart:function(){return'<div class="'+this.LINE_GAP_CLASS+'"></td></tr><tr><td style="vertical-align:top;">';},_getLogicalOperatorEnd:function(){return'</td><td style="vertical-align:top;">';},_getIndent:function(){var i;try{i=this.getProperty("useIndent");}catch(e){i=false;}return i;},_createValueRange:function(i){var r=null;if(i.valueOptions&&i.valueOptions.type==="Range"){r={};var e=i.valueOptions;if(e.from){r.minimum=e.from;}if(e.to){r.maximum=e.to;}}return r;},_getValueStateText:function(v){var t;if(!v){return t;}if(v.minimum!==undefined&&v.maximum!==undefined){t="";}else if(v.minimum!==undefined){t="";}else if(v.maximum!==undefined){t="";}else{t="";}return t;},_attachValidationHandlers:function(i){i.attachParseError(function(e){e.getParameter("element").setValueState("Error");e.getParameter("element").setValueStateText(e.getParameter("message"));});i.attachValidationSuccess(function(e){e.getParameter("element").setValueState("None");});},_showErrorMessage:function(e){jQuery.sap.require("sap.m.MessageBox");sap.m.MessageBox.alert(e,{icon:sap.m.MessageBox.Icon.ERROR});},_removeTextSingleQuote:function(e){var i=this._internalModel;var v=i.getProperty(e+this.TEXT);i.setProperty(e+this.TEXT,v.replace(/\'/g,""));},_syncToken:function(e){var i=this._internalModel,n=false,o=false;var p=i.getProperty(e+this.TEXT).toString();if(p==="'"){n=true;}if(p.substr(0,"'")!=="'"){n=true;}if(p.substr(p.length-1,"'")!=="'"){o=true;}if(n){p="'"+p;}if(o){p=p+"'";}i.setProperty(e+this.TOKEN,p);}});});
