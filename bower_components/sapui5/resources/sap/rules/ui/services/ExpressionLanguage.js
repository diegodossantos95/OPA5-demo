/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Element","sap/rules/ui/parser/businessLanguage/lib/parsingBackendMediator","sap/rules/ui/parser/ruleBody/lib/ruleServices","sap/rules/ui/parser/resources/common/lib/resourcesConvertor","sap/rules/ui/parser/resources/vocabulary/lib/vocabularyDataProviderInitiator","sap/rules/ui/parser/infrastructure/messageHandling/lib/responseCollector","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/rules/ui/library"],function(q,E,P,R,r,a,b,L,c){"use strict";var d=E.extend("sap.rules.ui.services.ExpressionLanguage",{metadata:{library:"sap.rule.ui",properties:{valueHelpCallback:{type:"any"},bindingContextPath:{type:"string",group:"Misc"}},publicMethods:["setData","validateExpression","getSuggestions","getExpressionMetadata"],events:{"dataChange":{}}}});d.prototype._initLocale=function(){var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var o=c.getInstance(l);var e=o.getDatePattern('short');var t=o.getTimePattern('medium');var f=-(new Date().getTimezoneOffset());var g=o.getNumberSymbol('decimal');var h=o.getNumberSymbol('group');this._localeSettings={"dateFormat":e,"timeFormat":t,"timeZoneOffset":f,"number":{"groupSeparator":h,"decimalSeparator":g}};};d.prototype.init=function(){this._initLocale();this.attachModelContextChange(this._setDataFromModel.bind(this));};d.prototype._setDataFromModel=function(){if(this.hasModel()&&this.getBindingContextPath()){this.getModel().read(this.getBindingContextPath(),{urlParameters:{"$expand":"DataObjects/Associations,DataObjects/Attributes,ValueHelps,Rules"},success:this.setData.bind(this)});}};d.prototype.setBindingContextPath=function(v){this.setProperty("bindingContextPath",v,false);this.fireModelContextChange();return this;};d.prototype._initVocaRuntimeService=function(){var v=this._CopyAndRemoveOdataTags(this._data);this._vocabularyName=v.Id||v.id;var i={"connection":null,"vocaLoadingType":"json","resourceID":this._vocabularyName,"resourceContent":v,"termModes":this._getTermModes()};var e=a.lib;var f=new e.vocaDataProviderInitiatorLib();this._runtimeService=f.init(i);};d.prototype._initBackendParser=function(){var e=P.lib;this._backendParser=new e.parsingBackendMediatorLib();};d.prototype._initParser=function(){this._initVocaRuntimeService();this._initBackendParser();};d.prototype.setData=function(D){if(D.Rules&&!D.Rules.results){D.Rules.results=[];delete D.Rules.__deferred;}this._data=D;this._initParser();this.fireDataChange({data:D});};d.prototype._isDataExist=function(){if(!this._data){return false;}return true;};d.prototype._removeOdataTags=function(o){for(var p in o){if(o[p]&&typeof o[p]==='object'){if(Array.isArray(o[p].results)){o[p]=o[p].results;}this._removeOdataTags(o[p]);}}};d.prototype._CopyAndRemoveOdataTags=function(e){var f={};if(e){f=JSON.parse(JSON.stringify(e));this._removeOdataTags(f);}return f;};d.prototype._addOdataTags=function(o){for(var p in o){if(typeof o[p]==='object'){this._addOdataTags(o[p]);if(Array.isArray(o[p])&&p!=="results"){o[p]={"results":o[p]};}}}};d.prototype._CopyAndAddOdataTags=function(e){var f;if(e){f=JSON.parse(JSON.stringify(e));this._addOdataTags(f);}return f;};d.prototype._getTermModes=function(){return["byName","byDescription"];};d.prototype._initResponseCollector=function(s){var e=b.lib.ResponseCollector;var o=e.getInstance();o.clear();o.addSubject(s);return e;};d.prototype.convertRuleToDisplayValues=function(o){var C={"source":"codeText","target":"displayText"};var f=this._buildFlagsObject(C,null,null,true);return this._validateRule(o,f);};d.prototype.convertRuleToCodeValues=function(o){var C={"source":"displayText","target":"codeText"};var f=this._buildFlagsObject(C);return this._validateRule(o,f);};d.prototype.validateRule=function(o){return this._validateRule(o);};d.prototype._fnValidateRule=function(o,f){f=f||{};f.isCollection=false;f.tokensOutput=true;var C=this._CopyAndRemoveOdataTags(o);var e=this._initResponseCollector("Rule Validation");var g=e.getInstance();var m="************* RULE: "+JSON.stringify(C)+"\n\n\n\n"+"*************    VOCABULARY: "+JSON.stringify(this._data)+"\n\n\n\n";g.trace(e.severity().debug,m);g.setOpMessage("RuleValidation","failure");var h=R.lib.validateRule(C,this._vocabularyName,this._runtimeService,f);if(h.status=="Success"){g.setOpMessage("RuleValidation","success");}if(h&&h.hasOwnProperty("decisionTableData")){this._addOdataTags(h.decisionTableData);}g.setOutput(h);return g.build();};d.prototype._validateRule=function(o,f){if(!this._isDataExist()){return null;}var e=this._fnValidateRule(o,f);var v=(e.output.valueHelp&&e.output.valueHelp.info.length>0);var g=this.getValueHelpCallback();var C=g&&(typeof g==="function");if(v&&!C){this._raiseError({},"Value help callback function is not set or is not a function");}if(v&&C){var h=e.output.valueHelp.info;g.call(this,h);var O=true;for(var i=0;i<h.length;i++){if(!h[i].model){this._raiseError({},"value help model is not provided");O=false;break;}else if(!(h[i].model instanceof sap.ui.model.odata.v2.ODataModel)){this._raiseError({},"value help model is not an oData V2 model");O=false;break;}}if(O){var j=this._buildValueHelpMap(h);this._buildDeferredResponse(j,f,e,h);var k=new q.Deferred();e.deferredResult=k.promise();e.valueHelpMapDeferred.done(function(l){k.resolve(this._fnValidateRule(o,l));}.bind(this));e.valueHelpMapDeferred.fail(function(){k.resolve(e);}.bind(this));h.forEach(function(V){if(V.model.isMetadataLoadingFailed()){k.resolve(e);return;}});}}return e;};d.prototype._validateExpression=function(e,f,C,t,g){this._initResponseCollector("Parsing");var p=this._backendParser.parseExpression(e,sap.rules.ui.BackendParserRequest.Validate,this._runtimeService,null,f,this._vocabularyName,g);var h={};h.status=p.status;if(p.valueHelp){h.valueHelp=p.valueHelp;}if(h.status==="Error"){h.errorDetails=p.errorDetails;h.cursorPosition=p.cursorPosition;}else{h.actualReturnType=p.actualReturnType;}if(p.tokens){h.tokens=p.tokens;}return h;};d.prototype._raiseError=function(e,f){e.status="Error";e.cursorPosition=-1;var B=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");e.errorDetails=B.getText("valueHelpTechnicalError");window.console.log(f);};d.prototype.validateExpression=function(e,f,C,t){if(!this._isDataExist()){return null;}var g=this._buildFlagsObject(null,C,t,true);var v=this._validateExpression(e,f,C,t,g);var V=(v.valueHelp&&(v.valueHelp.info.length>0));if(V){if((typeof this.getValueHelpCallback())!=="function"){this._raiseError(v,"value help callback is not set or is not a function");}else if(v.status==="Success"){var h=v.valueHelp.info;var j=this.getValueHelpCallback();j.call(this,h);var o=true;for(var i=0;i<h.length;i++){if(!h[i].model){this._raiseError(v,"value help model is not provided");o=false;break;}else if(!(h[i].model instanceof sap.ui.model.odata.v2.ODataModel)){this._raiseError(v,"value help model is not an oData V2 model");o=false;break;}}if(o){var k=this._buildValueHelpMap(h);this._buildDeferredResponse(k,g,v,h);var l=new q.Deferred();v.deferredResult=l.promise();v.valueHelpMapDeferred.done(function(m){var n=this._validateExpression(e,f,C,t,g);l.resolve(n);}.bind(this));v.valueHelpMapDeferred.fail(function(m){this._raiseError(m,"failed to read from value help oData service");l.resolve(m);}.bind(this));}}}return v;};d.prototype._buildFlagsObject=function(C,e,t,v){if(!e){e=false;}if(t===undefined||t===null){t=true;}var f={"isCollection":e,"tokensOutput":t};if(this._localeSettings){f.locale={localeSettings:this._localeSettings};}if(C){f.locale={localeSettings:this._localeSettings,convert:C};f.termMode={convert:C};}if(v){f.valueHelp={collectInfo:true};}return f;};d.prototype.getSuggestions=function(e,f,C,t){if(!this._isDataExist()){return null;}this._initResponseCollector("Parsing");var g=this._buildFlagsObject(null,C,t);var p=this._backendParser.parseExpression(e,sap.rules.ui.BackendParserRequest.Suggests,this._runtimeService,null,f,this._vocabularyName,g);var V="valueList";for(var i=0;i<p.suggs.length;i++){if(p.suggs[i].tokenType===V){var B=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");p.suggs[i].text=B.getText("valueHelp");}}var h={};h.suggs=p.suggs;if(p.tokens){h.tokens=p.tokens;}return h;};d.prototype.getSuggestionsByCategories=function(e,f){e=e?e:"";var s=this.getSuggestions(e,sap.rules.ui.ExpressionType.BooleanEnhanced,false).suggs;s=s?s:[];if(!f){return s;}var o=[];for(var i=0;i<f.length;i++){var g=f[i];for(var j=0;j<s.length;j++){if(g.tokenType===undefined||g.tokenType===s[j].tokenType||g.hasOwnProperty('tokenType')===false){if(s[j].hasOwnProperty('info')===false){if((g.hasOwnProperty('tokenCategory')===false&&g.hasOwnProperty('tokenBusinessType')===false)||(g.tokenCategory===undefined&&g.tokenBusinessType===undefined)){o.push(s[j]);}}else if((g.tokenCategory===undefined||g.tokenCategory===s[j].info.category||g.hasOwnProperty('tokenCategory')===false)&&(g.tokenBusinessType===undefined||g.tokenBusinessType===s[j].info.type||g.hasOwnProperty('tokenBusinessType')===false)){o.push(s[j]);}}}}return o;};d.prototype.getExpressionMetadata=function(e){if(!this._isDataExist()){return null;}this._initResponseCollector("Parsing");var p=this._backendParser.parseExpression(e,sap.rules.ui.BackendParserRequest.GetMetadata,this._runtimeService,null,null,this._vocabularyName,null);var f={};f.tokens=p.tokens;return f;};d.prototype.getResultInfo=function(s){if(!this._isDataExist()){return null;}var o=null;o=this._runtimeService.getOutput(this._vocabularyName,s,null);if(o&&o.name){this._getResultRequiredParamIds(o);}return o;};d.prototype.getResults=function(){if(!this._isDataExist()){return null;}var o=null;var e=[];o=this._runtimeService.getOutputs(this._vocabularyName).outputs;for(var i=0;i<o.length;i++){e.push({id:o[i].id,name:o[i].name,description:o[i].description,columns:o[i].requiredParams});}return e;};d.prototype.getResultColumnDescription=function(n,o){if(!this._isDataExist()){return n;}var e=null;var p=[];var i=0;e=this._runtimeService.getOutputs(this._vocabularyName).outputs;for(i=0;i<e.length;i++){if(e[i].id===o){p=e[i].requiredParams;break;}}for(i=0;i<p.length;i++){if(p[i].name===n){if(p[i].description!==""){return p[i].description;}}}return n;};d.prototype._getResultRequiredParamIds=function(o){var i,j,k;var e=JSON.parse(JSON.stringify(this._data));if(e.DataObjects&&e.DataObjects.results){e.DataObjects=e.DataObjects.results;for(i=0;i<e.DataObjects.length;i++){if(e.DataObjects[i].Attributes&&e.DataObjects[i].Attributes.results&&(e.DataObjects[i].Name==o.name)&&(e.DataObjects[i].Usage=="RESULT")&&o.requiredParams){e.DataObjects[i].Attributes=e.DataObjects[i].Attributes.results;for(j=0;j<e.DataObjects[i].Attributes.length;j++){for(k=0;k<o.requiredParams.length;k++){if(o.requiredParams[k].name===e.DataObjects[i].Attributes[j].Name){o.requiredParams[k].paramId=e.DataObjects[i].Attributes[j].Id;}}}return;}}}return;};d.prototype._setConfigurationForBasic=function(){this.suggestAfterMap={"initial":["vocabulary,undefined"],"vocabulary,undefined":["reservedword,comparisonOp","reservedword,comparisonBetweenOp","reservedword,comparisonExistOp"],"reservedword,comparisonOp":["constant,dynamic","constant,fixed","reservedword,value"],"reservedword,comparisonBetweenOp":["constant,dynamic","reservedword,value"],"reservedword,comparisonExistOp":["constant,dynamic","constant,fixed","reservedword,value"],"reservedword,UOM":["reservedword,null","reservedword,conjunctionOp"],"reservedword,function":["vocabulary,undefined"],"reservedword,conjunctionOp":["initial"],"reservedword,value":["reservedword,null","reservedword,conjunctionOp"],"reservedword,null":["reservedword,conjunctionOp"],"constant.dynamic":["reservedword,UOM","reservedword,null","reservedword,conjunctionOp"],"constant.fixed":["reservedword,null","reservedword,conjunctionOp"],"unknown,undefined":[]};this.filterByTypeMap={"vocabulary,undefined":[{tokenType:sap.rules.ui.ExpressionTokenType.vocabulary}],"reservedword,comparisonOp":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp}],"reservedword,comparisonBetweenOp":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp}],"reservedword,comparisonExistOp":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonExistOp}],"reservedword,UOM":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.UOM}],"reservedword,function":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.func}],"reservedword,conjunctionOp":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.conjunctionOp}],"reservedword,value":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.value}],"reservedword,null":[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:null}],"constant.dynamic":[{tokenType:sap.rules.ui.ExpressionTokenType.constant,tokenCategory:sap.rules.ui.ExpressionCategory.dynamic}],"constant.fixed":[{tokenType:sap.rules.ui.ExpressionTokenType.constant,tokenCategory:sap.rules.ui.ExpressionCategory.fixed}]};};d.prototype.getSuggestionsForBasic=function(e,f,C){var s=[];var g=this.getSuggestions(e,f,C,true);if(!g||!g.suggs||!g.suggs.length){return s;}s=this._filterSuggestionsForBasic(g);return s;};d.prototype._filterSuggestionsForBasic=function(s){var t=this._groupTokensByTokenType(s.tokens);var l=null;if(t&&t.length>0){l=t[t.length-1];}var e=this._getCategoryForToken(l);var f=this.suggestAfterMap[e];var g=this._getFilterForTokenTypes(f);var h=this._filterSuggestionsByCategories(s,g);return{suggs:h,afterTokenType:l&&l.tokenType};};d.prototype._getCategoryForToken=function(t){if(!t){return"initial";}var e=t.tokenType;var i=t.info&&t.info.category;return e+","+i;};d.prototype._getFilterForTokenTypes=function(t){var f=[];for(var i=0;i<t.length;i++){var e=t[i];var g=this.filterByTypeMap[e];if(g){f.push(g);}}return f;};d.prototype._filterSuggestionsByCategories=function(s,f){var o=[];if(!s||!f){return o;}for(var i=0;i<f.length;i++){var e=f[i];for(var j=0;j<s.length;j++){if(e.tokenType===undefined||e.tokenType===s[j].tokenType||e.hasOwnProperty('tokenType')===false){if(s[j].hasOwnProperty('info')===false){if((e.hasOwnProperty('tokenCategory')===false&&e.hasOwnProperty('tokenBusinessType')===false)||(e.tokenCategory===undefined&&e.tokenBusinessType===undefined)){o.push(s[j]);}}else if((e.tokenCategory===undefined||e.tokenCategory===s[j].info.category||e.hasOwnProperty('tokenCategory')===false)&&(e.tokenBusinessType===undefined||e.tokenBusinessType===s[j].info.type||e.hasOwnProperty('tokenBusinessType')===false)){o.push(s[j]);}}}}return o;};d.prototype._groupTokensByTokenType=function(t){var e=[];if(!t||!t.length){return e;}var p="";for(var i=0;i<t.length;i++){var f=t[i];if(f.tokenType===sap.rules.ui.ExpressionTokenType.whitespace){continue;}else if(f.tokenType!==sap.rules.ui.ExpressionTokenType.vocabulary){e.push(f);p=f.tokenType;}else{if(p!==sap.rules.ui.ExpressionTokenType.vocabulary){e.push(f);}else{e[e.length-1].token+=" "+f.token;e[e.length-1].end=f.end;}p=f.tokenType;}}return e;};d.prototype._getSubExpressions=function(t,e){if(!t){t=this.validateExpression(e);}var f=[];var i;var g;for(i=t.tokens.length-1;i>=0;i--){if(t.tokens[i].info){var T=t.tokens[i].info;if(T.category===sap.rules.ui.ExpressionCategory.comparisonOp||T.category===sap.rules.ui.ExpressionCategory.comparisonBetweenOp||T.category===sap.rules.ui.ExpressionCategory.comparisonExistOp){g=t.tokens[i];break;}}}f.push({exp:""});var p=0;while(p<t.tokens.length&&(t.tokens[p]!==g)){f[0].exp+=t.tokens[p].token;p++;}f[0].exp=f[0].exp.replace(/  +/g,' ');if(!f[0].exp){return f;}if(f[0].exp.slice(-1)===" "){f[0].exp=f[0].exp.slice("",-1);}p++;if(!g){return f;}f.push({exp:g.token.replace(/  +/g,' '),type:this._getCompType(this.exp)});if(p<t.tokens.length){f.push({exp:""});for(;p<t.tokens.length;p++){f[2].exp+=t.tokens[p].token;}}return f;};d.prototype._getBasicSuggestions=function(e,f){if(!f){f=sap.rules.ui.SuggestionsPart.all;}var t=this.validateExpression(e);var s=[];var g=this._getSubExpressions(t);var l=(g[0]&&g[0].exp)?g[0].exp:"";if(f===sap.rules.ui.SuggestionsPart.all){s.push(this._getLeftSuggestions("",l));if(l===""){return s;}}var C=(g[1]&&g[1].exp)?g[1].exp:"";var h=""||(g[1]&&g[1].type);if(f===sap.rules.ui.SuggestionsPart.all||f===sap.rules.ui.SuggestionsPart.compPart){s.push(this._getCompSuggestions(l,C,h));if(g.length===1){return s;}}if(f===sap.rules.ui.SuggestionsPart.all||f===sap.rules.ui.SuggestionsPart.rightPart){var i=(g[2]&&g[2].exp)?g[2].exp:"";h=(f===sap.rules.ui.SuggestionsPart.all)?s[1].type:null;var o=this._getRightSuggestions(l,C,i,h,t);s.push.apply(s,o);}return s;};d.prototype._getLeftSuggestions=function(e,f){var s=this._createEmptySuggestion(1)[0];var F=[{tokenType:sap.rules.ui.ExpressionTokenType.vocabulary}];var S=this.getSuggestionsByCategories(e,F);for(var i=0;i<S.length;i++){s.sugg.push(S[i].text);}s.currentValue=f;s.tokenCategory=sap.rules.ui.ExpressionTokenType.vocabulary;return s;};d.prototype._getCompSuggestions=function(l,e,C){var s=this._createEmptySuggestion(1)[0];var f=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp}];var S=this.getSuggestionsByCategories(l,f);s.type=C||this._getCompType(e);for(var i=0;i<S.length;i++){s.sugg.push(S[i].text);}s.currentValue=e;return s;};d.prototype._getRightSuggestions=function(l,C,e,s,t){var S;var f=l+" "+C;var g=this._getLeftBusinessDataType(l);if(!s){s=this._getCompType(C);}switch(s){case sap.rules.ui.ExpressionCategory.comparisonOp:S=this._geRightForComparisonOp(g,f,e);break;case sap.rules.ui.ExpressionCategory.comparisonBetweenOp:S=this._geRightForBetweenOp(g,f,e);break;case sap.rules.ui.ExpressionCategory.comparisonExistOp:break;default:break;}if(!S){return[{}];}return S;};d.prototype._geRightForComparisonOp=function(l,s,e){var S=this._createEmptySuggestion(1);var f;S[0].BDT=l;var F;var i;if(l===sap.rules.ui.ExpressionType.TimeSpan){S.push.apply(S,this._createEmptySuggestion(1));F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.UOM}];var g=this._splitStringBySeperator(e," ");S[0].currentValue=g[0];S[1].currentValue=g[1];f=this.getSuggestionsByCategories(s+" 5",F);for(i=0;i<f.length;i++){S[1].sugg.push(f[i].text);}}else if(l===sap.rules.ui.ExpressionType.Date){F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.value},{tokenType:sap.rules.ui.ExpressionTokenType.constant,tokenCategory:sap.rules.ui.ExpressionCategory.dynamic}];f=this.getSuggestionsByCategories(s+" ",F);for(i=0;i<f.length;i++){S[0].sugg.push(f[i].text);}S[0].currentValue=q.trim(e);}else{F=[{tokenType:sap.rules.ui.ExpressionTokenType.valueList}];f=this.getSuggestionsByCategories(s+" ",F);S[0].currentValue=q.trim(e);if(f.length){S[0].valueListObject=f[0].info;S[0].isValueList=true;}S[0].currentValue=q.trim(e);}return S;};d.prototype._geRightForBetweenOp=function(l,s,e){(function(){var t=this.validateExpression(e).tokens;if(t){for(var i=0;i<t.length;i++){if(t[i].info&&(t[i].info.category===sap.rules.ui.ExpressionCategory.comparisonOp||t[i].info.category===sap.rules.ui.ExpressionCategory.comparisonBetweenOp||t[i].info.category===sap.rules.ui.ExpressionCategory.comparisonExistOp)){e="";return;}}}}.bind(this))();var S=this._createEmptySuggestion(1);var f;var g,F,i;S[0].BDT=l;if(l!==sap.rules.ui.ExpressionType.TimeSpan&&l!==sap.rules.ui.ExpressionType.Date){g=this._getRightExpressionsForTimeStamp(e);}else{g=this._splitStringBySeperator(e," ");}if(l===sap.rules.ui.ExpressionType.TimeSpan){S.push.apply(S,this._createEmptySuggestion(4));S[3].BDT=l;F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.UOM}];f=this.getSuggestionsByCategories(s+" 5",F);for(i=0;i<f.length;i++){S[1].sugg.push(f[i].text);S[4].sugg.push(f[i].text);}}else if(l===sap.rules.ui.ExpressionType.Date){S.push.apply(S,this._createEmptySuggestion(2));S[2].BDT=l;F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.value},{tokenType:sap.rules.ui.ExpressionTokenType.constant,tokenCategory:sap.rules.ui.ExpressionCategory.dynamic}];f=this.getSuggestionsByCategories(s+" ",F);for(i=0;i<f.length;i++){S[0].sugg.push(f[i].text);S[2].sugg.push(f[i].text);}}else{S.push.apply(S,this._createEmptySuggestion(2));S[2].BDT=l;F=[{tokenType:sap.rules.ui.ExpressionTokenType.valueList}];f=this.getSuggestionsByCategories(s+" ",F);S[0].currentValue=q.trim(e);if(f.length){S[0].valueListObject=f[0].info;S[0].isValueList=true;S[2].valueListObject=f[0].info;S[2].isValueList=true;}}for(i=0;i<S.length;i++){if(g[i]==="to"||(i===2&&l===sap.rules.ui.ExpressionType.TimeSpan)||(i===1&&l===sap.rules.ui.ExpressionType.Date)||((i===1&&l!==sap.rules.ui.ExpressionType.Date)&&(i===1&&l!=sap.rules.ui.ExpressionType.TimeSpan))){S[i].tokenCategory="reservedword.undefined";S[i].currentValue=(g[i]==="to"||g[i]==="and")?g[i]:"to";}else if(l===sap.rules.ui.ExpressionType.Date){S[i].currentValue=q.trim(g[i]||"''");}else if(l===sap.rules.ui.ExpressionType.TimeSpan){S[i].currentValue=q.trim(g[i]||"''");}else{S[i].currentValue=q.trim(g[i]);}}return S;};d.prototype._geRightForExistOp=function(l,s,e,t){var S=this._createEmptySuggestion(1);S[0].BDT=l;var f;if(l===sap.rules.ui.ExpressionType.TimeSpan){f=t.tokens.filter(function(o){if(o.info){return o.info.category===sap.rules.ui.ExpressionCategory.UOM||o.tokenType===sap.rules.ui.ExpressionTokenType.constant;}return null;});f.forEach(function(v,i){});}else if(l===sap.rules.ui.ExpressionType.Date){f=t.tokens.filter(function(o){if(o.info){return o.info.category===sap.rules.ui.ExpressionCategory.value;}return null;});f.forEach(function(v,i){});}return S;};d.prototype._getLeftBusinessDataType=function(l){var t=this.validateExpression(l);var B=t.actualReturnType;if(B){return B;}return t;};d.prototype._splitStringBySeperator=function(e,s){return e.split(s).filter((function removeEmptyStrings(f){return f!=="";}));};d.prototype._getCompType=function(C){if(C){return this.getExpressionMetadata(C).tokens[0].info.category;}else{return null;}};d.prototype._createEmptySuggestion=function(A){var s=[];for(var i=0;i<A;i++){s.push({sugg:[]});}return s;};d.prototype._getRightExpressionsForTimeStamp=function(e){if(!String.prototype.includes){String.prototype.includes=function(){return String.prototype.indexOf.apply(this,arguments)!==-1;};}var f;if(e.indexOf("to")!==-1){f=this._splitStringBySeperator(e,"to");f.splice(1,0,"to");return f;}else if(e.indexOf("and")!==-1){f=this._splitStringBySeperator(e,"and");f.splice(1,0,"and");return f;}return[e,"to"];};d.prototype.convertDecisionTableExpressionToDisplayValue=function(h,f,C,e){var o={"source":"codeText","target":"displayText"};var g=this._buildFlagsObject(o);var i=this._validateDecisionTableExpression(h,f,C,e,g,"RuleServiceValidation");return i;};d.prototype.getDecisionTableCellTokens=function(h,f,C,e){var g=this._buildFlagsObject(null,"",true,false);var i=R.lib.validateDecisionTableExpression(h,f,C,e,this._vocabularyName,this._runtimeService,null,g);return i;};d.prototype.convertDecisionTableExpressionToModelValue=function(h,f,C,e,s){var o={"source":"displayText","target":"codeText"};var g=this._buildFlagsObject(o,"","",true);var i=this._validateDecisionTableExpression(h,f,C,e,g,"RuleServiceValidation",s);return i;};d.prototype._validateDecisionTableExpression=function(h,f,C,e,g,s,i){var j=this._initResponseCollector(s);var k=j.getInstance();k.setOpMessage(s,"failure");var l=R.lib.validateDecisionTableExpression(h,f,C,e,this._vocabularyName,this._runtimeService,i,g);if(l.status=="Success"){k.setOpMessage("RuleServiceValidation","success");}k.setOutput(l);var m=k.build();return m;};d.prototype._buildDeferredResponse=function(e,f,g,v){var h=e.length;var n=0;f.valueHelp={collectInfo:false,info:[]};f.valueHelpInfo=v;g.valueHelpMapDeferred=new q.Deferred();for(var i=0;i<h;i++){e[i].done(function(m,o,p){n++;var s={};s.id=o;s.values={};for(var j=0;j<f.valueHelpInfo.length;j++){if(f.valueHelpInfo[j].id==o){for(var k=0;k<f.valueHelpInfo[j].values.length;k++){s.values[f.valueHelpInfo[j].values[k]]=null;}for(var l=0;l<m.results.length;l++){s.values[m.results[l][p]]=m.results[l][p];}break;}}f.valueHelp.info.push(s);if(n==h){delete f.valueHelpInfo;g.valueHelpMapDeferred.resolve(f);}});e[i].fail(function(){g.valueHelpMapDeferred.reject(g);});}};d.prototype._buildValueHelpMap=function(v){var e=[];function _(f){var g=f.model;var h=f.metadata.propertyPath;var m=new sap.ui.comp.odata.MetadataAnalyser(g);var V=m.getValueListAnnotation(h);if(!V.primaryValueListAnnotation){f.deferred.reject("Failed to read value help annotation");return;}var k='/'+V.primaryValueListAnnotation.annotation.CollectionPath.String+'/';var l=V.primaryValueListAnnotation.keyField;var n=V.primaryValueListAnnotation.keys;var o=[];if(n.length>1){for(var j=0;j<n.length;j++){if(n[j]!==l){o.push(new sap.ui.model.Filter(n[j],"EQ",null));}}}for(var i=0;i<f.values.length;i++){o.push(new sap.ui.model.Filter(l,"EQ",f.values[i]));}var p=f.id;g.read(k,{filters:o,success:function(s){f.deferred.resolve(s,p,l);}.bind(this),error:function(s){f.deferred.reject("Failed to read value help values");window.console.log("Failed to read value help values");}});}for(var i=0;i<v.length;i++){this.oValueHelpInfo=v[i];this.oValueHelpInfo.deferred=new q.Deferred();e.push(this.oValueHelpInfo.deferred);if(!this.oValueHelpInfo.model.getMetaModel().oModel){this.oValueHelpInfo.model.attachMetadataLoaded(function(){_(this);}.bind(this.oValueHelpInfo));this.oValueHelpInfo.model.attachMetadataFailed(function(){if(this.deferred){this.deferred.reject("Failed to load value help model metadata");}}.bind(this.oValueHelpInfo));}else{_(this.oValueHelpInfo);}}return e;};d.prototype.getExpressionLanguageVersion=function(){return R.lib.getParserExprLangVersion();};return d;},true);
