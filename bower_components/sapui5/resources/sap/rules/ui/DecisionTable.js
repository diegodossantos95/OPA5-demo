/*!   
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	                          
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/DecisionTableCell","sap/rules/ui/RuleBase","sap/rules/ui/Utils","sap/ui/table/Table","sap/ui/table/Column","sap/m/Toolbar","sap/m/Popover","sap/m/Menu","sap/m/Dialog","sap/m/MenuButton","sap/m/Button","sap/m/ToolbarSpacer","sap/m/Text","sap/m/Input","sap/m/ObjectIdentifier","sap/m/Link","sap/m/Label","sap/m/BusyIndicator","sap/m/DisplayListItem","sap/m/MenuItem","sap/m/FlexBox","sap/m/MessageStrip","sap/rules/ui/DecisionTableSettingsOld","sap/rules/ui/type/DecisionTableCell"],function(q,l,D,R,U,T,C,a,P,M,b,c,B,d,f,I,O,L,g,h,k,m,F,n,o,p){"use strict";var r={vocabulary:"vocabulary",rule:"rule",columns:"columns",rows:"rows"};var v={emptyTable:3,max:10};var s=R.extend("sap.rules.ui.DecisionTable",{metadata:{properties:{enableSettings:{type:"boolean",group:"Misc",defaultValue:false},cellFormat:{type:"sap.rules.ui.DecisionTableCellFormat",defaultValue:sap.rules.ui.DecisionTableCellFormat.Both},hitPolicies:{type:"sap.rules.ui.RuleHitPolicy[]",defaultValue:[sap.rules.ui.RuleHitPolicy.FirstMatch,sap.rules.ui.RuleHitPolicy.AllMatch]},lineActionBuffer:{type:"any",defaultValue:{rowPath:null,operation:null}}},aggregations:{"_toolbar":{type:"sap.m.Toolbar",multiple:false,singularName:"_toolbar"},"_table":{type:"sap.ui.core.Control",multiple:false,singularName:"_table"},"_errorsText":{type:"sap.m.MessageStrip",multiple:false,singularName:"_errorsText"}}},_addErrorLabel:function(){var e=new n({showCloseButton:true,showIcon:true,type:sap.ui.core.MessageType.Error,visible:false}).addStyleClass("sapUiTinyMargin");this.setAggregation("_errorsText",e,true);},init:function(){this.multiHeaderFlag=false;this.resetContent=true;this._initInternalModel();this._initDisplayModel();this._initDataBucket();this.bindProperty("busy","dtModel>/busyState");this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this._addToolBar();this._addTable();this._addErrorLabel();this._decisionTableCellFormatter=new p();this.setBusyIndicatorDelay(0);},setEditable:function(e){this.setProperty("editable",e,true);this._internalModel.setProperty("/editable",e);this._internalModel.setProperty("/sequenceExist",this.isSequenceExistsInOdataMetadata());var t=this.getAggregation("_table");var i=this.getAggregation("_toolbar");if(e===false){t.addStyleClass("sapRULDecisionTableEdit");i.removeStyleClass("sapRULDecisionTableToolBar");}else{t.removeStyleClass("sapRULDecisionTableEdit");i.addStyleClass("sapRULDecisionTableToolBar");}return this;},setExpressionLanguage:function(e){this.setAssociation("expressionLanguage",e,true);this._decisionTableCellFormatter.setExpressionLanguage(this.getExpressionLanguage());var i=(e instanceof Object)?e:sap.ui.getCore().byId(e);if(!i){return this;}var t=this.getAggregation("_table");if(t){var j=t.getBinding("columns");if(j){j.refresh();}}if(i._isDataExist()){var E=new sap.ui.base.Event("","",{data:true});this._handleVocabularyDataChanged(E);}i.attachDataChange(this._handleVocabularyDataChanged.bind(this));return this;},setEnableSettings:function(e){this.setProperty("enableSettings",e,true);this._internalModel.setProperty("/enableSettings",e);return this;},setHitPolicies:function(e){this.setProperty("hitPolicies",e,true);this._internalModel.setProperty("/hitPolicies",e);return this;},setCellFormat:function(e){this.setProperty("cellFormat",e,true);this._internalModel.setProperty("/cellFormat",e);return this;},_initInternalModel:function(){var e={};e.editable=this.getEditable();e.newTable=true;e.sequenceExist=true;e.busyState=true;e.busyTableState=true;e.cellFormat=this.getCellFormat();e.hitPolicies=this.getHitPolicies();e.enableSettings=this.getEnableSettings();e.isAtLeastOneRowSelected=false;e.isExactlyOneRowSelected=false;e.isSelection=false;e.validationStatus={};e.valueState={};e.selectedRow=null;this._internalModel=new sap.ui.model.json.JSONModel(e);this.setModel(this._internalModel,"dtModel");},_initDisplayModel:function(){this._displayModel=new sap.ui.model.json.JSONModel();this.setModel(this._displayModel,"displayModel");this._settingsModel=new sap.ui.model.json.JSONModel();this.setModel(this._settingsModel,"settingModel");},_initDataBucket:function(){var e=false;var E=sap.ui.getCore().byId(this.getExpressionLanguage());if(E&&E._isDataExist()){e=true;}this.dataBucket={dataReceived:{vocabulary:e,rule:false,rows:false,columns:false},rows:{},columns:{},collectRowsMode:"replace"};},_setDataLoadedPromise:function(){if(!this._dataLoaded||this._dataLoaded.state()!=="pending"){this._dataLoaded=new q.Deferred();}},_getDataLoadedPromise:function(){if(!this._dataLoaded){this._setDataLoadedPromise();}return this._dataLoaded.promise();},setBindingContextPath:function(e){var i=this.getBindingContextPath();if(e&&(i!==e)){this._unbindRule();this._unbindRows();this._unbindColumns();this.setProperty("bindingContextPath",e);this.resetContent=true;this._initDataBucket();var j=this.getModel();if(!j.isMetadataLoadingFailed()){if(j.getServiceMetadata()){this._internalModel.setProperty("/sequenceExist",this.isSequenceExistsInOdataMetadata());}else{j.attachMetadataLoaded(function(){this._internalModel.setProperty("/sequenceExist",this.isSequenceExistsInOdataMetadata());}.bind(this));}}}return this;},setModelName:function(e){this.setProperty("modelName",e);this.resetContent=true;return this;},resetControl:function(){this._unbindRule();this._unbindRows();this._unbindColumns();this._clearErrorMessages();this._initDataBucket();this._initDisplayModel();this._updateBusyState();var e=this._getModel();var i=this.getBindingContextPath();if(!i||!e){return;}var j=new sap.ui.model.Context(e,i);this.setBindingContext(j);this._bindRule();this._bindRows();this._bindColumns();},isSequenceExistsInOdataMetadata:function(){var e=this.getModel();if(e){var t=e.getServiceMetadata();if(t){var E=t.dataServices.schema[0].entityType;var u;var w;var x;for(var i=0;i<E.length;i++){u=E[i];if(u.name!=="DecisionTableColumn"){continue;}w=u.property;for(var j=0;j<w.length;j++){x=w[j];if(x.name==="Sequence"){return true;}}}}}return false;},_createNewDecisionTableSettings:function(){var e=this._getModel();var i=this.getBindingContext();var j=new sap.rules.ui.DecisionTableSettings({expressionLanguage:this.getExpressionLanguage(),hitPolicies:"{dtModel>/hitPolicies}",newDecisionTable:this._internalModel.getProperty("/newTable"),cellFormat:"{dtModel>/cellFormat}"});var t=JSON.stringify(this._settingsModel.getData());var u=JSON.parse(t);var w=new sap.ui.model.json.JSONModel(u);j.setModel(w);j.setModel(this._internalModel,"dtModel");j.setModel(e,"oDataModel");j.setBindingContext(i,"dummy");return j;},_createOldDecisionTableSettings:function(){var e=this._getModel();var i=this.getBindingContext();var j=new o({expressionLanguage:this.getExpressionLanguage(),hitPolicies:"{dtModel>/hitPolicies}",newDecisionTable:this._internalModel.getProperty("/newTable")});j.setModel(e);j.setModel(this._internalModel,"dtModel");j.setBindingContext(i);return j;},_createDecisionTableSettings:function(){var e;if(this.isSequenceExistsInOdataMetadata()){e=this._createNewDecisionTableSettings();}else{e=this._createOldDecisionTableSettings();}return e;},_openTableSettings:function(){this.dataBucket.dataReceived.rows=false;var e=this._createDecisionTableSettings();var j=new b({contentWidth:"70%",title:this.oBundle.getText("tableSettings")});j.addContent(e);var t=e.getButtons(j);for(var i=0;i<t.length;i++){j.addButton(t[i]);}j.attachBeforeClose(function(u){var w=j.getState();j.destroy();if(w===sap.ui.core.ValueState.Success){this._initDisplayModel();this._refreshBinding();}},this);j.open();},_getBindModelName:function(){var e="";var i=this.getModelName();if(i){e=i+">";}return e;},_getModel:function(){var e=this.getModelName();if(e){return this.getModel(e);}return this.getModel();},columnFactory:function(i,e){if(this.multiHeaderFlag){this.multiHeaderFlag=false;}var j=this._getBindModelName();var t=new C(i,{width:"auto",multiLabels:[this._createColIfThenHeader(e),this._createColDescriptionHeader(e)],template:this._createCell(e)});t.isConditionOrFirstResultColumn=!this.firstResultColumnBound;j=this._getBindModelName();this.firstResultColumnBound=e.getProperty(j+"Type")===sap.rules.ui.DecisionTableColumn.Result;return t;},_createColDescriptionHeader:function(e){var i="displayModel>",j=e.getProperty("Type"),t=e.getProperty("Id"),u=e.getProperty("RuleId"),w=e.getProperty("Version");var x;var H={RuleId:u,Id:t,Version:w};var y=document.getElementsByClassName("sapUiSizeCozy").length>0?3:1;var z=new f({maxLines:y}).addStyleClass("sapRULDecisionTableColumnHeaderLabel");if(j===sap.rules.ui.DecisionTableColumn.Condition){x=i+e.getModel().createKey("/DecisionTableColumnConditions",H);z.bindText({parts:[{path:x+"/Expression"},{path:x+"/FixedOperator"}],formatter:function(E,A){return(E||A)?E+" "+A:"";}});z.bindProperty("tooltip",{parts:[{path:x+"/Expression"},{path:x+"/FixedOperator"}],formatter:function(E,A){return E+" "+A;}});}else if(j===sap.rules.ui.DecisionTableColumn.Result){x=i+e.getModel().createKey("/DecisionTableColumnResults",H);z.bindText({parts:[{path:x+"/DataObjectAttributeName"},{path:"dtModel>/busyState"}],formatter:this._getOutputColumnDescription.bind(this)});z.bindProperty("tooltip",{parts:[{path:x+"/DataObjectAttributeName"},{path:"dtModel>/busyState"}],formatter:this._getOutputColumnDescription.bind(this)});}return z;},_getOutputColumnDescription:function(N){var e=sap.ui.getCore().byId(this.getExpressionLanguage());if(e&&e._isDataExist()){var i=this.getBindingContext().getProperty("ResultDataObjectId");var j=e.getResultColumnDescription(N,i);return j;}else{return N;}},_createColIfThenHeader:function(e){var i=this._getBindModelName();var j=this.oBundle;return new g({text:{parts:[{path:i+"Type"},{path:i+"Sequence"}],formatter:function(t,S){if(S===1){return j.getText("conditionIfColumn");}else if(t===sap.rules.ui.DecisionTableColumn.Result&&this.getParent().isConditionOrFirstResultColumn){return j.getText("resultThenColumn");}else{return"";}}},design:"Bold"});},_createCell:function(e){var i=e.getProperty("Id");var j=e.getProperty("Type");return new D({editable:"{dtModel>/editable}",expressionLanguage:this.getExpressionLanguage(),displayModelName:"displayModel",decisionTableCellType:this._decisionTableCellFormatter}).data({colId:i,colType:j,table:this.getAggregation("_table")});},_updateTableCell:function(e,i,j,t){e.removeStyleClass("sapRULDecisionTableSCellMarked");var u="null";if(i){var w=e.data("colId");var x=i.getProperty("Id");var y=i.getProperty("RuleId");var z=i.getProperty("Version");var A='';var E="DecisionTableRowCells(RuleId='"+y+"',Version='"+z+"',RowId="+x+",ColId="+w+")";var G={RuleId:y,Id:w,Version:z};u="/"+E+"/Content";var H=e.getParent().getParent().getParent().getLineActionBuffer().rowPath;if(H&&(H.indexOf(",Id="+x+")")>0)){e.addStyleClass("sapRULDecisionTableSCellMarked");}switch(e.data("colType")){case"CONDITION":A="/"+i.getModel().createKey("DecisionTableColumnConditions",G);e.setHeaderValuePath(A+'/Expression');e.setFixedOperatorPath(A+'/FixedOperator');e.setValueOnlyPath(A+'/ValueOnly');break;case"RESULT":A="/"+i.getModel().createKey("DecisionTableColumnResults",G);e.setTypePath(A+'/BusinessDataType');break;default:break;}e.setValueStateTextPath("dtModel>/validationStatus/"+"RowId="+x+",ColId="+w);e.setValueStatePath("dtModel>/valueState/"+"RowId="+x+",ColId="+w);}e.setValuePath(u);},_bindRule:function(){var e=[this._getBindModelName(),this.getBindingContextPath()].join("");this.bindElement({path:e,parameters:{expand:"DecisionTable"}});this.getElementBinding().attachDataRequested(this._handleRuleDataRequested,this);this.getElementBinding().attachDataReceived(this._handleRuleDataReceived,this);this.getElementBinding().refresh();},_unbindRule:function(){this.unbindElement();},_bindColumns:function(){var t=this.getAggregation("_table");var e=[this._getBindModelName(),this.getBindingContextPath(),"/DecisionTable/DecisionTableColumns"].join("");t.bindColumns({path:e,parameters:{expand:"Condition,Result"},factory:this.columnFactory.bind(this)});t.getBinding("columns").attachDataRequested(this._handleColumnsDataRequested,this);t.getBinding("columns").attachDataReceived(this._handleColumnsDataReceived,this);},_unbindColumns:function(){var t=this.getAggregation("_table");t.unbindColumns();},_bindRows:function(){var t=this.getAggregation("_table");var e=[this._getBindModelName(),this.getBindingContextPath(),"/DecisionTable/DecisionTableRows"].join("");var S=new sap.ui.model.Sorter("Sequence");t.bindRows({path:e,parameters:{expand:"Cells"},sorter:S});t.getBinding("rows").attachDataRequested(this._handleRowsDataRequested,this);t.getBinding("rows").attachDataReceived(this._handleRowsDataReceived,this);},_unbindRows:function(){var t=this.getAggregation("_table");t.unbindRows();},_refreshBinding:function(){var t=this.getAggregation("_table");var e=this.getElementBinding();if(e){e.refresh();}var i=t.getBinding("columns");if(i){i.refresh();}var j=t.getBinding("rows");if(j){j.refresh();}},_handleRuleDataRequested:function(){this._dataPartRequested(r.rule);},_handleRuleDataReceived:function(e){if(e){this._dataPartReceived(r.rule);}},_handleColumnsDataRequested:function(e){this._dataPartRequested(r.columns);},_handleColumnsDataReceived:function(e){var i=e.getParameter("data");if(!i){return;}var t=this.getAggregation("_table");if(i.results&&i.results.length>0){this._internalModel.setProperty("/newTable",false);t.setNoData(null);this._setExpressionLanguageVersionOnoData(false);}else{this._internalModel.setProperty("/newTable",true);var j=this._getBlankContent();t.setNoData(j);this._setExpressionLanguageVersionOnoData(true);}this.dataBucket[r.columns]=i;this._dataPartReceived(r.columns);this._handleHeaderSpan();},_handleRowsDataRequested:function(e){this._dataPartRequested(r.rows);},_handleRowsDataReceived:function(e){var i=e.getParameter("data");if(i){if(this.dataBucket.collectRowsMode==="replace"){this.dataBucket[r.rows]=i;this.dataBucket.collectRowsMode="append";}else{var j=this.dataBucket[r.rows];var t={results:(j.results)?j.results.concat(i.results):i.results};this.dataBucket[r.rows]=t;}this._dataPartReceived(r.rows);}this._setTableRows();},_handleVocabularyDataChanged:function(e){var i=e.getParameter("data");if(i){this._handleVocabularyDataReceived(i);}else{this._handleVocabularyDataRequested();}},_handleVocabularyDataRequested:function(){this._dataPartRequested(r.vocabulary);},_handleVocabularyDataReceived:function(e){if(e){this._dataPartReceived(r.vocabulary);}},_dataPartRequested:function(e){this.dataBucket.dataReceived[e]=false;this._setDataLoadedPromise();this._updateBusyState();},_dataPartReceived:function(e){this.dataBucket.dataReceived[e]=true;if(!this._isAllDataReceived()){return;}try{this._convertAndValidate();this.dataBucket.collectRowsMode="replace";}catch(E){window.console.log(E);}this._updateBusyState();this._dataLoaded.resolve();},_isAllDataReceived:function(){var e=this.dataBucket.dataReceived;return e.rule&&e.rows&&e.columns&&e.vocabulary;},_updateBusyState:function(){var e=this.dataBucket.dataReceived;var i=e.rule&&e.columns&&e.vocabulary;var j=!i;this._internalModel.setProperty("/busyState",j);var t=!e.rows;this._internalModel.setProperty("/busyTableState",t);},_decideSettingsEnablement:function(e,i){return e&&i;},_decideDeleteRowEnablement:function(e,i){return e===false&&i;},_decideCopyRowEnablement:function(e,i){return e===false&&i;},_decideLineActionVisibility:function(i,e){return i===true&&e;},_decideAddRowEnablement:function(e){return!e;},_decidePasteRowEnablement:function(e,i,j){return e===false&&i&&j;},_addToolBar:function(){var t=new a({design:"Transparent",enabled:"{dtModel>/editable}"});var e=new sap.m.Title({text:this.oBundle.getText("decisionTable")});var A=new c({text:this.oBundle.getText("addRow"),visible:"{dtModel>/editable}",enabled:{parts:[{path:"dtModel>/newTable"}],formatter:this._decideAddRowEnablement},menu:new M({items:this._getMenuItems(),itemSelected:function(x){x.getParameter("item").firePress();}})}).setTooltip(this.oBundle.getText("addRow"));var i=new B({text:this.oBundle.getText("deleteRow"),press:[this._deleteRowWorkaround,this],visible:"{dtModel>/editable}",enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isAtLeastOneRowSelected"}],formatter:this._decideDeleteRowEnablement}}).setTooltip(this.oBundle.getText("deleteRow"));var j=new B({text:this.oBundle.getText("copyRow"),press:[this._copyRow,this],visible:{parts:[{path:"dtModel>/editable"},{path:"dtModel>/sequenceExist"}],formatter:this._decideLineActionVisibility},enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement}}).setTooltip(this.oBundle.getText("copyRow"));var u=new B({text:this.oBundle.getText("cutRow"),press:[this._cutRow,this],visible:{parts:[{path:"dtModel>/editable"},{path:"dtModel>/sequenceExist"}],formatter:this._decideLineActionVisibility},enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement}}).setTooltip(this.oBundle.getText("cutRow"));var w=new c({text:this.oBundle.getText("pasteRow"),visible:{parts:[{path:"dtModel>/editable"},{path:"dtModel>/sequenceExist"}],formatter:this._decideLineActionVisibility},enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"},{path:"dtModel>/isSelection"}],formatter:this._decidePasteRowEnablement},menu:new M({items:this._getPasteMenuItems(),itemSelected:function(x){x.getParameter("item").firePress();}})}).setTooltip(this.oBundle.getText("pasteRow"));var S=new B({text:"",press:this._openTableSettings.bind(this),visible:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement},enabled:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement}}).setTooltip(this.oBundle.getText("tableSettings"));S.setIcon("sap-icon://action-settings");t.addContent(e);t.addContent(new d({}));t.addContent(A);t.addContent(new d({width:"1em"}));t.addContent(i);t._delete=i;t.addContent(new d({width:"1em"}));t.addContent(j);t.addContent(new d({width:"1em"}));t.addContent(u);t.addContent(new d({width:"1em"}));t.addContent(w);t.addContent(new d({width:"1em"}));t.addContent(S);t.addContent(new d({width:"1em"}));this.setAggregation("_toolbar",t,true);},_rowAction:function(e){var i=this._internalModel.getProperty("/selectedRow");this._markSelection(false);var j=this.getLineActionBuffer();this.setLineActionBuffer({rowPath:null,operation:null});var t=this.getAggregation("_table");var u=i+1;if(e==="insertAfter"){u++;}var w=this._getModel();var S=w.getProperty(j.rowPath).Id;var x=w.getProperty(j.rowPath).RuleId;var V=w.getProperty(j.rowPath).Version;this._internalModel.setProperty("/busyState",true);var y=(j.operation==="cut");if(e==="paste"){this._callCopyRuleRow(x,V,S,u,y,true);}else{this._callCopyRuleRow(x,V,S,u,y,false);}t.setSelectedIndex(-1);sap.m.MessageToast.show(this.oBundle.getText("pasteSuccess"));},_callCopyRuleRow:function(i,V,S,t,j,u){var w={groupId:"changes"};this._getModel().setDeferredGroups([w.groupId]);var x=function(e){var A=this.getAggregation("_table");A.getBinding("rows").refresh();this._internalModel.setProperty("/busyState",false);}.bind(this);var y=function(e){sap.m.MessageToast.show(e);}.bind(this);var z=function(e){this._getModel().callFunction("/CopyRuleRow",{method:"POST",groupId:w.groupId,urlParameters:{RuleId:i,SourceRowId:S,TargetRowSeq:t,DeleteSourceRow:j,OverrideTargetRow:u}});this._getModel().submitChanges({groupId:w.groupId,success:x,error:y});}.bind(this);if(this._getModel().hasPendingChanges()){this._getModel().submitChanges({groupId:w.groupId,success:z,error:y});}else{z();}},_addNewRowWorkaround:function(e){var i=this._internalModel.getProperty("/selectedRow");this._addNewRow(i,e);},_addNewRow:function(e,i){var j=this.oMenu;if(j){j.close();}var t=this._getModel();var u=this.dataBucket.columns&&this.dataBucket.columns.results;if(!t||!u){return;}var w=this.getAggregation("_table"),x=this.getBindingContext(),y=x.getProperty("Id"),V=x.getProperty("Version");var z={RuleId:y,Version:V};e=e||0;var A;if(i){z.Sequence=1;}else{A=w.getContextByIndex(e).getPath();z.Sequence=t.getProperty(A).Sequence;z.Sequence++;}z.Id=0;t.createEntry("/DecisionTableRows",{properties:z});w.setSelectedIndex(-1);this._clearErrorMessages();this._saveWorkAround();},_copyRow:function(){this._cutCopyRow("copy");},_cutRow:function(){this._cutCopyRow("cut");},_cutCopyRow:function(e){var i=this._getModel();if(!i){return;}var t=this.getAggregation("_table");var S=[];if(t){S=t.getSelectedIndices();}if(S.length!==1){return;}var j=t.getContextByIndex(S[0]).getPath();this._markSelection(false);this.setLineActionBuffer({rowPath:j,operation:e});this._markSelection(true);t.setSelectedIndex(-1);sap.m.MessageToast.show(this.oBundle.getText(e+"RowSuccess"));},_markSelection:function(e){var j=this.getLineActionBuffer().rowPath;var t=this.getAggregation("_table");var u=this._getModel();if(j){var w=t.getFirstVisibleRow();var x=u.getProperty(j).Sequence-1;if((x-w>-1)&&(x-w<t.getVisibleRowCount())){var y=t.getRows()[x-w];var z=y.getCells();if(z){for(var i=0;i<z.length;i++){if(e){z[i].addStyleClass("sapRULDecisionTableSCellMarked");}else{z[i].removeStyleClass("sapRULDecisionTableSCellMarked");}}}}}},_deleteRowWorkaround:function(){var e=this._getModel();if(e.hasPendingChanges()){this._saveWorkAround({success:function(){this._deleteRow();}.bind(this)});}else{this._deleteRow();}},_deleteRow:function(){var e=this._getModel();if(!e){return;}var t=this.getAggregation("_table");var S=[];if(t){S=t.getSelectedIndices();}if(S.length===0){return;}var j=S.length;for(var i=0;i<j;i++){var u=t.getContextByIndex(S[i]).getPath();e.remove(u);}t.setSelectedIndex(-1);this._clearErrorMessages();},_setTableRows:function(){var t=this.getAggregation("_table");var e=t.getBinding("rows");var V=v.emptyTable;if(e&&e.getLength()){V=Math.min(e.getLength(),v.max);}var i=t.getVisibleRowCount();if(i!==V){t.setVisibleRowCount(V);}if(this.dataBucket.rows.results.length===0||!this.getEditable()){t.setSelectionMode(sap.ui.table.SelectionMode.None);}else{t.setSelectionMode(sap.ui.table.SelectionMode.MultiToggle);}},_getMenuItems:function(){var e=[new m({text:this.oBundle.getText("insertFirst"),enabled:true,press:this._addNewRowWorkaround.bind(this,true)}),new m({text:this.oBundle.getText("insertAfter"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._addNewRowWorkaround.bind(this,false)})];return e;},_getPasteMenuItems:function(){var e=[new m({text:this.oBundle.getText("pasteRowAction"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._rowAction.bind(this,"paste")}),new m({text:this.oBundle.getText("insertBeforeRowAction"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._rowAction.bind(this,"insertBefore")}),new m({text:this.oBundle.getText("insertAfterRowAction"),enabled:{parts:[{path:"dtModel>/newTable"},{path:"dtModel>/isExactlyOneRowSelected"}],formatter:this._decideCopyRowEnablement},press:this._rowAction.bind(this,"insertAfter")})];return e;},_rowSelectionChange:function(){var t=this.getAggregation("_table");var S=[];if(t){S=t.getSelectedIndices();}if(S.length>0){this._internalModel.setProperty("/isAtLeastOneRowSelected",true);this._internalModel.setProperty("/selectedRow",S[0]);}else{this._internalModel.setProperty("/isAtLeastOneRowSelected",false);}if(S.length==1){this._internalModel.setProperty("/isExactlyOneRowSelected",true);}else{this._internalModel.setProperty("/isExactlyOneRowSelected",false);}if(this.getLineActionBuffer().rowPath){this._internalModel.setProperty("/isSelection",true);}else{this._internalModel.setProperty("/isSelection",false);}},_getBlankContent:function(){var e=new g({text:this.oBundle.getText("start")});var S=new f();S.setText("\u00a0");var i=new L({enabled:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement},text:" "+this.oBundle.getText("settings"),press:[this._openTableSettings,this]}).addStyleClass("sapRULDecisionTableLink");var j=new F({justifyContent:"Center",items:[e,S,i],visible:{parts:[{path:"dtModel>/enableSettings"},{path:"dtModel>/editable"}],formatter:this._decideSettingsEnablement}}).addStyleClass("sapUiMediumMargin");return j;},_decideSelectionMode:function(e){return e?sap.ui.table.SelectionMode.MultiToggle:sap.ui.table.SelectionMode.None;},_addTable:function(){var t=new T({visibleRowCount:v.emptyTable,visibleRowCountMode:sap.ui.table.VisibleRowCountMode.Fixed,threshold:20,selectionMode:{parts:[{path:"dtModel>/editable"}],formatter:this._decideSelectionMode},rowSelectionChange:function(){this.oParent._rowSelectionChange();},enableColumnReordering:false,busy:"{dtModel>/busyTableState}"});t._updateTableCell=this._updateTableCell;t.setBusyIndicatorDelay(0);this.setAggregation("_table",t,true);},_buildMessagesStructure:function(e,j,t){var u;var x;var y;var z;if(!e.details){return j;}for(var w=0;w<e.details.length;w++){u=e.details[w];if(!u.messages){continue;}for(var i=0;i<u.messages.length;i++){y=u.messages[i].description;x=u.messages[i].additionalInfo;if(x.type==="ruleResult"){t.push(y);z="genericError";j[z]=t;}else if(x.type==="column"){z="errorInColumnHeader";j[z]=true;}else if(x.type==="cell"){z="RowId="+x.rowId+",ColId="+x.colId;j[z]=y;}}}return j;},_concatinateHeaderErrors:function(e){var j="";for(var i=0;i<e.length;i++){j+="\n"+e[i];}return j;},_concatinateColumnsHeaderErrors:function(e){var i="";for(var j in e){if(e.hasOwnProperty(j)){if(e[j].header){i+="In Col: "+j+" - "+e[j].header+"\n";}}}return i;},_displayHeaderErrorMessages:function(e,i){var t=this.getAggregation("_errorsText");this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");var j=this._concatinateHeaderErrors(e);t.setText(this.oBundle.getText("errorInTableHeader")+j);t.setVisible(true);},_clearErrorMessages:function(){var t=this.getAggregation("_errorsText");t.setText("");t.setVisible(false);this._internalModel.setProperty("/validationStatus",{},null,true);this._internalModel.setProperty("/valueState",{},null,true);},_displayErrorMessages:function(e,i){},_flatRule:function(e){var i=this._getModel();var j={};var t=function(u,w,x){var y=i.createKey(w,x);u[y]=x;};e.DecisionTable.DecisionTableColumns.results.forEach(function(u,w){if(u.Type==="CONDITION"){var x=u.Condition;if(x.parserResults&&x.parserResults.status==="Success"){x.Expression=x.parserResults.converted.Expression;if(x.parserResults.converted.FixedOperator||x.parserResults.converted.FixedOperator===""){x.FixedOperator=x.parserResults.converted.FixedOperator;}else{x.FixedOperator=x.FixedOperator;}}else{try{x.Expression=JSON.parse(x.Expression).text;}catch(y){x.Expression=x.Expression;}try{x.FixedOperator=JSON.parse(x.FixedOperator).text;}catch(y){x.Expression=x.Expression;}}delete x.parserResults;t(j,"DecisionTableColumnConditions",x);}else if(u.Type==="RESULT"){var z=u.Result;t(j,"DecisionTableColumnResults",z);}});e.DecisionTable.DecisionTableRows.results.forEach(function(u){var w=u.Cells;w.results.forEach(function(x){if(x.parserResults&&x.parserResults.status==="Success"){x.Content=x.parserResults.converted.Content;}else if(x.parserResults&&x.parserResults.status==="Error"){try{if(x.Content===Object){x.Content=JSON.parse(x.Content).text;}else{x.Content=x.Content;}}catch(y){x.Content="";q.sap.log.error("failed to pars AST cell in ColId "+x.ColId+" RowId "+x.RowId+" set cell content to empty");}}delete x.parserResults;t(j,"DecisionTableRowCells",x);});});return j;},_processValidationResults:function(e,i){if(e&&e.output){if(e.output.status==="Error"){var j=[];var t=this._internalModel.getProperty("/validationStatus");var u={};t=this._buildMessagesStructure(e,t,j);for(var w in t){if(t.hasOwnProperty(w)&&(typeof t[w]==="string")){u[w]=sap.ui.core.ValueState.Error;}}this._displayErrorMessages(j,t);this._internalModel.setProperty("/validationStatus",t,null,true);this._internalModel.setProperty("/valueState",u,null,true);}var x=this._flatRule(e.output.decisionTableData);e.output.decisionTableData.DecisionTable.DecisionTableRows=null;this._settingsModel.setData(e.output.decisionTableData);this._displayModel.setData(x,true);}},_convertAndValidate:function(){var e=this._getRuleData();var E=sap.ui.getCore().byId(this.getExpressionLanguage());var i={};if(E&&e){i=E.convertRuleToDisplayValues(e);if(i.deferredResult){i.deferredResult.done(this._processValidationResults.bind(this));}else{this._processValidationResults(i);}}},_getRuleData:function(){var e=this.getBindingContextPath();var i=this._getModel();var j=q.extend({},true,i.getProperty(e,null,true));var t=j.DecisionTable;t.DecisionTableColumns=this.dataBucket.columns;t.DecisionTableRows=this.dataBucket.rows;return j;},onBeforeRendering:function(){if(this.resetContent){this.resetControl();this.resetContent=false;}},_handleHeaderSpan:function(){if(!this.multiHeaderFlag){var i;this.multiHeaderFlag=true;var e=this.dataBucket.columns.results;this.iNumOfCondition=0;this.iNumOfResults=0;for(i=0;i<e.length;i++){if(e[i].Type===sap.rules.ui.DecisionTableColumn.Condition){this.iNumOfCondition++;}else if(e[i].Type===sap.rules.ui.DecisionTableColumn.Result){this.iNumOfResults++;}}var t=this.getAggregation('_table');e=t.getAggregation('columns');for(i=0;i<this.iNumOfCondition;i++){e[i].setHeaderSpan([this.iNumOfCondition,1]);}for(;i<e.length;i++){e[i].setHeaderSpan([this.iNumOfResults,1]);}}},_setExpressionLanguageVersionOnoData:function(N){var e=this._getModel();var i=this.getBindingContext();var V="1.0.0";if(N){var E=sap.ui.getCore().byId(this.getExpressionLanguage());V=E.getExpressionLanguageVersion();e.setProperty("ExpressionLanguageVersion",V,i,true);}else{V=e.getProperty(this.getBindingContextPath()+'/ExpressionLanguageVersion');if(!V){V="1.0.0";}}this._decisionTableCellFormatter.setExpressionLanguageVersion(V);},exit:function(){var e=this.oMenu;if(e){e.destroy();}}});sap.rules.ui.DecisionTable.prototype._saveWorkAround=function(e){var i=this._getModel();i.submitChanges(e);};return s;},true);
