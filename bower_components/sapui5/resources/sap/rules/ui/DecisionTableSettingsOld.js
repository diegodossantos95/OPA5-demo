/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/rules/ui/library","sap/ui/core/Control","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Switch","sap/m/Select","sap/m/Table","sap/m/Text","sap/m/CheckBox","sap/m/Input","sap/m/Button","sap/rules/ui/ExpressionAdvanced","sap/ui/layout/VerticalLayout","sap/rules/ui/type/Expression"],function(q,l,C,S,L,a,b,T,c,d,I,B,E,V,e){"use strict";var D=C.extend("sap.rules.ui.DecisionTableSettingsOld",{metadata:{library:"sap.rules.ui",properties:{hitPolicies:{type:"sap.rules.ui.RuleHitPolicy[]",defaultValue:[sap.rules.ui.RuleHitPolicy.FirstMatch,sap.rules.ui.RuleHitPolicy.AllMatch]},modelName:{type:"string",defaultValue:""},newDecisionTable:{type:"boolean",defaultValue:false}},aggregations:{mainLayout:{type:"sap.ui.layout.form.SimpleForm",multiple:false}},defaultAggregation:"mainLayout",associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"}},events:{},publicMethods:[]}});sap.rules.ui.DecisionTableSettingsOld.prototype.init=function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.needCreateLayout=true;this.firstLoad=true;this.onsapescape=function(o){o.stopPropagation();};this._decisionTableHeaderSettingFormatter=new e();this.setBusyIndicatorDelay(0);};sap.rules.ui.DecisionTableSettingsOld.prototype.onBeforeRendering=function(){if(this.firstLoad){this._initSettingsModel();if(this.getProperty("newDecisionTable")===true){this._prepareNewRuleWorkaround();}this.firstLoad=false;}if(this.needCreateLayout){var f=this.getAggregation("mainLayout");if(f){f.destroy();}f=this._createLayout();this.setAggregation("mainLayout",f,true);this.needCreateLayout=false;this.conditionsTable.getBinding("items").attachDataRequested(function(){this.setBusy(true);}.bind(this));this.conditionsTable.getBinding("items").attachDataReceived(function(){this.setBusy(false);}.bind(this));}};sap.rules.ui.DecisionTableSettingsOld.prototype._prepareNewRule=function(){var m=this._getModel();var o=this.getBindingContext();var r=sap.rules.ui.RuleFormat.Advanced;m.setProperty("Type",sap.rules.ui.RuleType.DecisionTable,o,true);m.setProperty("RuleFormat",r,o,true);var f=sap.ui.getCore().byId(this.getExpressionLanguage());var s=f.getExpressionLanguageVersion();m.setProperty("ExpressionLanguageVersion",s,o,true);var g={ruleId:o.getProperty("Id"),version:o.getProperty("Version")};var p={};this._createDecisionTable(g,p);g.colId=1;g.expression="";this._createCondition(g,p);g.colId=2;var h=this._createResult(g,p);g.rowId=1;g.columnsNumber=1+h;this._createRow(g,p);};sap.rules.ui.DecisionTableSettingsOld.prototype._createDecisionTable=function(o,p){var m=this._getModel();var f=this.getBindingContext();var h=this.getHitPolicies()[0];if(f.getProperty("DecisionTable")){m.setProperty("DecisionTable/HitPolicy",h,f,true);}else{var g={RuleId:o.ruleId,Version:o.version,HitPolicy:h};p=p?p:{};p.properties=g;m.createEntry("/DecisionTables",p);}};sap.rules.ui.DecisionTableSettingsOld.prototype._createRow=function(o,p){p=p?p:{};var m=this._getModel();var r={RuleId:o.ruleId,Version:o.version,Id:o.rowId};p.properties=r;m.createEntry("/DecisionTableRows",p);this._createCellsForNewRow(o,p);};sap.rules.ui.DecisionTableSettingsOld.prototype._createCondition=function(o,p){p=p?p:{};var m=this._getModel();var f={RuleId:o.ruleId,Version:o.version,Id:o.colId,Type:sap.rules.ui.DecisionTableColumn.Condition};p.properties=f;m.createEntry("/DecisionTableColumns",p);var g={RuleId:o.ruleId,Version:o.version,Id:o.colId,Expression:o.expression,ValueOnly:false,FixedOperator:"",Description:""};p.properties=g;m.createEntry("/DecisionTableColumnConditions",p);};sap.rules.ui.DecisionTableSettingsOld.prototype._createCellsForNewColumn=function(o,p){p=p?p:{};var m=this._getModel();var f=this.getBindingContext();var r=m.getProperty("DecisionTable/DecisionTableRows",f);for(var i=0;i<r.length;i++){var g=m.getProperty("/"+r[i]).Id;var h={RuleId:o.ruleId,Version:o.version,RowId:g,ColId:o.colId,Content:""};p.properties=h;m.createEntry("/DecisionTableRowCells",p);}};sap.rules.ui.DecisionTableSettingsOld.prototype._createCellsForNewRow=function(o,p){p=p?p:{};var m=this._getModel();for(var f=1;f<=o.columnsNumber;f++){var g={RuleId:o.ruleId,Version:o.version,RowId:o.rowId,ColId:f,Content:""};p.properties=g;m.createEntry("/DecisionTableRowCells",p);}};sap.rules.ui.DecisionTableSettingsOld.prototype._createResult=function(o,p){var f=this.getBindingContext();var r=f.getProperty("ResultDataObjectName");var g=sap.ui.getCore().byId(this.getExpressionLanguage());var h=g.getResultInfo(r);var j=h?h.requiredParams:[];var k=j.length;var m=o.colId;for(var i=0;i<k;i++){o.colId=m+i;o.resultParameterData=j[i];this._createResultParameter(o,p);}return k;};sap.rules.ui.DecisionTableSettingsOld.prototype._createResultParameter=function(o,p){p=p?p:{};var m=this._getModel();var f={RuleId:o.ruleId,Version:o.version,Id:o.colId,Type:sap.rules.ui.DecisionTableColumn.Result};p.properties=f;m.createEntry("/DecisionTableColumns",p);var r={RuleId:o.ruleId,Version:o.version,Id:o.colId,DataObjectAttributeName:o.resultParameterData.name,DataObjectAttributeId:o.resultParameterData.paramId,BusinessDataType:o.resultParameterData.businessDataType};p.properties=r;m.createEntry("/DecisionTableColumnResults",p);};sap.rules.ui.DecisionTableSettingsOld.prototype._removeColumn=function(o,p){var m=this._getModel();var f=o.getPath();m.remove(f,p);this._internalModel.setProperty("/tableData",{},true);};sap.rules.ui.DecisionTableSettingsOld.prototype._removeCellsForColumn=function(o,p){var m=this._getModel();var f=this.getBindingContext();var r=m.getProperty("DecisionTable/DecisionTableRows",f);var g=o.colId-1;for(var i=0;i<r.length;i++){var h=m.getProperty("/"+r[i]+"/Cells");var j="/"+h[g];m.remove(j,p);}};sap.rules.ui.DecisionTableSettingsOld.prototype._createTable=function(){this.conditionsTable=new T({backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.None,fixedLayout:true,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new sap.m.Column({width:"50%",header:new sap.m.Label({text:this.oBundle.getText("colOfDecisionTable"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("colOfDecisionTable"))}),new sap.m.Column({width:"30%",header:new sap.m.Label({text:this.oBundle.getText("fixedOperator"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("fixedOperator"))}),new sap.m.Column({width:"20%"})]}).data("hrf-id","columnsTable",true);this.conditionsTable.bindItems({path:"DecisionTable/DecisionTableColumnsCondition",factory:this._tableColumnsFactory.bind(this),parameters:{expand:"Condition"}});this.conditionsTable.setBusyIndicatorDelay(0);return this.conditionsTable;};sap.rules.ui.DecisionTableSettingsOld.prototype._createLayout=function(){var f=new S({editable:true,layout:"ResponsiveGridLayout",maxContainerCols:1,columnsL:1,columnsM:1,labelSpanM:1,content:[new L({text:this.oBundle.getText("hitPolicy")}).setTooltip(this.oBundle.getText("hitPolicy")),new b({width:"25%",enabled:"{settingsModel>/hitPolicy/enabled}",items:{path:"settingsModel>/hitPolicy/hitPolicyEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>text}"})},selectedKey:"{DecisionTable/HitPolicy}"}),new L(),this._createTable(),new L({text:this.oBundle.getText("ouput")}).setTooltip(this.oBundle.getText("ouput")),new c({width:"25%",text:"{ResultDataObjectName}"})]});return f;};sap.rules.ui.DecisionTableSettingsOld.prototype._setFixedOperatorOnExpressionChange=function(f,g){var F=this._getFixedOperatorDataForExpression(f);this._internalModel.setProperty("/tableData/"+g,F,true);this._updateRemoveRowEnabled();};sap.rules.ui.DecisionTableSettingsOld.prototype.setExpressionLanguage=function(o){this.setAssociation("expressionLanguage",o,true);this._decisionTableHeaderSettingFormatter.setExpressionLanguage(o);};sap.rules.ui.DecisionTableSettingsOld.prototype._getColumnControlObject=function(o){var m=this._internalModel.getProperty("/advancedMode/current");if(m===sap.rules.ui.RuleFormat.Advanced){var f=sap.ui.getCore().byId(this.getExpressionLanguage());return new E({expressionLanguage:f,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,type:sap.rules.ui.ExpressionType.NonComparison,value:{path:"Condition/Expression",type:this._decisionTableHeaderSettingFormatter,events:{change:function(g){var s=g.getSource();var h=s.getContext();var i=h.getProperty("Id");var r=f.convertDecisionTableExpressionToDisplayValue(s.getValue(),"","",sap.rules.ui.ExpressionType.All);var v;if(r.output.status==="Success"&&r.output.converted){v=r.output.converted.header;}else{v=s.getValue();}this._setFixedOperatorOnExpressionChange(v,i);}.bind(this)}},enabled:true,change:function(g){var s=g.getSource();var h=s.getBindingContext();var i=h.getProperty("Id");this._setFixedOperatorOnExpressionChange(s.getValue(),i);var j=h.getProperty("Condition/Expression");if(!j){var k=h.getModel();k.setProperty(h.getPath()+"/Condition/FixedOperator","");}}.bind(this)});}else{return new b({width:"100%",items:{path:"",template:new sap.ui.core.Item({key:"",text:""})},selectedKey:"{Condition/Expression}",enabled:true,change:function(g){}});}};sap.rules.ui.DecisionTableSettingsOld.prototype._tableColumnsFactory=function(i,o){var r=o.getProperty("RuleId");var v=o.getProperty("Version");var f=o.getProperty("Id");return new sap.m.ColumnListItem({cells:[this._getColumnControlObject(o),new sap.m.Select({width:"100%",items:{path:"settingsModel>/tableData/"+f+"/fixOperatorEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>value}"})},selectedKey:"{Condition/FixedOperator}",enabled:"{settingsModel>/tableData/"+f+"/fixOperatorEnabled}"}),new sap.ui.layout.HorizontalLayout({content:[new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("sys-cancel"),visible:"{settingsModel>/removeRowEnabled}",press:function(g){var h=g.getSource().getBindingContext();var p={};this._removeColumnWorkaround(h,p);}.bind(this)}).setTooltip(this.oBundle.getText("removeColumn")),new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("add"),press:function(g){var h={ruleId:r,version:v,colId:f+1,expression:""};var p={};this._addConditionWorkaround(h,p);}.bind(this)}).setTooltip(this.oBundle.getText("addColumn"))],height:"1em"})]});};sap.rules.ui.DecisionTableSettingsOld.prototype._prepareNewRuleWorkaround=function(){this._prepareNewRule();this._saveWorkaround();};sap.rules.ui.DecisionTableSettingsOld.prototype._addConditionWorkaround=function(o,p){this._createCondition(o,p);this._saveWorkaround();};sap.rules.ui.DecisionTableSettingsOld.prototype._removeColumnWorkaround=function(o,p){var m=this._getModel();if(m.hasPendingChanges()){this._saveWorkaround({success:function(){this._removeColumn(o,p);}.bind(this)});}else{this._removeColumn(o,p);}};sap.rules.ui.DecisionTableSettingsOld.prototype._saveWorkaround=function(p){var m=this._getModel();m.submitChanges(p);};sap.rules.ui.DecisionTableSettingsOld.prototype._getModel=function(){var m=this.getModelName();if(m){return this.getModel(m);}return this.getModel();};sap.rules.ui.DecisionTableSettingsOld.prototype._getBindModelName=function(){var p="";var m=this.getModelName();if(m){p=m+">";}return p;};sap.rules.ui.DecisionTableSettingsOld.prototype._initSettingsModel=function(){var i={};i.advancedMode=this._getAdvancedModeData();i.hitPolicy=this._getHitPoliciesData();i.tableData={};i.removeRowEnabled=false;this._internalModel=new sap.ui.model.json.JSONModel(i);this.setModel(this._internalModel,"settingsModel");};sap.rules.ui.DecisionTableSettingsOld.prototype._getAdvancedModeData=function(){var m;var f={};var o=this.getBindingContext();var r=o.getProperty("RuleFormat");if(r===sap.rules.ui.RuleFormat.Advanced){m=sap.rules.ui.RuleFormat.Advanced;}else{m=sap.rules.ui.RuleFormat.Advanced;}switch(m){case sap.rules.ui.RuleFormat.All:f={current:sap.rules.ui.RuleFormat.Basic,enabled:true,visible:true};break;case sap.rules.ui.RuleFormat.Basic:f={current:sap.rules.ui.RuleFormat.Basic,enabled:false,visible:false};break;case sap.rules.ui.RuleFormat.Advanced:f={current:sap.rules.ui.RuleFormat.Advanced,enabled:false,visible:true};break;default:}return f;};sap.rules.ui.DecisionTableSettingsOld.prototype._getHitPoliciesData=function(){var h=this.getProperty("hitPolicies");var f=h.length;var H={hitPolicyEnumration:[]};for(var i=0;i<f;i++){H.hitPolicyEnumration.push({key:h[i],text:this.oBundle.getText(h[i])});}H.enabled=f>1?true:false;return H;};sap.rules.ui.DecisionTableSettingsOld.prototype._getFixedOperatorDataForExpression=function(s){var f=s?true:false;var g={fixOperatorEnumration:[{key:"",value:this.oBundle.getText("fixOperatorDefaultValue")}],fixOperatorEnabled:f};if(f){var o=[];var h=sap.ui.getCore().byId(this.getExpressionLanguage());var F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonExistOp}];o=h.getSuggestionsByCategories(s,F);for(var i=0;i<o.length;i++){g.fixOperatorEnumration.push({key:o[i].text,value:o[i].text});}}return g;};sap.rules.ui.DecisionTableSettingsOld.prototype._setAdvancedMode=function(o){var A=o.getParameter("selected");var r=A?sap.rules.ui.RuleFormat.Advanced:sap.rules.ui.RuleFormat.Basic;var R=this._getModel();var f=this.getBindingContext().getPath();R.setProperty(f+"/RuleFormat",r);this.needCreateLayout=true;this.invalidate();};sap.rules.ui.DecisionTableSettingsOld.prototype._updateRemoveRowEnabled=function(){var t=this._internalModel.getProperty("/tableData");var f=Object.keys(t).length;var g=f>1;this._internalModel.setProperty("/removeRowEnabled",g,null,true);};sap.rules.ui.DecisionTableSettingsOld.prototype.getButtons=function(o){var f=[];var A=new B({text:this.oBundle.getText("applyChangesBtn")}).setTooltip(this.oBundle.getText("applyChangesBtn"));A.attachPress(function(){this.multiHeaderFlag=false;this.getModel().submitChanges();o.setState(sap.ui.core.ValueState.Success);o.close();},this);f.push(A);return f;};return D;},true);
