/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/rules/ui/library","sap/ui/core/Control","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Switch","sap/m/Select","sap/m/MessageBox","sap/m/Table","sap/m/Text","sap/m/CheckBox","sap/m/Input","sap/m/Button","sap/rules/ui/ExpressionAdvanced","sap/ui/layout/VerticalLayout","sap/rules/ui/type/Expression"],function(q,l,C,S,L,a,b,M,T,c,d,I,B,E,V,e){"use strict";var D=C.extend("sap.rules.ui.DecisionTableSettings",{metadata:{library:"sap.rules.ui",properties:{cellFormat:{type:"sap.rules.ui.DecisionTableCellFormat",defaultValue:sap.rules.ui.DecisionTableCellFormat.Both},hitPolicies:{type:"sap.rules.ui.RuleHitPolicy[]",defaultValue:[sap.rules.ui.RuleHitPolicy.FirstMatch,sap.rules.ui.RuleHitPolicy.AllMatch]},modelName:{type:"string",defaultValue:""},newDecisionTable:{type:"boolean",defaultValue:false}},aggregations:{mainLayout:{type:"sap.ui.layout.form.SimpleForm",multiple:false}},defaultAggregation:"mainLayout",associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"}},events:{},publicMethods:[]}});sap.rules.ui.DecisionTableSettings.prototype.init=function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.needCreateLayout=true;this.firstLoad=true;this.onsapescape=function(o){o.stopPropagation();};this._decisionTableHeaderSettingFormatter=new e();this.setBusyIndicatorDelay(0);};sap.rules.ui.DecisionTableSettings.prototype.onBeforeRendering=function(){this.mNextColumnId=this._calcNextColumnId();if(this.firstLoad){this._initSettingsModel();if(this.getProperty("newDecisionTable")===true){this.mNextColumnId=1;this._prepareNewRule();}this.firstLoad=false;}if(this.needCreateLayout){var f=this.getAggregation("mainLayout");if(f){f.destroy();}f=this._createLayout();this.setAggregation("mainLayout",f,true);this.needCreateLayout=false;this.conditionsTable.getBinding("items").attachDataRequested(function(){this.setBusy(true);}.bind(this));this.conditionsTable.getBinding("items").attachDataReceived(function(){this.setBusy(false);}.bind(this));}};sap.rules.ui.DecisionTableSettings.prototype._setDefaultResult=function(){var _=this.getModel();var m=_.getData();var r=this._internalModel.getData().results.resultsEnumration;if(r.length===2){m.ResultDataObjectId=r[1].id;m.ResultDataObjectName=r[1].name;m.ResultDataObjectStatus="C";}};sap.rules.ui.DecisionTableSettings.prototype._createDefaultColumn=function(){var _=this.getModel();var m=_.getData();m.DecisionTable.DecisionTableColumns.results.push({Condition:{Expression:"",FixedOperator:"",Id:this.mNextColumnId++,RuleId:m.Id,Version:m.Version,ValueOnly:this._getCellFormat()},Id:1,Sequence:1,Type:sap.rules.ui.DecisionTableColumn.Condition,Status:"C"});};sap.rules.ui.DecisionTableSettings.prototype._updateDecisionTableHeader=function(){var _=this.getModel();var o=sap.ui.getCore().byId(this.getExpressionLanguage());var s=o.getExpressionLanguageVersion();var m=_.getData();m.Type=sap.rules.ui.RuleType.DecisionTable;m.RuleFormat=sap.rules.ui.RuleFormat.Advanced;m.ExpressionLanguageVersion=s;};sap.rules.ui.DecisionTableSettings.prototype._prepareNewRule=function(){this._updateDecisionTableHeader();this._createDefaultColumn();this._setDefaultResult();};sap.rules.ui.DecisionTableSettings.prototype._createTable=function(){this.conditionsTable=new T({backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.None,fixedLayout:true,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new sap.m.Column({width:"50%",header:new sap.m.Label({text:this.oBundle.getText("colOfDecisionTable"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("colOfDecisionTable"))}),new sap.m.Column({width:"30%",header:new sap.m.Label({text:this.oBundle.getText("fixedOperator"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("fixedOperator"))}),new sap.m.Column({width:"30%",header:new sap.m.Label({text:this.oBundle.getText("inputMode"),design:sap.m.LabelDesign.Bold}).setTooltip(this.oBundle.getText("inputMode"))}),new sap.m.Column({width:"20%"})]}).data("hrf-id","columnsTable",true);var _=this.getModel();this.conditionsTable.setModel(_);this.conditionsTable.bindItems({path:"/DecisionTable/DecisionTableColumns/results",factory:this._tableColumnsFactory.bind(this)});this.conditionsTable.setBusyIndicatorDelay(0);return this.conditionsTable;};sap.rules.ui.DecisionTableSettings.prototype._ruleResultColumns=function(){var f=this.getModel().oData.DecisionTable.DecisionTableColumns.results;function i(g){return g.Result!=null;}return f.filter(i);};sap.rules.ui.DecisionTableSettings.prototype._getResultsUpdates=function(r,f){var g=[],h=[],k=[];var i=0,j=0;for(i=0;i<r.length;i++){var m=false;for(j=0;j<f.length;j++){if(f[j].name===r[i].Result.DataObjectAttributeName){m=true;if((f[j].businessDataType!=r[i].Result.BusinessDataType)||(f[j].name!=r[i].Result.DataObjectAttributeName)){k.push(r[i].Result.DataObjectAttributeName);}}}if(!m){h.push(r[i].Result.DataObjectAttributeName);}m=false;}for(j=0;j<f.length;j++){var n=false;for(i=0;i<r.length;i++){if(f[j].name===r[i].Result.DataObjectAttributeName){n=true;}}if(!n){g.push(f[j].name);}n=false;}return{addedColumns:g,changedColumns:k,removedColumns:h};};sap.rules.ui.DecisionTableSettings.prototype._updateRefreshFlags=function(n,i){this.getModel().getData().needToRefresh=n;this.getModel("settingsModel").setProperty("/refreshButtonEnabled",i,null,true);};sap.rules.ui.DecisionTableSettings.prototype._getMessageByResultUpdates=function(r){var m=this.oBundle.getText("refreshingWillDeleteMsg");var f=this.oBundle.getText("refreshAreyouSureMsg");var g=r.addedColumns.length+r.changedColumns.length+r.removedColumns.length;if(g!=0){var h=function(s){return"'"+s+"'";};var i=(r.addedColumns.length==0)?"":this.oBundle.getText("columnsWereAdded",r.addedColumns.map(h).toString());var j=(r.changedColumns.length==0)?"":this.oBundle.getText("columnsWereChanged",r.changedColumns.map(h).toString());var k=(r.removedColumns.length==0)?"":this.oBundle.getText("columnsWereRemoved",r.removedColumns.map(h).toString());var n=i+j+k+((r.removedColumns.length==0)?"":m)+f;this.getModel("settingsModel").setProperty("/refreshButtonEnabled",true,null,true);return n;}else{this.getModel("settingsModel").setProperty("/refreshButtonEnabled",false,null,true);}return null;};sap.rules.ui.DecisionTableSettings.prototype._createRefreshButton=function(){var _=function(){var j=this.getModel("settingsModel").oData.results.resultsEnumration;var k=this.getModel().oData.ResultDataObjectId;var m=[];var n=false;if(k){for(var i=0;i<j.length;i++){if(j[i].id===k){m=j[i].columns;n=true;break;}}if(!n){m=null;}if(m){var o=this._ruleResultColumns();var p=this._getResultsUpdates(o,m);return this._getMessageByResultUpdates(p);}}this.getModel("settingsModel").setProperty("/refreshButtonEnabled",false,null,true);return null;}.bind(this);var f=function(){this._updateRefreshFlags(true,false);}.bind(this);var g=_();var h=function(){var i=g;M.warning(i,{title:this.oBundle.getText("refeshResultWarningTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(A){if(A===sap.m.MessageBox.Action.OK){f();}}});}.bind(this);var r=new B({layoutData:new sap.ui.layout.ResponsiveFlowLayoutData({weight:1}),icon:sap.ui.core.IconPool.getIconURI("synchronize"),width:"3rem",type:sap.m.ButtonType.Transparent,text:"",press:h,visible:true,enabled:"{settingsModel>/refreshButtonEnabled}"}).setTooltip(this.oBundle.getText("refreshBtn"));this.refreshButton=r;return r;};sap.rules.ui.DecisionTableSettings.prototype._createResultInput=function(){var i=new I({width:"90%",valueHelpOnly:true,showValueHelp:true,selectedKey:"{/ResultDataObjectId}",value:"{/ResultDataObjectName}",suggestionItems:{path:"settingsModel>/results/resultsEnumration",template:new sap.ui.core.Item({key:"{settingsModel>id}",text:"{settingsModel>name}"})},valueHelpRequest:function(o){var f=o.getSource();var _=this.getModel();var m=_.getData();var g=function(){var j=function j(k){var v=k.getParameter("value");var F=new sap.ui.model.Filter("name",sap.ui.model.FilterOperator.Contains,v);k.getSource().getBinding("items").filter([F]);};this.oSelectDialog=new sap.m.SelectDialog({title:this.oBundle.getText("chooseResultDialogTitle"),styleClass:"sapUiPopupWithPadding",rememberSelections:true,items:{path:"settingsModel>/results/resultsEnumration",template:new sap.m.StandardListItem({title:"{settingsModel>name}",description:"{settingsModel>description}"})},search:j,liveChange:j,confirm:function(k){var s=k.getParameter("selectedItem");var n=k.getParameter("selectedContexts");if(s){f.setSelectedKey(n[0].getProperty().id);if(!m.ResultDataObjectStatus){m.ResultDataObjectStatus="U";if(m.ResultDataObjectId!=s.getInfo()){this._updateRefreshFlags(false,false);}}}k.getSource().getBinding("items").filter([]);if(this.oSelectDialog&&this.oSelectDialog._oDialog){this.oSelectDialog._oDialog.destroy();this.oSelectDialog=null;}}.bind(this),cancel:function(k){if(this.oSelectDialog&&this.oSelectDialog._oDialog){this.oSelectDialog._oDialog.destroy();this.oSelectDialog=null;}this.oSelectDialog=null;}.bind(this)});this.oSelectDialog.setModel(i.getModel("settingsModel"),"settingsModel");this.oSelectDialog.open();}.bind(this);function h(){M.warning(this.oBundle.getText("changeResultWarningMsg"),{title:this.oBundle.getText("changeResultWarningTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(A){if(A===sap.m.MessageBox.Action.OK){g();}}});}if(m.ResultDataObjectStatus){g();}else if(this.getProperty("newDecisionTable")){m.ResultDataObjectStatus="C";g();}else{h.call(this);}}.bind(this)});return i;};sap.rules.ui.DecisionTableSettings.prototype._createLayout=function(){var f=new S({editable:true,layout:"ResponsiveGridLayout",maxContainerCols:1,columnsL:1,columnsM:1,labelSpanM:1,content:[new L({text:this.oBundle.getText("hitPolicy")}).setTooltip(this.oBundle.getText("hitPolicy")),new b({width:"25%",enabled:"{settingsModel>/hitPolicy/enabled}",items:{path:"settingsModel>/hitPolicy/hitPolicyEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>text}"})},selectedKey:"{/DecisionTable/HitPolicy}",change:function(o){var _=this.getModel();var m=_.getData();if(m.DecisionTable.HitPolicyStatus!="C"){m.DecisionTable.HitPolicyStatus="U";}}.bind(this)}),new L(),this._createTable(),new L({text:this.oBundle.getText("ouput")}).setTooltip(this.oBundle.getText("ouput")),new sap.ui.layout.HorizontalLayout({content:[this._createResultInput(),this._createRefreshButton()]})]});return f;};sap.rules.ui.DecisionTableSettings.prototype._getColumnInputMode=function(v){if(!v){return this.oBundle.getText("advancedMode");}return(this.oBundle.getText("valueOnly"));};sap.rules.ui.DecisionTableSettings.prototype._setExpressionRelevantOperators=function(f,g,v){var F=this._getFixedOperatorDataForExpression(f,v);this._internalModel.setProperty("/tableData/"+g,F,false);this._updateRemoveRowEnabled();};sap.rules.ui.DecisionTableSettings.prototype.setExpressionLanguage=function(o){this.setAssociation("expressionLanguage",o,true);this._decisionTableHeaderSettingFormatter.setExpressionLanguage(o);};sap.rules.ui.DecisionTableSettings.prototype._changeColumnInputMode=function(o,f){var s=f.getSource();this._openWarningDialog(s,o);};sap.rules.ui.DecisionTableSettings.prototype._changeInputMode=function(s,o,f){if(!s){o.setSelectedKey(this.oBundle.getText("valueOnly"));return;}o.setEnabled(false);this.getModel().setProperty(f.sPath+"/Condition/ValueOnly",false);this._changeColumnStatusToUpdate(f);};sap.rules.ui.DecisionTableSettings.prototype._changeColumnStatusToUpdate=function(o){var m=o.getModel();var s=o.getProperty("Status");if(!s||s!="C"){m.setProperty(o.getPath()+"/Status","U");}};sap.rules.ui.DecisionTableSettings.prototype._getInputModeEnabled=function(s,v){if(s!==sap.rules.ui.DecisionTableCellFormat.Both||v===false){return false;}return true;};sap.rules.ui.DecisionTableSettings.prototype._getExpressionAdvanceColumn=function(o){var f=sap.ui.getCore().byId(this.getExpressionLanguage());return new E({expressionLanguage:f,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,type:sap.rules.ui.ExpressionType.NonComparison,value:{path:"Condition/Expression",events:{change:function(g){var s=g.getSource();var h=s.getContext();var i=h.getProperty("Id");var v=h.getProperty("Condition/ValueOnly");this._setExpressionRelevantOperators(s.getValue(),i,v);}.bind(this)}},enabled:true,change:function(g){var s=g.getSource();var h=s.getBindingContext();var i=h.getProperty("Id");var m=h.getModel();var v=h.getProperty("Condition/ValueOnly");this._setExpressionRelevantOperators(s.getValue(),i,v);this._changeColumnStatusToUpdate(h);var j=h.getProperty("Condition/Expression");if(!j){m.setProperty(h.getPath()+"/Condition/FixedOperator","");}}.bind(this)});};sap.rules.ui.DecisionTableSettings.prototype._removeColumnFromJsonModel=function(s,f){var g=this.getModel();var m=g.getData();var h=m.DecisionTable.DecisionTableColumns.results;if(!f||f!="C"){if(!m.DecisionTable.DecisionTableColumns.deleted){m.DecisionTable.DecisionTableColumns.deleted=[];}m.DecisionTable.DecisionTableColumns.deleted.push(h[s-1]);}h.splice(s-1,1);for(var i=s-1;i<h.length;i++){h[i].Sequence--;if(h[i].Status&&h[i].Status==="C"){continue;}h[i].Status="U";}g.setData(m);};sap.rules.ui.DecisionTableSettings.prototype._getCellFormat=function(){var s=this.getProperty("cellFormat");return(s!==sap.rules.ui.DecisionTableCellFormat.Text)?true:false;};sap.rules.ui.DecisionTableSettings.prototype._addColumnToJsonModel=function(s){var f=this.getModel();var m=f.getData();var g=f.oData.DecisionTable.DecisionTableColumns.results;var o={Condition:{Expression:"",FixedOperator:"",Id:this.mNextColumnId,RuleId:m.Id,ValueOnly:this._getCellFormat(),Version:m.Version},Id:this.mNextColumnId,RuleId:m.Id,Sequence:s+1,Type:sap.rules.ui.DecisionTableColumn.Condition,Version:m.Version,Status:"C"};this.mNextColumnId++;g.splice(s,0,o);for(var i=s+1;i<g.length;i++){g[i].Sequence=i+1;if(g[i].Status&&g[i].Status==="C"){continue;}g[i].Status="U";}f.setData(m);};sap.rules.ui.DecisionTableSettings.prototype._tableColumnsFactory=function(i,o){var f=o.getProperty("Id");var s=o.getProperty("Sequence");var g=o.getProperty("Status");var t=o.getProperty("Type");return new sap.m.ColumnListItem({visible:t===sap.rules.ui.DecisionTableColumn.Condition,cells:[this._getExpressionAdvanceColumn(o),new sap.m.Select({width:"100%",items:{path:"settingsModel>/tableData/"+f+"/fixOperatorEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>value}"})},selectedKey:"{Condition/FixedOperator}",enabled:"{settingsModel>/tableData/"+f+"/fixOperatorEnabled}",change:function(h){this._changeColumnStatusToUpdate(o);}.bind(this)}),new sap.m.Select({width:"100%",items:{path:"settingsModel>/cellFormat/cellFormatEnumration",template:new sap.ui.core.Item({key:"{settingsModel>key}",text:"{settingsModel>value}"})},selectedKey:{parts:[{path:"Condition/ValueOnly"}],formatter:this._getColumnInputMode.bind(this)},enabled:{parts:[{path:"settingsModel>/cellFormat/CellFormat"},{path:"Condition/ValueOnly"}],formatter:this._getInputModeEnabled},change:function(h){this._changeColumnInputMode(o,h);}.bind(this)}),new sap.ui.layout.HorizontalLayout({content:[new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("sys-cancel"),visible:"{settingsModel>/removeRowEnabled}",press:function(h){this._internalModel.setProperty("/tableData",{},true);this._removeColumnFromJsonModel(s,g);}.bind(this)}).setTooltip(this.oBundle.getText("removeColumn")),new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:sap.ui.core.IconPool.getIconURI("add"),press:function(h){this._addColumnToJsonModel(s);}.bind(this)}).setTooltip(this.oBundle.getText("addColumn"))],height:"1em"})]});};sap.rules.ui.DecisionTableSettings.prototype._openWarningDialog=function(s,o){var f=new sap.m.Dialog({title:this.oBundle.getText("changeInputModeDialogTitle"),width:"70%",type:'Message',state:'Warning',content:new c({text:this.oBundle.getText("changeInputModeDialogDescription")}),beginButton:new B({text:this.oBundle.getText("okBtn"),press:function(){f.close();f.destroy();this._changeInputMode(true,s,o);}.bind(this)}),endButton:new B({text:this.oBundle.getText("cancelBtn"),press:function(){f.close();f.destroy();this._changeInputMode(false,s,o);}.bind(this)}),afterClose:function(){f.close();f.destroy();}});f.open();};sap.rules.ui.DecisionTableSettings.prototype._getBindModelName=function(){var p="";var m=this.getModelName();if(m){p=m+">";}return p;};sap.rules.ui.DecisionTableSettings.prototype._getResultsData=function(){var o=sap.ui.getCore().byId(this.getExpressionLanguage());var r=[{id:"NO_RESULT",name:""}];r=r.concat(o.getResults());var R={resultsEnumration:r};return R;};sap.rules.ui.DecisionTableSettings.prototype._initSettingsModel=function(){var i={};i.hitPolicy=this._getHitPoliciesData();i.tableData={};i.removeRowEnabled=false;i.cellFormat=this._getCellFormatData();i.results=this._getResultsData();this._internalModel=new sap.ui.model.json.JSONModel(i);this.setModel(this._internalModel,"settingsModel");};sap.rules.ui.DecisionTableSettings.prototype._calcNextColumnId=function(){var f=this.getModel();var m=f.getData();var g=m.DecisionTable.DecisionTableColumns.results;var h=0;for(var i=0;i<g.length;i++){if(g[i].Id>h){h=g[i].Id;}}var n=h+1;return n;};sap.rules.ui.DecisionTableSettings.prototype._getHitPoliciesData=function(){var h=this.getProperty("hitPolicies");var f=h.length;var H={hitPolicyEnumration:[]};for(var i=0;i<f;i++){H.hitPolicyEnumration.push({key:h[i],text:this.oBundle.getText(h[i])});}H.enabled=f>1?true:false;return H;};sap.rules.ui.DecisionTableSettings.prototype._getCellFormatData=function(){var s=this.getProperty("cellFormat");var o={CellFormat:s,cellFormatEnumration:[{key:this.oBundle.getText("advancedMode"),value:this.oBundle.getText("advancedMode")},{key:this.oBundle.getText("valueOnly"),value:this.oBundle.getText("valueOnly")}]};return o;};sap.rules.ui.DecisionTableSettings.prototype._getFixedOperatorDataForExpression=function(s,v){var f=s?true:false;var g={fixOperatorEnumration:[{key:"",value:"None"}],fixOperatorEnabled:f};if(f){var o=[];var h=sap.ui.getCore().byId(this.getExpressionLanguage());var F;if(!v){F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonExistOp}];}else{F=[{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonOp},{tokenType:sap.rules.ui.ExpressionTokenType.reservedWord,tokenCategory:sap.rules.ui.ExpressionCategory.comparisonBetweenOp}];}o=h.getSuggestionsByCategories(s,F);for(var i=0;i<o.length;i++){g.fixOperatorEnumration.push({key:o[i].text,value:o[i].text});}}return g;};sap.rules.ui.DecisionTableSettings.prototype._updateRemoveRowEnabled=function(){var f=this.conditionsTable.getAggregation("items");var v=0;for(var i=0;i<f.length;i++){if(f[i].getVisible()===true){v++;}}var g=v>1;this._internalModel.setProperty("/removeRowEnabled",g,null,true);};sap.rules.ui.DecisionTableSettings.prototype.getButtons=function(o){var f=[];var g=new B({text:this.oBundle.getText("cancelBtn")}).setTooltip(this.oBundle.getText("cancelBtn"));g.attachPress(function(){o.close();},this);var A=new B({text:this.oBundle.getText("applyChangesBtn")}).setTooltip(this.oBundle.getText("applyChangesBtn"));A.attachPress(function(){this.multiHeaderFlag=false;this._applySettingsModelChangesToOData(o);},this);f.push(A);f.push(g);return f;};sap.rules.ui.DecisionTableSettings.prototype._applySettingsModelChangesToOData=function(o){var _=sap.ui.getCore().byId(this.getExpressionLanguage());var n=this.mNextColumnId;var f=this.getModel();var g=this.getModel("oDataModel");var h=this.getBindingContext("dummy");var r=h.getProperty("Id");var v=h.getProperty("Version");var H=f.oData.DecisionTable.HitPolicy;var j={groupId:"changes"};var k=false;var m=function(){var P={};P.groupId=j.groupId;var i={RuleId:r,Version:v,HitPolicy:H};var Q="/DecisionTables(Version='"+v+"',RuleId='"+r+"')";g.update(Q,i,P);};var p=function(i){var P={};var R={RuleId:r,Version:v,Id:1};P.properties=R;g.createEntry("/DecisionTableRows",P);};var s=function(R){g.callFunction("/SetRuleResultDataObject",{method:"POST",groupId:j.groupId,urlParameters:{RuleId:r,ResultDataObjectId:(R!=="NO_RESULT")?R:""}});};var t=function(){g.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:j.groupId,urlParameters:{RuleId:r}});};var u=function(i){var P={};var Q=g.oData["DecisionTables(Version='"+v+"',RuleId='"+r+"')"];if(!Q){var R={RuleId:r,Version:v,HitPolicy:H};P.properties=R;g.createEntry("/DecisionTables",P);}else{m();}p();};var w=function(i,Q){var P={};var R={RuleId:i.RuleId,Version:i.Version,Id:i.Id,Type:sap.rules.ui.DecisionTableColumn.Condition,Sequence:Q};P.properties=R;g.createEntry("/DecisionTableColumns",P);P.properties=i;g.createEntry("/DecisionTableColumnConditions",P);};var x=function(i){var Q="/DecisionTableColumns(RuleId='"+r+"',Version='"+v+"',Id="+i+")";g.remove(Q,j);};var y=function(J,N){var Q="/DecisionTableColumns(RuleId='"+r+"',Version='"+v+"',Id=ID_PROPERTY)";var R="/DecisionTableColumnConditions(Version='"+v+"',RuleId='"+r+"',Id=ID_PROPERTY)";var U;for(var i=0;i<J.length;i++){U=J[i];if(U.Status){var W;var X;if(U.Condition){W=(U.Condition.parserResults.converted&&U.Condition.parserResults.converted.Expression)?U.Condition.parserResults.converted.Expression:U.Condition.Expression;X=(U.Condition.parserResults.converted&&U.Condition.parserResults.converted.FixedOperator)?U.Condition.parserResults.converted.FixedOperator:U.Condition.FixedOperator;}k=true;if(U.Status==="U"){var Y;if(!(U.Result&&N)){Y=U.Id;var Z={Sequence:U.Sequence};var $=Q.replace("ID_PROPERTY",Y);g.update($,Z,j);}if(U.Condition){var a1=R.replace("ID_PROPERTY",Y);var b1=U.Condition.ValueOnly;var c1={Id:Y,Expression:W,FixedOperator:X,ValueOnly:b1};g.update(a1,c1,j);}}else if(U.Status==="C"){var d1=U.Condition;d1.Expression=W;d1.FixedOperator=X;delete d1.parserResults;w(d1,U.Sequence);}}}};var z=function(Q){if(!Q){return;}k=true;for(var i=0;i<Q.length;i++){var R=Q[i];x(R.Id);}};var A=function(i){o.setState(sap.ui.core.ValueState.Success);o.close();};var F=function(Q){var P={};P.groupId=j.groupId;var R=f.getData();var U=R.ResultDataObjectName;var W=_.getResultInfo(U);var X=W?W.requiredParams:[];var Y=X.length;for(var i=0;i<Y;i++){var Z={RuleId:r,Version:v,Id:n,Type:sap.rules.ui.DecisionTableColumn.Result,Sequence:Q};P.properties=Z;g.createEntry("/DecisionTableColumns",P);var $={RuleId:r,Version:v,Id:n,DataObjectAttributeName:X[i].name,DataObjectAttributeId:X[i].paramId,BusinessDataType:X[i].businessDataType};n++;Q++;P.properties=$;g.createEntry("/DecisionTableColumnResults",P);}};var G=_.convertRuleToCodeValues(f.oData);var J=G.output.decisionTableData.DecisionTable.DecisionTableColumns.results;g.setDeferredGroups([j.groupId]);var K=this.getProperty("newDecisionTable");if(K){k=true;u(J.length);}else if(f.oData.DecisionTable.HitPolicyStatus==="U"){k=true;m(r,v,H,j);}var N=f.oData.ResultDataObjectStatus?true:false;if(N){k=true;s(f.oData.ResultDataObjectId);}var O=f.oData.needToRefresh;if(O){k=true;t();}y(J,N);z(f.oData.DecisionTable.DecisionTableColumns.deleted);if(K){F(J.length+1);}var P={};P.success=A;P.groupId=j.groupId;if(k){g.submitChanges(P);return;}o.close();};return D;},true);
