/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2017 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.uiext.inbox.controller.InboxControllerAsync");jQuery.sap.require("sap.uiext.inbox.controller.InboxController");jQuery.sap.require("sap.ui.model.json.JSONModel");sap.uiext.inbox.controller.InboxController.extend("sap.uiext.inbox.controller.InboxControllerAsync",{constructor:function(){if(sap.uiext.inbox.controller.InboxController.prototype.constructor){sap.uiext.inbox.controller.InboxController.prototype.constructor.apply(this,arguments);}this.oTaskDefinitionModel=new sap.ui.model.json.JSONModel();this.oTaskDefinitionModel.setData({"TaskDefinitionCollection":[]});this.oTaskDescriptionModel=new sap.ui.model.json.JSONModel();this.oTaskDescriptionModel.setData({"TaskDescriptionCollection":[]});this.oCustomAttributeDataModel=new sap.ui.model.json.JSONModel();this.oCustomAttributeDataModel.setData({"CustomAttributeDataCollection":[]});this.oUtilityModelTaskDescription;this.oUtilityModelTaskDefinition;this.oUtilityModelCustomAttributeData;this.aFetchedTaskDefinitions=[];this.aBatchedTaskDefinitions=[];this.aFetchedTaskDescriptions=[];this.aBatchedTaskDescriptions=[];this.aFetchedCustomAttributes=[];this.aBatchedCustomAttributes=[];this.oBatchTimer;this.sLoadingText;this.iBatchThreshold=50;this.iTimerThreshold=1000;},setModel:function(m){if(sap.uiext.inbox.controller.InboxController.prototype.setModel){sap.uiext.inbox.controller.InboxController.prototype.setModel.apply(this,arguments);}if(m instanceof sap.ui.model.odata.ODataModel||m instanceof sap.ui.model.odata.v2.ODataModel){this.oUtilityModelTaskDescription=new sap.ui.model.odata.ODataModel(m.sServiceUrl);this.oUtilityModelCustomAttributeData=new sap.ui.model.odata.ODataModel(m.sServiceUrl);this.oUtilityModelTaskDefinition=new sap.ui.model.odata.ODataModel(m.sServiceUrl);this.getView()._getComponent('tasksRowRepeater').setModel(this.oTaskDefinitionModel,"TaskDefinitionModel").setModel(this.oTaskDescriptionModel,"TaskDescriptionModel");this.getView()._getComponent('listViewTable').setModel(this.oTaskDefinitionModel,"TaskDefinitionModel").setModel(this.oCustomAttributeDataModel,"CustomAttributeDataModel");}},setView:function(v){if(sap.uiext.inbox.controller.InboxController.prototype.setView){sap.uiext.inbox.controller.InboxController.prototype.setView.apply(this,arguments);}this.sLoadingText=v._oBundle.getText("INBOX_LP_LOADING");},getExpandParameters:function(){return"";},addReadTaskDefinitionToBatch:function(t,T,s){if(this.aFetchedTaskDefinitions.indexOf(T+s)===-1&&this.aBatchedTaskDefinitions.indexOf(T+s)===-1){if(this.oBatchTimer===undefined){this._startBatchTimer();}var r=this._getRequestURLTaskDefinitionData(t,s);var b=this.oUtilityModelTaskDefinition.createBatchOperation(r,"GET");this.oUtilityModelTaskDefinition.addBatchReadOperations([b]);this.aBatchedTaskDefinitions.push(T+s);if(this.aBatchedTaskDefinitions.length===this.iBatchThreshold){this._submitBatchTaskDefinitions(this.oUtilityModelTaskDefinition);this.aBatchedTaskDefinitions=[];}}return"";},_getRequestURLTaskDefinitionData:function(t,s){var c=this.getView().constants;var T=c.TaskCollection;var u=c.forwardSlash+T.entityName+"("+T.properties.instanceID+"='"+t+"',"+c.sapOrigin+"='"+s+"')"+c.forwardSlash+T.navParam.taskDefinition;return u;},_submitBatchTaskDefinitions:function(m){var t=this;m.submitBatch(function(d,r){t._processTaskDefinitionsResponse(d.__batchResponses);},function(e){var a=jQuery.parseJSON(e.response.body);},true);},_processTaskDefinitionsResponse:function(t){var a,s,T,c,r,b=[],v={};function k(T,s){this.sSapOrigin=s;this.sTaskDefinitionID=T;};k.prototype.toString=function(){return this.sTaskDefinitionID+this.sSapOrigin;};for(var i=0;i<t.length;i++){a=t[i];if(a&&a.statusCode&&a.statusCode==200){r=a.data;s=r.SAP__Origin;T=r.TaskDefinitionID;c=r.Category;b[new k(T,s)]={Category:c};this.aFetchedTaskDefinitions.push(T+s);}else{this.aBatchedTaskDefinitions=[];}}this.oTaskDefinitionModel.setData({"TaskDefinitionCollection":b},true);b=[];},addReadTaskDescriptionToBatch:function(t,s){if(this.aFetchedTaskDescriptions.indexOf(t+s)===-1&&this.aBatchedTaskDescriptions.indexOf(t+s)===-1){if(this.oBatchTimer===undefined){this._startBatchTimer();}var r=this._getRequestURLTaskDescriptionData(t,s);var b=this.oUtilityModelTaskDescription.createBatchOperation(r,"GET");this.oUtilityModelTaskDescription.addBatchReadOperations([b]);this.aBatchedTaskDescriptions.push(t+s);if(this.aBatchedTaskDescriptions.length===this.iBatchThreshold){this.aBatchedTaskDescriptions=[];this._submitBatchTaskDescriptions(this.oUtilityModelTaskDescription);}}return this.sLoadingText;},_submitBatchTaskDescriptions:function(m){var t=this;m.submitBatch(function(d,r){t._processTaskDescriptionResponse(d.__batchResponses);},function(e){var a=jQuery.parseJSON(e.response.body);},true);},_processTaskDescriptionResponse:function(t){var a,s,T,d,D,r,b={},v={};function k(T,s){this.sSapOrigin=s;this.sTaskInstanceID=T;};k.prototype.toString=function(){return this.sTaskInstanceID+this.sSapOrigin;};for(var i=0;i<t.length;i++){a=t[i];if(a&&a.statusCode&&a.statusCode==200){r=a.data;s=r.SAP__Origin;T=r.InstanceID;d=r.Description;D=r.DescriptionAsHtml;b[new k(T,s)]={Description:d,DescriptionAsHtml:D};this.aFetchedTaskDescriptions.push(T+s);}else{this.aBatchedTaskDescriptions=[];}}this.oTaskDescriptionModel.setData({"TaskDescriptionCollection":b},true);},_getRequestURLTaskDescriptionData:function(t,s){var c=this.getView().constants;var T=c.TaskCollection;var u=c.forwardSlash+T.entityName+"("+T.properties.instanceID+"='"+t+"',"+c.sapOrigin+"='"+s+"')"+c.forwardSlash+T.navParam.taskDescription;return u;},addReadCustomAttributeDataToBatch:function(t,s){if(this.aFetchedCustomAttributes.indexOf(t+s)===-1&&this.aBatchedCustomAttributes.indexOf(t+s)===-1){if(this.oBatchTimer===undefined){this._startBatchTimer();}var r=this.getRequestURLCustomAttributeData(t,s);var b=this.oUtilityModelCustomAttributeData.createBatchOperation(r,"GET");this.oUtilityModelCustomAttributeData.addBatchReadOperations([b]);this.aBatchedCustomAttributes.push(t+s);if(this.aBatchedCustomAttributes.length===this.iBatchThreshold){this.aBatchedCustomAttributes=[];this._submitBatchCustomAttributeData(this.oUtilityModelCustomAttributeData);}}return this.sLoadingText;},getRequestURLCustomAttributeData:function(t,s){var c=this.getView().constants;var T=c.TaskCollection;var u=c.forwardSlash+T.entityName+"("+T.properties.instanceID+"='"+t+"',"+c.sapOrigin+"='"+s+"')"+c.forwardSlash+T.navParam.customAttrValues;return u;},_submitBatchCustomAttributeData:function(m){var t=this;m.submitBatch(function(d,r){for(var i=0;i<d.__batchResponses.length;i++){t._processCustomAttributeDataResponse(d.__batchResponses[i]);}},function(e){var a=jQuery.parseJSON(e.response.body);},true);},_processCustomAttributeDataResponse:function(c){var a,s,t,r,C={},v={};function K(t,s){this.sSapOrigin=s;this.sTaskInstanceID=t;};K.prototype.toString=function(){return this.sTaskInstanceID+this.sSapOrigin;};if(c&&c.statusCode&&c.statusCode==200){var k;for(var i=0;i<c.data.results.length;i++){a=c.data.results[i];if(i===0){k=new K(a.InstanceID,a.SAP__Origin);this.aFetchedCustomAttributes.push(a.InstanceID+a.SAP__Origin);}v[a.Name]=a.Value;}C[k]=v;}else{this.aBatchedCustomAttributes=[];}this.oCustomAttributeDataModel.setData({"CustomAttributeDataCollection":C},true);},_fireSubmitBatch:function(){if(this.aBatchedTaskDefinitions!==undefined&&this.aBatchedTaskDefinitions.length>0){this.aBatchedTaskDefinitions=[];this._submitBatchTaskDefinitions(this.oUtilityModelTaskDefinition);}if(this.aBatchedTaskDescriptions!==undefined&&this.aBatchedTaskDescriptions.length>0){this.aBatchedTaskDescriptions=[];this._submitBatchTaskDescriptions(this.oUtilityModelTaskDescription);}if(this.aBatchedCustomAttributes!==undefined&&this.aBatchedCustomAttributes.length>0){this.aBatchedCustomAttributes=[];this._submitBatchCustomAttributeData(this.oUtilityModelCustomAttributeData);}this._stopBatchTimer();},_startBatchTimer:function(){var t=this;this.oBatchTimer=window.setInterval(function(){t._fireSubmitBatch();},this.iTimerThreshold);},_stopBatchTimer:function(){window.clearInterval(this.oBatchTimer);this.oBatchTimer=undefined;},getTaskInitiatorIconParts:function(){return[{path:"InstanceID"},{path:"TaskDefinitionID"},{path:"SAP__Origin"},{path:"CreatedBy"},{path:("TaskDefinitionModel>Category")}];},getTaskInitiatorIconFormatter:function(t){return function(i,T,s,c,C){if(!c){if(i&&T&&s){var a;if(C===null){this.bindElement("TaskDefinitionModel>/TaskDefinitionCollection/"+T+s+"/");return"";}if(C!=null){this.setVisible(true);var b=C.toUpperCase();if(b===t._oBundle.getText("ALERT"))a=t.constants.iconPool.getIconURI("alert");else if(b===t._oBundle.getText("NOTIFICATION"))a=t.constants.iconPool.getIconURI("notification-2");else if(b===t._oBundle.getText("TODO"))a=t.constants.iconPool.getIconURI("activity-2");else if(b===t._oBundle.getText("TASK"))a=t.constants.iconPool.getIconURI("task");return a;}else if(this.getBindingContext()){t.oController.addReadTaskDefinitionToBatch(i,T,s);}}}else{this.setVisible(false);}};},getExpandTaskDescriptionLinkParts:function(){return[{path:"InstanceID"},{path:"SAP__Origin"},{path:("TaskDescriptionModel>Description")},{path:("TaskDescriptionModel>DescriptionAsHtml")}];},getExpandTaskDescriptionLinkFormatter:function(t){return function(i,s,d,D){if(i&&s){this.bindElement("TaskDescriptionModel>/TaskDescriptionCollection/"+i+s+"/");if(d){var I=t.oTcmMetadata._isPropertyAvailable("TaskDescription","DescriptionAsHtml");if(!I){if(d&&d!==''){if(((d).search((/(<([^>]+)>)/ig))!==-1)){return'true';}}}else{if(D&&D!==''){if((D).search((/(<([^>]+)>)/ig))!==-1){return'true';}}}}return'auto';}};},isFilterOnCustomAttributesSupported:function(){return false;},isSortOnCustomAttributesSupported:function(){return false;},getCustomAttributeColumnParts:function(n){return[{path:"InstanceID"},{path:"SAP__Origin"},{path:("CustomAttributeDataModel>"+n)}];},getCustomAttributeColumnFormatter:function(t){return function(i,s,c){if(i&&s){this.bindElement("CustomAttributeDataModel>/CustomAttributeDataCollection/"+i+s+"/");var C=this.getBindingContext();if(c!=null){return c;}else if(C){return t.oController.addReadCustomAttributeDataToBatch(i,s);}}};},getTaskDetailsParts:function(){return[{path:"InstanceID"},{path:"SAP__Origin"},{path:("TaskDescriptionModel>Description")},{path:("TaskDescriptionModel>DescriptionAsHtml")}];},getTaskDetailsFormatter:function(t){return function(i,s,d,D){if(i&&s){this.bindElement("TaskDescriptionModel>/TaskDescriptionCollection/"+i+s+"/");var c=this.getBindingContext();if(d!=null){var a=t.oTcmMetadata._isPropertyAvailable("TaskDescription","DescriptionAsHtml");var r=/(<([^>]+)>)/ig;var b;if(d){if(a&&D!==""){b=D;}else{b=d;}}if(b!==null&&b!==undefined&&b!==""){this.data('showMore',b);this.data('showLess',b.replace(r,""));return b.replace(r,"");}else{return"";}}else if(c){return t.oController.addReadTaskDescriptionToBatch(i,s);}}};}});
