/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Control","sap/ui/table/TreeTable","./SelectionMode","./InternalColumnDescriptor","./ArrayUtilities","./MatrixUtilities","./TreeItemUtilities","./Column","./Lookup","./library","./Text","./ColumnType","./InternalColumns","sap/ui/model/json/JSONModel","sap/ui/commons/TextView","sap/ui/core/IconPool","sap/ui/core/Icon","sap/ui/layout/HorizontalLayout","sap/ui/vk/CheckEye"],function(q,S,a,b,c,d,e,f,g,h,j,k,l,m,n,o,p,r,s,t){"use strict";var T=S.extend("sap.ui.vtm.Tree",{metadata:{properties:{selectionMode:{type:"sap.ui.vtm.SelectionMode",defaultValue:"Single"}},aggregations:{_treeTable:{type:"sap.ui.table.TreeTable",multiple:false,visibility:"hidden"},headerControls:{type:"sap.ui.core.Control",multiple:true}},events:{dragStart:{parameters:{dragItem:{type:"object"},dragTree:{type:"sap.ui.vtm.Tree"}},allowPreventDefault:true},dragOver:{parameters:{dragItem:{type:"object"},dragTree:{type:"sap.ui.vtm.Tree"},dragOverItem:{type:"object"},dragOverTree:{type:"sap.ui.vtm.Tree"}},allowPreventDefault:true},drop:{parameters:{dragItem:{type:"object"},dragTree:{type:"sap.ui.vtm.Tree"},dropItem:{type:"object"},dropTree:{type:"sap.ui.vtm.Tree"}}},selectionChanged:{parameters:{addedItems:{type:"object[]"},removedItems:{type:"object[]"},userInteraction:{type:"boolean"}}},visibilityHeaderIconClicked:{parameters:{visibility:{type:"boolean"},control:{type:"sap.ui.core.Control"}}},visibilityIconClicked:{parameters:{item:{type:"object"},visibility:{type:"boolean"},control:{type:"sap.ui.core.Control"}}},expandedChanged:{parameters:{item:{type:"object"},expanded:{type:"boolean"},userInteraction:{type:"boolean"}}},beforeModelUpdated:{},modelUpdated:{},messageStatusIconClicked:{parameters:{items:{type:"object"},control:{type:"sap.ui.core.Control"}}},messageStatusHeaderIconClicked:{control:{type:"sap.ui.core.Control"}},hierarchyChanged:{}}},constructor:function(i,u){S.apply(this,arguments);this._rb=sap.ui.vtm.getResourceBundle();this._treeCollections=new sap.ui.vtm.TreeCollections();var v=new sap.ui.table.TreeTable({enableColumnReordering:true,selectionMode:sap.ui.table.SelectionMode.Single,showNoData:false,visibleRowCountMode:sap.ui.table.VisibleRowCountMode.Auto,minAutoRowCount:4,selectionBehavior:sap.ui.table.SelectionBehavior.RowOnly});this.setAggregation("_treeTable",v);v.allowTextSelection(false);var w=sap.ui.vtm.InternalColumns.createTreeColumn();var x=sap.ui.vtm.InternalColumns.createVisibilityColumn();var y=sap.ui.vtm.InternalColumns.createMessageStatusColumn();var z=x.getLabelControl();z.attachChange(function(D){var E=D.getSource().getChecked();this.fireVisibilityHeaderIconClicked({visibility:E,control:z});}.bind(this));var A=y.getLabelControl();A.attachPress(function(D){this.fireMessageStatusHeaderIconClicked({control:A});}.bind(this));A.addEventDelegate({onfocusin:function(D){A.getDomRef().blur();}},A);this._fixedColumns=[w,x,y];this._setColumns(this._fixedColumns);this.setRootItems([]);this.updateCollections(false);this._updateModel();v.attachToggleOpenState(this._handleToggleOpenState.bind(this));var B=function(D,E){if(D.getVisible&&!D.getVisible()||D.getEnabled&&!D.getEnabled()){return false;}if(D.ontap){D.ontap(E);}else if(D.userToggle){D.userToggle(E);}else if(D.onclick){D.onclick(E);}return true;};var C=function(E){var D=sap.ui.table.TableUtils.getFocusedItemInfo(v);var F=this.getSelectionMode()===sap.ui.vtm.SelectionMode.MultiToggle;var G=F?D.cellInRow-1:D.cellInRow;var H=v.getColumns();var I=H[G];if(!I){return;}var J=I.data("definition");var K=J.getType();var L=J.getDescriptor();var M=D.row===0;if(M){if(K===sap.ui.vtm.ColumnType.Internal&&L===sap.ui.vtm.InternalColumnDescriptor.Visibility){var N=I.getLabel();B(N,E);}}else if(K===sap.ui.vtm.ColumnType.Internal){var O=v.getRows()[D.row-1].getCells()[G];switch(L){case sap.ui.vtm.InternalColumnDescriptor.Tree:sap.ui.table.TableUtils.toggleRowSelection(v,E.target);E.preventDefault();E.stopImmediatePropagation();break;case sap.ui.vtm.InternalColumnDescriptor.Visibility:case sap.ui.vtm.InternalColumnDescriptor.MessageStatus:B(O,E);E.preventDefault();E.stopImmediatePropagation();break;default:break;}}}.bind(this);v.attachBrowserEvent("keyup",function(E){if(E.which===q.sap.KeyCodes.SPACE){C(E);}});v.attachRowSelectionChange(function(D){var _=D.getParameter("userInteraction");var E=D.getParameter("rowIndices");var F=v.getSelectedIndices();var G=[];var H=[];E.forEach(function(J){if(F.indexOf(J)!=-1){G.push(J);}else{H.push(J);}});var I={addedItems:this._getTreeItemsFromRowIndices(G),removedItems:this._getTreeItemsFromRowIndices(H),userInteraction:_};sap.ui.vtm.measure(this,"fireSelectionChanged",function(){this.fireSelectionChanged(I);}.bind(this));if(_){this.fireEvent("vtmInternalSetTreeSelectionComplete");}}.bind(this));},renderer:function(R,C){R.write("<div");R.writeControlData(C);R.addClass("sapUiVtmTree");R.writeStyles();R.writeClasses();R.write(">");var i=C.getHeaderControls();i.forEach(function(v){if(v){R.renderControl(v);}});var u=C._getTreeTable();R.renderControl(u);R.write("</div>");},_raiseExpandedChanged:function(i){sap.ui.vtm.measure(this,"fireExpandedChanged",function(){this.fireExpandedChanged(i);}.bind(this));},_handleToggleOpenState:function(E){var i=E.getParameter("rowContext");var u=E.getParameter("expanded");var v=i.getPath();var w=this._getItemByContextPath(v);this._raiseExpandedChanged({item:w,expanded:u,userInteraction:true});},_getAncestor:function(i){var u=this.getParent();while(u&&u.getMetadata().getName()!==i){u=u.getParent();}return u;},getPanel:function(){if(!this._panel){this._panel=this._getAncestor("sap.ui.vtm.Panel");}return this._panel;},setExpanded:function(i,E){var u=this._getTreeTable();var v=function(){var w=this._getRowIndexForTreeItem(u,i);if(w!==-1){var x;if(E){if(!u.isExpanded(w)){x=true;u.expand(w);}}else if(u.isExpanded(w)){x=true;u.collapse(w);}if(x){this._raiseExpandedChanged({item:i,expanded:E,userInteraction:false});}}}.bind(this);if(E){this._expandToTreeItem(i,false,v);}else{v();}return this;},getExpanded:function(i){var u=this._getTreeTable();var v=this._getRowIndexForTreeItem(u,i);if(v!==-1){return u.isExpanded(v);}return false;},getFixedColumns:function(){var u=[];var v=this._getTreeTable();var w=v.getColumns();for(var i=0;i<this._fixedColumns.length;i++){var x=w[i];var y=x.data("definition");y.setWidth(x.getWidth());y.setHAlign(x.getHAlign());u.push(y);}return u;},setFixedColumns:function(i){if(!i){throw"fixedColumns not specified";}this._fixedColumns=i;var u=this.getDataColumns();var v=this._fixedColumns.concat(u);this._setColumns(v);return this;},getDataColumns:function(){var u=[];var v=this._getTreeTable();var w=v.getColumns();for(var i=this._fixedColumns.length;i<w.length;i++){var x=w[i];var y=x.data("definition");y.setWidth(x.getWidth());y.setHAlign(x.getHAlign());u.push(y);}return u;},setDataColumns:function(i){if(!i){throw"dataColumns not specified";}var u=this._fixedColumns.concat(i);this._setColumns(u);return this;},_setColumns:function(i){var u=this._getTreeTable();u.removeAllColumns();i.forEach(function(v){var w=this._createColumn(v);u.addColumn(w);}.bind(this));u.setFixedColumnCount(this._fixedColumns.length);},_getTreeItemsFromRowIndices:function(i){return i.map(function(u){return this._getItemByRowIndex(u);}.bind(this)).filter(function(u){return!!u;});},_getTreeTable:function(){return this.getAggregation("_treeTable");},getRootItems:function(){return this._rootItems;},setRootItems:function(i){this._rootItems=i;return this;},isEmpty:function(){return this._rootItems.length===0;},getSelectedItems:function(){var i=this._getTreeTable().getSelectedIndices();return this._getTreeItemsFromRowIndices(i);},_expandToTreeItem:function(i,u,v){var w=this._getTreeTable();var x=function(D,E,F){var G;if((E<D)||(E>=(D+F))){G=E-(F/2);}else{G=D;}G=G>0?Math.floor(G):0;return G;};var y=this.getAncestorItems(i.id,false);var z=function(D,y,E){if(E.getParameter("reason")==="expand"){D(y);}};var A=null;var B=0;var C=function(y){var D=function(){w.getBinding("rows").detachChange(A);var E=this._getRowIndexForTreeItem(w,i,B);if(E===-1){throw"Tree item with id '"+i.id+"' not found in treeTable";}if(u){var F=w.getVisibleRowCount(),G=w.getFirstVisibleRow(),H=x(G,E,F);if(H!==G){w.setFirstVisibleRow(H);}}if(v){v();}}.bind(this);setTimeout(function(){if(y.length){while(y.length){var E=y.shift();var F=this._getRowIndexForTreeItem(w,E,B);if(F===-1){throw"Tree item with id '"+E.id+"' not found in treeTable";}B=F+1;if(!w.isExpanded(F)){w.expand(F);this._raiseExpandedChanged({item:E,expanded:true,userInteraction:false});return;}else if(!y.length){D();}}}else{D();}}.bind(this),0);}.bind(this);A=z.bind(this,C,y);w.getBinding("rows").attachChange(A);C(y);},_getRowIndexForTreeItem:function(i,u,v){var w=-1;sap.ui.vtm.measure(this,"_getRowIndexForTreeItem",function(){if(!v){v=0;}var x=function(C,B){B.forEach(function(E){C=C[E];});return C;};var y=this.getAllItems();for(var z=v;z<y.length;z++){var A=i.getContextByIndex(z);if(A){var B=A.getPath().split("/");B.shift();var C=A.getModel().getData();var D=x(C,B);if(D===u){w=z;break;}}}}.bind(this));return w;},expandAncestors:function(i){sap.ui.vtm.measure(this,"expandAncestors",function(){this._expandToTreeItem(i,false,null);}.bind(this));return this;},expandAll:function(){sap.ui.vtm.measure(this,"expandAll",function(){this._getTreeTable().expandToLevel(1000*1000*1000);}.bind(this));return this;},collapseAll:function(){sap.ui.vtm.measure(this,"collapseAll",function(){this._getTreeTable().collapseAll();}.bind(this));return this;},expandToLevel:function(L){sap.ui.vtm.measure(this,"expandToLevel",function(){this._getTreeTable().expandToLevel(L);}.bind(this));return this;},scrollIntoView:function(i){sap.ui.vtm.measure(this,"scrollIntoView",function(){this._expandToTreeItem(i,true,null);}.bind(this));return this;},setSelectedItems:function(u,v){u=sap.ui.vtm.ArrayUtilities.wrap(u);if(v!==true&&v!==false){v=true;}if(this.getSelectionMode()==sap.ui.vtm.SelectionMode.Single&&u.length>1){u=u.slice(0,1);}if(!u.length){this._getTreeTable().clearSelection();this.fireEvent("vtmInternalSetTreeSelectionComplete");return this;}var w=function(C){var D=this._getTreeTable();for(var i=0;;i++){var E=this._getItemByRowIndex(i);if(!E){break;}var F=C.indexOf(E)!==-1;if(F!=D.isIndexSelected(i)){if(F){D.addSelectionInterval(i,i);}else{D.removeSelectionInterval(i,i);}}}this.fireEvent("vtmInternalSetTreeSelectionComplete");}.bind(this);var x=function(){w(u);};for(var y=0;y<u.length;y++){var z=u[y],A=y===u.length-1,B=A?x:null;this._expandToTreeItem(z,v,B);}return this;},validateTree:function(){sap.ui.vtm.measure(this,"validateTree",function(){var i=sap.ui.vtm.TreeItemUtilities.validateTree(this.getRootItems());if(i.length!==0){i.forEach(function(u){var v="Tree error in "+this.getId()+": "+u;q.sap.log.error(v,null,"sap.ui.vtm.Tree");});throw"There were errors in the "+this.getId()+" tree. See the console trace for details";}}.bind(this));return this;},updateModel:function(i){sap.ui.vtm.measure(this,"updateModel",function(){sap.ui.vtm.measure(this,"fireBeforeModelUpdated",function(){this.fireBeforeModelUpdated();}.bind(this));this._updateModel(i);sap.ui.vtm.measure(this,"fireModelUpdated",function(){this.fireModelUpdated();}.bind(this));}.bind(this));return this;},_updateModel:function(i){var u=this._getTreeTable();var v=u.getModel();if(!v||i){v=new sap.ui.model.json.JSONModel();v.setSizeLimit(1000000);u.bindRows({path:"/rootItems",key:"id",parameters:{arrayNames:["includedChildren"],numberOfExpandedLevels:1}});v.setData({rootItems:this.getRootItems()});u.setModel(v);}else{v.setData({rootItems:this.getRootItems()});this._updateBindings(true);}},_updateBindings:function(){this._getTreeTable().getModel().updateBindings(true);},updateCollections:function(i){sap.ui.vtm.measure(this,"updateCollections",function(){if(this._treeCollections.updateCollections(this.getRootItems(),i)){sap.ui.vtm.measure(this,"fireHierarchyChanged",function(){this.fireHierarchyChanged();}.bind(this));}}.bind(this));return this;},updateTreeItemsBySceneNodeId:function(){sap.ui.vtm.measure(this,"updateTreeItemsBySceneNodeId",function(){this._treeCollections.updateTreeItemsBySceneNodeId(this.getRootItems());}.bind(this));return this;},_getItemByContextPath:function(i){return this._getTreeTable().getModel().getProperty(i)||undefined;},getItem:function(i){return this._treeCollections.getItem(i);},isIncludedItem:function(i){return this._treeCollections.isIncludedItem(i);},isExcludedItem:function(i){return this._treeCollections.isExcludedItem(i);},getItemsBySceneNodeId:function(i,u){return this._treeCollections.getItemsBySceneNodeId(i,u);},getParentItem:function(i){return this._treeCollections.getParentItem(i);},getDescendantItems:function(i,u){return this._treeCollections.getDescendantItems(i,u);},getAncestorItems:function(i){return this._treeCollections.getAncestorItems(i);},getAllItems:function(i){return this._treeCollections.getAllItems(i);},_modifyDisplayState:function(i,u,v,w,x){i=sap.ui.vtm.ArrayUtilities.wrap(i);v=v==null?true:v;x=x==null?true:x;w=w==null?true:w;var y=function(z){if(!w||sap.ui.vtm.TreeItemUtilities.hasVisibility(z)){u(z);}return sap.ui.vtm.ChildCollectionType.IncludedAndExcluded;};i.forEach(function(z){if(v){sap.ui.vtm.TreeItemUtilities.traverseBranch(z,y);}else{y(z);}});if(x){this.updateModel();this.getPanel().getViewport().refresh();}},_getTreeItemData:function(i,u){if(Array.isArray(i)){return i.map(u);}else{return u(i);}},setVisibility:function(i,v,u,w,x){var y=function(z){if(v==undefined){delete z.visibility;}else{z.visibility=v;}};this._modifyDisplayState(i,y,u,w,x);return this;},getVisibility:function(i){return this._getTreeItemData(i,function(u){return u.visibility;});},setOpacity:function(i,u,v,w,x){var y=function(z){if(u==undefined){delete z.opacity;}else{z.opacity=u;}};this._modifyDisplayState(i,y,v,w,x);return this;},getOpacity:function(i){return this._getTreeItemData(i,function(u){return u.opacity;});},setHighlightColor:function(i,u,v,w,x){var y=function(z){if(u==null){delete z.highlightColor;}else{z.highlightColor=u;}};this._modifyDisplayState(i,y,v,w,x);return this;},getHighlightColor:function(i){return this._getTreeItemData(i,function(u){return u.highlightColor;});},_getItemByRowIndex:function(i){var u=this._getTreeTable();var v=u.getContextByIndex(i);var w=v?v.sPath:"";return this._getItemByContextPath(w);},onAfterRendering:function(){var i=this._getTreeTable();if(i.setFixedColumnCount()!=this._fixedColumns.length){i.setFixedColumnCount(this._fixedColumns.length);}this._addDragHandlers();this._addMutationObserver();},setSelectionMode:function(v){if(v===this.getSelectionMode()){return this;}var i=this._getTreeTable();i.clearSelection();var u;var w;switch(v){case sap.ui.vtm.SelectionMode.Single:u=sap.ui.table.SelectionMode.Single;w=sap.ui.table.SelectionBehavior.RowOnly;break;case sap.ui.vtm.SelectionMode.MultiToggle:u=sap.ui.table.SelectionMode.MultiToggle;w=sap.ui.table.SelectionBehavior.Row;break;default:throw"Unknown selection mode: '"+v+"'";}i.setSelectionBehavior(w);i.setSelectionMode(u);this.setProperty("selectionMode",v);return this;},_addMutationObserver:function(){var i=false;var u=new MutationObserver(function(w){if(i){return;}i=true;var x=false;w.forEach(function(y){if(x){return;}if(y.type==="childList"){this._addDragHandlers();x=true;}}.bind(this));i=false;}.bind(this));var v={subtree:true,childList:true};q("#"+this.getId()).each(function(w,x){u.observe(x,v);});},_getRowIndexForTableRow:function(i){var u=q(i).attr("data-sap-ui-rowindex");var R=this._getTreeTable().getFirstVisibleRow()+parseInt(u,10);return R;},_addDragHandlers:function(){var i=this.getId();var u="#"+i+" tr.sapUiTableTr";if(q(u).attr("draggable")){return;}var v=this.getPanel().getVtm();var w=function(A){A.dataTransfer.setData("text","");var B=A.currentTarget;var C=this._getRowIndexForTableRow(B);var D=this._getItemByRowIndex(C);if(!D){A.preventDefault();return;}var E=this.getSelectedItems();if(E&&E.length&&E.indexOf(D)<0){A.preventDefault();return;}v._dragStartParameters={dragItem:D,dragTree:this};var F;sap.ui.vtm.measure(this,"fireDragStart",function(){F=this.fireDragStart(v._dragStartParameters);}.bind(this));if(!F){A.preventDefault();}}.bind(this);var x=function(A){var B=v._dragStartParameters;if(!B){return;}var C=A.currentTarget;var D=this._getRowIndexForTableRow(C);var E={dragItem:B.dragItem,dragTree:B.dragTree,dragOverItem:this._getItemByRowIndex(D),dragOverTree:this};var F;sap.ui.vtm.measure(this,"fireDragOver",function(){F=this.fireDragOver(E);}.bind(this));if(!F){A.preventDefault();}}.bind(this);var y=function(A){var B=v._dragStartParameters;if(!B){return;}var C=A.currentTarget;var D=this._getRowIndexForTableRow(C);var E={dragItem:B.dragItem,dragTree:B.dragTree,dropItem:this._getItemByRowIndex(D),dropTree:this};v._dragStartParameters=null;sap.ui.vtm.measure(this,"fireDrop",function(){this.fireDrop(E);}.bind(this));}.bind(this);var z=function(A){A.addEventListener("dragstart",w,false);A.addEventListener("dragover",x,false);A.addEventListener("drop",y,false);};q(u).each(function(){var A=q(this);A.attr("draggable","true");A.attr("droppable","true");z(this);});},_createColumn:function(i){var u=i.getTemplate()||this._createColumnTemplate(i);var v=i.getLabel();var w=i.getLabelControl();var x={label:w?w:v,tooltip:i.getTooltip()||v,hAlign:i.getHAlign()||sap.ui.core.HorizontalAlign.Left,width:i.getWidth()||"auto",resizable:i.getResizable(),template:u};var y=new sap.ui.table.Column(x);y.setTemplate(u);y.data("definition",i);return y;},traverseBranch:function(i,u){var v=this.getAncestorItems(i);sap.ui.vtm.TreeItemUtilities.traverseBranch(i,u,v);return this;},traverseTree:function(i){this.getRootItems().forEach(function(u){this.traverseBranch(u,i,[]);}.bind(this));return this;},removeRoot:function(i){return sap.ui.vtm.TreeItemUtilities.removeRoot(this._rootItems,i);},addRoot:function(i){sap.ui.vtm.TreeItemUtilities.addRoot(this._rootItems,i);return this;},_createColumnTemplate:function(i){var C=sap.ui.vtm.ColumnTemplates;var u=i.getType();if(!u){throw"Column type not specified";}switch(u){case sap.ui.vtm.ColumnType.Internal:{var v=i.getDescriptor();switch(v){case sap.ui.vtm.InternalColumnDescriptor.TreeItemId:return C.createTreeItemIdColumnTemplate();case sap.ui.vtm.InternalColumnDescriptor.Tree:return C.createTreeColumnTemplate();case sap.ui.vtm.InternalColumnDescriptor.MessageStatus:var w=C.createMessageStatusColumnTemplate();w.attachPress(function(E){var z=E.getSource();var A=z.getBindingContext();var P=A.getPath();var B=this._getItemByContextPath(P);this.fireMessageStatusIconClicked({item:B,control:z});}.bind(this));w.addEventDelegate({onfocusin:function(z){var A=sap.ui.getCore();var B=A.getCurrentFocusedControlId();var D=A.byId(B);if(D){var E=D.getDomRef();if(E){E.blur();}}}},w);return w;case sap.ui.vtm.InternalColumnDescriptor.AbsoluteMatrix:return C.createAbsoluteMatrixColumnTemplate();case sap.ui.vtm.InternalColumnDescriptor.RelativeMatrix:return C.createRelativeMatrixColumnTemplate();case sap.ui.vtm.InternalColumnDescriptor.SceneNodeIds:return C.createSceneNodeIdsColumnTemplate();case sap.ui.vtm.InternalColumnDescriptor.Visibility:var x=C.createVisibilityColumnTemplate();var y=function(z,A){var P=z.getBindingContext().getPath();var B=this._getItemByContextPath(P);if(B){sap.ui.vtm.measure(this,"fireVisibilityIconClicked",function(){this.fireVisibilityIconClicked({item:B,visibility:A,control:z});}.bind(this));}}.bind(this);x.attachChange(function(z){var A=z.getSource();y(A,A.getChecked());});x.attachBrowserEvent("click",function(z){if(z&&z.target){var A=q(document.getElementById(z.target.id)).control();var B=sap.ui.vtm.ArrayUtilities.unwrap(A);if(B){y(B,!B.getChecked());z.stopPropagation();z.preventDefault();}}});return x;case sap.ui.vtm.InternalColumnDescriptor.Opacity:return C.createOpacityColumnTemplate();case sap.ui.vtm.InternalColumnDescriptor.HighlightColor:return C.createHighlightColorColumnTemplate();default:throw"Unknown internal column type: "+v;}break;}case sap.ui.vtm.ColumnType.Metadata:return C.createMetadataColumnTemplate(i);case sap.ui.vtm.ColumnType.Identifier:return C.createIdentifierColumnTemplate(i);case sap.ui.vtm.ColumnType.AppData:return C.createAppDataColumnTemplate(i);default:throw"Invalid column type: "+u;}}});return T;});
