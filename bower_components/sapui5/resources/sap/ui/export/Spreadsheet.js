/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2017 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./library','./ExportDialog'],function(q,l,E){'use strict';var S=function(s){this.mSettings=q.extend(true,{},s);};S.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null;}};S.prototype.onprogress=function(P){q.sap.log.debug("Spreadsheet export: "+P+"% loaded.");};var p=(function(){var r={};for(var k in l.EdmType){r[k.toLowerCase()]=k;}return r;})();function v(P){var a="Spreadsheet export: ";var o="odata";var e=".xlsx";P.fileName=P.fileName||'export';if(!q.sap.endsWith(P.fileName,e)){P.fileName+=e;}var d=P.dataSource;if(typeof d==="string"){var c=P.count||1;P.dataSource={dataUrl:d,type:o,count:c};P.count=c;}else if(Array.isArray(d)){var D=d.map(function(r){return q.extend(true,{},r);});P.dataSource={data:D,type:"array"};}else if(d&&d.dataUrl){var s=(d.type||o).toLowerCase();P.dataSource.type=s;if(d.useBatch){}}var b=P&&P.workbook;b.columns.forEach(function(f){f.label=f.label||f.property||"";var w=f.width;if(typeof w==="string"){var W=w.toLowerCase();w=parseFloat(W);if(W.indexOf("em")>0){w=w*2;}else if(W.indexOf("px")>0){w=w/8;}}if(isNaN(w)||w<1){w=10;}if(f.label.length<30){w=Math.max(f.label.length,w);}f.width=Math.round(w);if(f.type){f.type=f.type.toLowerCase();if(!p[f.type]){q.sap.log.error(a+"insupported property type "+f.type+". Type string is used.");f.align="";}}var g=f.scale;if(f.type==="number"&&isNaN(g)&&g!=="variable"){q.sap.log.warning(a+"scale parameter for numerical column configuration is missing.");}if(typeof g==="string"){g=parseInt(g,10);}if(isNaN(g)){g=null;}f.scale=g;var t=(f.textAlign+"").toLowerCase();if(t!==""&&["left","right","center","begin","end"].indexOf(t)==-1){q.sap.log.warning(a+"incorrect column alignment property: "+t+". Default alignment is used.");t="";}f.textAlign=t;});}S.prototype.build=function(){var s=this;var P=q.extend(true,{},this.mSettings);v(P);return new Promise(function(r,R){var a;function o(m){if(!isNaN(m.progress)){if(a){a.updateStatus(m.progress);}s.onprogress(m.progress);}if(m.error||m.finish){s.process=null;if(a){a.finish();}if(m.error){R(m.error);}else if(m.finish){r();}}}if(s.process){R("Cannot start export: the process is already running");return;}if(P.showProgress!==false){a=E.getProgressDialog();a.oncancel=function(){return s.process&&s.process.cancel();};a.open();}s.process=sap.ui.requireSync("sap/ui/export/SpreadsheetExport").execute(P,o);});};return S;},true);
