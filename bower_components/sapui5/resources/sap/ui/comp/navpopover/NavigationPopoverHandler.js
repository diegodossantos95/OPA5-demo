/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library',"sap/ui/base/ManagedObject",'./SemanticObjectController','sap/ui/model/json/JSONModel','sap/ui/core/Control','./Factory','./NavigationPopover','./Util','sap/m/VBox','./LinkData','sap/m/MessageBox','sap/ui/comp/personalization/Controller','sap/ui/comp/personalization/Util','./FlexHandler','./NavigationContainer'],function(q,C,M,S,J,a,F,N,U,V,L,b,c,P,d,e){"use strict";var f=M.extend("sap.ui.comp.navpopover.NavigationPopoverHandler",{metadata:{library:"sap.ui.comp",properties:{semanticObject:{type:"string",defaultValue:null},additionalSemanticObjects:{type:"string[]",defaultValue:[]},semanticObjectController:{type:"any",defaultValue:null},fieldName:{type:"string",defaultValue:null},semanticObjectLabel:{type:"string",defaultValue:null},mapFieldToSemanticObject:{type:"boolean",defaultValue:true},semanticAttributes:{type:"object",visibility:"hidden",defaultValue:null},contactAnnotationPath:{type:"string",defaultValue:undefined},enableAvailableActionsPersonalization:{type:"boolean",defaultValue:true}},associations:{control:{type:"sap.ui.core.Control",multiple:false}},events:{beforePopoverOpens:{parameters:{semanticObject:{type:"string"},semanticAttributes:{type:"object"},semanticAttributesOfSemanticObjects:{type:"object"},setSemanticAttributes:{type:"function"},setAppStateKey:{type:"function"},originalId:{type:"string"},open:{type:"function"}}},navigationTargetsObtained:{parameters:{mainNavigation:{type:"sap.ui.comp.navpopover.LinkData"},actions:{type:"sap.ui.comp.navpopover.LinkData[]"},ownNavigation:{type:"sap.ui.comp.navpopover.LinkData"},popoverForms:{type:"sap.ui.layout.form.SimpleForm[]"},semanticObject:{type:"string"},semanticAttributes:{type:"object"},originalId:{type:"string"},show:{type:"function"}}},innerNavigate:{parameters:{text:{type:"string"},href:{type:"string"},semanticObject:{type:"string"},semanticAttributes:{type:"object"},originalId:{type:"string"}}}}}});f.prototype.init=function(){this._oPopover=null;var m=new J({semanticObject:undefined,semanticAttributes:undefined,appStateKey:undefined,mainNavigationId:undefined,contact:{exists:false,bindingPath:undefined,expand:undefined,select:undefined},navigationTarget:{mainNavigation:undefined,enableAvailableActionsPersonalization:undefined,availableActionsPersonalizationText:undefined,extraContent:undefined},availableActions:[]});m.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);m.setSizeLimit(1000);this.setModel(m,"$sapuicompNavigationPopoverHandler");};f.prototype.applySettings=function(s){M.prototype.applySettings.apply(this,arguments);this.setSemanticAttributes(this._calculateSemanticAttributes(null));};f.prototype.openPopover=function(D){var t=this;return this._getPopover().then(function(p){if(!p.hasContent()){t._showErrorDialog(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_DETAILS_NAV_NOT_POSSIBLE"),sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_MSG_NAV_NOT_POSSIBLE"),p);t._destroyPopover();return;}var l=p.getDirectLink();if(l){t._fireInnerNavigate({text:l.getText(),href:l.getHref()});window.location.href=l.getHref();t._destroyPopover();return;}p.show(D);});};f.prototype.getSemanticObjectValue=function(){var s=this.getSemanticAttributes();if(s){return s[this.getSemanticObject()][this.getSemanticObject()];}return undefined;};f.prototype.getNavigationPopoverStableId=function(){var A=this._getAppComponent();var s=this.getModel("$sapuicompNavigationPopoverHandler").getProperty("/semanticObject");if(!A||!s){return undefined;}var g=[s].concat(this.getAdditionalSemanticObjects());U.sortArrayAlphabetical(g);var h=g.join("--");return A.createId("sapuicompnavpopoverNavigationPopover---"+h);};f.prototype.updateBindingContext=function(){a.prototype.updateBindingContext.apply(this,arguments);this.setSemanticAttributes(this._calculateSemanticAttributes(null));this._destroyPopover();};f.prototype.setSemanticObject=function(s){this._destroyPopover();this.setProperty("semanticObject",s);this.getModel("$sapuicompNavigationPopoverHandler").setProperty("/semanticObject",s);this.setSemanticAttributes(this._calculateSemanticAttributes(null));return this;};f.prototype.setSemanticAttributes=function(s){this.setProperty("semanticAttributes",s);this.getModel("$sapuicompNavigationPopoverHandler").setProperty("/semanticAttributes",s);return this;};f.prototype.setEnableAvailableActionsPersonalization=function(E){this.setProperty("enableAvailableActionsPersonalization",E);this.getModel("$sapuicompNavigationPopoverHandler").setProperty("/navigationTarget/enableAvailableActionsPersonalization",E);return this;};f.prototype.setFieldName=function(s){this.setProperty("fieldName",s);this.setSemanticAttributes(this._calculateSemanticAttributes(null));return this;};f.prototype.setControl=function(o){this.setAssociation("control",o);this.setModel(o.getModel());this._destroyPopover();this._updateSemanticObjectController();this.setSemanticAttributes(this._calculateSemanticAttributes(null));return this;};f.prototype.setMapFieldToSemanticObject=function(m){this.setProperty("mapFieldToSemanticObject",m);this.setSemanticAttributes(this._calculateSemanticAttributes(null));return this;};f.prototype.setSemanticObjectController=function(s){this._updateSemanticObjectController(s);this.setSemanticAttributes(this._calculateSemanticAttributes(null));return this;};f.prototype.exit=function(){this._destroyPopover();if(this.getSemanticObjectController()){this.getSemanticObjectController().unregisterControl(this);}if(this.getModel("$sapuicompNavigationPopoverHandler")){this.getModel("$sapuicompNavigationPopoverHandler").destroy();}};f.prototype._initModel=function(){var t=this;var s;var g=this.getSemanticObject();var A=this.getAdditionalSemanticObjects();var h=this.getContactAnnotationPath();if(h===undefined&&this.getSemanticObjectController()&&this.getSemanticObjectController().getContactAnnotationPaths()&&this.getSemanticObjectController().getContactAnnotationPaths()[this.getFieldName()]!==undefined){h=this.getSemanticObjectController().getContactAnnotationPaths()[this.getFieldName()];}var o=sap.ui.getCore().byId(this.getControl());var B=o&&o.getBindingContext()?o.getBindingContext().getPath():null;var O=this.getModel();var i=this._getComponent();var I=o&&o.getId();var m,j;var k;return U.retrieveSemanticObjectMapping(this.getFieldName(),O,B).then(function(l){t.setSemanticAttributes(t._calculateSemanticAttributes(l));s=t.getSemanticAttributes();return t._fireBeforePopoverOpens(s,g,I);}).then(function(r){s=r.semanticAttributes;t.setSemanticAttributes(s);j=t.getSemanticObjectValue();m=(o&&o._getTextOfDom&&o._getTextOfDom())||t.getSemanticObjectValue();t.getModel("$sapuicompNavigationPopoverHandler").setProperty("/appStateKey",r.appStateKey);return t._prepareFormsAndTargets(g,A,r.appStateKey,i,s,m,O,B,h,j);}).then(function(r){k=r[0];return t._fireNavigationTargetsObtained(m,g,s,I,k.forms,r[1]);}).then(function(r){var l=t.getModel("$sapuicompNavigationPopoverHandler");l.setProperty("/mainNavigationId",r.mainNavigationId);l.setProperty("/navigationTarget/mainNavigation",r.mainNavigation);l.setProperty("/navigationTarget/extraContent",r.extraContent);l.setProperty("/contact/exists",!!k.forms.length);l.setProperty("/contact/bindingPath",k.bindingPath);l.setProperty("/contact/expand",k.expand);l.setProperty("/contact/select",k.select);l.setProperty("/availableActions",t._updateVisibilityOfAvailableActions(L.convert2Json(r.availableActions)));l.setProperty("/navigationTarget/enableAvailableActionsPersonalization",t._isAvailableActionsPersonalizationTextEnabled(l.getProperty("/availableActions")));});};f.prototype._initPopover=function(){var t=this;return this._initModel().then(function(){var m=t.getModel("$sapuicompNavigationPopoverHandler");var p=t._createPopover();p.setModel(m,"$sapuicompNavigationPopoverHandler");var o=sap.ui.getCore().byId(t.getControl());if(o){o.addDependent(p);}p.getContent()[0]._updateAvailableActionsPersonalizationText();t._requestBindingContextForContact(p,m.getProperty("/contact/exists"));return p;});};f.prototype._initNavigationContainer=function(){var t=this;return this._initModel().then(function(){var m=t.getModel("$sapuicompNavigationPopoverHandler");var n=t._createNavigationContainer();n.setModel(m,"$sapuicompNavigationPopoverHandler");var o=sap.ui.getCore().byId(t.getControl());if(o){o.addDependent(n);}n._updateAvailableActionsPersonalizationText();t._requestBindingContextForContact(n,m.getProperty("/contact/exists"));return n;});};f.prototype._requestBindingContextForContact=function(n,i){if(!i){return;}var m=this.getModel("$sapuicompNavigationPopoverHandler");var o=sap.ui.getCore().byId(this.getControl());var B=o&&o.getBindingContext()?o.getBindingContext().getPath():null;if(m.getProperty("/contact/bindingPath")){n.bindContext({path:m.getProperty("/contact/bindingPath"),events:{change:function(){n.invalidate();}}});}else if(B){n.bindContext({path:B,parameters:{expand:m.getProperty("/contact/expand"),select:m.getProperty("/contact/select")},events:{change:function(){n.invalidate();}}});}};f.prototype._getPopover=function(){if(!this._oPopover){return this._initPopover();}else{return Promise.resolve(this._oPopover);}};f.prototype._getNavigationContainer=function(){return this._initNavigationContainer().then(function(n){return n;});};f.prototype._destroyPopover=function(){if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}};f.prototype._createPopover=function(){if(this._oPopover){return this._oPopover;}var n=this._createNavigationContainer();n.attachAvailableActionsPersonalizationPress(this._onAvailableActionsPersonalizationPress,this);this._oPopover=new N({customData:new sap.ui.core.CustomData({key:"useExternalContent"}),content:[n],semanticObjectName:"{$sapuicompNavigationPopoverHandler>/semanticObject}",semanticAttributes:"{$sapuicompNavigationPopoverHandler>/semanticAttributes}",appStateKey:"{$sapuicompNavigationPopoverHandler>/appStateKey}",source:this.getControl(),afterClose:this._destroyPopover.bind(this)});return this._oPopover;};f.prototype._createNavigationContainer=function(){if(!!sap.ui.getCore().byId(this.getNavigationPopoverStableId())){q.sap.log.error("Duplicate ID '"+this.getNavigationPopoverStableId()+"'. The instance of NavigationContainer should be destroyed first in order to avoid duplicate creation of NavigationContainer with stable ID.");throw"Duplicate ID";}var m=this.getModel("$sapuicompNavigationPopoverHandler");var n=new e(this.getNavigationPopoverStableId(),{mainNavigationId:"{$sapuicompNavigationPopoverHandler>/mainNavigationId}",mainNavigation:m.getProperty("/navigationTarget/mainNavigation"),availableActions:{path:'$sapuicompNavigationPopoverHandler>/availableActions',templateShareable:false,template:new L({key:"{$sapuicompNavigationPopoverHandler>key}",href:"{$sapuicompNavigationPopoverHandler>href}",text:"{$sapuicompNavigationPopoverHandler>text}",target:"{$sapuicompNavigationPopoverHandler>target}",description:"{$sapuicompNavigationPopoverHandler>description}",visible:"{$sapuicompNavigationPopoverHandler>visible}"})},extraContent:m.getProperty("/navigationTarget/extraContent")?m.getProperty("/navigationTarget/extraContent").getId():undefined,component:this._getComponent(),enableAvailableActionsPersonalization:"{$sapuicompNavigationPopoverHandler>/navigationTarget/enableAvailableActionsPersonalization}",availableActionsPersonalizationText:"{$sapuicompNavigationPopoverHandler>/navigationTarget/availableActionsPersonalizationText}",navigate:this._onNavigate.bind(this)});n._getFlexHandler().setInitialSnapshot(d.convertArrayToSnapshot("key",m.getProperty("/availableActions")));return n;};f.prototype._prepareFormsAndTargets=function(s,A,g,o,h,m,O,B,i,j){var p=U.retrieveContactAnnotationData(O,B,i).then(function(l){var n=U.parseContactAnnotation(l);return{bindingPath:l.entitySet?"/"+l.entitySet+"('"+j+"')":undefined,expand:n.expand,select:n.select,forms:U.createContactDetailForms(n.groups)};});var k=U.retrieveNavigationTargets(s,A,g,o,h,m);return Promise.all([p,k]);};f.prototype._fireBeforePopoverOpens=function(s,g,i){var t=this;return new Promise(function(r){var R={semanticAttributes:s,appStateKey:undefined};if(!t.hasListeners("beforePopoverOpens")){return r(R);}t.fireBeforePopoverOpens({originalId:i,semanticObject:g,semanticAttributes:s?s[g]:s,semanticAttributesOfSemanticObjects:s,setSemanticAttributes:function(h,j){j=j||g;R.semanticAttributes=R.semanticAttributes||{};R.semanticAttributes[j]=h;},setAppStateKey:function(A){R.appStateKey=A;},open:function(){return r(R);}});});};f.prototype._fireNavigationTargetsObtained=function(m,s,o,i,g,n){var t=this;return new Promise(function(r){var R={mainNavigationId:m,mainNavigation:n.mainNavigation,availableActions:n.availableActions,ownNavigation:n.ownNavigation,extraContent:g.length?new V({items:g}):undefined};if(!t.hasListeners("navigationTargetsObtained")){return r(R);}t.fireNavigationTargetsObtained({mainNavigation:n.mainNavigation,actions:n.availableActions,ownNavigation:n.ownNavigation,popoverForms:g,semanticObject:s,semanticAttributes:o?o[s]:o,originalId:i,show:function(m,h,A,j){if(arguments.length>0&&!(typeof m==="string"||h instanceof sap.ui.comp.navpopover.LinkData||q.isArray(A))&&j===undefined){j=A;A=h;h=m;m=undefined;}if(m!==undefined&&m!==null){R.mainNavigationId=m;}if(h!==undefined){R.mainNavigation=h;}if(A){A.forEach(function(k){if(k.getKey()===undefined){q.sap.log.error("'key' attribute of 'availableAction' '"+k.getText()+"' is undefined. Links without 'key' can not be persisted.");q.sap.log.warning("The 'visible' attribute of 'availableAction' '"+k.getText()+"' is set to 'true'");k.setVisible(true);}});R.availableActions=A;}if(j){R.extraContent=j;}return r(R);}});});};f.prototype._onNavigate=function(E){var p=E.getParameters();this._fireInnerNavigate({text:p.text,href:p.href});};f.prototype._onAvailableActionsPersonalizationPress=function(E){var t=this;var n=E.getSource();this._oPopover.setModal(true);n.openSelectionDialog(false,true,undefined,true).then(function(){if(t._oPopover){t._oPopover.setModal(false);}});};f.prototype._fireInnerNavigate=function(p){var o=sap.ui.getCore().byId(this.getControl());var s=this.getSemanticObject();var g=this.getSemanticAttributes();this.fireInnerNavigate({text:p.text,href:p.href,originalId:o?o.getId():undefined,semanticObject:s,semanticAttributes:g?g[s]:g});};f.prototype._getComponent=function(){var o=sap.ui.getCore().byId(this.getControl());if(!o){return null;}var p=o.getParent();while(p){if(p instanceof sap.ui.core.Component){if(p&&p.getAppComponent){p=p.getAppComponent();}return p;}p=p.getParent();}return null;};f.prototype._getAppComponent=function(){return F.getService("FlexConnector").getAppComponentForControl(sap.ui.getCore().byId(this.getControl()));};f.prototype._calculateSemanticAttributes=function(s){var o=sap.ui.getCore().byId(this.getControl());var B=this.getBindingContext()||(o&&o.getBindingContext());if(!B){return null;}var t=this;var g=this.getFieldName();var h=B.getObject(B.getPath());var i=["",this.getSemanticObject()].concat(this.getAdditionalSemanticObjects());var m=this.getMapFieldToSemanticObject();if(this.getSemanticObjectController()&&this.getSemanticObjectController().getMapFieldToSemanticObject()!==undefined){m=this.getSemanticObjectController().getMapFieldToSemanticObject();}var r={};i.forEach(function(j){r[j]={};for(var A in h){if(A==="__metadata"){continue;}if(!h[A]){continue;}var k;if(s){k=(s[j]&&s[j][A])?s[j][A]:A;}else{k=A;if(m){k=t._mapFieldToSemanticObject(A);}}var l=h[A];if(r[j][k]){if(h[g]){if(k===t._mapFieldToSemanticObject(t.getFieldName())){l=h[g];}else{q.sap.log.error("During the mapping of the attribute "+A+" a clash situation is occurred. This can lead to wrong navigation later on.");}}}r[j][k]=l;}});return r;};f.prototype._mapFieldToSemanticObject=function(s){if(this.getFieldName()===s&&this.getSemanticObject()){return this.getSemanticObject();}var o=this.getSemanticObjectController();if(!o){return s;}var m=o.getFieldSemanticObjectMap();if(!m){return s;}return m[s]||s;};f.prototype._updateSemanticObjectController=function(o){var g=this.getProperty("semanticObjectController");var h=sap.ui.getCore().byId(this.getControl());o=o||this.getSemanticObjectController()||this._getSemanticObjectControllerOfControl(h);if(o&&h&&o.isControlRegistered(h)){o.unregisterControl(this);}if(o!==g&&g){g.unregisterControl(this);}this.setProperty("semanticObjectController",o);if(o&&!o.isControlRegistered(h)){o.registerControl(this);}};f.prototype._getSemanticObjectControllerOfControl=function(o){if(!o){return undefined;}var s;var p=o.getParent();while(p){if(p.getSemanticObjectController){s=p.getSemanticObjectController();if(s){this.setSemanticObjectController(s);break;}}p=p.getParent();}return s;};f.prototype._updateVisibilityOfAvailableActions=function(m){if(!this._getEnabledAvailableActionsPersonalizationTotal()){return m;}var g=U.getStorableAvailableActions(m);var h=g.some(function(o){return!!o.isSuperiorAction;});g.forEach(function(o){if(m.length>10){o.visible=false;}if(h){o.visible=false;}if(o.isSuperiorAction){o.visible=true;}});return m;};f.prototype._isAvailableActionsPersonalizationTextEnabled=function(m){var g=U.getStorableAvailableActions(m);if(g.length===0){return false;}return this._getEnabledAvailableActionsPersonalizationTotal();};f.prototype._getEnabledAvailableActionsPersonalizationTotal=function(){var E=this.getEnableAvailableActionsPersonalization();if(this.getSemanticObjectController()&&this.getSemanticObjectController().getEnableAvailableActionsPersonalization()&&this.getSemanticObjectController().getEnableAvailableActionsPersonalization()[this.getFieldName()]!==undefined){E=this.getSemanticObjectController().getEnableAvailableActionsPersonalization()[this.getFieldName()];}return E;};f.prototype._showErrorDialog=function(t,T,o){b.show(t,{icon:b.Icon.ERROR,title:T,actions:[sap.m.MessageBox.Action.CLOSE],styleClass:(o.$()&&o.$().closest(".sapUiSizeCompact").length)?"sapUiSizeCompact navigationPopoverErrorDialog":"navigationPopoverErrorDialog"});};return f;},true);
