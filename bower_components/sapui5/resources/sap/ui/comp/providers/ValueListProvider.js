/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/Column','sap/m/ColumnListItem','sap/m/Text','sap/m/Token','./BaseValueListProvider','sap/ui/core/Item','sap/ui/model/Filter','sap/ui/model/Sorter','sap/ui/model/json/JSONModel','sap/ui/comp/util/FormatUtil'],function(q,C,a,T,b,B,I,F,S,J,c){"use strict";var V=B.extend("sap.ui.comp.providers.ValueListProvider",{constructor:function(p){if(p){this.sAggregationName=p.aggregation;this.bTypeAheadEnabled=p.typeAheadEnabled;this.bEnableShowTableSuggestionValueHelp=p.enableShowTableSuggestionValueHelp===undefined?true:p.enableShowTableSuggestionValueHelp;}B.apply(this,arguments);this._onInitialise();}});V.prototype._onInitialise=function(){if(!this.bTypeAheadEnabled){this.oAfterRenderingEventDelegate={onAfterRendering:this._onMetadataInitialised};this.oControl.addEventDelegate(this.oAfterRenderingEventDelegate,this);}else if(this.oControl.attachSuggest){this._fSuggest=function(e){this.oControl=e.getSource();if(!this.bInitialised){return;}if(!this.oTemplate||!this.oControl.data("_hassuggestionTemplate")){this._createSuggestionTemplate();}var s=e.getParameter("suggestValue");this._fetchData(s);}.bind(this);this.oControl.attachSuggest(this._fSuggest);this._handleSelect();}};V.prototype._onMetadataInitialised=function(){if(this.bInitialised){if(this.oAfterRenderingEventDelegate){this.oControl.removeEventDelegate(this.oAfterRenderingEventDelegate,this);delete this.oAfterRenderingEventDelegate;}this._createDropDownTemplate();this._fetchData();}};V.prototype._isSortable=function(n){if(this.oPrimaryValueListAnnotation){for(var i=0;i<this.oPrimaryValueListAnnotation.valueListFields.length;i++){if(this.oPrimaryValueListAnnotation.valueListFields[i].name===n){return this.oPrimaryValueListAnnotation.valueListFields[i].sortable!==false;}}return false;}return true;};V.prototype._createDropDownTemplate=function(){this._oTemplate=new I({key:"{"+this.sKey+"}",text:this._getDDLBTextBindingPath()});this._oSorter=null;if(this.sDDLBDisplayBehaviour===sap.ui.comp.smartfilterbar.DisplayBehaviour.idOnly||this.sDDLBDisplayBehaviour===sap.ui.comp.smartfilterbar.DisplayBehaviour.idAndDescription){if(this._isSortable(this.sKey)){this._oSorter=new S(this.sKey);}}else{if(this._isSortable(this.sDescription)){this._oSorter=new S(this.sDescription);}else if((this.sDescription!==this.sKey)&&this._isSortable(this.sKey)){this._oSorter=new S(this.sKey);}}};V.prototype._createSuggestionTemplate=function(){var i=0,l=0,t,s=0;this._oTemplate=new a();if(this._aCols){this.oControl.removeAllSuggestionColumns();l=this._aCols.length;for(i=0;i<l;i++){var d=false,m="1px",w=this._aCols[i].width;if(sap.ui.Device.system.phone){w=undefined;if(i>=2){d=true;m=(i+1)*10+"rem";}}this.oControl.addSuggestionColumn(new C({header:new T({wrapping:false,text:this._aCols[i].label,tooltip:this._aCols[i].tooltip||this._aCols[i].label}),demandPopin:d,popinDisplay:sap.m.PopinDisplay.Inline,minScreenWidth:m,width:w}));t=null;if(this._aCols[i].type==="string"){t={path:this._aCols[i].template};}this._oTemplate.addCell(new T({wrapping:false,text:{path:this._aCols[i].template,type:this._aCols[i].oType},tooltip:t}));if(w){s+=parseFloat(w.substring(0,w.length-2));}}if(s>0){this.oControl.setProperty('maxSuggestionWidth',s+l+"em",true);}}this.oControl.data("_hassuggestionTemplate",true);};V.prototype._getDDLBTextBindingPath=function(){return c.getFormattedBindingExpressionFromDisplayBehaviour(this.sDDLBDisplayBehaviour,this.sKey,this.sDescription);};V.prototype._handleSelect=function(){var h=function(d,f){var k,t,o;if(d){k=d[this.sKey];t=d[this.sDescription];}if(k||(k==="")){if(this.oControl.addToken){t=c.getFormattedExpressionFromDisplayBehaviour(this.sTokenDisplayBehaviour,k,t);o=new b({key:k,text:t,tooltip:t});o.data("row",d);if(f){f(o);}delete this.oControl.__sValidationText;}else{this.oControl.setValue(k);this.oControl.fireChange({value:k,validated:true});}}this._calculateAndSetFilterOutputData([d]);}.bind(this);var A=function(){if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter&&this.oFilterProvider._oSmartFilter.bIsSearchPending&&this.oFilterProvider._oSmartFilter.search){if(this.oFilterProvider._oSmartFilter.getLiveMode&&this.oFilterProvider._oSmartFilter.getLiveMode()){return;}this.oFilterProvider._oSmartFilter.search();}}.bind(this);if(this.oControl.addValidator){var v=this.oControl._tokenizer?this.oControl._tokenizer._aTokenValidators.slice():[];this.oControl.removeAllValidators();this._fValidator=function(d){if(!this.bInitialised){return;}if(v){var t;v.some(function(e){t=e(d);return t;},this);if(t){return t;}}var r=d.suggestionObject,D,i=d.text,f=[],p;if(r){D=this.oODataModel.getData(r.getBindingContextPath());h(D,d.asyncCallback);}else if(i){if(this.sDisplayFormat==="UpperCase"){i=i.toUpperCase();}if(this.oControl.__sValidationText!==i){this.oControl.__sValidationText=i;this.oControl.__bValidatingToken=true;this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){f=sap.ui.comp.smartfilterbar.FilterProvider.generateFilters(this.aFilterField,this.mFilterInputData);}f.push(new F(this.sKey,sap.ui.model.FilterOperator.EQ,i));if(this.bSupportBasicSearch){p={"search-focus":this.sKey};}this.oODataModel.read("/"+this.sValueListEntitySetName,{filters:f,urlParameters:p,success:function(R,e){var o=R;delete this.oControl.__bValidatingToken;if(R){if(R.results&&R.results.length>=1){if(R.results.length===1){o=R.results[0];}if(this.oControl.data("__validationError")){this.oControl.data("__validationError",null);this.oControl.setValueState("None");}}else{this.oControl.setValueState("Error");this.oControl.data("__validationError",true);}if(o&&o[this.sKey]){h(o,d.asyncCallback);}}A();}.bind(this),error:function(){if(this.oControl.data("__validationError")){this.oControl.setValueState("None");}delete this.oControl.__bValidatingToken;A();}.bind(this)});}else{if(this.oControl.data("__validationError")){this.oControl.setValueState(sap.ui.core.ValueState.Error);}}}}.bind(this);this.oControl.addValidator(this._fValidator);}else if(this.oControl.attachSuggestionItemSelected){this._fSuggestionItemSelected=function(e){var r=e.getParameter("selectedRow"),d;if(r){d=r.getModel().getData(r.getBindingContextPath());h(d);}};this.oControl.attachSuggestionItemSelected(this._fSuggestionItemSelected);}this.oControl.setRowResultFunction(function(s){var o,r="";if(s){o=s.getBindingContext();}if(o&&this.sKey){r=o.getProperty(this.sKey);}return r;}.bind(this));};V.prototype._fetchData=function(s){var p={},f=[],l,e;if(this.bTypeAheadEnabled){if(s&&this.sDisplayFormat==="UpperCase"){s=s.toUpperCase();}if(this.bSupportBasicSearch){p["custom"]={"search-focus":this.sKey,"search":s};}this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){f=sap.ui.comp.smartfilterbar.FilterProvider.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings});}if(!this.bSupportBasicSearch){f.push(new F(this.sKey,sap.ui.model.FilterOperator.StartsWith,s));}l=10;if(this.bEnableShowTableSuggestionValueHelp){e={dataReceived:function(E){var o=E.getSource(),i;if(o){i=o.getLength();if(i&&i<=l){this.oControl.setShowTableSuggestionValueHelp(false);}else{this.oControl.setShowTableSuggestionValueHelp(true);}}}.bind(this)};}else{this.oControl.setShowTableSuggestionValueHelp(false);}}if(this.aSelect&&this.aSelect.length){p["select"]=this.aSelect.toString();}if(!this.sValueListEntitySetName){q.sap.log.error("ValueListProvider","Empty sValueListEntitySetName for "+this.sAggregationName+" binding! (missing primaryValueListAnnotation)");}this.oControl.bindAggregation(this.sAggregationName,{path:"/"+this.sValueListEntitySetName,length:l,parameters:p,filters:f,sorter:this._oSorter,events:e,template:this._oTemplate,templateShareable:false});};V.prototype.destroy=function(){if(this.oControl){if(this.oControl.detachSuggest){this.oControl.detachSuggest(this._fSuggest);this._fSuggest=null;}if(this.oControl.removeValidator){this.oControl.removeValidator(this._fValidator);this._fValidator=null;}else if(this.oControl.detachSuggestionItemSelected){this.oControl.detachSuggestionItemSelected(this._fSuggestionItemSelected);this._fSuggestionItemSelected=null;}this.oControl.unbindAggregation(this.sAggregationName);this.oControl.data("_hassuggestionTemplate",false);delete this.oControl.__sValidationText;delete this.oControl.__bValidatingToken;}B.prototype.destroy.apply(this,arguments);if(this.oJsonModel){this.oJsonModel.destroy();this.oJsonModel=null;}this._oTemplate=null;this.sAggregationName=null;this.bTypeAheadEnabled=null;this._oSorter=null;};return V;},true);
