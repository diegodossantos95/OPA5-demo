/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/CheckBox','sap/m/ComboBox','sap/m/DatePicker','sap/m/TimePicker','sap/m/HBox','sap/m/Input','sap/m/Text','sap/m/ObjectIdentifier','sap/m/ObjectStatus','sap/m/Image','sap/m/Link','sap/m/VBox','sap/ui/comp/navpopover/SmartLink','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/smartfield/ODataHelper','sap/ui/comp/smartfield/SmartField','sap/ui/comp/odata/ODataType','sap/ui/comp/odata/CriticalityMetadata','sap/ui/comp/util/FormatUtil','sap/ui/core/Control','sap/ui/comp/navpopover/SemanticObjectController'],function(q,C,a,D,T,H,I,b,O,c,d,L,V,S,M,e,f,g,h,F,j,k){"use strict";var l;var m=function(p){if(p){this._oParentODataModel=p.model;this._oMetadataAnalyser=p.metadataAnalyser;this._aODataFieldMetadata=p.fieldsMetadata;this._oLineItemAnnotation=p.lineItemAnnotation;this._oSemanticKeyAnnotation=p.semanticKeyAnnotation;this._smartTableId=p.smartTableId;this._isAnalyticalTable=p.isAnalyticalTable;this._isMobileTable=p.isMobileTable;this._oDateFormatSettings=p.dateFormatSettings;this._bEnableDescriptions=p.enableDescriptions;this._oCurrencyFormatSettings=p.currencyFormatSettings;this._oDefaultDropDownDisplayBehaviour=p.defaultDropDownDisplayBehaviour||"descriptionAndId";this.useSmartField=p.useSmartField==="true";this.useSmartToggle=p.useSmartToggle==="true";this._sEntitySet=p.entitySet;this._oSemanticKeyAdditionalControl=p._semanticKeyAdditionalControl;this._oSemanticObjectController=p.semanticObjectController;}if(!this._oMetadataAnalyser&&this._oParentODataModel){this._oMetadataAnalyser=new M(this._oParentODataModel);this._intialiseMetadata();}this._mSmartField={};this._oHelper=new e(this._oMetadataAnalyser.oModel);this._aValueListProvider=[];this._aValueHelpProvider=[];this._aLinkHandlers=[];};m.prototype._intialiseMetadata=function(){if(!this._aODataFieldMetadata){this._aODataFieldMetadata=this._oMetadataAnalyser.getFieldsByEntitySetName(this.sEntity);}};m.prototype.getFieldViewMetadata=function(o,i){var n=this._createFieldMetadata(o);this._createFieldTemplate(n,i);return n;};m.prototype._createFieldTemplate=function(v,i){if(this.useSmartField){v.template=new f({value:{path:v.name},entitySet:this._sEntitySet,contextEditable:{path:"sm4rtM0d3l>/editable",mode:"OneWay"},controlContext:this._isMobileTable?"responsiveTable":"table",wrapping:this._isMobileTable});if(g.isNumeric(v.type)||g.isDateOrTime(v.type)){v.template.setTextAlign("Right");v.template.setWidth("100%");}this._completeSmartField(v);v.template._setPendingEditState(i);}if(this.useSmartToggle){v.template=new l({editable:{path:"sm4rtM0d3l>/editable",mode:"OneWay"},edit:this.useSmartField?v.template:this._createEditableTemplate(v),display:this._createDisplayOnlyTemplate(v)});}else if(!this.useSmartField){v.template=i?this._createEditableTemplate(v):this._createDisplayOnlyTemplate(v);}};m.prototype._completeSmartField=function(v){var o={annotations:{},path:v.name};if(!this._mSmartField.entitySetObject){this._mSmartField.entitySetObject=this._oHelper.oMeta.getODataEntitySet(this._sEntitySet);this._mSmartField.entityType=this._oHelper.oMeta.getODataEntityType(this._mSmartField.entitySetObject.entityType);}o.modelObject=this._oParentODataModel;o.entitySetObject=this._mSmartField.entitySetObject;o.entitySet=this._mSmartField.entitySetObject;o.entityType=this._mSmartField.entityType;this._oHelper.getProperty(o);v.fieldControlProperty=this._oHelper.oAnnotation.getFieldControlPath(o.property.property);if(v.fieldControlProperty&&v.parentPropertyName){v.fieldControlProperty=v.parentPropertyName+"/"+v.fieldControlProperty;}o.annotations.uom=this._oHelper.getUnitOfMeasure2(o);o.annotations.text=this._oHelper.getTextProperty2(o);o.annotations.lineitem=this._oLineItemAnnotation;o.annotations.semantic=M.getSemanticObjectsFromProperty(o.property.property);this._oHelper.getUOMTextAnnotation(o);if(o.property.property["sap:value-list"]||o.property.property["com.sap.vocabularies.Common.v1.ValueList"]){o.annotations.valuelist=this._oHelper.getValueListAnnotationPath(o);if(o.property.property["sap:value-list"]){o.annotations.valuelistType=o.property.property["sap:value-list"];}else{o.annotations.valuelistType=this._oMetadataAnalyser.getValueListSemantics(o.property.property["com.sap.vocabularies.Common.v1.ValueList"]);}}this._oHelper.getUOMValueListAnnotationPath(o);delete o.entitySet;v.template.data("configdata",{"configdata":o});v.template.data("dateFormatSettings",this._oDateFormatSettings);v.template.data("currencyFormatSettings",this._oCurrencyFormatSettings);v.template.data("defaultDropDownDisplayBehaviour",this._oDefaultDropDownDisplayBehaviour);if(o.annotations.uom||g.isNumeric(v.type)||g.isDateOrTime(v.type)){var A=v.template.getTextAlign();if(A==="Initial"){A="Right";}v.align=A;}};m.prototype._createEditableTemplate=function(v,B){var t=null,o,i,n;if(v.type==="Edm.DateTime"||v.type==="Edm.DateTimeOffset"){if(v.displayFormat==="Date"){o=this._oDateFormatSettings;i={displayFormat:"Date"};t=new D({dateValue:{path:v.name}});}}else if(v.type==="Edm.Boolean"){t=new C({selected:{path:v.name}});}else if(v.type==="Edm.Decimal"){i={precision:v.precision,scale:v.scale};}else if(v.type==="Edm.String"){i={isDigitSequence:v.isDigitSequence};}n=g.getType(v.type,o,i);if(v.semanticObjects&&(!B)){t=this._createSmartLinkFieldTemplate(v,n,function(){return this._createEditableTemplate(v,true);}.bind(this));}if(!t){if(v.type==="Edm.Time"){t=new T({value:{path:v.name,type:n}});}else{t=new I({value:{path:v.name,type:n}});if(v.unit){t.bindProperty("description",{path:v.unit});t.setTextAlign("Right");t.setTextDirection("LTR");t.setFieldWidth("80%");}else if(this._bEnableDescriptions&&v.description){t.bindProperty("description",{path:v.description});}else if(g.isNumeric(v.type)||g.isDateOrTime(v.type)){t.setTextAlign("Right");t.setTextDirection("LTR");}if(v.hasValueListAnnotation){this._associateValueHelpAndSuggest(t,v);}}}return t;};m.prototype._associateValueHelpAndSuggest=function(o,i){o.setShowValueHelp(true);this._aValueHelpProvider.push(new sap.ui.comp.providers.ValueHelpProvider({loadAnnotation:true,fullyQualifiedFieldName:i.fullName,metadataAnalyser:this._oMetadataAnalyser,control:o,model:this._oParentODataModel,preventInitialDataFetchInValueHelpDialog:true,dateFormatSettings:this._oDateFormatSettings,takeOverInputValue:false,fieldName:i.fieldName,type:i.type,maxLength:i.maxLength,displayFormat:i.displayFormat,displayBehaviour:i.displayBehaviour,title:i.label}));o.setShowSuggestion(true);o.setFilterSuggests(false);this._aValueListProvider.push(new sap.ui.comp.providers.ValueListProvider({loadAnnotation:true,fullyQualifiedFieldName:i.fullName,metadataAnalyser:this._oMetadataAnalyser,control:o,model:this._oParentODataModel,dateFormatSettings:this._oDateFormatSettings,typeAheadEnabled:true,aggregation:"suggestionRows",displayFormat:i.displayFormat,displayBehaviour:i.displayBehaviour}));};m.prototype._createDisplayOnlyTemplate=function(v,B){var t=null,o=null,i,n,A,p;if(v.displayFormat==="Date"){i=this._oDateFormatSettings;n={displayFormat:"Date"};}else if(v.type==="Edm.Decimal"){n={precision:v.precision,scale:v.scale};}else if(v.type==="Edm.String"){n={isDigitSequence:v.isDigitSequence};}o=g.getType(v.type,i,n);if(g.isNumeric(v.type)||g.isDateOrTime(v.type)){A="Right";}if(this._isMobileTable){if(v.isImageURL){t=new d({src:{path:v.name},width:"3em",height:"3em"});}else if(this._oLineItemAnnotation&&this._oLineItemAnnotation.urlInfo&&this._oLineItemAnnotation.urlInfo[v.name]){t=this._createLink(v,o,this._oLineItemAnnotation.urlInfo[v.name]);}else if(this._oLineItemAnnotation&&this._oLineItemAnnotation.criticality&&this._oLineItemAnnotation.criticality[v.name]){t=this._createObjectStatusTemplate(v,o,this._oLineItemAnnotation.criticality[v.name]);}else if(this._oSemanticKeyAnnotation&&this._oSemanticKeyAnnotation.semanticKeyFields&&this._oSemanticKeyAnnotation.semanticKeyFields.indexOf(v.name)>-1){t=this._createObjectIdentifierTemplate(v,o,this._oSemanticKeyAnnotation.semanticKeyFields.indexOf(v.name)===0);}}if(!t){if(v.semanticObjects&&(!B)){t=this._createSmartLinkFieldTemplate(v,o,function(){return this._createDisplayOnlyTemplate(v,true);}.bind(this));}else if(v.unit){t=this._createMeasureFieldTemplate(v,o);}else{p=this._getDefaultBindingInfo(v,o);t=new b({wrapping:this._isMobileTable,textAlign:A,text:p});}}v.align=A;return t;};m.prototype._getDefaultBindingInfo=function(v,t){var B={path:v.name,type:t};if(this._bEnableDescriptions&&v.description){B={parts:[{path:v.name,type:t},{path:v.description}],formatter:function(i,s){return F.getFormattedExpressionFromDisplayBehaviour(v.displayBehaviour,i,s);}};}return B;};m.prototype._createLink=function(v,t,o){var i=null;v.linkProperties=o.parameters||o.urlPath;if(o.urlPath){i={path:o.urlPath};}else if(o.urlTarget){i=o.urlTarget;}return new L({text:this._getDefaultBindingInfo(v,t),wrapping:this._isMobileTable,href:i});};m.prototype._createObjectIdentifierTemplate=function(v,t,i){var o,s,n,p,r,u;var w;var x=this;if(v.semanticObjects){k.getDistinctSemanticObjects().then(function(y){w=k.hasDistinctSemanticObject(v.semanticObjects.defaultSemanticObject,y);if(w){q.sap.require("sap.ui.comp.navpopover.NavigationPopoverHandler");u=new sap.ui.comp.navpopover.NavigationPopoverHandler({semanticObject:v.semanticObjects.defaultSemanticObject,additionalSemanticObjects:v.semanticObjects.additionalSemanticObjects,semanticObjectLabel:v.label,fieldName:v.name,semanticObjectController:x._oSemanticObjectController,navigationTargetsObtained:function(E){var o=sap.ui.getCore().byId(E.getSource().getControl());var z=E.getParameters().mainNavigation;if(z){z.setDescription(o.getText());}E.getParameters().show(o.getTitle(),z,undefined,undefined);}});x._aLinkHandlers.push(u);}});}if(v.description){switch(v.displayBehaviour){case"descriptionAndId":s=v.description;n=v.name;p=t;break;case"idAndDescription":s=v.name;n=v.description;r=t;break;case"idOnly":s=v.name;p=t;break;default:s=v.description;break;}}else{s=v.name;r=t;}o=new O({title:s?{path:s,type:r}:undefined,text:n?{path:n,type:p}:undefined,titleActive:v.semanticObjects?{path:"$sapuicompcontrolprovider_distinctSO>/distinctSemanticObjects/"+v.semanticObjects.defaultSemanticObject,formatter:function(y){return!!y;}}:false,titlePress:function(E){if(w&&u){u.setControl(E.getSource());u.openPopover(E.getParameter("domRef"));}}});o.attachEvent("ObjectIdentifier.designtime",function(E){if(u){u.setControl(E.getSource());E.getParameters().registerNavigationPopoverHandler(u);}});o.setModel(k.getJSONModel(),"$sapuicompcontrolprovider_distinctSO");if(this._oSemanticKeyAdditionalControl&&i){this._bSemanticKeyAdditionalControlUsed=true;return new V({renderType:"Bare",items:[o,this._oSemanticKeyAdditionalControl]}).addStyleClass("sapMTableContentMargin");}return o;};m.prototype._createObjectStatusTemplate=function(v,t,o){var s,i,n,B;n=h.getShowCriticalityIcon(o.criticalityRepresentationType);if(o.path){v.criticality=o.path;s={path:o.path,formatter:h.getCriticalityState};if(n){i={path:o.path,formatter:h.getCriticalityIcon};}}else{s=h.getCriticalityState(o.criticalityType);if(n){i=h.getCriticalityIcon(o.criticalityType);}}if(v.unit){B={parts:[{path:v.name,type:t},{path:v.unit}],formatter:v.isCurrencyField?F.getInlineAmountFormatter():F.getInlineMeasureUnitFormatter(),useRawValues:v.isCurrencyField};}else if(v.description){B={path:v.description};}else{B={path:v.name,type:t};}return new c({text:B,state:s,icon:i});};m.prototype._createSmartLinkFieldTemplate=function(v,t,i){var B=v.unit?{parts:[{path:v.name,type:t},{path:v.unit}],formatter:v.isCurrencyField?F.getAmountCurrencyFormatter():F.getMeasureUnitFormatter(),useRawValues:true}:this._getDefaultBindingInfo(v,t);var o=new S({semanticObject:v.semanticObjects.defaultSemanticObject,additionalSemanticObjects:v.semanticObjects.additionalSemanticObjects,semanticObjectLabel:v.label,fieldName:v.name,text:B,uom:v.unit?{path:v.unit}:undefined,wrapping:this._isMobileTable,semanticObjectController:this._oSemanticObjectController,navigationTargetsObtained:function(E){var n=this.getBinding("text");if(!q.isArray(n.getValue())||v.unit){E.getParameters().show();return;}var p=n.getValue();var r=F.getTextsFromDisplayBehaviour(v.displayBehaviour,p[0],p[1]);var s=E.getParameters().mainNavigation;if(s){s.setDescription(r.secondText);}E.getParameters().show(r.firstText,s,undefined,undefined);}});o.setCreateControlCallback(i);return o;};m.prototype._createMeasureFieldTemplate=function(v,t){var o,A,i,n,u,E=false;E=!!(v.isCurrencyField&&this._oCurrencyFormatSettings&&this._oCurrencyFormatSettings.showCurrencySymbol);n=new b({layoutData:new sap.m.FlexItemData({growFactor:1,baseSize:"0%"}),textDirection:"LTR",wrapping:false,textAlign:"End",text:{parts:[{path:v.name,type:t},{path:v.unit}],formatter:v.isCurrencyField?F.getAmountCurrencyFormatter():F.getMeasureUnitFormatter(),useRawValues:v.isCurrencyField}});u=new b({layoutData:new sap.m.FlexItemData({shrinkFactor:0}),textDirection:"LTR",wrapping:false,textAlign:"Begin",width:"2.5em",text:{path:v.unit,formatter:E?F.getCurrencySymbolFormatter():undefined}});o=new H({renderType:"Bare",justifyContent:"End",items:[n,u]});o.addStyleClass("sapUiCompDirectionLTR");if(v.isCurrencyField&&this._isAnalyticalTable){if(!this._oMultiCurrencyUtil){q.sap.require("sap.ui.comp.util.MultiCurrencyUtil");this._oMultiCurrencyUtil=sap.ui.comp.util.MultiCurrencyUtil;}A=new L({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTTABLE_MULTI_LINK_TEXT")||"Show Details",visible:{path:v.unit,formatter:this._oMultiCurrencyUtil.isMultiCurrency},press:function(p){this._oMultiCurrencyUtil.openMultiCurrencyPopover(p,{currency:v.name,unit:v.unit,additionalParent:this.useSmartToggle,smartTableId:this._smartTableId,template:i});}.bind(this)});i=o;i.bindProperty("visible",{path:v.unit,formatter:function(s){return!this._oMultiCurrencyUtil.isMultiCurrency(s);}.bind(this)});o=new V({renderType:"Bare",items:[A,i]});}return o;};m.prototype._createFieldMetadata=function(o){var i=q.extend({},o);i.label=o.fieldLabel||o.name;i.quickInfo=o.quickInfo||i.label;i.displayBehaviour=i.displayBehaviour||this._oDefaultDropDownDisplayBehaviour;i.filterType=this._getFilterType(o);this._updateValueListMetadata(i);this._setAnnotationMetadata(i);return i;};m.prototype._updateValueListMetadata=function(o){o.hasValueListAnnotation=o["sap:value-list"]!==undefined;if(o.hasValueListAnnotation){o.hasFixedValues=o["sap:value-list"]==="fixed-values";}else if(o["com.sap.vocabularies.Common.v1.ValueList"]){o.hasValueListAnnotation=true;o.hasFixedValues=this._oMetadataAnalyser.getValueListSemantics(o["com.sap.vocabularies.Common.v1.ValueList"])==="fixed-values";}};m.prototype._setAnnotationMetadata=function(o){if(o&&o.fullName){o.semanticObjects=this._oMetadataAnalyser.getSemanticObjectsFromAnnotation(o.fullName);}};m.prototype._getFilterType=function(o){if(g.isNumeric(o.type)){return"numeric";}else if(o.type==="Edm.DateTime"&&o.displayFormat==="Date"){return"date";}else if(o.type==="Edm.String"){return"string";}else if(o.type==="Edm.Boolean"){return"boolean";}else if(o.type==="Edm.Time"){return"time";}return undefined;};m.prototype.destroy=function(){var n=function(A){var i;if(A){i=A.length;while(i--){A[i].destroy();}}};if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;if(!this._bSemanticKeyAdditionalControlUsed&&this._oSemanticKeyAdditionalControl&&this._oSemanticKeyAdditionalControl.destroy){this._oSemanticKeyAdditionalControl.destroy();}n(this._aValueHelpProvider);this._aValueHelpProvider=null;n(this._aValueListProvider);this._aValueListProvider=null;n(this._aLinkHandlers);this._aLinkHandlers=null;if(this._oHelper){this._oHelper.destroy();}this._oHelper=null;this._mSmartField=null;this._aODataFieldMetadata=null;this._oDateFormatSettings=null;this._oCurrencyFormatSettings=null;this._oDefaultDropDownDisplayBehaviour=null;this._oLineItemAnnotation=null;this._oSemanticKeyAnnotation=null;this._oParentODataModel=null;this.bIsDestroyed=true;};l=j.extend("sap.ui.comp.SmartToggle",{metadata:{library:"sap.ui.comp",properties:{editable:{type:"boolean",defaultValue:false}},aggregations:{edit:{type:"sap.ui.core.Control",multiple:false},display:{type:"sap.ui.core.Control",multiple:false}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}}},renderer:function(r,o){r.write("<span ");r.writeControlData(o);r.addClass("sapUiCompSmartToggle");r.writeClasses();r.write(">");r.renderControl(o.getEditable()?o.getEdit():o.getDisplay());r.write("</span>");}});l.prototype.getFocusDomRef=function(){var o=this.getEditable()?this.getEdit():this.getDisplay();if(o){return o.getFocusDomRef();}return j.prototype.getFocusDomRef.call(this);};l.prototype.getAccessibilityInfo=function(){var o=this.getEditable()?this.getEdit():this.getDisplay();if(o&&o.getAccessibilityInfo){return o.getAccessibilityInfo();}return null;};l.prototype.addAssociation=function(A,i,s){if(A==="ariaLabelledBy"){var E=this.getEdit(),o=this.getDisplay();E&&E.addAssociation(A,i,s);o&&o.addAssociation(A,i,s);}return j.prototype.addAssociation.apply(this,arguments);};l.prototype.removeAssociation=function(A,o,s){if(A==="ariaLabelledBy"){var E=this.getEdit(),i=this.getDisplay();E&&E.removeAssociation(A,o,s);i&&i.removeAssociation(A,o,s);}return j.prototype.removeAssociation.apply(this,arguments);};l.prototype.removeAllAssociation=function(A,s){if(A==="ariaLabelledBy"){var E=this.getEdit(),o=this.getDisplay();E&&E.removeAllAssociation(A,s);o&&o.removeAllAssociation(A,s);}return j.prototype.removeAllAssociation.apply(this,arguments);};return m;},true);
