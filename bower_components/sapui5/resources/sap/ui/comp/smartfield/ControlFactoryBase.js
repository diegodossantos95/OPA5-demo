/*
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/comp/util/FormatUtil","sap/ui/comp/providers/ValueHelpProvider","sap/ui/comp/providers/ValueListProvider","sap/ui/comp/smartfield/BindingUtil","sap/m/HBox"],function(q,B,F,V,a,b,H){"use strict";var C=B.extend("sap.ui.comp.smartfield.ControlFactoryBase",{constructor:function(m,p){B.apply(this,arguments);this.sName="ControlFactoryBase";this._oModel=m;this._oParent=p;this._oBinding=new b();this._aProviders=[];this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");}});C.prototype.createControl=function(c){var m,o;m=this._getCreator(c);if(m){o=this[m]();this._addAriaLabelledBy(o);if(o&&o.onCreate){this[o.onCreate](o.control,o.params);}}return o;};C.prototype._addAriaLabelledBy=function(c){var t;if((this._oParent.getControlContext()===sap.ui.comp.smartfield.ControlContextType.None)||(this._oParent.getControlContext()===sap.ui.comp.smartfield.ControlContextType.Form)||(this._oParent.getControlContext()===sap.ui.comp.smartfield.ControlContextType.SmartFormGrid)){if(c){t=c.control;if(t instanceof H){if(t.getItems().length>0){t=t.getItems()[0];}}}if(t&&t.addAriaLabelledBy&&this._oParent.getAriaLabelledBy().length>0){t.removeAllAriaLabelledBy();this._oParent.getAriaLabelledBy().forEach(function(A){t.addAriaLabelledBy(A);});}}};C.prototype.addValidations=function(c,m){var s,e,t=this;s=function(S,E){var M,o,d=E.getSource();if(d){if(d.setValueState){d.setValueState(S);}o=E.getParameter("exception");if(o){M=o.message;}if(!M){M=E.getParameter("message");}if(d.setValueStateText){d.setValueStateText(M);}}if(m){t._oParent[m](S===sap.ui.core.ValueState.Error);}};e=function(E){s(sap.ui.core.ValueState.Error,E);};c.attachFormatError(e);c.attachParseError(e);c.attachValidationError(e);c.attachValidationSuccess(function(E){s(sap.ui.core.ValueState.None,E);});};C.prototype._getDisplayBehaviourConfiguration=function(d){var D=null;var c=this._oParent.getConfiguration();if(c){D=c.getDisplayBehaviour();}if(!D&&this._oMetaData&&this._oMetaData.entityType){D=this._oHelper.oAnnotation.getTextArrangement(this._oMetaData.property.property,this._oMetaData.entityType);}if(!D){D=this._oParent.data(d);}return D;};C.prototype._getPreventInitialDataFetchInVHDialog=function(){var c=this._oParent.getConfiguration();return c?c.getPreventInitialDataFetchInValueHelpDialog():true;};C.prototype._formatDisplayBehaviour=function(d,k,D){var s=this._getDisplayBehaviourConfiguration(d);if(d==="defaultCheckBoxDisplayBehaviour"){return this._getFormattedExpressionFromDisplayBehaviour(s,k);}if(d==="defaultComboBoxReadOnlyDisplayBehaviour"&&!s){s="descriptionAndId";}return F.getFormattedExpressionFromDisplayBehaviour(s||"idOnly",k,D);};C.prototype._getFormattedExpressionFromDisplayBehaviour=function(d,v){var k="";switch(d){case"OnOff":k=v?"SMARTFIELD_CB_ON":"SMARTFIELD_CB_OFF";break;case"TrueFalse":k=v?"SMARTFIELD_CB_TRUE":"SMARTFIELD_CB_FALSE";break;default:k=v?"SMARTFIELD_CB_YES":"SMARTFIELD_CB_NO";break;}return this._oRb.getText(k);};C.prototype.createValueHelp=function(c,p,v,m,o){var d,e;if(v.annotation&&(p["sap:value-list"]||p["com.sap.vocabularies.Common.v1.ValueList"])){var D=this._getDisplayBehaviourConfiguration("defaultDropDownDisplayBehaviour"),f=this._oParent.data("dateFormatSettings"),P=this._getPreventInitialDataFetchInVHDialog();if(typeof f==="string"){try{f=JSON.parse(f);}catch(g){}}var A,s;if(typeof v.annotation==="string"){s=v.annotation;}else if(v&&typeof v.annotation==="object"){A=v.analyser.getValueListAnnotationForFunctionImport({"":v.annotation},p.name).primaryValueListAnnotation;}if(!v.noDialog){if(c.setFilterSuggests){c.setFilterSuggests(false);}d=new V({loadAnnotation:true,fullyQualifiedFieldName:s,annotation:A,metadataAnalyser:v.analyser,control:c,model:m,preventInitialDataFetchInValueHelpDialog:P,dateFormatSettings:f,takeOverInputValue:false,supportMultiSelect:false,supportRanges:false,fieldName:p.name,title:v.dialogtitle,displayBehaviour:D});if(o){d.attachValueListChanged(o);}this._aProviders.push(d);if(c.setShowValueHelp){c.setShowValueHelp(true);}}e=new a({control:c,typeAheadEnabled:!v.noTypeAhead,aggregation:v.aggregation,loadAnnotation:true,fullyQualifiedFieldName:s,annotation:A,metadataAnalyser:v.analyser,model:m,dateFormatSettings:f,displayBehaviour:D});if(!v.noTypeAhead){if(c.setShowSuggestion){c.setShowSuggestion(true);}}if(o){e.attachValueListChanged(o);}this._aProviders.push(e);}};C.prototype.getAttribute=function(n){var i=this._oParent.getBindingInfo(n);if(i){return this._oBinding.toBindingPath(i);}return this._oParent["get"+n.substring(0,1).toUpperCase()+n.substring(1)]();};C.prototype.createAttributes=function(A,t,N,e){var c=this,n,i,m={};for(n in N){i=this._oParent.getBindingInfo(n);if(i){m[n]=this._oBinding.toBinding(i);}else{m[n]=this._oParent["get"+n.substring(0,1).toUpperCase()+n.substring(1)]();}}if(A){m[A]={model:this._oMetaData.model,path:this._oMetaData.path,type:t?this._oTypes.getType(t):null};}if(e){m[e.event]=function(p){try{c._oParent.fireChange({value:p.mParameters[e.parameter],newValue:p.mParameters[e.parameter]});}catch(d){q.sap.log.warning(d);}};}this.addObjectBinding(m);return m;};C.prototype.mapBindings=function(A,N){var n,i;for(n in N){i=this._oParent.getBindingInfo(n);if(i){A[N[n]]=this._oBinding.toBinding(i);}else{A[N[n]]=this._oParent["get"+n.substring(0,1).toUpperCase()+n.substring(1)]();}}};C.prototype.addObjectBinding=function(A,o){if(!o){o=this._oParent.getObjectBinding(this._oMetaData.model);}if(A&&o){A.objectBindings={};A.objectBindings[this._oMetaData.model]=o.sPath;}};C.prototype.getFormatSettings=function(f){var m=null,c,o,l;if(f){m=this._oParent.data(f);if(!m){c=this._oParent.getCustomData();if(c){l=c.length;while(l--){o=c[l];if(o.getKey()===f){m=o.getValue();break;}}}}if(m&&typeof(m)==="string"){try{m=JSON.parse(m);}catch(e){return null;}}}return m;};C.prototype.destroy=function(){var l=this._aProviders.length;while(l--){this._aProviders[l].destroy();}if(this._oBinding){this._oBinding.destroy();}this._oBinding=null;this._oParent=null;this._oModel=null;this._aProviders=[];this._oRb=null;};return C;},true);
