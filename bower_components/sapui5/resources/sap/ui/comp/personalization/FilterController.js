/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','./Util','./ChartWrapper','sap/ui/comp/filterbar/VariantConverterTo','sap/ui/comp/filterbar/VariantConverterFrom'],function(q,B,l,U,C,V,a){"use strict";var F=B.extend("sap.ui.comp.personalization.FilterController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.filter);},metadata:{events:{afterFilterModelDataChange:{}}}});F.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(U.getTableType(t)===sap.ui.comp.personalization.TableType.ChartWrapper){t.detachExternalFiltersSet(this._onExternalFiltersSet,this);t.attachExternalFiltersSet(this._onExternalFiltersSet,this);}};F.prototype._getTable2Json=function(){var j=this.createPersistentStructure();this._addPersistentData(this._mapTable2Json(this.getTable()),j);return j;};F.prototype._getDataSuiteFormat2Json=function(d){var j=this.createPersistentStructure();this._addPersistentData(this._mapDataSuiteFormat2Json(d),j);return j;};F.prototype._addPersistentData=function(s,d){var c=this.getColumnMap(true);s.filter.filterItems.forEach(function(S){if(!S.isFiltered||!c[S.columnKey]){return;}d.filter.filterItems.push({columnKey:S.columnKey,exclude:S.exclude,operation:S.operation,value1:S.value1,value2:S.value2});});};F.prototype._mapTable2Json=function(t){var j=this.createPersistentStructure();if(U.getTableBaseType(t)!==sap.ui.comp.personalization.TableType.Table){return j;}j.filter.filterItems=t.getColumns().map(function(c){return{columnKey:U.getColumnKey(c),isFiltered:c.getFiltered(),exclude:false,operation:c.getFilterOperator(),value1:c.getFilterValue(),value2:""};});return j;};F.prototype._mapDataSuiteFormat2Json=function(d){var j=this.createPersistentStructure();if(!d.SelectOptions||!d.SelectOptions.length){return j;}j.filter.filterItems=d.SelectOptions.map(function(s){var c=a.convertOption(s.Ranges[0].Option,s.Ranges[0].Low);return{columnKey:s.PropertyName,isFiltered:true,exclude:(s.Ranges[0].Sign==="E"),operation:c.op,value1:c.v,value2:s.Ranges[0].High};});return j;};F.prototype.syncTable2TransientModel=function(){var t=this.getTable();var i=[];var c;var s;if(t){var b,v,o;if(t.getModel()instanceof sap.ui.model.odata.ODataModel||t.getModel()instanceof sap.ui.model.odata.v2.ODataModel){q.sap.require("sap.ui.model.odata.type.Boolean");o=new sap.ui.model.odata.type.Boolean();}else{if(t.getModel()instanceof sap.ui.model.Model){q.sap.require("sap.ui.model.type.Boolean");o=new sap.ui.model.type.Boolean();}}if(o){b=["",o.formatValue(false,"string"),o.formatValue(true,"string")];}var d=this.getColumnMap(true);if(U.getTableBaseType(t)===sap.ui.comp.personalization.TableType.Table){for(s in d){c=d[s];if(U.isFilterable(c)){if(U.getColumnType(c)==="boolean"){v=U._getCustomProperty(c,"values")||b;}i.push({columnKey:s,text:c.getLabel().getText(),tooltip:(c.getTooltip()instanceof sap.ui.core.TooltipBase)?c.getTooltip().getTooltip_Text():c.getTooltip_Text(),maxLength:U._getCustomProperty(c,"maxLength"),precision:U._getCustomProperty(c,"precision"),scale:U._getCustomProperty(c,"scale"),type:U.getColumnType(c),values:v});}}}else if(U.getTableType(t)===sap.ui.comp.personalization.TableType.ResponsiveTable){for(s in d){c=d[s];if(U.getColumnType(c)==="boolean"){v=U._getCustomProperty(c,"values")||b;}if(U.isFilterable(c)){i.push({columnKey:s,text:c.getHeader().getText(),tooltip:(c.getHeader().getTooltip()instanceof sap.ui.core.TooltipBase)?c.getHeader().getTooltip().getTooltip_Text():c.getHeader().getTooltip_Text(),maxLength:U._getCustomProperty(c,"maxLength"),precision:U._getCustomProperty(c,"precision"),scale:U._getCustomProperty(c,"scale"),type:U.getColumnType(c),values:v});}}}else if(U.getTableType(t)===sap.ui.comp.personalization.TableType.ChartWrapper){for(s in d){c=d[s];if(U.isFilterable(c)){i.push({columnKey:s,text:c.getLabel(),tooltip:(c.getTooltip()instanceof sap.ui.core.TooltipBase)?c.getTooltip().getTooltip_Text():c.getTooltip_Text(),maxLength:U._getCustomProperty(c,"maxLength"),precision:U._getCustomProperty(c,"precision"),scale:U._getCustomProperty(c,"scale"),type:U.getColumnType(c),values:v});}}}}U.sortItemsByText(i,"text");var I=this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.filter.items;if(q(i).not(I).length!==0||q(I).not(i).length!==0){this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.filter.items=i;}};F.prototype._onExternalFiltersSet=function(e){var m=this.getModel("$sapuicomppersonalizationBaseController");var d=m.getData();var c=this.getColumnMap(true);this.fireBeforePotentialTableChange();d.persistentData.filter.filterItems=d.persistentData.filter.filterItems.filter(function(f){return f.source!=="chart";});e.getParameters().filters.forEach(function(f){if(f&&f.getColumnKey()&&f.getOperation()){var o=c[f.getColumnKey()];if(!o){return;}var M={columnKey:f.getColumnKey(),operation:f.getOperation(),value1:f.getValue1(),value2:f.getValue2(),source:"chart"};if(this._hasSemanticEqual(M,d.persistentData.filter.filterItems)){return;}d.persistentData.filter.filterItems.push(M);}},this);m.refresh();this.fireAfterPotentialTableChange();this.fireAfterFilterModelDataChange();};F.prototype._hasSemanticEqual=function(f,b){if(!f||!b.length){return false;}var e=b.filter(function(o){for(var p in f){if(f[p]!==o[p]){return false;}}return true;});return e.length>0;};F.prototype.getPanel=function(p){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nFilterPanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nFilterItem");if(!this.getColumnHelper().hasFilterableColumns()){return null;}if(p&&p.column){var c=U.getColumnKey(p.column);if(c){var i=this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.filter.items;i.forEach(function(I){I["isDefault"]=I.columnKey===c;});}}var t=this;var P=new sap.m.P13nFilterPanel({containerQuery:true,items:{path:"$sapmP13nPanel>/transientData/filter/items",template:new sap.m.P13nItem({columnKey:'{$sapmP13nPanel>columnKey}',text:"{$sapmP13nPanel>text}",tooltip:"{$sapmP13nPanel>tooltip}",maxLength:"{$sapmP13nPanel>maxLength}",precision:"{$sapmP13nPanel>precision}",scale:"{$sapmP13nPanel>scale}",type:"{$sapmP13nPanel>type}",isDefault:"{$sapmP13nPanel>isDefault}",values:"{$sapmP13nPanel>values}"})},filterItems:{path:"$sapmP13nPanel>/persistentData/filter/filterItems",template:new sap.m.P13nFilterItem({key:"{$sapmP13nPanel>key}",columnKey:"{$sapmP13nPanel>columnKey}",exclude:"{$sapmP13nPanel>exclude}",operation:"{$sapmP13nPanel>operation}",value1:"{$sapmP13nPanel>value1}",value2:"{$sapmP13nPanel>value2}"})},beforeNavigationTo:t.setModelFunction()});var s=function(o,f){var b=this.getColumnMap(true);var d=b[f];var e=U._getCustomProperty(d,"fullName");if(e){q.sap.require("sap.ui.comp.providers.ValueListProvider");o.setShowSuggestion(true);o.setFilterSuggests(false);o.setModel(this.getTable().getModel());return new sap.ui.comp.providers.ValueListProvider({control:o,fieldName:f,typeAheadEnabled:true,aggregation:"suggestionRows",resolveInOutParams:false,loadAnnotation:true,fullyQualifiedFieldName:e,model:this.getTable().getModel(),enableShowTableSuggestionValueHelp:false});}}.bind(this);P._oIncludeFilterPanel._fSuggestCallback=s;P._oExcludeFilterPanel._fSuggestCallback=s;P.attachAddFilterItem(function(e){var d=this.getModel("$sapuicomppersonalizationBaseController").getData();var b=e.getParameters();var f={columnKey:b.filterItemData.getColumnKey(),operation:b.filterItemData.getOperation(),exclude:b.filterItemData.getExclude(),value1:b.filterItemData.getValue1(),value2:b.filterItemData.getValue2()};if(b.index>-1){d.persistentData.filter.filterItems.splice(b.index,0,f);}else{d.persistentData.filter.filterItems.push(f);}this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);},this);P.attachRemoveFilterItem(function(e){var b=e.getParameters();var d=this.getModel("$sapuicomppersonalizationBaseController").getData();if(b.index>-1){d.persistentData.filter.filterItems.splice(b.index,1);this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);}},this);return P;};F.prototype.syncJsonModel2Table=function(j){var c=this.getColumnMap();var o=q.extend(true,{},c);this.fireBeforePotentialTableChange();if(U.getTableBaseType(this.getTable())===sap.ui.comp.personalization.TableType.Table){j.filter.filterItems.forEach(function(f){var b=c[f.columnKey];if(b){if(!b.getFiltered()){b.setFiltered(true);}delete o[f.columnKey];}});for(var s in o){var b=o[s];if(b&&b.getFiltered()){b.setFiltered(false);}}}this.fireAfterPotentialTableChange();};F.prototype.getChangeType=function(p,P){if(!P||!P.filter||!P.filter.filterItems){return sap.ui.comp.personalization.ChangeType.Unchanged;}if(P&&P.filter&&P.filter.filterItems){P.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(p&&p.filter&&p.filter.filterItems){p.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}var i=JSON.stringify(p.filter.filterItems)!==JSON.stringify(P.filter.filterItems);return i?sap.ui.comp.personalization.ChangeType.ModelChanged:sap.ui.comp.personalization.ChangeType.Unchanged;};F.prototype.getChangeData=function(p,P){if(!p||!p.filter||!p.filter.filterItems){return this.createPersistentStructure();}if(P&&P.filter&&P.filter.filterItems){P.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(p&&p.filter&&p.filter.filterItems){p.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(!P||!P.filter||!P.filter.filterItems){return{filter:U.copy(p.filter)};}if(JSON.stringify(p.filter.filterItems)!==JSON.stringify(P.filter.filterItems)){return{filter:U.copy(p.filter)};}return null;};F.prototype.getUnionData=function(p,P){if(!p||!p.filter||!p.filter.filterItems){return this.createPersistentStructure();}if(!P||!P.filter||!P.filter.filterItems){return{filter:U.copy(p.filter)};}return{filter:U.copy(P.filter)};};F.prototype.getDataSuiteFormatSnapshot=function(d){var p=this.getUnionData(this.getPersistentDataRestore(),this.getPersistentData());if(!p.filter||!p.filter.filterItems||!p.filter.filterItems.length){return;}p.filter.filterItems.forEach(function(f){var r=V.addRangeEntry(d,f.columnKey);V.addRanges(r,[f]);});};F.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(U.getTableType(t)===sap.ui.comp.personalization.TableType.ChartWrapper){t.detachExternalFiltersSet(this._onExternalFiltersSet,this);}};return F;},true);
