/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','./Util'],function(q,B,l,U){"use strict";var C=B.extend("sap.ui.comp.personalization.ColumnsController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.columns);},metadata:{properties:{triggerModelChangeOnColumnInvisible:{type:"boolean",group:"Misc",defaultValue:false}},events:{afterColumnsModelDataChange:{}}}});C.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(U.getTableBaseType(t)===sap.ui.comp.personalization.TableType.Table){t.detachColumnMove(this._onColumnMove,this);t.detachColumnVisibility(this._onColumnVisibility,this);t.detachColumnResize(this._onColumnResize,this);t.attachColumnMove(this._onColumnMove,this);t.attachColumnVisibility(this._onColumnVisibility,this);t.attachColumnResize(this._onColumnResize,this);}this._monkeyPatchTable(t);};C.prototype.createPersistentStructure=function(i){var p=B.prototype.createPersistentStructure.apply(this,arguments);p.columns.fixedColumnCount=0;return p;};C.prototype._getTable2Json=function(){return this._mapTable2Json(this.getTable());};C.prototype._getDataSuiteFormat2Json=function(d){return this._mapDataSuiteFormat2Json(d);};C.prototype._mapTable2Json=function(t){var j=this.createPersistentStructure();if(!t){return j;}var c=this.getColumnMap(true);var i=0;t.getColumns().forEach(function(o){var s=U.getColumnKey(o);if(!c[s]){return;}j.columns.columnsItems.push({columnKey:s,index:i,visible:o.getVisible(),width:(o&&o.getWidth)?o.getWidth():undefined,total:(o&&o.getSummed)?o.getSummed():undefined});i++;});return j;};C.prototype._mapDataSuiteFormat2Json=function(d){var p=U.copy(this.getPersistentDataRestore());if(d.Total&&d.Total.length){d.Total.forEach(function(c){var o=U.getArrayElementByKey("columnKey",c,p.columns.columnsItems);if(o){o.total=true;}});}if(d.Visualizations&&d.Visualizations.length){var L=d.Visualizations.filter(function(v){return v.Type==="LineItem";});if(L.length){p.columns.columnsItems.forEach(function(c){c.visible=false;});L[0].Content.forEach(function(c,i){var o=U.getArrayElementByKey("columnKey",c.Value,p.columns.columnsItems);if(!o){return;}o.visible=true;var I=U.getIndexByKey("columnKey",c.Value,p.columns.columnsItems);this._moveModelItems(I,i,p.columns.columnsItems);},this);}}return p;};C.prototype._moveModelItems=function(i,I,a){if(i<0||I<0||i>a.length-1||I>a.length-1){return;}var m=a.splice(i,1);a.splice(I,0,m[0]);a.forEach(function(M,b){M.index=b;});};C.prototype._getTable2JsonRestore=function(c){if(!c){return B.prototype._getTable2JsonRestore.apply(this,arguments);}var j=this.createPersistentStructure();var i=this.getIgnoreColumnKeys();var o=this.getColumnMap();var I=0;c.forEach(function(s){if(i.indexOf(s)>-1){return;}var a=o[s];j.columns.columnsItems.push({columnKey:s,index:I,visible:a?a.getVisible():false,width:a?a.getWidth():undefined,total:(a&&a.getSummed)?a.getSummed():undefined});I++;});return j;};C.prototype.syncTable2TransientModel=function(){this._syncTable2TransientModel();};C.prototype._determineTooltipText=function(o){var t=null;if(o&&o.getTooltip){if(o.getTooltip()instanceof sap.ui.core.TooltipBase){t=o.getTooltip().getTooltip_Text();}else{t=o.getTooltip_Text();}if(!t&&o instanceof sap.ui.table.AnalyticalColumn){t=o.getTooltip_AsString();}if(!t&&o.getLabel&&o.getLabel().getTooltip_Text){t=o.getLabel().getTooltip_Text();}}return t;};C.prototype._syncTable2TransientModel=function(){var t=this.getTable();var i=[];var c;var o;if(t){var a=this.getColumnMap(true);if(U.getTableBaseType(t)===sap.ui.comp.personalization.TableType.Table){for(c in a){o=a[c];var T=this._determineTooltipText(o);i.push({columnKey:c,text:o.getLabel().getText(),tooltip:T,visible:o.getVisible(),width:o.getWidth(),total:(o&&o.getSummed)?o.getSummed():undefined});}}else{if(U.getTableType(t)===sap.ui.comp.personalization.TableType.ResponsiveTable){for(c in a){o=a[c];i.push({columnKey:c,text:o.getHeader().getText(),tooltip:(o.getHeader().getTooltip()instanceof sap.ui.core.TooltipBase)?o.getHeader().getTooltip().getTooltip_Text():o.getHeader().getTooltip_Text(),visible:o.getVisible(),width:o.getWidth()});}}}}var I=this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.columns.items;if(q(i).not(I).length!==0||q(I).not(i).length!==0){this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.columns.items=i;}};C.prototype._setNewColumnItemIndex=function(d,c,n){var i=-1;if(c&&n!==null&&n!==undefined&&n>-1){i=U.getIndexByKey("columnKey",U.getColumnKey(c),d.persistentData.columns.columnsItems);if(i>-1){d.persistentData.columns.columnsItems[i].index=n;}else{d.persistentData.columns.columnsItems.push({columnKey:U.getColumnKey(c),index:n});}}};C.prototype._onColumnMove=function(e){var i=0,n=null,t=null;var T=null,d=null,c=null;var N=null,o=null;c=e.getParameter("column");N=e.getParameter("newPos");this.fireBeforePotentialTableChange();if(c){T=this.getTable();o=T.indexOfColumn(c);}if(o!==null&&N!==null){d=this.getModel("$sapuicomppersonalizationBaseController").getData();if(o>N){for(i=N;i<=o;i++){if(i<o){t=T.getColumns()[i];n=i+1;}else{t=c;n=e.getParameter("newPos");}this._setNewColumnItemIndex(d,t,n);}}else{for(i=o;i<=N;i++){if(i===o){t=c;n=e.getParameter("newPos");}else{t=T.getColumns()[i];n=i-1;}this._setNewColumnItemIndex(d,t,n);}}this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();}};C.prototype._onColumnVisibility=function(e){var d=this.getModel("$sapuicomppersonalizationBaseController").getData();var c=e.getParameter("column");var v=e.getParameter("newVisible");this.fireBeforePotentialTableChange();var i=U.getIndexByKey("columnKey",U.getColumnKey(c),d.persistentData.columns.columnsItems);if(i>-1){d.persistentData.columns.columnsItems[i].visible=v;}else{d.persistentData.columns.columnsItems.push({columnKey:U.getColumnKey(c),visible:v});}this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._onColumnTotal=function(p){var d=this.getModel("$sapuicomppersonalizationBaseController").getData();var c=p.column;var i=p.isSummed;this.fireBeforePotentialTableChange();var I=U.getIndexByKey("columnKey",U.getColumnKey(c),d.persistentData.columns.columnsItems);if(I>-1){d.persistentData.columns.columnsItems[I].total=i;}else{d.persistentData.columns.columnsItems.push({columnKey:U.getColumnKey(c),total:i});}this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._onColumnFixedCount=function(f){this.fireBeforePotentialTableChange();this.getModel("$sapuicomppersonalizationBaseController").setProperty("/persistentData/columns/fixedColumnCount",f);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._onColumnResize=function(e){var c=e.getParameter("column");var d=this.getModel("$sapuicomppersonalizationBaseController").getData();this.fireBeforePotentialTableChange();var i=U.getIndexByKey("columnKey",U.getColumnKey(c),d.persistentData.columns.columnsItems);if(i>-1){d.persistentData.columns.columnsItems[i].width=e.getParameter("width");}else{d.persistentData.columns.columnsItems.push({columnKey:U.getColumnKey(c),width:e.getParameter("width")});}this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype.getPanel=function(p){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nColumnsPanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nColumnsItem");var t=this;var v=-1;if(p&&p.visibleItemsThreshold){v=p.visibleItemsThreshold;}var P=new sap.m.P13nColumnsPanel({visibleItemsThreshold:v,items:{path:'$sapmP13nPanel>/transientData/columns/items',template:new sap.m.P13nItem({columnKey:'{$sapmP13nPanel>columnKey}',text:'{$sapmP13nPanel>text}',visible:'{$sapmP13nPanel>visible}',tooltip:'{$sapmP13nPanel>tooltip}',width:"{$sapmP13nPanel>width}"})},columnsItems:{path:"$sapmP13nPanel>/persistentData/columns/columnsItems",template:new sap.m.P13nColumnsItem({columnKey:"{$sapmP13nPanel>columnKey}",index:"{$sapmP13nPanel>index}",visible:"{$sapmP13nPanel>visible}",width:"{$sapmP13nPanel>width}",total:"{$sapmP13nPanel>total}"})},beforeNavigationTo:this.setModelFunction(),changeColumnsItems:function(e){var m=[];if(e.getParameter("items")){e.getParameter("items").forEach(function(M){m.push({columnKey:M.columnKey,index:M.index===-1?undefined:M.index,visible:M.visible,width:M.width,total:M.total});});t.getModel("$sapuicomppersonalizationBaseController").setProperty("/persistentData/columns/columnsItems",m);}}});return P;};C.prototype.syncJsonModel2Table=function(j){var t=this.getTable();var i=j.columns.columnsItems;this.fireBeforePotentialTableChange();if(U.getTableBaseType(t)===sap.ui.comp.personalization.TableType.Table){this._applyChangesToUiTableType(t,i);}else if(U.getTableType(t)===sap.ui.comp.personalization.TableType.ResponsiveTable){this._applyChangesToMTableType(t,i);}this.fireAfterPotentialTableChange();};C.prototype._sortByIndex=function(a,b){if(a.index!==undefined&&b.index===undefined){return-1;}if(b.index!==undefined&&a.index===undefined){return 1;}if(a.index<b.index){return-1;}if(a.index>b.index){return 1;}return 0;};C.prototype._applyChangesToUiTableType=function(t,c){var o=null;var a={};var f=this.getModel("$sapuicomppersonalizationBaseController").getProperty("/persistentData/columns/fixedColumnCount");var b=this;var s=function(m,n){var r=[];m.sort(b._sortByIndex);m.forEach(function(p){r.push(p.columnKey);a[p.columnKey]=p;});n.forEach(function(p,I){if(r.indexOf(p)<0){r.splice(I,0,p);}});return r;};var S=function(m,o){var n=a[m];if(n&&n.visible!==undefined&&o.getVisible()!==n.visible){o.setVisible(n.visible,true);}};var i=false;var d=function(I,m,o){var T=t.indexOfColumn(o);var M=I;if(M!==undefined&&T!==M){if(T>-1){t.removeColumn(o,true);}t.insertColumn(o,M,true);}};var e=function(m,o){var n=a[m];if(n&&n.width!==undefined&&o.getWidth()!==n.width){o.setWidth(n.width,true);}};var g=function(m,o){var n=a[m];if(n&&n.total!==undefined&&o.getSummed&&o.getSummed()!==n.total){o.setSummed(n.total,true);}};var h=function(t){if(i){t.setFixedColumnCount(0,true);}else if(f!==t.getFixedColumnCount()){t.setFixedColumnCount(f,true);}};if(c.length){var j=s(c,this._aColumnKeys);var k=this.getColumnMap();j.forEach(function(m,I){o=k[m];if(o){S(m,o);d(I,m,o);e(m,o);g(m,o);}});h(t);}};C.prototype._applyChangesToMTableType=function(t,c){var T=false;var o=this.getColumnMap();var s=function(a,b){var m=a.index;if(m!==undefined){b.setOrder(m,true);T=true;}};var S=function(a,b){if(a.visible!==undefined&&b.getVisible()!==a.visible){b.setVisible(a.visible,true);T=true;}};if(c.length){c.sort(function(a,b){if(a.index<b.index){return-1;}if(a.index>b.index){return 1;}return 0;});c.forEach(function(a){var b=o[a.columnKey];if(b){s(a,b);S(a,b);}},this);}if(T){t.invalidate();}};C.prototype.getChangeType=function(p,P){var c=this.getChangeData(p,P);var n=U.getTableType(this.getTable())===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTriggerModelChangeOnColumnInvisible();if(c){var o=sap.ui.comp.personalization.ChangeType.TableChanged;c.columns.columnsItems.some(function(i){if(i.visible||(i.visible===false&&n)){o=sap.ui.comp.personalization.ChangeType.ModelChanged;return true;}if(i.total===false||i.total===true){o=sap.ui.comp.personalization.ChangeType.ModelChanged;return true;}});return o;}return sap.ui.comp.personalization.ChangeType.Unchanged;};C.prototype.getChangeData=function(p,P){if(!P||!P.columns||!P.columns.columnsItems){return null;}var c={columns:U.copy(p.columns)};var i=true;i=(p.columns.fixedColumnCount===P.columns.fixedColumnCount);p.columns.columnsItems.some(function(I){var o=U.getArrayElementByKey("columnKey",I.columnKey,P.columns.columnsItems);if(!U.semanticEqual(I,o)){i=false;return true;}});if(i){return null;}var t=[];c.columns.columnsItems.forEach(function(I,a){var o=U.getArrayElementByKey("columnKey",I.columnKey,P.columns.columnsItems);if(U.semanticEqual(I,o)){t.push(I);return;}for(var b in I){if(b==="columnKey"||!o){if(o&&o[b]===undefined){delete I[b];}else{continue;}}if(I[b]===o[b]){delete I[b];}}if(Object.keys(I).length<2){t.push(I);}});t.forEach(function(I){var a=U.getIndexByKey("columnKey",I.columnKey,c.columns.columnsItems);c.columns.columnsItems.splice(a,1);});return c;};C.prototype._sortArrayByPropertyName=function(A,p,t){var s=[];if(t===null||t===undefined){t=false;}if(A&&A.length>0&&p!==undefined&&p!==null&&p!==""){if(t){s=q.extend(true,[],A);}else{s=A;}s.sort(function(a,b){var c=a[p];var d=b[p];if(c<d||(c!==undefined&&d===undefined)){return-1;}if(c>d||(c===undefined&&d!==undefined)){return 1;}return 0;});}return s;};C.prototype.getUnionData=function(p,P){var o=U.copy(p);if(!P||!P.columns||!P.columns.columnsItems||(P.columns.columnsItems.length===0&&P.columns.fixedColumnCount===0)){return o.columns?{columns:o.columns}:null;}if(!o||!o.columns||!o.columns.columnsItems){return{columns:q.extend(true,{},P.columns)};}var d=[];var u=this.createPersistentStructure();u.columns.fixedColumnCount=o.columns.fixedColumnCount;if(P.columns.fixedColumnCount!==undefined){u.columns.fixedColumnCount=P.columns.fixedColumnCount;}o.columns.columnsItems.forEach(function(c,i){var a=U.getArrayElementByKey("columnKey",c.columnKey,P.columns.columnsItems);if(a){if(a.visible!==undefined){c.visible=a.visible;}if(a.width!==undefined){c.width=a.width;}if(a.total!==undefined){c.total=a.total;}if(a.index!==undefined){c.index=a.index;d.push(c);return;}}u.columns.columnsItems.push(c);});if(d&&d.length>0){this._sortArrayByPropertyName(d,"index");d.forEach(function(D){u.columns.columnsItems.splice(D.index,0,D);});}u.columns.columnsItems.forEach(function(c,i){c.index=i;});return u;};C.prototype.isColumnSelected=function(p,P,c){if(!p){P.columnsItems.some(function(o,I){if(o.columnKey===c&&o.visible){i=I;return true;}});return i>-1;}if(!p.selectedItems){return false;}var i=U.getIndexByKey("columnKey",c,p.selectedItems);return i>-1;};C.prototype.getDataSuiteFormatSnapshot=function(d){var p=this.getUnionData(this.getPersistentDataRestore(),this.getPersistentData());if(!p.columns||!p.columns.columnsItems||!p.columns.columnsItems.length){return;}var c=p.columns.columnsItems.filter(function(o){return!!o.total;});if(c.length){d.Total=c.map(function(o){return o.columnKey;});}var a=p.columns.columnsItems.filter(function(o){return!!o.visible;});if(a.length){if(!d.Visualizations){d.Visualizations=[];}a.sort(this._sortByIndex);d.Visualizations.push({Type:"LineItem",Content:a.map(function(o){return{Value:o.columnKey,Label:undefined};})});}};C.prototype._monkeyPatchTable=function(t){if(U.getTableBaseType(t)!==sap.ui.comp.personalization.TableType.Table){return;}var a=this;var s=t.setFixedColumnCount.bind(t);var S=function(f,b){a._onColumnFixedCount(f);s(f,b);};if(t.setFixedColumnCount.toString()===S.toString()){return;}t.setFixedColumnCount=S;};C.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(U.getTableBaseType(t)===sap.ui.comp.personalization.TableType.Table){t.detachColumnMove(this._onColumnMove,this);t.detachColumnVisibility(this._onColumnVisibility,this);t.detachColumnResize(this._onColumnResize,this);}};return C;},true);
