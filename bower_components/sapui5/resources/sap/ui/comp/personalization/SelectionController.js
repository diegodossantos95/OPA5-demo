/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','sap/ui/comp/library','./Util','sap/m/P13nSelectionPanel','sap/m/P13nItem','sap/m/P13nSelectionItem'],function(q,B,M,C,U,P,c,d){"use strict";var S=B.extend("sap.ui.comp.personalization.SelectionController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.selection);},metadata:{events:{afterSelectionModelDataChange:{}}}});S.prototype.onAfterSubmit=function(p){if(!p||!p.selection){return;}var D=this.getModel("$sapuicomppersonalizationBaseController").getData();D.persistentData.selection.selectionItems=[];p.selection.selectionItems.forEach(function(s){D.persistentData.selection.selectionItems.push({columnKey:s.getColumnKey(),visible:s.getSelected()});});this.getModel("$sapuicomppersonalizationBaseController").refresh();B.prototype.onAfterSubmit.apply(this,arguments);};S.prototype._getTable2Json=function(){var j=this.createPersistentStructure();var t=this.getTable();if(!t){return j;}var o=this.getColumnMap(true);for(var s in o){var a=o[s];j.selection.selectionItems.push({columnKey:s,text:a.getLabel(),visible:a.getSelected()});}return j;};S.prototype._getTable2JsonRestore=function(){return this._getTable2Json();};S.prototype.syncTable2TransientModel=function(){var i=[];var t=this.getTable();if(!t){return;}var o=this.getColumnMap(true);for(var s in o){var a=o[s];i.push({columnKey:s,text:a.getLabel(),href:a.getHref(),target:a.getTarget(),press:a.getPress()});}var I=this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.selection.items;if(q(i).not(I).length!==0||q(I).not(i).length!==0){this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.selection.items=i;}};S.prototype.getPanel=function(p){return new P({titleLarge:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_SELECTION_TITLE"),items:{path:'$sapmP13nPanel>/transientData/selection/items',template:new c({columnKey:'{$sapmP13nPanel>columnKey}',href:'{$sapmP13nPanel>href}',target:'{$sapmP13nPanel>target}',text:'{$sapmP13nPanel>text}',press:'{$sapmP13nPanel>press}'})},selectionItems:{path:"$sapmP13nPanel>/persistentData/selection/selectionItems",template:new d({columnKey:"{$sapmP13nPanel>columnKey}",selected:"{$sapmP13nPanel>visible}"})},beforeNavigationTo:this.setModelFunction()});};S.prototype.getChangeType=function(D,o){return this.getChangeData(D,o)?sap.ui.comp.personalization.ChangeType.ModelChanged:sap.ui.comp.personalization.ChangeType.Unchanged;};S.prototype.getChangeData=function(D,o){if(!o||!o.selection||!o.selection.selectionItems){return null;}var a={selection:U.copy(D.selection)};if(this._isSemanticEqual(D,o)){return null;}var t=[];a.selection.selectionItems.forEach(function(i){var I=U.getArrayElementByKey("columnKey",i.columnKey,o.selection.selectionItems);if(U.semanticEqual(i,I)){t.push(i);return;}for(var p in i){if(p==="columnKey"||!I){continue;}if(i[p]===I[p]){delete i[p];}}if(Object.keys(i).length<2){t.push(i);}});t.forEach(function(i){var I=U.getIndexByKey("columnKey",i.columnKey,a.selection.selectionItems);a.selection.selectionItems.splice(I,1);});return a;};S.prototype.getUnionData=function(D,o){if(!o||!o.selection||!o.selection.selectionItems){return D.selection?{selection:U.copy(D.selection)}:null;}if(!D||!D.selection||!D.selection.selectionItems){return{selection:U.copy(o.selection)};}var u=this.createPersistentStructure();D.selection.selectionItems.forEach(function(s){var a=U.getArrayElementByKey("columnKey",s.columnKey,o.selection.selectionItems);if(a){if(a.visible!==undefined){s.visible=a.visible;}}u.selection.selectionItems.push(s);});return u;};S.prototype._isSemanticEqual=function(D,o){var s=function(a,b){if(a.visible===true&&(b.visible===false||b.visible===undefined)){return-1;}else if((a.visible===false||a.visible===undefined)&&b.visible===true){return 1;}else if(a.visible===true&&b.visible===true){return 0;}else if((a.visible===false||a.visible===undefined)&&(b.visible===false||b.visible===undefined)){if(a.columnKey<b.columnKey){return-1;}else if(a.columnKey>b.columnKey){return 1;}else{return 0;}}};var e=U.copy(D.selection.selectionItems).sort(s);var f=U.copy(o.selection.selectionItems).sort(s);return!e.some(function(a,i){if(!U.semanticEqual(a,f[i])){return true;}});};S.prototype.exit=function(){B.prototype.exit.apply(this,arguments);};return S;},true);
