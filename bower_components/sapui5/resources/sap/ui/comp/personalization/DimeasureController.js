/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','sap/ui/comp/library','./ChartWrapper','./Util'],function(q,B,M,C,c,U){"use strict";var D=B.extend("sap.ui.comp.personalization.DimeasureController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.dimeasure);},metadata:{events:{afterDimeasureModelDataChange:{}}}});D.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(U.getTableType(t)!==sap.ui.comp.personalization.TableType.ChartWrapper){throw"The provided object is incorrect. 'oTable' has to be an instance of sap.ui.comp.personalization.ChartWrapper. ";}var o=t.getChartObject();o.detachDrilledDown(this._onDrilledDown,this);o.attachDrilledDown(this._onDrilledDown,this);o.detachDrilledUp(this._onDrilledUp,this);o.attachDrilledUp(this._onDrilledUp,this);var a=this;var s=o.setChartType.bind(o);var S=function(b){s(b);var m=a.getModel("$sapuicomppersonalizationBaseController");var d=m.getData();if(b&&b!==d.persistentData.dimeasure.chartTypeKey){a.fireBeforePotentialTableChange();d.persistentData.dimeasure.chartTypeKey=b;a.fireAfterPotentialTableChange();a.fireAfterDimeasureModelDataChange();}};if(o.setChartType.toString()===S.toString()){return;}o.setChartType=S;};D.prototype._onDrilledDown=function(e){this._updateModel(e.getSource());};D.prototype._onDrilledUp=function(e){this._updateModel(e.getSource());};D.prototype._updateModel=function(o){var m=this.getModel("$sapuicomppersonalizationBaseController");var d=m.getData();var a=this.getColumnMap();this.fireBeforePotentialTableChange();d.persistentData.dimeasure.dimeasureItems=[];o.getVisibleDimensions().forEach(function(s){var b=a[s];d.persistentData.dimeasure.dimeasureItems.push({columnKey:s,index:d.persistentData.dimeasure.dimeasureItems.length,visible:true,role:b.getRole()});});o.getVisibleMeasures().forEach(function(s){var b=a[s];d.persistentData.dimeasure.dimeasureItems.push({columnKey:s,index:d.persistentData.dimeasure.dimeasureItems.length,visible:true,role:b.getRole()});});m.refresh();this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange();};D.prototype.createPersistentStructure=function(i){var p=B.prototype.createPersistentStructure.apply(this,arguments);p.dimeasure.chartTypeKey="";return p;};D.prototype.syncJsonModel2Table=function(j){var t=this.getTable();var o=t.getChartObject();var d=[];var m=[];var u=function(a,s,S,g){var b=U.copy(a);b.sort(D._sortByIndex);var e=[];b.forEach(function(f){if(f.visible===true){e.push(f.columnKey);var h=g(f.columnKey);if(h){h.setRole(f.role);}}});if(JSON.stringify(e)!==JSON.stringify(s)){S(e);}};this.fireBeforePotentialTableChange();U.splitDimeasures(j.dimeasure.dimeasureItems,this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.dimeasure.items,d,m);var v=o.getVisibleDimensions();u(d,v,o.setVisibleDimensions.bind(o),o.getDimensionByName.bind(o));var V=o.getVisibleMeasures();u(m,V,o.setVisibleMeasures.bind(o),o.getMeasureByName.bind(o));o.setChartType(j.dimeasure.chartTypeKey);this.fireAfterPotentialTableChange();};D.prototype._getTable2Json=function(){var j=this.createPersistentStructure();this._addPersistentData(this._mapTable2Json(this.getTable()),j);return j;};D.prototype._getDataSuiteFormat2Json=function(d){var j=this.createPersistentStructure();this._addPersistentData(this._mapDataSuiteFormat2Json(d),j);return j;};D.prototype._addPersistentData=function(s,d){var o=this.getColumnMap(true);d.dimeasure.chartTypeKey=s.dimeasure.chartTypeKey;s.dimeasure.dimeasureItems.forEach(function(S){if(!o[S.columnKey]){return;}d.dimeasure.dimeasureItems.push({columnKey:S.columnKey,index:S.index,visible:S.visible,role:S.role});});};D.prototype._mapTable2Json=function(t){var j=this.createPersistentStructure();if(!t){return j;}var o=t.getChartObject();var v=o.getVisibleDimensions();var V=o.getVisibleMeasures();var a=this.getColumnMap(true);var d=v.filter(function(s){return(a[s]&&(a[s].getAggregationRole()===sap.ui.comp.personalization.AggregationRole.Dimension||a[s].getAggregationRole()===sap.ui.comp.personalization.AggregationRole.Measure));}).map(function(s,i){return{columnKey:s,index:i,visible:true,role:a[s].getRole()};});var m=V.filter(function(s){return(a[s]&&(a[s].getAggregationRole()===sap.ui.comp.personalization.AggregationRole.Dimension||a[s].getAggregationRole()===sap.ui.comp.personalization.AggregationRole.Measure));}).map(function(s,i){return{columnKey:s,index:d.length+i,visible:true,role:a[s].getRole()};});j.dimeasure.chartTypeKey=o.getChartType();j.dimeasure.dimeasureItems=d.concat(m);return j;};D.prototype._mapDataSuiteFormat2Json=function(d){var j=this.createPersistentStructure();if(!d.Visualizations||!d.Visualizations.length){return j;}var a=d.Visualizations.filter(function(v){return v.Type==="Chart";});if(!a.length){return j;}var b=[];if(a[0].Content.Dimensions.length&&a[0].Content.DimensionAttributes.length){b=a[0].Content.Dimensions.map(function(s,i){var o=U.getArrayElementByKey("Dimension",s,a[0].Content.DimensionAttributes);return{columnKey:s,index:i,visible:true,role:o?o.Role:this._getDefaultValueOfProperty("role",s,"Dimension")};},this);}var m=[];if(a[0].Content.Measures.length&&a[0].Content.MeasureAttributes.length){m=a[0].Content.Measures.map(function(s,i){var o=U.getArrayElementByKey("Measure",s,a[0].Content.MeasureAttributes);return{columnKey:s,index:b.length+i,visible:true,role:o?o.Role:this._getDefaultValueOfProperty("role",s,"Measure")};},this);}j.dimeasure.dimeasureItems=b.concat(m);j.dimeasure.chartTypeKey=sap.ui.comp.odata.ChartMetadata.getChartType(a[0].Content.ChartType);return j;};D.prototype._getDefaultValueOfProperty=function(p,s,t){var T=this.getTable();if(T&&t==="Dimension"){return T.getChartObject().getDimensionByName(s).getMetadata().getProperty(p).getDefaultValue();}else if(T&&t==="Measure"){return T.getChartObject().getMeasureByName(s).getMetadata().getProperty(p).getDefaultValue();}return undefined;};D.prototype._getTable2JsonRestore=function(a){if(!a){return B.prototype._getTable2JsonRestore.apply(this,arguments);}var j=this.createPersistentStructure();var i=this.getIgnoreColumnKeys();var o=this.getColumnMap();var b=this.getTable().getChartObject();var v=b.getVisibleDimensions();var V=b.getVisibleMeasures();var I=0;a.forEach(function(s){if(i.indexOf(s)>-1){return;}if(o[s].getAggregationRole()===sap.ui.comp.personalization.AggregationRole.NotDimeasure){return;}j.dimeasure.dimeasureItems.push({columnKey:s,index:I,visible:v.indexOf(s)>-1||V.indexOf(s)>-1,role:o[s].getRole()});I++;});j.dimeasure.chartTypeKey=b.getChartType();return j;};D.prototype.syncTable2TransientModel=function(){var i=[];var t=this.getTable();if(!t){return;}var o=this.getColumnMap(true);for(var s in o){var a=o[s];if(a.getAggregationRole()===sap.ui.comp.personalization.AggregationRole.NotDimeasure){continue;}i.push({columnKey:s,text:a.getLabel(),tooltip:a.getTooltip(),aggregationRole:a.getAggregationRole()});}var I=this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.dimeasure.items;if(q(i).not(I).length!==0||q(I).not(i).length!==0){this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.dimeasure.items=i;}};D.prototype.getPanel=function(p){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nDimMeasurePanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nDimMeasureItem");var t=this;var a=[];if(p&&p.availableChartTypes){a=p.availableChartTypes;}var P=new sap.m.P13nDimMeasurePanel({availableChartTypes:a,chartTypeKey:"{$sapmP13nPanel>/persistentData/dimeasure/chartTypeKey}",items:{path:'$sapmP13nPanel>/transientData/dimeasure/items',template:new sap.m.P13nItem({columnKey:'{$sapmP13nPanel>columnKey}',text:'{$sapmP13nPanel>text}',tooltip:'{$sapmP13nPanel>tooltip}',aggregationRole:'{$sapmP13nPanel>aggregationRole}'})},dimMeasureItems:{path:"$sapmP13nPanel>/persistentData/dimeasure/dimeasureItems",template:new sap.m.P13nDimMeasureItem({columnKey:"{$sapmP13nPanel>columnKey}",index:"{$sapmP13nPanel>index}",visible:"{$sapmP13nPanel>visible}",role:"{$sapmP13nPanel>role}"})},beforeNavigationTo:t.setModelFunction(),changeChartType:function(e){t.getModel("$sapuicomppersonalizationBaseController").setProperty("/persistentData/dimeasure/chartTypeKey",e.getParameter("chartTypeKey"));},changeDimMeasureItems:function(e){var m=[];e.getParameter("items").forEach(function(o){m.push({columnKey:o.columnKey,index:o.index,visible:o.visible,role:o.role});});t.getModel("$sapuicomppersonalizationBaseController").setProperty("/persistentData/dimeasure/dimeasureItems",m);}});return P;};D.prototype._isDimMeasureItemEqual=function(d,o){if(!d&&!o){return true;}if(d&&!o){if(d.index===-1&&d.visible===false){return true;}return false;}if(o&&!d){if(o.index===-1&&o.visible===false){return true;}return false;}for(var p in d){if(o[p]===undefined||d[p]!==o[p]){return false;}}return true;};D.prototype._isSemanticEqual=function(p,P){if(p.dimeasure.chartTypeKey!==P.dimeasure.chartTypeKey){return false;}var s=function(a,b){if(a.visible===true&&(b.visible===false||b.visible===undefined)){return-1;}else if((a.visible===false||a.visible===undefined)&&b.visible===true){return 1;}else if(a.visible===true&&b.visible===true){if(a.index<b.index){return-1;}else if(a.index>b.index){return 1;}else{return 0;}}else if((a.visible===false||a.visible===undefined)&&(b.visible===false||b.visible===undefined)){if(a.columnKey<b.columnKey){return-1;}else if(a.columnKey>b.columnKey){return 1;}else{return 0;}}};var d=U.copy(p.dimeasure.dimeasureItems).sort(s);var e=U.copy(P.dimeasure.dimeasureItems).sort(s);var i=true;d.some(function(o,I){if(!this._isDimMeasureItemEqual(o,e[I])){i=false;return true;}},this);return i;};D.prototype.getChangeType=function(p,P){if(!P||!P.dimeasure||!P.dimeasure.dimeasureItems){return sap.ui.comp.personalization.ChangeType.Unchanged;}return this._isSemanticEqual(p,P)?sap.ui.comp.personalization.ChangeType.Unchanged:sap.ui.comp.personalization.ChangeType.TableChanged;};D.prototype.getChangeData=function(p,P){if(!p||!p.dimeasure||!p.dimeasure.dimeasureItems){return this.createPersistentStructure();}if(!P||!P.dimeasure||!P.dimeasure.dimeasureItems){return{chartTypeKey:p.dimeasure.chartTypeKey,dimeasure:U.copy(p.dimeasure)};}if(!this._isSemanticEqual(p,P)){return{chartTypeKey:p.dimeasure.chartTypeKey,dimeasure:U.copy(p.dimeasure)};}return null;};D.prototype.getUnionData=function(d,o){if(!o||!o.dimeasure||!o.dimeasure.dimeasureItems){return{chartTypeKey:d.dimeasure.chartTypeKey,dimeasure:U.copy(d.dimeasure)};}return{dimeasure:{chartTypeKey:o.dimeasure.chartTypeKey?o.dimeasure.chartTypeKey:d.dimeasure.chartTypeKey,dimeasureItems:U.copy(o.dimeasure.dimeasureItems)}};};D.prototype.getDataSuiteFormatSnapshot=function(d){var p=this.getUnionData(this.getPersistentDataRestore(),this.getPersistentData());if(!p.dimeasure||!p.dimeasure.dimeasureItems||!p.dimeasure.dimeasureItems.length){return;}var a=[];var m=[];var t=this.getTransientData();U.splitDimeasures(p.dimeasure.dimeasureItems,t.dimeasure.items,a,m);var b=a.filter(function(o){return!!o.visible;});var e=m.filter(function(o){return!!o.visible;});if(b.length||e.length){if(!d.Visualizations){d.Visualizations=[];}d.Visualizations.push({Type:"Chart",Content:{ChartType:sap.ui.comp.odata.ChartMetadata.getAnnotationChartType(p.dimeasure.chartTypeKey),Dimensions:b.map(function(o){return o.columnKey;}),DimensionAttributes:b.map(function(o){return{Dimension:o.columnKey,Role:o.role};}),Measures:e.map(function(o){return o.columnKey;}),MeasureAttributes:e.map(function(o){return{Measure:o.columnKey,Role:o.role};})}});}};D._sortByIndex=function(a,b){if(a.index<b.index){return-1;}else if(a.index>b.index){return 1;}else{return 0;}};D.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(t){var o=t.getChartObject();if(o){o.detachDrilledDown(this._onDrilledDown,this);o.detachDrilledUp(this._onDrilledUp,this);}}};return D;},true);
