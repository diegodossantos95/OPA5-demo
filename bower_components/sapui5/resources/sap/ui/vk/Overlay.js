/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/vbm/library","sap/ui/vbm/lib/sapvbi","./Messages"],function(q,l,C,v,a,M){"use strict";var O=C.extend("sap.ui.vk.Overlay",{metadata:{library:"sap.ui.vk",properties:{zoomOnResize:{type:"boolean",group:"Behavior",defaultValue:true}},aggregations:{areas:{type:"sap.ui.vk.OverlayArea",multiple:true,singularName:"area"}},associations:{target:{type:"sap.ui.core.Control",cardinality:"0..1"}},events:{click:{parameters:{clientX:{type:"int"},clientY:{type:"int"},pos:{type:"string"}}},contextMenu:{parameters:{pos:{type:"string"},menu:{type:"sap.ui.unified.Menu"}}}}}});O.prototype.getPositionInteractive=function(p,c){if(!this.mIACreateCB&&c&&typeof(c)==="function"){this.mIACreateCB=c;var t="POS";if(p){t+="ARRAY";}var L={"SAPVB":{"Automation":{"Call":{"handler":"OBJECTCREATIONHANDLER","name":"CreateObject","object":"MainScene","scene":"MainScene","instance":"","Param":{"name":"data","#":"{"+t+"}"}}}}};this._load(L);return true;}else{return false;}};O.prototype.openContextMenu=function(m){this._openContextMenu("Overlay",this,m);};O.prototype.setPanAndZoom=function(n,b,z){if(n===0&&b===0&&z===1){return;}var s=this.mVBIContext.GetMainScene();this.totalCenterOffset.dx+=n;this.totalCenterOffset.dy+=b;if(z===1){s.MoveMap(n,b);}else{var c=s.m_Canvas[0];var d=c.m_nExactLOD+Math.log(z)*Math.LOG2E;s.ZoomToGeoPosition(VBI.MathLib.DegToRad([0.5,0.5]),d);s.MoveMap(this.totalCenterOffset.dx,this.totalCenterOffset.dy);}};O.prototype.reset=function(){this.totalCenterOffset.dx=this.totalCenterOffset.dy=0;var s=this.mVBIContext.GetMainScene();if(s){s.ZoomToGeoPosition(VBI.MathLib.DegToRad([0.5,0.5]),this.initialZoom);}return this;};O.prototype.init=function(){this.aLoadQueue=null;this.oTargetDomRef=null;this.mVBIContext=new VBI.VBIContext(this);this.resizeID="";this.resizeIDTarget="";this.bVosDirty=true;this.bWindowsDirty=true;this.bSceneDirty=true;this.bDataDeltaUpdate=false;this.bHandleDataChangeActive=false;this.bForceDataUpdate=false;this.mAddMenuItems=[];this.totalCenterOffset={dx:0,dy:0};this.initialZoom=10;};O.prototype.exit=function(){if(this.mVBIContext){this.mVBIContext.clear();}if(this.resizeID!=""){sap.ui.core.ResizeHandler.deregister(this.resizeID);this.resizeID="";}if(this.resizeIDTarget!=""){sap.ui.core.ResizeHandler.deregister(this.resizeIDTarget);this.resizeIDTarget="";}};O.prototype.resize=function(e){var c=(this.oControl!=undefined)?this.oControl:this;var b=c.mVBIContext;if(b){var s=b.GetMainScene();if(s){if(c.getZoomOnResize()&&e&&e.oldSize.width>0){var z=Math.log(e.size.width/e.oldSize.width)*Math.LOG2E;s.ZoomToGeoPosition(s.GetCenterPos(),s.GetCurrentZoomlevel()+z,false,true,true);}s.resizeCanvas(e,true,true);}}};O.prototype.setTarget=function(t){if(!t){return;}this.setAssociation("target",t);this.reset();if(t instanceof sap.m.Image){t.addDelegate({onAfterRendering:function(e){this.oTargetDomRef=t.getDomRef();this.oTargetDomRef.addEventListener("load",q.proxy(this._adaptSizeOfTarget,this));}.bind(this)});}else{t.addDelegate({onAfterRendering:function(e){this.oTargetDomRef=t.getDomRef();this._adaptSizeOfTarget();}.bind(this)});}if(this.resizeIDTarget!=""){sap.ui.core.ResizeHandler.deregister(this.resizeIDTarget);this.resizeIDTarget="";}this.resizeIDTarget=sap.ui.core.ResizeHandler.register(t,this._adaptSizeOfTarget.bind(this));};O.prototype._adaptSizeOfTarget=function(){var t=this.oTargetDomRef;var d=this.getDomRef();if(t){try{var T=q(t);var p={top:T.offset().top,left:T.offset().left,width:T.outerWidth(),height:T.outerHeight()};q(d).width(p.width).height(p.height).css("position","absolute");q(d).css("top","0px").css("left","0px").css("visibility","");}catch(e){q.sap.log.error(e);}}else{q(d).css("position","fixed").width("0px").height("0px").css("top","0px").css("left","0px").css("visibility","hidden");}};O.prototype.onAfterRendering=function(){if(this.$oldContent.length>0){this.$().append(this.$oldContent);}this._adaptSizeOfTarget();if(this.aLoadQueue){var n;for(n=0;n<this.aLoadQueue.length;++n){this._load(this.aLoadQueue[n]);}this.aLoadQueue=null;}if(this.resizeID==""){this.resize();this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize);}var o=this.getId();if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.Awake(o);}};O.prototype.onBeforeRendering=function(){this.$oldContent=sap.ui.core.RenderManager.findPreservedContent(this.getId());};O.prototype.invalidate=function(s){this.bSceneDirty=true;if(s instanceof sap.ui.vk.OverlayArea){this.bVosDirty=true;this.bDataDeltaUpdate=this.bHandleDataChangeActive;}sap.ui.core.Control.prototype.invalidate.apply(this,arguments);};O.prototype._load=function(d){if(!this.isRendered()){if(!this.aLoadQueue){this.aLoadQueue=[];}this.aLoadQueue.push(d);return;}this._loadHtml(d);};O.prototype._loadHtml=function(d){var o=this.getId();var b=null;if(typeof d=="string"){b=JSON.parse(d.indexOf("{")?d.substr(d.indexOf("{")):d);}else if(typeof d=="object"){b=d;}if(!b){return;}if(!b["SAPVB"]){var m;if(this.mVBIContext&&(m=(new VBI.Adaptor(this.mVBIContext)).CreateLoadData(b))){this.loadHtml(m);return;}else{return;}}var c=false;var e=false;var f=false;if(q.type(b)=="object"){if(b.SAPVB){if(b.SAPVB.Config){this.mVBIContext.GetConfig().load(b.SAPVB.Config,this.mVBIContext);}if(b.SAPVB.Resources){this.mVBIContext.GetResources().load(b.SAPVB.Resources,this.mVBIContext);}if(b.SAPVB.DataTypes){if(!this.mVBIContext["m_DataTypeProvider"]){this.mVBIContext["m_DataTypeProvider"]=new VBI.DataTypeProvider();}this.mVBIContext["m_DataTypeProvider"].load(b.SAPVB.DataTypes,this.mVBIContext);}if(b.SAPVB.Data){if(!this.mVBIContext["m_DataProvider"]){this.mVBIContext["m_DataProvider"]=new VBI.DataProvider();}this.mVBIContext["m_DataProvider"].load(b.SAPVB.Data,this.mVBIContext);c=true;}if(b.SAPVB.Windows){if(!this.mVBIContext["m_Windows"]){this.mVBIContext["m_Windows"]=new VBI.Windows();}this.mVBIContext["m_Windows"].load(b.SAPVB.Windows,this.mVBIContext);f=true;}if(b.SAPVB.Actions){if(!this.mVBIContext["m_Actions"]){this.mVBIContext["m_Actions"]=new VBI.Actions();}this.mVBIContext["m_Actions"].load(b.SAPVB.Actions,this.mVBIContext);}if(b.SAPVB.Automation){if(!this.mVBIContext["m_Automations"]){this.mVBIContext["m_Automations"]=new VBI.Automations();}this.mVBIContext["m_Automations"].load(b.SAPVB.Automation,this.mVBIContext);}if(b.SAPVB.Menus){if(!this.mVBIContext["m_Menus"]){this.mVBIContext["m_Menus"]=new VBI.Menus();}this.mVBIContext["m_Menus"].load(b.SAPVB.Menus,this.mVBIContext);}if(b.SAPVB.Scenes){if(!this.mVBIContext["m_SceneManager"]){this.mVBIContext["m_SceneManager"]=new VBI.SceneManager();}this.mVBIContext["m_SceneManager"].load(b.SAPVB.Scenes,this.mVBIContext);e=true;}}if(c){if(this.mVBIContext["m_Windows"]){this.mVBIContext["m_Windows"].NotifyDataChange();}}if(e||f){if(this.mVBIContext["m_Windows"]){this.mVBIContext["m_Windows"].Awake(o);}}if(e||c){if(this.mVBIContext["m_Windows"]){this.mVBIContext["m_Windows"].RenderAsync();}}}};O.prototype._openContextMenu=function(t,i,m){if(m&&m.vbi_data&&m.vbi_data.VBIName=="DynContextMenu"){if(!this.mVBIContext["m_Menus"]){this.mVBIContext["m_Menus"]=new window.VBI.Menus();}for(var n=0;n<this.mAddMenuItems.length;++n){m.addItem(this.mAddMenuItems[n]);}this.mVBIContext.m_Menus.m_menus.push(m);this._loadHtml({"SAPVB":{"version":"2.0","Automation":{"Call":{"earliest":"0","handler":"CONTEXTMENUHANDLER","instance":i.sId,"name":"SHOW","object":t,"refID":"CTM","Param":[{"name":"x","#":i.mClickPos[0]},{"name":"y","#":i.mClickPos[1]},{"name":"scene","#":"MainScene"}]}}}});}this.mAddMenuItems=[];};O.prototype._update=function(){var A={SAPVB:{}};if(this.bSceneDirty){this._updateScene(A);}this._updateWindows(A);if(A.SAPVB.Actions){Array.prototype.push.apply(A.SAPVB.Actions.Set.Action,this._getActionArray());}return this._minimizeApp(A);};O.prototype._minimizeApp=function(A){var t,s;var c;s=null;if(!this.bWindowsDirty){c=(t=A)&&(t=t.SAPVB)&&(t=t.Windows)&&(s=JSON.stringify(t))&&(s==this.mCurWindows)&&(delete A.SAPVB.Windows);if(!c){this.mCurWindows=s?s:this.mCurWindows;}}else{this.bWindowsDirty=false;}s=null;c=(t=A)&&(t=t.SAPVB)&&(t=t.Scenes)&&(s=JSON.stringify(t))&&(s==this.mCurScenes)&&(delete A.SAPVB.Scenes);if(!c){this.mCurScenes=s?s:this.mCurScenes;}s=null;c=(t=A)&&(t=t.SAPVB)&&(t=t.Actions)&&(s=JSON.stringify(t))&&(s==this.mCurActions)&&(delete A.SAPVB.Actions);if(!c){this.mCurActions=s?s:this.mCurActions;}s=null;c=(t=A)&&(t=t.SAPVB)&&(t=t.DataTypes)&&(s=JSON.stringify(t))&&(s==this.mCurDataTypes)&&(delete A.SAPVB.DataTypes);if(!c){this.mCurDataTypes=s?s:this.mCurDataTypes;}if(!this.bForceDataUpdate){s=null;c=(t=A)&&(t=t.SAPVB)&&(t=t.Data)&&(s=JSON.stringify(t))&&(s==this.mCurData)&&(delete A.SAPVB.Data);if(!c){this.mCurData=s?s:this.mCurData;}}else{this.bForceDataUpdate=false;}return A;};O.prototype._updateWindows=function(A){A.SAPVB.Windows={"Set":[{"name":"Main","Window":{"id":"Main","caption":"MainWindow","type":"geo","refParent":"","refScene":"MainScene","modal":"true"}}]};};O.prototype._updateScene=function(A){var s=[];var b=[];var c=[];var d=[];this._updateVOData(s,b,c,d);var _=JSON.stringify(s);var m=true;if(!this.saVO){((((A.SAPVB.Scenes={}).Set={}).SceneGeo={id:"MainScene",scaleVisible:"false",navControlVisible:"false",VisualFrame:{minLOD:5},NavigationDisablement:{move:"true",zoom:"true"},initialZoom:this.initialZoom.toString(),initialStartPosition:"0.5;0.5;0"}).VO=s);}else if(this.bRefMapLayerStackDirty||!(this.saVO===_)){(A.SAPVB.Scenes=this._getSceneVOdelta(JSON.parse(this.m_saVO),s));}else{m=false;}this.saVO=_;if(this.bDataDeltaUpdate){A.SAPVB.Data=[];for(var n=0;n<b.length;++n){A.SAPVB.Data.push({Set:{name:b[n].name,type:"N",N:b[n]}});}}else{((A.SAPVB.Data={}).Set={}).N=b;}if(m){(((A.SAPVB.DataTypes={}).Set={}).N=c);}(((A.SAPVB.Actions={}).Set={}).Action=d);this.bSceneDirty=this.bVosDirty=this.bDataDeltaUpdate=false;};O.prototype._isEventRegistered=function(A,e){var b=this.getAggregation(A);if(!b){return false;}for(var n=0;n<b.length;++n){var i=b[n];if(i.hasListeners(e)){return true;}}return false;};O.prototype._getTemplateBindingInfo=function(A){var b=this.getBindingInfo(A);if(b&&b.template){return b.template.mBindingInfos;}};O.prototype._getBindInfo=function(A){var b={};var t=this._getTemplateBindingInfo(A);b.C=(t)?t.hasOwnProperty("color"):true;b.CB=(t)?t.hasOwnProperty("colorBorder"):true;b.DCH=(t)?t.hasOwnProperty("deltaColorHot"):true;b.CS=(t)?t.hasOwnProperty("colorSelect"):true;b.CNS=(t)?t.hasOwnProperty("colorNonSelect"):true;b.TT=(t)?t.hasOwnProperty("tooltip"):true;b.M=(t)?t.hasOwnProperty("changeable"):true;b.hasTemplate=(t)?true:false;return b;};O.prototype._updateVOData=function(s,b,c,d){var B,V;this.AreaBindInfo=B=(this.AreaBindInfo)?this.AreaBindInfo:this._getBindInfo("areas");V=(B.hasTemplate)?this.getBindingInfo("areas").template:null;var o={id:"OverlayArea",datasource:"OverlayArea",type:"{00100000-2012-0004-B001-F311DE491C77}"};o["posarray.bind"]=o.id+".P";if(B.C){o["color.bind"]=o.id+".C";}else{o.color=V.getColor();}if(B.CB){o["colorBorder.bind"]=o.id+".C";}else{o.colorBorder=V.getColorBorder();}if(B.DCH){o["hotDeltaColor.bind"]=o.id+".DCH";}else{o.hotDeltaColor=V.getDeltaColorHot();}if(B.CS){o["colorSelect.bind"]=o.id+".C";}else{o.colorSelect=V.getColorSelect();}if(B.CNS){o["colorNonSelect.bind"]=o.id+".C";}else{o.colorNonSelect=V.getColorNonSelect();}if(!B.M){o["VB:c"]=V.getChangeable();}s.push(o);var e={name:o.id,key:"K"};e.A=[{"name":"K","alias":"K","type":"string"},{"name":"VB:s","alias":"VB:s","type":"boolean"},{"name":"P","alias":"P","type":"vectorarray","changeable":"true"}];if(B.C){e.A.push({"name":"C","alias":"C","type":"color"});}if(B.CB){e.A.push({"name":"CB","alias":"CB","type":"string"});}if(B.DCH){e.A.push({"name":"DCH","alias":"DCH","type":"string"});}if(B.CS){e.A.push({"name":"CS","alias":"CS","type":"string"});}if(B.CNS){e.A.push({"name":"CNS","alias":"CNS","type":"string"});}if(B.TT){e.A.push({"name":"TT","alias":"TT","type":"string"});}c.push(e);var i=o.id;if(this._isEventRegistered("areas","click")){d.push({"id":i+"1","name":"click","refScene":"MainScene","refVO":i,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});}if(this._isEventRegistered("areas","contextMenu")){d.push({"id":i+"2","name":"contextMenu","refScene":"MainScene","refVO":i,"refEvent":"ContextMenu"});}if(this._isEventRegistered("areas","edgeClick")){d.push({"id":i+"7","name":"edgeClick","refScene":"MainScene","refVO":i,"refEvent":"EdgeClick"});}d.push({"id":i+"4","name":"handleMoved","refScene":"MainScene","refVO":i,"refEvent":"HandleMoved"});d.push({"id":i+"5","name":"handleContextMenu","refScene":"MainScene","refVO":i,"refEvent":"HandleContextMenu"});d.push({"id":i+"8","name":"edgeContextMenu","refScene":"MainScene","refVO":i,"refEvent":"EdgeContextMenu"});if(this._isEventRegistered("areas","handleClick")){d.push({"id":i+"6","name":"handleClick","refScene":"MainScene","refVO":i,"refEvent":"HandleClick"});}var f={name:o.id,E:[]};var g=this.getAreas();for(var n=0;n<g.length;++n){f.E.push(g[n].getDataElement());}b.push(f);};O.prototype._getSceneVOdelta=function(c,n){var V=[];var r=[];var o={};for(var b=0,d=c.length;b<d;++b){o[c[b].id]=c[b];}for(var e=0;e<n.length;++e){if(o[n[e].id]){if(JSON.stringify(n[e])!=JSON.stringify(o[n[e].id])){r.push({"id":n[e].id,"type":"VO"});V.push(n[e]);}}else{V.push(n[e]);}delete o[n[e].id];}for(var i in o){r.push({"id":i,"type":"VO"});}var f={"Merge":{"name":"MainScene","type":"SceneGeo","SceneGeo":{"id":"MainScene"}}};if(r.length){f.Merge.SceneGeo.Remove=r;}if(V.length){f.Merge.SceneGeo.VO=V;}return f;};O.prototype._getActionArray=function(){var A=[];if(this.mEventRegistry["click"]){A.push({"id":"Overlay1","name":"click","refScene":"MainScene","refVO":"Map","refEvent":"Click","AddActionProperty":[{"name":"pos"}]});}if(this.mEventRegistry["contextMenu"]){A.push({"id":"Overlay2","name":"contextMenu","refScene":"MainScene","refVO":"Map","refEvent":"ContextMenu","AddActionProperty":[{"name":"pos"}]});}A.push({"id":"Overlay3","name":"GetPosComplete","refScene":"MainScene","refVO":"General","refEvent":"CreateComplete"});return A;};O.prototype._handleChangedData=function(n){try{this.bHandleDataChangeActive=true;if(n&&n.length){for(var b=0,N;b<n.length;++b){N=n[b];if(N.E&&N.E.length){for(var c=0,e,i;c<N.E.length;++c){e=N.E[c];i=this._findInstance(e.K);if(i){i.handleChangedData(e);}}}}}this.bHandleDataChangeActive=false;}catch(d){this.bHandleDataChangeActive=false;throw d;}};O.prototype._findInstance=function(i){var I=(i.indexOf(".")!==-1)?i.split(".")[1]:i;var A=this.getAreas();for(var n=0;n<A.length;++n){var e=A[n];if(e.getId()===I){return e;}}return null;};O.prototype._handleAggregationEvent=function(e){var E;if((E=this._findInstance(e.Action.instance))){try{E.handleEvent(e);}catch(b){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT11.summary),M.VIT11.code,"sap.ui.vk.Overlay");}}};O.prototype.isRendered=function(){return this.getDomRef()?true:false;};O.prototype.fireSubmit=function(e){var d=JSON.parse(e.data);if(d.Data&&d.Data.Merge){this._handleChangedData(d.Data.Merge.N);}if(d.Action.object==="OverlayArea"){this._handleAggregationEvent(d);}else{var A=d.Action.name,c;if(A==="click"||A==="contextMenu"){c=[d.Action.Params.Param[0]["#"],d.Action.Params.Param[1]["#"]];}switch(A){case"GetPosComplete":if(this.mIACreateCB){try{this.mIACreateCB(d.Action.Params.Param[0]["#"]);this.mIACreateCB=null;}catch(b){this.mIACreateCB=null;throw b;}}break;case"click":this.fireClick({clientX:c[0],clientY:c[1],pos:d.Action.AddActionProperties.AddActionProperty[0]["#"]});break;case"contextMenu":if(this.mVBIContext.m_Menus){this.mVBIContext.m_Menus.deleteMenu("DynContextMenu");}sap.ui.getCore().loadLibrary("sap.ui.unified");var m=new sap.ui.unified.Menu();m["vbi_data"]={};m["vbi_data"].menuRef="CTM";m["vbi_data"].VBIName="DynContextMenu";this.mClickPos=c;this.fireContextMenu({pos:d.Action.AddActionProperties.AddActionProperty[0]["#"],menu:m});break;default:break;}}};O.prototype.fireRender=function(d){};O.prototype.fireMove=function(d){};O.prototype.fireZoom=function(d){};O.prototype.fireOpenWindow=function(d){};O.prototype.fireCloseWindow=function(d){};return O;});
