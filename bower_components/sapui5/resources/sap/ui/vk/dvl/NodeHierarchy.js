/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../NodeHierarchy","sap/ui/base/ObjectPool","./BaseNodeProxy","./NodeProxy","./LayerProxy","../Messages"],function(q,l,N,O,B,a,L,M){"use strict";var g=sap.ui.vk.dvl.getJSONObject;var s={modeDictionary:{equals:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL_CASE_INSENSITIVE;},contains:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING_CASE_INSENSITIVE;},startsWith:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH_CASE_INSENSITIVE;}}};var b=N.extend("sap.ui.vk.dvl.NodeHierarchy",{metadata:{publicMethods:["createLayerProxy","createNode","createNodeCopy","createNodeProxy","destroyLayerProxy","destroyNodeProxy","enumerateAncestors","enumerateChildren","findNodesById","findNodesByMetadata","findNodesByName","getAncestors","getChildren","getGraphicsCore","getLayers","getSceneRef","getScene","removeNode"]},_baseNodeProxyPool:new O(B),constructor:function(c){N.call(this);this._graphicsCore=c.getGraphicsCore();this._scene=c;this._dvlSceneRef=this._scene.getSceneRef();this._dvl=this._graphicsCore._getDvl();this._nodeProxies=[];this._layerProxies=[];}});b.prototype.destroy=function(){this._layerProxies.slice().forEach(this.destroyLayerProxy,this);this._nodeProxies.slice().forEach(this.destroyNodeProxy,this);this._dvl=null;this._dvlSceneRef=null;this._scene=null;this._graphicsCore=null;N.prototype.destroy.call(this);};b.prototype.getGraphicsCore=function(){return this._graphicsCore;};b.prototype.getScene=function(){return this._scene;};b.prototype.getSceneRef=function(){return this._dvlSceneRef;};b.prototype.enumerateChildren=function(n,c,d,p){if(typeof n==="function"){p=d;d=c;c=n;n=undefined;}var e;if(n){if(d||(g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){e=g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes;}else{e=[];}}else{e=g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes;}if(p){e.forEach(c);}else{var f=this._baseNodeProxyPool.borrowObject();try{e.forEach(function(n){f.init(this,n);c(f);f.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(f);}}return this;};b.prototype.enumerateAncestors=function(n,c,p){var d=g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;if(p){d.forEach(c);}else{var e=this._baseNodeProxyPool.borrowObject();try{d.forEach(function(n){e.init(this,n);c(e);e.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(e);}}return this;};b.prototype.createNodeProxy=function(n){var c=new a(this,n);this._nodeProxies.push(c);return c;};b.prototype.destroyNodeProxy=function(n){var i=this._nodeProxies.indexOf(n);if(i>=0){this._nodeProxies.splice(i,1)[0].destroy();}return this;};b.prototype.getChildren=function(n,c){if(typeof n==="boolean"){c=n;n=undefined;}if(n){if(c||(g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){return g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes;}else{return[];}}else{return g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes;}};b.prototype.getAncestors=function(n){return g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;};b.prototype.findNodesByName=function(c){var d=sap.ve.dvl.DVLFINDNODETYPE.DVLFINDNODETYPE_NODE_NAME,e=[],f,h;if(c===undefined||c===null||q.isEmptyObject(c)){f=s.modeDictionary.contains(false);h=[""];}else{if(c.value===undefined||c.value===null||c.value===""){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT6.summary),M.VIT6.code,"sap.ui.vk.dvl.NodeHierarchy");}var p=c.hasOwnProperty("predicate")?c.predicate:"equals";if(p===undefined||p===null||p===""){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT7.summary),M.VIT7.code,"sap.ui.vk.dvl.NodeHierarchy");}else if(["equals","contains","startsWith"].indexOf(p)===-1){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT8.summary),M.VIT8.code,"sap.ui.vk.dvl.NodeHierarchy");}f=s.modeDictionary[p](c.caseSensitive);h=(typeof c.value==="string")?[c.value]:c.value;}for(var i=0;i<h.length;i++){e=e.concat(g(this._dvl.Scene.FindNodes(this._dvlSceneRef,d,f,h[i])).nodes);}return q.sap.unique(e);};b.prototype.createLayerProxy=function(c){var d=new L(this,c);this._layerProxies.push(d);return d;};b.prototype.destroyLayerProxy=function(c){var i=this._layerProxies.indexOf(c);if(i>=0){this._layerProxies.splice(i,1)[0].destroy();}return this;};b.prototype.getLayers=function(){return g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_LAYERS)).Layers;};b.prototype.getHotspotNodeIds=function(){var h=g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return h.length>0?h:this._getLegacyHotspotNodeIds();};b.prototype._getLegacyHotspotNodeIds=function(){var c=this.getLayers(),h=[];for(var i=0;i<c.length;i++){var d=this.createLayerProxy(c[i]),e=d.getName();if(e.toLowerCase()==="hotspots"){h=d.getNodes();this.destroyLayerProxy(d);break;}this.destroyLayerProxy(d);}return h;};b.prototype.createNode=function(p,n,i){var c=this._dvl.Scene.CreateNode(this._dvlSceneRef,p,n,i);this.fireNodeCreated({nodeRef:c,nodeId:c});this.fireChanged();return c;};b.prototype.createNodeCopy=function(n,p,c,i){var d=this._dvl.Scene.CreateNodeCopy(this._dvlSceneRef,n,p,sap.ve.dvl.DVLCREATENODECOPYFLAG.COPY_CHILDREN,c,i);this.fireNodeCreated({nodeRef:d,nodeId:d});this.fireChanged();return d;};b.prototype.removeNode=function(n){this.fireNodeRemoving({nodeRef:n,nodeId:n});this._dvl.Scene.DeleteNode(this._dvlSceneRef,n);this.fireChanged();return this;};return b;});
