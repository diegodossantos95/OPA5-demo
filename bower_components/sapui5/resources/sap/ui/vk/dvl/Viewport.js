/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../ViewportBase","sap/ui/core/ResizeHandler","../Loco","../ViewportHandler","../Smart2DHandler","../Messages","../ContentConnector","../ViewStateManager","./GraphicsCore"],function(q,l,V,R,L,a,S,M,C,b,G){"use strict";var d={encodedProjectionType:{},decodedProjectionType:{},encodedBindingType:{},decodedBindingType:{},decodedZoomTo:{}};d.decodedProjectionType[sap.ui.vk.CameraProjectionType.Perspective]=sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE;d.decodedProjectionType[sap.ui.vk.CameraProjectionType.Orthographic]=sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC;d.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE]=sap.ui.vk.CameraProjectionType.Perspective;d.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC]=sap.ui.vk.CameraProjectionType.Orthographic;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Minimum]=sap.ve.dvl.DVLCAMERAFOVBINDING.MIN;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Maximum]=sap.ve.dvl.DVLCAMERAFOVBINDING.Max;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Horizontal]=sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Vertical]=sap.ve.dvl.DVLCAMERAFOVBINDING.VERT;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MIN]=sap.ui.vk.CameraFOVBindingType.Minimum;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MAX]=sap.ui.vk.CameraFOVBindingType.Maximum;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ]=sap.ui.vk.CameraFOVBindingType.Horizontal;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.VERT]=sap.ui.vk.CameraFOVBindingType.Vertical;d.decodedZoomTo[sap.ui.vk.ZoomTo.All]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_ALL;d.decodedZoomTo[sap.ui.vk.ZoomTo.Visible]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_VISIBLE;d.decodedZoomTo[sap.ui.vk.ZoomTo.Selected]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_SELECTED;d.decodedZoomTo[sap.ui.vk.ZoomTo.Node]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_NODE;d.decodedZoomTo[sap.ui.vk.ZoomTo.NodeSetIsolation]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_NODE_SETISOLATION;d.decodedZoomTo[sap.ui.vk.ZoomTo.Restore]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_RESTORE;d.decodedZoomTo[sap.ui.vk.ZoomTo.RestoreRemoveIsolation]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_RESTORE_REMOVEISOLATION;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewLeft]=sap.ve.dvl.DVLZOOMTO.VIEW_LEFT;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewRight]=sap.ve.dvl.DVLZOOMTO.VIEW_RIGHT;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewTop]=sap.ve.dvl.DVLZOOMTO.VIEW_TOP;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewBottom]=sap.ve.dvl.DVLZOOMTO.VIEW_BOTTOM;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewBack]=sap.ve.dvl.DVLZOOMTO.VIEW_BACK;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewFront]=sap.ve.dvl.DVLZOOMTO.VIEW_FRONT;var c=V.extend("sap.ui.vk.dvl.Viewport",{metadata:{library:"sap.ui.vk",publicMethods:["beginGesture","endGesture","getGraphicsCore","getViewInfo","hitTest","pan","queueCommand","rotate","setGraphicsCore","setScene","setViewInfo","tap","zoom"],properties:{showAllHotspots:{type:"boolean",defaultValue:false},hotspotColorABGR:{type:"int",defaultValue:0xc00000ff},hotspotColor:{type:"sap.ui.core.CSSColor",defaultValue:"rgba(255, 0, 0, 0.7529411764705882)"},backgroundColorTopABGR:{type:"int",defaultValue:0xff000000},backgroundColorBottomABGR:{type:"int",defaultValue:0xffffffff}},events:{urlClicked:{parameters:{nodeRef:"any",url:"string"},enableEventBubbling:true},nodeClicked:{parameters:{nodeRef:"any",x:"int",y:"int"},enableEventBubbling:true},pan:{parameters:{dx:"int",dy:"int"}},zoom:{parameters:{zoomFactor:"float"}},rotate:{parameters:{dx:"int",dy:"int"}},viewActivated:{parameters:{type:{type:"string"}}},frameRenderingFinished:{}}}});var e=c.getMetadata().getParent().getClass().prototype;c.prototype.init=function(){if(e.init){e.init.call(this);}this._graphicsCore=null;this._dvl=null;this._dvlRendererId=null;this._viewStateManager=null;this._canvas=null;this._resizeListenerId=null;this._is2D=false;this._viewportHandler=new a(this);this._loco=new L();this._loco.addHandler(this._viewportHandler);this._smart2DHandler=null;this._lastPlayedStep=null;this._contentConnector=null;};c.prototype.exit=function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._clearContentConnector();this.setViewStateManager(null);this.setScene(null);this.setGraphicsCore(null);if(e.exit){e.exit.call(this);}};c.prototype.setGraphicsCore=function(i){if(i!=this._graphicsCore){if(this._graphicsCore){this._dvl.Client.detachFrameFinished(this._handleFrameFinished,this);this._dvl.Client.detachStepEvent(this._updateLastPlayedStep,this);this._dvl.Renderer.SetViewStateManager(null,this._dvlRendererId);this._graphicsCore._deregisterViewport(this);this._dvl=null;}this._graphicsCore=i;if(this._graphicsCore){this._dvl=this._graphicsCore._getDvl();this._graphicsCore._registerViewport(this);this.setShowDebugInfo(this.getShowDebugInfo());this._dvl.Client.attachStepEvent(this._updateLastPlayedStep,this);this._dvl.Client.attachFrameFinished(this._handleFrameFinished,this);this._dvl.Renderer.SetViewStateManager(this._viewStateManager,this._dvlRendererId);}}return this;};c.prototype.getGraphicsCore=function(){return this._graphicsCore;};c.prototype._setCanvas=function(i){var j=this.getDomRef()&&this._canvas!==i;this._canvas=i;if(j){this.invalidate();}return this;};c.prototype._setRenderer=function(i){this._dvlRendererId=i;return this;};c.prototype._updateLastPlayedStep=function(i){if(i.type===sap.ve.dvl.DVLSTEPEVENT.DVLSTEPEVENT_STARTED){this._lastPlayedStep=i.stepId;}};c.prototype.setScene=function(i){if(this._dvlRendererId){this._dvl.Renderer.AttachScene(i&&i.getSceneRef()||null,this._dvlRendererId);this._dvlSceneRef=i?i.getSceneRef():null;if(i){this._dvl.Client.attachUrlClicked(this._fireUrlClicked,this);var j=this._isSmart2DContent()||this._isSmart2DContentLegacy();if(j){this._dvl.Renderer.SetBackgroundColor(1,1,1,1,1,1,1,1,this._dvlRendererId);}else{var t=this._getDecomposedABGR(this.getBackgroundColorTopABGR());var n=this._getDecomposedABGR(this.getBackgroundColorBottomABGR());this._dvl.Renderer.SetBackgroundColor(t.red,t.green,t.blue,t.alpha,n.red,n.green,n.blue,n.alpha,this._dvlRendererId);}this.fireViewActivated({type:j?"2D":"3D"});}else{this._dvl.Client.detachUrlClicked(this._fireUrlClicked,this);if(this._smart2DHandler){var u=new L();u.removeHandler(this._smart2DHandler);}this.invalidate();}}return this;};c.prototype._isSmart2DContent=function(){var i=sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return i&&i.length>0;};c.prototype._isSmart2DContentLegacy=function(){var i=this._dvl.Scene.GetCurrentCamera(this._dvlSceneRef),j=this._dvl.Camera.GetRotation(i),n=this._dvl.Camera.GetProjection(i);return j[0]===90&&j[1]===-90&&j[2]===0&&n===sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC;};c.prototype._initializeSmart2DHandler=function(){if(this._viewStateManager){if(this._smart2DHandler){this._loco.removeHandler(this._smart2DHandler);}this._smart2DHandler=new S(this,this._viewStateManager);this._loco.addHandler(this._smart2DHandler);}if(this.getShowAllHotspots()){var n=this._viewStateManager.getNodeHierarchy(),i=n.getHotspotNodeIds();this.showHotspots(i,true);}};c.prototype._fireUrlClicked=function(i){this.fireUrlClicked({url:i.url,nodeRef:i.nodeRef,nodeId:i.nodeId});};c.prototype.setHotspotColorABGR=function(v){this.setProperty("hotspotColorABGR",v,true);this.setProperty("hotspotColor",sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(this.getProperty("hotspotColorABGR"))),true);return this;};c.prototype.setHotspotColor=function(v){this.setProperty("hotspotColor",v,true);this.setProperty("hotspotColorABGR",sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(this.getProperty("hotspotColor"))),true);return this;};c.prototype._getStepAndProcedureIndexes=function(n,t){var u=-1,v=-1,w=false;for(var i=0;i<n.length;i++){if(!w){for(var j=0;j<n[i].steps.length;j++){if(n[i].steps[j].id===t){v=j;u=i;w=true;break;}}}else{break;}}return{stepIndex:v,procedureIndex:u};};c.prototype._getStepVeIdById=function(i){if(i){var v=this._dvl.Scene.RetrieveVEIDs(this._dvlSceneRef,i);if(Array.isArray(v)){for(var j=0,n=v.length;j<n;++j){var t=v[j];if(t.source==="SAP"&&t.type==="VE_VIEWPORT"&&Array.isArray(t.fields)){for(var u=0,w=t.fields.length;u<w;++u){var x=t.fields[u];if(x.name==="ID"){return x.value;}}}}}}return null;};c.prototype._getStepIdByVeId=function(i,j){for(var n=0,t=i.length;n<t;++n){var u=i[n].steps;for(var v=0,w=u.length;v<w;++v){var x=u[v].id;if(this._getStepVeIdById(x)===j){return x;}}}return null;};var s=function(i){i.camera={};};var f=function(i){if(typeof i.camera==="object"&&i.camera!==null){i.camera.matrices=false;}};var g=function(i){if(typeof i.camera==="object"&&i.camera!==null){i.camera.useTransitionCamera=false;}};var h=function(i){i.animation=true;};var k=function(i){i.visibility=false;};var m=function(i){if(typeof i.visibility==="object"&&i.visibility!==null){i.visibility.mode=sap.ui.vk.VisibilityMode.Complete;}};c.prototype.getViewInfo=function(i){if(!this._dvlSceneRef){return null;}var j={};if(typeof i!=="object"||i===null){s(j);f(j);g(j);h(j);k(j);m(j);}else{if(typeof i.camera==="object"&&i.camera!==null){j.camera={};if(typeof i.camera.matrices==="boolean"){j.camera.matrices=i.camera.matrices;}else if("matrices"in i.camera){j.camera.matrices=false;}else{f(j);}if(typeof i.camera.useTransitionCamera==="boolean"){j.camera.useTransitionCamera=i.camera.useTransitionCamera;}else if("useTransitionCamera"in i.camera){j.camera.useTransitionCamera=false;}else{g(j);}}else if(typeof i.camera==="boolean"){if(i.camera===true){j.camera={};f(j);g(j);}else{j.camera=false;}}else if("camera"in i){j.camera=false;}else{s(j);f(j);g(j);}if(typeof i.animation==="boolean"){j.animation=i.animation;}else if("animation"in i){j.animation=false;}else{h(j);}if(typeof i.visibility==="object"&&i.visibility!==null){j.visibility={};if(i.visibility.mode===sap.ui.vk.VisibilityMode.Complete||i.visibility.mode===sap.ui.vk.VisibilityMode.Differences){j.visibility.mode=i.visibility.mode;}else{m(j);}}else if(typeof i.visibility==="boolean"){if(i.visibility===true){j.visibility={};m(j);}else{j.visibility=false;}}else if("visibility"in i){j.visibility=false;}else{k(j);m(j);}}var v={};if(j.camera){var n=null;if(j.camera.useTransitionCamera){n=this._dvl.Renderer.GetTransitionCamera(this._dvlRendererId);if(n===sap.ve.dvl.DVLID_INVALID){n=null;}}if(n===null){n=this._dvl.Renderer.GetCurrentCamera(this._dvlRendererId);}var t=this._dvl.Camera.GetRotation(n),u=this._dvl.Camera.GetOrigin(n);v.camera={rotation:{yaw:t[0],pitch:t[1],roll:t[2]},position:{x:u[0],y:u[1],z:u[2]},projectionType:d.encodedProjectionType[this._dvl.Camera.GetProjection(n)],bindingType:d.encodedBindingType[this._dvl.Camera.GetFOVBinding(n)]};if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective){v.camera.fieldOfView=this._dvl.Camera.GetFOV(n);}else if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){v.camera.zoomFactor=this._dvl.Camera.GetOrthoZoomFactor(n);}if(j.camera.matrices){var w=this._dvl.Renderer.GetCameraMatrices(this._dvlRendererId);v.camera.matrices={view:w.view,projection:w.projection};}}if(j.animation){var x=this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_STEP_INFO),y=x.StepId!==sap.ve.dvl.DVLID_INVALID;var z=y?x.StepId:this._lastPlayedStep,A=y?x.StepTime:0,B=this._dvl.Scene.RetrieveProcedures(this._dvlSceneRef),D=this._getStepAndProcedureIndexes(B.procedures,z),E=this._getStepVeIdById(z);v.animation={animationTime:A,stepIndex:D.stepIndex,procedureIndex:D.procedureIndex};if(E){v.animation.stepVeId=E;}}if(j.visibility&&this._viewStateManager){v.visibility={mode:j.visibility.mode};if(j.visibility.mode===sap.ui.vk.VisibilityMode.Complete){var F=this._viewStateManager.getVisibilityComplete();v.visibility.visible=F.visible;v.visibility.hidden=F.hidden;}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){v.visibility.changes=this._viewStateManager.getVisibilityChanges();}else{q.sap.log.warning(sap.ui.vk.getResourceBundle().getText(M.VIT32.summary),M.VIT32.code,"sap.ui.vk.dvl.Viewport");}}return v;};c.prototype.setViewInfo=function(v,i){var j=false;if(v.animation){var n=this._dvl.Scene.RetrieveProcedures(this._dvlSceneRef),t=v.animation.procedureIndex,u=v.animation.stepIndex,w=v.animation.stepVeId,x,y=v.animation.animationTime||0;if(w||u>=0&&t>=0){if(w){x=this._getStepIdByVeId(n.procedures,v.animation.stepVeId);}else if(t>=0&&t<n.procedures.length){if(u>=0&&u<n.procedures[t].steps.length){x=n.procedures[t].steps[u].id;}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT26.summary),M.VIT26.code,"sap.ui.vk.dvl.Viewport");}}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT27.summary),M.VIT27.code,"sap.ui.vk.dvl.Viewport");}if(x){this._dvl.Renderer.ActivateStep(this._dvlRendererId,x,false,false,y);this._dvl.Renderer.PauseCurrentStep(this._dvlRendererId);}}else{j=true;}}if(v.camera){var z;if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective||v.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){z=d.decodedProjectionType[v.camera.projectionType];}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT19.summary),M.VIT19.code,"sap.ui.vk.dvl.Viewport");z=sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE;}var A=this._dvl.Scene.CreateCamera(this._dvlSceneRef,z,sap.ve.dvl.DVLID_INVALID);if(z===sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE){this._dvl.Camera.SetFOV(A,v.camera.fieldOfView);}else if(z===sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC){this._dvl.Camera.SetOrthoZoomFactor(A,v.camera.zoomFactor);}if(v.camera.position){this._dvl.Camera.SetOrigin(A,v.camera.position.x,v.camera.position.y,v.camera.position.z);}if(v.camera.rotation){this._dvl.Camera.SetRotation(A,v.camera.rotation.yaw,v.camera.rotation.pitch,v.camera.rotation.roll);}if(v.camera.bindingType){var B=d.decodedBindingType[v.camera.bindingType]||sap.ve.dvl.DVLCAMERAFOVBINDING.MIN;this._dvl.Camera.SetFOVBinding(A,B);}i=i||0;this._dvl.Renderer.ActivateCamera(this._dvlRendererId,A,i);this._dvl.Scene.DeleteNode(this._dvlSceneRef,A);}if(v.visibility){var D=this._viewStateManager.getNodeHierarchy(),E=new Map(),F=D.findNodesByName();F.forEach(function(J){var K=D.createNodeProxy(J),N=q.grep(K.getVeIds(),function(N){return N.type==="VE_LOCATOR";});N=Array.isArray(N)&&N.length>0?N[0].fields[0].value:null;D.destroyNodeProxy(K);if(N){E.set(N,J);}});switch(v.visibility.mode){case sap.ui.vk.VisibilityMode.Complete:var H=v.visibility.visible,I=v.visibility.hidden;H.forEach(function(J){this._viewStateManager.setVisibilityState(E.get(J),true,false);},this);I.forEach(function(J){this._viewStateManager.setVisibilityState(E.get(J),false,false);},this);break;case sap.ui.vk.VisibilityMode.Differences:if(j){this.resetView({camera:false,visibility:true,transition:false});}v.visibility.changes.forEach(function(J){var K=E.get(J);if(K){this._viewStateManager.setVisibilityState(K,!this._viewStateManager.getVisibilityState(K),false);}},this);break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.dvl.Viewport");break;}}return this;};c.prototype.getOutputSize=function(){var i=this.getViewInfo().camera.bindingType,j=this.getDomRef().getBoundingClientRect(),v=j.width,n=j.height,t;switch(d.decodedBindingType[i]){case sap.ve.dvl.DVLCAMERAFOVBINDING.MIN:t=Math.min(v,n);break;case sap.ve.dvl.DVLCAMERAFOVBINDING.MAX:t=Math.max(v,n);break;case sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ:t=v;break;case sap.ve.dvl.DVLCAMERAFOVBINDING.VERT:t=n;break;default:break;}return{left:(v-t)/2,top:(n-t)/2,sideLength:t};};c.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}};c.prototype.onAfterRendering=function(){if(this._canvas){var i=this.getDomRef();i.appendChild(this._canvas);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:i.clientWidth,height:i.clientHeight}});}};c.prototype._handleResize=function(i){if(this._dvlRendererId&&this._canvas){var j=i.size.width*window.devicePixelRatio;var n=i.size.height*window.devicePixelRatio;this._dvl.Renderer.SetDimensions(j,n,this._dvlRendererId);this._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*window.devicePixelRatio,this._dvlRendererId);this._canvas.width=j;this._canvas.height=n;this._canvas.style.width=i.size.width+"px";this._canvas.style.height=i.size.height+"px";this.fireResize({size:{width:i.size.width,height:i.size.height}});return true;}};c.prototype._handleVisibilityChanged=c.prototype._handleSelectionChanged=c.prototype._handleOpacityChanged=c.prototype._handleTintColorChanged=function(i){if(this._dvlRendererId){this._dvl.Renderer.ForceRenderFrame(this._dvlRendererId);}};c.prototype.showHotspots=function(n,i,j){var t=sap.ui.vk.dvl.NodeProxy.prototype[typeof j==="string"?"setTintColor":"setTintColorABGR"];var u=function(w,j,A){var B=w.createNodeProxy(A);t.call(B,j);w.destroyNodeProxy(B);};if(!Array.isArray(n)){n=[n];}var v=j===undefined?this.getHotspotColorABGR():j;if(!i){v=0;}var w=this._viewStateManager.getNodeHierarchy();if(this._isSmart2DContent()){var x=[];n.forEach(function(A){var B=sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,A,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN).ChildNodes);Array.prototype.push.apply(x,B);}.bind(this));Array.prototype.push.apply(x,n);x.forEach(u.bind(null,w,v));}else{var y=[];var z=function(A){var x=w.getChildren(A);Array.prototype.push.apply(y,x);x.forEach(z);};n.forEach(z);Array.prototype.push.apply(y,n);y.forEach(u.bind(null,w,v));}return this;};c.prototype._getDecomposedABGR=function(i){return{red:(i>>>0&0xff)/255,green:(i>>>8&0xff)/255,blue:(i>>>16&0xff)/255,alpha:(i>>>24&0xff)/255};};c.prototype._setBackgroundColor=function(){if(this._dvl){var t=this._getDecomposedABGR(this.getBackgroundColorTopABGR()),i=this._getDecomposedABGR(this.getBackgroundColorBottomABGR());this._dvl.Renderer.SetBackgroundColor(t.red,t.green,t.blue,t.alpha,i.red,i.green,i.blue,i.alpha,this._dvlRendererId);}};c.prototype.setBackgroundColorTopABGR=function(i){this.setProperty("backgroundColorTopABGR",i,true);this._setBackgroundColor();return this;};c.prototype.setBackgroundColorTop=function(v){this.setProperty("backgroundColorTop",v,true);return this.setBackgroundColorTopABGR(sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(v)));};c.prototype.setBackgroundColorBottomABGR=function(i){this.setProperty("backgroundColorBottomABGR",i,true);this._setBackgroundColor();return this;};c.prototype.setBackgroundColorBottom=function(v){this.setProperty("backgroundColorBottom",v,true);return this.setBackgroundColorBottomABGR(sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(v)));};c.prototype.setShouldRenderFrame=function(){if(this._dvlRendererId){this._dvl.Renderer.ForceRenderFrame(this._dvlRendererId);}return this;};c.prototype.shouldRenderFrame=function(){return this._dvlRendererId&&this._dvl.Renderer.ShouldRenderFrame(this._dvlRendererId);};c.prototype.renderFrame=function(){if(this._dvlRendererId){this._dvl.Renderer.RenderFrame(this._dvlRendererId);}return this;};c.prototype.renderFrameEx=function(v,i){if(this._dvlRendererId){this._dvl.Renderer.RenderFrameEx.apply(this,[].concat(v,i),this._dvlRendererId);}return this;};c.prototype.resetView=function(i){if(i!==undefined&&!q.isPlainObject(i)){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT31.summary),M.VIT31.code,"sap.ui.vk.dvl.Viewport");}var j={camera:true,transition:true,visibility:false};q.extend(j,i);if(j.camera||j.visibility){var n=(j.camera?sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA:0)|(j.transition?sap.ve.dvl.DVLRESETVIEWFLAG.SMOOTHTRANSITION:0)|(j.visibility?sap.ve.dvl.DVLRESETVIEWFLAG.VISIBILITY:0);if(this._dvlRendererId){this._dvl.Renderer.ResetView(n,this._dvlRendererId);this._lastPlayedStep=null;}}return this;};c.prototype.canIsolateNode=function(n){if(this._dvlRendererId){return this._dvl.Renderer.CanIsolateNode(n,this._dvlRendererId);}else{return false;}};c.prototype.setIsolatedNode=function(n){if(this._dvlRendererId){this._dvl.Renderer.SetIsolatedNode(n,this._dvlRendererId);}return this;};c.prototype.getIsolatedNode=function(){if(this._dvlRendererId){return this._dvl.Renderer.GetIsolatedNode(this._dvlRendererId);}else{return sap.ve.dvl.DVLID_INVALID;}};c.prototype.hitTest=function(x,y){if(this._dvlRendererId){var i=this._dvl.Renderer.HitTest(x*window.devicePixelRatio,y*window.devicePixelRatio,this._dvlRendererId).id;this.setShouldRenderFrame();return i;}else{return sap.ve.dvl.DVLID_INVALID;}};c.prototype.setShowDebugInfo=function(v){this.setProperty("showDebugInfo",v,true);if(this._dvlRendererId){this._dvl.Renderer.SetOption(sap.ve.dvl.DVLRENDEROPTION.DVLRENDEROPTION_SHOW_DEBUG_INFO,v,this._dvlRendererId);}return this;};c.prototype._handleFrameFinished=function(i){if(i.rendererId===this._dvlRendererId){this.fireFrameRenderingFinished();}};c.prototype.beginGesture=function(x,y){if(this._dvlRendererId){this._dvl.Renderer.BeginGesture(x*window.devicePixelRatio,y*window.devicePixelRatio,this._dvlRendererId);}return this;};c.prototype.endGesture=function(){if(this._dvlRendererId){this._dvl.Renderer.EndGesture(this._dvlRendererId);}return this;};c.prototype.pan=function(i,j){if(this._dvlRendererId){this._dvl.Renderer.Pan(i*window.devicePixelRatio,j*window.devicePixelRatio,this._dvlRendererId);this.firePan({dx:i,dy:j});}return this;};c.prototype.rotate=function(i,j){if(this._dvlRendererId){this._dvl.Renderer.Rotate(i*window.devicePixelRatio,j*window.devicePixelRatio,this._dvlRendererId);this.fireRotate({dx:i,dy:j});}return this;};c.prototype.zoom=function(i){if(this._dvlRendererId){this._dvl.Renderer.Zoom(i,this._dvlRendererId);this.fireZoom({zoomFactor:i});}return this;};c.prototype.zoomTo=function(w,n,j,t){if(this._dvlRendererId){var u=0;if(Array.isArray(w)){for(var i in w){u|=d.decodedZoomTo[w[i]];}}else{u=d.decodedZoomTo[w];}this._dvl.Renderer.ZoomTo(u,n,j,t,this._dvlRendererId);}return this;};c.prototype.tap=function(x,y,i){if(this._dvlRendererId){var j=x*window.devicePixelRatio,n=y*window.devicePixelRatio;if(!i){var t=this.hitTest(x,y);var u={picked:t!==sap.ve.dvl.DVLID_INVALID?[t]:[]};this.fireNodesPicked(u);if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Exclusive){this.exclusiveSelectionHandler(u.picked);}else if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Sticky){this.stickySelectionHandler(u.picked);}if(t!==sap.ve.dvl.DVLID_INVALID){this.fireNodeClicked({nodeRef:t,nodeId:t,x:x,y:y},true,true);}}else{this._dvl.Renderer.Tap(j,n,i,this._dvlRendererId);}}return this;};c.prototype.queueCommand=function(i){if(this._dvlRendererId){this._dvl.Renderer._queueCommand(i,this._dvlRendererId);}return this;};c.prototype._onAfterUpdateContentConnector=function(){this._setScene(this._contentConnector.getContent());};c.prototype._onBeforeClearContentConnector=function(){this._setScene(null);};c.prototype._handleContentReplaced=function(i){var j=i.getParameter("newContent");if(!(j instanceof sap.ui.vk.dvl.Scene)){j=null;}this._setScene(j);};c.prototype._setScene=function(i){var j=i&&i.getGraphicsCore();this.setGraphicsCore(j);this.setScene(i);if(i&&(this._isSmart2DContent()||this._isSmart2DContentLegacy())){this._initializeSmart2DHandler();}};c.prototype._handleContentChangesFinished=function(i){this.setShouldRenderFrame();};c.prototype._onAfterUpdateViewStateManager=function(){if(this._dvl){this._dvl.Renderer.SetViewStateManager(this._viewStateManager,this._dvlRendererId);}};c.prototype._onBeforeClearViewStateManager=function(){if(this._dvl){this._dvl.Renderer.SetViewStateManager(null,this._dvlRendererId);}};var o={x:-2,y:-2};var r=2;var p=5;[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){c.prototype["onsap"+i.key]=function(j){this.beginGesture(o.x,o.y);this.rotate(i.dx,i.dy);this.endGesture();this.setShouldRenderFrame();j.preventDefault();j.stopPropagation();};});[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){c.prototype["onsap"+i.key+"modifiers"]=function(j){if(j.shiftKey&&!(j.ctrlKey||j.altKey||j.metaKey)){this.beginGesture(o.x,o.y);this.pan(i.dx,i.dy);this.endGesture();this.setShouldRenderFrame();j.preventDefault();j.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){V.prototype["onsap"+i.key]=function(j){this.beginGesture(this.$().width()/2,this.$().height()/2);this.zoom(i.d);this.endGesture();this.setShouldRenderFrame();j.preventDefault();j.stopPropagation();};});C.injectMethodsIntoClass(c);b.injectMethodsIntoClass(c);return c;});
