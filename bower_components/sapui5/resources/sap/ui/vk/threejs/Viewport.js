/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../ViewportBase","sap/ui/core/ResizeHandler","../Loco","./thirdparty/three","../ContentConnector","../ViewStateManager","./ViewportGestureHandler"],function(q,l,V,R,L,t,C,a,b){"use strict";var c=V.extend("sap.ui.vk.threejs.Viewport",{metadata:{library:"sap.ui.vk",publicMethods:["setScene","getScene","setCamera","getCamera","getRenderer","hitTest","tap","render"]}});var d=c.getMetadata().getParent().getClass().prototype;c.prototype.init=function(){if(d.init){d.init.call(this);}this._resizeListenerId=null;this._renderLoopRequestId=0;this._renderLoopFunction=this._renderLoop.bind(this);var e=1;var f=1;this._renderer=new THREE.WebGLRenderer({antialias:true});this._renderer.setClearColor(0xf0f0f0);this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(e,f);var n=1;var g=20000;this._camera=new THREE.OrthographicCamera(e/-2,e/2,f/2,f/-2,n,g);this._camera.position.set(0,0,10000);this._camera.zoom=10;this._viewportGestureHandler=new b(this);this._loco=new L();this._loco.addHandler(this._viewportGestureHandler);};c.prototype.exit=function(){this._loco.removeHandler(this._viewportGestureHandler);this._viewportGestureHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();this.setScene(null);this.setCamera(null);this._renderer=null;this._loco=null;this._viewportGestureHandler=null;if(d.exit){d.exit.call(this);}};c.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);}return this;};c.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0;}return this;};c.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();};c.prototype.onAfterRendering=function(){var e=this.getDomRef();e.appendChild(this._renderer.domElement);this._resizeListenerId=R.register(this,this._handleResize.bind(this));var f=e.getBoundingClientRect();this._handleResize({size:{width:f.width,height:f.height}});this._startRenderLoop();};c.prototype._updateCamera=function(w,h){if(!this._camera){return false;}if(this._camera.isPerspectiveCamera){this._camera.aspect=w/h;}else{this._camera.left=w/-2;this._camera.right=w/2;this._camera.top=h/2;this._camera.bottom=h/-2;}this._camera.updateProjectionMatrix();return true;};c.prototype._handleResize=function(e){if(!this._camera||!this._renderer){return false;}var w=e.size.width;var h=e.size.height;this._updateCamera(w,h);this._renderer.setSize(w,h);this.fireResize({size:{width:w,height:h}});return true;};c.prototype.setScene=function(s){this._scene=s;var n=this._scene?this._scene.getSceneRef():undefined;if(n){var g;for(var i=0;i<n.children.length;i++){g=n.children[i];if(g.name==="DefaultLights"&&g.children.length){if(g.children[0]instanceof THREE.DirectionalLight){this._eyePointLight=g.children[0];}}}}};c.prototype.getScene=function(){return this._scene;};c.prototype.setCamera=function(e){this._camera=e;var f=window.devicePixelRatio||1;if(this._camera&&this._renderer){this._updateCamera(this._renderer.domElement.width*f,this._renderer.domElement.height*f);}};c.prototype.getCamera=function(){return this._camera;};c.prototype.getRenderer=function(){return this._renderer;};c.prototype.hitTest=function(x,y){var n=this._scene?this._scene.getSceneRef():undefined;if(!this._camera||!n){return null;}var e=this._renderer.domElement;var m=new THREE.Vector2((x-e.offsetLeft)/e.width*2-1,(e.offsetTop-y)/e.height*2+1);var f=new THREE.Raycaster();f.setFromCamera(m,this._camera);var i=f.intersectObjects(n.children,true);if(i&&i.length){return i[0];}return null;};c.prototype.tap=function(x,y,i){if(!i){if(this._viewStateManager){var h=this.hitTest(x,y);var n=h&&h.object;var e={picked:n?[n]:[]};this.fireNodesPicked(e);if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Exclusive){this.exclusiveSelectionHandler(e.picked);}else if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Sticky){this.stickySelectionHandler(e.picked);}}}else{}return this;};var o={x:-2,y:-2};var r=2;var p=5;[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){c.prototype["onsap"+i.key]=function(e){var f=this._viewportGestureHandler._cameraController;f.beginGesture(o.x,o.y);f.rotate(i.dx,i.dy,true);f.endGesture();e.preventDefault();e.stopPropagation();};});[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){c.prototype["onsap"+i.key+"modifiers"]=function(e){if(e.shiftKey&&!(e.ctrlKey||e.altKey||e.metaKey)){var f=this._viewportGestureHandler._cameraController;f.beginGesture(o.x,o.y);f.pan(i.dx,i.dy);f.endGesture();e.preventDefault();e.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){V.prototype["onsap"+i.key]=function(e){var f=this._viewportGestureHandler._cameraController;f.beginGesture(this.$().width()/2,this.$().height()/2);f.zoom(i.d);f.endGesture();e.preventDefault();e.stopPropagation();};});c.prototype._handleVisibilityChanged=c.prototype._handleSelectionChanged=c.prototype._handleOpacityChanged=c.prototype._handleTintColorChanged=c.prototype._handleHighlightColorChanged=function(e){this.render();};c.prototype._renderLoop=function(){if(!this._renderer||!this.getDomRef()){this._renderLoopRequestId=0;return;}if(this._viewportGestureHandler){this._viewportGestureHandler.update();}if(this._eyePointLight&&this._camera){this._eyePointLight.position.copy(this._camera.position);this._eyePointLight.position.normalize();}this.render();this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);};c.prototype.render=function(){var n=this._scene?this._scene.getSceneRef():undefined;if(!n||!this._camera||!this._renderer){return;}this._renderer.render(n,this._camera);};c.prototype._onAfterUpdateContentConnector=function(){this.setScene(this._contentConnector.getContent());};c.prototype._onBeforeClearContentConnector=function(){this.setScene(null);};c.prototype._handleContentReplaced=function(e){var f=e.getParameter("newContent");if(!(f instanceof sap.ui.vk.threejs.Scene)){f=null;}this.setScene(f);};c.prototype._onAfterUpdateViewStateManager=function(){};c.prototype._onBeforeClearViewStateManager=function(){};C.injectMethodsIntoClass(c);a.injectMethodsIntoClass(c);return c;});
