/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../ContentManager","./Scene","../TransformationMatrix"],function(q,C,S,T){"use strict";var a=C.extend("sap.ui.vk.threejs.ContentManager",{metadata:{library:"sap.ui.vk"}});var b=a.getMetadata().getParent().getClass().prototype;var t=function(p,c){return new Promise(function(r,d){var l=new THREE.ObjectLoader();l.load(c.getSource(),function(o){p.add(o);r({node:p,contentResource:c});},function(x){},function(x){d(new Error("Not object json"));});});};a.prototype.init=function(){if(b.init){b.init.call(this);}};a.prototype.exit=function(){if(b.exit){b.exit.call(this);}};function i(n){if(n){var c=[new THREE.Color(0.8,0.8,0.9).multiplyScalar(0.9),new THREE.Color(0.5,0.5,0.5).multiplyScalar(0.4),new THREE.Color(0.8,0.8,0.9).multiplyScalar(0.4),new THREE.Color(0.9,0.9,0.9).multiplyScalar(0.4)];var d=[new THREE.Vector3(0,0,1).normalize(),new THREE.Vector3(-2.0,-1.5,-0.5).normalize(),new THREE.Vector3(2.0,1.1,-2.5).normalize(),new THREE.Vector3(0.04,0.01,2.0).normalize()];var e=new THREE.Group();n.add(e);e.name="DefaultLights";for(var l=0,g=c.length;l<g;l++){var h=new THREE.DirectionalLight();h.color.copy(c[l]);h.position.copy(d[l]);e.add(h);}}}a.prototype.loadContent=function(c,d){var e=this;var l=function(){e.fireContentChangesStarted();var n=new THREE.Scene(),s=new S(n);i(n);e._loadContentResources(s,d).then(function(v){s._setState(v[0].state);e.fireContentChangesFinished({content:s});},function(r){q.sap.log.error("Failed to load content resources.");e.fireContentChangesFinished({content:null,failureReason:[{error:r,errorMessage:"Failed to load content resources."}]});});};if(window.THREE){l();}else{sap.ui.require(["sap/ui/vk/threejs/thirdparty/three"],function(g){l();});}return this;};var f=function(c){if(c._contentManagerResolver&&c._contentManagerResolver.settings&&c._contentManagerResolver.settings.loader){return c._contentManagerResolver.settings.loader;}if(c.getSource()){var s=c.getSourceType();if(s==="threejs.test.json"){return t;}return null;}return null;};a.prototype._loadContentResources=function(s,c){var p=[];c.forEach(function loadContentResource(d,e){var n=new THREE.Group();n.name=e.getName();n.sourceId=e.getSourceId();e._shadowContentResource={nodeProxy:s.getDefaultNodeHierarchy().createNodeProxy(n)};var l=e.getLocalMatrix();if(l){n.applyMatrix(new THREE.Matrix4().fromArray(T.convertTo4x4(l)));}d.add(n);var g=f(e);if(g){p.push(g(n,e));}else{p.push(Promise.resolve({node:n,contentResource:e}));}e.getContentResources().forEach(loadContentResource.bind(this,n));}.bind(this,s.getSceneRef()));return Promise.all(p);};return a;});
