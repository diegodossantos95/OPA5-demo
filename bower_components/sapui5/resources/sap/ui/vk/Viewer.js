/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","./Scene","./ContentResource","./FlexibleControl","sap/ui/layout/VerticalLayout","sap/ui/core/ResizeHandler","./DvlException","./Messages","./ProgressIndicator","./Notifications","./ContentConnector","./ViewStateManager","./dvl/ContentManager"],function(q,l,C,S,a,F,V,R,D,M,P,N,b,c,d){"use strict";var e=q.sap.log;sap.ui.lazyRequire("sap.ui.vk.NativeViewport");sap.ui.lazyRequire("sap.ui.vk.Overlay");sap.ui.lazyRequire("sap.ui.vk.SceneTree");sap.ui.lazyRequire("sap.ui.vk.StepNavigation");sap.ui.lazyRequire("sap.ui.vk.Toolbar");sap.ui.lazyRequire("sap.ui.vk.Viewport");var f=C.extend("sap.ui.vk.Viewer",{metadata:{library:"sap.ui.vk",properties:{enableOverlay:{type:"boolean",defaultValue:false},enableSceneTree:{type:"boolean",defaultValue:true},showSceneTree:{type:"boolean",defaultValue:true},enableStepNavigation:{type:"boolean",defaultValue:true},enableNotifications:{type:"boolean",defaultValue:true},showStepNavigation:{type:"boolean",defaultValue:false},showStepNavigationThumbnails:{type:"boolean",defaultValue:true},enableToolbar:{type:"boolean",defaultValue:true},enableProgressIndicator:{type:"boolean",defaultValue:true},width:{type:"sap.ui.core.CSSSize",defaultValue:"auto"},height:{type:"sap.ui.core.CSSSize",defaultValue:"auto"},toolbarTitle:{type:"string",defaultValue:""},shouldTrackVisibilityChanges:{type:"boolean",defaultValue:false},runtimeSettings:{type:"object",defaultValue:{}},webGLContextAttributes:{type:"object",defaultValue:{antialias:true,alpha:true,premultipliedAlpha:false}},showAllHotspots:{type:"boolean",defaultValue:false},hotspotColorABGR:{type:"int",defaultValue:0xc00000ff},hotspotColor:{type:"sap.ui.core.CSSColor",defaultValue:"rgba(255, 0, 0, 0.7529411764705882)"}},publicMethods:["activateFullScreenMode","activateRedlineDesign","destroyRedlineDesign","getDecryptionHandler","getGraphicsCore","getNativeViewport","getRedlineDesign","getScene","getViewport","getViewStateManager","setDecryptionHandler"],aggregations:{contentResources:{type:"sap.ui.vk.ContentResource"},overlay:{type:"sap.ui.vk.Overlay",multiple:false},toolbar:{type:"sap.ui.vk.Toolbar",multiple:false,visibility:"hidden"},progressIndicator:{type:"sap.ui.vk.ProgressIndicator",multiple:false,visibility:"hidden"},viewport:{type:"sap.ui.vk.ViewportBase",multiple:false,visibility:"hidden"},nativeViewport:{type:"sap.ui.vk.NativeViewport",multiple:false,visibility:"hidden"},stepNavigation:{type:"sap.ui.vk.StepNavigation",multiple:false,visibility:"hidden"},sceneTree:{type:"sap.ui.vk.SceneTree",multiple:false,visibility:"hidden"},layout:{type:"sap.ui.layout.VerticalLayout",multiple:false,visibility:"hidden"},contentConnector:{type:"sap.ui.vk.ContentConnector",multiple:false,visibility:"hidden"},viewStateManager:{type:"sap.ui.vk.ViewStateManager",multiple:false,visibility:"hidden"},messagePopover:{type:"sap.ui.vk.Notifications",multiple:false,visibility:"hidden"}},defaultAggregation:"contentResources",events:{contentResourceChangesProcessed:{},sceneLoadingSucceeded:{parameters:{scene:{type:"sap.ui.vk.Scene"}}},sceneLoadingFailed:{parameters:{reason:{type:"object"}}},sceneDestroying:{parameters:{scene:{type:"sap.ui.vk.Scene"},preventGarbageCollection:{type:"function"}}},selectionChanged:{parameters:{selected:{type:"any[]"},unselected:{type:"any[]"}}},fullScreen:{parameters:{isFullScreen:{type:"boolean"}}},urlClicked:{parameters:{nodeRef:"any",url:"string"}},nodeClicked:{parameters:{nodeRef:"any",x:"int",y:"int"}}}}});f.prototype.applySettings=function(s){this._inApplySettings=true;C.prototype.applySettings.apply(this,arguments);delete this._inApplySettings;if(this._viewStateManager){this._viewStateManager.setShouldTrackVisibilityChanges(this.getShouldTrackVisibilityChanges());}this._componentsState={sceneTree:{defaultEnable:this.getEnableSceneTree(),shouldBeEnabled:true,userInteractionShow:this.getShowSceneTree()},stepNavigation:{defaultEnable:this.getEnableStepNavigation(),userInteractionShow:this.getShowStepNavigation()},progressIndicator:{defaultEnable:this.getEnableProgressIndicator()},messagePopover:{defaultEnable:this.getEnableNotifications()}};this.setEnableSceneTree(false);this.setEnableStepNavigation(false);};f.prototype.init=function(){if(C.prototype.init){C.prototype.init.apply(this);}this._contentConnector=new b(this.getId()+"-contentconnector");this.setAggregation("contentConnector",this._contentConnector);this._contentConnector.attachContentReplaced(this._handleContentReplaced,this);this._contentConnector.attachContentChangesStarted(this._handleContentChangesStarted,this);this._contentConnector.attachContentChangesFinished(this._handleContentChangesFinished,this);this._contentConnector.attachContentChangesProgress(this._handleContentChangesProgress,this);this._viewStateManager=new c(this.getId()+"-viewstatemanager",{contentConnector:this._contentConnector});this.setAggregation("viewStateManager",this._viewStateManager);e.debug("sap.ui.vk.Viewer.init() called.");this._mainScene=null;this._resizeListenerId=null;this._busyIndicatorCounter=0;this._toolbar=null;this._viewport=null;this._nativeViewport=null;this._redlineDesign=null;this._stepNavigation=null;this._sceneTree=null;this._overlayManager={initialized:false,changed:false,control:null,onNativeViewportMove:function(g){var p=g.getParameter("pan");var z=g.getParameter("zoom");this.control.setPanAndZoom(p.x,p.y,z);},onViewportZoom:function(g){var z=g.getParameter("zoomFactor");this.control.setPanAndZoom(0,0,z);},onViewportPan:function(g){var h=g.getParameter("dx");var j=g.getParameter("dy");this.control.setPanAndZoom(h,j,1);}};this._overlayManager.delegate={onAfterRendering:this._onAfterRenderingOverlay.bind(this,this._viewport,this._nativeViewport,this._overlayManager)};this._updateSizeTimer=0;this._layout=new sap.ui.layout.VerticalLayout(this.getId()+"-verticalLayout").addStyleClass("sapUiVizKitLayout");this.setAggregation("layout",this._layout);this._toolbar=new sap.ui.vk.Toolbar({title:this.getToolbarTitle(),visible:this.getEnableToolbar(),viewer:this});this.setAggregation("toolbar",this._toolbar);this._layout.addContent(this._toolbar);this._splitter=new sap.ui.layout.Splitter(this.getId()+"-splitter",{orientation:"Horizontal"});this._layout.addContent(this._splitter);this._stackedViewport=new F(this.getId()+"-stackedViewport",{width:"100%",height:"100%",layout:"Stacked",layoutData:new sap.ui.layout.SplitterLayoutData({size:"auto",minSize:200})});this._splitter.addContentArea(this._stackedViewport);this._messagePopover=new N({visible:true});this._messagePopover.attachAllMessagesCleared(this._updateLayout,this);this._messagePopover.attachMessageAdded(this._updateLayout,this);this.setAggregation("messagePopover",this._messagePopover);this._layout.addContent(this._messagePopover);this.setTooltip(sap.ui.vk.getResourceBundle().getText("VIEWER_TITLE"));if(this.getEnableProgressIndicator()){this._progressIndicator=new P({visible:false}).addStyleClass("sapUiVizKitProgressIndicator");this.setAggregation("progressIndicator",this._progressIndicator);}};f.prototype.exit=function(){e.debug("sap.ui.vk.Viewer.exit() called.");if(this._viewport){this._viewport.detachEvent("viewActivated",this._onViewportViewActivated,this);}this._setMainScene(null);this._toolbar=null;this._messagePopover=null;this._sceneTree=null;this._nativeViewport=null;this._stepNavigation=null;this._viewport=null;this._componentsState=null;this._viewStateManager=null;this._contentConnector=null;if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}if(C.prototype.exit){C.prototype.exit.apply(this);}};f.prototype._setMainScene=function(s){if(s){if(s!==this._mainScene){this._mainScene=s;this._showViewport();if(this._componentsState.sceneTree.defaultEnable){this._instantiateSceneTree();this.setEnableSceneTree(true);this._sceneTree.setScene(s,this._viewStateManager);if(this._componentsState.sceneTree.userInteractionShow&&this._componentsState.sceneTree.shouldBeEnabled){this.setShowSceneTree(true);this._sceneTree.setVisible(true);}else{this.setShowSceneTree(false);}}else if(this._sceneTree&&this._viewStateManager){this._sceneTree.setScene(s,this._viewStateManager);}if(this._componentsState.stepNavigation.defaultEnable){this._instantiateStepNavigation();this.setEnableStepNavigation(true);if(this._componentsState.stepNavigation.userInteractionShow){this.setShowStepNavigation(true);this._stepNavigation.setVisible(true);}else{this.setShowStepNavigation(false);}}}if(this._sceneTree){this._sceneTree.refresh();}if(this._stepNavigation){this._stepNavigation.refresh(s);}}else{this._mainScene=null;this.setEnableSceneTree(false);this.setEnableStepNavigation(false);}return this;};f.prototype.getGraphicsCore=function(){return this._mainScene instanceof sap.ui.vk.dvl.Scene?this._mainScene.getGraphicsCore():null;};f.prototype.getScene=function(){return this._mainScene;};f.prototype.getViewStateManager=function(){return this._viewStateManager;};f.prototype.getViewport=function(){return this._viewport?this._viewport.getImplementation():null;};f.prototype.getNativeViewport=function(){return this._nativeViewport;};f.prototype.getRedlineDesign=function(){if(i(this.getViewport())){return this._redlineDesign;}else{return null;}};f.prototype.getOverlay=function(){return this._overlayManager.control;};f.prototype.setEnableOverlay=function(p){if(p!==this.getProperty("enableOverlay")){this.setProperty("enableOverlay",p);this._overlayManager.changed=true;}return this;};f.prototype.setEnableSceneTree=function(p){this.setProperty("enableSceneTree",p,true);if(!p){this.setProperty("showSceneTree",false);}this._updateLayout();return this;};f.prototype.setEnableNotifications=function(p){this.setProperty("enableNotifications",p,true);this._messagePopover.setVisible(false);this._updateLayout();return this;};f.prototype.setShowSceneTree=function(p){this.setProperty("showSceneTree",p,true);this._updateLayout();return this;};f.prototype.setEnableStepNavigation=function(p){this.setProperty("enableStepNavigation",p,true);if(!p){this.setProperty("showStepNavigation",false);}this._updateLayout();return this;};f.prototype.setShowStepNavigation=function(p){this.setProperty("showStepNavigation",p,true);this._updateLayout();return this;};f.prototype.setEnableToolbar=function(p){this.setProperty("enableToolbar",p,true);this._updateLayout();return this;};f.prototype.activateFullScreenMode=function(v){var g=function(j){return!!(j.fullScreen||j.webkitIsFullScreen||j.mozFullScreen||j.msFullscreenElement);};if(v){if(!g(document)){if(!this._fullScreenHandler){var t=this;this._fullScreenHandler=function(j){var k=g(document);if(!k){document.removeEventListener("fullscreenchange",t._fullScreenHandler);document.removeEventListener("mozfullscreenchange",t._fullScreenHandler);document.removeEventListener("webkitfullscreenchange",t._fullScreenHandler);document.removeEventListener("MSFullscreenChange",t._fullScreenHandler);}t.fireFullScreen({isFullScreen:k});};}var h=document.getElementsByTagName("body")[0];if(h.requestFullScreen){document.addEventListener("fullscreenchange",this._fullScreenHandler);h.requestFullScreen();}else if(h.webkitRequestFullScreen){document.addEventListener("webkitfullscreenchange",this._fullScreenHandler);h.webkitRequestFullScreen();}else if(h.mozRequestFullScreen){document.addEventListener("mozfullscreenchange",this._fullScreenHandler);h.mozRequestFullScreen();}else if(h.msRequestFullscreen){document.addEventListener("MSFullscreenChange",this._fullScreenHandler);h.msRequestFullscreen();}}this.addStyleClass("sapVizKitViewerFullScreen");}else{if(g(document)){if(document.cancelFullScreen){document.cancelFullScreen();}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}}this.removeStyleClass("sapVizKitViewerFullScreen");}return this;};function i(v){if(!v){return false;}return v instanceof sap.ui.vk.dvl.Viewport;}f.prototype.getShowAllHotspots=function(){return i(this.getViewport())?this.getViewport().getShowAllHotspots():this.getProperty("showAllHotspots");};f.prototype.setShowAllHotspots=function(v){this.setProperty("showAllHotspots",v,true);if(i(this.getViewport())){this.getViewport().setShowAllHotspots(v);}return this;};f.prototype.getHotspotColorABGR=function(){return i(this.getViewport())?this.getViewport().getHotspotColorABGR():this.getProperty("hotspotColorABGR");};f.prototype.setHotspotColorABGR=function(v){this.setProperty("hotspotColorABGR",v,true);this.setProperty("hotspotColor",sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(v)),true);if(i(this.getViewport())){this.getViewport().setHotspotColorABGR(v);}return this;};f.prototype.getHotspotColor=function(){return i(this.getViewport())?this.getViewport().getHotspotColor():this.getProperty("hotspotColor");};f.prototype.setHotspotColor=function(v){this.setProperty("hotspotColor",v,true);this.setProperty("hotspotColorABGR",sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(v)),true);if(i(this.getViewport())){this.getViewport().setHotspotColor(v);}return this;};f.prototype.setRuntimeSettings=function(s){if(this._inApplySettings){this.setProperty("runtimeSettings",s,true);d.setRuntimeSettings(s);}else{e.error(sap.ui.vk.getResourceBundle().getText(M.VIT29.summary),M.VIT29.code,"sap.ui.vk.Viewer");}return this;};f.prototype.setWebGLContextAttributes=function(g){if(this._inApplySettings){this.setProperty("webGLContextAttributes",g,true);d.setWebGLContextAttributes(g);}else{e.error(sap.ui.vk.getResourceBundle().getText(M.VIT30.summary),M.VIT30.code,"sap.ui.vk.Viewer");}return this;};f.prototype.invalidate=function(o){if(o instanceof a){this._contentConnector.invalidate(o);return;}C.prototype.invalidate.apply(this,arguments);};f.prototype.validateAggregation=function(g,o,m){if(g==="contentResources"){return this._contentConnector.validateAggregation(g,o,m);}return C.prototype.validateAggregation.call(this,g,o,m);};f.prototype.getAggregation=function(g,h){if(g==="contentResources"){return this._contentConnector.getAggregation(g,h);}return C.prototype.getAggregation.call(this,g,h);};f.prototype.setAggregation=function(g,o,s){if(g==="contentResources"){this._contentConnector.setAggregation(g,o,s);return this;}return C.prototype.setAggregation.call(this,g,o,s);};f.prototype.addAggregation=function(g,o,s){if(g==="contentResources"){this._contentConnector.addAggregation(g,o,s);return this;}return C.prototype.addAggregation.call(this,g,o,s);};f.prototype.insertAggregation=function(g,o,h,s){if(g==="contentResources"){this._contentConnector.insertAggregation(g,o,h,s);return this;}return C.prototype.insertAggregation.call(this,g,o,h,s);};f.prototype.removeAggregation=function(g,o,s){if(g==="contentResources"){return this._contentConnector.removeAggregation(g,o,s);}return C.prototype.removeAggregation.call(this,g,o,s);};f.prototype.removeAllAggregation=function(g,s){if(g==="contentResources"){return this._contentConnector.removeAllAggregation(g,s);}return C.prototype.removeAllAggregation.call(this,g,s);};f.prototype.destroyAggregation=function(g,s){if(g==="contentResources"){this._contentConnector.destroyAggregation(g,s);return this;}return C.prototype.destroyAggregation.call(this,g,s);};f.prototype.onBeforeRendering=function(){this._showOverlay();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}};f.prototype.onAfterRendering=function(){this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize();};f.prototype._handleResize=function(g){this._updateSize();if(this.getRedlineDesign()){var x=this.getRedlineDesign().exportJSON();this.getRedlineDesign().removeAllRedlineElements();q.sap.delayedCall(200,this,function(){var v;if(this.getViewport()&&this.getViewport().getVisible()){v=this.getViewport().getOutputSize();}else if(this.getNativeViewport()&&this.getNativeViewport().getVisible()){v=this.getNativeViewport().getOutputSize();}this.getRedlineDesign().setProperty("virtualLeft",v.left,true);this.getRedlineDesign().setProperty("virtualTop",v.top,true);this.getRedlineDesign().setProperty("virtualSideLength",v.sideLength,true);this.getRedlineDesign().invalidate();this.getRedlineDesign().importJSON(x);});}};f.prototype._delayedUpdateSize=function(){if(this.getDomRef()){if(this._updateSizeTimer){clearTimeout(this._updateSizeTimer);}this._updateSizeTimer=setTimeout(this._updateSize.bind(this),0);}};f.prototype._updateSize=function(){this._updateSizeTimer=0;if(!this.getDomRef()){return;}var h=this.getDomRef().clientHeight;if(this._toolbar&&this._toolbar.getDomRef()&&this.getEnableToolbar()){h-=this._toolbar.getDomRef().clientHeight;}if(this._stepNavigation&&this._stepNavigation.getDomRef()&&this.getShowStepNavigation()){h-=this._stepNavigation.getDomRef().clientHeight;}if(this._messagePopover&&this._messagePopover.getDomRef()&&this._messagePopover.getVisible()){h-=this._messagePopover.getDomRef().clientHeight;}if(this._sceneTree){this._sceneTree.updateHeight(h);}this._splitter.setHeight(Math.max(h,100)+"px");};f.prototype.isTreeBinding=function(n){return n==="contentResources";};f.prototype.setBusy=function(g){if(g){if(this._busyIndicatorCounter===0){this.setBusyIndicatorDelay(0);C.prototype.setBusy.call(this,true);}this._busyIndicatorCounter+=1;}else{this._busyIndicatorCounter-=1;if(this._busyIndicatorCounter==0){C.prototype.setBusy.call(this,false);}}};f.prototype._updateLayout=function(){if(this._bIsBeingDestroyed){return;}if(this._sceneTree){if(this.getShowSceneTree()&&this.getEnableSceneTree()){this._sceneTree.setVisible(true);if(this._splitter.indexOfContentArea(this._sceneTree)<0){this._splitter.insertContentArea(this._sceneTree,0);}}else{if(this._splitter.indexOfContentArea(this._sceneTree)>=0){this._splitter.removeContentArea(this._sceneTree);}this._sceneTree.setVisible(false);}}if(this._stepNavigation){this._stepNavigation.setVisible(this.getShowStepNavigation()&&this.getEnableStepNavigation());}if(this._messagePopover){this._messagePopover.setVisible(this.getEnableNotifications()&&this._messagePopover.getAggregation("_messagePopover").getItems().length>0);}if(this._toolbar){this._toolbar.setVisible(this.getEnableToolbar());this._toolbar.refresh();}this._delayedUpdateSize();};f.prototype._instantiateSceneTree=function(){if(!this._sceneTree){this._sceneTree=new sap.ui.vk.SceneTree({layoutData:new sap.ui.layout.SplitterLayoutData({size:"320px",minSize:200}),viewStateManager:this._viewStateManager,contentConnector:this._contentConnector});this.setAggregation("sceneTree",this._sceneTree);}return this;};f.prototype._instantiateStepNavigation=function(){if(!this._stepNavigation){this._stepNavigation=new sap.ui.vk.StepNavigation(this.getId()+"-stepNavigation",{showThumbnails:this.getShowStepNavigationThumbnails(),contentConnector:this._contentConnector});this.setAggregation("stepNavigation",this._stepNavigation);this._layout.insertContent(this._stepNavigation,3);}return this;};f.prototype._showViewport=function(){if(!this._viewport){this._viewport=new sap.ui.vk.Viewport(this.getId()+"-viewport",{viewStateManager:this._viewStateManager,selectionMode:sap.ui.vk.SelectionMode.Exclusive,contentConnector:this._contentConnector});this.setAggregation("viewport",this._viewport);this._viewport.attachEvent("viewActivated",this._onViewportViewActivated,this);var v=this.getViewport();if(i(v)){v.setHotspotColor(this.getProperty("hotspotColor"));v.setHotspotColorABGR(this.getProperty("hotspotColorABGR"));v.setShowAllHotspots(this.getProperty("showAllHotspots"));}}if(this._nativeViewport){this._nativeViewport.setVisible(false);}this._stackedViewport.removeAllContent();this._stackedViewport.addContent(this._viewport);this._viewport.setVisible(true);return this;};f.prototype._showNativeViewport=function(){if(!this._nativeViewport){this._nativeViewport=new sap.ui.vk.NativeViewport(this.getId()+"-nativeViewport",{limitZoomOut:true,contentConnector:this._contentConnector});this.setAggregation("nativeViewport",this._nativeViewport);}if(this._viewport){this._viewport.setVisible(false);}this._stackedViewport.removeAllContent();this._stackedViewport.addContent(this._nativeViewport);this._nativeViewport.setVisible(true);return this;};f.prototype._showOverlay=function(){var o=this._overlayManager;if(o.changed){var O;if(this.getEnableOverlay()){if(!o.initialized){if(!(O=this.getAggregation("overlay"))){O=new sap.ui.vk.Overlay();}O.setZoomOnResize(false);o.control=O;o.initialized=true;}else{O=o.control;O.reset();}if(this._nativeViewport&&this._nativeViewport.getVisible()){O.setTarget(this._nativeViewport);o.savedLimitZoomOutState=this._nativeViewport.getLimitZoomOut();this._nativeViewport.setLimitZoomOut(true);this._nativeViewport.attachEvent("move",o.onNativeViewportMove,o);}else if(this._viewport&&this._viewport.getVisible()){O.setTarget(this._viewport);o.savedLimitZoomOutState=false;this._viewport.attachEvent("zoom",o.onViewportZoom,o);this._viewport.attachEvent("pan",o.onViewportPan,o);}this._stackedViewport.addContent(O);this._stackedViewport.addDelegate(o.delegate);}else{this._nativeViewport.detachEvent("move",o.onNativeViewportMove,o);this._stackedViewport.removeDelegate(o.delegate);this._stackedViewport.removeContent(o.control);this._nativeViewport.setLimitZoomOut(o.savedLimitZoomOutState);}o.changed=false;}};f.prototype._onAfterRenderingOverlay=function(E){var o=this._overlayManager.control.getDomRef();if(o&&(this._nativeViewport||this._viewport)){var v=this._nativeViewport&&this._nativeViewport.getVisible()?this._nativeViewport.getDomRef():this._viewport.getDomRef();if(o.parentNode!==v){o.parentNode.style.display="none";}v.appendChild(o);o.style.width="100%";o.style.height="100%";}};f.prototype.setDecryptionHandler=function(h){d.setDecryptionHandler(h);return this;};f.prototype.getDecryptionHandler=function(){return d.getDecryptionHandler();};f.prototype._instantiateRedlineDesign=function(r){if((this.getViewport()&&this.getViewport().getVisible())||(this.getNativeViewport()&&this.getNativeViewport().getVisible())){var g=this.getViewport()&&this.getViewport().getVisible()?this.getViewport():this.getNativeViewport();var v=g.getOutputSize();this._redlineDesign=new sap.ui.vk.RedlineDesign({visible:false,virtualTop:v.top,virtualLeft:v.left,virtualSideLength:v.sideLength,redlineElements:r});}return this;};f.prototype.activateRedlineDesign=function(r){if(!i(this.getViewport())){return this;}r=r||[];this._instantiateRedlineDesign(r);this.getRedlineDesign().placeAt(this._stackedViewport);this.getRedlineDesign().setVisible(true);var o=function(k){var m=k.getParameter("deltaX"),n=k.getParameter("deltaY");this.getViewport().queueCommand(function(m,n){this.getViewport().pan(m,n);this.getViewport().endGesture();}.bind(this,m,n));};var g=function(k){var m=k.getParameter("originX"),n=k.getParameter("originY"),z=k.getParameter("zoomFactor");this.getViewport().queueCommand(function(m,n,z){this.getViewport().beginGesture(m,n);this.getViewport().zoom(z);this.getViewport().endGesture();}.bind(this,m,n,z));};var h=function(k){var m=k.getParameter("deltaX"),n=k.getParameter("deltaY");this.getNativeViewport().queueCommand(function(){this.getNativeViewport().pan(m,n);this.getNativeViewport().endGesture();}.bind(this));};var j=function(k){var m=k.getParameter("originX"),n=k.getParameter("originY"),z=k.getParameter("zoomFactor");this.getNativeViewport().queueCommand(function(m,n,z){this.getNativeViewport().beginGesture(m,n);this.getNativeViewport().zoom(z);this.getNativeViewport().endGesture();}.bind(this,m,n,z));};if(this.getNativeViewport()&&this.getNativeViewport().getVisible()){this.getRedlineDesign().attachEvent("pan",h.bind(this));this.getRedlineDesign().attachEvent("zoom",j.bind(this));}else if(this.getViewport()&&this.getViewport().getVisible()){this.getRedlineDesign().attachEvent("pan",o.bind(this));this.getRedlineDesign().attachEvent("zoom",g.bind(this));}return this;};f.prototype.destroyRedlineDesign=function(){if(this.getRedlineDesign()){this.getRedlineDesign().destroy();this._redlineDesign=null;}return this;};f.prototype._onViewportViewActivated=function(g){this._componentsState.sceneTree.shouldBeEnabled=g.getParameter("type")==="3D";};f.prototype._handleContentReplaced=function(g){var h=g.getParameter("newContent");if(h instanceof sap.ui.vk.Scene){this._showViewport();if(this.getRedlineDesign()){this.getRedlineDesign().updatePanningRatio();}this._setMainScene(h);}else if(h instanceof HTMLImageElement||h instanceof HTMLObjectElement){this._setMainScene(null);this._showNativeViewport();if(this.getEnableOverlay()){this._overlayManager.changed=true;this._showOverlay();}}else{this._setMainScene(null);if(this._viewport){this._viewport.setVisible(false);}if(this._nativeViewport){this._nativeViewport.setVisible(false);}this._stackedViewport.removeAllContent();}};f.prototype._handleContentChangesStarted=function(g){this.setBusy(true);if(this._componentsState.progressIndicator.defaultEnable){this._progressIndicator.setPercentValue(0.0);this._progressIndicator.setVisible(true);}};f.prototype._handleContentChangesFinished=function(g){e.info("Finished");this._progressIndicator.setVisible(false);this._progressIndicator.setDisplayValue("");this._progressIndicator.setPercentValue(0);this.setBusy(false);var h=g.getParameter("content");if(h){this.fireSceneLoadingSucceeded({scene:h});}var j=g.getParameter("failureReason");if(j){this.fireSceneLoadingFailed({reason:j});if(this.getEnableNotifications()===false){this._showNativeViewport();if(j.errorMessage==="The content resources cannot be loaded. The type of content resources is unknown."){this._nativeViewport.loadFailed();}else{var k=sap.ui.vk.getResourceBundle().getText("VIEWPORT_MESSAGEERRORLOADINGFILE");this._nativeViewport.loadFailed(k);}}(Array.isArray(j)?j:[j]).forEach(function(r){e.error(r.errorMessage,"","sap.ui.vk.Viewer");});}this.fireContentResourceChangesProcessed();};f.prototype._handleContentChangesProgress=function(g){if(this._progressIndicator.getVisible()){var s=g.getParameter("source"),p=g.getParameter("percentage"),h=s.match(/\..{3,4}$/),j=h&&h[0]?s.split(/\\|\//).pop()+" ":"";this._progressIndicator.setPercentValue(p);this._progressIndicator.setDisplayValue(j+sap.ui.vk.getResourceBundle().getText("PROGRESS_INDICATOR_DOWNLOADING")+" "+(p?Math.floor(p)+"%":""));}};f.prototype._handleContentDestroying=function(g){this.fireSceneDestroying({scene:g.getParameter("content"),preventGarbageCollection:g.getParameter("preventGarbageCollection")});};return f;});
