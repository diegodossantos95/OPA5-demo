(function(t){var P='autosave',R='restoredraft',T=true,u,a,D=t.util.Dispatcher;t.create('tinymce.plugins.AutoSave',{init:function(e,b){var s=this,c=e.settings;s.editor=e;function p(d){var m={s:1000,m:60000};d=/^(\d+)([ms]?)$/.exec(''+d);return(d[2]?m[d[2]]:1)*parseInt(d);};t.each({ask_before_unload:T,interval:'30s',retention:'20m',minlength:50},function(v,k){k=P+'_'+k;if(c[k]===u)c[k]=v;});c.autosave_interval=p(c.autosave_interval);c.autosave_retention=p(c.autosave_retention);e.addButton(R,{title:P+".restore_content",onclick:function(){if(e.getContent({draft:true}).replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length>0){e.windowManager.confirm(P+".warning_message",function(o){if(o)s.restoreDraft();});}else s.restoreDraft();}});e.onNodeChange.add(function(){var d=e.controlManager;if(d.get(R))d.setDisabled(R,!s.hasDraft());});e.onInit.add(function(){if(e.controlManager.get(R)){s.setupStorage(e);setInterval(function(){if(!e.removed){s.storeDraft();e.nodeChanged();}},c.autosave_interval);}});s.onStoreDraft=new D(s);s.onRestoreDraft=new D(s);s.onRemoveDraft=new D(s);if(!a){window.onbeforeunload=t.plugins.AutoSave._beforeUnloadHandler;a=T;}},getInfo:function(){return{longname:'Auto save',author:'Moxiecode Systems AB',authorurl:'http://tinymce.moxiecode.com',infourl:'http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/autosave',version:t.majorVersion+"."+t.minorVersion};},getExpDate:function(){return new Date(new Date().getTime()+this.editor.settings.autosave_retention).toUTCString();},setupStorage:function(b){var s=this,c=P+'_test',d="OK";s.key=P+b.id;t.each([function(){if(localStorage){localStorage.setItem(c,d);if(localStorage.getItem(c)===d){localStorage.removeItem(c);return localStorage;}}},function(){if(sessionStorage){sessionStorage.setItem(c,d);if(sessionStorage.getItem(c)===d){sessionStorage.removeItem(c);return sessionStorage;}}},function(){if(t.isIE){b.getElement().style.behavior="url('#default#userData')";return{autoExpires:T,setItem:function(k,v){var f=b.getElement();f.setAttribute(k,v);f.expires=s.getExpDate();try{f.save("TinyMCE");}catch(e){}},getItem:function(k){var f=b.getElement();try{f.load("TinyMCE");return f.getAttribute(k);}catch(e){return null;}},removeItem:function(k){b.getElement().removeAttribute(k);}};}},],function(f){try{s.storage=f();if(s.storage)return false;}catch(e){}});},storeDraft:function(){var s=this,b=s.storage,e=s.editor,c,d;if(b){if(!b.getItem(s.key)&&!e.isDirty())return;d=e.getContent({draft:true});if(d.length>e.settings.autosave_minlength){c=s.getExpDate();if(!s.storage.autoExpires)s.storage.setItem(s.key+"_expires",c);s.storage.setItem(s.key,d);s.onStoreDraft.dispatch(s,{expires:c,content:d});}}},restoreDraft:function(){var s=this,b=s.storage,c;if(b){c=b.getItem(s.key);if(c){s.editor.setContent(c);s.onRestoreDraft.dispatch(s,{content:c});}}},hasDraft:function(){var s=this,b=s.storage,e,c;if(b){c=!!b.getItem(s.key);if(c){if(!s.storage.autoExpires){e=new Date(b.getItem(s.key+"_expires"));if(new Date().getTime()<e.getTime())return T;s.removeDraft();}else return T;}}return false;},removeDraft:function(){var s=this,b=s.storage,k=s.key,c;if(b){c=b.getItem(k);b.removeItem(k);b.removeItem(k+"_expires");if(c){s.onRemoveDraft.dispatch(s,{content:c});}}},"static":{_beforeUnloadHandler:function(e){var m;t.each(tinyMCE.editors,function(b){if(b.plugins.autosave)b.plugins.autosave.storeDraft();if(b.getParam("fullscreen_is_enabled"))return;if(!m&&b.isDirty()&&b.getParam("autosave_ask_before_unload"))m=b.getLang("autosave.unload_msg");});return m;}}});t.PluginManager.add('autosave',t.plugins.AutoSave);})(tinymce);
