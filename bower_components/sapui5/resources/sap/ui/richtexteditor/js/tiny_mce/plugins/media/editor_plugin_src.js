(function(){var s=tinymce.explode('id,name,style,align,class,hspace,vspace,bgcolor,type'),a=tinymce.makeMap(s.join(',')),r=s.concat(tinymce.explode('width, height')),e=tinymce.makeMap(r.join(',')),N=tinymce.html.Node,m,b,J=tinymce.util.JSON;m=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"],["Object"]];function c(d){return typeof(d)=="string"?d.replace(/[^0-9%]/g,''):d;}function t(o){var d,i;if(o&&!o.splice){d=[];for(i=0;true;i++){if(o[i]){d[i]=o[i];}else{break;}}return d;}return o;}tinymce.create('tinymce.plugins.MediaPlugin',{init:function(d,u){var f=this,l={},i,y,g,n;function h(j){return j&&j.nodeName==='IMG'&&d.dom.hasClass(j,'mceItemMedia');}f.editor=d;f.url=u;b='';for(i=0;i<m.length;i++){n=m[i][0];g={name:n,clsids:tinymce.explode(m[i][1]||''),mimes:tinymce.explode(m[i][2]||''),codebase:m[i][3]};for(y=0;y<g.clsids.length;y++){l['clsid:'+g.clsids[y]]=g;}for(y=0;y<g.mimes.length;y++){l[g.mimes[y]]=g;}l['mceItem'+n]=g;l[n.toLowerCase()]=g;b+=(b?'|':'')+n;}tinymce.each(d.getParam("media_types","video=mp4,m4v,ogv,webm;"+"silverlight=xap;"+"flash=swf,flv;"+"shockwave=dcr;"+"quicktime=mov,qt,mpg,mpeg;"+"shockwave=dcr;"+"windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;"+"realmedia=rm,ra,ram;"+"java=jar;"+"audio=mp3,ogg").split(';'),function(g){var i,j,k;g=g.split(/=/);j=tinymce.explode(g[1].toLowerCase());for(i=0;i<j.length;i++){k=l[g[0].toLowerCase()];if(k){l[j[i]]=k;}}});b=new RegExp('write('+b+')\\(([^)]+)\\)');f.lookup=l;d.onPreInit.add(function(){d.schema.addValidElements('object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]');d.parser.addNodeFilter('object,embed,video,audio,script,iframe',function(j){var i=j.length;while(i--){f.objectToImg(j[i]);}});d.serializer.addNodeFilter('img',function(j,n,k){var i=j.length,o;while(i--){o=j[i];if((o.attr('class')||'').indexOf('mceItemMedia')!==-1){f.imgToObject(o,k);}}});});d.onInit.add(function(){if(d.theme&&d.theme.onResolveName){d.theme.onResolveName.add(function(j,p){if(p.name==='img'&&d.dom.hasClass(p.node,'mceItemMedia')){p.name='media';}});}if(d&&d.plugins.contextmenu){d.plugins.contextmenu.onContextMenu.add(function(p,j,k){if(k.nodeName==='IMG'&&k.className.indexOf('mceItemMedia')!==-1){j.add({title:'media.edit',icon:'media',cmd:'mceMedia'});}});}});d.addCommand('mceMedia',function(){var j,k;k=d.selection.getNode();if(h(k)){j=d.dom.getAttrib(k,'data-mce-json');if(j){j=J.parse(j);tinymce.each(r,function(n){var v=d.dom.getAttrib(k,n);if(v){j[n]=v;}});j.type=f.getType(k.className).name.toLowerCase();}}if(!j){j={type:'flash',video:{sources:[]},params:{}};}d.windowManager.open({file:u+'/media.htm',width:430+parseInt(d.getLang('media.delta_width',0)),height:500+parseInt(d.getLang('media.delta_height',0)),inline:1},{plugin_url:u,data:j});});d.addButton('media',{title:'media.desc',cmd:'mceMedia'});d.onNodeChange.add(function(d,j,k){j.setActive('media',h(k));});},convertUrl:function(u,f){var d=this,g=d.editor,h=g.settings,i=h.url_converter,j=h.url_converter_scope||d;if(!u){return u;}if(f){return g.documentBaseURI.toAbsolute(u);}return i.call(j,u,'src','object');},getInfo:function(){return{longname:'Media',author:'Moxiecode Systems AB',authorurl:'http://tinymce.moxiecode.com',infourl:'http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media',version:tinymce.majorVersion+"."+tinymce.minorVersion};},dataToImg:function(d,f){var g=this,h,j,k,i;d.params.src=g.convertUrl(d.params.src,f);j=d.video.attrs;if(j){j.src=g.convertUrl(j.src,f);}if(j){j.poster=g.convertUrl(j.poster,f);}h=t(d.video.sources);if(h){for(i=0;i<h.length;i++){h[i].src=g.convertUrl(h[i].src,f);}}k=g.editor.dom.create('img',{id:d.id,style:d.style,align:d.align,hspace:d.hspace,vspace:d.vspace,src:g.editor.theme.url+'/img/trans.gif','class':'mceItemMedia mceItem'+g.getType(d.type).name,'data-mce-json':J.serialize(d,"'")});k.width=d.width=c(d.width||(d.type=='audio'?"300":"320"));k.height=d.height=c(d.height||(d.type=='audio'?"32":"240"));return k;},dataToHtml:function(d,f){return this.editor.serializer.serialize(this.dataToImg(d,f),{forced_root_block:'',force_absolute:f});},htmlToData:function(h){var f,i,d;d={type:'flash',video:{sources:[]},params:{}};f=this.editor.parser.parse(h);i=f.getAll('img')[0];if(i){d=J.parse(i.attr('data-mce-json'));d.type=this.getType(i.attr('class')).name.toLowerCase();tinymce.each(r,function(n){var v=i.attr(n);if(v){d[n]=v;}});}return d;},getType:function(v){var i,d,f;d=tinymce.explode(v,' ');for(i=0;i<d.length;i++){f=this.lookup[d[i]];if(f){return f;}}},imgToObject:function(d,f){var g=this,h=g.editor,v,o,j,k,l,p,q,u,w,x,i,y,z,A,B,C;function D(F,G){var H,I,K,L,M;M=h.getParam('flash_video_player_url',g.convertUrl(g.url+'/moxieplayer.swf'));if(M){H=h.documentBaseURI;p.params.src=M;if(h.getParam('flash_video_player_absvideourl',true)){F=H.toAbsolute(F||'',true);G=H.toAbsolute(G||'',true);}K='';I=h.getParam('flash_video_player_flashvars',{url:'$url',poster:'$poster'});tinymce.each(I,function(l,k){l=l.replace(/\$url/,F||'');l=l.replace(/\$poster/,G||'');if(l.length>0){K+=(K?'&':'')+k+'='+escape(l);}});if(K.length){p.params.flashvars=K;}L=h.getParam('flash_video_player_params',{allowfullscreen:true,allowscriptaccess:true});tinymce.each(L,function(l,k){p.params[k]=""+l;});}}function E(d,B,r,p){o=new N('object',1).attr({id:d.attr('id'),width:c(d.attr('width')),height:c(d.attr('height')),style:B});tinymce.each(r,function(k){var l=p[k];if(k=='class'&&l){l=l.replace(/mceItem.+ ?/g,'');}if(l&&k!='type'){o.attr(k,l);}});for(var k in p.params){var w;w=new N('param',1);w.shortEnded=true;l=p.params[k];if(k==='src'&&x.name==='WindowsMedia'){k='url';}w.attr({name:k,value:l});o.append(w);}if(p.object_html){l=new N('#text',3);l.raw=true;l.value=p.object_html;o.append(l);}if(v){v.append(o);}return o;}p=d.attr('data-mce-json');if(!p){return;}p=J.parse(p);x=this.getType(d.attr('class'));B=d.attr('data-mce-style');if(!B){B=d.attr('style');if(B){B=h.dom.serializeStyle(h.dom.parseStyle(B,'img'));}}p.width=d.attr('width')||p.width;p.height=d.attr('height')||p.height;if(x.name==='Iframe'){z=new N('iframe',1);tinymce.each(r,function(k){var l=d.attr(k);if(k=='class'&&l){l=l.replace(/mceItem.+ ?/g,'');}if(l&&l.length>0){z.attr(k,l);}});for(k in p.params){z.attr(k,p.params[k]);}z.attr({style:B,src:p.params.src});d.replace(z);return;}if(this.editor.settings.media_use_script){z=new N('script',1).attr('type','text/javascript');l=new N('#text',3);l.value='write'+x.name+'('+J.serialize(tinymce.extend(p.params,{width:d.attr('width'),height:d.attr('height')}))+');';z.append(l);d.replace(z);return;}if(x.name==='Video'&&p.video.sources[0]){v=new N('video',1).attr(tinymce.extend({id:d.attr('id'),width:c(d.attr('width')),height:c(d.attr('height')),style:B},p.video.attrs));if(p.video.attrs){A=p.video.attrs.poster;}u=p.video.sources=t(p.video.sources);for(i=0;i<u.length;i++){if(/\.mp4$/.test(u[i].src)){y=u[i].src;}}if(!u[0].type){v.attr('src',u[0].src);u.splice(0,1);}for(i=0;i<u.length;i++){q=new N('source',1).attr(u[i]);q.shortEnded=true;v.append(q);}if(y){D(y,A);x=g.getType('flash');}else{p.params.src='';}}if(x.name==='Audio'&&p.video.sources[0]){C=new N('audio',1).attr(tinymce.extend({id:d.attr('id'),width:c(d.attr('width')),height:c(d.attr('height')),style:B},p.video.attrs));if(p.video.attrs){A=p.video.attrs.poster;}u=p.video.sources=t(p.video.sources);if(!u[0].type){C.attr('src',u[0].src);u.splice(0,1);}for(i=0;i<u.length;i++){q=new N('source',1).attr(u[i]);q.shortEnded=true;C.append(q);}p.params.src='';}if(x.name==='EmbeddedAudio'){j=new N('embed',1);j.shortEnded=true;j.attr({id:d.attr('id'),width:c(d.attr('width')),height:c(d.attr('height')),style:B,type:d.attr('type')});for(k in p.params){j.attr(k,p.params[k]);}tinymce.each(r,function(k){if(p[k]&&k!='type'){j.attr(k,p[k]);}});p.params.src='';}if(p.params.src){if(/\.flv$/i.test(p.params.src)){D(p.params.src,'');}if(f&&f.force_absolute){p.params.src=h.documentBaseURI.toAbsolute(p.params.src);}o=E(d,B,r,p,v);if(this.editor.getParam('media_strict',true)){o.attr({data:p.params.src,type:x.mimes[0]});}else{if(x.clsids[0]){o.attr({classid:"clsid:"+x.clsids[0],codebase:x.codebase});}j=new N('embed',1);j.shortEnded=true;j.attr({id:d.attr('id'),width:c(d.attr('width')),height:c(d.attr('height')),style:B,type:x.mimes[0]});for(k in p.params){j.attr(k,p.params[k]);}tinymce.each(r,function(k){if(p[k]&&k!='type'){j.attr(k,p[k]);}});o.append(j);}}else if(x.name==='Object'){delete p.params.src;o=E(d,B,r,p,v);}if(v){if(p.video_html){l=new N('#text',3);l.raw=true;l.value=p.video_html;v.append(l);}}if(C){if(p.video_html){l=new N('#text',3);l.raw=true;l.value=p.video_html;C.append(l);}}var n=v||C||o||j;if(n){d.replace(n);}else{d.remove();}},objectToImg:function(n){var d,f,v,g,h,j,k,w,l,p,i,q,u,x,y,z,A,B,C=this.lookup,D,E,F=this.editor.settings.url_converter,G=this.editor.settings.url_converter_scope,H,I,K,L;function M(n){return new tinymce.html.Serializer({inner:true,validate:false}).serialize(n);}function O(o,Q){return C[(o.attr(Q)||'').toLowerCase()];}function P(o){var Q=o.replace(/^.*\.([^.]+)$/,'$1');return C[Q.toLowerCase()||''];}if(!n.parent){return;}if(n.name==='script'){if(n.firstChild){D=b.exec(n.firstChild.value);}if(!D){return;}B=D[1];A={video:{},params:J.parse(D[2])};w=A.params.width;l=A.params.height;}A=A||{video:{},params:{}};h=new N('img',1);h.attr({src:this.editor.theme.url+'/img/trans.gif'});j=n.name;if(j==='video'||j=='audio'){v=n;d=n.getAll('object')[0];f=n.getAll('embed')[0];w=v.attr('width');l=v.attr('height');k=v.attr('id');A.video={attrs:{},sources:[]};E=A.video.attrs;for(j in v.attributes.map){E[j]=v.attributes.map[j];}y=n.attr('src');if(y){A.video.sources.push({src:F.call(G,y,'src',n.name)});}z=v.getAll("source");for(i=0;i<z.length;i++){y=z[i].remove();A.video.sources.push({src:F.call(G,y.attr('src'),'src','source'),type:y.attr('type'),media:y.attr('media')});}if(E.poster){E.poster=F.call(G,E.poster,'poster',n.name);}}if(n.name==='object'){d=n;f=n.getAll('embed')[0];}if(n.name==='embed'){f=n;}if(n.name==='iframe'){g=n;B='Iframe';}if(d){p=p||d.attr('style');k=k||d.attr('id');H=H||d.attr('hspace');I=I||d.attr('vspace');K=K||d.attr('align');L=L||d.attr('bgcolor');A.name=d.attr('name');A["class"]=d.attr('class');x=d.getAll("param");for(i=0;i<x.length;i++){u=x[i];j=u.remove().attr('name');if(!a[j]){A.params[j]=u.attr('value');}}w=w||d.attr('width')||A.params.width;l=l||d.attr('height')||A.params.height;A.params.src=A.params.src||d.attr('data');}if(f){w=w||f.attr('width');l=l||f.attr('height');p=p||f.attr('style');k=k||f.attr('id');H=H||f.attr('hspace');I=I||f.attr('vspace');K=K||f.attr('align');L=L||f.attr('bgcolor');for(j in f.attributes.map){if(!e[j]&&!A.params[j]){A.params[j]=f.attributes.map[j];}}}if(g){w=c(g.attr('width'));l=c(g.attr('height'));p=p||g.attr('style');k=g.attr('id');H=g.attr('hspace');I=g.attr('vspace');K=g.attr('align');L=g.attr('bgcolor');tinymce.each(r,function(j){h.attr(j,g.attr(j));});for(j in g.attributes.map){if(!e[j]&&!A.params[j]){A.params[j]=g.attributes.map[j];}}}if(A.params.movie){A.params.src=A.params.src||A.params.movie;delete A.params.movie;}if(A.params.src){A.params.src=F.call(G,A.params.src,'src','object');}if(v){if(n.name==='video'){B=C.video.name;}else if(n.name==='audio'){B=C.audio.name;}}if(f&&!B){B=(O(f,'type')||P(A.params.src)||{}).name;}if(d&&!B){B=(O(d,'clsid')||O(d,'classid')||O(d,'type')||{name:'Object'}).name;}if(f&&B=='EmbeddedAudio'){A.params.type=f.attr('type');}n.replace(h);if(f){f.remove();}if(d){q=M(d.remove());if(q){A.object_html=q;}}if(v){q=M(v.remove());if(q){A.video_html=q;}}A.hspace=H;A.vspace=I;A.align=K;A.bgcolor=L;h.attr({id:k,'class':'mceItemMedia mceItem'+(B||'Flash'),style:p,width:w||(n.name=='audio'?"300":"320"),height:l||(n.name=='audio'?"32":"240"),hspace:H,vspace:I,align:K,bgcolor:L,"data-mce-json":J.serialize(A,"'")});}});tinymce.PluginManager.add('media',tinymce.plugins.MediaPlugin);})();
