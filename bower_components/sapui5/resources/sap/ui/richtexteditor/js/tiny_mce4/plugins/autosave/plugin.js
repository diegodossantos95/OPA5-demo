
tinymce._beforeUnloadHandler=function(){var m;tinymce.each(tinymce.editors,function(e){if(e.plugins.autosave){e.plugins.autosave.storeDraft();}if(!m&&e.isDirty()&&e.getParam("autosave_ask_before_unload",true)){m=e.translate("You have unsaved changes are you sure you want to navigate away?");}});return m;};
tinymce.PluginManager.add('autosave',function(e){var s=e.settings,L=tinymce.util.LocalStorage,p,a;p=s.autosave_prefix||'tinymce-autosave-{path}{query}-{id}-';p=p.replace(/\{path\}/g,document.location.pathname);p=p.replace(/\{query\}/g,document.location.search);p=p.replace(/\{id\}/g,e.id);function b(t,k){var m={s:1000,m:60000};t=/^(\d+)([ms]?)$/.exec(''+(t||k));return(t[2]?m[t[2]]:1)*parseInt(t,10);}function h(){var t=parseInt(L.getItem(p+"time"),10)||0;if(new Date().getTime()-t>s.autosave_retention){r(false);return false;}return true;}function r(k){L.removeItem(p+"draft");L.removeItem(p+"time");if(k!==false){e.fire('RemoveDraft');}}function c(){if(!j()&&e.isDirty()){L.setItem(p+"draft",e.getContent({format:'raw',no_events:true}));L.setItem(p+"time",new Date().getTime());e.fire('StoreDraft');}}function d(){if(h()){e.setContent(L.getItem(p+"draft"),{format:'raw'});e.fire('RestoreDraft');}}function f(){if(!a){setInterval(function(){if(!e.removed){c();}},s.autosave_interval);a=true;}}s.autosave_interval=b(s.autosave_interval,'30s');s.autosave_retention=b(s.autosave_retention,'20m');function g(){var k=this;k.disabled(!h());e.on('StoreDraft RestoreDraft RemoveDraft',function(){k.disabled(!h());});f();}function i(){e.undoManager.beforeChange();d();r();e.undoManager.add();}e.addButton('restoredraft',{title:'Restore last draft',onclick:i,onPostRender:g});e.addMenuItem('restoredraft',{text:'Restore last draft',onclick:i,onPostRender:g,context:'file'});function j(k){var l=e.settings.forced_root_block;k=tinymce.trim(typeof k=="undefined"?e.getBody().innerHTML:k);return k===''||new RegExp('^<'+l+'[^>]*>((\u00a0|&nbsp;|[ \t]|<br[^>]*>)+?|)<\/'+l+'>|<br>$','i').test(k);}if(e.settings.autosave_restore_when_empty!==false){e.on('init',function(){if(h()&&j()){d();}});e.on('saveContent',function(){r();});}window.onbeforeunload=tinymce._beforeUnloadHandler;this.hasDraft=h;this.storeDraft=c;this.restoreDraft=d;this.removeDraft=r;this.isEmpty=j;});
