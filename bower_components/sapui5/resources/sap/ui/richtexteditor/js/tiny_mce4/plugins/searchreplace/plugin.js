(function(){function a(n){return n&&n.nodeType==1&&n.contentEditable==="false";}
// released under UNLICENSE that is compatible with LGPL
function f(r,n,b,c,s){var m,d=[],t,e=0,g;var h,j,k;g=n.ownerDocument;h=s.getBlockElements();j=s.getWhiteSpaceElements();k=s.getShortEndedElements();function o(m,c){c=c||0;if(!m[0]){throw'findAndReplaceDOMText cannot handle zero-length matches';}var i=m.index;if(c>0){var l=m[c];if(!l){throw'Invalid capture group';}i+=m[0].indexOf(l);m[0]=l;}return[i,i+m[0].length,[m[0]]];}function p(n){var i;if(n.nodeType===3){return n.data;}if(j[n.nodeName]&&!h[n.nodeName]){return'';}i='';if(a(n)){return'\n';}if(h[n.nodeName]||k[n.nodeName]){i+='\n';}if((n=n.firstChild)){do{i+=p(n);}while((n=n.nextSibling));}return i;}function q(n,d,i){var l,v,w,x,y=[],z=0,A=n,B=d.shift(),C=0;out:while(true){if(h[A.nodeName]||k[A.nodeName]||a(A)){z++;}if(A.nodeType===3){if(!v&&A.length+z>=B[1]){v=A;x=B[1]-z;}else if(l){y.push(A);}if(!l&&A.length+z>B[0]){l=A;w=B[0]-z;}z+=A.length;}if(l&&v){A=i({startNode:l,startNodeIndex:w,endNode:v,endNodeIndex:x,innerNodes:y,match:B[2],matchIndex:C});z-=(v.length-x);l=null;v=null;y=[];B=d.shift();C++;if(!B){break;}}else if((!j[A.nodeName]||h[A.nodeName])&&A.firstChild){if(!a(A)){A=A.firstChild;continue;}}else if(A.nextSibling){A=A.nextSibling;continue;}while(true){if(A.nextSibling){A=A.nextSibling;break;}else if(A.parentNode!==n){A=A.parentNode;}else{break out;}}}}function u(v){var w;if(typeof v!='function'){var x=v.nodeType?v:g.createElement(v);w=function(i,l){var y=x.cloneNode(false);y.setAttribute('data-mce-index',l);if(i){y.appendChild(g.createTextNode(i));}return y;};}else{w=v;}return function(y){var z,A,B,C=y.startNode,D=y.endNode,E=y.matchIndex;if(C===D){var n=C;B=n.parentNode;if(y.startNodeIndex>0){z=g.createTextNode(n.data.substring(0,y.startNodeIndex));B.insertBefore(z,n);}var F=w(y.match[0],E);B.insertBefore(F,n);if(y.endNodeIndex<n.length){A=g.createTextNode(n.data.substring(y.endNodeIndex));B.insertBefore(A,n);}n.parentNode.removeChild(n);return F;}z=g.createTextNode(C.data.substring(0,y.startNodeIndex));A=g.createTextNode(D.data.substring(y.endNodeIndex));var G=w(C.data.substring(y.startNodeIndex),E);var H=[];for(var i=0,l=y.innerNodes.length;i<l;++i){var I=y.innerNodes[i];var J=w(I.data,E);I.parentNode.replaceChild(J,I);H.push(J);}var K=w(D.data.substring(0,y.endNodeIndex),E);B=C.parentNode;B.insertBefore(z,C);B.insertBefore(G,C);B.removeChild(C);B=D.parentNode;B.insertBefore(K,D);B.insertBefore(A,D);B.removeChild(D);return K;};}t=p(n);if(!t){return;}if(r.global){while((m=r.exec(t))){d.push(o(m,c));}}else{m=t.match(r);d.push(o(m,c));}if(d.length){e=d.length;q(n,d,u(b));}return e;}function P(b){var s=this,c=-1;function d(){var l={},i;i=tinymce.trim(b.selection.getContent({format:'text'}));function n(){w.statusbar.find('#next').disabled(!h(c+1).length);w.statusbar.find('#prev').disabled(!h(c-1).length);}function o(){b.windowManager.alert('Could not find the specified string.',function(){w.find('#find')[0].focus();});}var w=b.windowManager.open({layout:"flex",pack:"center",align:"center",onClose:function(){b.focus();s.done();},onSubmit:function(e){var p,q,t,v;e.preventDefault();q=w.find('#case').checked();v=w.find('#words').checked();t=w.find('#find').value();if(!t.length){s.done(false);w.statusbar.items().slice(1).disabled(true);return;}if(l.text==t&&l.caseState==q&&l.wholeWord==v){if(h(c+1).length===0){o();return;}s.next();n();return;}p=s.find(t,q,v);if(!p){o();}w.statusbar.items().slice(1).disabled(p===0);n();l={text:t,caseState:q,wholeWord:v};},buttons:[{text:"Find",subtype:'primary',onclick:function(){w.submit();}},{text:"Replace",disabled:true,onclick:function(){if(!s.replace(w.find('#replace').value())){w.statusbar.items().slice(1).disabled(true);c=-1;l={};}}},{text:"Replace all",disabled:true,onclick:function(){s.replace(w.find('#replace').value(),true,true);w.statusbar.items().slice(1).disabled(true);l={};}},{type:"spacer",flex:1},{text:"Prev",name:'prev',disabled:true,onclick:function(){s.prev();n();}},{text:"Next",name:'next',disabled:true,onclick:function(){s.next();n();}}],title:"Find and replace",items:{type:"form",padding:20,labelGap:30,spacing:10,items:[{type:'textbox',name:'find',size:40,label:'Find',value:i},{type:'textbox',name:'replace',size:40,label:'Replace with'},{type:'checkbox',name:'case',text:'Match case',label:' '},{type:'checkbox',name:'words',text:'Whole words',label:' '}]}});}s.init=function(e){e.addMenuItem('searchreplace',{text:'Find and replace',shortcut:'Meta+F',onclick:d,separator:'before',context:'edit'});e.addButton('searchreplace',{tooltip:'Find and replace',shortcut:'Meta+F',onclick:d});e.addCommand("SearchReplace",d);e.shortcuts.add('Meta+F','',d);};function g(e){var v=e.getAttribute('data-mce-index');if(typeof v=="number"){return""+v;}return v;}function m(e){var n,i;i=b.dom.create('span',{"data-mce-bogus":1});i.className='mce-match-marker';n=b.getBody();s.done(false);return f(e,n,i,false,b.schema);}function u(n){var p=n.parentNode;if(n.firstChild){p.insertBefore(n.firstChild,n);}n.parentNode.removeChild(n);}function h(e){var n,l=[];n=tinymce.toArray(b.getBody().getElementsByTagName('span'));if(n.length){for(var i=0;i<n.length;i++){var o=g(n[i]);if(o===null||!o.length){continue;}if(o===e.toString()){l.push(n[i]);}}}return l;}function j(e){var t=c,i=b.dom;e=e!==false;if(e){t++;}else{t--;}i.removeClass(h(c),'mce-match-marker-selected');var l=h(t);if(l.length){i.addClass(h(t),'mce-match-marker-selected');b.selection.scrollIntoView(l[0]);return t;}return-1;}function r(n){var e=b.dom,p=n.parentNode;e.remove(n);if(e.isEmpty(p)){e.remove(p);}}s.find=function(t,e,w){t=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");t=w?'\\b'+t+'\\b':t;var i=m(new RegExp(t,e?'g':'gi'));if(i){c=-1;c=j(true);}return i;};s.next=function(){var i=j(true);if(i!==-1){c=i;}};s.prev=function(){var i=j(false);if(i!==-1){c=i;}};function k(n){var e=g(n);return e!==null&&e.length>0;}s.replace=function(t,e,l){var i,n,o,p,q,v=c,w;e=e!==false;o=b.getBody();n=tinymce.grep(tinymce.toArray(o.getElementsByTagName('span')),k);for(i=0;i<n.length;i++){var x=g(n[i]);p=q=parseInt(x,10);if(l||p===c){if(t.length){n[i].firstChild.nodeValue=t;u(n[i]);}else{r(n[i]);}while(n[++i]){p=parseInt(g(n[i]),10);if(p===q){r(n[i]);}else{i--;break;}}if(e){v--;}}else if(q>c){n[i].setAttribute('data-mce-index',q-1);}}b.undoManager.add();c=v;if(e){w=h(v+1).length>0;s.next();}else{w=h(v-1).length>0;s.prev();}return!l&&w;};s.done=function(e){var i,n,l,o;n=tinymce.toArray(b.getBody().getElementsByTagName('span'));for(i=0;i<n.length;i++){var p=g(n[i]);if(p!==null&&p.length){if(p===c.toString()){if(!l){l=n[i].firstChild;}o=n[i].firstChild;}u(n[i]);}}if(l&&o){var q=b.dom.createRng();q.setStart(l,0);q.setEnd(o,o.data.length);if(e!==false){b.selection.setRng(q);}return q;}};}tinymce.PluginManager.add('searchreplace',P);})();
