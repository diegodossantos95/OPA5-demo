tinymce.PluginManager.add('layer',function(a){function g(n){do{if(n.className&&n.className.indexOf('mceItemLayer')!=-1){return n;}}while((n=n.parentNode));}function v(e){var d=a.dom;tinymce.each(d.select('div,p',e),function(e){if(/^(absolute|relative|fixed)$/i.test(e.style.position)){if(e.hasVisual){d.addClass(e,'mceItemVisualAid');}else{d.removeClass(e,'mceItemVisualAid');}d.addClass(e,'mceItemLayer');}});}function m(d){var i,z=[],l=g(a.selection.getNode()),c=-1,f=-1,e;e=[];tinymce.walk(a.getBody(),function(n){if(n.nodeType==1&&/^(absolute|relative|static)$/i.test(n.style.position)){e.push(n);}},'childNodes');for(i=0;i<e.length;i++){z[i]=e[i].style.zIndex?parseInt(e[i].style.zIndex,10):0;if(c<0&&e[i]==l){c=i;}}if(d<0){for(i=0;i<z.length;i++){if(z[i]<z[c]){f=i;break;}}if(f>-1){e[c].style.zIndex=z[f];e[f].style.zIndex=z[c];}else{if(z[c]>0){e[c].style.zIndex=z[c]-1;}}}else{for(i=0;i<z.length;i++){if(z[i]>z[c]){f=i;break;}}if(f>-1){e[c].style.zIndex=z[f];e[f].style.zIndex=z[c];}else{e[c].style.zIndex=z[c]+1;}}a.execCommand('mceRepaint');}function b(){var d=a.dom,p=d.getPos(d.getParent(a.selection.getNode(),'*'));var c=a.getBody();a.dom.add(c,'div',{style:{position:'absolute',left:p.x,top:(p.y>20?p.y:20),width:100,height:100},'class':'mceItemVisualAid mceItemLayer'},a.selection.getContent()||a.getLang('layer.content'));if(tinymce.Env.ie){d.setHTML(c,c.innerHTML);}}function t(){var l=g(a.selection.getNode());if(!l){l=a.dom.getParent(a.selection.getNode(),'DIV,P,IMG');}if(l){if(l.style.position.toLowerCase()=="absolute"){a.dom.setStyles(l,{position:'',left:'',top:'',width:'',height:''});a.dom.removeClass(l,'mceItemVisualAid');a.dom.removeClass(l,'mceItemLayer');}else{if(!l.style.left){l.style.left=20+'px';}if(!l.style.top){l.style.top=20+'px';}if(!l.style.width){l.style.width=l.width?(l.width+'px'):'100px';}if(!l.style.height){l.style.height=l.height?(l.height+'px'):'100px';}l.style.position="absolute";a.dom.setAttrib(l,'data-mce-style','');a.addVisual(a.getBody());}a.execCommand('mceRepaint');a.nodeChanged();}}a.addCommand('mceInsertLayer',b);a.addCommand('mceMoveForward',function(){m(1);});a.addCommand('mceMoveBackward',function(){m(-1);});a.addCommand('mceMakeAbsolute',function(){t();});a.addButton('moveforward',{title:'layer.forward_desc',cmd:'mceMoveForward'});a.addButton('movebackward',{title:'layer.backward_desc',cmd:'mceMoveBackward'});a.addButton('absolute',{title:'layer.absolute_desc',cmd:'mceMakeAbsolute'});a.addButton('insertlayer',{title:'layer.insertlayer_desc',cmd:'mceInsertLayer'});a.on('init',function(){if(tinymce.Env.ie){a.getDoc().execCommand('2D-Position',false,true);}});a.on('mouseup',function(e){var l=g(e.target);if(l){a.dom.setAttrib(l,'data-mce-style','');}});a.on('mousedown',function(e){var n=e.target,d=a.getDoc(),p;if(tinymce.Env.gecko){if(g(n)){if(d.designMode!=='on'){d.designMode='on';n=d.body;p=n.parentNode;p.removeChild(n);p.appendChild(n);}}else if(d.designMode=='on'){d.designMode='off';}}});a.on('NodeChange',v);});
