define("tinymce/imagetoolsplugin/Plugin",["global!tinymce.PluginManager","global!tinymce.Env","global!tinymce.util.Promise","global!tinymce.util.URI","global!tinymce.util.Tools","global!tinymce.util.Delay","ephox/imagetools/api/ImageTransformations","ephox/imagetools/api/BlobConversions","tinymce/imagetoolsplugin/Dialog","tinymce/imagetoolsplugin/ImageSize","tinymce/imagetoolsplugin/Proxy"],function(P,E,a,U,T,D,I,B,b,c,d){var p=function(f){var g=0,i,l;if(!E.fileApi){return;}function h(e){f.notificationManager.open({text:e,type:'error'});}function j(){return f.selection.getNode();}function k(){return'imagetools'+g++;}function m(e){var G=e.src;return G.indexOf('data:')===0||G.indexOf('blob:')===0||new U(G).host===f.documentBaseURI.host;}function n(e){return T.inArray(f.settings.imagetools_cors_hosts,new U(e.src).host)!==-1;}function o(){return f.settings.api_key||f.settings.imagetools_api_key;}function q(e){var G=e.src,H;if(n(e)){return d.getUrl(e.src,null);}if(!m(e)){G=f.settings.imagetools_proxy;G+=(G.indexOf('?')===-1?'?':'&')+'url='+encodeURIComponent(e.src);H=o();return d.getUrl(G,H);}return B.imageToBlob(e);}function r(){var e;e=f.editorUpload.blobCache.getByUri(j().src);if(e){return e.blob();}return q(j());}function s(){i=D.setEditorTimeout(f,function(){f.editorUpload.uploadImagesAuto();},30000);}function t(){clearTimeout(i);}function u(e,G){return B.blobToDataUri(e).then(function(H){var J,K,L,M,N;N=j();J=k();L=f.editorUpload.blobCache;K=U.parseDataUri(H).data;M=L.create(J,e,K);L.add(M);f.undoManager.transact(function(){function O(){f.$(N).off('load',O);f.nodeChanged();if(G){f.editorUpload.uploadImagesAuto();}else{t();s();}}f.$(N).on('load',O);f.$(N).attr({src:M.blobUri()}).removeAttr('data-mce-src');});return M;});}function v(e){return function(){return f._scanForImages().then(r).then(e).then(u,h);};}function w(e){return function(){return v(function(G){var H=c.getImageSize(j());if(H){c.setImageSize(j(),{w:H.h,h:H.w});}return I.rotate(G,e);})();};}function x(e){return function(){return v(function(G){return I.flip(G,e);})();};}function y(){var e=j(),G=c.getNaturalImageSize(e);var H=function(K){return new a(function(L){B.blobToImage(K).then(function(M){var N=c.getNaturalImageSize(M);if(G.w!=N.w||G.h!=N.h){if(c.getImageSize(e)){c.setImageSize(e,N);}}URL.revokeObjectURL(M.src);L(K);});});};var J=function(K){return b.edit(K).then(H).then(function(K){u(K,true);},function(){});};if(e){q(e).then(J,h);}}function z(){f.addButton('rotateleft',{title:'Rotate counterclockwise',onclick:w(-90)});f.addButton('rotateright',{title:'Rotate clockwise',onclick:w(90)});f.addButton('flipv',{title:'Flip vertically',onclick:x('v')});f.addButton('fliph',{title:'Flip horizontally',onclick:x('h')});f.addButton('editimage',{title:'Edit image',onclick:y});f.addButton('imageoptions',{title:'Image options',icon:'options',cmd:'mceImage'});}function A(){f.on('NodeChange',function(e){if(l&&l.src!=e.element.src){t();f.editorUpload.uploadImagesAuto();l=undefined;}if(C(e.element)){l=e.element;}});}function C(e){var G=f.dom.is(e,'img:not([data-mce-object],[data-mce-placeholder])');return G&&(m(e)||n(e)||f.settings.imagetools_proxy);}function F(){var e=f.settings.imagetools_toolbar;if(!e){e='rotateleft rotateright | flipv fliph | crop editimage imageoptions';}f.addContextToolbar(C,e);}z();F();A();f.addCommand('mceEditImage',y);};P.add('imagetools',p);return function(){};});
