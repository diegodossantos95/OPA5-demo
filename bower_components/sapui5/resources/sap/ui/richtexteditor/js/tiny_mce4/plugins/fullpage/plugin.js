tinymce.PluginManager.add('fullpage',function(b){var c=tinymce.each,N=tinymce.html.Node;var h,f;function d(){var a=g();b.windowManager.open({title:'Document properties',data:a,defaults:{type:'textbox',size:40},body:[{name:'title',label:'Title'},{name:'keywords',label:'Keywords'},{name:'description',label:'Description'},{name:'robots',label:'Robots'},{name:'author',label:'Author'},{name:'docencoding',label:'Encoding'}],onSubmit:function(e){j(tinymce.extend(a,e.data));}});}function g(){var a=p(),e={},i,n;function o(i,q){var v=i.attr(q);return v||'';}e.fontface=b.getParam("fullpage_default_fontface","");e.fontsize=b.getParam("fullpage_default_fontsize","");i=a.firstChild;if(i.type==7){e.xml_pi=true;n=/encoding="([^"]+)"/.exec(i.value);if(n){e.docencoding=n[1];}}i=a.getAll('#doctype')[0];if(i){e.doctype='<!DOCTYPE'+i.value+">";}i=a.getAll('title')[0];if(i&&i.firstChild){e.title=i.firstChild.value;}c(a.getAll('meta'),function(q){var r=q.attr('name'),s=q.attr('http-equiv'),n;if(r){e[r.toLowerCase()]=q.attr('content');}else if(s=="Content-Type"){n=/charset\s*=\s*(.*)\s*/gi.exec(q.attr('content'));if(n){e.docencoding=n[1];}}});i=a.getAll('html')[0];if(i){e.langcode=o(i,'lang')||o(i,'xml:lang');}e.stylesheets=[];tinymce.each(a.getAll('link'),function(q){if(q.attr('rel')=='stylesheet'){e.stylesheets.push(q.attr('href'));}});i=a.getAll('body')[0];if(i){e.langdir=o(i,'dir');e.style=o(i,'style');e.visited_color=o(i,'vlink');e.link_color=o(i,'link');e.active_color=o(i,'alink');}return e;}function j(a){var e,n,o,q,v,r=b.dom;function s(q,i,v){q.attr(i,v?v:undefined);}function t(i){if(n.firstChild){n.insert(i,n.firstChild);}else{n.append(i);}}e=p();n=e.getAll('head')[0];if(!n){q=e.getAll('html')[0];n=new N('head',1);if(q.firstChild){q.insert(n,q.firstChild,true);}else{q.append(n);}}q=e.firstChild;if(a.xml_pi){v='version="1.0"';if(a.docencoding){v+=' encoding="'+a.docencoding+'"';}if(q.type!=7){q=new N('xml',7);e.insert(q,e.firstChild,true);}q.value=v;}else if(q&&q.type==7){q.remove();}q=e.getAll('#doctype')[0];if(a.doctype){if(!q){q=new N('#doctype',10);if(a.xml_pi){e.insert(q,e.firstChild);}else{t(q);}}q.value=a.doctype.substring(9,a.doctype.length-1);}else if(q){q.remove();}q=null;c(e.getAll('meta'),function(i){if(i.attr('http-equiv')=='Content-Type'){q=i;}});if(a.docencoding){if(!q){q=new N('meta',1);q.attr('http-equiv','Content-Type');q.shortEnded=true;t(q);}q.attr('content','text/html; charset='+a.docencoding);}else if(q){q.remove();}q=e.getAll('title')[0];if(a.title){if(!q){q=new N('title',1);t(q);}else{q.empty();}q.append(new N('#text',3)).value=a.title;}else if(q){q.remove();}c('keywords,description,author,copyright,robots'.split(','),function(w){var x=e.getAll('meta'),i,y,v=a[w];for(i=0;i<x.length;i++){y=x[i];if(y.attr('name')==w){if(v){y.attr('content',v);}else{y.remove();}return;}}if(v){q=new N('meta',1);q.attr('name',w);q.attr('content',v);q.shortEnded=true;t(q);}});var u={};tinymce.each(e.getAll('link'),function(i){if(i.attr('rel')=='stylesheet'){u[i.attr('href')]=i;}});tinymce.each(a.stylesheets,function(i){if(!u[i]){q=new N('link',1);q.attr({rel:'stylesheet',text:'text/css',href:i});q.shortEnded=true;t(q);}delete u[i];});tinymce.each(u,function(i){i.remove();});q=e.getAll('body')[0];if(q){s(q,'dir',a.langdir);s(q,'style',a.style);s(q,'vlink',a.visited_color);s(q,'link',a.link_color);s(q,'alink',a.active_color);r.setAttribs(b.getBody(),{style:a.style,dir:a.dir,vLink:a.visited_color,link:a.link_color,aLink:a.active_color});}q=e.getAll('html')[0];if(q){s(q,'lang',a.langcode);s(q,'xml:lang',a.langcode);}if(!n.firstChild){n.remove();}o=new tinymce.html.Serializer({validate:false,indent:true,apply_source_formatting:true,indent_before:'head,html,body,meta,title,script,link,style',indent_after:'head,html,body,meta,title,script,link,style'}).serialize(e);h=o.substring(0,o.indexOf('</body>'));}function p(){return new tinymce.html.DomParser({validate:false,root_name:'#document'}).parse(h);}function k(e){var i,n,o=e.content,q,r='',t=b.dom,u;if(e.selection){return;}function v(s){return s.replace(/<\/?[A-Z]+/g,function(a){return a.toLowerCase();});}if(e.format=='raw'&&h){return;}if(e.source_view&&b.getParam('fullpage_hide_in_source_view')){return;}if(o.length===0&&!e.source_view){o=tinymce.trim(h)+'\n'+tinymce.trim(o)+'\n'+tinymce.trim(f);}o=o.replace(/<(\/?)BODY/gi,'<$1body');i=o.indexOf('<body');if(i!=-1){i=o.indexOf('>',i);h=v(o.substring(0,i+1));n=o.indexOf('</body',i);if(n==-1){n=o.length;}e.content=o.substring(i+1,n);f=v(o.substring(n));}else{h=l();f='\n</body>\n</html>';}q=p();c(q.getAll('style'),function(a){if(a.firstChild){r+=a.firstChild.value;}});u=q.getAll('body')[0];if(u){t.setAttribs(b.getBody(),{style:u.attr('style')||'',dir:u.attr('dir')||'',vLink:u.attr('vlink')||'',link:u.attr('link')||'',aLink:u.attr('alink')||''});}t.remove('fullpage_styles');var w=b.getDoc().getElementsByTagName('head')[0];if(r){t.add(w,'style',{id:'fullpage_styles'},r);u=t.get('fullpage_styles');if(u.styleSheet){u.styleSheet.cssText=r;}}var x={};tinymce.each(w.getElementsByTagName('link'),function(s){if(s.rel=='stylesheet'&&s.getAttribute('data-mce-fullpage')){x[s.href]=s;}});tinymce.each(q.getAll('link'),function(s){var a=s.attr('href');if(!a){return true;}if(!x[a]&&s.attr('rel')=='stylesheet'){t.add(w,'link',{rel:'stylesheet',text:'text/css',href:a,'data-mce-fullpage':'1'});}delete x[a];});tinymce.each(x,function(s){s.parentNode.removeChild(s);});}function l(){var a='',v,s='';if(b.getParam('fullpage_default_xml_pi')){a+='<?xml version="1.0" encoding="'+b.getParam('fullpage_default_encoding','ISO-8859-1')+'" ?>\n';}a+=b.getParam('fullpage_default_doctype','<!DOCTYPE html>');a+='\n<html>\n<head>\n';if((v=b.getParam('fullpage_default_title'))){a+='<title>'+v+'</title>\n';}if((v=b.getParam('fullpage_default_encoding'))){a+='<meta http-equiv="Content-Type" content="text/html; charset='+v+'" />\n';}if((v=b.getParam('fullpage_default_font_family'))){s+='font-family: '+v+';';}if((v=b.getParam('fullpage_default_font_size'))){s+='font-size: '+v+';';}if((v=b.getParam('fullpage_default_text_color'))){s+='color: '+v+';';}a+='</head>\n<body'+(s?' style="'+s+'"':'')+'>\n';return a;}function m(e){if(!e.selection&&(!e.source_view||!b.getParam('fullpage_hide_in_source_view'))){e.content=tinymce.trim(h)+'\n'+tinymce.trim(e.content)+'\n'+tinymce.trim(f);}}b.addCommand('mceFullPageProperties',d);b.addButton('fullpage',{title:'Document properties',cmd:'mceFullPageProperties'});b.addMenuItem('fullpage',{text:'Document properties',cmd:'mceFullPageProperties',context:'file'});b.on('BeforeSetContent',k);b.on('GetContent',m);});
