/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','./library','sap/ui/core/IconPool','sap/ui/core/Item'],function(q,C,l,I,a){"use strict";var T=C.extend("sap.ui.richtexteditor.ToolbarWrapper",{metadata:{interfaces:["sap.ui.richtexteditor.IToolbar"],library:"sap.ui.richtexteditor",aggregations:{_toolbar:{type:"sap.m.OverflowToolbar",multiple:false,visibility:"hidden"},_customInsertImageDialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_customInsertLinkDialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_customTextColorDialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_customBackgroundColorDialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_customInsertTableDialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{editor:{type:"sap.ui.richtexteditor.RichTextEditor",multiple:false}}}});T.prototype.init=function(){this._helper=l.RichTextEditorHelper;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.richtexteditor");};T.prototype.onBeforeRendering=function(){if(!this.getAggregation("_toolbar")){this.setAggregation("_toolbar",this._createCustomToolbar());this.setAggregation("_customInsertImageDialog",this._helper.createDialog(this._createInsertImageConfig("InsertImage")));this.setAggregation("_customInsertLinkDialog",this._helper.createDialog(this._createInsertLinkConfig("InsertLink")));this.setAggregation("_customTextColorDialog",this._helper.createDialog(this._createColorDialogConfig("TextColor")));this.setAggregation("_customBackgroundColorDialog",this._helper.createDialog(this._createColorDialogConfig("BackgroundColor")));this.setAggregation("_customInsertTableDialog",this._helper.createDialog(this._createInsertTableConfig("InsertTable")));}};T.prototype.exit=function(){this._customButtons=null;};T.prototype._getId=function(e){this._getId.counter=this._getId.counter?this._getId.counter+1:1;var r=this.getEditor()?this.getEditor().getId():"_rte"+this._getId.counter,t=this.getId(),b=[r+t];if(e||e===0){b.push(e);}return b.join("-");};T.prototype.getEditor=function(){var i=this.getAssociation("editor"),e=sap.ui.getCore().byId(i);return e||null;};T.prototype.modifyRTEToolbarConfig=function(c){var t=this;c.toolbar=false;c.setup=function(e){e.on('init',function(){var E=l.EditorCommands;e.execCommand("FontName",false,E["FontFamily"]["Verdana"].commandValue);e.execCommand("FontSize",false,"8");e.execCommand("JustifyLeft",false);});e.on('NodeChange',function(){t._syncToolbarStates(this);});};return c;};T.prototype._syncToolbarStates=function(n){var e,c,E,o=l.EditorCommands,f=n.formatter,_=function(t,d,c){var A;for(A in t){if(t.hasOwnProperty(A)&&d.match(t[A].style)){if(c.getIcon()!==I.getIconURI(e[A].icon)){c.setIcon(I.getIconURI(e[A].icon));}else{c.setIcon(I.getIconURI(e["Left"].icon));}break;}}},b=function(d,F,c){var s,g,t,h=d.getDoc().queryCommandValue("FontName");for(s in F){if(!F.hasOwnProperty(s)){break;}g=F[s].commandValue.match(/\w+/g).join("").toLowerCase();h=h&&h.match(/\w+/g).join("").toLowerCase();t=F[s].text.match(/\w+/g).join("").toLowerCase();if(g===h||h===t){c.setSelectedItemId(c.getId()+s);break;}}};for(E in o){if(!o.hasOwnProperty(E)){continue;}e=o[E];c=sap.ui.getCore().byId(this._getId(E));if(!c){continue;}if(E==="TextAlign"){_(e,f,c);}else if(E==="FontFamily"){b(n,e,c);}else if(E==="FontSize"&&n.getDoc().queryCommandValue(E)){c.setSelectedItemId(c.getId()+n.getDoc().queryCommandValue(E));}else if(c.getMetadata().getName()==="sap.m.ToggleButton"){c.setPressed(f.match(e.style));}}};T.prototype._createButtonConfig=function(c){var e=l.EditorCommands,o=e[c],r=this.getEditor();return{id:this._getId(c),icon:I.getIconURI(o.icon),tooltip:this._oResourceBundle.getText(o.bundleKey),press:function(){if(r){r.getNativeApi().execCommand(o.command);}else{q.sap.log.warning("Cannot execute native command: "+o.command);}}};};T.prototype._createMenuButtonItems=function(c){var e=this._helper,E=l.EditorCommands,i=[],o;for(var s in E[c]){if(s==='bundleKey'){continue;}o=E[c][s];i.push(e.createMenuItem(this._getId(c+s),o.text,I.getIconURI(o.icon)));}return i;};T.prototype._createFontStyleSelectItems=function(){var e=l.EditorCommands,f=e["FontFamily"],i=[],o;for(var F in f){o={id:this._getId("FontFamily"+F),text:f[F].text};i.push(new a(o));}return i;};T.prototype._getFontStyleCommand=function(i){var e=l.EditorCommands,f=e["FontFamily"];for(var F in f){if(f.hasOwnProperty(F)&&f[F].text===i){return f[F].commandValue;}}};T.prototype._createFontSizeSelectItems=function(){var i=[],n=1,o,e=l.EditorCommands;e["FontSize"].forEach(function(b){o={id:this._getId("FontSize"+n),text:b+"pt"};i.push(new a(o));n++;},this);return i;};T.prototype._getColor=function(c){var r=this.getEditor(),o=l.EditorCommands[c].style,n=r.getNativeApi().selection.getNode(),N=r.getNativeApi().dom.getParents(n),i,b,s;for(i=0;i<N.length;i++){b=N[i];s=b.style[o];if(s&&s!=""){return s;}}return l.EditorCommands[c].defaultValue;};T.prototype._createButtonForDialog=function(c){var o=l.EditorCommands[c],t=this;if(!o){return;}return{id:this._getId(c),icon:sap.ui.core.IconPool.getIconURI(o.icon),tooltip:this._oResourceBundle.getText(o.bundleKey),press:function(){if(c.indexOf("Color")!==-1){t.getAggregation("_custom"+c+"Dialog").getContent()[0].setColorString(t._getColor(c));}t.getAggregation("_custom"+c+"Dialog").open();}};};T.prototype._createColorDialogConfig=function(t){var c=l.EditorCommands[t],e=this._helper,o=e.createColorPicker(),r=this.getEditor(),b=this,B=[];if(!c){return;}B.push(e.createButton({id:this._getId("OKButton"+t),text:"OK",press:function(){if(b._getColor(t).replace(/,\s/g,',')!==o.getColorString()){r.getNativeApi().execCommand(c.command,false,o.Color.hex);}b.getAggregation("_custom"+t+"Dialog").close();}}));B.push(e.createButton({id:this._getId("cancelButton"+t),text:"Cancel",press:function(){b.getAggregation("_custom"+t+"Dialog").close();}}));return{contentWidth:'320px',title:c.title,content:[o],buttons:B};};T.prototype._generateImageHTML=function(u,t,h,w,r){var U=u?' src="'+u+'"':'',A=t?' alt="'+t+'"':'',H=h?' height="'+h+'px"':'',W=w?' width="'+h+'px"':'',d=H+W;if(r){d=H?H:W;}return'<img'+U+A+d+'/>';};T.prototype._createInsertImageConfig=function(){var u=this._helper.createInput(),U=this._helper.createLabel({text:"Source URL",labelFor:u}),t=this._helper.createInput(),o=this._helper.createLabel({text:"Image Description",labelFor:t}),d=this._helper.createInput({width:'8rem',fieldWidth:"6rem",description:'px'}),b=this._helper.createText({textAlign:"Center",width:'2rem',text:'x'}),D=this._helper.createInput({fieldWidth:"6rem",width:'8rem',description:'px'}),c=this._helper.createHBox({wrap:"Wrap",alignItems:"Center",justifyContent:"SpaceBetween",items:[d,b,D]}),e=this._helper.createLabel({text:"Dimensions"}),r=this._helper.createCheckBox(),R=this._helper.createLabel({text:"Maintain Aspect Ratio",labelFor:r}),f=this.getEditor(),g=this,B=[];B.push(this._helper.createButton({id:this._getId("InsertImageButton"),text:"Insert",press:function(){f.getNativeApi().insertContent(g._generateImageHTML(u.getValue(),t.getValue(),d.getValue(),D.getValue(),r.getSelected()));g.getAggregation("_customInsertImageDialog").close();}}));B.push(this._helper.createButton({id:this._getId("CancelInsertImageButton"),text:"Cancel",press:function(){g.getAggregation("_customInsertImageDialog").close();}}));return{contentWidth:'320px',title:sap.ui.richtexteditor.EditorCommands["InsertImage"].title,buttons:B,content:[U,u,o,t,e,c,r,R]};};T.prototype._generateLinkHTML=function(u,t,s,b){var U=u?' href="'+u+'"':'',c=s?' title="'+s+'"':'',d=b?' target="_blank"':'';t=t?t:'';return'<a'+U+c+d+'>'+t+'</a>';};T.prototype._createInsertLinkConfig=function(){var u=this._helper.createInput(),U=this._helper.createLabel({text:"URL",labelFor:u}),t=this._helper.createInput(),o=this._helper.createLabel({text:"Display Text",labelFor:t}),b=this._helper.createInput(),c=this._helper.createLabel({text:"Title",labelFor:b}),d=this._helper.createSelect({id:this._getId("InsertLinkSelect"),items:[new a({id:this._getId("InsertLinkSelectNone"),text:"None"}),new a({id:this._getId("InsertLinkSelectNewWindow"),text:"New Window"})]}),e=this._helper.createLabel({text:"Target",labelFor:d}),f=this._helper.createVBox({direction:"Column",alignItems:"Start",items:[e,d]}),r=this.getEditor(),g=this,B=[];B.push(this._helper.createButton({id:this._getId("InsertLinkButton"),text:"Insert",press:function(E){var h=d.getSelectedItem().getText()==="New Window"?true:false;r.getNativeApi().insertContent(g._generateLinkHTML(u.getValue(),t.getValue(),b.getValue(),h));g.getAggregation("_customInsertLinkDialog").close();}}));B.push(this._helper.createButton({id:this._getId("CancelInsertLinkButton"),text:"Cancel",press:function(){g.getAggregation("_customInsertLinkDialog").close();}}));return{contentWidth:'320px',title:l.EditorCommands["InsertLink"].title,buttons:B,content:[U,u,o,t,c,b,f]};};T.prototype._createInsertTableConfig=function(){var r=this._helper.createStepInput({value:2,min:0,width:"50%"}),R=this._helper.createLabel({text:"Number of Rows:",labelFor:r}),c=this._helper.createStepInput({value:2,min:0,width:"50%"}),o=this._helper.createLabel({text:"Number of Cols:",labelFor:c}),d=this._helper.createInput({width:'8rem',fieldWidth:"6rem",description:'px'}),t=this._helper.createText({textAlign:"Center",width:'2rem',text:'x'}),D=this._helper.createInput({fieldWidth:"6rem",width:'8rem',description:'px'}),b=this._helper.createHBox({wrap:"Wrap",alignItems:"Center",justifyContent:"SpaceBetween",items:[d,t,D]}),e=this._helper.createLabel({text:"Dimensions"}),f=this.getEditor(),g=this,B=[];B.push(this._helper.createButton({id:this._getId("InsertTableButton"),text:"Insert",press:function(){var h=f.getNativeApi().plugins.table.insertTable(r.getValue(),c.getValue()),i=f.getNativeApi().dom;i.setStyle(h,'width',D.getValue()+"px");i.setStyle(h,'height',d.getValue()+"px");g.getAggregation("_customInsertTableDialog").close();}}));B.push(this._helper.createButton({id:this._getId("CancelInsertTableButton"),text:"Cancel",press:function(){g.getAggregation("_customInsertTableDialog").close();}}));return{title:sap.ui.richtexteditor.EditorCommands["InsertTable"].title,buttons:B,content:this._helper.createVBox({direction:"Column",alignItems:"Start",items:[R,r,o,c,e,b]})};};T.prototype._createCustomToolbar=function(){var e=this._helper,c=[],b=l.ButtonGroups;Object.keys(b).forEach(function(g){c=c.concat(this.addButtonGroup(g));},this);return e.createOverflowToolbar(this._getId(),c);};T.prototype.setShowGroup=function(g,s){var o=this._findGroupedControls(g),t=this.getAggregation("_toolbar");o.forEach(function(O){O.setVisible(s);});t&&t.rerender();};T.prototype.addButtonGroup=function(g){var r=this.getEditor(),e=this._helper,c=[],b=l.ButtonGroups,o=l.EditorCommands,v,V,d,f,h,i,j,k;switch(g){case"font-style":f=r?r.getShowGroupFontStyle():false;b["font-style"].forEach(function(n){c.push(e.createToggleButton(this._createButtonConfig(n)).setVisible(f));},this);break;case"font":d=r?r.getShowGroupFont():false;c.push(e.createSelect({id:this._getId("FontFamily"),items:this._createFontStyleSelectItems(),change:function(E){var n;if(r){n=E.getSource().getSelectedItem();r.getNativeApi().execCommand('FontName',false,this._getFontStyleCommand(n.getText()));}else{q.sap.log.warning("Cannot execute native command: "+'FontName');}}.bind(this)}).setVisible(d));c.push(e.createSelect({id:this._getId("FontSize"),items:this._createFontSizeSelectItems(),change:function(E){var n;if(r){n=E.getSource().getSelectedItem();r.getNativeApi().execCommand('FontSize',false,n.getText());}else{q.sap.log.warning("Cannot execute native command: "+'FontSize');}}}).setVisible(d));c.push(e.createButton(this._createButtonForDialog("TextColor")).setVisible(d));c.push(e.createButton(this._createButtonForDialog("BackgroundColor")).setVisible(d));break;case"text-align":i=r?r.getShowGroupTextAlign():false;var m=this._createMenuButtonItems("TextAlign");c.push(e.createMenuButton(this._getId("TextAlign"),m,function(E){var s;if(r){s=E.getParameter("item");r.getNativeApi().execCommand('Justify'+s.getText());this.getParent().setIcon(s.getIcon());}else{q.sap.log.warning("Cannot execute native command: "+'Justify');}},m[0].getIcon(),this._oResourceBundle.getText(o["TextAlign"].bundleKey)).setVisible(i));break;case"structure":V=r?r.getShowGroupStructure():false;b["structure"].forEach(function(n){c.push(e.createButton(this._createButtonConfig(n)).setVisible(V));},this);break;case"clipboard":v=r?r.getShowGroupClipboard():false;b["clipboard"].forEach(function(n){c.push(e.createButton(this._createButtonConfig(n)).setVisible(v));},this);break;case"undo":h=r?r.getShowGroupUndo():false;b["undo"].forEach(function(n){c.push(e.createButton(this._createButtonConfig(n)).setVisible(h));},this);break;case"insert":k=r?r.getShowGroupInsert():false;c.push(e.createButton(this._createButtonForDialog("InsertImage")).setVisible(k));break;case"link":j=r?r.getShowGroupLink():false;c.push(e.createButton(this._createButtonForDialog("InsertLink")).setVisible(j));c.push(e.createButton(this._createButtonConfig("Unlink")).setVisible(j));break;case"table":c.push(e.createButton(this._createButtonForDialog("InsertTable")));break;}return c;};T.prototype.addButtonGroupToContent=function(g,f){var G;if(!f&&g.buttons[0]==="table"){G=g.buttons[0];sap.ui.richtexteditor.ButtonGroups.custom[g.name]={name:g.buttons[0],controls:["InsertTable"]};}if(f&&g.name==="table"){G=g.name;sap.ui.richtexteditor.ButtonGroups[g.name]=["InsertTable"];}if(!sap.ui.richtexteditor.ButtonGroups[g.name]&&!sap.ui.richtexteditor.ButtonGroups.custom[g.name]){return this;}var t=this.getAggregation("_toolbar"),c=this.addButtonGroup(G),b=c.length,i;for(i=0;i<b;i+=1){t.addContent(c[i]);}return this;};T.prototype.removeButtonGroup=function(g){var o=this._findGroupedControls(g);o.forEach(function(O){O.destroy();});};T.prototype._findGroupedControls=function(g){var b=l.ButtonGroups,t=this.getAggregation("_toolbar"),c;if(!t){return[];}c=b[g]?b[g]:b.custom[g].controls;var i=c.map(function(n){return this._getId(n);},this);return t.findAggregatedObjects(false,function(A){return i.indexOf(A.getId())>-1;})||[];};T.prototype.modifyToolbarContent=function(m){var r,b=Array.prototype.slice.call(arguments);b.shift();switch(m){case"add":r=this._proxyToolbarAdd.apply(this,b);break;case"destroy":r=this._proxyToolbarDestroy.apply(this,b);break;case"get":r=this._proxyToolbarGet.apply(this,b);break;case"indexOf":r=this._proxyToolbarIndexOf.apply(this,b);break;case"insert":r=this._proxyToolbarInsert.apply(this,b);break;case"removeAll":r=this._proxyToolbarRemoveAll.apply(this,b);break;case"remove":r=this._proxyToolbarRemove.apply(this,b);break;}return r;};T.prototype._updateCustomToolbarRefIds=function(i,b){var c,d;c=this._customButtons||[];d=c.indexOf(i);if(d>-1){c.splice(d,1);}if(b!==-1){b=b>=0&&b<=c.length?b:c.length;c.splice(b,0,i);}this._customButtons=c;};T.prototype._proxyToolbarAdd=function(i){var t=this.getAggregation("_toolbar"),r=t.addContent(i);t.rerender();if(r){this._updateCustomToolbarRefIds(i.getId());}return r;};T.prototype._proxyToolbarGet=function(){var t=this.getAggregation("_toolbar"),c=this._customButtons||[];return t.findAggregatedObjects(false,function(A){return c.indexOf(A.getId())>-1;})||[];};T.prototype._proxyToolbarDestroy=function(){var i=this._proxyToolbarGet();i.forEach(function(o){o.destroy();});this._customButtons=[];};T.prototype._proxyToolbarIndexOf=function(i){var c=this._customButtons||[],s=typeof i==="object"?i.getId():i;return c.indexOf(s);};T.prototype._proxyToolbarInsert=function(i,b){var r,t=this.getAggregation("_toolbar"),c=t.getContent()||[],d=this._customButtons||[],e=c.length-d.length;if(b<0){b=0;}else if(b>d.length){b=d.length;}else if(!b&&b!==0){b=d.length;}e+=b;r=t.insertContent(i,e);t.rerender();if(r){this._updateCustomToolbarRefIds(i.getId(),b);}return r;};T.prototype._proxyToolbarRemoveAll=function(){var i=this._proxyToolbarGet();i.forEach(this._proxyToolbarRemove,this);return i;};T.prototype._proxyToolbarRemove=function(i){var s,r,t=this.getAggregation("_toolbar");switch(typeof i){case"string":s=i;break;case"object":s=i.getId();break;case"number":s=this._customButtons[i];break;}r=t.removeContent(s);if(r&&s){this._updateCustomToolbarRefIds(s,-1);}return r;};return T;},true);
