jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");jQuery.sap.require("sap.apf.modeler.ui.utils.nullObjectChecker");jQuery.sap.require("sap.apf.modeler.ui.utils.optionsValueModelBuilder");jQuery.sap.require("sap.apf.modeler.ui.utils.viewValidator");jQuery.sap.require('sap.apf.modeler.ui.utils.sortDataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.stepPropertyMetadataHandler');(function(){"use strict";var p,t,c,C,T,g,s,v,S,o,I;var n=new sap.apf.modeler.ui.utils.NullObjectChecker();var a=new sap.apf.modeler.ui.utils.OptionsValueModelBuilder();var b=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_TITLE;var d=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_LONG_TITLE;function _(i){i.byId("idStepBasicData").setText(t("stepBasicData"));i.byId("idStepTitleLabel").setText(t("stepTitle"));i.byId("idStepTitle").setPlaceholder(t("newStep"));i.byId("idStepLongTitleLabel").setText(t("stepLongTitle"));i.byId("idStepLongTitle").setPlaceholder(t("stepLongTitle"));i.byId("idCategoryTitleLabel").setText(t("categoryAssignments"));i.byId("idGlobalLabel").setText(t("globalNavigationTarget"));i.byId("idStepSpecificLabel").setText(t("stepSpecificNavTargets"));i.byId("idDataRequest").setText(t("dataRequest"));i.byId("idFilterMapping").setText(t("filterMap"));i.byId("idFilterMapKeepSourceLabel").setText(t("filterMapKeepSource"));i.byId("idNavigationTarget").setText(t("navigationTargetAssignments"));i.byId("idDataReduction").setText(t("dataReduction"));i.byId("idDataReductionLabel").setText(t("dataReductionType"));i.byId("idNoDataReduction").setText(t("noDataReduction"));i.byId("idTopN").setText(t("topN"));i.byId("idNumberOfRecordsLabel").setText(t("recordNumber"));i.byId("idAriaPropertyForDataReduction").setText(t("dataReductionType"));}function e(i,j){var K=t(I?"hierarchicalStepTitle":"step")+": "+j;i.getView().getViewData().updateTitleAndBreadCrumb(K);f(i,j);}function f(i,j){var K=t(I?"hierarchicalStepTitle":"step")+": "+j;i.getView().getViewData().oTitleBreadCrumbController.byId("IdFormTitle").setText(K);}function h(i,j){var K={id:s.getId(),icon:s.getType()==="hierarchicalStep"?"sap-icon://drill-down":"sap-icon://step"};if(j){K.name=j;}i.getView().getViewData().updateSelectedNode(K);}function k(i){var j,K;if(p&&p.arguments&&p.arguments.stepId){s=C.getStep(p.arguments.stepId);I=(s&&s.getType()==="hierarchicalStep")?true:false;}if(!n.checkIsNotUndefined(s)){K=p.arguments.categoryId;I=p.bIsHierarchicalStep;if(I){j=C.createHierarchicalStep(K);}else{j=C.createStep(K);}s=C.getStep(j);h(i);}}function l(i){var j=this;var K=i.getParameter("bShowFilterMappingLayout");j.byId("idStepFilterMappingVBox").setVisible(K);j.byId("idFilterMapKeepSourceLabel").setVisible(K);j.byId("idFilterKeepSourceCheckBox").setVisible(K);if(!K){j.byId("idFilterMapping").setText("");j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS);}else{j.byId("idFilterMapping").setText(t("filterMap"));}}function m(i){i.byId("idDataReductionForm").setVisible(!I);}function q(i,j,V,K,U){sap.ui.view({viewName:K,type:sap.ui.core.mvc.ViewType.XML,id:i.createId(U),viewData:V,controller:j});}function r(i){var V,j,K,L,M,N,O;V={oTextReader:t,oConfigurationEditor:C,oTextPool:T,oParentObject:s};j=new sap.ui.controller("sap.apf.modeler.ui.controller.stepCornerTexts");q(i,j,V,"sap.apf.modeler.ui.view.cornerTexts","idStepCornerTextView");M=i.byId("idStepCornerTextView");i.byId("idStepCornerTextVBox").insertItem(M);V.oConfigurationHandler=c;V.getCalatogServiceUri=i.getView().getViewData().getCalatogServiceUri;if(I){K=new sap.ui.controller("sap.apf.modeler.ui.controller.hierarchicalStepRequest");}else{K=new sap.ui.controller("sap.apf.modeler.ui.controller.stepRequest");}q(i,K,V,"sap.apf.modeler.ui.view.requestOptions","idStepRequestView");N=i.byId("idStepRequestView");i.byId("idStepRequestVBox").insertItem(N);L=new sap.ui.controller("sap.apf.modeler.ui.controller.stepFilterMapping");q(i,L,V,"sap.apf.modeler.ui.view.requestOptions","idStepFilterMappingView");O=i.byId("idStepFilterMappingView");i.byId("idStepFilterMappingVBox").insertItem(O);N.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETDATAREDUCTIONSECTION,i.setDataReductionSection.bind(i));N.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,l.bind(i));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,l.bind(i));N.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.UPDATEFILTERMAPPINGFIELDS,O.getController().updateFilterMappingFields.bind(O.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS,O.getController().resetFilterMappingFields.bind(O.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,M.getController().updateSubViewInstancesOnReset.bind(M.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,N.getController().updateSubViewInstancesOnReset.bind(N.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,O.getController().updateSubViewInstancesOnReset.bind(O.getController()));N.addStyleClass("formTopPadding");N.addStyleClass("formBottomPadding");O.addStyleClass("formTopPadding");O.addStyleClass("formBottomPadding");}function u(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getStep(p.arguments.stepId))){return;}i.byId("idStepTitle").setValue(s.getId());if(n.checkIsNotNullOrUndefinedOrBlank(s.getTitleId())&&T.get(s.getTitleId())){i.byId("idStepTitle").setValue(T.get(s.getTitleId()).TextElementDescription);}}function w(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getStep(p.arguments.stepId))){return;}i.byId("idStepLongTitle").setValue("");if(n.checkIsNotNullOrUndefinedOrBlank(s.getLongTitleId())&&T.get(s.getLongTitleId())){i.byId("idStepLongTitle").setValue(T.get(s.getLongTitleId()).TextElementDescription);}}function x(i){var j=[];var K=C.getCategories();K.forEach(function(N){var O={};O.CategoryId=N.getId();O.CategoryTitle=T.get(N.labelKey)?T.get(N.labelKey).TextElementDescription:N.labelKey;j.push(O);});var M=a.prepareModel(j,j.length);i.byId("idCategorySelect").setModel(M);var L=C.getCategoriesForStep(s.getId());if(n.checkIsNotNullOrUndefinedOrBlank(L)){i.byId("idCategorySelect").setSelectedKeys(L);}}function y(i){i.byId("idNumberOfRecordsValue").setValue("");i.byId("idNumberOfRecordsValue").setValueState("None");if(s.getTopN()){i.byId("idNumberOfRecordsValue").setValue(s.getTopN().top);}A(i);}function z(i){i.byId("idDataReductionRadioGroup").setSelectedButton(i.byId("idNoDataReduction"));D(i);if(s.getTopN()){i.byId("idDataReductionRadioGroup").setSelectedButton(i.byId("idTopN"));}}function A(i){var j=i.byId("idDataReductionRadioGroup").getSelectedButton()===i.byId("idTopN")?true:false;i.byId("idNumberOfRecordsLabel").setVisible(j);i.byId("idNumberOfRecordsValue").setVisible(j);if(j){v.addField("idNumberOfRecordsValue");}else{v.removeField("idNumberOfRecordsValue");}}function B(i){if(s.getTopN()){S.instantiateStepSortData();if(s.getTopN().orderby.length===0){i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);var M=o.createMessageObject({code:"11523"});o.putMessage(M);}}else{S.destroySortData();}}function D(i){var j=(s.getSelectProperties().length!==0)?true:false;i.byId("idDataReductionRadioGroup").setEnabled(j);}function E(i){var j=(s.getFilterProperties().length!==0)?true:false;i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{"bShowFilterMappingLayout":j});}function F(i){if(n.checkIsNotNullOrUndefinedOrBlank(s.getFilterMappingKeepSource())){i.byId("idFilterKeepSourceCheckBox").setSelected(s.getFilterMappingKeepSource());}}function G(i,N,j,K){var M=[];if(N.length!==0){j.setBusy(true);}N.forEach(function(L){var O={};O.navTargetKey=L.getId();g(L.getId()).then(function(P){O.navTargetName=P;M.push(O);if(M.length===N.length){var Q=a.prepareModel(M,M.length);j.setModel(Q);j.setSelectedKeys(K);j.setBusy(false);}});});}function H(i){var j=C.getNavigationTargets();var K=s.getNavigationTargets();var N=j.filter(function(L){return L.isStepSpecific();});G(i,N,i.byId("idStepSpecificCombo"),K);}function J(i){var j=C.getNavigationTargets();var N=j.filter(function(L){return L.isGlobal();});var K=N.map(function(L){return L.getId();});G(i,N,i.byId("idGlobalCombo"),K);}sap.ui.controller("sap.apf.modeler.ui.controller.step",{onInit:function(){var i=this,j,K;var V=i.getView().getViewData();o=V.oCoreApi;t=o.getText;p=V.oParams;c=V.oConfigurationHandler;T=c.getTextPool();C=V.oConfigurationEditor;g=V.getNavigationTargetName;v=new sap.apf.modeler.ui.utils.ViewValidator(i.getView());_(i);k(i);j=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(o,s);S=new sap.apf.modeler.ui.utils.SortDataHandler(i.getView(),s,j,t);r(i);i.setDetailData();K=i.byId("idStepTitle").getValue().trim();if(K===""){K="< "+t("newStep")+" >";}f(i,K);v.addFields(["idStepTitle","idCategorySelect"]);},setDetailData:function(){var i=this;u(i);w(i);x(i);i.setDataReductionSection();m(i);E(i);F(i);H(i);J(i);},onAfterRendering:function(){var i=this;if(i.byId("idStepTitle").getValue().length===0){i.byId("idStepTitle").focus();}},updateSubViewInstancesOnReset:function(i){var j=this;C=i;s=C.getStep(s.getId());j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{"oConfigurationEditor":C,"oParentObject":s});},setDataReductionSection:function(){var i=this;z(i);y(i);B(i);},handleChangeForStepTitle:function(){var i=this;var j=C.getCategoriesForStep(s.getId());var K=i.byId("idStepTitle").getValue().trim();if(n.checkIsNotNullOrUndefinedOrBlank(K)){T.setTextAsPromise(K,b).done(function(L){s.setTitleId(L);if(j.length>1){i.getView().getViewData().updateTree();}else{h(i,K);}e(i,K);C.setIsUnsaved();});}else{C.setIsUnsaved();}},handleSuggestionsForStepTitle:function(i){var j=new sap.apf.modeler.ui.utils.SuggestionTextHandler(T);j.manageSuggestionTexts(i,b);},handleChangeForStepLongTitle:function(){var i=this;var j=i.byId("idStepLongTitle").getValue().trim();if(n.checkIsNotNullOrUndefined(j)){T.setTextAsPromise(j,d).done(function(K){s.setLongTitleId(K);C.setIsUnsaved();});}else{C.setIsUnsaved();}},handleSuggestionsForStepLongTitle:function(i){var j=new sap.apf.modeler.ui.utils.SuggestionTextHandler(T);j.manageSuggestionTexts(i,d);},handleChangeForCategory:function(){var K=this;var L=s.getId();var M=p.arguments.categoryId;var P=C.getCategoriesForStep(s.getId());var N=K.byId("idCategorySelect").getSelectedKeys();var O=N.indexOf(M);var Q=[];var R=[];var i,j;for(i=0;i<P.length;i++){var U=false;for(j=0;j<N.length;j++){if(P[i]===N[j]){U=true;break;}}if(!U){R.push(P[i]);}}if(N.length!==0){N.forEach(function(V){C.addCategoryStepAssignment(V,L);var W={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:M,stepId:L}},newContext:{arguments:{configId:p.arguments.configId,categoryId:V}}};if(V!==M){Q.push(W);}});P.forEach(function(V){if(N.indexOf(V)===-1){C.removeCategoryStepAssignment(V,s.getId());}});if(R.length!==0){R.forEach(function(V){var W={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:M,stepId:L}},newContext:{arguments:{configId:p.arguments.configId,categoryId:V}},removeStep:true};if(O===-1&&V===M){var X={arguments:{appId:p.arguments.appId,configId:p.arguments.configId,categoryId:N[0],stepId:L}};W.categoryChangeContext=X;W.changeCategory=true;}Q.push(W);});}}if(Q.length!==0){K.getView().getViewData().updateTree(Q);}C.setIsUnsaved();},handleChangeForDataReductionType:function(){var i=this;if(i.byId("idDataReductionRadioGroup").getSelectedButton()===i.byId("idNoDataReduction")){s.resetTopN();i.setDataReductionSection();}else{S.instantiateStepSortData();}A(i);C.setIsUnsaved();},handleValidationForNumberOfRecords:function(i){var j=i.getSource();var V=j.getValue().trim();var K=(V.indexOf("E")!==-1||V.indexOf("e")!==-1||V.indexOf(".")!==-1||V<=0||V>10000)?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.None;j.setValueState(K);C.setIsUnsaved();},handleChangeForNoOfRecords:function(i){var j=this;var V=i.getSource().getValue().trim();if(i.getSource().getValueState()===sap.ui.core.ValueState.Error){return;}if(n.checkIsNotNullOrUndefinedOrBlank(V)){if(s.getTopN()===undefined){j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);}s.setTopNValue(V);}C.setIsUnsaved();},handleFilterMapKeepSource:function(){var i=this;var j=i.byId("idFilterKeepSourceCheckBox").getSelected();s.setFilterMappingKeepSource(j);C.setIsUnsaved();},handleChangeForStepSpecificNavTargets:function(){var i=this;var j=i.byId("idStepSpecificCombo").getSelectedKeys();var K=s.getNavigationTargets();K.forEach(function(L){if(j.indexOf(L)===-1){s.removeNavigationTarget(L);}});j.forEach(function(L){if(K.indexOf(L)===-1){s.addNavigationTarget(L);}});C.setIsUnsaved();},getValidationState:function(){var i=this;return v.getValidationState()&&i.byId("idStepRequestView").getController().getValidationState()&&i.byId("idStepFilterMappingView").getController().getValidationState();},onExit:function(){var i=this;i.byId("idStepCornerTextView").destroy();i.byId("idStepRequestView").destroy();i.byId("idStepFilterMappingView").destroy();}});}());
