/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.require("sap.apf.ui.utils.constants");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require('sap.apf.modeler.ui.utils.representationTypesHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.stepPropertyMetadataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.representationHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.representationBasicDataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.sortDataHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.nullObjectChecker');jQuery.sap.require('sap.apf.modeler.ui.utils.optionsValueModelBuilder');(function(){'use strict';var p,c,C,r,P,R,s,o,a,S;var n=new sap.apf.modeler.ui.utils.NullObjectChecker();var b=new sap.apf.modeler.ui.utils.OptionsValueModelBuilder();var l=sap.apf.core.constants.representationMetadata.labelDisplayOptions;function _(E){E.byId("idVisualization").setText(c.getText("visualization"));E.byId("idChartTypeLabel").setText(c.getText("chartType"));E.byId("idChartTypeLabel").setTooltip(c.getText("chartType"));E.byId("idBasicData").setText(c.getText("basicData"));E.byId("idSorting").setText(c.getText("sorting"));}function d(E,F){var G;var I=R.getPictureOfRepresentationType(r.getRepresentationType());var H=C.getCategoriesForStep(P.getId());if(H.length===1){G={id:r.getId(),icon:I};if(F){G.name=F;}E.getView().getViewData().updateSelectedNode(G);}else{E.getView().getViewData().updateTree();}}function e(E,F){var T=c.getText("representation")+": "+F;E.getView().getViewData().updateTitleAndBreadCrumb(T);}function f(E){r.setRepresentationType(E);var F="TableRepresentation";if(E===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION||E===sap.apf.ui.utils.CONSTANTS.representationTypes.TREE_TABLE_REPRESENTATION){F=undefined;}r.setAlternateRepresentationType(F);}function g(E){var I;var F=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(G){var H=s.getDimensionsProperties(G);var J=R.getKindsForDimensionPropertyType(E);J.forEach(function(K,L){I=false;var M;var N;var O=H[L];if(r.getDimensions().length!==0){if(r.getDimensions()[L]){if(r.getDimensionKind(r.getDimensions()[L])){I=true;}}}if(!I&&O){M=s.hasTextPropertyOfDimension(G,O);N=M?l.KEY_AND_TEXT:l.KEY;r.addDimension(O);r.setLabelDisplayOption(O,N);r.setDimensionKind(O,J[0]);}});F.resolve();});return F.promise();}function h(E){var I;var F=s.oStep.getService();var G=s.oStep.getEntitySet();var H=s.oStep.getHierarchyProperty();C.getHierarchyNodeIdAsPromise(F,G,H).done(function(N){I=s.hasTextPropertyOfDimension(E,N);});return I;}function i(E){var I,F;var G=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(H){var J=s.getHierarchicalProperty();if(J&&(r.getHierarchyPropertyLabelDisplayOption()===undefined)){I=h(H);F=I?l.TEXT:l.KEY;r.setHierarchyPropertyLabelDisplayOption(F);}G.resolve();});return G.promise();}function j(E){var F=jQuery.Deferred(),G,I;var H;s.getEntityTypeMetadataAsPromise().done(function(J){H=R.getKindsForMeasurePropertyType(E);G=s.getMeasures(J);H.forEach(function(K,L){I=false;var M=G[L];if(r.getMeasures().length!==0){if(r.getMeasures()[L]){if(r.getMeasureKind(r.getMeasures()[L])){I=true;}}}if(!I&&M){r.addMeasure(M);r.setMeasureKind(M,K);}});F.resolve();});return F.promise();}function k(E){var F=jQuery.Deferred();var G,H;if(E==="TableRepresentation"){if(r.getProperties().length===0){H=R.getKindsForPropertyType(E);G=s.getProperties()[0];r.addProperty(G);r.setPropertyKind(G,H[0]);F.resolve();}else{F.resolve();}}else if(E==="TreeTableRepresentation"){i(E).done(function(){F.resolve();});}else{g(E).done(function(){j(E).done(function(){F.resolve();});});}return F.promise();}function m(E){var V=[],M;V=s.getRepresentationTypesArray();M=b.prepareModel(V);E.byId("idChartType").setModel(M);E.byId("idChartType").setSelectedKey(r.getRepresentationType());}function q(){if(p&&p.arguments&&p.arguments.stepId){P=C.getStep(p.arguments.stepId);}}function t(){var E=c.getRepresentationTypes()[0].id;if(P.getType()==="hierarchicalStep"){E="TreeTableRepresentation";}return E;}function u(E){var F;var G=jQuery.Deferred();if(p&&p.arguments&&p.arguments.representationId){r=P.getRepresentation(p.arguments.representationId);}if(!n.checkIsNotUndefined(r)){r=P.createRepresentation();F=t();f(F);d(E,c.getText(F));C.setIsUnsaved();k(F).done(function(){return G.resolve();});}else{F=r.getRepresentationType();B().done(function(){k(F).done(function(){return G.resolve();});});}return G.promise();}function v(E){var F=new sap.m.Button({id:E.createId("idPreviewButton"),text:c.getText("preview"),press:E.handlePreviewButtonPress.bind(E)});var G=E.getView().getViewData().oFooter;G.addContentRight(F);}function w(E){var T=E.getView().getViewData().oConfigurationHandler.getTextPool();var V={oTextReader:c.getText,oConfigurationEditor:C,oTextPool:T,oParentObject:r,oParentStep:P,oRepresentationTypeHandler:R};var F=new sap.ui.controller("sap.apf.modeler.ui.controller.representationCornerTexts");var G=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.cornerTexts",type:sap.ui.core.mvc.ViewType.XML,id:E.createId("representationCornerTexts"),viewData:V,controller:F});E.byId("idCornerTextsVBox").insertItem(G);E.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON,G.getController().setChartIcon.bind(G.getController()));}function x(){r.getDimensions().forEach(function(E){r.removeDimension(E);});r.getMeasures().forEach(function(M){r.removeMeasure(M);});}function y(){var E,M;if(r.getRepresentationType()==="TableRepresentation"){E=r.getDimensions();M=r.getMeasures();E.forEach(function(F){r.addProperty(F);r.setPropertyTextLabelKey(F,r.getDimensionTextLabelKey(F));r.setPropertyKind(F,sap.apf.core.constants.representationMetadata.kind.COLUMN);C.setIsUnsaved();});M.forEach(function(F){r.addProperty(F);r.setPropertyTextLabelKey(F,r.getMeasureTextLabelKey(F));r.setPropertyKind(F,sap.apf.core.constants.representationMetadata.kind.COLUMN);C.setIsUnsaved();});x();}}function z(E){var F;s.getEntityTypeMetadataAsPromise().done(function(G){F=s.hasTextPropertyOfDimension(G,E);if(F){r.setLabelDisplayOption(E,l.KEY_AND_TEXT);}else{r.setLabelDisplayOption(E,l.KEY);}C.setIsUnsaved();});}function A(){var E=jQuery.Deferred();s.getEntityTypeMetadataAsPromise().done(function(F){r.getDimensions().forEach(function(G){if(r.getLabelDisplayOption(G)===undefined){z(G);}});E.resolve();});return E.promise();}function B(){y();return A();}function D(E){a.instantiateBasicData();S.instantiateRepresentationSortData();w(E);}sap.ui.controller("sap.apf.modeler.ui.controller.representation",{onInit:function(){var E=this;var V=E.getView().getViewData();c=V.oCoreApi;p=V.oParams;C=V.oConfigurationEditor;R=new sap.apf.modeler.ui.utils.RepresentationTypesHandler(c.getRepresentationTypes());_(E);q();s=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(c,P);u(E).done(function(){o=new sap.apf.modeler.ui.utils.RepresentationHandler(r,R,c.getText);a=new sap.apf.modeler.ui.utils.RepresentationBasicDataHandler(E.getView(),s,o);S=new sap.apf.modeler.ui.utils.SortDataHandler(E.getView(),r,s,c.getText);D(E);E.setDetailData();if(P.getType()!=="hierarchicalStep"){v(E);}});},setDetailData:function(){var E=this;m(E);},handleChangeForChartType:function(E){var F=this;var N=E.getParameter("selectedItem").getKey();var G=c.getText(N);var O=r.getRepresentationType();f(N);d(F,G);e(F,G);if(!R.isChartTypeSimilar(O,N)){F.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.REMOVEALLPROPERTIESFROMPARENTOBJECT);x();k(N).done(function(){a.instantiateBasicData();F.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);C.setIsUnsaved();});}else{a.instantiateBasicData();F.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);C.setIsUnsaved();}},handlePreviewButtonPress:function(){var E=this;var F={oParentStep:P,oRepresentation:r,oConfigurationHandler:E.getView().getViewData().oConfigurationHandler,oCoreApi:c,oRepresentationHandler:o,oStepPropertyMetadataHandler:s,oRepresentationTypeHandler:R};sap.ui.view({id:E.createId("idPreviewContentView"),viewName:"sap.apf.modeler.ui.view.previewContent",type:sap.ui.core.mvc.ViewType.XML,viewData:F});},onExit:function(){var E=this;E.getView().getViewData().oFooter.removeContentRight(E.byId("idPreviewButton"));a.destroyBasicData();S.destroySortData();E.byId("idCornerTextsVBox").destroyItems();}});}());
