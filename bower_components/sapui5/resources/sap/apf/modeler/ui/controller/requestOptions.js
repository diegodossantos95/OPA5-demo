/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.apf.modeler.ui.utils.nullObjectChecker");jQuery.sap.require("sap.apf.modeler.ui.utils.optionsValueModelBuilder");jQuery.sap.require("sap.apf.modeler.ui.utils.viewValidator");jQuery.sap.require("sap.apf.modeler.ui.utils.textManipulator");jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");jQuery.sap.require("sap.apf.utils.utils");(function(){"use strict";var n=new sap.apf.modeler.ui.utils.NullObjectChecker();var o=new sap.apf.modeler.ui.utils.OptionsValueModelBuilder();var t=new sap.apf.modeler.ui.utils.TextManipulator();function _(c){c.byId("idSource").attachEvent("selectService",c.handleSelectionOfService.bind(c));}sap.ui.core.mvc.Controller.extend("sap.apf.modeler.ui.controller.requestOptions",{viewValidator:{},oConfigurationEditor:{},oParentObject:{},onInit:function(){var c=this;c.viewValidator=new sap.apf.modeler.ui.utils.ViewValidator(c.getView());c.oConfigurationEditor=c.getView().getViewData().oConfigurationEditor;c.oParentObject=c.getView().getViewData().oParentObject;c.setDetailData();c.setDisplayText();_(c);},setDetailData:function(){var c=this;c.setSource();c.setEntityAsPromise();c.setOptionalHierarchicalProperty();c.setSelectProperties();c.setOptionalRequestFieldProperty();},setSource:function(){var c=this;var s=c.getSource();c.byId("idSource").setValue("");c.setValidationStateForService();if(!n.checkIsNotNullOrUndefinedOrBlank(s)){c.addOrRemoveMandatoryFieldsAndRequiredFlag(false);return;}c.byId("idSource").setValue(s);c.addOrRemoveMandatoryFieldsAndRequiredFlag(true);},setEntityAsPromise:function(){var c=this;var d=jQuery.Deferred();var m,s,e,v;s=c.byId("idSource").getValue();c.byId("idEntity").setModel(null);c.byId("idEntity").clearSelection();if(!n.checkIsNotNullOrUndefinedOrBlank(s)){d.resolve();return d.promise();}c.getAllEntitiesAsPromise(s).done(function(a){e=c.getEntity();if(n.checkIsNotNullOrUndefinedOrBlank(e)){v=c.validateSelectedValues(c,[e],a);a=v.aValues;e=v.aSelectedValues[0];}m=o.convert(a);c.byId("idEntity").setModel(m);if(!n.checkIsNotNullOrUndefinedOrBlank(e)||a.indexOf(e)===-1){c.getAllEntitiesAsPromise(s).done(function(b){e=b[0];if(n.checkIsNotNullOrUndefinedOrBlank(e)){c.byId("idEntity").setSelectedKey(e);}d.resolve();});}else if(n.checkIsNotNullOrUndefinedOrBlank(e)){c.byId("idEntity").setSelectedKey(e);d.resolve();}});return d.promise();},setSelectProperties:function(){var c=this;var s,e,S,m,v=[];var T=c.getView().getViewData().oTextReader;s=c.byId("idSource").getValue();var i=c.getIdOfPropertiesControl();c.byId(i).setModel(null);c.byId(i).clearSelection();e=t.removePrefixText(c.byId("idEntity").getSelectedKey(),T(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));c.getAllEntitySetPropertiesAsPromise(s,e).done(function(p){S=c.getSelectProperties();if(n.checkIsNotNullOrUndefinedOrBlank(S)){v=c.validateSelectedValues(c,S,p);p=v.aValues;S=v.aSelectedValues;}m=o.convert(p);c.byId(i).setModel(m);c.setSelectedKeysForProperties(S);});},updateSubViewInstancesOnReset:function(e){var c=this;c.oConfigurationEditor=e.getParameter("oConfigurationEditor");c.oParentObject=e.getParameter("oParentObject");c.setDetailData();},setDisplayText:function(){},handleChangeForSourceAsPromise:function(e){var d=jQuery.Deferred();var c=this,E,s;var S=c.byId("idSource").getValue().trim();var T=c.getView().getViewData().oTextReader;c.setValidationStateForService();if(!n.checkIsNotNullOrUndefinedOrBlank(S)){c.clearSource();c.addOrRemoveMandatoryFieldsAndRequiredFlag(false);c.setEntityAsPromise(c).done(function(){E=t.removePrefixText(c.byId("idEntity").getSelectedKey(),T(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));c.updateEntity(E);c.setSelectProperties();s=c.getSelectedKeysForProperties();c.updateSelectProperties(s);c.setOptionalHierarchicalProperty().done(function(){var h=t.removePrefixText(c.byId("idOptionalProperty").getSelectedKey(),T(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));c.updateHierarchicalProperty(h);c.setOptionalRequestFieldProperty();c.oConfigurationEditor.setIsUnsaved();c.fireRelevantEvents(e);d.resolve();});});}else{c.oConfigurationEditor.registerServiceAsPromise(S).done(function(r){c.getAllEntitiesAsPromise(S).done(function(a){if(r){c.addOrRemoveMandatoryFieldsAndRequiredFlag(true);c.updateSource(S);if(!n.checkIsNotNullOrUndefinedOrBlank(a)){var v={sValueState:sap.ui.core.ValueState.Error,sValueStateText:T("hierarchicalServiceError")};c.setValidationStateForService(v);c.resetEntityAndProperties();return;}}else{c.clearSource();c.addOrRemoveMandatoryFieldsAndRequiredFlag(false);}c.setEntityAsPromise(c).done(function(){E=t.removePrefixText(c.byId("idEntity").getSelectedKey(),T(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));c.updateEntity(E);c.setSelectProperties();s=c.getSelectedKeysForProperties();c.updateSelectProperties(s);c.setOptionalHierarchicalProperty().done(function(){var h=t.removePrefixText(c.byId("idOptionalProperty").getSelectedKey(),T(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));c.updateHierarchicalProperty(h);c.setOptionalRequestFieldProperty();c.oConfigurationEditor.setIsUnsaved();c.fireRelevantEvents(e);d.resolve();});});});});}return d.promise();},handleChangeForEntity:function(e){var c=this,E,s;var T=c.getView().getViewData().oTextReader;E=t.removePrefixText(c.byId("idEntity").getSelectedKey(),T(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));c.updateEntity(E);c.setSelectProperties();s=c.getSelectedKeysForProperties();c.updateSelectProperties(s);c.setOptionalHierarchicalProperty();var h=t.removePrefixText(c.byId("idOptionalProperty").getSelectedKey(),T(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));c.updateHierarchicalProperty(h);c.setOptionalRequestFieldProperty();c.oConfigurationEditor.setIsUnsaved();c.fireRelevantEvents(e);},handleChangeForSelectProperty:function(e){var c=this;var s=c.getSelectedKeysForProperties();c.updateSelectProperties(s);c.setOptionalRequestFieldProperty();c.oConfigurationEditor.setIsUnsaved();c.fireRelevantEvents(e);},handleChangeForOptionalRequestField:function(e){var c=this;var T=c.getView().getViewData().oTextReader;var f=[t.removePrefixText(c.byId("idOptionalRequestField").getSelectedKey(),T(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE))];c.updateOptionalRequestFieldProperty(f);c.oConfigurationEditor.setIsUnsaved();c.fireRelevantEvents(e);},handleSuggestions:function(e){var c=this;var E=c.oConfigurationEditor.getAllServices();var T=c.getView().getViewData().oConfigurationHandler.getTextPool();var s=new sap.apf.modeler.ui.utils.SuggestionTextHandler(T);s.manageSuggestions(e,E);},fireRelevantEvents:function(){},addOrRemoveMandatoryFieldsAndRequiredFlag:function(r){var c=this;c.byId("idEntityLabel").setRequired(r);c.byId(c.getIdOfPropertyLabel()).setRequired(r);if(r){c.viewValidator.addFields(["idEntity",c.getIdOfPropertiesControl()]);}else{c.viewValidator.removeFields(["idEntity",c.getIdOfPropertiesControl()]);}},handleSelectionOfService:function(e){var s=e.getParameter("sSelectedService");e.getSource().setValue(s);e.getSource().fireEvent("change");},handleShowValueHelpRequest:function(e){var c=this;var v={oTextReader:c.getView().getViewData().oTextReader,parentControl:e.getSource(),getCalatogServiceUri:c.getView().getViewData().getCalatogServiceUri};sap.ui.view({id:c.createId("idCatalogServiceView"),viewName:"sap.apf.modeler.ui.view.catalogService",type:sap.ui.core.mvc.ViewType.XML,viewData:v});},getNonCommonValues:function(e,T){var N=[];if(!n.checkIsNotNullOrUndefined(e)){return N;}N=e.filter(function(p){return T.indexOf(p)===-1;});return N;},validateSelectedValues:function(c,s,a){var v={},i=[],V=[],I=[],b=[],d;var T=c.getView().getViewData().oTextReader;v=sap.apf.utils.validateSelectedValues(s,a);i=v.invalid;V=v.valid;I=t.addPrefixText(i,T);b=I.concat(a).length!==0?I.concat(a):a;d=I.concat(V).length!==0?I.concat(V):s;return{aValues:b,aSelectedValues:d};},resetEntityAndProperties:function(){},setOptionalRequestFieldProperty:function(){},setOptionalHierarchicalProperty:function(){return jQuery.Deferred().resolve();},getIdOfPropertiesControl:function(){return"idSelectProperties";},getIdOfPropertyLabel:function(){return"idSelectPropertiesLabel";},setSelectedKeysForProperties:function(p){var c=this;c.byId("idSelectProperties").setSelectedKeys(p);},getSelectedKeysForProperties:function(){var c=this,s=[],S=[];var T=c.getView().getViewData().oTextReader;s=c.byId("idSelectProperties").getSelectedKeys();s.forEach(function(k){S.push(t.removePrefixText(k,T(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE)));});return S;},setValidationStateForService:function(v){var c=this;var d={sValueState:sap.ui.core.ValueState.None,sValueStateText:""};var V=v?v:d;c.byId("idSource").setValueState(V.sValueState);c.byId("idSource").setValueStateText(V.sValueStateText);},getSource:function(){},updateSource:function(s){},clearSource:function(){},getAllEntitiesAsPromise:function(s){return sap.apf.utils.createPromise();},getEntity:function(){},updateEntity:function(e){},clearEntity:function(){},getAllEntitySetPropertiesAsPromise:function(s,e){return sap.apf.utils.createPromise();},getSelectProperties:function(){},updateSelectProperties:function(s){},clearSelectProperties:function(){},removeSelectProperties:function(p){},getOptionalRequestFieldProperty:function(){},updateOptionalRequestFieldProperty:function(f){},updateHierarchicalProperty:function(h){},clearOptionalRequestFieldProperty:function(){},removeOptionalRequestFieldProperty:function(p){}});}());
