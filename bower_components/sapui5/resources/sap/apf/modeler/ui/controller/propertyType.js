/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.apf.modeler.ui.utils.optionsValueModelBuilder");jQuery.sap.require("sap.apf.modeler.ui.utils.nullObjectChecker");jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");jQuery.sap.require('sap.apf.modeler.ui.utils.constants');jQuery.sap.require("sap.apf.modeler.ui.utils.textManipulator");jQuery.sap.require('sap.apf.utils.utils');(function(){"use strict";var t=new sap.apf.modeler.ui.utils.TextManipulator();var n=new sap.apf.modeler.ui.utils.NullObjectChecker();var o=new sap.apf.modeler.ui.utils.OptionsValueModelBuilder();var c=sap.apf.modeler.ui.utils.CONSTANTS.events;var T=sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_LABEL;function _(C){var r=C.oRepresentation.getRepresentationType();var k=C.getView().getViewData().oPropertyTypeData.sContext;var p=C.getView().getViewData().oRepresentationTypeHandler.getLabelsForChartType(C.oTextReader,r,k);C.byId("idPropertyTypeLabel").setText(p);C.byId("idPropertyTypeLabel").setTooltip(p);}function a(C){C.byId("idAriaPropertyForAdd").setText(C.oTextReader("ariaTextForAddIcon"));C.byId("idAriaPropertyForDelete").setText(C.oTextReader("ariaTextForDeleteIcon"));}function b(C){var m;var i=jQuery.Deferred();var j=C.byId("idPropertyType");C.getAllPropertiesAsPromise().done(function(r){m=o.convert(r.aAllProperties);j.setModel(m);j.setSelectedKey(r.sSelectedKey);i.resolve();});return i.promise();}function d(C){var p=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));var s=C.getPropertyTextLabelKey(p)?C.oTextReader("label"):C.oTextReader("label")+" ("+C.oTextReader("default")+")";C.byId("idPropertyLabel").setText(s);C.byId("idPropertyLabel").setTooltip(s);}function e(C){var p;var P=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));var s=C.getPropertyTextLabelKey(P);if(n.checkIsNotUndefined(s)){p=C.getView().getViewData().oConfigurationHandler.getTextPool().get(s).TextElementDescription;C.byId("idPropertyLabelText").setValue(p);}else{C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(i){var l=C.oStepPropertyMetadataHandler.getDefaultLabel(i,P);C.byId("idPropertyLabelText").setValue(l);});}}function f(C){C.byId("idAddPropertyIcon").setTooltip(C.oTextReader("addButton"));C.byId("idRemovePropertyIcon").setTooltip(C.oTextReader("deleteButton"));}function g(C){var p=C.getView().getViewData().sPropertyType;var k=C.getView().getViewData().oPropertyTypeData.sContext;var s=C.oRepresentationTypeHandler.isAdditionToBeEnabled(C.oRepresentation.getRepresentationType(),p,k);var S=s;var P=C.getView().getViewData().oPropertyTypeState;var i=P.indexOfPropertyTypeViewId(C.getView().getId());if(i===0){S=false;}else if(i>0){var j=P.getViewAt(i-1);var l=j.getViewData().oPropertyTypeData.sContext;if(k!==l){S=false;}}C.byId("idAddPropertyIcon").setVisible(s);C.byId("idRemovePropertyIcon").setVisible(S);}function h(C){C.byId("idAddPropertyIcon").attachEvent(c.SETFOCUSONADDICON,C.setFocusOnAddIcons.bind(C));}sap.ui.core.mvc.Controller.extend("sap.apf.modeler.ui.controller.propertyType",{oConfigurationEditor:{},oRepresentation:{},oStepPropertyMetadataHandler:{},oRepresentationTypeHandler:{},oTextReader:{},oTextPool:{},initPromise:null,onInit:function(){var C=this;C.initPromise=new jQuery.Deferred();C.oConfigurationEditor=C.getView().getViewData().oConfigurationEditor;C.oRepresentation=C.getView().getViewData().oParentObject;C.oStepPropertyMetadataHandler=C.getView().getViewData().oStepPropertyMetadataHandler;C.oRepresentationTypeHandler=C.getView().getViewData().oRepresentationTypeHandler;C.oTextReader=C.getView().getViewData().oCoreApi.getText;C.oTextPool=C.getView().getViewData().oTextPool;b(C).done(function(){C.setDetailData().done(function(){C.initPromise.resolve();});});},onAfterRendering:function(){var C=this;C.initPromise.then(function(){C.enableDisableLabelDisplayOptionTypeAsPromise().done(function(){C.byId("idAddPropertyIcon").fireEvent(c.SETFOCUSONADDICON);});});},setDetailData:function(){var i=jQuery.Deferred();var C=this;C.setLabelDisplayOptionTypeAsPromise(o).done(function(){if(!C.byId("idPropertyType")){i.resolve();return;}e(C);a(C);d(C);_(C);f(C);g(C);i.resolve();});return i.promise();},handleChangeForPropertyTypeAsPromise:function(){var C=this;var i=jQuery.Deferred();var j=C.getView().getViewData().oPropertyTypeState.indexOfPropertyTypeViewId(C.getView().getId());var O=C.getView().getViewData().oPropertyTypeState.getPropertyValueState()[j];var N=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));C.getView().fireEvent(c.UPDATEPROPERTYVALUESTATE,{"sProperty":N});C.updatePropertyTypeAsPromise(N).done(function(){C.setDetailData();C.enableDisableLabelDisplayOptionTypeAsPromise().done(function(){C.getView().fireEvent(c.UPDATEPROPERTY,{"sOldProperty":O});C.oConfigurationEditor.setIsUnsaved();i.resolve();});});return i.promise();},handleChangeForLabelDisplayOptionType:function(){var C=this;var l=C.byId("idLabelDisplayOptionType").getSelectedKey();C.changeDisplayOptionsLabel(l);C.oConfigurationEditor.setIsUnsaved();},handleChangeForLabelText:function(){var C=this,l;var L=C.byId("idPropertyLabelText").getValue();var p=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));if(L.trim().length===0){l=undefined;C.setPropertyTextLabelKey(p,l);d(C);e(C);C.oConfigurationEditor.setIsUnsaved();}else{C.getView().getViewData().oConfigurationHandler.getTextPool().setTextAsPromise(L,T).done(function(l){C.setPropertyTextLabelKey(p,l);d(C);e(C);C.oConfigurationEditor.setIsUnsaved();});}},setFocusOnAddIcons:function(){var C=this;C.byId("idAddPropertyIcon").focus();},setFocusOnRemoveIcons:function(){var C=this;C.byId("idPropertyType").focus();},handlePressOfAddPropertyIcon:function(){var C=this;h(C);C.addPropertyAsPromise();},handlePressOfRemovePropertyIcon:function(){var C=this;C.getView().fireEvent(c.FOCUSONREMOVE);C.getView().fireEvent(c.REMOVEPROPERTY);C.oConfigurationEditor.setIsUnsaved();C.getView().destroy();},updatePropertyTypeAsPromise:function(N){var C=this;var i=jQuery.Deferred();var p=[];var P=C.getView().getViewData().oPropertyTypeState;var j=P.getPropertyValueState();var k=P.indexOfPropertyTypeViewId(C.getView().getId());C.createNewPropertyInfoAsPromise(N).done(function(l){j.forEach(function(s,m){if(s!==C.oTextReader("none")){if(k===m){p.push(l);}else{p.push(C.createCurrentProperiesInfo(s));}}});C.updateProperties(p);i.resolve();});return i.promise();},handleSuggestions:function(E){var C=this;var s=new sap.apf.modeler.ui.utils.SuggestionTextHandler(C.oTextPool);s.manageSuggestionTexts(E,T);},getSelectedProperty:function(){var C=this;var p=C.getView().getViewData().oPropertyTypeState;var i=p.getPropertyValueState();var j=p.indexOfPropertyTypeViewId(C.getView().getId());return i[j];},addRemovedProperty:function(E){var C=this,p;p=E.getParameter("sProperty");C.oStepPropertyMetadataHandler.oStep.getConsumablePropertiesForRepresentation(C.oRepresentation.getId()).done(function(r){if(r.available.indexOf(p)===-1&&(p!==C.oTextReader("none"))){p=t.addPrefixText([p],C.oTextReader);}if(p!==C.oTextReader("none")){var i=new sap.ui.core.Item({key:p,text:p});C.byId("idPropertyType").addItem(i);}});},removeAddedProperty:function(E){var C=this;var p=E.getParameter("sProperty");var i=C.byId("idPropertyType").getItems();i.forEach(function(I){if((t.removePrefixText(I.getKey(),C.oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE))===p)&&p!==C.oTextReader("none")){C.byId("idPropertyType").removeItem(I);}});},updateProperties:function(p){},createNewPropertyInfoAsPromise:function(N){return sap.apf.utils.createPromise();},createCurrentProperiesInfo:function(p,N){},setPropertyInParentObject:function(){},setLabelDisplayOptionTypeAsPromise:function(o){return sap.apf.utils.createPromise();},getAllPropertiesAsPromise:function(){return sap.apf.utils.createPromise();},getPropertyTextLabelKey:function(p){},setPropertyTextLabelKey:function(p,l){},enableDisableLabelDisplayOptionTypeAsPromise:function(){return sap.apf.utils.createPromise();},removePropertyFromParentObject:function(){},addPropertyAsPromise:function(){return sap.apf.utils.createPromise();},changeDisplayOptionsLabel:function(l){}});}());
