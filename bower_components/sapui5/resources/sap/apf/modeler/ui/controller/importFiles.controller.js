/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.apf.modeler.ui.utils.nullObjectChecker");sap.ui.define(["sap/apf/modeler/ui/controller/overwriteExistingConfiguration"],function(B){"use strict";var c,p,a,o,b;var n=new sap.apf.modeler.ui.utils.NullObjectChecker();function _(C){var t=c.getText;C.byId("idImportFilesDialog").setTitle(t("importConfig"));C.byId("idJsonFileLabel").setText(t("jsonFile"));C.byId("idJsonFileUploader").setPlaceholder(t("jsonFileInputPlaceHolder"));C.byId("idTextFileLabel").setText(t("textFile"));C.byId("idTextFileUploader").setPlaceholder(t("textFileInputPlaceHolder"));C.byId("idUploadOfConfig").setText(t("upload"));C.byId("idCancelImportOfConfig").setText(t("cancel"));}function d(C,i,j,k){var l=new sap.ui.core.CustomData({value:{callbackOverwrite:i,callbackCreateNew:j}});o=sap.ui.xmlfragment("idOverwriteConfirmationFragment","sap.apf.modeler.ui.fragment.overwriteConfirmation",C);C.getView().addDependent(o);C.setOverwriteConfirmationDialogText(c.getText);o.removeAllCustomData();o.addCustomData(l);sap.ui.core.Fragment.byId("idOverwriteConfirmationFragment","idNewConfigTitleInput").setValue(k);o.open();}function e(C){var i=C.byId("idImportFilesDialog");if(o&&o.isOpen()){C.handleCancelOfOverwriteDialog();}if(i&&i.isOpen()){C.handleCancelOfImportFilesDialog();}}function f(m){var M=c.createMessageObject({code:m});c.putMessage(M);}function g(i,m,j){var C=this;var t=C.byId("idTextFileUploader");if(!n.checkIsNotUndefined(j)){p.fireEvent("updateAppListEvent");f("11515");if(t&&t.getValue()){t.upload();}}else{var M=c.createMessageObject({code:"11502"});M.setPrevious(j);c.putMessage(M);}if(t&&!t.getValue()){e(C);}}function h(C,P){c.importTexts(P,function(m){if(!n.checkIsNotUndefined(m)){f("11516");}else{var M=c.createMessageObject({code:"11503"});M.setPrevious(m);c.putMessage(M);}});e(C);}return B.extend("sap.apf.modeler.ui.controller.importFiles",{onInit:function(){var C=this;c=C.getView().getViewData().oCoreApi;p=C.getView().getViewData().oParentControl;c.getApplicationHandler(function(i,m){if(i&&!n.checkIsNotUndefined(m)){a=i;}else{var M=c.createMessageObject({code:"11508"});M.setPrevious(m);c.putMessage(M);}});_(C);C.byId("idImportFilesDialog").open();},addAcceptAttribute:function(){var C=this;var j=jQuery("#"+C.getView().getId()+"--idJsonFileUploader-fu");var i=jQuery("#"+C.getView().getId()+"--idTextFileUploader-fu");j.attr('accept','.json');i.attr('accept','.properties');},handleTypeMissmatchForJSONFile:function(){f("11517");},handleTypeMissmatchForPropertiesFile:function(){f("11518");},handleJSONFileUploadComplete:function(E){var C=this;var i=E.getSource().oFileUpload.files[0];if(i){var r=new FileReader();r.readAsText(i,"UTF-8");r.onload=function(j){b=JSON.parse(j.target.result).configHeader.Application;c.importConfiguration(JSON.stringify(JSON.parse(j.target.result)),function(k,l,m){d(C,k,l,m);},g.bind(C));};r.onerror=function(){f("11519");};}},handleTextFileUploadComplete:function(E){var C=this,j,J;j=E.getSource().oFileUpload.files[0];J=C.byId("idJsonFileUploader");if(j){var r=new FileReader();r.readAsText(j,"UTF-8");r.onload=function(k){var l=k.target.result.split(/\r?\n/);var m,i,q;for(i=0;i<l.length;i++){m=/^\#\s*ApfApplicationId=[0-9A-F]+\s*$/.exec(l[i]);if(n.checkIsNotNull(m)){q=l[i].split('=')[1];}}var s;if(a){for(i=0;i<a.getList().length;i++){if(q===a.getList()[i].Application){s=true;break;}else{s=false;}}}if(!s&&J&&!J.getValue()){f("11520");}else if(J&&J.getValue()){if(b&&q&&q!==b){f("11521");e(C);}else{h(C,k.target.result);}}else if(s&&J&&!J.getValue()){h(C,k.target.result);}};r.onerror=function(){f("11522");};}},handleUploadOfConfig:function(){var C=this;var j=n.checkIsNotNullOrUndefinedOrBlank(C.byId("idJsonFileUploader").getValue());var t=n.checkIsNotNullOrUndefinedOrBlank(C.byId("idTextFileUploader").getValue());if((j&&t)||j){C.byId("idJsonFileUploader").upload();}else{C.byId("idTextFileUploader").upload();}},handleCancelOfImportFilesDialog:function(){var C=this;C.getView().destroy();}});});
