/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.instance");(function(){'use strict';jQuery.sap.require("sap.ui.thirdparty.datajs");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require('sap.apf.core.constants');jQuery.sap.require('sap.apf.core.messageHandler');jQuery.sap.require('sap.apf.core.sessionHandler');jQuery.sap.require('sap.apf.core.representationTypes');jQuery.sap.require("sap.apf.core.entityTypeMetadata");jQuery.sap.require("sap.apf.core.configurationFactory");jQuery.sap.require("sap.apf.core.utils.uriGenerator");jQuery.sap.require("sap.apf.core.metadata");jQuery.sap.require("sap.apf.core.metadataFacade");jQuery.sap.require("sap.apf.core.metadataProperty");jQuery.sap.require('sap.apf.core.messageDefinition');jQuery.sap.require("sap.apf.core.metadataFactory");jQuery.sap.require('sap.apf.core.odataProxy');jQuery.sap.require('sap.apf.core.ajax');jQuery.sap.require('sap.apf.core.odataRequest');jQuery.sap.require('sap.apf.modeler.core.messageDefinition');jQuery.sap.require('sap.apf.modeler.core.textHandler');jQuery.sap.require('sap.apf.modeler.core.textPool');jQuery.sap.require('sap.apf.modeler.core.applicationHandler');jQuery.sap.require('sap.apf.modeler.core.configurationHandler');jQuery.sap.require('sap.apf.modeler.core.configurationEditor');jQuery.sap.require("sap.apf.modeler.core.step");jQuery.sap.require("sap.apf.modeler.core.hierarchicalStep");jQuery.sap.require("sap.apf.modeler.core.smartFilterBar");jQuery.sap.require("sap.apf.modeler.core.facetFilter");jQuery.sap.require("sap.apf.modeler.core.navigationTarget");jQuery.sap.require("sap.apf.modeler.core.elementContainer");jQuery.sap.require("sap.apf.modeler.core.representation");jQuery.sap.require("sap.apf.modeler.core.configurationObjects");jQuery.sap.require("sap.apf.modeler.core.elementContainer");jQuery.sap.require("sap.apf.utils.parseTextPropertyFile");jQuery.sap.require("sap.apf.modeler.core.lazyLoader");jQuery.sap.require("sap.apf.modeler.core.registryWrapper");jQuery.sap.require("sap.apf.utils.startParameter");jQuery.sap.require("sap.apf.core.utils.fileExists");jQuery.sap.require("sap.apf.core.utils.annotationHandler");sap.apf.modeler.core.Instance=function(p,a){var t=this;var A,C,b,c,d,S,H,e,F,N,R,E,f,g,h,M,j,k,l,m,L,n,o,q,r,s,u,v,w,x,y,z,O,B,D,G,I,J,K;var P=[];var Q;var T;A=(a&&a.constructors&&a.constructors.ApplicationHandler)||sap.apf.modeler.core.ApplicationHandler;C=(a&&a.constructors&&a.constructors.ConfigurationHandler)||sap.apf.modeler.core.ConfigurationHandler;b=(a&&a.constructors&&a.constructors.ConfigurationEditor)||sap.apf.modeler.core.ConfigurationEditor;c=(a&&a.constructors&&a.constructors.ConfigurationObjects)||sap.apf.modeler.core.ConfigurationObjects;d=(a&&a.constructors&&a.constructors.ConfigurationFactory)||sap.apf.core.ConfigurationFactory;E=(a&&a.constructors&&a.constructors.ElementContainer)||sap.apf.modeler.core.ElementContainer;S=(a&&a.constructors&&a.constructors.Step)||sap.apf.modeler.core.Step;H=(a&&a.constructors&&a.constructors.HierarchicalStep)||sap.apf.modeler.core.HierarchicalStep;e=(a&&a.constructors&&a.constructors.SmartFilterBar)||sap.apf.modeler.core.SmartFilterBar;F=(a&&a.constructors&&a.constructors.FacetFilter)||sap.apf.modeler.core.FacetFilter;N=(a&&a.constructors&&a.constructors.NavigationTarget)||sap.apf.modeler.core.NavigationTarget;R=(a&&a.constructors&&a.constructors.Representation)||sap.apf.modeler.core.Representation;g=(a&&a.constructors&&a.constructors.Hashtable)||sap.apf.utils.Hashtable;h=(a&&a.constructors&&a.constructors.RegistryProbe)||sap.apf.modeler.core.RegistryWrapper;L=(a&&a.constructors&&a.constructors.LazyLoader)||sap.apf.modeler.core.LazyLoader;M=(a&&a.constructors&&a.constructors.Metadata)||sap.apf.core.Metadata;j=(a&&a.constructors&&a.constructors.EntityTypeMetadata)||sap.apf.core.EntityTypeMetadata;k=(a&&a.constructors&&a.constructors.MetadataFacade)||sap.apf.core.MetadataFacade;l=(a&&a.constructors&&a.constructors.MetadataProperty)||sap.apf.core.MetadataProperty;m=(a&&a.constructors&&a.constructors.MetadataFactory)||sap.apf.core.MetadataFactory;n=(a&&a.constructors&&a.constructors.StartParameter)||sap.apf.utils.StartParameter;o=(a&&a.constructors&&a.constructors.AnnotationHandler)||sap.apf.core.utils.AnnotationHandler;f=(a&&a.constructors&&a.constructors.FileExists)||sap.apf.core.utils.FileExists;T=(a&&a.instances&&a.instances.datajs)||OData;if(a&&a.constructors&&a.constructors.TextHandler){q=new a.constructors.TextHandler();}else{q=new sap.apf.modeler.core.TextHandler();}if(a&&a.constructors&&a.constructors.MessageHandler){r=new a.constructors.MessageHandler(true);}else{r=new sap.apf.core.MessageHandler(true);}r.activateOnErrorHandling(true);r.loadConfig(sap.apf.core.messageDefinition);r.loadConfig(sap.apf.modeler.core.messageDefinition);r.setTextResourceHandler(q);if(a&&a.instances&&a.instances.component){K={};K.baseManifest=sap.apf.modeler.Component.prototype.getMetadata().getManifest();K.manifest=jQuery.extend({},true,a.instances.component.getMetadata().getManifest());}u=new n(a&&a.instances&&a.instances.component,K);this.getStartParameterFacade=function(){return u;};x={instances:{messageHandler:r,coreApi:this}};if(a&&a.constructors&&a.constructors.PersistenceProxy){v=new a.constructors.PersistenceProxy(p,x);}else{v=new sap.apf.core.OdataProxy(p,x);}if(a&&a.constructors&&a.constructors.SessionHandler){s=new a.constructors.SessionHandler(x);}else{s=new sap.apf.core.SessionHandler(x);}this.ajax=function(i){var Y=jQuery.extend(true,{},i);Y.functions=Y.functions||{};Y.functions.getSapSystem=u.getSapSystem;if(a&&a.functions&&a.functions.ajax){Y.functions.ajax=a.functions.ajax;}Y.instances={messageHandler:r};return sap.apf.core.ajax(Y);};var U={functions:{getSapSystem:u.getSapSystem,getComponentNameFromManifest:sap.apf.utils.getComponentNameFromManifest,getODataPath:sap.apf.core.utils.uriGenerator.getODataPath,getBaseURLOfComponent:sap.apf.core.utils.uriGenerator.getBaseURLOfComponent,addRelativeToAbsoluteURL:sap.apf.core.utils.uriGenerator.addRelativeToAbsoluteURL},instances:{fileExists:new f({functions:{ajax:this.ajax,getSapSystem:u.getSapSystem}})}};var V=new o(U);y={constructors:{EntityTypeMetadata:j,Hashtable:g,Metadata:M,MetadataFacade:k,MetadataProperty:l},functions:{getServiceDocuments:function(){return[p.serviceRoot];},getSapSystem:u.getSapSystem},instances:{messageHandler:r,coreApi:t,annotationHandler:V},deactivateFatalError:true};w=new m(y);z={constructors:{Hashtable:g},instances:{messageHandler:r}};this.getCatalogServiceUri=a&&a.functions&&a.functions.getCatalogServiceUri;O=(a&&a.functions&&a.functions.odataRequestWrapper)||sap.apf.core.odataRequestWrapper;this.odataRequest=function(i,Y,Z,$){var _={instances:{datajs:T},functions:{getSapSystem:u.getSapSystem}};O(_,i,Y,Z,$);};this.checkForTimeout=function(i){var Y=sap.apf.core.utils.checkForTimeout(i);if(Y){r.putMessage(Y);}return Y;};this.getEntityTypeMetadataAsPromise=function(i,Y){return w.getEntityTypeMetadata(i,Y);};this.getEntityTypeMetadata=this.getEntityTypeMetadataAsPromise;this.getXsrfToken=function(i){return s.getXsrfToken(i);};this.getUriGenerator=function(){return sap.apf.core.utils.uriGenerator;};this.getText=function(i,Y){return q.getText(i,Y);};this.putMessage=function(i){return r.putMessage(i);};this.check=function(i,Y,Z){return r.check(i,Y,Z);};this.createMessageObject=function(i){return r.createMessageObject(i);};this.setCallbackForMessageHandling=function(i){r.setMessageCallback(i);};this.importConfigurationFromLrep=function(Y,Z,$,_){var a1;v.readAllConfigurationsFromVendorLayer().then(function(h1){var i1=Y+'.'+Z;var i;for(i=0;i<h1.length;i++){if(h1[i].value===i1){a1=h1[i].applicationText;break;}}t.getApplicationHandler(b1);});function b1(i,h1){if(h1){_(undefined,undefined,h1);return;}var i1=false;var j1=i.getApplication(Y);if(!j1){i1=true;}var k1={ApplicationName:a1};i.setAndSave(k1,c1,Y,i1);}function c1(i,h1,i1){if(i1){_(Z,undefined,i1);return;}d1();}function d1(){var i=new sap.apf.core.utils.Filter(r,'Language','eq',sap.apf.core.constants.developmentLanguage);var h1=new sap.apf.core.utils.Filter(r,'Application','eq',Y);h1.addAnd(i);v.readCollection("texts",e1,undefined,undefined,h1,{layer:"VENDOR"});}function e1(i,h1,i1){if(i1){_(Z,undefined,i1);return;}W(i,Y,f1);}function f1(i){if(i){_(Z,undefined,i);return;}v.readEntity("configuration",g1,[{value:Z}],undefined,Y,{layer:"VENDOR"});}function g1(i,h1,i1){if(i1){_(undefined,h1,i1);return;}var j1=JSON.parse(i.SerializedAnalyticalConfiguration);X(j1,$,_);}};function W(i,Y,Z){t.getApplicationHandler(_);function $(a1,b1,c1){var d1;var e1;if(c1){Z(c1);}else{d1={instances:{messageHandler:r,persistenceProxy:v},constructors:{Hashtable:g}};e1=new sap.apf.modeler.core.TextPool(d1,Y,a1);e1.addTextsAndSave(i,Z,Y);}}function _(a1,b1){if(b1){Z(b1);return;}var c1;var d1=a1.getApplication(Y);if(!d1){c1=r.createMessageObject({code:11021});Z(c1);return;}if(G&&G.getId()===Y){G.getInstance().getTextPool().addTextsAndSave(i,Z,Y);}else{var e1=new sap.apf.core.utils.Filter(r,'Application','eq',Y);var f1=new sap.apf.core.utils.Filter(r,'Language','eq',sap.apf.core.constants.developmentLanguage);f1.addAnd(e1);v.readCollection("texts",$,undefined,undefined,f1);}}}this.importTexts=function(Y,Z){var $;var _;var i;var a1=sap.apf.utils.parseTextPropertyFile(Y,{instances:{messageHandler:r}});if(a1.Messages.length>0){$=r.createMessageObject({code:11020});_=a1.Messages.length;for(i=0;i<_-1;i++){a1.Messages[i+1].setPrevious(a1.Messages[i]);}$.setPrevious(a1.Messages[_-1]);Z($);}else{W(a1.TextElements,a1.Application,Z);}};function X(i,Y,Z){var $=i.configHeader;t.getApplicationHandler(_);function _(d1,e1){if(e1){Z(undefined,undefined,e1);return;}var f1=false;var g1=d1.getList();g1.forEach(function(i1){if(i1.Application===$.Application){f1=true;}});if(f1){t.getConfigurationHandler($.Application,b1);}else{var h1={ApplicationName:$.ApplicationName,SemanticObject:$.SemanticObject};d1.setAndSave(h1,a1,$.Application,true);}}function a1(d1,e1,f1){if(f1){Z(undefined,undefined,f1);return;}t.getConfigurationHandler($.Application,b1);}function b1(d1,e1){if(e1){Z(undefined,undefined,e1);return;}var f1=jQuery.extend({},i,true);delete f1.configHeader;var g1=false;var h1=d1.getList();h1.forEach(function(l1){if(l1.AnalyticalConfiguration===$.AnalyticalConfiguration){g1=true;}});if(g1){Y(j1,k1,$.AnalyticalConfigurationName);}else{d1.setConfiguration({AnalyticalConfigurationName:$.AnalyticalConfigurationName},$.AnalyticalConfiguration);var i1={id:$.AnalyticalConfiguration,creationDate:$.CreationUTCDateTime,lastChangeDate:$.LastChangeUTCDateTime,content:f1};d1.loadConfiguration(i1,c1);}function j1(){d1.setConfiguration({AnalyticalConfigurationName:$.AnalyticalConfigurationName},$.AnalyticalConfiguration);var i1={updateExisting:true,id:$.AnalyticalConfiguration,creationDate:$.CreationUTCDateTime,lastChangeDate:$.LastChangeUTCDateTime,content:f1};d1.loadConfiguration(i1,c1);}function k1(l1){if(l1&&l1!==""){$.AnalyticalConfigurationName=l1;}var m1=d1.setConfiguration({AnalyticalConfigurationName:$.AnalyticalConfigurationName});var n1={id:m1,content:f1};d1.loadConfiguration(n1,c1);}}function c1(d1,e1){if(e1){Z(undefined,undefined,e1);return;}d1.save(Z);}}this.importConfiguration=function(i,Y,Z){var $=JSON.parse(i);if(!_($,Z)){return;}X($,Y,Z);function _($,Z){var a1=[],b1=true,c1;if(!sap.apf.utils.isValidGuid($.configHeader.Application)){a1.push(r.createMessageObject({code:11037,aParameters:[$.configHeader.Application]}));b1=false;}if(!sap.apf.utils.isValidGuid($.configHeader.AnalyticalConfiguration)){a1.push(r.createMessageObject({code:11038,aParameters:[$.configHeader.AnalyticalConfiguration]}));b1=false;}c1=sap.apf.modeler.core.ConfigurationObjects.getTextKeysFromConfiguration($);c1.forEach(function(d1){var e1=new g(r);if(!e1.hasItem(d1)){e1.setItem(d1,d1);if(!sap.apf.utils.isValidGuid(d1)){a1.push(r.createMessageObject({code:11039,aParameters:[d1]}));b1=false;}}});if(b1){return b1;}a1.forEach(function(d1,e1,a1){if(e1){d1.setPrevious(a1[e1-1]);}});Z(i,undefined,a1[a1.length-1]);return b1;}};this.getApplicationHandler=function(i){if(!D){var Y=(a&&a.functions&&a.functions.loadApplicationHandler)||Z;D=new L(z,Y);}D.asyncGetInstance("ApplicationHandlerId",i);function Z($,_){new A({instances:{messageHandler:r,persistenceProxy:v},constructors:{Hashtable:g},functions:{resetConfigurationHandler:b1}},a1);function a1(c1,d1){_($,c1,d1);}function b1(c1){if(G&&G.getId()===c1){G.getInstance().removeAllConfigurations();G.reset();}}}};this.getConfigurationHandler=function(i,Y){if(!G){B=(a&&a.functions&&a.functions.loadConfigurationHandler)||Z;G=new L(z,B);}G.asyncGetInstance(i,Y);function Z(i,$,_){var a1=new sap.apf.core.utils.Filter(r,'Application','eq',i);var b1=new sap.apf.core.utils.Filter(r,'Language','eq',sap.apf.core.constants.developmentLanguage);b1.addAnd(a1);var c1=[];var d1=["AnalyticalConfiguration","AnalyticalConfigurationName","Application","CreatedByUser","CreationUTCDateTime","LastChangeUTCDateTime","LastChangedByUser"];c1.push({entitySetName:"configuration",filter:a1,selectList:d1});c1.push({entitySetName:'texts',filter:b1});v.readCollectionsInBatch(c1,e1);function e1(f1,g1){var h1,i1;var j1;var k1;var l1=_;if(g1){$(i,undefined,g1);}else{j1=f1[0];k1=f1[1];i1={instances:{messageHandler:r,persistenceProxy:v},constructors:{Hashtable:g}};h1=new sap.apf.modeler.core.TextPool(i1,i,k1);if(!l1){l1=new C({instances:{messageHandler:r,persistenceProxy:v,coreApi:t,metadataFactory:w},constructors:{ConfigurationEditor:b,ConfigurationFactory:d,ConfigurationObjects:c,ElementContainer:E,EntityTypeMetadata:j,SmartFilterBar:e,FacetFilter:F,NavigationTarget:N,Hashtable:g,Representation:R,RegistryProbe:h,Step:S,HierarchicalStep:H,LazyLoader:L},functions:{getApplication:D.getInstance().getApplication}});}l1.setApplicationIdAndContext(i,j1,h1);$(i,l1,g1);}}}};this.getUnusedTextKeys=function(i,Y){var Z={instances:{messageHandler:r,persistenceProxy:v},constructors:{Hashtable:g}};var $=new c(Z);var _=null,a1=null,b1=null;$.getTextKeysFromAllConfigurations(i,function(d1,e1){if(a1){return;}_=d1;a1=e1;if(e1||b1){c1();}});this.getConfigurationHandler(i,function(d1,e1){if(a1){return;}b1=d1;a1=e1;if(e1||_){c1();}});function c1(){var d1=[];if(a1){Y(undefined,a1);return;}b1.getTextPool().getTextKeys().forEach(function(e1){if(!_.hasItem(e1)){d1.push(e1);}});Y(d1,undefined);}};this.resetConfigurationHandler=function(){if(G){G.reset();}};this.getRepresentationTypes=function(){var i=sap.apf.core.representationTypes();var Y=[];jQuery.extend(true,Y,i);return Y;};this.getAllAvailableSemanticObjects=function(i){if(J){i(J,Q);return;}if(Q){i([],Q);return;}P.push(i);if(P.length===1){var Y={requestUri:"/sap/opu/odata/UI2/INTEROP/SemanticObjects?$format=json&$select=id,text",method:"GET",isSemanticObjectRequest:true};t.odataRequest(Y,Z,$);}function Z(_,a1){J=_.results;P.forEach(function(b1){b1(_.results,undefined);});}function $(_){var a1;if(_&&_.messageObject){a1=_.messageObject;}else{r.createMessageObject({code:"11041"});J=[];}Q=a1;P.forEach(function(b1){b1([],a1);});}};this.getSemanticActions=function(Y){var Z;var $=jQuery.Deferred();if(!I){I=new g(r);}Z=I.getItem(Y);if(Z){$.resolve(Z);return $.promise();}t.getAllAvailableSemanticObjects(_);return $.promise();function _(a1,b1){if(b1){$.reject(b1);return;}var c1=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var d1={id:Y,text:""};var i;for(i=0;i<a1.length;i++){if(a1[i].id===Y){d1=a1[i];break;}}if(!c1){r.createMessageObject({code:"5038"});var e1={semanticObject:d1,semanticActions:[]};I.setItem(Y,e1);$.resolve(e1);}else{c1.getLinks({semanticObject:d1.id,ignoreFormFactor:true,ui5Component:a.instances.component}).done(function(f1){var g1=[];f1.forEach(function(h1){var i1=h1.intent.split("-");var j1=i1[1].split("?");j1=j1[0].split("~");g1.push({id:j1[0],text:h1.text});});var e1={semanticObject:d1,semanticActions:g1};I.setItem(Y,e1);$.resolve(e1);}).fail(function(){$.reject(r.createMessageObject({code:"11042"}));});}}};this.navigateToGenericRuntime=function(i,Y,Z){var $;if(a&&a.exits&&a.exits.getRuntimeUrl&&jQuery.isFunction(a.exits.getRuntimeUrl)){$=a.exits.getRuntimeUrl(i,Y);}else{var _=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var a1={};if(t.getStartParameterFacade().isLrepActive()){a1['sap-apf-configuration-id']=i+'.'+Y;}else{a1['sap-apf-configuration-id']=Y;}var b1=_.hrefForExternal({target:a.functions.getNavigationTargetForGenericRuntime(),params:a1});var c1=jQuery(location).attr('href');var d1=c1.split('#')[0];$=d1+b1;}Z($);};this.readAllConfigurationsFromVendorLayer=function(){return v.readAllConfigurationsFromVendorLayer();};if(a&&a.probe&&typeof a.probe==='function'){a.probe({constructors:{ApplicationHandler:A,ConfigurationHandler:C,ConfigurationEditor:b,ConfigurationObjects:c,ConfigurationFactory:d,MetadataFactory:m,Metadata:M,EntityTypeMetadata:j,MetadataFacade:k,MetadataProperty:l,Step:S,HierarchicalStep:H,SmartFilterBar:e,FacetFilter:F,NavigationTarget:N,Representation:R,ElementContainer:E,Hashtable:g,LazyLoader:L,AnnotationHandler:o,RegistryProbe:h},textHandler:q,messageHandler:r,sessionHandler:s,persistenceProxy:v,metadataFactory:w,injectForFollowUp:x,injectMetadataFactory:y,fnOdataRequestWrapper:O,ajax:this.ajax,odataRequestWrapper:O,annotationHandler:V});}};}());
