/* SAP APF Analysis Path Framework
* 
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.declare("sap.apf.ui.representations.treeTable");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.ui.utils.formatter");jQuery.sap.require("sap.apf.modeler.ui.utils.constants");jQuery.sap.require("sap.apf.ui.representations.BaseUI5ChartRepresentation");jQuery.sap.require("sap.ui.table.TreeTable");(function(){'use strict';function g(r,m){if(r&&r.length>0){if(m.getPropertyMetadata(r[0])["filter-restriction"]==="single-value"){return sap.ui.table.SelectionMode.Single;}return sap.ui.table.SelectionMode.MultiToggle;}return sap.ui.table.SelectionMode.None;}function _(t,s,T){var o;var F=new sap.apf.ui.utils.formatter({getEventCallback:T.oApi.getEventCallback.bind(T.oApi),getTextNotHtmlEncoded:T.oApi.getTextNotHtmlEncoded,getExits:T.oApi.getExits()},T.metadata,T.aDataResponse);var m=function(q){return function(u){if(T.metadata!==undefined){var v;if(u){v=F.getFormattedValue(q,u);if(v!==undefined){return v;}}}return u;};};o=new sap.ui.table.TreeTable({showNoData:false,title:s,enableSelectAll:false});var r=T.oParameters.requiredFilters;o.setSelectionMode(g(r,T.metadata));var C=[],n,p;t.name.forEach(function(q,u){n=new sap.m.Text().bindText(t.value[u],m(t.value[u]),sap.ui.model.BindingMode.OneWay);p=new sap.ui.table.Column({label:new sap.m.Label({text:q}),template:n,tooltip:q});C.push(p);});C.forEach(function(q){o.addColumn(q);});T.oTreeTableModel.attachBatchRequestCompleted(function(){if(T.oApi.getUiApi().getLayoutView().getController()&&T.oApi.getUiApi().getLayoutView().getController().byId("stepContainer")){T.oApi.getUiApi().getLayoutView().getController().byId("stepContainer").getContent()[0].byId("idStepLayout").setBusy(false);}j(o);b(T,o,t);if(T.UI5ChartHelper.filterValues.length>0){a(T);}else{T.oTreeTable.clearSelection();}});T.oTreeTableModel.attachBatchRequestSent(function(E){T.oApi.getUiApi().getLayoutView().getController().byId("stepContainer").getContent()[0].byId("idStepLayout").setBusy(true);});o.setModel(T.oTreeTableModel);o.bindRows(T.oTreeTableControlObject);return o;}function a(t){var T=t.oTreeTable.getRows();t.oTreeTable.clearSelection();setTimeout(function(){T.forEach(function(r,m){var n=r.getBindingContext();if(n){var R=n.getProperty(t.oParameters.requiredFilters[0]);t.UI5ChartHelper.filterValues.forEach(function(o){if(R===o[0]){t.oTreeTable.addSelectionInterval(m,m);}});}});},1);}function b(t,T,m){if(t.metadata!==undefined){for(var n=0;n<m.name.length;n++){var M=t.metadata.getPropertyMetadata(m.value[n]);if(M["aggregation-role"]==="measure"){var o=T.getColumns()[n];o.setHAlign(sap.ui.core.HorizontalAlign.End);}}}}function c(E){var m=E.getParameter("userInteraction");var n=E.getParameter("rowIndex");if(!m||n===undefined||n===null){return;}var r=this.oParameters.requiredFilters&&(this.oParameters.requiredFilters.length>0)?this.oParameters.requiredFilters[0]:undefined;d(this,r,n);}function d(t,r,m){var C=t.oTreeTable.getContextByIndex(m).getProperty(r);var s=t.oTreeTable.getSelectionMode();var I=t.oTreeTable.isIndexSelected(m);var u=t.UI5ChartHelper.filterValues.map(function(n){return n[0];});if(I){u=f(t,s,C,u);}else{u=h(t,s,C,u);}i(t,u);t.oApi.selectionChanged();}function e(t){t.UI5ChartHelper.filterValues=[];}function f(t,s,C,u){if(s===sap.ui.table.SelectionMode.Single){u=[C];}else{u.push(C);}return jQuery.unique(u);}function h(t,s,C,u){if(s===sap.ui.table.SelectionMode.Single){u=[];}else{var m=u.indexOf(C);if(m!==-1){u.splice(m,1);}}return u;}function i(t,u){e(t);u.forEach(function(v){t.UI5ChartHelper.filterValues.push([v]);});}function j(t){var m;if(jQuery('.chartContainer').height()){m=jQuery('.chartContainer').height()-(jQuery(".chartContainer > div :first-child").height()+120);}var v=(m>0)?m/32:15;var n=Math.floor(v);t.setVisibleRowCount(n+1);}function k(C,t){var s;var m=jQuery('.treeTableRepresentation').offset().top;var S=t.oApi.getUiApi().getStepContainer();if(S&&S.getContent()[0]&&S.getContent()[0].getContent()[0].getFullScreen()){s=((window.innerHeight-(m+80)))+"px";}else{s=((window.innerHeight-m)-(jQuery(".applicationFooter").height()+jQuery(".subHeader").height()+80))+"px";}document.querySelector('.treeTableRepresentation').style.cssText+="height : "+s;}function l(t){var C={name:[],value:[]};var p=t.oParameters.hierarchicalProperty.concat(t.oParameters.properties);p.forEach(function(m,n){var o=m.fieldName;var q=t.metadata.getPropertyMetadata(o).label||t.metadata.getPropertyMetadata(o).name;if(m.kind===sap.apf.modeler.ui.utils.CONSTANTS.propertyTypes.HIERARCHIALCOLUMN){if(m.labelDisplayOption==="text"){o=t.metadata.getPropertyMetadata(t.oTreeTableControlObject.parameters.treeAnnotationProperties.hierarchyNodeFor).text;}else{o=t.oTreeTableControlObject.parameters.treeAnnotationProperties.hierarchyNodeExternalKeyFor;}}C.name[n]=m.fieldDesc===undefined||!t.oApi.getTextNotHtmlEncoded(m.fieldDesc).length?q:t.oApi.getTextNotHtmlEncoded(m.fieldDesc);C.value[n]=o;});return C;}sap.apf.ui.representations.treeTable=function(A,p){this.oParameters=p;this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TREE_TABLE_REPRESENTATION;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(this,[A,p]);};sap.apf.ui.representations.treeTable.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);sap.apf.ui.representations.treeTable.prototype.constructor=sap.apf.ui.representations.treeTable;sap.apf.ui.representations.treeTable.prototype.getMainContent=function(s,m){var t=this,n;if(!m){var T=l(this);if(!this.oTreeTable){this.oTreeTable=_(T,s,this);this.oTreeTable.addEventDelegate({onAfterRendering:function(){if(t.oParameters){k(n,t);j(t.oTreeTable);if(t.UI5ChartHelper.filterValues.length>0){a(t);}else{t.oTreeTable.clearSelection();}}}});this.oTreeTable.attachRowSelectionChange(c.bind(this));}}n=new sap.m.ScrollContainer({content:[t.oTreeTable],horizontal:false}).addStyleClass("treeTableRepresentation");n.addStyleClass("sapUiSizeCompact");return n;};sap.apf.ui.representations.treeTable.prototype.getSelections=function(){var s=[];this.UI5ChartHelper.filterValues.forEach(function(m){s.push({id:m[0],text:m[0]});});return s;};sap.apf.ui.representations.treeTable.prototype.removeAllSelection=function(){this.UI5ChartHelper.filterValues=[];this.oTreeTable.clearSelection();this.oApi.selectionChanged();};sap.apf.ui.representations.treeTable.prototype.getFilter=function(){var m=this.oApi.createFilter();var A=m.getTopAnd().addOr('exprssionOr');this.UI5ChartHelper.filterValues.forEach(function(n){var F={id:n,name:this.oParameters.requiredFilters[0],operator:"EQ",value:n[0]};A.addExpression(F);}.bind(this));return m;};sap.apf.ui.representations.treeTable.prototype.setFilterValues=function(v){var t=this;t.UI5ChartHelper.filterValues=[];v.forEach(function(m){t.UI5ChartHelper.filterValues.push([m]);});};sap.apf.ui.representations.treeTable.prototype.updateTreetable=function(m,M,o,F){this.oTreeTableModel=M;this.oTreeTableControlObject=m;this.metadata=o;if(this.oTreeTable&&F){this.oTreeTable.bindRows(this.oTreeTableControlObject);}};sap.apf.ui.representations.treeTable.prototype.getThumbnailContent=function(){var t;var T=new sap.ui.core.Icon({src:"sap-icon://tree",size:"70px"}).addStyleClass('thumbnailTableImage');t=T;return t;};sap.apf.ui.representations.treeTable.prototype.getPrintContent=function(s){var t=this.oTreeTable.clone();var p={oRepresentation:t};return p;};sap.apf.ui.representations.treeTable.prototype.destroy=function(){if(this.oParameters){this.oParameters=null;}if(this.oTreeTableModel){this.oTreeTableModel=null;}if(this.oTreeTableControlObject){this.oTreeTableControlObject=null;}if(this.metadata){this.metadata=null;}if(this.UI5ChartHelper){this.UI5ChartHelper.filterValues=[];this.UI5ChartHelper.destroy();this.UI5ChartHelper=null;}};}());
