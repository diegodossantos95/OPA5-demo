/* SAP APF Analysis Path Framework
* 
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.declare("sap.apf.ui.representations.table");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require('sap.apf.ui.utils.formatter');jQuery.sap.require("sap.apf.ui.representations.utils.paginationHandler");jQuery.sap.require("sap.apf.ui.representations.BaseUI5ChartRepresentation");jQuery.sap.require("sap.ui.model.Sorter");jQuery.sap.require("sap.ui.table.Table");jQuery.sap.require("sap.ui.table.Column");jQuery.sap.require("sap.ui.core.CustomData");jQuery.sap.require("sap.ui.model.json.JSONModel");jQuery.sap.require("sap.ui.core.Icon");jQuery.sap.require("sap.ui.layout.VerticalLayout");jQuery.sap.require("sap.m.Text");jQuery.sap.require("sap.m.Label");jQuery.sap.require("sap.m.ScrollContainer");(function(){'use strict';var t,n=0;function _(s){s.forEach(function(i){t.addSelectionInterval(i,i);});}function a(T){if(T.oApi.getActiveStep()!==undefined){T.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues.forEach(function(F){if(T.aFiltersInTable.indexOf(F[0])===-1){T.aFiltersInTable.push(F[0]);}});}var r=T.oParameter.requiredFilters?T.oParameter.requiredFilters[0]:undefined;if(r&&T.oParameter.top){T.aFiltersInTable=c(T,r);}}function b(T,r){var s=[];T.aDataResponse.forEach(function(i,q){var u=i[r];if(T.aFiltersInTable.indexOf(u)!==-1){s.push(q);}});return s;}function c(T,r){var F=[];T.aFiltersInTable.forEach(function(i){T.aDataResponse.forEach(function(q){var s=q[r];if(s==i&&F.indexOf(i)===-1){F.push(i);}});});return F;}function d(E){var r=this.oParameter.requiredFilters;var R=r&&(r.length>0)?r[0]:undefined;var i=E.getParameter("userInteraction");var C=E.getParameter("rowIndices");if(!i||C.length===0){return;}if(E.getSource().getFocusDomRef()&&E.getSource().getFocusDomRef().offsetTop!==0){n=this.oTableRepresentation.getFirstVisibleRow();}var q=e(this,R,C);var s=jQuery.unique(this.aFiltersInTable.concat(q));f(this,s);}function e(T,r,C){var i=[];var s=t.getContextByIndex(C[0]).getProperty(r);if((t.isIndexSelected(C[0]))&&(i.indexOf(s))===-1){i.push(s);}else{var q=T.aFiltersInTable.indexOf(s);if(q!==-1){T.aFiltersInTable.splice(q,1);T.UI5ChartHelper.filterValues.splice(q,1);}}return i;}function f(T,C){g(T);T.filter=T.UI5ChartHelper.getFilterFromSelection(C);C.forEach(function(v){T.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues.push([v]);});T.aFiltersInTable=C;T.oApi.selectionChanged();}function g(T){T.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues=[];T.UI5ChartHelper.filterValues=[];T.aValidatedFilter=[];T.aFiltersInTable=[];}function h(T,P){var r=T.oParameter.requiredFilters;var R=r&&(r.length>0)?r[0]:undefined;var F=j(T);var A=P.getModel().getData().tableData;var s=[],S=[];A.forEach(function(u,v){if(F.indexOf(u[R])!==-1){s.push(v);}});var i=T.oTableRepresentation.getBinding().aIndices;s.forEach(function(u){S.push(i.indexOf(u));});s=S;var q=(r&&(r.length>0))?"MultiToggle":"None";P.setSelectionMode(q);P.onAfterRendering=function(){s.forEach(function(u){P.getRows()[u].$().addClass("sapTableSelectionForPrint");});};}function j(T){var F=T.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues;var i=F.map(function(q){return q[0];});return i;}function k(i,s,T){var F=new sap.apf.ui.utils.formatter({getEventCallback:T.oApi.getEventCallback.bind(T.oApi),getTextNotHtmlEncoded:T.oApi.getTextNotHtmlEncoded,getExits:T.oApi.getExits()},T.metadata,T.aDataResponse);var q=function(G){return function(H){if(T.metadata!==undefined){var I;if(i.value[G]&&H){I=F.getFormattedValue(i.value[G],H);if(I!==undefined){return I;}}}return H;};};var t=new sap.ui.table.Table({showNoData:false,title:s,enableSelectAll:false,visibleRowCount:15});var r=T.oParameter.requiredFilters;var u=(r&&(r.length>0))?"MultiToggle":"None";t.setSelectionMode(u);var v=[],C,w,x;for(var y=0;y<i.name.length;y++){C=new sap.m.Text().bindText(i.value[y],q(y),sap.ui.model.BindingMode.OneWay);w=new sap.ui.table.Column({label:new sap.m.Label({text:i.name[y]}),template:C,tooltip:i.name[y]});x=new sap.ui.core.CustomData({value:{text:i.name[y],key:i.value[y]}});w.addCustomData(x);v.push(w);}var z;z=v;z.forEach(function(G){t.addColumn(G);});if(v.length>10){t.getColumns().forEach(function(w){w.setWidth("125px");});}var M=new sap.ui.model.json.JSONModel();M.setSizeLimit(10000);var A=T.getData();M.setData({tableData:A});t.setModel(M);t.bindRows("/tableData");l(t);if(T.metadata!==undefined){for(var B=0;B<i.name.length;B++){var D=T.metadata.getPropertyMetadata(i.value[B]);if(D["aggregation-role"]==="measure"){var E=t.getColumns()[B];E.setHAlign(sap.ui.core.HorizontalAlign.End);}}}return t;}function l(t){var i=t.getModel().getData().tableData.length;var q;if(jQuery('.chartContainer').height()){q=jQuery('.chartContainer').height()-(jQuery(".chartContainer > div :first-child").height()+120);}var r=(q>0)?q/32:15;var s=Math.floor(r);if(i<s){s=i;}t.setVisibleRowCount(s);}function m(C,T){var s;var i=jQuery('.tableRepresentation').offset().top;var S=T.oApi.getUiApi().getStepContainer();if(S&&S.getContent()[0]&&S.getContent()[0].getContent()[0].getFullScreen()){s=((window.innerHeight-i)+40)+"px";}else{s=((window.innerHeight-i)-(jQuery(".applicationFooter").height()+40))+"px";}document.querySelector('.tableRepresentation').style.cssText+="height : "+s;T.oTableRepresentation.setFirstVisibleRow(n);}function o(T){var q=T.getData();var P=[],r;var C={name:[],value:[]};P=T.oParameter.dimensions.concat(T.oParameter.measures).length?T.oParameter.dimensions.concat(T.oParameter.measures):T.parameter.properties;if(q.length!==0){for(var i=0;i<P.length;i++){C.value[i]=P[i].fieldName;var s=T.metadata.getPropertyMetadata(P[i].fieldName).label||T.metadata.getPropertyMetadata(P[i].fieldName).name;var u="";if(T.metadata!==undefined&&T.metadata.getPropertyMetadata(P[i].fieldName).unit!==undefined){var U=T.metadata.getPropertyMetadata(P[i].fieldName).unit;u=T.getData()[0][U];for(r=0;r<T.getData().length;r++){if(u!==T.getData()[r][U]){u=undefined;break;}}C.name[i]=P[i].fieldDesc===undefined||!T.oApi.getTextNotHtmlEncoded(P[i].fieldDesc).length?s:T.oApi.getTextNotHtmlEncoded(P[i].fieldDesc);if(u!==undefined&&u!==""){C.name[i]=T.oApi.getTextNotHtmlEncoded("displayUnit",[C.name[i],u]);}}else{C.name[i]=P[i].fieldDesc===undefined||!T.oApi.getTextNotHtmlEncoded(P[i].fieldDesc).length?s:T.oApi.getTextNotHtmlEncoded(P[i].fieldDesc);}}}return C;}function p(v){var s;var S=v.getSelectedSortItem();v.getSortItems().forEach(function(i){if(i.getId()===S){s=i.getKey();}});return s;}sap.apf.ui.representations.table=function(A,P){this.oViewSettingDialog=undefined;this.aDataResponse=[];this.aValidatedFilter=[];this.aFiltersInTable=[];this.oParameter=P;this.orderby=P.orderby;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(this,[A,P]);this.alternateRepresentation=P.alternateRepresentationType;this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;this.oPaginationHandler=new sap.apf.ui.representations.utils.PaginationHandler(this);};sap.apf.ui.representations.table.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);sap.apf.ui.representations.table.prototype.constructor=sap.apf.ui.representations.table;sap.apf.ui.representations.table.prototype.setData=function(D,i,q,v){var s=this;var r=this.oParameter.requiredFilters?this.oParameter.requiredFilters[0]:undefined;if(i){this.metadata=i;this.UI5ChartHelper.metadata=i;}else{var M=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(M);}if(!this.oParameter.isAlternateRepresentation){if(r){this.aValidatedFilter=[];if(v&&v.length>0){v.forEach(function(w){s.aValidatedFilter.push(w[r]);});s.aFiltersInTable=s.aValidatedFilter;}}var u=this.oPaginationHandler.getPagingOption().skip;this.nDataResponseCount=q;if(u===undefined||u===0){this.aDataResponse=D;n=0;}else{D.map(function(w){s.aDataResponse.push(w);});}}else{this.aDataResponse=D;}};sap.apf.ui.representations.table.prototype.getSelectionFromChart=function(){var s=t.getSelectedIndices();return s;};sap.apf.ui.representations.table.prototype.getFilter=function(){this.filter=this.UI5ChartHelper.getFilterFromSelection(this.aFiltersInTable);return this.filter;};sap.apf.ui.representations.table.prototype.getSelections=function(){var s=[];a(this);this.aFiltersInTable.forEach(function(i){s.push({id:i,text:i});});return s;};sap.apf.ui.representations.table.prototype.markSelectionInTable=function(i){var r=this.oParameter.requiredFilters?this.oParameter.requiredFilters[0]:undefined;if(r){var s=b(this,r);if(this.oParameter.isAlternateRepresentation){var S=[];var q=this.oTableRepresentation.getBinding().aIndices;s.forEach(function(u){S.push(q.indexOf(u));});s=S;}if(s.length>0){this.oTableRepresentation.clearSelection();_(s);}}};sap.apf.ui.representations.table.prototype.getRequestOptions=function(F,i){if(F){this.oPaginationHandler.resetPaginationOption();}var r={paging:{},orderby:[]};if(!i){r.paging=this.oPaginationHandler.getPagingOption(this.oParameter.top);}if(this.orderby&&this.orderby.length){var q=this.orderby.map(function(O){return{property:O.property,descending:!O.ascending};});r.orderby=q;}if(this.oViewSettingDialog){var s=p(this.oViewSettingDialog);if(s){var S={property:p(this.oViewSettingDialog),descending:this.oViewSettingDialog.getSortDescending()};this.orderby=[S];r.orderby=[S];}}return r;};sap.apf.ui.representations.table.prototype.resetPaginationForTable=function(){this.oPaginationHandler.resetPaginationOption();};sap.apf.ui.representations.table.prototype.getMainContent=function(s,i,w){var q=this;var T=this.getData();var r=this.oParameter.dimensions.concat(this.oParameter.measures).length?this.oParameter.dimensions.concat(this.oParameter.measures):this.oParameter.properties;var u=o(this);var M;if(!s){M=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(M);}if(r.length===0){M=this.oApi.createMessageObject({code:"6002",aParameters:["dimensions",s]});this.oApi.putMessage(M);}if(!T||T.length===0){M=this.oApi.createMessageObject({code:"6000",aParameters:[s]});this.oApi.putMessage(M);}var v=(w||1000)+"px";t=k(u,s,this);t.attachRowSelectionChange(d.bind(q));this.oTableRepresentation=t;var x=new sap.m.ScrollContainer({content:[t],width:v,horizontal:false}).addStyleClass("tableRepresentation");x.addStyleClass("sapUiSizeCompact");t.addEventDelegate({onAfterRendering:function(){if(q.oParameter){q.markSelectionInTable(true);l(t);m(x,q);if(!q.oParameter.top&&!q.oParameter.isAlternateRepresentation&&q.nDataResponseCount>100){q.oPaginationHandler.attachPaginationOnTable(q);}}}});return x;};sap.apf.ui.representations.table.prototype.getThumbnailContent=function(){var T;var i=this.getData();var I=this.oParameter.isAlternateRepresentation?"sap-icon://table-view":"sap-icon://table-chart";if(i!==undefined&&i.length!==0){var q=new sap.ui.core.Icon({src:I,size:"70px"}).addStyleClass('thumbnailTableImage');T=q;}else{var r=new sap.m.Text({text:this.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass('noDataText');T=new sap.ui.layout.VerticalLayout({content:r});}return T;};sap.apf.ui.representations.table.prototype.removeAllSelection=function(){g(this);t.clearSelection();this.oApi.selectionChanged();};sap.apf.ui.representations.table.prototype.getPrintContent=function(s){var i=o(this),P;var q=k(i,s,this);q.setTitle(s);q.getColumns().forEach(function(r){r.setWidth("auto");});q.setVisibleRowCount(q.getModel().getData().tableData.length);h(this,q);P={oRepresentation:q};return P;};sap.apf.ui.representations.table.prototype.getViewSettingDialog=function(){if(!this.oViewSettingDialog){var v={oTableInstance:this};var V=new sap.ui.view({type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.apf.ui.reuse.view.viewSetting",viewData:v});this.oViewSettingDialog=V.getContent()[0];this.oViewSettingDialog.addStyleClass("sapUiSizeCompact");}return this.oViewSettingDialog;};sap.apf.ui.representations.table.prototype.serialize=function(){return{oFilter:this.aFiltersInTable,bIsAlternateView:this.bIsAlternateView,orderby:this.orderby};};sap.apf.ui.representations.table.prototype.deserialize=function(s){this.aFiltersInTable=s.oFilter;this.bIsAlternateView=s.bIsAlternateView;this.orderby=s.orderby;};sap.apf.ui.representations.table.prototype.destroy=function(){if(this.UI5ChartHelper){this.UI5ChartHelper.filterValues=[];this.UI5ChartHelper.destroy();this.UI5ChartHelper=null;}if(this.orderby){this.orderby=null;}if(this.oParameter){this.oParameter=null;}if(this.oViewSettingDialog){this.oViewSettingDialog.destroy();}if(this.aDataResponse){this.aDataResponse=null;}if(this.aValidatedFilter){this.aValidatedFilter=[];}if(this.aFiltersInTable){this.aFiltersInTable=[];}};}());
