/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.metadata");jQuery.sap.require("sap.apf.utils.utils");jQuery.sap.require("sap.ui.model.odata.v2.ODataModel");jQuery.sap.require("sap.ui.model.odata.ODataUtils");(function(){'use strict';sap.apf.core.Metadata=function(I,a){this.type="metadata";var t=this;var b=jQuery.Deferred();var A=[];var H=(I&&I.constructors&&I.constructors.Hashtable)||sap.apf.utils.Hashtable;var h=new H(I.instances.messageHandler);var o=new H(I.instances.messageHandler);var c=new H(I.instances.messageHandler);var d=new H(I.instances.messageHandler);var e=new H(I.instances.messageHandler);var f=new H(I.instances.messageHandler);var g=new H(I.instances.messageHandler);var j=new H(I.instances.messageHandler);var k=new H(I.instances.messageHandler);var l=new H(I.instances.messageHandler);var m=new H(I.instances.messageHandler);var n=new H(I.instances.messageHandler);var O=I.constructors.ODataModel||sap.ui.model.odata.v2.ODataModel;var D=false;if(I.deactivateFatalError){D=true;}var M;var p;var E;var s;var q=r(a);function r(i){var Q=I.functions.getSapSystem();if(Q){return sap.ui.model.odata.ODataUtils.setOrigin(i,{force:true,alias:Q});}return i;}function u(i){var Q;function R(T){if(!Q.dataType){Q.dataType={};}Q.dataType[T]=Q[T];}function S(T,U){if(jQuery.isArray(Q[U])===true){(Q[U]).forEach(function(V){Q[V.name]=V.value;});}else if(U!=="dataType"&&typeof(Q[U])==="object"){if(Object.keys(Q[U]).length===0){Q[T]="true";}if(U!==T){jQuery.each(Q[U],function(V,W){Q[T]=W;});}}else{Q[T]=Q[U];}}if(i===null){return{};}Q=jQuery.extend(true,{},i);jQuery.each(Q,function(T){switch(T){case'type':R(T);break;case'maxLength':R(T);break;case'precision':R(T);break;default:var U=T.split(".").pop();if(U.search("ISO")===0){S(U,T);}else{S(U.replace(/^./,U[0].toLowerCase()),T);}break;}});return Q;}function v(i,Q){if(d.hasItem(i)!==true){var R;var S={};var T={allParameters:[],keyParameters:[]};if(C(i)){R=L(i);if(R.key&&R.key.propertyRef){R.key.propertyRef.forEach(function(U){S[U.name]=null;});}R.property.forEach(function(U){var V=u(U);V.isKey=S.hasOwnProperty(V.name);T.allParameters.push(V);if(V.isKey){T.keyParameters.push(V);}});}d.setItem(i,T);}if(!Q){return d.getItem(i).allParameters;}return d.getItem(i).keyParameters;}function w(i){var Q=[];var R;if(C(i)){i=K(i);}R=L(i);R.property.forEach(function(S){Q.push(S.name);});return Q;}function x(Q){var i;if(c.hasItem(Q)===true){return c.getItem(Q);}var R;var S=[];var T=[];var U=K(Q);if(U&&F(U)){var V=L(U);V.property.forEach(function(X){S.push(X.name);});}var W=v(Q,false);for(i=0;i<W.length;i++){T.push(W[i].name);}R=S.concat(T);c.setItem(Q,R);return R;}function y(i){return f.getItem(i);}function z(i){var Q=y(i);Q=Q||y(i+"Results");if(!Q&&L(i)){Q=i;}return Q;}function B(i){if(o.hasItem(i)===false){var R=[];var Q=L(i);Q.property.forEach(function(S){if(!(S["sap:filterable"]==="false"||S.filterable&&S.filterable==="true")){R.push(S.name);}});o.setItem(i,R);}return o.getItem(i);}function C(i){return G(i)==="parameters";}function F(i){return G(i)==="aggregate";}function G(i){if(!j.hasItem(i)){var Q=L(i);var R=Q&&Q["sap:semantics"]||"undefined";j.setItem(i,R);}return j.getItem(i);}function J(i,Q){if(h.hasItem(i+Q)===false){var R=C(i);var S=L(i);var T=M.getODataProperty(S,Q);if(!T&&R){var U=K(i);S=L(U);T=M.getODataProperty(S,Q);}h.setItem(i+Q,u(T));}return h.getItem(i+Q);}function K(i){var R=l.getItem(i);if(R){return y(R.toAggregateEntitySet);}return i;}function L(i){if(!i){return undefined;}if(!n.hasItem(i)){var Q=M.getODataEntityType(E+i);if(!Q){return Q;}n.setItem(i,Q);}return n.getItem(i);}function N(){var i;p=U();p.attachMetadataLoaded(function(){M=p.getMetaModel();M.loaded().then(function(){if(!p.getServiceMetadata()){i="5018";if(D){i="11013";}I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:i,aParameters:[a],oCallingObject:t}));b.reject();return;}Q();R();S(p);T();b.resolve(this);}.bind(this));}.bind(this));p.attachMetadataFailed(function(){i="5018";if(D){i="11013";}I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:i,aParameters:[a],oCallingObject:t}));b.reject();return;});function Q(){var V={};var W=M.getODataEntityContainer()&&M.getODataEntityContainer().entitySet;if(!W){I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:"5041",aParameters:[a],oCallingObject:t}));return;}W.forEach(function(W){var X=W.entityType.split(/[. ]+/).pop();f.setItem(W.name,X);g.setItem(X,W.name);if(!V.hasOwnProperty(X)){V[X]=true;A.push(X);}});}function R(){var V=M.getODataEntityContainer()&&M.getODataEntityContainer().entitySet;if(!V){return;}var W=V[0].entityType.split(".");W.pop();E=W.join(".")+".";}function S(V){var W=V&&V.getServiceAnnotations();if(W&&W.aliasDefinitions&&W.aliasDefinitions.Capabilities){s=W.aliasDefinitions.Capabilities+".";}}function T(){var V=M.getODataEntityContainer();if(!V||!V.associationSet){return;}V.associationSet.forEach(function(W){var X=W.end[0].entitySet,Y=W.end[1].entitySet,Z,$;if(C(y(X))){Z=X;}else if(F(y(X))){$=X;}if(C(y(Y))){Z=Y;}else if(F(y(Y))){$=Y;}if(!Z||!$){return;}var _;var a1=L(y(Z));var b1;a1.navigationProperty.forEach(function(d1){if(!b1&&d1.relationship===W.association){_=d1.name;b1=true;}});if(!_){return;}var c1={navigationProperty:_,fromParameterEntitySet:Z,toAggregateEntitySet:$,fromIsUnique:undefined,toIsUnique:undefined};if(k.hasItem(Z)){c1.fromIsUnique=false;k.getItem(Z).fromIsUnique=false;}else{c1.fromIsUnique=true;k.setItem(Z,c1);l.setItem(y(Z),c1);}if(m.hasItem($)){m.getItem($).toIsUnique=false;}else{c1.toIsUnique=true;m.setItem($,c1);}});}function U(){var V=I.instances.annotationHandler.getAnnotationsForService(a);var W={annotationURI:V,json:true};return new O(q,W);}}this.getEntityTypes=function(){return A;};this.getPropertyMetadata=function(i,Q){I.instances.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect EntityType name or type");I.instances.messageHandler.check(Q!==undefined&&typeof Q==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect sPropertyName name or type");var R=z(i);if(!R){return{};}return J(R,Q);};this.getUriComponents=function(i){if(!y(i)){if(y(i+"Results")){return{entitySet:i+"Results",navigationProperty:""};}return null;}var R;switch(G(y(i))){case"undefined":return{entitySet:i,navigationProperty:""};case"parameters":R=k.getItem(i);if(!R||R.fromIsUnique===false){return{entitySet:i,navigationProperty:undefined};}return{entitySet:i,navigationProperty:R.navigationProperty};case"aggregate":R=m.getItem(i);if(!R){return{entitySet:i,navigationProperty:""};}if(R.toIsUnique===false){return{entitySet:undefined,navigationProperty:undefined};}return{entitySet:R.fromParameterEntitySet,navigationProperty:R.navigationProperty};default:I.instances.messageHandler.check(false,"metadata : getUriComponents - not handled return value for sap semantics");}};this.getFilterableProperties=function(i){I.instances.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getFilterableProperties incorrect EntityType name or type");var Q=z(i);if(!Q){return[];}Q=K(Q);return B(Q);};this.getAllPropertiesOfEntitySet=function(i){I.instances.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getAllPropertiesOfEntitySet incorrect EntitySet name or type");var Q=z(i);if(!Q){return[];}return w(Q);};this.getAllProperties=function(){var i=[];var Q;this.getEntityTypes().forEach(function(R){Q=x(R);if(Q.length===0){Q=w(R);}i=i.concat(Q);});i=sap.apf.utils.eliminateDuplicatesInArray(I.instances.messageHandler,i);return i;};this.getFilterablePropertiesAndParameters=function(){var i=[];var Q;var R=this.getEntityTypes();R.forEach(function(S){var T=L(S);T.property.forEach(function(U){if(!(U["sap:filterable"]==="false")&&(U["sap:aggregation-role"]==="dimension")){i.push(U.name);}});Q=v(S,false);Q.forEach(function(U){i.push(U.name);});});return sap.apf.utils.eliminateDuplicatesInArray(I.instances.messageHandler,i);};this.getParameterEntitySetKeyPropertiesForService=function(){var i=[];this.getEntityTypes().forEach(function(Q){v(Q,true).forEach(function(R){i.push(R.name);});});i=sap.apf.utils.eliminateDuplicatesInArray(I.instances.messageHandler,i);return i;};this.getAllKeys=function(){var i=[];var Q=[];this.getEntityTypes().forEach(function(R){var S=L(R);Q=[];if(S.key&&S.key.propertyRef){S.key.propertyRef.forEach(function(T){Q.push(T.name);});}i=i.concat(Q);});i=sap.apf.utils.eliminateDuplicatesInArray(I.instances.messageHandler,i);return i;};this.getAttributes=function(i){var Q=false;var R={};this.getEntityTypes().forEach(function(S){if(!Q){R=J(S,i);if(R.name){Q=true;}}});return R;};this.getParameterEntitySetKeyProperties=function(i){I.instances.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getParameterEntitySetKeyProperties incorrect EntityType name or type");var Q=z(i);if(!Q){return[];}return v(Q,true);};this.getEntityTypeAnnotations=function(i){var Q=z(i);I.instances.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getEntityTypeAnnotations incorrect EntityType name or type");if(e.hasItem(Q)===true){return e.getItem(Q);}var R={};T(Q,R);var S=K(Q);if(S!==Q){T(S,R);}e.setItem(Q,R);return e.getItem(Q);function T(Q,U){var V;var W;var X;var Y=L(Q);for(V in Y){if(Y.hasOwnProperty(V)){if(V.indexOf(s)!==0){continue;}W=V.split(".").pop();W=W.replace(/^./,W[0].toLowerCase());for(X in Y[V]){if(Y[V].hasOwnProperty(X)){U[W]=Y[V][X];}}}}}};this.getEntitySets=function(){var i={};var Q=[];var R=M.getODataEntityContainer();if(!R){return[];}if(R.associationSet){R.associationSet.forEach(function(S){var T,U,V;T=z(S.end[0].entitySet);if(!C(T)){return;}V=S.end[1].entitySet;U=z(V);if(!C(U)){i[V]=true;}});}if(R.entitySet){R.entitySet.forEach(function(S){if(!i[S.name]){Q.push(S.name);}});}return Q;};this.getAllEntitySetsExceptParameterEntitySets=function(){var i=M.getODataEntityContainer();var Q=[];if(!i){return[];}if(i.entitySet){i.entitySet.forEach(function(R){var S=y(R.name);if(!C(S)){Q.push(R.name);}});}return Q;};this.getEntitySetByEntityType=function(i){return g.getItem(i);};this.getHierarchyAnnotationsForProperty=function(i,Q){var R={};var S=this.getAllPropertiesOfEntitySet(i);if(S.length===0){return I.instances.messageHandler.createMessageObject({code:5072,aParameters:[i,a]});}var T=y(i);var U=K(T);S.forEach(function(V){var W=J(U,V);if(W["hierarchy-node-for"]===Q){R.hierarchyNodeFor=V;}});if(!R.hierarchyNodeFor){return I.instances.messageHandler.createMessageObject({code:5073,aParameters:[i,a,Q]});}S.forEach(function(V){var W=J(U,V);if(W["hierarchy-level-for"]===R.hierarchyNodeFor){R.hierarchyLevelFor=V;}else if(W["hierarchy-parent-node-for"]===R.hierarchyNodeFor){R.hierarchyParentNodeFor=V;}else if(W["hierarchy-drill-state-for"]===R.hierarchyNodeFor){R.hierarchyDrillStateFor=V;}else if(W["hierarchy-node-external-key-for"]===R.hierarchyNodeFor){R.hierarchyNodeExternalKeyFor=V;}});return R;};this.getHierarchicalEntitySets=function(){var i=[];var Q=this.getEntitySets();Q.forEach(function(R){var S=P.call(this,R);if(S.entitySet){i.push(S.entitySet);}}.bind(this));return i;};this.getHierarchicalPropertiesOfEntitySet=function(i){return P.call(this,i).hierarchyProperties;};function P(i){var Q={};Q.hierarchyProperties=[];var R=y(i);if(!R){return Q;}var S=K(R);var T=this.getAllPropertiesOfEntitySet(i);T.forEach(function(U){var V=J(S,U);var W=false;var X=false;var Y=false;if(V["hierarchy-node-for"]!==undefined){var Z=V["hierarchy-node-for"];var $=U;T.forEach(function(U){var V=J(S,U);if(V["hierarchy-level-for"]===$){W=true;}else if(V["hierarchy-parent-node-for"]===$){X=true;}else if(V["hierarchy-drill-state-for"]===$){Y=true;}});if(W&&X&&Y){Q.entitySet=i;Q.hierarchyProperties.push(Z);}}});return Q;}this.getNonHierarchicalPropertiesOfEntitySet=function(i){var Q=[];var R=y(i);if(!R){return Q;}var S=K(R);var T=this.getAllPropertiesOfEntitySet(i);var U=P.call(this,i).hierarchyProperties;T.forEach(function(V){var W=J(S,V);if(W["hierarchy-node-for"]===undefined&&W["hierarchy-node-external-key-for"]===undefined&&W["hierarchy-parent-node-for"]===undefined&&W["hierarchy-level-for"]===undefined&&W["hierarchy-drill-state-for"]===undefined&&W["hierarchy-node-descendant-count-for"]===undefined&&U.indexOf(V)===-1){var X=W.name;Q.push(X);}});return Q;};this.getODataModel=function(){return p;};this.isInitialized=function(){return b.promise();};N.call(this);};}());
