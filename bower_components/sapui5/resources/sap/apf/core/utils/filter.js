/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.core.utils.filter');jQuery.sap.require('sap.apf.core.utils.filterTerm');jQuery.sap.require('sap.apf.core.constants');jQuery.sap.require('sap.ui.model.Filter');(function(){'use strict';var c="%20and%20";var a="%20or%20";sap.apf.core.utils.Filter=function(m,b,d,e,f){this.type="internalFilter";this.messageHandler=m;if(b&&(b instanceof sap.apf.core.utils.FilterTerm||b instanceof sap.apf.core.utils.Filter)){this.leftExpr=b;}else if(b!==undefined&&d!==undefined&&e!==undefined){this.leftExpr=new sap.apf.core.utils.FilterTerm(m,b,d,e,f);}else if(b!==undefined||d!==undefined||e!==undefined){m.check(false,"wrong arguments in construction of sap.apf.core.utils.Filter");}this.restExpr=[];};sap.apf.core.utils.Filter.prototype.getProperties=function(){var i;var p=[];var P=[];var b="";if(this.leftExpr===undefined){return p;}if(this.leftExpr instanceof sap.apf.core.utils.FilterTerm){b=this.leftExpr.getProperty();p.push(b);}else if(this.leftExpr instanceof sap.apf.core.utils.Filter){p=this.leftExpr.getProperties();}for(i=0;i<this.restExpr.length;i++){if(this.restExpr[i]instanceof sap.apf.core.utils.FilterTerm){p.push(this.restExpr[i].getProperty());}else{P=this.restExpr[i].getProperties();p=p.concat(P);}}return sap.apf.utils.eliminateDuplicatesInArray(this.messageHandler,p);};sap.apf.core.utils.Filter.prototype.copy=function(){var f;var i;if(this.leftExpr===undefined){return new sap.apf.core.utils.Filter(this.messageHandler);}f=new sap.apf.core.utils.Filter(this.messageHandler,this.leftExpr);if(this.levelOperator===undefined){return f;}for(i=0;i<this.restExpr.length;i++){if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND){f.addAnd(this.restExpr[i].copy());}else{f.addOr(this.restExpr[i].copy());}}return f;};sap.apf.core.utils.Filter.prototype.isEmpty=function(){if(this.leftExpr===undefined){return true;}if(this.leftExpr instanceof sap.apf.core.utils.FilterTerm){return false;}if(!this.leftExpr.isEmpty()){return false;}if(this.restExpr.length===0){return true;}var i;for(i=0;i<this.restExpr.length;++i){if(!this.restExpr[i].isEmpty()){return false;}}return true;};sap.apf.core.utils.Filter.prototype.isOr=function(){if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.OR){return true;}else if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND){return false;}if(this.leftExpr){if(this.leftExpr instanceof sap.apf.core.utils.Filter){return this.leftExpr.isOr();}}return false;};sap.apf.core.utils.Filter.prototype.isEqual=function(f){if(this===f){return true;}if(f===undefined){return false;}return this.getHash()===f.getHash();};sap.apf.core.utils.Filter.prototype.getHash=function(l){var n=l||1;var b=0;if(this.restExpr.length===0){b=n;}else{b=n+1;}if(this.leftExpr===undefined){return 0;}var h=this.leftExpr.getHash(b);var i;if(this.levelOperator===undefined){return h;}if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND){h=h+Math.pow(2,n);}else if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.OR){h=h+Math.pow(3,n);}for(i=0;i<this.restExpr.length;i++){h=h+this.restExpr[i].getHash(b);}return h;};sap.apf.core.utils.Filter.prototype.getFilterTermsForProperty=function(p){var t=[];var i;if(this.leftExpr===undefined){return t;}if(this.leftExpr instanceof sap.apf.core.utils.Filter){t=this.leftExpr.getFilterTermsForProperty(p);}else if(p===this.leftExpr.getProperty()){t.push(this.leftExpr);}for(i=0;i<this.restExpr.length;i++){if(this.restExpr[i]instanceof sap.apf.core.utils.FilterTerm){if(p===this.restExpr[i].getProperty()){t.push(this.restExpr[i]);}}else{t=t.concat(this.restExpr[i].getFilterTermsForProperty(p));}}return t;};sap.apf.core.utils.Filter.prototype.getFilterTerms=function(){var t=[];var i;if(this.leftExpr===undefined){return t;}if(this.leftExpr instanceof sap.apf.core.utils.Filter){t=this.leftExpr.getFilterTerms();}else{t.push(this.leftExpr);}for(i=0;i<this.restExpr.length;i++){if(this.restExpr[i]instanceof sap.apf.core.utils.FilterTerm){t.push(this.restExpr[i]);}else{t=t.concat(this.restExpr[i].getFilterTerms());}}return t;};sap.apf.core.utils.Filter.prototype.isConsistentWithFilter=function(p,v){var i;var b=false;if(this.leftExpr===undefined){return true;}if(this.levelOperator===undefined){return this.leftExpr.isConsistentWithFilter(p,v);}if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND){if(!this.leftExpr.isConsistentWithFilter(p,v)){return false;}for(i=0;i<this.restExpr.length;i++){if(!this.restExpr[i].isConsistentWithFilter(p,v)){return false;}}return true;}if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.OR){if(d(this.leftExpr,p)){b=true;if(this.leftExpr.isConsistentWithFilter(p,v)){return true;}}for(i=0;i<this.restExpr.length;i++){if(d(this.restExpr[i],p)){b=true;if(this.restExpr[i].isConsistentWithFilter(p,v)){return true;}}}return!b;}function d(f,p){if(f instanceof sap.apf.core.utils.FilterTerm){return f.getProperty()===p;}return f.getProperties().indexOf(p)>=0;}};sap.apf.core.utils.Filter.prototype.removeTermsByProperty=function(p){var f=this.internalRemoveTermsByProperty(p);if(f===undefined){return new sap.apf.core.utils.Filter(this.messageHandler);}return f;};sap.apf.core.utils.Filter.prototype.internalRemoveTermsByProperty=function(p){var i,r,R;if(this.leftExpr===undefined){return this.copy();}r=this.leftExpr.internalRemoveTermsByProperty(p);if(r instanceof sap.apf.core.utils.FilterTerm){r=new sap.apf.core.utils.Filter(this.messageHandler,r.getProperty(),r.getOp(),r.getValue(),r.getHighValue());}if(this.levelOperator===undefined){return r;}for(i=0;i<this.restExpr.length;i++){R=this.restExpr[i].internalRemoveTermsByProperty(p);if(r===undefined){if(R instanceof sap.apf.core.utils.FilterTerm){r=new sap.apf.core.utils.Filter(this.messageHandler,R);}else{r=R;}}else if(R!==undefined){if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND){r.addAnd(R);}else{r.addOr(R);}}}if(r){return new sap.apf.core.utils.Filter(this.messageHandler,r);}};sap.apf.core.utils.Filter.prototype.removeTerms=function(p,o,v){var i;if(this.leftExpr===undefined){return this.copy();}var f=this.leftExpr.removeTerms(p,o,v);var F;if(f instanceof sap.apf.core.utils.FilterTerm){f=new sap.apf.core.utils.Filter(this.messageHandler,f.getProperty(),f.getOp(),f.getValue(),f.getHighValue());}if(this.levelOperator===undefined){return f;}for(i=0;i<this.restExpr.length;i++){F=this.restExpr[i].removeTerms(p,o,v);if(f===undefined){if(F instanceof sap.apf.core.utils.FilterTerm){f=new sap.apf.core.utils.Filter(this.messageHandler,F);}else{f=F;}}else if(F!==undefined){if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND){f.addAnd(F);}else{f.addOr(F);}}}return f;};sap.apf.core.utils.Filter.prototype.addOr=function(b,d,e,f){var F;if(b instanceof sap.apf.core.utils.Filter||b instanceof sap.apf.core.utils.FilterTerm){F=b;}else if(b!==undefined&&d!==undefined&&e!==undefined){F=new sap.apf.core.utils.FilterTerm(this.messageHandler,b,d,e,f);}else{this.messageHandler.check(false,"sap.apf.core.utils.Filter.addOr: wrong arguments in construction of  Filter");}if(this.leftExpr===undefined){this.leftExpr=F;return this;}if(this.levelOperator===undefined){this.levelOperator=sap.apf.core.constants.BooleFilterOperators.OR;}this.restExpr.push(F);this.messageHandler.check(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.OR,"sap.apf.core.utils.Filter - addOr wrong operation");return this;};sap.apf.core.utils.Filter.prototype.addAnd=function(b,d,e,f){var F;if(b instanceof sap.apf.core.utils.Filter||b instanceof sap.apf.core.utils.FilterTerm){F=b;}else if(b!==undefined&&d!==undefined&&e!==undefined){F=new sap.apf.core.utils.FilterTerm(this.messageHandler,b,d,e,f);}else{this.messageHandler.check(false,"sap.apf.core.utils.Filter.addAnd: wrong arguments in construction of  Filter");}if(this.leftExpr===undefined){this.leftExpr=F;return this;}if(this.levelOperator===undefined){this.levelOperator=sap.apf.core.constants.BooleFilterOperators.AND;}this.messageHandler.check(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND,"sap.apf.core.utils.Filter - addAnd wrong operation");this.restExpr.push(F);return this;};sap.apf.core.utils.Filter.prototype.toUrlParam=function(b){var e="";if(this.leftExpr===undefined){return"";}e=this.leftExpr.toUrlParam(b);var i=0;var l=this.restExpr.length;var C="";if(l===0){return e;}if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND){C=c;}else{C=a;}var r="";for(i=0;i<l;i++){r=this.restExpr[i].toUrlParam(b);if(e===""){e=r;}else if(r!==""){e=e+C+r;}}if(e===""){return"";}return'('+e+')';};sap.apf.core.utils.Filter.prototype.mapToSapUI5FilterExpression=function(){var i,e,f=[];if(this.leftExpr===undefined){return new sap.ui.model.Filter({filters:[],and:undefined});}if(this.restExpr.length===0){return this.leftExpr.mapToSapUI5FilterExpression();}if(!(this.leftExpr.type==="internalFilter"&&this.leftExpr.isEmpty())){f.push(this.leftExpr.mapToSapUI5FilterExpression());}for(i=0;i<this.restExpr.length;i++){if(!(this.restExpr[i].type==="internalFilter"&&this.restExpr[i].isEmpty())){f.push(this.restExpr[i].mapToSapUI5FilterExpression());}}e={aFilters:f,bAnd:this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND};var r=new sap.ui.model.Filter({filters:e.aFilters,and:e.bAnd});r.bAnd=e.bAnd;return r;};sap.apf.core.utils.Filter.prototype.overwriteWith=function(f){var p=f.getProperties();var r;if(p.length!==0){r=this.removeTermsByProperty(p);if(r===undefined){return f.copy();}r.addAnd(f);return r;}return this.copy();};sap.apf.core.utils.Filter.prototype.restrictToProperties=function(p){var f=s(this.getProperties(),p);return this.copy().removeTermsByProperty(f)||new sap.apf.core.utils.Filter(this.messageHandler);function s(S,b){var i;var r=[];var h={};var l=S?S.length:0;var d=b?b.length:0;for(i=0;i<d;i++){h[b[i]]=undefined;}for(i=0;i<l;i++){if(!(S[i]in h)){r.push(S[i]);}}return r;}};sap.apf.core.utils.Filter.prototype.isFilterTerm=function(){if(this.restExpr.length>0){return false;}if(!this.leftExpr){return false;}if(this.leftExpr instanceof sap.apf.core.utils.FilterTerm){return true;}return this.leftExpr.isFilterTerm();};sap.apf.core.utils.Filter.prototype.traverse=function(v){if(!this.leftExpr){return v.processEmptyFilter();}if(this.leftExpr&&this.restExpr.length===0){if(this.leftExpr instanceof sap.apf.core.utils.FilterTerm){return v.processTerm(this.leftExpr);}return this.leftExpr.traverse(v);}if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND){return v.processAnd(this.leftExpr,this.restExpr,this);}if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.OR){return v.processOr(this.leftExpr,this.restExpr,this);}this.messageHandler.check(false,'undefined case in traverse()');return false;};sap.apf.core.utils.Filter.prototype.isDisjunctionOverEqualities=function(){var i=true;if(this.levelOperator===sap.apf.core.constants.BooleFilterOperators.AND){return false;}if(this.getProperties().length>1){return false;}if(this.leftExpr instanceof sap.apf.core.utils.Filter){if(this.leftExpr.getFilterTerms().length>1&&!this.leftExpr.isOr()){return false;}}this.getFilterTerms().forEach(function(f){if(f.getOp()!==sap.apf.core.constants.FilterOperators.EQ){i=false;}});this.restExpr.forEach(function(r){if(r instanceof sap.apf.core.utils.Filter){if(r.getFilterTerms().length>1){i=false;}}});return i;};sap.apf.core.utils.Filter.prototype.mapToSelectOptions=function(g){var d=jQuery.Deferred();var p;var t=this;g(b);function b(e){p=e;var v=new V();v.process(t);d.resolve(v.getSelectionVariant());}function V(){var s={};s.SelectOptions=[];s.Parameters=[];function e(i){var j;s.SelectOptions.forEach(function(k){if(k.PropertyName===i){j=k;}});if(!j){j={PropertyName:i,Ranges:[]};s.SelectOptions.push(j);}return j.Ranges;}function f(i){var o,v;var r=e(i.getProperty());if(i.getHighValue()!==undefined&&i.getHighValue()!==null){r.push({Sign:'I',Option:i.getOp(),Low:i.getValue(),High:i.getHighValue()});}else{o=i.getOp();v=i.getValue();if(o==='StartsWith'){o='CP';v=v+'*';}else if(o==='EndsWith'){o='CP';v='*'+v;}else if(o==='Contains'){o='CP';v='*'+v+'*';}r.push({Sign:'I',Option:o,Low:v});}}function h(i){s.Parameters.push({PropertyName:i.getProperty(),PropertyValue:i.getValue()});}this.getSelectionVariant=function(){if(s.SelectOptions.length>0||s.Parameters.length>0){return s;}return{};};this.processEmptyFilter=function(){return;};this.processTerm=function(i){if(jQuery.inArray(i.getProperty(),p)===-1){f(i);}else{h(i);}};this.processAnd=function(i,F){this.process(i);F.forEach(function(j){this.process(j);}.bind(this));};this.processOr=function(i,F){this.process(i);F.forEach(function(j){this.process(j);}.bind(this));};this.process=function(i){i.traverse(this);};}return d.promise();};sap.apf.core.utils.Filter.createFromArray=function(m,p,d,I){var l=p.length;var i;var n;var j;var f;var F;var o;m.check(p instanceof Array&&p.length>0,"sap.apf.core.utils.Filter.createFromArray incorrect argument aProperties");m.check(d instanceof Array,"sap.apf.core.utils.Filter.createFromArray incorrect argument aData");if(I.length>0){for(i=0;i<I.length;++i){F=undefined;n=I[i];if(!d[n]){continue;}for(j=0;j<l;j++){o=new sap.apf.core.utils.Filter(m,p[j],sap.apf.core.constants.FilterOperators.EQ,d[n][p[j]]);if(F===undefined){F=new sap.apf.core.utils.Filter(m,o);}else{F.addAnd(o);}}if(f===undefined){f=new sap.apf.core.utils.Filter(m,F);}else{f.addOr(F);}}return f;}return new sap.apf.core.utils.Filter(m);};sap.apf.core.utils.Filter.createEmptyFilter=function(m,p){m.check(jQuery.isArray(p)&&p.length>0,"sap.apf.core.utils.Filter.createEmptyFilter - array with property names expected");return new sap.apf.core.utils.Filter(m,p[0],sap.apf.core.constants.FilterOperators.EQ,'').addAnd(p[0],sap.apf.core.constants.FilterOperators.NE,'');};sap.apf.core.utils.Filter.transformUI5FilterToInternal=function(m,u){return t(u,u.bAnd);function t(u,A){var r=new sap.apf.core.utils.Filter(m);var s;if(u.aFilters){u.aFilters.forEach(function(f){if(f.aFilters){s=t(f,f.bAnd);if(A){r.addAnd(s);}else{r.addOr(s);}}else if(f.sPath){if(A){r.addAnd(f.sPath,f.sOperator,f.oValue1,f.oValue2);}else{r.addOr(f.sPath,f.sOperator,f.oValue1,f.oValue2);}}});}else{r=new sap.apf.core.utils.Filter(m,u.sPath,u.sOperator,u.oValue1,u.oValue2);}return r;}};}());
