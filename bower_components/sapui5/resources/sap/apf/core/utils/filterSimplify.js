/*
 * Copyright(c) 2015 SAP SE
 */
jQuery.sap.declare('sap.apf.core.utils.filterSimplify');jQuery.sap.require('sap.apf.core.utils.filter');jQuery.sap.require('sap.apf.core.utils.filterTerm');jQuery.sap.require('sap.apf.core.constants');jQuery.sap.require('sap.apf.core.messageHandler');(function(){'use strict';sap.apf.core.utils.CollectPropertiesAndValuesVisitor=function(){var t=this;var p=[];var v=[];var a=true;var b=true;var n=0;var c=0;var d=0;var e=0;function f(g){var i,l=p.length;for(i=0;i<l;i++){if(p[i]===g){return;}}p.push(g);}this.getProperties=function(){return p.slice(0);};this.getValues=function(){return v.slice(0);};this.isWellFormed=function(){return a&&b&&p.length<=1;};this.isEmptyFilter=function(){return n===0&&c===0&&d>0&&e===0;};this.processEmptyFilter=function(){d++;};this.processAnd=function(g,F){n++;b=false;this.process(g);this.processAndArray(F);};this.processAndArray=function(F){F.forEach(function(g){t.process(g);});};this.processOr=function(g,F){c++;this.process(g);this.processOrArray(F);};this.processOrArray=function(F){F.forEach(function(g){t.process(g);});};this.processTerm=function(g){e++;var h=g.getProperty();f(h);switch(g.getOp()){case sap.apf.core.constants.FilterOperators.EQ:v.push(g.getValue());return;default:a=false;return;}};this.process=function(g){if(g instanceof sap.apf.core.utils.FilterTerm){this.processTerm(g);}else{g.traverse(this);}};};sap.apf.core.utils.CollectChildrenOfAndNodeVisitor=function(){this.processEmptyFilter=function(){return null;};this.processTerm=function(t){return[t];};this.processAnd=function(f,F){var r=[];r.push(f);F.forEach(function(a){r.push(a);});return r;};this.processOr=function(){return null;};this.process=function(f){if(f instanceof sap.apf.core.utils.FilterTerm){this.processTerm(f);}else{return f.traverse(this);}};};sap.apf.core.utils.FilterReduction=function(){var t=this;var a=false;this.transformFilter=function(f){var T=[];var p;var c;if(f){f.forEach(function(b){if(b instanceof sap.apf.core.utils.FilterTerm){T.push({property:b.getProperty(),values:[b.getValue()]});}else if(b instanceof sap.apf.core.utils.Filter){p=b.getProperties();c=new sap.apf.core.utils.CollectPropertiesAndValuesVisitor();c.process(b);T.push({property:p[0],values:c.getValues()});}});}return T;};this.intersection=function(b,c){var r={};var l=b.values;var d=c.values;var e=[];var f={};var i,g=l.length;var j,h=d.length;for(i=0;i<g;i++){f[l[i]]=l[i];}for(j=0;j<h;j++){if(f[d[j]]!==undefined&&e.indexOf(d[j])<0){e.push(d[j]);}}r.property=b.property;r.values=e;return r;};function F(m){this.reducers=[];this.disjunctions=[];this.processTerm=function(b){var w=new sap.apf.core.utils.Filter(m,b);if(b.getOp()===sap.apf.core.constants.FilterOperators.EQ){this.disjunctions.push(w);}else{this.reducers.push(w);}};this.processOr=function(l,f,o){var i=new sap.apf.core.utils.CollectPropertiesAndValuesVisitor();i.process(o);if(i.isWellFormed()){this.disjunctions.push(o);}else{this.reducers.push(o);}};this.processAnd=function(l,f,b){var s=t.filterSeparation(b,m);this.disjunctions=this.disjunctions.concat(s.disjunctions);this.reducers=this.reducers.concat(s.reducers);};this.processEmptyFilter=function(){};this.process=function(b){b.traverse(this);};}this.filterSeparation=function(f,m){var c=new sap.apf.core.utils.CollectChildrenOfAndNodeVisitor();var b=c.process(f);var v;if(!b){return{reducers:[],disjunctions:[]};}v=new F(m);b.forEach(function(e){e.traverse(v);});return{reducers:v.reducers,disjunctions:v.disjunctions};};this.simplifyTransforms=function(T){var s=[];var r;var p=[];var l=T.length;var n;T.forEach(function(b,i){var j;n=b.property;if(p.indexOf(n)===-1){p.push(n);r=b;for(j=i+1;j<l;++j){if(n===T[j].property){r=t.intersection(r,T[j]);}}s.push(r);}});return s;};this.applyStartFilter=function(s,T){var r=[];var p=s.getProperties();T.forEach(function(b){var R=[];var j;var l=b.values.length;var v;if(p.indexOf(b.property)>-1){for(j=0;j<l;j++){v=b.values[j];if(s.isConsistentWithFilter(b.property,v)){R.push(v);}}r.push({property:b.property,values:R});}else{r.push(b);}});return r;};this.simplifyInStartFilter=function(s,T){var r=s;T.forEach(function(b){if(r){r=r.removeTermsByProperty(b.property);}});if(r.isEmpty()){return undefined;}return r;};this.containsContradiction=function(m,T){var a=false;T.forEach(function(b){if(b.values.length===0){a=true;}});if(a){return a;}return a;};this.rebuildDisjunction=function(m,b){var r=new sap.apf.core.utils.Filter(m);var p=b.property;var v=b.values;v.forEach(function(c){var f=new sap.apf.core.utils.FilterTerm(m,p,sap.apf.core.constants.FilterOperators.EQ,c);r.addOr(f);});return r;};this.filterReduction=function(m,f){var c=this;function b(R){var h=[];R.forEach(function(i){h.push(t.rebuildDisjunction(m,i));});return h;}function d(h,i){i.forEach(function(j){h.addAnd(j);});}function e(h,j){var i;var R=j;var k=[];var l;for(i=0;i<h.length;++i){R=c.applyStartFilter(h[i],j);if(c.containsContradiction(m,R)){return{contradiction:f};}l=c.simplifyInStartFilter(h[i],j);if(l){k.push(l);}}return{reducedTransforms:R,simplifiedReducers:k};}var s;var D;var T;var S;var r;var g;if(f.isFilterTerm()||f.isOr()||f.isEmpty()){return f;}s=this.filterSeparation(f,m);D=s.disjunctions;T=this.transformFilter(D);S=this.simplifyTransforms(T);if(this.containsContradiction(m,S)){a=true;return f;}g=e(s.reducers,S);if(g.contradiction){a=true;return g.contradiction;}r=new sap.apf.core.utils.Filter(m);d(r,g.simplifiedReducers);d(r,b(g.reducedTransforms));return r;};this.isContradicted=function(){return a;};};}());
