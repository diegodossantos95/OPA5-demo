/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.core.messageHandler");jQuery.sap.require("sap.apf.core.messageObject");jQuery.sap.require("sap.apf.core.messageDefinition");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.utils.utils");jQuery.sap.require("sap.apf.core.constants");sap.apf.core.MessageHandler=function(l){var a={initial:0,startup:1,running:2,shutdown:3};var t=this;var T;var L=[];var n=0;var b;var m;var c;var o=false;var d=false;var e=false;var D=false;var h=false;var u="";var f={code:sap.apf.core.constants.message.code.errorUnknown,severity:sap.apf.core.constants.message.severity.error,rawText:"Unknown Error occurred"};var g=a.initial;var C=[];this.setLifeTimePhaseStartup=function(i){g=a.startup;};this.setLifeTimePhaseRunning=function(){g=a.running;};this.setLifeTimePhaseShutdown=function(){g=a.shutdown;};this.fatalErrorOccurredAtStartup=function(){var i;if(g!==a.startup){return false;}for(i=0;i<C.length;i++){if(C[i].getSeverity()===sap.apf.core.constants.message.severity.fatal){return true;}}return false;};this.createMessageObject=function(i){var M=new sap.apf.core.MessageObject(i);if(l){if(M.getCode()===undefined){M.setCode(sap.apf.core.constants.message.code.errorUnknown);}s.bind(this)(M);v(M,1);}else if(i.enrichInfoInMessageObject===true){s.bind(this)(M);}return M;};this.activateOnErrorHandling=function(O){o=O;if(o===true){jQuery(window).on("error",y);}else{jQuery(window).off("error");}};this.setTextResourceHandler=function(i){T=i;};this.loadConfig=function(M,R){if(b===undefined||R){b=new sap.apf.utils.Hashtable(t);}for(var i=0;i<M.length;i++){x(M[i]);}};this.setMessageCallback=function(i){if(i!==undefined&&typeof i==="function"){m=i;}else{m=undefined;}};this.setCallbackForTriggeringFatal=function(i){if(i!==undefined&&typeof i==="function"){c=i;}else{c=undefined;}};this.putMessage=function(M){var P;var i=0;var A;if(M.getCode()===undefined){M.setCode(sap.apf.core.constants.message.code.errorUnknown);}s.bind(this)(M);if(M.getSeverity()===sap.apf.core.constants.message.severity.fatal){A=t.createMessageObject({code:sap.apf.core.constants.message.code.errorExitTriggered});s.bind(this)(A);A.setSeverity(sap.apf.core.constants.message.severity.fatal);if(A.getMessage()===""){A.setMessage("The app has stopped working due to a technical error.");}}P=M.getPrevious();while(P!==undefined&&P.type&&P.type==="messageObject"&&i<10){if(P.getCode()===undefined){P.setCode(sap.apf.core.constants.message.code.errorUnknown);}s.bind(this)(P);P=P.getPrevious();i++;}if(A!==undefined){A.setPrevious(M);M=A;}if(!l){v(M,10);}C.push(M);if(d){return;}if(M.getSeverity()===sap.apf.core.constants.message.severity.technError){return;}if(m!==undefined){if(g===a.shutdown||(g===a.startup&&M.getSeverity()!==sap.apf.core.constants.message.severity.fatal)){return;}d=true;m(M);d=false;}if(c!==undefined&&e===false){e=true;c(M);e=false;}if(M.getSeverity()===sap.apf.core.constants.message.severity.fatal&&g!==a.shutdown){if(sap.ui.Device.browser.firefox){h=true;}throw new Error(u);}};this.check=function(i,M,A){var E=A||sap.apf.core.constants.message.code.errorCheck;if(!i){var B=this.createMessageObject({code:E,aParameters:[M]});t.putMessage(B);}};this.getConfigurationByCode=function(E){if(b===undefined){return undefined;}return b.getItem(E);};this.getLogMessages=function(){return jQuery.extend(true,[],L);};this.reset=function(){b=undefined;m=undefined;L=[];C=[];};this.isOwnException=function(i){return(i&&i.message&&i.message.search(u)>-1);};function j(E){if(sap.ui.Device.browser.firefox){return h;}return(E.originalEvent&&E.originalEvent.message&&E.originalEvent.message.search(u)>-1);}function k(E){return(E.originalEvent&&E.originalEvent.message&&E.originalEvent.message.search(u)===-1&&E.originalEvent.message.search(sap.apf.core.constants.message.code.suppressFurtherException)>-1);}function p(){var i=sap.apf.utils.createPseudoGuid(32);return sap.apf.core.constants.message.code.suppressFurtherException+i;}function q(i){var A=parseInt(i,10);return(A==sap.apf.core.constants.message.code.errorExitTriggered||A==sap.apf.core.constants.message.code.errorUnknown||A==sap.apf.core.constants.message.code.errorInMessageDefinition);}function r(i){var A=parseInt(i,10);return(A==sap.apf.core.constants.message.code.errorExitTriggered||A==sap.apf.core.constants.message.code.errorInMessageDefinition);}function s(M){function i(G,H){var I=0;while(G.indexOf("{"+I+"}")>-1){if(typeof H[I]==="string"){G=G.replace("{"+I+"}",H[I]);}else{G=G.replace("{"+I+"}","undefined");}I++;}return G;}var A=M.getCode();var B=t.getConfigurationByCode(A);if(B===undefined){B=jQuery.extend(true,{},f);if(q(A)){if(M.hasRawText()){B.rawText=M.getRawText();}B.rawText+=' '+M.getParameters();if(r(A)){B.severity=sap.apf.core.constants.message.severity.fatal;}}else{B.rawText="Message "+A+"  "+M.getParameters()+" (Message Code has no Configuration)";}if(!q(A)){M.setCode(B.code);}}if(B.severity!==undefined){M.setSeverity(B.severity);}else{M.setSeverity(sap.apf.core.constants.message.severity.technError);}if(B.rawText){M.setMessage(B.rawText);}else{var P=M.getParameters();if(M.getSeverity()===sap.apf.core.constants.message.severity.technError){var E=t.getConfigurationByCode(B.code).text;if(!E){E=t.getConfigurationByCode(B.code).description;}M.setMessage(i(E,P));}else{try{if(T&&B.key){M.setMessage(T.getMessageText(B.key,M.getParameters()));}else if(B.description){M.setMessage(i(B.description,P));}else{M.setMessage("Message Code: "+A+" "+P.toString());}}catch(F){if(B.description){M.setMessage(i(B.description,P));}else{M.setMessage("Message Code: "+A+" "+P.toString());}}}}}function v(M,i){var A="APF message ";var P="";var B=i-1;if(i===0){return;}var E=M.getPrevious();if(E!==undefined){v(E,B);P=" - (see previous message for more information)";}n++;var F=A+'('+n+'): '+M.getCode()+" - "+M.getMessage()+P;if(D){alert("Fatal Error during Log Writing "+F);return;}D=true;if(M.getSeverity()===sap.apf.core.constants.message.severity.fatal){if(L.length<2){L.unshift(F);}}switch(M.getSeverity()){case sap.apf.core.constants.message.severity.warning:jQuery.sap.log.warning(F);break;case sap.apf.core.constants.message.severity.error:jQuery.sap.log.error(F);break;case sap.apf.core.constants.message.severity.fatal:jQuery.sap.log.error(F);break;case sap.apf.core.constants.message.severity.technError:jQuery.sap.log.error(F);break;default:jQuery.sap.log.info(F);}D=false;}function w(i){t.check(i!==undefined&&i.hasOwnProperty("code")!==false,"MessageHandler setItem: oItem is undefined or property 'code' is missing",sap.apf.core.constants.message.code.errorInMessageDefinition);var A=b.setItem(i.code,i);t.check((A===undefined),"MessageHandler setItem: Configuration includes duplicated codes",sap.apf.core.constants.message.code.errorInMessageDefinition);}function x(M){if(M.type===undefined){M.type="message";}w(M);}function y(E){var M;var i="";var A="";var U="";var B="";var F=true;if(sap.ui.Device.browser.firefox){F=false;}if(F&&E&&E.originalEvent){i=E.originalEvent.message;U=E.originalEvent.filename;A=E.originalEvent.lineno;}if(j(E)){E.stopImmediatePropagation();E.preventDefault();}else if(k(E)){return;}else if(d){B="";if(F){B=i+" (source: "+U+":"+A+")";}M=new sap.apf.core.MessageObject({code:"5070",aParameters:[B]});s.bind(this)(M);v(M,1);}else{B="";if(F){B=i+" (source: "+U+":"+A+")";}M=new sap.apf.core.MessageObject({code:"5070",aParameters:[B]});s.bind(this)(M);v(M,1);}}function z(){u=p();}z();};}());
