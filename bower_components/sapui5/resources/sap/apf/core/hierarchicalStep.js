/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.hierarchicalStep");jQuery.sap.require("sap.apf.core.step");jQuery.sap.require("sap.apf.core.utils.uriGenerator");jQuery.sap.require("sap.ui.model.odata.v2.ODataModel");jQuery.sap.require("sap.ui.model.Sorter");(function(){'use strict';sap.apf.core.HierarchicalStep=function(m,s,f,r,c){sap.apf.core.Step.call(this,m,s,f,r);var a;var b;this.type="hierarchicalStep";var d=f.getConfigurationById(s.request).service;var e=f.getConfigurationById(s.request).entityType;var g=c.getAnnotationsForService(d);var h=s.hierarchyProperty;var i=jQuery.Deferred();var j=c.getStartParameterFacade().getSapSystem();if(j){d=sap.ui.model.odata.ODataUtils.setOrigin(d,{force:true,alias:j});}jQuery.when(c.getMetadata(d),c.getEntityTypeMetadata(d,e)).then(function(o,p){var q=o.getHierarchyAnnotationsForProperty(e,h);if(q.type==="messageObject"){m.putMessage(q);}else{a=n(h,q);}i.resolve(o,q,p);});var M=new sap.ui.model.odata.v2.ODataModel(d,{annotationURI:g});var k=f.getConfigurationById(s.binding).requiredFilters;var l=f.createRequest({service:d,entityType:e,selectProperties:k,type:"request",id:"SelectionValidationRequest"});function n(h,o){var p=[h];for(var q in o){p.push(o[q]);}p=p.concat(f.getConfigurationById(s.request).selectProperties);return sap.apf.core.utils.uriGenerator.getSelectString(p);}this.update=function(o,p){i.done(function(q,t,u){var v=o.restrictToProperties(q.getFilterablePropertiesAndParameters(e));var F=!v.isEqual(b);b=v.copy();var w="/"+sap.apf.core.utils.uriGenerator.generateOdataPath(m,q,e,o,q.getUriComponents(e).navigationProperty);var x={};x.path=w;var y=o.restrictToProperties(q.getFilterableProperties(e));if(!y.isEmpty()){x.filters=[y.mapToSapUI5FilterExpression()];}x.parameters={select:a,operationMode:sap.ui.model.odata.OperationMode.Server,useServerSideApplicationFilters:true,treeAnnotationProperties:t};x.sorter=this.getSorter();this.getBinding().updateTreetable(x,M,u,F);if(!this.getFilter().isEmpty()&&F){var z=y.removeTermsByProperty(k[0]);l.sendGetInBatch(z.addAnd(this.getFilter()),function(A){var B=A.data;var C=this.getFilter().getFilterTerms();var D=[];C.forEach(function(E){B.forEach(function(G){if(G[k[0]]===E.getValue()){D.push(E.getValue());}});});this.getBinding().setFilterValues(D);p({},false);}.bind(this));}else{p({},false);}}.bind(this));};this.getSorter=function(){var o=[];var p=this.getBinding().getRequestOptions();if(p&&p.orderby&&p.orderby.length>0){p.orderby.forEach(function(q){o.push(new sap.ui.model.Sorter(q.property,q.descending));});}if(o.length===0){return;}return o;};this.setData=function(){};this.adjustCumulativeFilter=function(o){if(k[0]&&!this.getFilter().isEmpty()){return o.removeTermsByProperty(k[0]);}return o;};};})();
