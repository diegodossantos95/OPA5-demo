/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.utils.startFilterHandler');jQuery.sap.require('sap.apf.utils.filter');jQuery.sap.require('sap.apf.core.utils.filter');
sap.apf.utils.StartFilterHandler=function(a){'use strict';var s=[{isLevel:true}];var S=(a&&a.constructors&&a.constructors.StartFilter)||sap.apf.utils.StartFilter;var r={};var b={};var c={};var d={};var m=a.instances.messageHandler;var e=jQuery.Deferred();var f=jQuery.Deferred();var g=false;var p=jQuery.Deferred();var n=0;var h=0;var j;var k=jQuery.Deferred();this.getStartFilters=function(){l().done(function(){e.resolve(u());});return e.promise();};this.setRestrictionByProperty=function(i){if(!j){j=jQuery.Deferred();}n++;var B=i.getInternalFilter();var C=B.getProperties()[0];r[C]=i;l();j.done(function(){var D=true;w().forEach(function(E){if(E.getPropertyName()===C){if(B.isDisjunctionOverEqualities()){var F=k.state()==="pending";E.setSelectedValues(q(B),F);}else{E.setContext(B);}D=false;}});if(D){s.unshift(new S(a,{multiSelection:true,property:C,invisible:true,notConfigured:true},B));}if(p.state()==='resolved'){p=jQuery.Deferred();}if(a.functions.getFacetFilterConfigurations().length===0){p.resolve(z(x()));}b[C]=i;delete r[C];if(!c[C]){c[C]=i.serialize();}h++;if(h===n){A();k.resolve();}});};this.getRestrictionByProperty=function(i){if(b[i]){return b[i];}else if(r[i]){return r[i];}return new sap.apf.utils.Filter(m);};this.getCumulativeFilter=function(){var i=jQuery.Deferred();var B=new sap.apf.core.utils.Filter(m);var C;l().done(function(){C=w().length;if(C===0){i.resolve(new sap.apf.core.utils.Filter(m));}p.done(function(D,E,F){var G;G=new sap.apf.core.utils.Filter(m);if(D&&D.type==='internalFilter'){G=D;}if(jQuery.isArray(D)){D.forEach(function(H){G.addOr(new sap.apf.core.utils.Filter(m,F,'eq',H));});}if(E){B.addAnd(E).addAnd(G);}else{B=G;}i.resolve(B);});});return i.promise();};this.serialize=function(i,B){var C=jQuery.Deferred();var D;var E;var F={};F.startFilters=[];F.restrictionsSetByApplication={};for(E in b){F.restrictionsSetByApplication[E]=b[E].serialize();}D=w().length;if(w().length>0){w().forEach(function(G){G.serialize(i,B).done(function(H){F.startFilters.push(H);D--;if(D===0){C.resolve(F);}});});}else{C.resolve(F);}return C.promise();};this.deserialize=function(B){var C=jQuery.Deferred();p.done(function(){var s=w();var D;var E;b={};B.startFilters.forEach(function(F){for(var i=0,G=s.length;i<G;i++){if(F.propertyName===s[i].getPropertyName()){s[i].deserialize(F);}}});for(D in B.restrictionsSetByApplication){E=new sap.apf.utils.Filter(m);E.deserialize(B.restrictionsSetByApplication[D]);b[D]=E;}p=jQuery.Deferred();A();p.done(function(){C.resolve();});});return C;};this.resetAll=function(){var i;w().forEach(function(B){B.reset();});b={};for(i in c){b[i]=new sap.apf.utils.Filter(m).deserialize(c[i]);}A();};this.resetVisibleStartFilters=function(){u().forEach(function(D){D.reset();});var B=0;var C=s.length;for(var i=0;i<C;i++){if(s[i].isLevel){B=i+1;break;}}if(s[B]){s[B].setRestriction(d[s[B].getPropertyName()]);}};function l(){if(!g){g=true;a.instances.onBeforeApfStartupPromise.done(function(){a.functions.getReducedCombinedContext().done(function(B){var C=a.functions.getFacetFilterConfigurations();var D=B.getProperties();var E=D.length;var F=null;C.forEach(function(G){for(var i=0;i<E;i++){if(G.property===D[i]){F=D[i];break;}}if(F){s.push(new S(a,G,t(B,F)));D.splice(D.indexOf(F),1);F=null;}else{s.push(new S(a,G));}});D.forEach(function(i){s.unshift(new S(a,{property:i,invisible:true,multiSelection:true},t(B,i)));});if(!j){j=jQuery.Deferred();k.resolve();}j.resolve();k.done(function(){y().done(function(){o();f.resolve();});});});});}return f;}function o(){var s=v();s.forEach(function(B){B.getSelectedValues().done(C);function C(D,E){var F;var G=new sap.apf.core.utils.Filter(m);var H;E.done(C);for(var i=0;i<s.length;i++){if(s[i]===B){F=i;break;}}if(F===s.length-1){if(p.state()==='resolved'){p=jQuery.Deferred();}p.resolve(D,d[B.getPropertyName()],B.getPropertyName());return;}else if(p.state()==='resolved'){p=jQuery.Deferred();}if(D&&D.type==='internalFilter'){G=D;}else if(jQuery.isArray(D)){D.forEach(function(I){G.addOr(B.getPropertyName(),'eq',I);});}if(d[B.getPropertyName()]){if(G.isEmpty()){H=d[B.getPropertyName()].copy();}else{if(d[B.getPropertyName()].isOr()){H=new sap.apf.core.utils.Filter(m);H.addAnd(d[B.getPropertyName()]).addAnd(G);}else{H=d[B.getPropertyName()].copy().addAnd(G);}}}else{H=G;}d[s[F+1].getPropertyName()]=H;s[F+1].setRestriction(H);}});}function q(i){var B=[];i.getFilterTerms().forEach(function(C){B.push(C.getValue());});return B;}function t(B,C){var D=[];var E=B.getFilterTermsForProperty(C);var F=B.restrictToProperties([C]);if(F.toUrlParam().indexOf('%20and%20')>-1){return F;}for(var i=0,G=E.length;i<G;i++){if(E[i].getOp()!=='EQ'){return F;}D.push(E[i].getValue());}return D;}function u(){var i=[];w().forEach(function(B){if(B.isVisible()){i.push(B);}});return i;}function v(){var i=false;var B=[];s.forEach(function(C){if(C.isLevel){i=true;}else if(i===true){B.push(C);}});return B;}function w(){var i=[];s.forEach(function(B){if(!B.isLevel){i.push(B);}});return i;}function x(){var B=[];for(var i=0,C=s.length;i<C;i++){if(!s[i].isLevel){B.push(s[i]);}else{break;}}return B;}function y(){var B=jQuery.Deferred();C(z(x()));return B;function C(D){var i;var E=s.length;var F=D;var G=0;for(i=0;i<E;i++){if(s[i].isLevel){G=i+1;break;}}if(s[G]){s[G].setRestriction(F);d[s[G].getPropertyName()]=F.copy();H(G);}else{p.resolve(z(x()));B.resolve();}function H(I){if(s[I+1]){s[I].getSelectedValues().done(function(J){var K=new sap.apf.core.utils.Filter(m);if(J&&J.type==='internalFilter'){K.addOr(J);}else if(jQuery.isArray(J)){J.forEach(function(L){K.addOr(s[I].getPropertyName(),'eq',L);});}if(!K.isEmpty()){F.addAnd(K);}s[I+1].setRestriction(F);d[s[I+1].getPropertyName()]=F.copy();H(I+1);});}else{B.resolve();}}}}function z(i){var B=new sap.apf.core.utils.Filter(m);i.forEach(function(C){var D=new sap.apf.core.utils.Filter(m);C.getSelectedValues().done(function(E){if(E.type==='internalFilter'){D.addOr(E);}else{E.forEach(function(F){D.addOr(C.getPropertyName(),'eq',F);});}});B.addAnd(D);});return B;}function A(){var B=0;var C=s.length;for(var i=0;i<C;i++){if(s[i].isLevel){B=i+1;break;}}if(s[B]){var D=z(x());d[s[B].getPropertyName()]=D;s[B].setRestriction(D);}else{p.resolve(z(x()));}}};
