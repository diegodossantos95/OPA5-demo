/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2015 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.utils.externalContext');jQuery.sap.require('sap.apf.core.utils.filter');
sap.apf.utils.ExternalContext=function(a){'use strict';var d=jQuery.Deferred();var s=a.instances.startParameter.getEvaluationId();var x=a.instances.startParameter.getXappStateId();var m=a.instances.messageHandler;var e=this;var b=a.functions.ajax;this.getCombinedContext=function(){if(x){r();}else if(s){c();}else{d.resolve(new sap.apf.core.utils.Filter(m));}return d.promise();function n(f){if(f.levelOperator===sap.apf.core.constants.BooleFilterOperators.OR){return new sap.apf.core.utils.Filter(m,f);}return f;}function r(){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(a.instances.component,x).done(function(f){var g=f.getData();if(g&&g.sapApfCumulativeFilter){d.resolve(n(sap.apf.core.utils.Filter.transformUI5FilterToInternal(m,g.sapApfCumulativeFilter)));}else if(g&&g.selectionVariant){d.resolve(n(e.convertSelectionVariantToFilter(g.selectionVariant)));}else{d.resolve(new sap.apf.core.utils.Filter(m));}}).fail(function(){var f=m.createMessageObject({code:5045,aParameters:[x]});m.putMessage(f);});}function c(){a.functions.getConfigurationProperties().done(function(f){var g=f&&f.smartBusiness&&f.smartBusiness.runtime;if(g&&g.service){var h=g.service+"/EVALUATIONS('"+s+"')/FILTERS?$format=json";b({url:h,success:function(j){var p;var o;var k=new sap.apf.core.utils.Filter(m);var l=[];var t={};j.d.results.forEach(q);for(p in t){if(t.hasOwnProperty(p)){o=new sap.apf.core.utils.Filter(m);t[p].forEach(u);l.push(o);}}l.forEach(v);d.resolve(n(k));function q(w){if(!t[w.NAME]){t[w.NAME]=[];}t[w.NAME].push(new sap.apf.core.utils.Filter(m,w.NAME,w.OPERATOR,w.VALUE_1,w.VALUE_2));}function u(w){o.addOr(w);}function v(w){k.addAnd(w);}},error:function(j,t,k,l){var i=m.createMessageObject({code:5043,aParameters:[s,t]});if(l){i.setPrevious(l);}m.putMessage(i);}});}else{var i=m.createMessageObject({code:5044,aParameters:[s]});m.putMessage(i);}});}};this.convertParameterObject=function(p){var c;if(!p.PropertyName||p.PropertyValue===undefined||p.PropertyValue===null){if(!p.PropertyName){c=m.createMessageObject({code:5046,aParameters:[x]});}else{c=m.createMessageObject({code:5047,aParameters:[x,p.PropertyName]});}m.putMessage(c);}return new sap.apf.core.utils.FilterTerm(m,p.PropertyName,sap.apf.core.constants.FilterOperators.EQ,p.PropertyValue);};this.convertSelectOption=function(c){var e=this;var f=null;var i;var g;if(!c.PropertyName||!c.Ranges||!(jQuery.isArray(c.Ranges))){if(!c.PropertyName){g=m.createMessageObject({code:5048,aParameters:[x]});}else{g=m.createMessageObject({code:5049,aParameters:[x,c.PropertyName]});}m.putMessage(g);}f=new sap.apf.core.utils.Filter(m);for(i=0;i<c.Ranges.length;i++){var h=e.convertRange(c.Ranges[i],c.PropertyName);f.addOr(h);}return f;};this.convertRange=function(r,p){var c,l,o,f;if(r.Sign!='I'){c=m.createMessageObject({code:5050,aParameters:[x,p]});m.putMessage(c);}if(r.Option==='BT'&&(r.High===undefined||r.High===null)){c=m.createMessageObject({code:5051,aParameters:[x,p]});m.putMessage(c);}if(r.Option==='CP'){f=r.Low.split("\*");if(f.length>3||(f.length===3&&(f[0].length!==0||f[2].length!==0))||f.length===1){c=m.createMessageObject({code:5069,aParameters:[x,p]});m.putMessage(c);}if(r.Low.indexOf("*")===0&&r.Low.lastIndexOf("*")===r.Low.length-1){l=r.Low.substr(1,r.Low.lastIndexOf("*")-1);o='Contains';}else if(r.Low.indexOf("*")===0){l=r.Low.substr(1,r.Low.length-1);o='EndsWith';}else if(r.Low.lastIndexOf("*")===r.Low.length-1){l=r.Low.substring(0,r.Low.indexOf("*"));o='StartsWith';}return new sap.apf.core.utils.FilterTerm(m,p,o,l,r.High);}return new sap.apf.core.utils.FilterTerm(m,p,r.Option,r.Low,r.High);};this.convertSelectionVariantToFilter=function(c){var e=this;var f=new sap.apf.core.utils.Filter(m);var i;if(!c){return f;}if(c.Parameters&&!(jQuery.isArray(c.Parameters))){return f;}if(c.SelectOptions&&!(jQuery.isArray(c.SelectOptions))){return f;}if(c.Parameters){for(i=0;i<c.Parameters.length;i++){var g=e.convertParameterObject(c.Parameters[i]);f.addAnd(g);}}if(c.SelectOptions){for(i=0;i<c.SelectOptions.length;i++){var h=e.convertSelectOption(c.SelectOptions[i]);f.addAnd(h);}}return f;};};
