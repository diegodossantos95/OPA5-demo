/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.utils.navigationHandler");jQuery.sap.require("sap.apf.core.utils.filterSimplify");jQuery.sap.require("sap.apf.utils.utils");jQuery.sap.require("sap.ui.core.routing.HashChanger");sap.apf.utils.NavigationHandler=function(I){var c;var e;var m=I.instances.messageHandler;var n=this;var F=I.constructors&&I.constructors.FilterReduction||sap.apf.core.utils.FilterReduction;var f;this.getNavigationTargets=function(){var h;var i=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(e){h=jQuery.Deferred();h.resolve(d(e));return h.promise();}if(!i){var j=m.createMessageObject({code:5074});m.putMessage(j);e={global:[],stepSpecific:[]};return sap.apf.utils.createPromise(e);}if(!c){a();}e=jQuery.extend(true,[],c);e.forEach(function(l){l.text="";});h=jQuery.Deferred();k().done(function(l){e=l;h.resolve(d(e));});return h.promise();function k(){var h=jQuery.Deferred();var l=[];var D=[];e.forEach(function(o){var p;var q=[];if(o.parameters){q=o.parameters;}p=jQuery.Deferred();D.push(p);i.getLinks({semanticObject:o.semanticObject,action:o.action,params:b(q),ignoreFormFactor:false,ui5Component:I.instances.component}).then(function(r){r.forEach(function(s){var t=s.intent.split("-");var u=t[1].split("?");u=u[0].split("~");if(s.text!==""&&u[0]===o.action){o.text=s.text;l.push(o);}});p.resolve();},function(){p.resolve();});});jQuery.when.apply(jQuery,D).done(function(){h.resolve(l);});return h.promise();}};this.navigateToApp=function(h){if(!c){a();}var N=g(h);if(!N){return;}var i=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance();I.functions.getCumulativeFilterUpToActiveStep().done(function(C){if(I.functions.isFilterReductionActive&&I.functions.isFilterReductionActive()){f=new F();var o=f.filterReduction(m,C);if(o===null){m.putMessage(m.createMessageObject({code:5235}));}else{C=o;}}if(!N.filterMapping||!N.filterMapping.requestForMappedFilter){j(null,null);}else{var M=I.functions.createRequest(N.filterMapping.requestForMappedFilter);sap.apf.utils.executeFilterMapping(C,M,N.filterMapping.target,j,m);}function j(k,l){var p;if(l){return;}if(k){C=C.addAnd(k);}var q=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(q){I.instances.serializationMediator.serialize(true).done(function(s){n.generateSelectionVariant(C).done(function(r){var t={};t.sapApfState=s;t.sapApfCumulativeFilter=C.mapToSapUI5FilterExpression();t.selectionVariant=r;p=q.createEmptyAppState(I.instances.component);p.setData(t);p.save();if(i){i.replaceHash("sap-iapp-state="+p.getKey());}q.toExternal({target:{semanticObject:N.semanticObject,action:N.action},appStateKey:p.getKey(),params:b(N.parameters)},I.instances.component);});});}}});};this.checkMode=function(){var h=jQuery.Deferred();var i=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance&&sap.ui.core.routing.HashChanger.getInstance();var j=/(?:sap-iapp-state=)([^&=]+)/;var k,l,o,p;if(i){o=j.exec(i.getHash());if(o){k=o[1];}}l=I.functions.getXappStateId();if(k){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,k).done(function(q){p=q.getData();if(p.sapApfState){I.instances.serializationMediator.deserialize(p.sapApfState).done(function(){h.resolve({navigationMode:"backward"});});}});}else if(l){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,l).done(function(q){p=q.getData();if(p&&p.sapApfCumulativeFilter){h.resolve({navigationMode:"forward",sapApfCumulativeFilter:p.sapApfCumulativeFilter});}else{h.resolve({navigationMode:"forward"});}});}else{h.resolve({navigationMode:"forward"});}if(i){i.replaceHash("");}return h.promise();};this.generateSelectionVariant=function(h){var i=jQuery.Deferred();if(!I.functions.isFilterReductionActive||!I.functions.isFilterReductionActive()){f=new F();h=f.filterReduction(m,h);}if(!f||!f.isContradicted()){var s=h.mapToSelectOptions(I.functions.getAllParameterEntitySetKeyProperties);s.done(function(j){j.SelectionVariantID=jQuery.sap.uid();i.resolve(j);});}else{var j={};j={SelectionVariantID:jQuery.sap.uid(),Text:'Filter could not be converted to a selectionVariant'};i.resolve(j);}return i.promise();};function a(){c=I.functions.getNavigationTargets();}function g(h){for(var i=0,l=c.length;i<l;i++){if(c[i].id===h){return c[i];}}}function b(p){var h={};if(p&&p.length>0){p.forEach(function(i){h[i.key]=i.value;});return h;}}function d(t){var h=jQuery.extend(true,[],t);var r={global:[],stepSpecific:[]};h.forEach(function(j){if(j.isStepSpecific&&i(j.id)){delete j.isStepSpecific;r.stepSpecific.push(j);}else if(!j.isStepSpecific){delete j.isStepSpecific;r.global.push(j);}});return r;function i(j){var k=false;var l;var o=I.functions.getActiveStep();if(o&&o.getAssignedNavigationTargets){l=o.getAssignedNavigationTargets();if(l&&jQuery.isArray(l)){l.forEach(function(p){if(j===p.id){k=true;}});}}return k;}}};}());
