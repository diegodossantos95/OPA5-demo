/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/core/util/MockServer','sap/apf/utils/utils','sap/apf/utils/parseTextPropertyFile'],function(U,A){'use strict';jQuery.sap.require("jquery.sap.storage");var S=jQuery.sap.storage;return c;function c(d){var m=[];var l=S(S.Type.session);var s={setupConstants:function(_){this.constants={LOCAL_STORAGE_CONFIGURATION:"ApfConfiguration",LOCAL_STORAGE_TEXTS:"ApfTexts",CONFIGURATION_ENTITYSET:"AnalyticalConfigurationQueryResults",TEXTS_ENTITYSET:"TextElementQueryResults",RUNTIME_DATA_PATH:_+"model/apf/",RUNTIME_SERVICE_URL:"/sap/hba/r/apf/core/odata/apf.xsodata/",RUNTIME_SERVICE_METADATA:_+"model/apf/AnalysisPath.xml",PATH_ENTITYSET:"AnalysisPathQueryResults",MODELER_DATA_PATH:_+"model/apf/",CONFIGURATION_SERVICE:"/sap/hba/r/apf/core/odata/modeler/AnalyticalConfiguration.xsodata/",CONFIGURATION_SERVICE_METADATA:_+"model/apf/AnalyticalConfiguration.xml",DEMOKIT_SERVICE_URL:"/tmp/demokit/demokit.xsodata/",DEMOKIT_METADATA:_+"model/data/Demokit.xml",DEMOKIT_DATA_PATH:_+"model/data/",DEMOKIT_HIERARCHY_SERVICE_URL:"/tmp/demokit/hierarchy.xsodata/",DEMOKIT_HIERARCHY_METADATA:_+"model/data/hierarchyMetadata.xml",HIERARCHY_SERVICE_SPEC:{levelProperty:"Customer_Level",hierarchyNode:"Customer_NodeID",parentNode:"Customer_ParentID",measureName:"Revenue"}};},teardownMockserver:function(){m.forEach(function(_){_.stop();_.destroy();});},_getStorage:function(){return l;},getConfigurationId:function(n){var i;var e=n.indexOf(s.constants.LOCAL_STORAGE_CONFIGURATION);if(e!==-1){i=n.slice(e+s.constants.LOCAL_STORAGE_CONFIGURATION.length);}return i;},getAllConfigurationIdsInStorage:function(){var i=[];Object.keys(sessionStorage).forEach(function(n){var e=s.getConfigurationId(n);if(e){i.push(e);}});return i;},getConfigurationFromLocalStorage:function(e){return l.get(s.constants.LOCAL_STORAGE_CONFIGURATION+e);},idIsContained:function(e,i){return e.reduce(function(f,C){return f||C.AnalyticalConfiguration===i;},false);},importTextsFromFile:function(f,e,o){o=o||function(){};function h(j){var t=sap.apf.utils.parseTextPropertyFile(j,{instances:{messageHandler:function(){}}});var k=[];t.TextElements.forEach(function(n){k.push(n);});e.setEntitySetData(s.constants.TEXTS_ENTITYSET,k);o(k);}function i(j,t,k){var n="while importing \""+f+"\" jQuery.ajax fails with "+t+",  "+k;jQuery.sap.log.error(k);o({errorText:n,filePath:f});}jQuery.ajax({url:f,method:"GET",dataType:"text",error:i,success:h});},mockDemokitService:function(){var e=new sap.ui.core.util.MockServer({rootUri:s.constants.DEMOKIT_SERVICE_URL});e.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,p);e.simulate(s.constants.DEMOKIT_METADATA,s.constants.DEMOKIT_DATA_PATH);e.start();m.push(e);return e;},_loadAnalyticalConfiguration:function(r){function e(C){var f=C.AnalyticalConfiguration;C.SerializedAnalyticalConfiguration=s.getConfigurationFromLocalStorage(f);C.AnalyticalConfigurationName=JSON.parse(C.SerializedAnalyticalConfiguration).analyticalConfigurationName;}var C=r.mParameters.oEntry;if(C){if(C.SerializedAnalyticalConfiguration&&C.AnalyticalConfigurationName){e(C);}}else if(jQuery.isArray(r.mParameters.oFilteredData.results)){var E=r.mParameters.oFilteredData.results;E.forEach(function(C){e(C);});}},_initialLoadConfigurationsToMockServer:function(e,f){function i(_,k){for(var n in _){if(_.hasOwnProperty(n)){k(_[n]);}}}var r=[];s.getAllConfigurationIdsInStorage().forEach(function(k){var n=s.getConfigurationFromLocalStorage(k);var C=JSON.parse(n);j(C);});i(f,j);i(f,h);e.setEntitySetData("AnalyticalConfigurationQueryResults",r);function h(C){var k=C.configHeader.AnalyticalConfiguration;if(!s.getConfigurationFromLocalStorage(k)){var n=JSON.stringify(C);l.put(s.constants.LOCAL_STORAGE_CONFIGURATION+k,n);}}function j(C){var k=C.configHeader.AnalyticalConfiguration;if(s.idIsContained(r,k)){return;}var n=JSON.stringify(C);var o={AnalyticalConfiguration:k,Application:C.configHeader.Application,AnalyticalConfigurationName:C.configHeader.AnalyticalConfigurationName,SerializedAnalyticalConfiguration:n,CreationUTCDateTime:"/Date(1478533989544)/",LastChangeUTCDateTime:"/Date(1478533989544)/",CreatedByUser:"demokit engine",LastChangedByUser:null};r.push(o);}},savePath:function(r){var B=r.mParameters.oXhr.requestBody;var o=JSON.parse(B);if(!o.AnalysisPath){o.AnalysisPath=sap.apf.utils.createPseudoGuid();}if(!o.CreationUTCDateTime){o.CreationUTCDateTime="/Date("+new Date().getTime()+")/";}if(!o.LastChangeUTCDateTime){o.LastChangeUTCDateTime="/Date("+new Date().getTime()+")/";}r.mParameters.oXhr.requestBody=JSON.stringify(o);},mockRuntimeService:function(e,t){var f=null;h();s._initialLoadConfigurationsToMockServer(f,e);if(t){t();}return f;function h(){f=new U({rootUri:s.constants.RUNTIME_SERVICE_URL});f.attachBefore(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,s.savePath,s.constants.PATH_ENTITYSET);f.attachBefore(sap.ui.core.util.MockServer.HTTPMETHOD.POST,s.savePath,s.constants.PATH_ENTITYSET);f.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s._loadAnalyticalConfiguration,s.constants.CONFIGURATION_ENTITYSET);f.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s.loadTexts,s.constants.TEXTS_ENTITYSET);f.simulate(s.constants.RUNTIME_SERVICE_METADATA,s.constants.RUNTIME_DATA_PATH);m.push(f);f.start();}},mockConfigurationService:function(e,t){var f=null;h();s._initialLoadConfigurationsToMockServer(f,e);if(t){t();}return f;function h(){f=new U({rootUri:s.constants.CONFIGURATION_SERVICE});f.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s._loadAnalyticalConfiguration,s.constants.CONFIGURATION_ENTITYSET);f.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,s.saveAnalyticalConfiguration.bind(null,"PUT"),s.constants.CONFIGURATION_ENTITYSET);f.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.POST,s.saveAnalyticalConfiguration.bind(null,"POST"),s.constants.CONFIGURATION_ENTITYSET);f.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.POST,s.saveText,s.constants.TEXTS_ENTITYSET);f.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,s.saveText,s.constants.TEXTS_ENTITYSET);f.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s.loadTexts,s.constants.TEXTS_ENTITYSET);f.simulate(s.constants.CONFIGURATION_SERVICE_METADATA,s.constants.MODELER_DATA_PATH);m.push(f);f.start();}},saveAnalyticalConfiguration:function(e,r){var f=r.mParameters.oEntity.SerializedAnalyticalConfiguration;var C;var h=r.mParameters.oEntity.AnalyticalConfiguration;if(e==="POST"){h=sap.apf.utils.createPseudoGuid();r.mParameters.oEntity.AnalyticalConfiguration=h;C=JSON.parse(f);C.configHeader.AnalyticalConfiguration=h;f=JSON.stringify(C);r.mParameters.oEntity.SerializedAnalyticalConfiguration=f;}l.put(s.constants.LOCAL_STORAGE_CONFIGURATION+h,f);},saveText:function(r){r.mParameters.oEntity=r.mParameters.oEntity||{};if(!sap.apf.utils.isValidGuid(r.mParameters.oEntity.TextElement)){r.mParameters.oEntity.TextElement=sap.apf.utils.createPseudoGuid();}var t=l.get(s.constants.LOCAL_STORAGE_TEXTS);if(!t){t=[];}else{t=JSON.parse(t);}t.push({TextElement:r.mParameters.oEntity.TextElement,TextElementDescription:r.mParameters.oEntity.TextElementDescription,MaximumLength:r.mParameters.oEntity.MaximumLength,TextElementType:r.mParameters.oEntity.TextElementType});l.put(s.constants.LOCAL_STORAGE_TEXTS,JSON.stringify(t));},loadTexts:function(r){var t=l.get(s.constants.LOCAL_STORAGE_TEXTS);if(t){r.mParameters.oFilteredData=r.mParameters.oFilteredData||{};r.mParameters.oFilteredData.results=r.mParameters.oFilteredData.results||[];t=JSON.parse(t);t.forEach(function(e){r.mParameters.oFilteredData.results.push(e);});}},mockHierarchyService:function(){var h=jQuery.sap.sjax({url:s.constants.DEMOKIT_DATA_PATH+"RevenueHryQueryResults.json",dataType:"json"}).data;var e=new sap.ui.core.util.MockServer({rootUri:s.constants.DEMOKIT_HIERARCHY_SERVICE_URL});e.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,r);e.simulate(s.constants.DEMOKIT_HIERARCHY_METADATA,s.constants.DEMOKIT_DATA_PATH);e.start();m.push(e);function r(w){var x;var y=w.getParameters().oFilteredData;var z=w.getParameters().oXhr.url;var B=z.indexOf("P_Currency")+14;var C=z.indexOf("%27",B);var D=z.slice(B,C);var E=u(JSON.parse(JSON.stringify(h)),"Currency",[D],true);E=u(E,"Country",n(z,"Country"),true);E=u(E,"Customer",n(z,"Customer"),true);x=E;var F=n(z,"Customer_NodeID");if(F.length>0){E=j(E,F);}var G=z.indexOf("Customer_ParentID%20eq")+28;if(G>=28){var H=z.indexOf("%27",G);var I=z.slice(G,H);E=u(E,"Customer_ParentID",[t(I)],false);}if(z.indexOf("Customer_Level%20eq%200")>-1){E=i(E);}o(E,x);v(E);E=f(E);k(E,z);y.results=E;a(w);}function f(w){var x=[];w.forEach(function(y){if(y.Revenue===undefined||y.Revenue>0){x.push(y);}});return x;}function i(w){var x=[];var y=[];w.forEach(function(z){y.push(z.Customer_NodeID);});w.forEach(function(z){if(y.indexOf(z.Customer_ParentID)===-1){x.push(z);}});return x;}function j(w,x){var y=[];var z=false;var B=[];x.forEach(function(D){B.push(t(D));});w.forEach(function(D){if(B.indexOf(D.Customer_NodeID)>-1){y.push(D);z=true;}});function C(D){if(B.indexOf(D.Customer_ParentID)>-1&&B.indexOf(D.Customer_NodeID)===-1){y.push(D);B.push(D.Customer_NodeID);z=true;}}while(z){z=false;w.forEach(C);}return y;}function k(w,x){x=t(x);var y=x.indexOf("$select");if(y>-1&&w.length>0){var z=x.indexOf("$",y+1);Object.keys(w[0]).forEach(function(B){if(B!=="__metadata"){var C=x.indexOf(B+"&",y);var D=x.indexOf(B+",",y);var E=C===-1?D:C;if(E<0||(z>-1&&E>z)){w.forEach(function(F){delete F[B];});}}});}}function n(w,x){var y=0;var z=[];z[y]=[];var B=w.indexOf(x+"%20eq%20%27")+x.length+11;while(B>=x.length+11){if(D&&D>-1&&D<B){y++;z[y]=[];}var C=w.indexOf("%27",B);z[y].push(w.slice(B,C));var D=w.indexOf("%20and%20",C);B=w.indexOf(x+"%20eq%20%27",C)+x.length+11;}if(y>0){var E=z[0];var F=[];z.forEach(function(G){E.forEach(function(H){if(G.indexOf(H)>=0){F.push(H);}});E=F;});return F;}return z[y];}function o(w,x){w.forEach(function(y){if(y.Revenue===null){y.Revenue=q(y,x);}});}function q(w,x){var y=w.Customer_NodeID;var z=0;x.forEach(function(B){if(B.Customer_ParentID===y){if(B.Revenue===null){z+=q(B,x);}else{z+=B.Revenue;}}});return z;}function t(w){return w.replace(new RegExp("%3a","g"),":").replace(new RegExp("%20","g")," ").replace(new RegExp("%2c","g"),",");}function u(w,x,V,E){if(V.length===0){return w;}var y=[];w.forEach(function(z){if((z[x]===null&&E)||V.indexOf(z[x])>=0){y.push(z);}});return y;}function v(w){w.forEach(function(x){x.__metadata={"id":"/tmp/demokit/hierarchy.xsodata/RevenueHryQueryResults('"+x.GenID+"')","type":"tmp.demokit.demokit.RevenueHryQueryResultsType","uri":"/tmp/demokit/hierarchy.xsodata/RevenueHryQueryResults('"+x.GenID+"')"};});}}};s.setupConstants(d);return s;}function p(d){var u=d.mParameters.oXhr.url;var e=b(u);var f=e.couldParse&&(e.parameters.$top!==undefined||e.parameters.$skip!==undefined);if(f){var h=jQuery.extend({},e.parameters);delete h.$top;delete h.$skip;var i=g(e.path,h);var r=jQuery.sap.sjax({url:i,dataType:"json"}).data.d.results;var $=e.parameters.$skip||0;var j=e.parameters.$top;if(j){r=r.slice($,Number($)+Number(j));}else{r=r.slice($);}d.mParameters.oFilteredData.results=r;}else{a(d);}}function a(d){var m=["Revenue","ShippingCosts","Discount","NumberOfOrders"];var r=[];if(d&&d.mParameters&&d.mParameters.oFilteredData&&d.mParameters.oFilteredData.results){var e=d.mParameters.oFilteredData.results;if(e.length>0){var h={};var f=Object.getOwnPropertyNames(e[0]);var i=[];var j=[];f.forEach(function(l){if(l!=="__metadata"){if(m.indexOf(l)>-1){j.push(l);}else{i.push(l);}}});if(j.length>0){e.forEach(function(l){var n="";var o=false;i.forEach(function(q){if(l[q]===null){o=true;}n=n+l[q];});if(o){return;}if(!h[n]){h[n]=l;j.forEach(function(q){h[n][q]=Number(l[q]);});}else{j.forEach(function(q){h[n][q]=Number(h[n][q])+Number(l[q]);});}});r=jQuery.map(h,function(v){return v;});r=s(r,d.mParameters.oXhr.url);if(r.length>0){d.mParameters.oFilteredData.results=r;}}else if(i.length===1||i.length===2){var k=[];e.forEach(function(l){if(jQuery.inArray(l[i[0]],k)===-1){k.push(l[i[0]]);r.push(l);}});if(r.length>0){d.mParameters.oFilteredData.results=r;}}}}function s(l,u){var n=b(u);if(n.couldParse){var o=t(n.parameters["$orderby"]);if(o.length===0){return l;}var q=l.sort(function(v,w){var x=o.filter(function(y){return v[y.attr]!==w[y.attr];})[0];if(!x){return 0;}if(v[x.attr]>w[x.attr]){return x.direction;}return-x.direction;});return q;}return l;function t(v){if(typeof v!=="string"){return[];}var O=v.split(",").map(function(I){var w=I.trim().split("%20");if(w[1]&&w[1].toLowerCase().trim()==="desc"){return{attr:w[0].trim(),direction:-1};}return{attr:w[0].trim(),direction:1};});return O;}}}function b(u){if(typeof u!=="string"){return{couldParse:false};}var q=u.split("?");if(q.length<1||q.length>2){return{couldParse:false};}else if(q.length==1){return{couldParse:true,path:q[0],parameters:{}};}var d={};q[1].split("&").map(function(e){var f=e.split("=");var l=f[0];var r=f[1];return{lhs:l,rhs:r};}).forEach(function(e){d[e.lhs]=e.rhs;});return{couldParse:true,path:q[0],parameters:d};}function g(d,e){var f=Object.keys(e).map(function(k){return k+"="+e[k];}).join("&");return d+"?"+f;}});
