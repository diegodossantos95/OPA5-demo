jQuery.sap.declare("sap.zen.crosstab.EventHandler");jQuery.sap.require("sap.zen.crosstab.TouchHandler");jQuery.sap.require("sap.zen.crosstab.SelectionHandler");jQuery.sap.require("sap.zen.crosstab.rendering.CrossRequestManager");jQuery.sap.require("sap.zen.crosstab.rendering.RenderingConstants");jQuery.sap.require("sap.zen.crosstab.utils.Utils");jQuery.sap.require("sap.zen.crosstab.keyboard.CrosstabKeyboardNavHandler");jQuery.sap.require("sap.zen.crosstab.HeaderResizer");jQuery.sap.require("sap.zen.crosstab.ColResizer");
sap.zen.crosstab.EventHandler=function(c){"use strict";var t=this;var r=c.getRenderEngine();var C=r.getCrossRequestManager();var d=c.getDataArea();var R=c.getRowHeaderArea();var o=c.getColumnHeaderArea();var D=c.getDimensionHeaderArea();var h=null;var k=new sap.zen.crosstab.keyboard.CrosstabKeyboardNavHandler(c,this);var m=null;var p=false;var T=null;var s="";var I=null;var H=null;var a=null;this.handleHierarchyClick=function(e,i,l){var n=f(i);var q=n.getHierarchyAction();var u=n.getDrillState();if(u!=="L"){C.saveTableDimensions();C.saveHScrollInfo(l);C.saveVScrollInfo(l);j(q);}sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.handleSortClick=function(e,i,l){var n=f(i);var S=n.getSortAction();if(S||c.getTestProxy().getTestAction()){C.saveVScrollInfo(l);C.saveHScrollInfo(l);C.saveColWidths();if(!c.getTestProxy().getTestAction()){j(S);}}sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.findTargetId=function(e){var i=null;var J;var l;l=$(e).attr("xtabspacer-cellid");if(l&&l.length>0){i=l;}else{J=$(e).closest("div");if(J.length>0){var n=J.attr("id");if(n){var q=n.indexOf("_contentDiv");if(q>-1){i=n.slice(0,q);}}}}return i;};this.executeOnClickAction=function(e){if(p){return;}m=null;p=false;var i=e.target.id;if(!i){i=t.findTargetId(e.target);}if(!i){return;}var l=g(i);if(l==="sort"){t.handleSortClick(e,i,l);}else if(l==="hier"){t.handleHierarchyClick(e,i,l);}else if(l==="__ce"){t.handleClickOnCell(e,i);}else if(l==="vhlp"){t.handleValueHelpClick(i);}sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.handleClickOnCell=function(e,i){if(c.hasLoadingPages()){sap.zen.crosstab.utils.Utils.cancelEvent(e);return;}if(i){var l=c.getUtils().getCellIdFromContenDivId(i);if(l){var M=sap.ui.getCore().getControl(l);if(M){if(M.isEntryEnabled()){t.handleInputEnabledCell(i,-1,-1);}else{if(c.getSelectionMode()!==undefined&&c.getSelectionMode()!==""){var F="";if(e.ctrlKey){F="CTRL";}else if(e.shiftKey){F="SHIFT";}c.getSelectionHandler().handleCellClick(M,F);}}}}}};this.postPlanningValue=function(){if(c.isPlanningMode()===true&&I&&I.length>0){var J=$(document.activeElement);if(J.is("input")&&I.attr("id")===J.attr("id")){var i=I.val()||"";if(i!==s){I.blur();}}}};this.provideInputEnabledCell=function(M,i,l,S,n){I=l.find("input");if(I.length===0){var q=l.text();var u=l.html();var v=M.getArea().isDataArea();var w=null;var x=function(V){var U=M.getUnit();if(U&&U!==""){var e=V.toUpperCase().indexOf(U.toUpperCase());if(e!==-1){if(e===0){V=V.substring(e+U.length);}else{V=V.substring(0,e);}}}var O=c.calculateOffset(M);V=$.trim(V);var F=c.getTransferDataCommand();F=F.replace("__ROW__",M.getRow()+"");F=F.replace("__COL__",(M.getCol()-O)+"");F=F.replace("__VALUE__",V);F=F.replace("__CTYPE__",M.getPassiveCellType());C.saveVScrollInfo("plan");C.saveHScrollInfo("plan");C.saveColWidths();j(F,true);};var y=function(e){if(I.val()!==q){x(I.val());var F=$('<div/>').text(q).html();u=u.replace(F,I.val());}A(e);};var z=function(e){var F=true;var i=null;var J=null;var G=null;if(e&&e.relatedTarget&&e.relatedTarget.id&&c.getValueHelpStatus()!==sap.zen.crosstab.VHLP_STATUS_OPENING){i=e.relatedTarget.id;G=$(document.getElementById(i));J=c.getTableDiv();F=G.closest(J).length>0;}return F;};var A=function(e){var J=$(document.getElementById(i+"_contentDiv"));J.html(u);if(w&&v){J.width(w);}if(z(e)===true){J.focus();}else{k.reset();s="";I.off("keydown focusout");I=null;}};var B=function(e){if(e.which===27){A();sap.zen.crosstab.utils.Utils.cancelEvent(e);}if(e.which===13){if(I.val()!==q){sap.zen.crosstab.utils.Utils.cancelEvent(e);x(I.val());}else{A();if(c.isIE8Mode()){k.keyboardNavKeyHandler(e);}}}if(e.which===38||e.which===40){return true;}if(e.which===37||e.which===39){if(!e.ctrlKey&&!e.altKey&&!e.shiftKey){sap.zen.crosstab.utils.Utils.stopEventPropagation(e);}return true;}if(e.which===115&&!v){t.invokeValueHelp(M,"vhlp_"+M.getId());}};var E=0;if(v){E=l.innerWidth();w=sap.zen.crosstab.utils.Utils.getWidthFromStyle(l);}l.html("<input id=\""+i+"_input"+"\" type=\"text\" value=\""+q+"\" />");if(v){l.width(E+"px");}I=$(document.getElementById(i+"_input"));if(sap.zen.crosstab.utils.Utils.isMainMode()){I.addClass("sapzencrosstab-EntryEnabledInput-MainMode");}else{I.addClass("sapzencrosstab-EntryEnabledInput");}I.on("keydown",B);I.focus();c.getUtils().selectTextInInputField(I,S,n);I.on("focusout",y);}else{c.getUtils().selectTextInInputField(I,S,n);}s=I.val()||"";};this.handleValueHelpClick=function(e){var i=f(e);t.invokeValueHelp(i,e);};this.invokeValueHelp=function(e,i){if(e){k.focusNewCell(e,-1,-1);var l=c.getCallValueHelpCommand();var O=c.calculateOffset(e);C.saveVScrollInfo("plan");C.saveHScrollInfo("plan");C.saveColWidths();l=l.replace("__ROW__",e.getRow());l=l.replace("__COL__",e.getCol()-O);l=l.replace("__DOM_REF_ID__",i);j(l,true);}};this.handleInputEnabledCell=function(e,S,i){if(e){e=c.getUtils().getCellIdFromContenDivId(e);if(e){var M=sap.ui.getCore().getControl(e);if(M){if(M.getArea().isDataArea()||M.getArea().isRowHeaderArea()){k.focusNewCell(M,S,i);}}}}};this.sendSelectCommand=function(e){var i=-1;var l=-1;var A="";if(e){var n=e.getArea();if(n.isRowHeaderArea()){A="ROWS";}else if(n.isColHeaderArea()){A="COLUMNS";}else{A="DATA";}i=e.getRow();l=e.getCol();}var q=c.getOnSelectCommand();q=q.replace("__ROW__",i+"");q=q.replace("__COL__",l+"");q=q.replace("__AXIS__",A);j(q,true);};this.getContextElement=function(e,l){var n=[];var i=0;var J=$(document.elementFromPoint(e,l));var q=J.closest(".zenControl");var u=q.attr("id");u=J.attr("id");while(u&&u.indexOf("droparea")>-1){n.push(J);J.css("display","none");J=$(document.elementFromPoint(e,l));u=J.attr("id");}for(i=0;i<n.length;i++){n[i].css("display","block");}return J;};this.onContextMenuClick=function(e){var J=t.getContextElement(e.clientX,e.clientY);var i=c.createContextMenu();var l=i.getContext(J);if(l){var n=c.getPropertyBag().getContextMenuCommand();n=n.replace("__AXIS__",l.sAxis);n=n.replace("__ROW__",l.iRow);n=n.replace("__COL__",l.iCol);n=n.replace("__ID__","CONTEXT_MENU");n=n.replace("__DOM_REF_ID__",J.attr("id"));if(n.indexOf("__REMOVE_SELECTION__")>=0){n=n.replace("__REMOVE_SELECTION__",l.bRemoveSelection);}var q=sap.bi.framework.getService(null,"zen.rt.components.dynamicmenu");q.showDynamicMenu("ExpandedMenuBuilder",J.context,"",{"command":n},"",["crosstabActions"],"",false);}sap.zen.crosstab.utils.Utils.cancelEvent(e);c.enableClick();};this.attachEvents=function(){var A=false;var J=c.getRenderSizeDiv();var i=c.getTableDiv();J.unbind("mousedown");J.bind("mousedown",this.onMouseDown);if(c.getPropertyBag().isMobileMode()||c.getPropertyBag().isTestMobileMode()){J.unbind('click');J.bind('click',function(e){sap.zen.crosstab.utils.Utils.cancelEvent(e);});J.unbind('mousedown');J.bind('mousedown',function(e){sap.zen.crosstab.utils.Utils.cancelEvent(e);});T=new sap.zen.crosstab.TouchHandler(this,c);T.registerTouchEvents(J);k.setEnabled(false);if(c.getPropertyBag().isEnableColResize()===true){var l=new sap.zen.crosstab.ColResizer(c);T.setColResizer(l);}T.registerTouchEvents(oJqTitleDiv);}else{J.unbind("mouseup",this.onMouseUp);J.bind("mouseup",this.onMouseUp);i.unbind("mouseup",this.onMouseUp);i.bind("mouseup",this.onMouseUp);J.unbind('click');J.bind('click',this.executeOnClickAction);if(c.isSelectable()===true&&c.isHoveringEnabled()===true){J.unbind('mouseover');J.bind('mouseover',this.executeOnMouseEnter);J.unbind('mouseout');J.bind('mouseout',this.executeOnMouseOut);}k.setEnabled(c.isPlanningMode());k.attachEvents(J);if(c.getUserHeaderWidthCommand()&&c.getUserHeaderWidthCommand().length>0){H=new sap.zen.crosstab.HeaderResizer(c);H.initialize();A=true;}if(c.getPropertyBag().isEnableColResize()===true){a=new sap.zen.crosstab.ColResizer(c);a.initialize();A=true;}if(A===true){J.unbind("mousemove",this.onMouseMove);J.bind("mousemove",this.onMouseMove);}}};this.onMouseMove=function(e){if(a&&a.isResizeAction()){a.onMouseMove(e);}else if(H&&H.isResizeAction()){H.onMouseMove(e);}};this.onMouseDown=function(e){var i=e.target.id;var l=g(i);m=i;};function b(i,e){var l=false;var n=document.getElementById(i);if(n){var q=n.getBoundingClientRect();var u=(q.left<e.clientX)&&(e.clientX<q.right);var v=(q.bottom>e.clientY)&&(e.clientY>q.top);l=u&&v;}return l;}this.onMouseUp=function(e){if(a&&a.isResizeAction()){a.onMouseUp(e);}else if(H&&H.isResizeAction()){H.onMouseUp(e);}else{p=false;if(m){var i=c.getUtils().getCellIdFromContenDivId(m);if(b(i,e)){var l=sap.ui.getCore().getControl(i);if(l){if(c.isPlanningMode()){var n=document.getElementById(m);var P=null;if(n){P=c.getUtils().getSelectionParams(n);}if(P.iSelectionStartPos>=0||P.iSelectionEndPos>=0){p=true;t.handleInputEnabledCell(e.target.id,P.iSelectionStartPos,P.iSelectionEndPos);}}}}else{if(!c.isDragAction()){sap.zen.crosstab.utils.Utils.cancelEvent(e);sap.zen.crosstab.utils.Utils.stopEventPropagation(e);}p=true;}}}};this.restoreFocusOnCell=function(){k.restoreFocusOnCell();};function g(i){var A=i.slice(0,4);return A;}function f(i){var e=i.slice(5);return sap.ui.getCore().getControl(e);}function j(A,e){if(A){if(!e){}c.getUtils().executeCommandAction(A);}}this.handleHoverEntry=function(e){if(e){var i=c.getUtils().getCellIdFromContenDivId(e);if(i&&i!==undefined){var M=sap.ui.getCore().getControl(i);if(M&&M!==undefined){c.getSelectionHandler().handleCellHoverEntry(M);}}}};this.executeOnMouseEnter=function(e){var P=null;var i=e.target.id;if(c.hasLoadingPages()){sap.zen.crosstab.utils.Utils.cancelEvent(e);return;}if(!i){i=t.findTargetId(e.target);}if(!i){return;}P=g(i);if(P==="__ce"){t.handleHoverEntry(i);}sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.executeOnMouseOut=function(e){c.getSelectionHandler().handleCellHoverOut(e);sap.zen.crosstab.utils.Utils.cancelEvent(e);};this.enableClick=function(){p=false;m=null;};this.getColResizer=function(){return a;};};
