// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/renderers/fiori2/allMyApps/AllMyAppsManager'],function(A){"use strict";var s=false,K=function(v){this.init(v);};sap.ui.controller("sap.ushell.renderers.fiori2.allMyApps.AllMyApps",{oStateEnum:{FIRST_LEVEL:0,SECOND_LEVEL:1,DETAILS:2,FIRST_LEVEL_SPREAD:3},iNumberOfProviders:0,onInit:function(){this.bFirstLoadOfAllMyApps=true;var a=new sap.ui.model.json.JSONModel();a.setProperty("/AppsData",[]);this.getView().setModel(a,'allMyAppsModel');sap.ui.getCore().getEventBus().subscribe("launchpad","allMyAppsFirstCatalogLoaded",this.updateMasterFocusAndDetailsContext,this);sap.ui.getCore().getEventBus().subscribe("launchpad","allMyAppsFirstCatalogLoaded",this.onDetailLoad,this);sap.ui.getCore().getEventBus().subscribe("launchpad","allMyAppsMasterLoaded",this.onMasterLoad,this);sap.ui.getCore().getEventBus().subscribe("launchpad","allMyAppsNoCatalogsLoaded",this.onNoCatalogsLoaded,this);},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("launchpad","allMyAppsFirstCatalogLoaded",this.updateMasterFocusAndDetailsContext);sap.ui.getCore().getEventBus().unsubscribe("launchpad","allMyAppsFirstCatalogLoaded",this.onDetailLoad,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","allMyAppsMasterLoaded",this.onMasterLoad,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","allMyAppsNoCatalogsLoaded",this.onNoCatalogsLoaded,this);},onAfterRendering:function(){var t=this,v=this.getView(),a=v.getModel("allMyAppsModel"),S=v.oSplitApp;if(!this.bAfterInitialLoading){S.toMaster("allMyAppsMasterBusyIndicator","show");if(!sap.ui.Device.system.phone){S.toDetail("allMyAppsDetailBusyIndicator","show");}}if(this.bFirstLoadOfAllMyApps){a.setProperty("/AppsData",[]);}else{var m=a.getProperty("/AppsData");m.splice(0,1);a.setProperty("/AppsData",m);}setTimeout(function(){t._getAllMyAppsManager().loadAppsData(a,t._getPopoverObject(),t.bFirstLoadOfAllMyApps);s=t._isSingleDataSource();t.switchToInitialState();t.bFirstLoadOfAllMyApps=false;},100);},switchToInitialState:function(){var v=this.getView(),S=v.getModel(),b,o,a,c=v.getModel().getProperty("/ShellAppTitleState");if(this._isSingleDataSource()){S.setProperty('/allMyAppsMasterLevel',this.oStateEnum.FIRST_LEVEL_SPREAD);v.oDataSourceList.bindItems("allMyAppsModel>/AppsData/0/groups",v.oDataSourceListTemplate);}else{S.setProperty('/allMyAppsMasterLevel',this.oStateEnum.FIRST_LEVEL);v.oDataSourceList.bindItems("allMyAppsModel>/AppsData",v.oDataSourceListTemplate);}if(sap.ui.Device.system.phone){o=this.getView().oSplitApp;o.toMaster("sapUshellAllMyAppsMasterPage","show");}v.oDataSourceList.rerender();this.updateMasterFocusAndDetailsContext(undefined,undefined,{bFirstCatalogLoadedEvent:false});this._getPopoverHeaderLabel().setText(sap.ushell.resources.i18n.getText("allMyApps_headerTitle"));b=this._getPopoverHeaderBackButton();if(c===this._getShellAppTitleStateEnum().ALL_MY_APPS_ONLY){b.setVisible(false);}else{b.setVisible(true);}},handleSwitchToMasterAreaOnPhone:function(){var S=this.getView().oSplitApp,o=this.getView().getModel(),a=this._getDataSourcesSelectedPath(),p=a.split('/'),b=this.getView().getModel().getProperty("/ShellAppTitleState"),B=this._getPopoverHeaderBackButton();S.toMaster("sapUshellAllMyAppsMasterPage","show");if(this._isSingleDataSource()){o.setProperty('/allMyAppsMasterLevel',this.oStateEnum.FIRST_LEVEL_SPREAD);if(b===this._getShellAppTitleStateEnum().ALL_MY_APPS_ONLY){B.setVisible(false);}}else if(p.length===3){o.setProperty('/allMyAppsMasterLevel',this.oStateEnum.FIRST_LEVEL);if(b===this._getShellAppTitleStateEnum().ALL_MY_APPS_ONLY){B.setVisible(false);}}else{o.setProperty('/allMyAppsMasterLevel',this.oStateEnum.SECOND_LEVEL);}},handleMasterListItemPress:function(o){var c=this._getClickedDataSourceItemPath(o),v=this.getView(),a=v.getModel('allMyAppsModel'),C=a.getProperty(c+"/type"),S=v.getModel(),b=S.getProperty('/allMyAppsMasterLevel'),i=(C===sap.ushell.Container.getService("AllMyApps").getProviderTypeEnum().CATALOG),I=S.getProperty('/isPhoneWidth'),t=this.getShellAppTitleToggleListButton(),B;this.lastPressedMasterItem=o.getParameter('listItem');if(i||(b===this.oStateEnum.FIRST_LEVEL_SPREAD)||(b===this.oStateEnum.SECOND_LEVEL)){B=this.handleMasterListItemPress_toDetails(o);}else{B=this.handleMasterListItemPress_toSecondLevel(o);}v.oCustomLabel.setBindingContext(B,'allMyAppsModel');v.oCustomLink.setBindingContext(B,'allMyAppsModel');v.oCustomPanel.setBindingContext(B,'allMyAppsModel');if(t.getVisible()){t.firePress();t.setPressed(false);t.focus();}},handleMasterListItemPress_toSecondLevel:function(o){var c=this._getClickedDataSourceItemPath(o),v=this.getView(),b,S=v.getModel().getProperty("/ShellAppTitleState"),a=v.getModel('allMyAppsModel'),C=a.getProperty(c+"/type"),d=a.getProperty(c+"/title"),e=v.getModel(),f=this.getView().oSplitApp,B,g;if(!sap.ui.Device.system.phone){f.toDetail("sapUshellAllMyAppsDetailsPage");}v.oDataSourceList.bindItems('allMyAppsModel>'+c+"/groups",v.oDataSourceListTemplate);e.setProperty('/allMyAppsMasterLevel',this.oStateEnum.SECOND_LEVEL);if(S===this._getShellAppTitleStateEnum().ALL_MY_APPS_ONLY){b=this._getPopoverHeaderBackButton();b.setVisible(true);}this._setBindingContext(c+"/groups/0",v.oItemsContainer);v.oDataSourceList.rerender();v.oDataSourceList.setSelectedItem(v.oDataSourceList.getItems()[0]);g=v.oDataSourceList.getSelectedItem();if(g){g.focus();}if(C===sap.ushell.Container.getService("AllMyApps").getProviderTypeEnum().HOME){this._getPopoverHeaderLabel().setText(sap.ushell.resources.i18n.getText("allMyApps_homeEntryTitle"));}else if(C===sap.ushell.Container.getService("AllMyApps").getProviderTypeEnum().EXTERNAL){this._getPopoverHeaderLabel().setText(d);}this._getDetailsHeaderLabel().setText(a.getProperty(c+"/groups/0/title"));return B;},handleMasterListItemPress_toDetails:function(c){var C=this._getClickedDataSourceItemPath(c),v=this.getView(),S=v.getModel(),a=v.getModel('allMyAppsModel'),o=v.oSplitApp,b=this._getPopoverHeaderBackButton(),B=this._setBindingContext(C,v.oItemsContainer);this._getDetailsHeaderLabel().setText(a.getProperty(C+"/title"));if(sap.ui.Device.system.phone){o.toDetail("sapUshellAllMyAppsDetailsPage");S.setProperty('/allMyAppsMasterLevel',this.oStateEnum.DETAILS);b.setVisible(true);}return B;},onMasterLoad:function(){var v=this.getView(),S=v.oSplitApp,b=this._getPopoverHeaderBackButton();this.bAfterInitialLoading=true;if(S.getCurrentMasterPage()==v.oMasterBusyIndicator){S.toMaster("sapUshellAllMyAppsMasterPage","show");}b.focus();s=this._isSingleDataSource();this.updateMasterFocusAndDetailsContext(undefined,undefined,{bFirstCatalogLoadedEvent:false});},onDetailLoad:function(){var v=this.getView(),S=v.oSplitApp;this.bAfterInitialLoading=true;if(!sap.ui.Device.system.phone){S.toDetail("sapUshellAllMyAppsDetailsPage","show");}},onNoCatalogsLoaded:function(){var v=this.getView(),S=v.oSplitApp;if((!sap.ui.Device.system.phone)&&(!s)){S.toDetail("sapUshellAllMyAppsEmptyDetailsPage","show");}else if((!sap.ui.Device.system.phone)&&s){S.toDetail("sapUshellAllMyAppsDetailsPage");}},updateMasterFocusAndDetailsContext:function(c,e,d){var v=this.getView(),S=v.getModel(),a=v.getModel('allMyAppsModel'),f=this._getInitialFirstLevelSelectionIndex(),b,B,o,g=this.getView().oSplitApp;if(s===true){b=a.createBindingContext("/AppsData/0/groups/0");B=a.getProperty(b.sPath);}else{b=a.createBindingContext("/AppsData/"+f);B=a.getProperty(b.sPath);}v.oItemsContainer.setBindingContext(b,'allMyAppsModel');v.oCustomLabel.setBindingContext(b,'allMyAppsModel');v.oCustomLink.setBindingContext(b,'allMyAppsModel');v.oCustomPanel.setBindingContext(b,'allMyAppsModel');if(B!==undefined){this._getDetailsHeaderLabel().setText(B.title);}if(d.bFirstCatalogLoadedEvent===true){v.oDataSourceList.rerender();}if(d.bFirstCatalogLoadedEvent===false&&f===0){this.onNoCatalogsLoaded();}v.oDataSourceList.setSelectedItem(v.oDataSourceList.getItems()[f]);o=v.oDataSourceList.getSelectedItem();if(o){o.focus();}if(d.bFirstCatalogLoadedEvent){jQuery.sap.measure.end("FLP:ShellAppTitle.onClick");jQuery.sap.measure.end("FLP:ShellNavMenu.footerClick");}},handleGroupPress:function(e){var d=this.getView().oCustomLink.getBindingContext("allMyAppsModel").getObject();if(d.handlePress){d.handlePress(e,d);}},toggleMasterArea:function(){var S=this.getView().oSplitApp;!this.bMasterShown?S.showMaster():S.hideMaster();this.bMasterShown=!this.bMasterShown;},onAppItemClick:function(c){var a=this.getView().getModel('allMyAppsModel'),C=c.getBindingContext("allMyAppsModel").sPath,u=a.getProperty(C+"/url");if(u){if(u[0]==='#'){hasher.setHash(u);setTimeout(function(){this.getView().getParent().close();}.bind(this),50);}else{window.open(u,'_blank');}}},getCurrentState:function(){var S=this.getView().getModel();return S.getProperty('/allMyAppsMasterLevel');},getStateEnum:function(){return this.oStateEnum;},_isSingleDataSource:function(){var a=sap.ushell.Container.getService("AllMyApps");if(a.isCatalogAppsEnabled()){return false;}if(!a.isExternalProviderAppsEnabled()&&a.isHomePageAppsEnabled()){return true;}if(a.isExternalProviderAppsEnabled()&&Object.keys(a.getDataProviders()).length===1&&!a.isHomePageAppsEnabled()){return true;}return false;},_getInitialFirstLevelSelectionIndex:function(){var v=this.getView(),a=v.getModel('allMyAppsModel'),d=a.getProperty("/AppsData"),i,t;for(i=0;i<d.length;i++){t=d[i];if(t.type===sap.ushell.Container.getService("AllMyApps").getProviderTypeEnum().CATALOG){return i;}}return 0;},_getPopoverHeaderBackButton:function(){return this._getPopoverHeaderContent(0);},getShellAppTitleToggleListButton:function(){return this._getPopoverHeaderContent(1);},_getPopoverHeaderContent:function(c){var C,h,b;C=this._getPopoverObject().getCustomHeader();h=C.getContentLeft();b=h[c];return b;},_getPopoverHeaderLabel:function(){var c,C;c=this._getPopoverObject().getCustomHeader();C=c.getContentMiddle();return C[0];},_getPopoverObject:function(){return this.getView().getParent();},_getDetailsHeaderLabel:function(){return this.getView().oDetailsHeaderLabel;},_setBindingContext:function(b,B){var a=this.getView().getModel("allMyAppsModel"),o=a.createBindingContext(b);B.setBindingContext(o,"allMyAppsModel");return o;},_getClickedDataSourceItemPath:function(o){var c=o.getParameter("listItem");return c.getBindingContext('allMyAppsModel').sPath;},_getAllMyAppsManager:function(){return A;},_getDataSourcesSelectedPath:function(){return this.lastPressedMasterItem.getBindingContextPath();},_getShellAppTitleStateEnum:function(){var S=sap.ui.getCore().byId("shellAppTitle");return S.getStateEnum();},initKeyBoardNavigationHandling:function(){if(this.keyboardNavigation){this.keyboardNavigation.destroy();}this.keyboardNavigation=new K(this.getView());}});K.prototype.init=function(v){this.keyCodes=jQuery.sap.KeyCodes;v.oDataSourceList.addEventDelegate({onsaptabnext:function(e){var d=jQuery('.sapUshellAllMyAppsListItem');this.jqDetailAreaElement=v.oItemsContainer.$();this.jqDetailAreaElement.on('keydown.keyboardNavigation',this.keydownHandler.bind(this));this._setItemFocus(e,d[0]);}.bind(this)});v.oItemsContainer.addEventDelegate({onsaptabprevious:function(e){var c=jQuery('.sapUshellAllMyAppsListItem[tabindex="0"]')[0];jQuery(c).attr('tabindex',-1);},onsaptabnext:function(e){var c=jQuery('.sapUshellAllMyAppsCustomPanel'),C=jQuery('.sapUshellAllMyAppsListItem[tabindex="0"]')[0];if(c.length===0){jQuery(C).attr('tabindex',-1);}}});v.oCustomPanel.addEventDelegate({onsaptabnext:function(e){var c=jQuery('.sapUshellAllMyAppsListItem[tabindex="0"]')[0];jQuery(c).attr('tabindex',-1);}});};K.prototype.keydownHandler=function(e){var d=jQuery('.sapUshellAllMyAppsListItem'),c=jQuery('.sapUshellAllMyAppsListItem[tabindex="0"]')[0];switch(e.keyCode){case this.keyCodes.ARROW_UP:this.arrowKeyHandler(e,-2);break;case this.keyCodes.ARROW_DOWN:this.arrowKeyHandler(e,2);break;case this.keyCodes.ARROW_LEFT:this.arrowKeyHandler(e,-1);break;case this.keyCodes.ARROW_RIGHT:this.arrowKeyHandler(e,1);break;default:break;}};K.prototype.arrowKeyHandler=function(e,d){var D=jQuery('.sapUshellAllMyAppsListItem').toArray(),c=jQuery('.sapUshellAllMyAppsListItem[tabindex="0"]')[0],C=D.indexOf(c),E=D[C+d];if(E){jQuery(c).attr('tabindex',-1);this._setItemFocus(e,E);}};K.prototype._setItemFocus=function(e,E){if(E){e.preventDefault();e.stopImmediatePropagation();jQuery(E).attr('tabindex',0);E.focus();}};K.prototype.destroy=function(){if(this.jqDetailAreaElement){this.jqDetailAreaElement.off(".keyboardNavigation");}delete this.jqDetailAreaElement;};},false);
