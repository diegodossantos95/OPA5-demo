sap.ui.define([],function(){"use strict";jQuery.sap.declare('sap.ushell.renderers.fiori2.search.SearchFacetsFormatter');var a=sap.ushell.renderers.fiori2.search.SearchFacetsFormatter=function(){this.init.apply(this,arguments);};jQuery.sap.declare('sap.ushell.renderers.fiori2.search.Facet');var F=sap.ushell.renderers.fiori2.search.Facet=function(){this.init.apply(this,arguments);};jQuery.sap.declare('sap.ushell.renderers.fiori2.search.FacetItem');var b=sap.ushell.renderers.fiori2.search.FacetItem=function(){this.init.apply(this,arguments);};F.prototype={init:function(p){this.title=p.title;this.facetType=p.facetType;this.dimension=p.dimension;this.dataType=p.dataType;this.items=p.items||[];this.totalCount=p.totalCount;},hasFilterCondition:function(f){for(var i=0,l=this.items.length;i<l;i++){var c=this.items[i].filterCondition||this.items[i];if(c.equals&&c.equals(f)){return true;}}return false;},hasFilterConditions:function(){for(var i=0,l=this.items.length;i<l;i++){if(this.items[i].filterCondition){return true;}}return false;},removeItem:function(f){for(var i=0,l=this.items.length;i<l;i++){var c=this.items[i].filterCondition||this.items[i];if(c.equals&&f.filterCondition&&c.equals(f.filterCondition)){return this.items.splice(i,1);}}}};b.prototype={init:function(p){p=p||{};this.selected=p.selected||false;this.level=p.level||0;this.filterCondition=p.filterCondition;this.value=p.value||"";this.label=p.label||"";this.facetTitle=p.facetTitle||"";this.facetAttribute=p.facetAttribute||"";this.valueLabel=this.value;this.advanced=p.advanced||false;this.listed=p.listed||false;},equals:function(o){return(this.facetTitle===o.facetTitle&&this.label===o.label&&this.value===o.value&&this.filterCondition.equals(o.filterCondition));},clone:function(){var n=new sap.ushell.renderers.fiori2.search.FacetItem();n.facetTitle=this.facetTitle;n.selected=this.selected;n.label=this.label;n.level=this.level;n.value=this.value;n.valueLabel=this.valueLabel;n.filterCondition=this.filterCondition.clone();return n;}};a.prototype={init:function(){},_getAncestorDataSources:function(s){var r=[];var A=s.dataSourceTree.findNode(s.getProperty("/uiFilter/dataSource")).getAncestors().reverse();for(var i=0;i<A.length;i++){var d=A[i].dataSource;var c=new b({label:d.labelPlural,filterCondition:d,level:0,value:A[i].count});r.push(c);}return r;},_getSiblingDataSources:function(s,l){var S=[];var c=s.getProperty("/uiFilter/dataSource");var d=s.dataSourceTree.findNode(c);var e;if(d.parent&&!d.unsureWhetherNodeisBelowRoot){e=d.parent.getChildren();}else{e=[];}if(e.length===0){e.push(d);}for(var j=0,f=e.length;j<f;j++){var g=e[j].dataSource;var h=new b({label:g.labelPlural,value:e[j].count,filterCondition:g,selected:c.equals(g),level:l});S.push(h);if(h.selected){S.push.apply(S,this._getChildrenDataSources(s,l+1));}}return S;},_getChildrenDataSources:function(s,l){var c=[];var d=s.getProperty("/uiFilter/dataSource");var C=s.dataSourceTree.findNode(d).getChildren();for(var j=0,e=C.length;j<e;j++){var f=C[j].dataSource;var g=new b({label:f.labelPlural,value:C[j].count,filterCondition:f,selected:false,level:l});c.push(g);}return c;},getDataSourceFacetFromTree:function(s){var d=new F({facetType:"datasource",title:"Search In"});var c=s.getProperty("/uiFilter/dataSource");var A=this._getAncestorDataSources(s);d.items.push.apply(d.items,A);var S=this._getSiblingDataSources(s,s.allDataSource.equals(c)?0:1);d.items.push.apply(d.items,S);return d;},_findAttributeLabelOfFilterGroup:function(f){for(var i=0;i<f.conditions.length;i++){var c=f.conditions[i];if(c instanceof window.filter.Condition){return c.attributeLabel;}else if(c instanceof window.filter.ConditionGroup){return this._findAttributeLabelOfFilterGroup(c);}}},_findAttributeOfFilterGroup:function(f){for(var i=0;i<f.conditions.length;i++){var c=f.conditions[i];if(c instanceof window.filter.Condition){return c.attribute;}else if(c instanceof window.filter.ConditionGroup){return this._findAttributeOfFilterGroup(c);}}},_createFacetItemsFromConditionGroup:function(c){var f=[];for(var i=0;i<c.conditions.length;i++){var d=c.conditions[i];if(d instanceof window.filter.Condition){f.push(new b({label:d.valueLabel?d.valueLabel:d.value,facetTitle:d.attributeLabel,facetAttribute:d.attribute,filterCondition:d,selected:true}));}else if(d instanceof window.filter.ConditionGroup){for(var j=0;j<d.conditions.length;j++){var n=d.conditions[j];if(n instanceof window.filter.Condition){f.push(new b({label:n.valueLabel?n.valueLabel:n.value,filterCondition:n,selected:true,facetTitle:n.attributeLabel,facetAttribute:n.attribute}));}else if(n instanceof window.filter.ConditionGroup){f.push(new b({label:n.label,filterCondition:n,selected:true,facetTitle:this._findAttributeLabelOfFilterGroup(n),facetAttribute:this._findAttributeOfFilterGroup(n)}));}}}}return f;},getAttributeFacetsFromPerspective:function(r,s){var S=r.getChartFacets().filter(function(B){return B.facetType==="attribute";});var c=[];var C={};var d={};var f=this._createFacetItemsFromConditionGroup(s.getProperty("/uiFilter/defaultConditionGroup"));for(var i=0,l=S.length;i<l;i++){var o=S[i];var e=new F({title:o.title,facetType:o.facetType,dimension:o.dimension,totalCount:o.query.resultSet.totalCount});if(!o.query.resultSet||!o.query.resultSet.elements||o.query.resultSet.elements.length===0){continue;}for(var j=0;j<o.query.resultSet.elements.length;j++){var g=o.query.resultSet.elements[j];var h=new b({value:g.valueRaw,filterCondition:g.dataSource||g.labelRaw,label:g.label});if(g.labelRaw){if(g.labelRaw.attributeLabel){h.facetTitle=g.labelRaw.attributeLabel;}else if(g.labelRaw.conditions){h.facetTitle=this._findAttributeLabelOfFilterGroup(g.labelRaw);}}h.serverSideItem=true;e.items.push(h);}d[o.dimension]=e;c.push(e);}for(var k=0,p=f.length;k<p;k++){var q=f[k];var t=d[q.facetAttribute];if(!t){t=new F({dimension:q.filterCondition.attribute?q.filterCondition.attribute:q.filterCondition.conditions[0].attribute,title:q.facetTitle,facetType:"attribute",items:[q]});d[q.facetAttribute]=t;c.splice(0,0,t);}else{var u=c.indexOf(t);if(u>0){c.splice(u,1);c.splice(0,0,t);}var v=false;for(var m=0,w=t.items.length;m<w;m++){var x=t.items[m];if(q.filterCondition.equals(x.filterCondition)){x.selected=true;v=true;if(!s.config.multiSelect){x.value=null;x.valueLabel=null;}}}if(!v){t.items.push(q);}}C[q.facetTitle]=t;}if(!s.config.multiSelect){for(var y in C){if(C.hasOwnProperty(y)){var z=C[y];for(var n=z.items.length-1;n>=0;n--){var A=z.items[n];if(!A.selected){z.items.splice(n,1);}}}}}return this.addDataTypeToClientSideFacets(c,s);},addDataTypeToClientSideFacets:function(c,s){var d=s.getDataSource();if(d.type==="Category"||d.type=="Apps"){return $.when([]);}var m=d.getMetaData();if(!m||!m.then){return $.when(c);}return m.then(function(m){var M,f,D,A,e;if(d.type==="Category"){return c;}if(!m||!m.attributeMap){return c;}M=m.attributeMap;for(var i=0;i<c.length;i++){f=c[i];D=f.dimension;A=M[D];e=A.type;if(typeof e==="string"){e=e.toLowerCase();}if(e==="string"||e==="char"||e==="edm.string"){e="text";}f.dataType=e;}return c;});},getFacets:function(d,i,s){var f=[this.getDataSourceFacetFromTree(s)];if(d.equals(s.appDataSource)||(d.getTypeAsString&&d.getTypeAsString().indexOf('Category')>-1)){return $.when(f);}if(!i){var c=[];return $.when(c);}var e=this.getAttributeFacetsFromPerspective(i,s);var r=e.then(function(A){if(A.length>0){f.push.apply(f,A);}return f;});return r;},getFacetItemsWithFilterConditions:function(s){return this._createFacetItemsFromConditionGroup(s.getProperty("/uiFilter/defaultConditionGroup"));},getDialogFacetsFromMetaData:function(m,s){var S=jQuery.map(m.attributeMap,function(h){return h;});var c=[];for(var i=0,l=S.length;i<l;i++){var o=S[i];var A=false;if(o.accessUsage){for(var j=0;j<o.accessUsage.length;j++){if(s.aAllowedAccessUsage.indexOf(o.accessUsage[j])>=0){A=true;break;}}}else{A=true;}if(A){var C=new F({title:o.label,facetType:"attribute",dimension:o.labelRaw,dataType:o.type});var f=this._createFacetItemsFromConditionGroup(s.getProperty("/uiFilter/defaultConditionGroup"));var d=0;for(var k=0,e=f.length;k<e;k++){var g=f[k];if(g.facetAttribute===C.dimension){d++;C.items.splice(0,0,g);}}C.count=d;c.push(C);}}return c;},getDialogFacetsFromChartQuery:function(r,s,i){var c=new F({dimension:r.dimensions[0]});for(var j=0;j<r.elements.length;j++){var f=r.elements[j];var d=new b({value:f.valueRaw,filterCondition:f.labelRaw,label:f.label,facetAttribute:r.dimensions[0]});c.items.push(d);}var e;if(i){e=this._createFacetItemsFromConditionGroup(s.getProperty("/uiFilter/defaultConditionGroup"));}else{e=s.aFilters;}for(var k=0,l=e.length;k<l;k++){var S=e[k];if(S.facetAttribute===c.dimension){var g=false;for(var m=0,h=c.items.length;m<h;m++){var n=c.items[m];if(S.filterCondition.equals(n.filterCondition)){n.selected=true;g=true;}}if(!g){c.items.splice(0,0,S);S.advanced=true;}else{S.listed=true;}}}return c;}};return a;});
