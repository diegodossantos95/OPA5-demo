sap.ui.define(['sap/ushell/renderers/fiori2/search/SearchHelper','sap/ushell/renderers/fiori2/search/suggestions/SinaSuggestionProvider','sap/ushell/renderers/fiori2/search/suggestions/DataSourceSuggestionProvider','sap/ushell/renderers/fiori2/search/suggestions/AppSuggestionProvider','sap/ushell/renderers/fiori2/search/suggestions/TimeMerger'],function(S,a,D,A,T){"use strict";jQuery.sap.declare('sap.ushell.renderers.fiori2.search.suggestions.SuggestionHandler');var s=sap.ushell.renderers.fiori2.search.suggestions;var b=function(){this.init.apply(this,arguments);};b.prototype={init:function(){this.terms={};},addTerm:function(t){t=t.trim().toLowerCase();this.terms[t]=true;},hasTerm:function(t){t=t.trim().toLowerCase();return!!this.terms[t];},clear:function(){this.terms={};}};s.SuggestionHandler=function(){this.init.apply(this,arguments);};s.SuggestionHandler.prototype={init:function(p){var t=this;t.model=p.model;t.sina=t.model.sina;t.suggestionProviders=[];t.suggestionTermBuffer=new b();t.keyboardRelaxationTime=400;t.uiUpdateInterval=500;t.uiClearOldSuggestionsTimeOut=1000;t.dataSourceSuggestionProvider=new D({model:t.model,sina:t.sina,suggestionTermBuffer:t.suggestionTermBuffer});t.appSuggestionProvider=new A({model:t.model,suggestionTermBuffer:t.suggestionTermBuffer});t.doSuggestionInternal=S.delayedExecution(t.doSuggestionInternal,t.keyboardRelaxationTime);t.timeMerger=new T();},abortSuggestions:function(c){if(c===undefined||c===true){this.model.setProperty("/suggestions",[]);}if(this.clearSuggestionTimer){clearTimeout(this.clearSuggestionTimer);this.clearSuggestionTimer=null;}this.doSuggestionInternal.abort();this.getSuggestionProviders().done(function(d){for(var i=0;i<d.length;++i){var e=d[i];e.abortSuggestions();}});this.timeMerger.abort();},getSuggestionProviders:function(){var t=this;if(t.suggestionProvidersDeferred){return t.suggestionProvidersDeferred;}var c=[t.appSuggestionProvider];if(!t.model.config.searchBusinessObjects){t.suggestionProvidersDeferred=jQuery.when(c);return t.suggestionProvidersDeferred;}t.suggestionProvidersDeferred=t.sina.sinaSystem().getServerInfo().then(function(d){c.push.apply(c,t.createSinaSuggestionProviders(d));return jQuery.when(c);},function(){return jQuery.when(c);});return t.suggestionProvidersDeferred;},createSinaSuggestionProviders:function(c){var p=[{suggestionTypes:[window.sinabase.SuggestionType.HISTORY],activeSuggestionTypes:[]},{suggestionTypes:[window.sinabase.SuggestionType.DATASOURCE],activeSuggestionTypes:[]},{suggestionTypes:[window.sinabase.SuggestionType.OBJECTDATA],activeSuggestionTypes:[]}];var d=c.services.Suggestions.suggestionTypes;var e;var f=false;for(var i=0;i<d.length;++i){var g=d[i];if(g===window.sinabase.SuggestionType.DATASOURCE){f=true;}for(var j=0;j<p.length;++j){e=p[j];if(e.suggestionTypes.indexOf(g)<0){continue;}e.activeSuggestionTypes.push(g);}}var h=[];for(var k=0;k<p.length;++k){e=p[k];if(e.activeSuggestionTypes.length===0){continue;}h.push(new a({model:this.model,sina:this.sina,suggestionTermBuffer:this.suggestionTermBuffer,suggestionQuery:this.model.suggestionQuery,suggestionTypes:e.activeSuggestionTypes}));}if(!f){h.push(this.dataSourceSuggestionProvider);}return h;},isSuggestionPopupVisible:function(){return jQuery('.searchSuggestion').filter(':visible').length>0;},doSuggestion:function(){var t=this;if(this.isSuggestionPopupVisible()){this.abortSuggestions(false);this.clearSuggestionTimer=setTimeout(function(){t.clearSuggestionTimer=null;t.model.setProperty("/suggestions",[]);},t.uiClearOldSuggestionsTimeOut);}else{this.abortSuggestions();}this.doSuggestionInternal();},doSuggestionInternal:function(){var t=this;var c=t.model.getProperty("/uiFilter/searchTerms");if(c.length===0){return;}if(c.trim()==='*'){return;}t.model.eventLogger.logEvent({type:t.model.eventLogger.SUGGESTION_REQUEST,suggestionTerm:t.model.getProperty('/uiFilter/searchTerms'),dataSourceKey:t.model.getProperty('/uiFilter/dataSource').key});t.suggestionTermBuffer.clear();t.getSuggestionProviders().done(function(d){var p=[];var f=true;var e=d.length;for(var i=0;i<d.length;++i){var g=d[i];p.push(g.getSuggestions());}t.timeMerger.abort();t.timeMerger=new T(p,t.uiUpdateInterval);t.timeMerger.process(function(r){e-=r.length;var s=[];for(var j=0;j<r.length;++j){var h=r[j];s.push.apply(s,h);}if(e>0&&s.length===0){return;}if(t.clearSuggestionTimer){clearTimeout(t.clearSuggestionTimer);t.clearSuggestionTimer=null;}t.insertSuggestions(s,f);f=false;});});},insertSuggestions:function(i,f){var s=this.model.getProperty('/suggestions');if(f){s=[];}var g=this._groupByPosition(i);for(var p in g){var c=g[p];this._insertSuggestions(s,c);}this.model.setProperty('/suggestions',s);},_groupByPosition:function(s){var g={};for(var i=0;i<s.length;++i){var c=s[i];var d=g[c.position];if(!d){d=[];g[c.position]=d;}d.push(c);}return g;},_insertSuggestions:function(s,i){if(i.length<=0){return;}var c=i[0];var d=0;for(;d<s.length;++d){var e=s[d];if(e.position>c.position){break;}}var f=[d,0];f.push.apply(f,i);s.splice.apply(s,f);}};return s.SuggestionHandler;});
