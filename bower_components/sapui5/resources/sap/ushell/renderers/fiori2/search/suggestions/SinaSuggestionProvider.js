sap.ui.define(['sap/ushell/renderers/fiori2/search/SearchHelper','sap/ushell/renderers/fiori2/search/suggestions/SinaBaseSuggestionProvider','sap/ushell/renderers/fiori2/search/suggestions/SuggestionTypeProps'],function(S,a,b){"use strict";var s=window.sinabase;jQuery.sap.declare('sap.ushell.renderers.fiori2.search.suggestions.SinaSuggestionProvider');var m=sap.ushell.renderers.fiori2.search.suggestions.SinaSuggestionProvider=function(){this.init.apply(this,arguments);};m.prototype=jQuery.extend(new a(),{suggestionLimit:jQuery.device.is.phone?5:7,init:function(p){a.prototype.init.apply(this,arguments);this.getResultSet=S.refuseOutdatedRequests(this.getResultSet);this.dataSourceDeferred=null;},abortSuggestions:function(){this.getResultSet.abort();},getResultSet:function(){return this.suggestionQuery.getResultSet();},getSuggestions:function(){var t=this;this.suggestions=[];this.firstObjectDataSuggestion=true;this.numberSuggestionsByType={};for(var c in s.SuggestionType){this.numberSuggestionsByType[s.SuggestionType[c]]=0;}var d=t.model.getProperty('/uiFilter/searchTerms');if(this.suggestionTypes.length===1&&this.suggestionTypes.indexOf(s.SuggestionType.OBJECTDATA)>=0&&d.length<3){return jQuery.when(this.suggestions);}t.createAllAndAppDsSuggestions();if(!t.model.isBusinessObjSearchEnabled()){return jQuery.when(this.suggestions);}if(t.model.getDataSource().equals(t.model.appDataSource)){return jQuery.when(this.suggestions);}t.prepareSuggestionQuery(d);return t.getResultSet().then(function(r){var e=r.getElements();t.formatSinaSuggestions(e);return t.suggestions;});},createAllAndAppDsSuggestions:function(){if(this.suggestionTypes.indexOf(s.SuggestionType.DATASOURCE)<0){return;}if(!this.model.getDataSource().equals(this.model.allDataSource)){return;}var d=[];d.unshift(this.model.appDataSource);d.unshift(this.model.allDataSource);var c=this.model.getProperty('/uiFilter/searchTerms');var e=c.replace(/\*/g,'');var t=new S.Tester(e);for(var i=0;i<d.length;++i){var f=d[i];if(f.key===this.model.getDataSource().key){continue;}var T=t.test(f.label);if(T.bMatch===true){var g={};g.label='<i>'+sap.ushell.resources.i18n.getText("searchInPlaceholder",[""])+'</i> '+T.sHighlightedText;g.labelRaw='';g.dataSource=f;g.type=s.SuggestionType.DATASOURCE;g.position=b[s.SuggestionType.DATASOURCE].position;g.key=f.key;this.addSuggestion(g);}}},preFormatSuggestions:function(c){for(var i=0;i<c.length;++i){var d=c[i];d.position=b[d.type].position;if(d.type===s.SuggestionType.DATASOURCE){d.key=d.labelRaw.key;}else{d.key=d.labelRaw;}if(d.children){this.preFormatSuggestions(d.children);}}},formatSinaSuggestions:function(c){this.preFormatSuggestions(c);for(var i=0;i<c.length;++i){var d=c[i];if(!d.labelRaw){continue;}if(this.suggestionTermBuffer.hasTerm(d.key)){continue;}var n=this.numberSuggestionsByType[d.type];var l=b[d.type].limit;if(n>=l){continue;}switch(d.type){case s.SuggestionType.DATASOURCE:if(!this.model.getDataSource().equals(this.model.allDataSource)){continue;}d.label='<i>'+sap.ushell.resources.i18n.getText("searchInPlaceholder",[""])+'</i> '+d.label;this.addSuggestion(d);break;case s.SuggestionType.OBJECTDATA:this.formatObjectDataSuggestion(d);break;case s.SuggestionType.HISTORY:d.label=d.label;this.addSuggestion(d);break;default:break;}}return this.suggestions;},addSuggestion:function(c){this.suggestions.push(c);this.suggestionTermBuffer.addTerm(c.key);this.numberSuggestionsByType[c.type]+=1;},formatObjectDataSuggestion:function(c){if(this.model.getDataSource().equals(this.model.allDataSource)){if(this.firstObjectDataSuggestion&&c.children.length>0){this.firstObjectDataSuggestion=false;c.label=this.assembleSearchInSuggestionLabel(c);this.addSuggestion(c);this.addChildSuggestions(c);}else{this.addSuggestion(c);}}else{this.addSuggestion(c);}},addChildSuggestions:function(c){if(!c.children){return;}var l=Math.min(c.children.length,b[s.SuggestionType.OBJECTDATA].limitDataSource,b[s.SuggestionType.OBJECTDATA].limit-1);for(var i=0;i<l;++i){var d=c.children[i];this.numberObjectDataSuggestions++;d.label=this.assembleSearchInSuggestionLabel(d);d.position=b[s.SuggestionType.OBJECTDATA].position;this.addSuggestion(d);}},assembleSearchInSuggestionLabel:function(c){return sap.ushell.resources.i18n.getText("resultsIn",['<span>'+c.label+'</span>',c.dataSource.labelPlural]);}});return m;});
