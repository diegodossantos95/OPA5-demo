// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.adapters.cdm.LaunchPageAdapter");jQuery.sap.require("sap.ushell.resources");jQuery.sap.require("sap.m.Text");jQuery.sap.require("sap.m.GenericTile");jQuery.sap.require("sap.m.GenericTileMode");jQuery.sap.require("sap.ushell.utils.utilsCdm");sap.ushell.adapters.cdm.LaunchPageAdapter=function(u,p,a){var _;this._mResolvedTiles={};this._mResolvedCatalogTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};this.TileType={Tile:"tile",Link:"link"};this.getGroups=function(){var D=new jQuery.Deferred();this._assureLoaded().done(function(G){D.resolve(G);}).fail(function(){D.resolve([]);});return D.promise();};this._getTileFromHashInContextOfSite=function(r,C,I){var D=new jQuery.Deferred(),o=C[I];if(!o){o=r(I);C[I]=o;}o.done(function(T){var e={tileIntent:I,tileResolutionResult:T};D.resolve(e);}).fail(function(e){D.reject("Hash '"+I+"' could not be resolved to a tile. "+e);});return D.promise();};this._getTileFromHash=function(I){var C=sap.ushell.Container.getService("ClientSideTargetResolution");var r=C.resolveTileIntent.bind(C);return this._getTileFromHashInContextOfSite(r,this._mCatalogTilePromises,I);};this._getTileFromHashFromSite=function(s,I){var C=sap.ushell.Container.getService("ClientSideTargetResolution");var e=sap.ushell.utils.utilsCdm.formatSite(s);var r=C.resolveTileIntentInContext.bind(C,e);var o={};return this._getTileFromHashInContextOfSite(r,o,I);};this._getTileForUrl=function(T){var s=T.indicatorDataSource?"#Shell-dynamicTile":"#Shell-staticTile";return{tileIntent:"#",tileResolutionResult:{tileComponentLoadInfo:s,isCustomTile:false}};};this._assureGroupItemsResolved=function(G){var P=[],r,R;if(G.payload&&G.payload.tiles){r=this._assureGroupTilesResolved(G.payload.tiles);Array.prototype.push.apply(P,r);}if(G.payload&&G.payload.links){R=this._assureGroupLinksResolved(G.payload.links,G.identification.id);Array.prototype.push.apply(P,R);}return P;};this._assureGroupTilesResolved=function(G){return(G||[]).map(function(T,I){return this._getResolvedTile(T,I).then(function(r){r.isLink=false;return r;});},this);};this._assureGroupLinksResolved=function(G,s){return(G||[]).map(function(L,I){return this._getResolvedTile(L,I).then(function(r){r.isLink=true;return r;});},this);};this._prepareTileHash=function(T){var U=sap.ushell.Container.getService("URLParsing"),P={},o,r;if(this._isCatalogTile(T)){return T.tileIntent;}if(this._isGroupTile(T)){r=T.target.parameters||[];r.forEach(function(e){if(e.name&&e.value){P[e.name]=[e.value];}});o={target:{semanticObject:T.target.semanticObject,action:T.target.action},params:P,appSpecificRoute:T.target.appSpecificRoute};return"#"+U.constructShellHash(o);}return undefined;};this._allPromisesDone=function(P){var D=new jQuery.Deferred(),o;if(P.length===0){D.resolve([]);}else{var n=P.map(function(e){o=new jQuery.Deferred();e.always(o.resolve.bind(o));return o.promise();});jQuery.when.apply(this,n).done(function(){var A=Array.prototype.slice.call(arguments);D.resolve(A);});}return D.promise();};this._generateDefaultGroup=function(){var G,o,D=new jQuery.Deferred(),C=sap.ushell.Container.getService("CommonDataModel");C.getSite().done(function(s){G=sap.ushell.utils.generateUniqueId(s.site.payload.groupsOrder);o={"identification":{"id":G,"namespace":"","title":"Home"},"payload":{"isDefaultGroup":true,"locked":false,"tiles":[],"links":[],"groups":[]}};_=o;s.groups[G]=o;s.site.payload.groupsOrder.unshift(G);D.resolve(o);}).fail(function(e){D.reject("Failed to access site. "+e);});return D.promise();};this._assureLoaded=function(){var e=this,C=sap.ushell.Container.getService("CommonDataModel"),D,L=[],o;if(this._assureLoadedDeferred){return this._assureLoadedDeferred.promise();}o=new jQuery.Deferred();this._assureLoadedDeferred=o;C.getSite().done(function(s){var I=[];s.site.payload.groupsOrder.forEach(function(G,m){var n=s.groups[G];if(n){n.payload=n.payload||{};if(n.payload.hasOwnProperty("isDefaultGroup")){_=n;}L.push(n);I=e._assureGroupItemsResolved(n).concat(I);}});if(_===undefined){D=e._generateDefaultGroup();I.push(D);D.done(function(G){L.unshift(G);}).fail(function(E){jQuery.sap.log.error("Delivering hompage groups failed - "+E);e._assureLoadedDeferred.resolve([]);});}e._allPromisesDone(I).done(function(){e._assureLoadedDeferred.resolve(L);delete e._assureLoadedDeferred;});}).fail(function(E){jQuery.sap.log.error("Delivering hompage groups failed - "+E);e._assureLoadedDeferred.resolve([]);delete e._assureLoadedDeferred;});return o.promise();};this.getDefaultGroup=function(){var D=new jQuery.Deferred(),A;if(!_){A=this._assureLoaded();}if(A){A.done(function(){D.resolve(_);}).fail(function(m){D.reject("Failed to access default group. "+m);});}else{D.resolve(_);}return D.promise();};this._isValidTitle=function(T){if(typeof T!=='string'||!T){return false;}return true;};this._isGroupPreset=function(G){if(!G.payload.hasOwnProperty("isPreset")){return true;}return!!G.payload.isPreset;};this._isGroupLocked=function(G){return!!G.payload.locked;};this.addGroup=function(T){var D=new jQuery.Deferred(),C=sap.ushell.Container.getService("CommonDataModel"),G,s,e,m=this;if(!this._isValidTitle(T)){return D.reject("No valid group title").promise();}e="Failed to add the group with title '"+T+"' to the homepage. ";C.getSite().done(function(S){s=sap.ushell.utils.generateUniqueId(S.site.payload.groupsOrder);G={"identification":{"id":s,"namespace":"","title":T},"payload":{"locked":false,"isPreset":false,"tiles":[],"links":[],"groups":[]}};S.groups[s]=G;S.site.payload.groupsOrder.push(G.identification.id);C.save().done(function(){delete m._assureLoadedDeferred;D.resolve(S.groups[s],s);}).fail(function(E){D.reject(E);});}).fail(function(E){D.reject(e+E);});return D.promise();};this.getGroupTitle=function(G){return G.identification.title;};this.setGroupTitle=function(G,n){var e=this,D=new jQuery.Deferred(),C=sap.ushell.Container.getService("CommonDataModel"),o,s;if(typeof G!=='object'||!G.identification||!G.identification.id){return D.reject("Unexpected group value").promise();}if(!e._isValidTitle(n)){return D.reject("Unexpected oGroup title value").promise();}s="Failed to set new title for group with id '"+G.identification.id+"'. ";o=G.identification.title;C.getSite().done(function(S){if(S.groups[G.identification.id]){S.groups[G.identification.id].identification.title=n;}C.save().done(function(){D.resolve();}).fail(function(E){jQuery.sap.log.error(E);D.reject(o);});}).fail(function(E){D.reject(o,s+E);});return D.promise();};this.getGroupId=function(G){return G.identification.id;};this.hideGroups=function(H){var D=new jQuery.Deferred(),C=sap.ushell.Container.getService("CommonDataModel"),G;if(H&&jQuery.isArray(H)){G="Failed to hide group. ";C.getSite().done(function(s){if(H.length>0){Object.keys(s.groups).forEach(function(e){if(jQuery.inArray(s.groups[e].identification.id,H)>-1){s.groups[e].identification.isVisible=false;}else{delete s.groups[e].identification.isVisible;}});}if(H.length===0){Object.keys(s.groups).forEach(function(e){delete s.groups[e].identification.isVisible;});}C.save().done(function(){D.resolve();}).fail(function(e){D.reject("Hiding of groups did not work as expected - "+e);});}).fail(function(e){D.reject(G+e);});}else{D.reject("Invalid input parameter aHiddenGroupIds. Please pass a valid input parameter.");}return D.promise();};this.isGroupVisible=function(G){if(G.identification.isVisible===undefined||G.identification.isVisible===true){return true;}else{return false;}};this.moveGroup=function(G,n){var D=new jQuery.Deferred(),C=sap.ushell.Container.getService("CommonDataModel"),e,s;if(!G||!G.identification||!G.identification.id||n<0){return D.reject("Unable to move groups - invalid parameters").promise();}s="Failed to move group with id '"+G.identification.id+"'. ";C.getSite().done(function(S){if(!S.site.payload.groupsOrder){return D.reject("groupsOrder not found - abort operation of adding a group.");}else if(S.site.payload.groupsOrder.indexOf(G.identification.id)===n){return D.resolve();}e=sap.ushell.utils.moveElementInsideOfArray(S.site.payload.groupsOrder,S.site.payload.groupsOrder.indexOf(G.identification.id),n);if(!e){return D.reject("invalid move group operation - abort.");}C.save().done(function(){D.resolve();}).fail(function(E){D.reject(E);});}).fail(function(E){D.reject(s+E);});return D.promise();};this.removeGroup=function(G){var D=new jQuery.Deferred(),C=sap.ushell.Container.getService("CommonDataModel"),s;if(!G||typeof G!=="object"||!G.identification||!G.identification.id){return D.reject("no valid input parameter for 'oGroup'").promise();}s="Failed to remove group with id '"+G.identification.id+"'. ";C.getSite().done(function(S){if(S&&S.groups&&S.groups[G.identification.id]){delete S.groups[G.identification.id];}if(S&&S.site&&S.site.payload&&S.site.payload.groupsOrder){S.site.payload.groupsOrder=jQuery.grep(S.site.payload.groupsOrder,function(e){return e!==G.identification.id;});}C.save().done(function(){D.resolve();}).fail(function(e){D.reject(e);});}).fail(function(e){D.reject(s+e);});return D.promise();};this.resetGroup=function(G){var D=new jQuery.Deferred(),C=sap.ushell.Container.getService("CommonDataModel"),s={},e=this,m;if(G&&typeof G==="object"&&G.identification&&G.identification.id){m="Failed to reset group with id '"+G.identification.id+"'. ";C.getSite().done(function(S){jQuery.extend(true,s,S.groups);if(e.isGroupRemovable(G)===false){C.getGroupFromOriginalSite(G.identification.id).done(function(o){if(S&&typeof S==="object"&&S.groups&&S.groups[G.identification.id]){S.groups[G.identification.id]=o;}C.save().done(function(){D.resolve(o);}).fail(function(E){D.reject("Group could not be reset - "+E,s);});}).fail(function(E){D.reject("Group could not be reset - "+E,s);});}else{D.reject("Group could not be reset as it was created by the user",s);}}).fail(function(E){D.reject(m+E,s);});}return D.promise();};this.getTileTitle=function(T){var r;if(T&&T.isBookmark){return T.title;}r=this._mResolvedTiles[T.id];if(r){return T.title||r.tileResolutionResult.title;}else{return"";}};this.getTileSubtitle=function(T){var r;if(T.isBookmark){return T.subTitle;}r=this._mResolvedTiles[T.id];return T.subTitle||r.tileResolutionResult.subTitle;};this.getTileIcon=function(T){var r;if(T.isBookmark){return T.icon;}r=this._mResolvedTiles[T.id];return T.icon||r.tileResolutionResult.icon;};this.getTileInfo=function(T){var r;if(T.isBookmark){return T.info;}r=this._mResolvedTiles[T.id];return T.info||r.tileResolutionResult.info;};this.getTileIndicatorDataSource=function(T){var r=this._mResolvedTiles[T.id];var R={};var o;if(T.indicatorDataSource){R.indicatorDataSource=T.indicatorDataSource;if(T.dataSource){R.dataSource=T.dataSource;}return R;}if(r){o=r.tileResolutionResult;if(o.indicatorDataSource){R.indicatorDataSource=o.indicatorDataSource;}if(o.dataSource){R.dataSource=o.dataSource;}}return R;};this.isGroupRemovable=function(G){return!this._isGroupPreset(G);};this.isGroupLocked=function(G){return this._isGroupLocked(G);};this.getGroupTiles=function(G){var T=G.payload.tiles||[];if(G.payload.links&&jQuery.isArray(G.payload.links)&&G.payload.links.length>0){T=T.concat(G.payload.links);}return T;};this.getLinkTiles=function(G){if(G.payload.links&&jQuery.isArray(G.payload.links)&&G.payload.links.length>0){return G.payload.links;}else{return[];}};this.getTileType=function(T){var r=this._mResolvedTiles[T.id];if(r&&r.isLink){return this.TileType.Link;}return this.TileType.Tile;};this.getTileId=function(T){return T.id;};this.getTileSize=function(T){var r=this._mResolvedTiles[T.id];if(r&&r.tileResolutionResult&&r.tileResolutionResult.size){return r.tileResolutionResult.size;}return"1x1";};this.getTileTarget=function(T){var r,R=this._mResolvedTiles[T.id],s;if(T.target&&T.target.url){return T.target.url;}if(R&&R.tileResolutionResult){r=R.tileResolutionResult;if(r.isCustomTile!==true){return R.tileIntent;}if(r&&typeof r.targetOutbound==="object"){s=this._toHashFromOutbound(r.targetOutbound);if(s){return s;}}}jQuery.sap.log.warning("Could not find a target for Tile with id '"+T.id+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return"";};this.isLinkPersonalizationSupported=function(T){return true;};this.isTileIntentSupported=function(T){return(this._mFailedResolvedTiles[T.id]===undefined)?true:false;};this.refreshTile=function(T){};this.setTileVisible=function(T,n){var r=this._mResolvedTiles[T.id];if(r&&r.tileComponent&&typeof r.tileComponent.tileSetVisible==="function"){if(r.visibility!==n){r.visibility=n;r.tileComponent.tileSetVisible(n);}}};this.getTileView=function(G){var A=this;return new jQuery.Deferred(function(D){return A._getTileView(G,false).then(function(T){if(!T){D.reject("Tile view or component could not be initialized");}D.resolve(T);},function(r){var e="Tile with ID '"+G.id+"' could not be initialized"+(r?":\n"+r:".");jQuery.sap.log.error(e,null,G.tileType);D.reject(e);});}).promise();};this._getResolvedTile=function(T,I){var H;var s=this._mResolvedTiles;var F=this._mFailedResolvedTiles;function e(r){s[T.id]=r;if(F[T.id]){delete F[T.id];}return r;}if(s[T.id]){return(new jQuery.Deferred()).resolve(s[T.id]).promise();}if(T.target&&T.target.url){return new jQuery.Deferred().resolve(e(this._getTileForUrl(T))).promise();}H=this._prepareTileHash(T,I);return this._getTileFromHash(H).then(e,function(E){F[T.id]=E;return E;});};this._getTileUiComponentContainer=function(T,r,I){var e=this,s,m,R,C,n,o,N,q,v={};if(I===true){o=e._createTileComponentData(T,true,r);}else{o=e._createTileComponentData(T,false,r);}R=r.tileResolutionResult;if(r.isLink){N=R.navigationMode;return e._createLinkInstance(T,I,N);}if(typeof R.tileComponentLoadInfo==="string"){if(o.properties.indicatorDataSource&&o.properties.indicatorDataSource.path){v.name="sap.ushell.components.tiles.cdm.applauncherdynamic";}else{v.name="sap.ushell.components.tiles.cdm.applauncher";}}else if(typeof R.tileComponentLoadInfo==="object"&&R.tileComponentLoadInfo!==null){v=R.tileComponentLoadInfo.componentProperties||{};v.name=R.tileComponentLoadInfo.componentName;}v.componentData=o;if(v.name){q=sap.ui.component(v);var w=new sap.ui.core.ComponentContainer({component:q,height:'100%'});if(I===true){e._mResolvedCatalogTiles[T.id].tileComponent=q;}else{e._mResolvedTiles[T.id].tileComponent=q;}return w;}return null;};this._getTileView=function(G){var e=this,T,s,o,E,D=new jQuery.Deferred();if(typeof G!=="object"||!G.id){E="Invalid input parameter passed to _getTileView: "+G;jQuery.sap.log.error(E);return D.reject(E).promise();}s=this._prepareTileHash(G);T=(G.id&&this._mResolvedTiles[G.id])||this._getTileFromHash(s);jQuery.when(T).then(function(r){if(e._mResolvedTiles.hasOwnProperty(G.id)===false){e._mResolvedTiles[G.id]=r;}try{o=e._getTileUiComponentContainer(G,r,false);}catch(m){D.reject(m.message);}D.resolve(o);});return D.promise();};this._getCatalogTileView=function(C){if(typeof C!=="object"){throw new Error(C);}return this._getTileUiComponentContainer(C,C,true);};this._createTileComponentData=function(T,I,r){var s=I?this.getCatalogTileTitle(T):this.getTileTitle(T),S=I?this.getCatalogTilePreviewSubtitle(T):this.getTileSubtitle(T),e=I?this.getCatalogTilePreviewIcon(T):this.getTileIcon(T),m=I?this.getCatalogTilePreviewInfo(T):this.getTileInfo(T),n=I?this.getCatalogTileTargetURL(T):this.getTileTarget(T),o=this.getTileIndicatorDataSource(T),C={properties:{},startupParameters:{}};if(r.tileResolutionResult.isCustomTile===true&&r.tileResolutionResult.startupParameters){C.startupParameters=r.tileResolutionResult.startupParameters;}if(s){C.properties.title=s;}if(m){C.properties.info=m;}if(S){C.properties.subtitle=S;}if(e){C.properties.icon=e;}if(n){C.properties.targetURL=n;}if(o.indicatorDataSource){C.properties.indicatorDataSource=o.indicatorDataSource;if(o.dataSource){C.properties.dataSource=o.dataSource;}}if(r.tileResolutionResult){C.properties.navigationMode=r.tileResolutionResult.navigationMode;}return C;};this._createLinkInstance=function(T,I,n){var s,e,m,o=this.getTileSubtitle(T);if(I===true){s=this.getCatalogTileTitle(T);}else{s=this.getTileTitle(T);}e=new sap.m.GenericTile({mode:sap.m.GenericTileMode.LineMode,subheader:o,header:s,press:function(E){this._genericTilePressHandler(T,E);}.bind(this)});if(n){m=sap.ushell.resources.i18n.getText(n+"NavigationMode");e.setAriaLabel(m+" "+s+" "+o);}this._mResolvedTiles[T.id].linkTileControl=e;return e;};this._genericTilePressHandler=function(T,e){var s;if(e.getSource().getScope&&e.getSource().getScope()==="Display"){s=this.getTileTarget(T);if(s){if(s[0]==='#'){hasher.setHash(s);}else{window.open(s,'_blank');}}}};this._addTileToSite=function(P,G,n,C){var e=this,D=new jQuery.Deferred(),I=sap.ushell.Container.getService("URLParsing").parseShellHash(n.properties.targetURL),T={"id":e.getTileId(n),"target":{"semanticObject":I.semanticObject,"action":I.action,"parameters":l(I.params)}};P.groups[G.identification.id].payload.tiles.push(T);C.save().done(function(){D.resolve(T);}).fail(function(m){D.reject(m);});return D.promise();};this.addTile=function(C,G){if(!G){G=_;}var D=new jQuery.Deferred(),e=this,s;if(C.contentProviderId){if(C.externalUrl){return this.addBookmark(this._getBookmarkDataForExtensionCatalogTile(C),G);}return D.reject("Extension Tile without URL").promise();}var H=e.getCatalogTileTargetURL(C);var U=sap.ushell.Container.getService("URLParsing");var I=U.parseShellHash(H);var T=d({},k(I));s="Failed to add tile with id '"+T.id+"' to group with id '"+G.identification.id+"'. ";e._getTileFromHash(H).fail(function(E){e._mFailedResolvedTiles[T.id]=E;}).done(function(n){e._mResolvedTiles[T.id]=n;var o=sap.ushell.Container.getService("CommonDataModel");o.getSite().done(function(S){S.groups[G.identification.id].payload.tiles.push(T);o.save().done(function(){D.resolve(T);}).fail(function(r){D.reject(r);});}).fail(function(E){D.reject(s+E);});});return D.promise();};this._getBookmarkDataForExtensionCatalogTile=function(e){var B={title:e.tileResolutionResult.title,subtitle:e.tileResolutionResult.subTitle,icon:e.tileResolutionResult.icon,info:e.tileResolutionResult.info,url:e.externalUrl};if(e.tileResolutionResult.indicatorDataSource&&e.tileResolutionResult.indicatorDataSource.path){B.serviceUrl=e.tileResolutionResult.indicatorDataSource.path;B.serviceRefreshInterval=e.tileResolutionResult.indicatorDataSource.refresh;}return B;};this.removeTile=function(G,T,I){var C,s,D=new jQuery.Deferred(),m=this;if(!G||typeof G!=="object"||!G.identification||!G.identification.id||!T||typeof T!=="object"||!T.id){return D.reject({},"Failed to remove tile. No valid input parameters passed to removeTile method.").promise();}s="Failed to remove tile with id '"+T.id+"' from group with id '"+G.identification.id+"'. ";C=sap.ushell.Container.getService("CommonDataModel");C.getSite().done(function(S){var P,n;I=+I;try{P=S.groups[G.identification.id].payload;}catch(e){D.reject(S.groups[G.identification.id],s);}n=m.getTileType(T)===m.TileType.Link?"links":"tiles";if(m.getTileType(T)===m.TileType.Link){I-=P.tiles.length;}if(I>=0){P[n].splice(I,1);}else{P[n]=P[n].filter(function(o){return o.id!==T.id;});}C.save().done(function(){D.resolve();}).fail(function(E){jQuery.sap.log.error(E);D.reject(S.groups[G.identification.id],E);});}).fail(function(e){D.reject({},s+e);});return D.promise();};this.moveTile=function(T,s,e,S,o,n){var D=new jQuery.Deferred(),C=sap.ushell.Container.getService("CommonDataModel"),m=this,G;if(!T||jQuery.isEmptyObject(T)||s===undefined||s<0||e===undefined||e<0||!S||!S.identification||!S.identification.id||!o||!o.identification||!o.identification.id){return D.reject("Invalid input parameters").promise();}G="Failed to move tile with id '"+T.id+"'. ";C.getSite().done(function(q){var r,v,O=m.getTileType(T)===m.TileType.Link?"links":"tiles";if(!n){n=m._mResolvedTiles[T.id].isLink?"link":"tile";}r=n==="link"?"links":"tiles";if(O!=r&&m._mResolvedTiles[T.id]){m._mResolvedTiles[T.id].isLink=n==="link";}if(r==="links"){e-=q.groups[o.identification.id].payload.tiles.length;}if(O==="links"){s-=q.groups[S.identification.id].payload.tiles.length;}if(S.identification.id===o.identification.id){if(s!==e||O!=r){v=q.groups[o.identification.id].payload;if(O==="tiles"){e++;}v[O].splice(s,1);v[r].splice(e,0,T);}else{return D.resolve(T).promise();}}else{q.groups[S.identification.id].payload[O].splice(s,1);q.groups[o.identification.id].payload[r].splice(e,0,T);}C.save().done(function(){D.resolve(T);}).fail(function(E){jQuery.sap.log.error(E);C.getSite().done(function(w){D.reject(w.groups,E);}).fail(function(w){jQuery.sap.log.error(w);D.reject([],w);});});}).fail(function(E){D.reject([],G+E);});return D.promise();};this._compareCatalogs=function(A,B){if(A.identification.id>B.identification.id){return 1;}return-1;};this.getCatalogs=function(){var e=this,D=new jQuery.Deferred(),C=[],o=sap.ushell.Container.getService("CommonDataModel");function m(n,s,C,G,P,q){var r=n.catalogs[s];r.id=s;if(P&&q){r.contentProviderId=P;q.catalogsMap[s]=r;}C.push(r);G.notify(r);}window.setTimeout(function(){o.getSite().done(function(s){Object.keys(s.catalogs).forEach(function(n){m(s,n,C,D);});o.getExtensionSites().progress(function(L){var P=L.providerId;var E=L.site;var n=Promise.resolve(E);var q={sitePromise:n,site:E,catalogsMap:{}};Object.keys(E.catalogs).forEach(function(r){e._mContentProviders[P]=q;m(E,r,C,D,P,q);});}).done(function(L){L.filter(function(n){return!n.success;}).forEach(function(F,I){C.push({identification:{id:F.providerId},contentProviderId:F.providerId,error:"The following content providers could not provide catalogs: "+F.providerId+(F.error?" -> "+F.error:"")});});D.resolve(C.sort(e._compareCatalogs));});});},0);return D.promise();};this._isStartableInbound=function(I){if(!jQuery.sap.getObject("signature.parameters",undefined,I)){return true;}var r=Object.keys(I.signature.parameters).every(function(p){return!I.signature.parameters[p].filter||(p==="sap-external-url");});return r;};this._isHiddenInbound=function(I){return!!I.hideLauncher;};this._toHashFromInbound=function(I){var s,P,C;s={target:{semanticObject:I.semanticObject,action:I.action},params:{}};P=jQuery.sap.getObject("signature.parameters",undefined,I)||{};Object.keys(P).forEach(function(K){if(P[K].filter&&Object.prototype.hasOwnProperty.call(P[K].filter,"value")&&(P[K].filter.format===undefined||P[K].filter.format==="plain")){s.params[K]=[P[K].filter.value];}if(P[K].launcherValue&&Object.prototype.hasOwnProperty.call(P[K].launcherValue,"value")&&(P[K].launcherValue.format===undefined||P[K].launcherValue.format==="plain")){s.params[K]=[P[K].launcherValue.value];}});C=sap.ushell.Container.getService("URLParsing").constructShellHash(s);if(!C){return undefined;}return"#"+C;};this._getExternalUrlFromInbound=function(I){return jQuery.sap.getObject("signature.parameters.sap-external-url.launcherValue.value",undefined,I)||null;};this._toHashFromOutbound=function(o){var s,P,C;s={target:{semanticObject:o.semanticObject,action:o.action},params:{}};P=o.parameters||{};Object.keys(P).forEach(function(K){if(P.hasOwnProperty(K)&&typeof P[K].value==="object"){s.params[K]=[P[K].value.value];}});C=sap.ushell.Container.getService("URLParsing").constructShellHash(s);if(!C){return undefined;}return"#"+C;};this._isCustomTile=function(A){if(sap.ushell.utils.getMember(A,"sap|flp.type")==="tile"){return true;}return false;};this.getCatalogTiles=function(C){var e=this,D=new jQuery.Deferred();if(typeof C!=="object"||C===null){return D.reject("Invalid input parameter '"+C+"' passed to getCatalogTiles.").promise();}if(C.contentProviderId&&this._mContentProviders[C.contentProviderId]){this._mContentProviders[C.contentProviderId].sitePromise.then(function(s){b.call(e,C,s).done(D.resolve).fail(D.reject);},function(E){D.reject("Failed to get site: "+E);});}else{sap.ushell.Container.getService("CommonDataModel").getSite().done(function(s){b.call(e,C,s).done(D.resolve).fail(D.reject);}).fail(function(E){D.reject("Failed to get site: "+E);});}return D.promise();};function g(I){return Object.keys(I).map(function(K){var o=I[K];return{intent:o.semanticObject+"-"+o.action,inbound:o};}).sort(function(o,e){if(o.intent===e.intent){return 0;}return o.intent<e.intent?-1:1;}).reduce(function(U,o){var e=U.length;if(e===0){U.push(o);return U;}if(U[e-1].intent!==o.intent){U.push(o);return U;}return U;},[]).map(function(o){return o.inbound;});}function b(C,s){var e=this,D=new jQuery.Deferred(),m=[],T;C.payload=C.payload||{};(C.payload.appDescriptors||[]).forEach(function(A){var o=s.applications[A.id];var I=e._getMember(o,"sap|app.crossNavigation.inbounds")||{};var U=g(I);var r=U.filter(function(n){return e._isStartableInbound(n)&&!e._isHiddenInbound(n);}).map(function(n){var q=e._toHashFromInbound(n,o);if(e._mResolvedCatalogTiles[q]||e._mFailedResolvedCatalogTiles[q]){if(e._mResolvedCatalogTiles.hasOwnProperty(q)){return new jQuery.Deferred().resolve(e._mResolvedCatalogTiles[q]).promise();}jQuery.sap.log.error(e._mFailedResolvedCatalogTiles[q],"sap.ushell.adapters.cdm.LaunchPageAdapter");return new jQuery.Deferred().reject(e._mFailedResolvedCatalogTiles[q]).promise();}if(C.contentProviderId){T=e._getTileFromHashFromSite(s,q);}else{T=e._getTileFromHash(q);}return T.done(function(R){var E;R.id=q;if(C.contentProviderId){R.contentProviderId=C.contentProviderId;E=e._getExternalUrlFromInbound(n);if(E){R.id=E;R.externalUrl=E;e._mResolvedCatalogTiles[R.id]=R;}}e._mResolvedCatalogTiles[q]=R;}).fail(function(E){jQuery.sap.log.error(E,"sap.ushell.adapters.cdm.LaunchPageAdapter");e._mFailedResolvedCatalogTiles[q]=E;});});m=m.concat(r);});e._allPromisesDone(m).done(function(n){var S=n.filter(function(v){return typeof v!=="string";});D.resolve(S);}).fail(function(E){if(C.identification&&C.identification.id){D.reject("Failed to deliver tiles for catalog '"+C.identification.id+"'. "+E);}});return D.promise();}this.getCatalogError=function(C){if(C.error){return C.error;}return;};this.getCatalogId=function(C){return C.identification.id;};this.getCatalogTitle=function(C){return C.identification.title;};this._isGroupTile=function(T){return!!(T&&T.id&&T.target);};this._isCatalogTile=function(T){return!!(T&&T.id&&T.tileIntent&&T.tileResolutionResult);};this._isFailedGroupTile=function(T){return!!(T&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[T.id]);};this._isFailedCatalogTile=function(T){return!!(T&&this._mFailedResolvedCatalogTiles&&this._mFailedResolvedCatalogTiles[T.id]);};this.getCatalogTileId=function(G){if(this._isGroupTile(G)){if(this._isFailedGroupTile(G)){return undefined;}if(G.isBookmark&&jQuery.sap.getObject("target.url",undefined,G)){return G.target.url;}return(this._mResolvedTiles[G.id]||{}).tileIntent;}if(this._isCatalogTile(G)){return G.id;}};this.getCatalogTileTitle=function(G){if(this._isGroupTile(G)){if(this._isFailedGroupTile(G)){return"";}return this._mResolvedTiles[G.id].tileResolutionResult.title;}if(this._isCatalogTile(G)){if(this._isFailedCatalogTile(G)){return undefined;}return G.tileResolutionResult.title;}};this.getCatalogTileSize=function(C){return this.getTileSize(C);};this.getCatalogTileView=function(C){return this._getCatalogTileView(C);};this.getCatalogTileTargetURL=function(G){if(!G){throw new Error("The given tile is falsy");}return this.getCatalogTileId(G);};this.getCatalogTilePreviewTitle=function(G){if(this._isGroupTile(G)){return this.getTileTitle(G);}return(G.tileResolutionResult&&G.tileResolutionResult.title)||"";};this.getCatalogTilePreviewSubtitle=function(G){if(this._isGroupTile(G)){return this.getTileSubtitle(G);}return(G.tileResolutionResult&&G.tileResolutionResult.subTitle)||"";};this.getCatalogTilePreviewIcon=function(G){if(this._isGroupTile(G)){return this.getTileIcon(G);}return(G.tileResolutionResult&&G.tileResolutionResult.icon)||"";};this.getCatalogTilePreviewInfo=function(G){if(this._isGroupTile(G)){return this.getTileInfo(G);}return(G.tileResolutionResult&&G.tileResolutionResult.info)||"";};this.getCatalogTileKeywords=function(G){var K=[],r=G;if(!r){jQuery.sap.log.error("Could not find the Tile","sap.ushell.adapters.cdm.LaunchPageAdapter");return K;}if(this._mResolvedTiles&&this._mResolvedTiles[G.id]){r=this._mResolvedTiles[G.id];}if(r&&r.tileResolutionResult&&r.tileResolutionResult.title){K.push(r.tileResolutionResult.title);}if(r&&r.tileResolutionResult&&r.tileResolutionResult.subTitle){K.push(r.tileResolutionResult.subTitle);}return K;};this._visitBookmarks=function(U,v){var C=sap.ushell.Container;var o=C.getService("URLParsing");var e=C.getService("CommonDataModel");var r;var I=o.parseShellHash(U);if(I){r=k(I);}else{r=j(U);}return e.getSite().then(function(s){var G=s.groups;var T=Object.keys(G).filter(function(K){return!G[K].payload.locked;}).map(function(K){return G[K].payload.tiles.filter(function(m){return m.isBookmark&&i(r,m.target);});}).reduce(function(A,m){Array.prototype.push.apply(A,m);return A;},[]);if(!v){return T.length;}return jQuery.when(T.map(v)).then(function(){return T.length;});});};this.addBookmark=function(P,G){var T=this;return new jQuery.Deferred(function(D){var C=sap.ushell.Container;var U=C.getService("URLParsing");var o=C.getService("CommonDataModel");jQuery.when(G||T.getDefaultGroup(),o.getSite()).done(function(G,s){var e,m,I=U.parseShellHash(P.url),n,r,q=false;if(!I){m=j(P.url);q=true;}else{m=k(I);}e=c(P,m);if(q){r=new jQuery.Deferred();r.resolve(T._getTileForUrl(e));}else{r=T._getTileFromHash(P.url);}r.done(function(n){n.isLink=false;T._mResolvedTiles[e.id]=n;s.groups[G.identification.id].payload.tiles.push(e);o.save().done(function(){D.resolve(e);}).fail(function(R){D.reject(R);});}).fail(function(E){D.reject("Bookmark creation failed because: "+E);});}).fail(function(r){D.reject(r);});}).promise();};this.countBookmarks=function(U){return this._visitBookmarks(U);};this.updateBookmarks=function(U,P){var C=sap.ushell.Container;var o=C.getService("URLParsing");var e=C.getService("CommonDataModel");var r=this._mResolvedTiles;function m(T){return new jQuery.Deferred(function(D){var I,n;var q;var s=false;var v={};if(P.url||P.url===""){I=o.parseShellHash(P.url);if(!I){n=j(P.url);}else{n=k(I);}}if(T.icon!==P.icon){v.icon=P.icon;s=true;}if(T.title!==P.title){v.title=P.title;s=true;}if(T.subTitle!==P.subtitle){v.subtitle=P.subtitle;s=true;}if(P.url&&U!==P.url){v.targetURL=P.url;s=true;}if(T.info!==P.info){v.info=P.info;s=true;}f(T,P,n);if(s&&r[T.id]){q=r[T.id].tileComponent;q.tileSetVisualProperties(v);}D.resolve(T);}).promise();}return this._visitBookmarks(U,m).then(function(n){return e.save().then(function(){return n;});});};this.deleteBookmarks=function(U){var C=sap.ushell.Container;var o=C.getService("URLParsing");var e=C.getService("CommonDataModel");var I=o.parseShellHash(U);var r;if(I){r=k(I);}else{r=j(U);}return e.getSite().then(function(s){var G=s.groups;var D=Object.keys(G).map(function(K){var P=G[K].payload;var m=0;P.tiles=P.tiles.filter(function(T){if(T.isBookmark&&i(r,T.target)){++m;return false;}return true;});return m;}).reduce(function(m,n){m+=n;return m;},0);return e.save().then(function(){return D;});});};this.onCatalogTileAdded=function(T){};this._onTileSettingsSave=function(T,s){var D=new jQuery.Deferred(),C,U,n,N,e,o,O,m;if(T&&T.id&&s){n=s.oTitleInput.getValue();e=s.oSubTitleInput.getValue();N=s.oInfoInput.getValue();o=this.getTileTitle(T);O=this.getTileInfo(T);m=this.getTileSubtitle(T);if(o===n&&m===e&&O===N){return;}C=sap.ushell.Container.getService("CommonDataModel");var q=this;C.getSite().done(function(S){if(!S.modifiedTiles){S.modifiedTiles={};}if(!S.modifiedTiles[T.id]){S.modifiedTiles[T.id]={id:T.id};}U={};if(o!==n){U.title=n;S.modifiedTiles[T.id].title=n;T.title=n;}if(m!==e){U.subtitle=e;S.modifiedTiles[T.id].subTitle=e;T.subTitle=e;}if(O!==N){U.info=N;S.modifiedTiles[T.id].info=N;T.info=N;}if(q._mResolvedTiles[T.id].tileComponent){q._mResolvedTiles[T.id].tileComponent.tileSetVisualProperties(U);}else{if(q._mResolvedTiles[T.id].linkTileControl){if(U.title){q._mResolvedTiles[T.id].linkTileControl.setHeader(U.title);}if(U.subtitle){q._mResolvedTiles[T.id].linkTileControl.setSubheader(U.subtitle);}if((U.title)||(U.subtitle)){q._mResolvedTiles[T.id].linkTileControl.rerender();}}}C.save().fail(function(E){jQuery.sap.log.error(E);D.reject("Could not save personalization changes: "+E);}).done(function(){D.resolve();});}).fail(function(E){jQuery.sap.log.error(E);D.reject("Cannot get site: "+E);});}return D.promise();};this.getTileActions=function(T){var e=[],o,m;if(this._isGroupTile(T)&&!this._isFailedGroupTile(T)){m=new sap.ui.model.json.JSONModel({config:{display_title_text:this.getTileTitle(T),display_subtitle_text:this.getTileSubtitle(T),display_info_text:this.getTileInfo(T)}});o=sap.ushell.components.tiles.utilsRT.getTileSettingsAction(m,this._onTileSettingsSave.bind(this,T),this.getTileType(T));e.push(o);}return e;};function c(P,T){var o=d(P,T);o.isBookmark=true;return o;}function d(P,T){var o={id:sap.ushell.utils.generateUniqueId([])};f(o,P,T);return o;}function f(T,P,o){P=jQuery.extend(true,{},P);if(o){T.target=o;}if(P.title||P.title===""){T.title=P.title;}if(P.icon||P.icon===""){T.icon=P.icon;}if(P.subtitle||P.subtitle===""){T.subTitle=P.subtitle;}if(P.info||P.info===""){T.info=P.info;}if(P.dataSource){T.dataSource={};jQuery.extend(true,T.dataSource,P.dataSource);delete P.serviceUrl;}else if(P.dataSource===null){delete T.dataSource;delete T.indicatorDataSource;delete P.serviceUrl;}if((P.dataSource||T.dataSource)&&P.serviceUrlPath){T.indicatorDataSource={path:P.serviceUrlPath};}if(P.serviceUrl||P.serviceUrl===""){if(T.dataSource){jQuery.sap.log.warning("`serviceUrl` is marked for deprecation in the future."+"It is not the preferred means for defining a dynamic "+"tile's data source. Please use `oParameter.dataSource`");delete T.dataSource;}T.indicatorDataSource={path:P.serviceUrl};}else if(P.serviceUrl===null&&!T.dataSource){delete T.indicatorDataSource;}if(P.serviceRefreshInterval||P.serviceRefreshInterval===0){T.indicatorDataSource.refresh=P.serviceRefreshInterval;}}function i(T,o){if(T&&o){if(T.url){return T.url===o.url;}return T.semanticObject===o.semanticObject&&T.action===o.action&&h(T.parameters,o.parameters);}return T===o;}function h(P,o){var F,O;P=P||[];o=o||[];if(P.length===o.length){F=t(P);O=t(o);return F===O;}return false;}function t(L){return L.map(function(P){return P.name+P.value;}).sort().join();}function j(U){return{url:U};}function k(I){var T={semanticObject:I.semanticObject,action:I.action,parameters:l(I.params)};if(I.appSpecificRoute){T.appSpecificRoute=I.appSpecificRoute;}return T;}function l(I){return Object.keys(I).map(function(K){var v=I[K]&&I[K][0];return{name:K,value:v||""};});}};sap.ushell.adapters.cdm.LaunchPageAdapter.prototype._getMember=function(o,a){return sap.ushell.utils.getMember(o,a);};}());
