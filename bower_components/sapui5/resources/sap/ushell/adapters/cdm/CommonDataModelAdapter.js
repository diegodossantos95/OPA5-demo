// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.adapters.cdm.CommonDataModelAdapter");sap.ushell.adapters.cdm.CommonDataModelAdapter=function(u,p,a){jQuery.sap.require("sap.ushell.adapters.cdm.ClientSideTargetResolutionAdapter");this.oAdapterConfiguration=a;if(a&&a.config&&a.config.siteData){this.oCdmSiteDataRequestPromise=new jQuery.Deferred().resolve(a.config.siteData);}else if(a&&a.config&&a.config.siteDataPromise){this.oCdmSiteDataRequestPromise=a.config.siteDataPromise;}else{if(a&&a.config){this.sCdmSiteUrl=a.config.siteDataUrl||a.config.cdmSiteUrl;}this.oCdmSiteDataRequestPromise=this._requestSiteData(this.sCdmSiteUrl);}};sap.ushell.adapters.cdm.CommonDataModelAdapter.prototype._requestSiteData=function(u){var s=new jQuery.Deferred();if(!u){s.reject("Cannot load site: configuration property 'siteDataUrl' is missing for CommonDataModelAdapter.");}else{jQuery.ajax({type:"GET",dataType:"json",url:u}).done(function(r){s.resolve(r);}).fail(function(e){jQuery.sap.log.error(e.responseText);s.reject("CDM Site was requested but could not be loaded.");});}return s.promise();};sap.ushell.adapters.cdm.CommonDataModelAdapter.prototype.getSite=function(){var d=new jQuery.Deferred();this.oCdmSiteDataRequestPromise.done(function(s){var S=jQuery.extend({},s);delete S.personalization;d.resolve(S);}).fail(function(m){d.reject(m);});return d.promise();};sap.ushell.adapters.cdm.CommonDataModelAdapter.prototype.getPersonalization=function(){var d=new jQuery.Deferred(),t=this;this.oCdmSiteDataRequestPromise.done(function(s){var S=jQuery.extend({},s);if(t.oAdapterConfiguration&&t.oAdapterConfiguration.config&&t.oAdapterConfiguration.config.ignoreSiteDataPersonalization){delete S.personalization;}if(S.personalization){d.resolve(S.personalization);}else{t._readPersonalizationDataFromStorage().done(function(p){d.resolve(p);}).fail(function(m){d.reject(m);});}}).fail(function(m){d.reject(m);});return d.promise();};sap.ushell.adapters.cdm.CommonDataModelAdapter.prototype._storePersonalizationData=function(p){var P=new jQuery.Deferred(),o=sap.ushell.Container.getService("Personalization"),c,s={keyCategory:o.constants.keyCategory.FIXED_KEY,writeFrequency:o.constants.writeFrequency.LOW,clientStorageAllowed:true},a={container:"sap.ushell.cdm.personalization",item:"data"},b=o.getPersonalizer(a,s,c);b.setPersData(p).done(function(){jQuery.sap.log.info("Personalization data has been stored successfully.");P.resolve();}).fail(function(){P.reject("Writing personalization data failed.");});return P.promise();};sap.ushell.adapters.cdm.CommonDataModelAdapter.prototype._readPersonalizationDataFromStorage=function(){var p=new jQuery.Deferred(),P=sap.ushell.Container.getService("Personalization"),c,s={keyCategory:P.constants.keyCategory.FIXED_KEY,writeFrequency:P.constants.writeFrequency.LOW,clientStorageAllowed:true},o={container:"sap.ushell.cdm.personalization",item:"data"},a=P.getPersonalizer(o,s,c);a.getPersData().done(function(b){if(!b){b={};}p.resolve(b);}).fail(function(){p.reject("Fetching personalization data failed.");});return p.promise();};}());
