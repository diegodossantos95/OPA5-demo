/*!
 * Copyright (c) 2009-2017 SAP SE, All Rights Reserved
 */
sap.ui.define(['sap/ui/core/Control','sap/ushell/library','sap/ushell/override','sap/ushell/ui/launchpad/PlusTile'],function(C,l,o,P){"use strict";var T=C.extend("sap.ushell.ui.launchpad.TileContainer",{metadata:{library:"sap.ushell",properties:{scrollType:{type:"string",group:"Misc",defaultValue:'item'},animationSpeed:{type:"int",group:"Misc",defaultValue:500},groupId:{type:"string",group:"Misc",defaultValue:null},showHeader:{type:"boolean",group:"Misc",defaultValue:true},showPlaceholder:{type:"boolean",group:"Misc",defaultValue:true},defaultGroup:{type:"boolean",group:"Misc",defaultValue:false},isLastGroup:{type:"boolean",group:"Misc",defaultValue:false},headerText:{type:"string",group:"Misc",defaultValue:null},headerLevel:{type:"sap.m.HeaderLevel",group:"Misc",defaultValue:sap.m.HeaderLevel.H2},groupHeaderLevel:{type:"sap.m.HeaderLevel",group:"Misc",defaultValue:sap.m.HeaderLevel.H4},showGroupHeader:{type:"boolean",group:"Misc",defaultValue:true},visible:{type:"boolean",group:"Misc",defaultValue:true},sortable:{type:"boolean",group:"Misc",defaultValue:true},showNoData:{type:"boolean",group:"Misc",defaultValue:false},noDataText:{type:"string",group:"Misc",defaultValue:null},isGroupLocked:{type:"boolean",group:"Misc",defaultValue:null},isGroupSelected:{type:"boolean",group:"Misc",defaultValue:false},editMode:{type:"boolean",group:"Misc",defaultValue:false},showBackground:{type:"boolean",group:"Misc",defaultValue:false},icon:{type:"string",group:"Misc",defaultValue:'sap-icon://locked'},showIcon:{type:"boolean",group:"Misc",defaultValue:false},deluminate:{type:"boolean",group:"Misc",defaultValue:false},showMobileActions:{type:"boolean",group:"Misc",defaultValue:false},enableHelp:{type:"boolean",group:"Misc",defaultValue:false},tileActionModeActive:{type:"boolean",group:"Misc",defaultValue:false},ieHtml5DnD:{type:"boolean",group:"Misc",defaultValue:false},showDragIndicator:{type:"boolean",group:"Misc",defaultValue:false},showEmptyLinksArea:{type:"boolean",group:"Misc",defaultValue:false},showEmptyLinksAreaPlaceHolder:{type:"boolean",group:"Misc",defaultValue:false},hidden:{type:"boolean",group:"Misc",defaultValue:false},transformationError:{type:"boolean",group:"Misc",defaultValue:false},supportLinkPersonalization:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{tiles:{type:"sap.ushell.ui.launchpad.Tile",multiple:true,singularName:"tile"},links:{type:"sap.ui.core.Control",multiple:true,singularName:"link"},beforeContent:{type:"sap.ui.core.Control",multiple:true,singularName:"beforeContent"},afterContent:{type:"sap.ui.core.Control",multiple:true,singularName:"afterContent"},footerContent:{type:"sap.ui.core.Control",multiple:true,singularName:"footerContent"},headerActions:{type:"sap.ui.core.Control",multiple:true,singularName:"headerAction"}},events:{afterRendering:{},add:{},titleChange:{}}}});T.prototype.init=function(){this.bIsFirstTitleChange=true;this._sDefaultValue=sap.ushell.resources.i18n.getText("new_group_name");this._sOldTitle="";this.oNoLinksText=new sap.m.Text({text:sap.ushell.resources.i18n.getText("emptyLinkContainerInEditMode")}).addStyleClass("sapUshellNoLinksAreaPresentTextInner");this.oTransformationErrorText=new sap.m.Text({text:sap.ushell.resources.i18n.getText("transformationErrorText")}).addStyleClass("sapUshellTransformationErrorText");this.oTransformationErrorIcon=new sap.ui.core.Icon({src:"sap-icon://message-error"}).addStyleClass("sapUshellTransformationErrorIcon");this.oIcon=new sap.ui.core.Icon({src:this.getIcon()});this.oIcon.addStyleClass('sapUshellContainerIcon');this.oPlusTile=new P({groupId:this.getGroupId(),press:[this.fireAdd,this]});this.oPlusTile.setParent(this);if(sap.ushell.Container.getService("LaunchPage").isLinkPersonalizationSupported()){T.prototype.isLinkPersonalizationOveride();};};T.prototype.exit=function(){if(this.oPlusTile){this.oPlusTile.destroy();}};T.prototype.onAfterRendering=function(){var t=this,j;if(this.getEnableHelp()){this.oPlusTile.addStyleClass("help-id-plusTile");}this.setTransformationError(false);this.handleNoItemsToDisplayMessage();var E=this.getModel()&&this.getModel().getProperty("/enableRenameLockedGroup")||false;jQuery("#"+this.getId()+"-title").find(this.getHeaderLevel()).click(function(){var e=E||!t.getIsGroupLocked()&&!t.getDefaultGroup()&&t.getTileActionModeActive();t.setEditMode(e);});if((document.documentMode)&&(navigator.maxTouchPoints||navigator.msMaxTouchPoints)){j=jQuery(this.getDomRef());j.on("MSHoldVisual contextmenu",".sapUshellTile",function(e){e.preventDefault();});}this.fireAfterRendering();if(sap.ui.Device.system.desktop){this.handleScreenReaderAttr();}};T.prototype.getTransformationErrorText=function(){return this.oTransformationErrorText;},T.prototype.getTransformationErrorIcon=function(){return this.oTransformationErrorIcon;},T.prototype.getNoLinksText=function(){return this.oNoLinksText;};T.prototype.setTransformationError=function(t){this.setProperty('transformationError',t,true);if(t){this.$().find(".sapUshellTransformationError").show();}else{this.$().find(".sapUshellTransformationError").hide();}this.$().find(".sapUshellNoLinksAreaPresent").toggleClass("sapUshellNoLinksAreaPresentError",t);return this;};T.prototype.updateAggregation=o.updateAggregation;T.prototype.updateTiles=function(r){var n="tiles";if(this.isTreeBinding(n)){sap.ui.base.ManagedObject.prototype.updateAggregation.apply(this,arguments);}else{jQuery.sap.log.debug("Updating TileContainer. Reason: ",r);switch(r){case"filter":try{this.filterTiles();}catch(e){this.updateAggregation(n);}break;default:this.updateAggregation(n);}}};T.prototype.handleNoItemsToDisplayMessage=function(){var t=this.getBinding('tiles'),i=t&&t.getContexts().length;if(i){this.$().find(".sapUshellNoFilteredItems").hide();}else{if(this.getShowNoData()){if(this.getNoDataText()){this.setNoDataText(this.getNoDataText());}else{this.setNoDataText(sap.ushell.resources.i18n.getText("noFilteredItems"));}this.$().find(".sapUshellNoFilteredItems").show();}}};T.prototype.createMissingElementsInOnScreenElements=function(i,e,a,g,s,b,f,A){var p,n=null,G=null,j=a,S=this.getShowGroupHeader(),c=e.length,d;for(j=a;j<c;j++){p=e[j].getPath();if(!i.onScreenPathIndexMap[p]){if(g&&s.length>0){n=s[0].fnGroup(e[j]);if(typeof n==="string"){n={key:n};}if(G===null&&j>0){G=s[0].fnGroup(e[j-1]);}if(n.key!==G){if(b.groupHeaderFactory){d=b.groupHeaderFactory(n);}if(!i.onScreenHeaders[n.key]){A(n,d);i.onScreenHeaders[n.key]={aItemsRefrenceIndex:this.getTiles().length-1,isVisible:S};}G=n.key;}}f(e[j]);i.onScreenPathIndexMap[p]={aItemsRefrenceIndex:this.getTiles().length-1,isVisible:true};}else{throw true;}}};T.prototype._newLinkContainerEnabled=function(){return this.getSupportLinkPersonalization();};T.prototype.addNewItem=function(e){var n="tiles",a=this.getMetadata().getJSONKeys()[n],b=this.mBindingInfos[n],f=b.factory,c=jQuery.proxy(function(d){var i=this.getId()+"-"+jQuery.sap.uid(),g=f(i,d);g.setBindingContext(d,b.model);this[a._sMutator](g);},this);c(e);};T.prototype.markVisibleOnScreenElements=function(e,i){var a=0,p,b=e.length;for(a=0;a<b;a++){p=e[a].getPath();if(i.onScreenPathIndexMap[p]){i.onScreenPathIndexMap[p].isVisible=true;}else{return a;}}return a;};T.prototype.indexOnScreenElements=function(a){var p,i,b={onScreenHeaders:{},onScreenPathIndexMap:{}},c=a.length,d;for(i=0;i<c;i++){d=a[i];if(d.getHeaderText){b.onScreenHeaders[d.getHeaderText()]={aItemsRefrenceIndex:i,isVisible:false};}else if(d.getBindingContext()){p=d.getBindingContext().getPath();b.onScreenPathIndexMap[p]={aItemsRefrenceIndex:i,isVisible:false};}}return b;};T.prototype.showHideTilesAndHeaders=function(i,a){var s,n="tiles",S=this.getShowGroupHeader(),b=this.mBindingInfos[n].binding,g,r,e;for(s in i.onScreenPathIndexMap){if(i.onScreenPathIndexMap.hasOwnProperty(s)){e=i.onScreenPathIndexMap[s];r=a[e.aItemsRefrenceIndex];r.setVisible(e.isVisible);if(e.isVisible){g=b.aSorters[0].fnGroup(r.getBindingContext());i.onScreenHeaders[g].isVisible=S;}}}for(s in i.onScreenHeaders){if(i.onScreenHeaders.hasOwnProperty(s)){e=i.onScreenHeaders[s];a[e.aItemsRefrenceIndex].setVisible(e.isVisible);}}};T.prototype.filterTiles=function(){var n="tiles",b=this.mBindingInfos[n],B=this.mBindingInfos[n].binding,a=B.getContexts(),i=this.getTiles(),c,d,e,f,s,g,h,j;d=this.indexOnScreenElements(i);c=this.markVisibleOnScreenElements(a,d);if(a[c]&&this.getTiles().length>0){e=this.getTiles()[this.getTiles().length-1].getBindingContext().getPath();f=a[c].getPath();s=e.split('/');g=f.split('/');j=s[s.length-1];h=g[g.length-1];if(parseInt(j,10)>parseInt(h,10)){throw true;}}this.createMissingElementsInOnScreenElements(d,a,c,B.isGrouped(),B.aSorters,b,this.addNewItem.bind(this),this.addTileGroup.bind(this));i=this.getTiles();this.showHideTilesAndHeaders(d,i);this.handleNoItemsToDisplayMessage();if(sap.ui.Device.system.desktop){this.handleScreenReaderAttr();}};T.prototype.addTileGroup=function(g,h){this.addAggregation("tiles",h||new sap.ushell.ui.launchpad.HeaderTile({headerText:g.text||g.key,headerLevel:g.headerLevel||this.getGroupHeaderLevel(),visible:this.getShowGroupHeader()}));};T.prototype.setNoDataText=function(n){this.setProperty("noDataText",n,true);if(this.getShowNoData()){this.$().find(".sapUshellNoFilteredItems").text(n);}return this;};T.prototype.setGroupId=function(v){this.setProperty("groupId",v,true);if(this.oPlusTile){this.oPlusTile.setGroupId(v);}return this;};T.prototype.setHeaderText=function(h){this.setProperty("headerText",h,true);this.$().find(".sapUshellContainerTitle").text(h);return this;};T.prototype.setShowGroupHeader=function(v){this.setProperty("showGroupHeader",v,true);this.$().find(".sapUshellTileContainerHeader").toggleClass("sapUshellGroupHeaderHidden",!v);return this;};T.prototype.setVisible=function(v){this.setProperty("visible",v,true);this.toggleStyleClass("sapUshellHidden",!v);return this;};T.prototype.setShowMobileActions=function(s){var S=true;if(this.oHeaderButton){this.oHeaderButton.setVisible(s);}else if(s){S=false;}this.setProperty('showMobileActions',s,S);};T.prototype.setShowIcon=function(s){this.setProperty('showIcon',s,true);jQuery('#'+this.getId()).find('.'+'sapUshellContainerIcon').toggleClass('sapUshellContainerIconHidden',!s);};T.prototype.setDeluminate=function(d){this.setProperty('deluminate',d,true);this.toggleStyleClass('sapUshellDisableLockedGroupDuringDrag',d);return this;};sap.ushell.ui.launchpad.TileContainer.prototype.setHidden=function(h){this.setProperty("hidden",!!h,true);this.toggleStyleClass("sapUshellTileContainerEditModeHidden",!!h);return this;};T.prototype.groupHasTiles=function(){var p='',t=this.getTiles(),a=[];if(this.getBindingContext()){p=this.getBindingContext().sPath;t=this.getModel().getProperty(p).tiles;}return sap.ushell.utils.groupHasVisibleTiles(t,a);};T.prototype.handleScreenReaderAttr=function(){var c=this.getInnerContainersDomRefs();var a=c[0].children;if(!a||a.length==0||!a[0].classList.contains("sapUshellHeaderTile")){return;}var b;var d;var e=[];for(var i=0;i<a.length;i++){if(a[i].classList.contains("sapUshellHidden")){continue;}if(a[i].classList.contains("sapUshellHeaderTile")){b=a[i];jQuery(b).attr("role","heading");jQuery(b).attr("aria-level","3");d=0;e=[];}else if(a[i].tagName=="LI"){d++;jQuery(a[i]).attr("aria-posinset",d);e.push(a[i]);var n=a[i+1];if(!n||n.tagName!="LI"){for(var j=0;j<e.length;j++){jQuery(e[j]).attr("aria-setsize",e.length);}}}}};T.prototype.getInnerContainerDomRef=function(){var c=this.getDomRef(),i;if(!c){return null;}i=jQuery(c).find('.sapUshellTilesContainer-sortable');return i[0];};T.prototype.getInnerContainersDomRefs=function(){var c=this.getDomRef(),i,a;if(!c){return null;}i=jQuery(c).find('.sapUshellTilesContainer-sortable');a=jQuery(c).find('.sapUshellLineModeContainer');return[i[0],a[0]];};T.prototype.setEditMode=function(v){if(v){this.addStyleClass('sapUshellEditing');this._startEdit();}else{this.setProperty('editMode',v,false);this.removeStyleClass('sapUshellEditing');}};T.prototype.isLinkPersonalizationOveride=function(){T.prototype.updateLinks=function(r){var g=this.getParent(),t=g&&g.getDisplayMode&&g.getDisplayMode()==='tabs';if(t&&!this.getTileActionModeActive()){g.removeLinksFromUnselectedGroups();}this.removeAllLinks();sap.ui.base.ManagedObject.prototype.updateAggregation.call(this,"links");};T.prototype.destroyLinks=function(r){console.log("*************link is destroyed"+r);};};T.prototype.setShowEmptyLinksArea=function(v){this.setProperty('showEmptyLinksArea',v,true);this.toggleStyleClass("sapUshellLinksAreaHidden",!v);};T.prototype.setShowEmptyLinksAreaPlaceHolder=function(v){this.setProperty('showEmptyLinksArea',v,true);this.toggleStyleClass("sapUshellTileContainerEditMode",v);this.toggleStyleClass("sapUshellTileContainerTabsModeEmptyLinksArea",v);this.toggleStyleClass("sapUshellEmptyLinksAreaPlaceHolder",!v);};T.prototype._startEdit=function(){var t=this;if(this.getModel()&&!this.getModel().getProperty("/editTitle")){this.getModel().setProperty("/editTitle",true,false);}if(!this.oEditInputField){sap.ui.require(['sap/m/Input'],function(I){t.setProperty('editMode',true,false);t.oEditInputField=new I({placeholder:t._sDefaultValue,value:t.getHeaderText()}).addStyleClass('sapUshellTileContainerTitleInput');t.oEditInputField.addEventDelegate({onAfterRendering:function(){setTimeout(function(){var e=t.oEditInputField.getDomRef();if(e){if(jQuery('#'+e.id+":visible").length>0){setTimeout(function(){jQuery(e).find('input').focus();t.oEditInputField.selectText(0,t.oEditInputField.getValue().length);}.bind(t),100);var w=jQuery(window).height(),j=t.getDomRef(),g=j.offsetHeight,a=j.getBoundingClientRect().top,b=j.offsetTop;;if(g+a>w){jQuery('.sapUshellDashboardView section').stop().animate({scrollTop:b},0);}}}}.bind(t),100);}.bind(t),onfocusout:function(e){t._stopEdit();jQuery.proxy(t.setEditMode,t,false)();},onsapenter:function(e){t._stopEdit();jQuery.proxy(t.setEditMode,t,false)();setTimeout(function(){var a=e.srcControl,j=jQuery(a.getDomRef()).prev();j.focus();},0);}});t.oEditInputField.setValue(t.getHeaderText());});}else{this.oEditInputField.setValue(this.getHeaderText());t.setProperty('editMode',true,false);}this._sOldTitle=this._sDefaultValue;if(sap.ui.Device.system.phone){var t=this;setTimeout(function(){var e=sap.ui.getCore().getEventBus();e.publish("launchpad","scrollToGroup",{group:t,groupChanged:false,focus:false});},100);}};T.prototype._stopEdit=function(){var c=this.getHeaderText();var n=this.oEditInputField.getValue(),h;n=n.substring(0,256).trim()||this._sDefaultValue;h=n!==c;if(this.bIsFirstTitleChange&&n===this.oEditInputField.getPlaceholder()){h=true;}this.bIsFirstTitleChange=false;if(this.getModel()&&this.getModel().getProperty("/editTitle")){this.getModel().setProperty("/editTitle",false,false);}if(!this._sOldTitle){this._sOldTitle=c;this.setHeaderText(c);}else if(h){this.fireTitleChange({newTitle:n});this.setHeaderText(n);}};T.prototype.exit=function(){if(this.oHeaderButton){this.oHeaderButton.destroy();}if(this.oActionSheet){this.oActionSheet.destroy();}if(C.prototype.exit){C.prototype.exit.apply(this,arguments);}};return T;});
