// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ushell/services/AppConfiguration","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ushell/services/_ClientSideTargetResolution/InboundProvider","sap/ushell/services/_ClientSideTargetResolution/InboundIndex","sap/ushell/services/_ClientSideTargetResolution/VirtualInbounds","sap/ushell/services/_ClientSideTargetResolution/Search","sap/ushell/services/_ClientSideTargetResolution/StagedLogger","sap/ushell/services/_ClientSideTargetResolution/Formatter","sap/ushell/navigationMode"],function(u,c,b,S,I,d,V,s,l,f,n){"use strict";function C(a,o,p,e){this._init.apply(this,arguments);};C.prototype._init=function(a,o,p,e){this._iLogId=0;if(!this._implementsServiceInterface(a)){jQuery.sap.log.error("Cannot get Inbounds","ClientSideTargetResolutionAdapter should implement getInbounds method","sap.ushell.services.ClientSideTargetResolution");return;}this._oInboundProvider=new I(a.getInbounds.bind(a));this._oHaveEasyAccessSystemsDeferreds={userMenu:null,sapMenu:null};this._validateServiceConfiguration(e);this._oServiceConfiguration=e;this._oAdapter=a;};C.prototype._validateServiceConfiguration=function(o){var e=jQuery.sap.getObject("config.enableInPlaceForClassicUIs",undefined,o),a=true;if(e){if(typeof e!=="object"){a=false;}else{Object.keys(e).forEach(function(k){if(["GUI","WDA"].indexOf(k)===-1){a=false;}else if(typeof e[k]!=="boolean"){a=false;}});}}if(!a){jQuery.sap.log.error("Invalid service configuration: 'enableInPlaceForClassicUIs' must be an object; allowed properties: GUI|WDA, type boolean","Actual config: "+JSON.stringify(o),"sap.ushell.services.ClientSideTargetResolution");}};C.prototype._implementsServiceInterface=function(a){if(typeof a.getInbounds==="function"){return true;}return false;};C.prototype._getURLParsing=function(){if(!this._oURLParsing){this._oURLParsing=sap.ushell.Container.getService("URLParsing");}return this._oURLParsing;};C.prototype._isFullLocalWDAResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWdaLocalResolution"]===false){return false;}return!(!o||!r||!(r["sap.wda"])||!(r.applicationType==="WDA"));};C.prototype._isLocalWDAResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWdaLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="WDA"));};C.prototype._isFullLocalWebguiResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r["sap.gui"])||!(r.applicationType==="TR"));};C.prototype._isLocalWebguiNowrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")===-1));};C.prototype._isLocalWebguiWrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")>=0));};C.prototype._isLocalNativeWebguiWrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableNativeWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")!==-1));};C.prototype._isLocalNativeWebguiNowrapResolution=function(m){var o=m.inbound,r=o&&o.resolutionResult;if(this._oServiceConfiguration&&this._oServiceConfiguration.config&&this._oServiceConfiguration.config["enableNativeWebguiLocalResolution"]===false){return false;}return!(!o||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")===-1));};C.prototype._hasRenameTo=function(m){return m.inbound&&m.inbound.signature&&m.inbound.signature.parameters&&Object.keys(m.inbound.signature.parameters).some(function(k){return!!(m.inbound.signature.parameters[k].renameTo);});};C.prototype._removeUnusedComplexParameterValuesFromDefaultList=function(m){m.defaultedParamNames=m.defaultedParamNames.filter(function(N){if(m.intentParamsPlusAllDefaults[N]&&!jQuery.isArray(m.intentParamsPlusAllDefaults[N])){if(!(m.resolutionResult.oNewAppStateMembers&&m.resolutionResult.oNewAppStateMembers[N])){return false;}}return true;});};C.prototype._mapDefaultParameterNames=function(m){var p=jQuery.sap.getObject("inbound.signature.parameters",undefined,m)||{},M={};m.defaultedParamNames.forEach(function(N){var a=(p[N]&&p[N].renameTo)||N;if(M[a]){jQuery.sap.log.error("renaming of defaultedParamNames creates duplicates"+N+"->"+a);}else{M[a]=true;}});m.mappedDefaultedParamNames=Object.keys(M).sort();};C.prototype._mixAppStateIntoResolutionResultAndRename=function(m,a){var D=new jQuery.Deferred(),t=this,N,e,o;function g(T){var q;t._removeUnusedComplexParameterValuesFromDefaultList(T);t._mapDefaultParameterNames(T);q=n.compute(jQuery.sap.getObject("inbound.resolutionResult.applicationType",undefined,T),(T.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0],(T.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0],(b.getCurrentApplication()||{}).applicationType,t._oServiceConfiguration&&t._oServiceConfiguration.config&&t._oServiceConfiguration.config.enableInPlaceForClassicUIs);u.shallowMergeObject(T.resolutionResult,q);delete T.resolutionResult.oNewAppStateMembers;D.resolve(T);}function h(m){return(m.resolutionResult.oNewAppStateMembers&&!jQuery.isEmptyObject(m.resolutionResult.oNewAppStateMembers));}function j(L,P){return jQuery.isArray(L)&&L.some(function(q){return(P.indexOf(q)!==-1);});}function k(A,P){var q,v,w;if(A&&A.selectionVariant){q=new S(JSON.stringify(A.selectionVariant));w=q.getSelectOptionsPropertyNames()||[];v=q.getParameterNames()||[];if(j(w,P)||j(v,P)){return true;}}return false;}function r(q,v,P){var w=new S(),x=q.getParameterNames()||[],y=q.getSelectOptionsPropertyNames()||[],z,A;x.forEach(function(B){z=q.getParameter(B);if(P[B]&&P[B].renameTo){if((w.getParameter(P[B].renameTo)===undefined)&&(w.getSelectOption(P[B].renameTo)===undefined)){w.addParameter(P[B].renameTo,z);v.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+B+"->"+P[B].renameTo);}}else{if((w.getParameter(B)===undefined)&&(w.getSelectOption(B)===undefined)){w.addParameter(B,z);}}});y.forEach(function(B){A=q.getSelectOption(B);if(P[B]&&P[B].renameTo){if((w.getSelectOption(P[B].renameTo)===undefined)&&(w.getParameter(P[B].renameTo)===undefined)){w.massAddSelectOption(P[B].renameTo,A);v.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+B+"->"+P[B].renameTo);}}else{if((w.getSelectOption(B)===undefined)&&(w.getParameter(B)===undefined)){w.massAddSelectOption(B,A);}}});x.forEach(function(B){q.removeParameter(B);});y.forEach(function(B){q.removeSelectOption(B);});w.getParameterNames().forEach(function(B){q.addParameter(B,w.getParameter(B));});w.getSelectOptionsPropertyNames().forEach(function(B){q.massAddSelectOption(B,w.getSelectOption(B));});return q;}function R(q,v,P){return r(q,v,P);}function p(q){if(q===undefined||jQuery.isPlainObject(q)){return false;}return true;}function M(q){var v=q.getData()||{},w,x={};if(v.selectionVariant){w=new S(JSON.stringify(v.selectionVariant));}else{w=new S();}if(h(m)){Object.keys(m.resolutionResult.oNewAppStateMembers).forEach(function(y){w.massAddSelectOption(y,m.resolutionResult.oNewAppStateMembers[y].Ranges);});}w=R(w,x,m.inbound.signature.parameters);if(w.getParameterNames().length!==0||w.getSelectOptionsPropertyNames().length!==0){v.selectionVariant=w.toJSONObject();}if(!x.changed&&!h(m)){g(m);return;}q.setData(v);q.save().done(function(){m.intentParamsPlusAllDefaults["sap-xapp-state"]=[q.getKey()];m.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[q.getKey()];g(m);});}if(!h(m)&&!t._hasRenameTo(m)){g(m);}else{e=m.intentParamsPlusAllDefaults["sap-xapp-state"]&&m.intentParamsPlusAllDefaults["sap-xapp-state"][0];if(e){a.getAppState(e).done(function(q){var P=c.constructParameterDominatorMap(m.inbound.signature.parameters);o=q.getData();if(p(o)){delete m.resolutionResult.oNewAppStateMembers;g(m);}if(m.resolutionResult.oNewAppStateMembers){Object.keys(m.resolutionResult.oNewAppStateMembers).forEach(function(v){var w=P[v].dominatedBy;if(k(o,w)){delete m.resolutionResult.oNewAppStateMembers[v];}});}if(!h(m)&&!t._hasRenameTo(m)){g(m);}else{N=a.createEmptyAppState(undefined,true);if(N){N.setData(q.getData());M(N);}}});}else if(h(m)){M(a.createEmptyAppState(undefined,true));}else{g(m);}}return D.promise();};C.prototype._extractInboundFilter=function(o){if(!this._oAdapter.hasSegmentedAccess){return undefined;}if(typeof o!=="string"){return undefined;}var F=o.indexOf("#")===0?o:"#"+o;var a=this._getURLParsing().parseShellHash(F);if(!a||!a.semanticObject||!a.action){return undefined;}return[{semanticObject:a.semanticObject,action:a.action}];};C.prototype.resolveHashFragment=function(h){var t=this,D=new jQuery.Deferred(),B=this._oAdapter.resolveHashFragmentFallback&&this._oAdapter.resolveHashFragmentFallback.bind(this._oAdapter),a=this._extractInboundFilter(h);this._oInboundProvider.getInbounds(a).then(function(e){t._resolveHashFragment(h,B,e).done(function(o){return D.resolve(o);}).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype.resolveTileIntent=function(h){var t=this,D=new jQuery.Deferred(),a=this._extractInboundFilter(h);this._oInboundProvider.getInbounds(a).then(function(o){t._resolveTileIntent(h,undefined,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype.resolveTileIntentInContext=function(a,h){var o,D=new jQuery.Deferred();o=d.createIndex(a.concat(V.getInbounds()));this._resolveTileIntent(h,undefined,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));return D.promise();};C.prototype._resolveHashFragment=function(h,B,a){var U=this._getURLParsing(),t=this,D=new jQuery.Deferred(),F=h.indexOf("#")===0?h:"#"+h,e=U.parseShellHash(F);if(e===undefined){jQuery.sap.log.error("Could not parse shell hash '"+h+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return D.reject().promise();}e.formFactor=u.getFormFactor();this._getMatchingInbounds(e,a,{bExcludeTileInbounds:true}).fail(function(E){jQuery.sap.log.error("Could not resolve "+h,"_getMatchingInbounds promise rejected with: "+E,"sap.ushell.services.ClientSideTargetResolution");D.reject(E);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+h,"rejecting promise","sap.ushell.services.ClientSideTargetResolution");D.reject("Could not resolve navigation target");return;}M=m[0];c.whenDebugEnabled(function(){function g(k,v){return this[k]===undefined?"<undefined>":v;}function r(k,v){return(k==="_original")?undefined:g.call(this,k,v);}var j=JSON.stringify(M,r,"   ");jQuery.sap.log.debug("The following target will now be resolved",j,"sap.ushell.services.ClientSideTargetResolution");});t._resolveSingleMatchingTarget(M,B,F).done(function(o){D.resolve(o);}).fail(D.reject.bind(D));});return D.promise();};C.prototype._resolveEasyAccessMenuIntent=function(o,m,B,F){var e="Intent must be either #Shell-startGUI or #Shell-startWDA";if(o.action==="startGUI"){return this._resolveEasyAccessMenuIntentWebgui(o,m,B,F,true);}if(o.action==="startWDA"){return this._resolveEasyAccessMenuIntentWDA(o,m);}return new jQuery.Deferred().reject("The easy access menu intent "+o.semanticObject+"-"+o.action+" could not be resolved: "+e).promise();};C.prototype._resolveEasyAccessMenuIntentWDA=function(o,m){var a,A,O,D=new jQuery.Deferred(),t=this;A=o.params["sap-ui2-wd-app-id"][0];a=(jQuery.sap.getObject("params.sap-ui2-wd-conf-id",undefined,o)||[])[0];O=Object.keys(o.params).reduce(function(r,p){if(p!=="sap-ui2-wd-app-id"&&p!=="sap-ui2-wd-conf-id"){r[p]=o.params[p];}return r;},{});t._buildWdaURI(A,a,O).done(function(U){var r={url:U.toString(),applicationType:"NWBC",text:A,additionalInformation:"","sap-system":o.params["sap-system"][0]};if(m&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){r["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}D.resolve(r);}).fail(function(e){D.reject(e);});return D.promise();};C.prototype._buildNativeWebGuiURI=function(t,a){var U,o;U="/sap/bc/gui/sap/its/webgui?%7etransaction="+t+"&%7enosplash=1";o=new URI(U);return this._spliceSapSystemIntoURI(o,"",a,"NATIVEWEBGUI");};C.prototype._buildWdaURI=function(a,e,o){var g,U,h,j=jQuery.extend(true,{},o);if(e){j["sap-wd-configId"]=e;}g=j["sap-system"][0];delete j["sap-system"];U="/ui2/nwbc/~canvas;window=app/wda/"+a+"/"+"?"+this._getURLParsing().paramsToString(j);h=new URI(U);return this._spliceSapSystemIntoURI(h,"",g,"WDA");};C.prototype._resolveEasyAccessMenuIntentWebgui=function(o,m,B,F,U){var D=new jQuery.Deferred(),t=this;this._buildNativeWebGuiURI(o.params["sap-ui2-tcode"][0],o.params["sap-system"][0]).done(function(e){delete m.intentParamsPlusAllDefaults["sap-ui2-tcode"];t._mapParameterNamesAndRemoveObjects(m);t._blendParamsIntoNativeWebGUI(m,e);var a=m;if(m.resolutionResult&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){a["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}a.resolutionResult["sap-system"]=o.params["sap-system"][0];if(U){a.resolutionResult.text=o.params["sap-ui2-tcode"][0];}D.resolve(a.resolutionResult);return;});return D.promise();};C.prototype._resolveSingleMatchingTarget=function(m,B,F){var t=this,D=new jQuery.Deferred(),U=this._getURLParsing(),o=U.parseShellHash(F);if(o.semanticObject==="Shell"&&(o.action==="startWDA"||o.action==="startGUI")){return this._resolveEasyAccessMenuIntent(o,m,B,F).then(function(r){var N=n.compute(jQuery.sap.getObject("inbound.resolutionResult.applicationType",undefined,m),(m.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0],(m.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0],(b.getCurrentApplication()||{}),t._oServiceConfiguration&&t._oServiceConfiguration.config&&t._oServiceConfiguration.config.enableInPlaceForClassicUIs);u.shallowMergeObject(r,N);return r;});}this._mapParameterNamesAndRemoveObjects(m);this._mixAppStateIntoResolutionResultAndRename(m,sap.ushell.Container.getService("AppState")).done(function(m){var a=t._determineResultProcessor(m);delete m.intentParamsPlusAllDefaults["sap-tag"];delete m.mappedIntentParamsPlusSimpleDefaults["sap-tag"];m.mappedDefaultedParamNames=m.mappedDefaultedParamNames.filter(function(p){return p!=="sap-tag";});var e=jQuery.sap.getObject('inbound.resolutionResult.url',undefined,m);a(m,B,F,e).done(function(m){D.resolve(m.resolutionResult);jQuery.sap.log.debug("Intent was resolved to the following target",JSON.stringify(m.resolutionResult,null,3),"sap.ushell.services.ClientSideTargetResolution");}).fail(function(M){if(M.indexOf("fallback:")>=0){t._constructFallbackResolutionResult.call(this,m,B,F).fail(D.reject.bind(D)).done(function(m){D.resolve(m.resolutionResult);});}else{D.reject(M);}});});return D.promise();};C.prototype._resolveTileIntent=function(h,B,o){var U=this._getURLParsing(),t=this,D=new jQuery.Deferred(),F=h.indexOf("#")===0?h:"#"+h,a=U.parseShellHash(F);if(a===undefined){jQuery.sap.log.error("Could not parse shell hash '"+h+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return D.reject("Cannot parse shell hash").promise();}a.formFactor=u.getFormFactor();this._getMatchingInbounds(a,o,{bExcludeTileInbounds:false}).fail(function(e){jQuery.sap.log.error("Could not resolve "+h,"_getMatchingInbounds promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");D.reject(e);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+h,"no matching targets were found","sap.ushell.services.ClientSideTargetResolution");D.reject("No matching targets found");return;}M=m[0];t._resolveSingleMatchingTileIntent(M,B,F).done(D.resolve.bind(D)).fail(D.reject.bind(D));});return D.promise();};C.prototype._resolveSingleMatchingTileIntent=function(m,B,F){var D=new jQuery.Deferred(),t=this;this._mapParameterNamesAndRemoveObjects(m);this._mixAppStateIntoResolutionResultAndRename(m,sap.ushell.Container.getService("AppState")).done(function(m){var a=t._determineResultProcessor(m);delete m.intentParamsPlusAllDefaults["sap-tag"];delete m.mappedIntentParamsPlusSimpleDefaults["sap-tag"];m.mappedDefaultedParamNames=m.mappedDefaultedParamNames.filter(function(p){return p!=="sap-tag";});var e=jQuery.sap.getObject('inbound.resolutionResult.url',undefined,m);a(m,B,F,e).done(function(m){var T=jQuery.extend(true,{},m.inbound.tileResolutionResult);T.startupParameters=m.effectiveParameters;T.navigationMode=m.resolutionResult.navigationMode;if(!T.navigationMode){T.navigationMode=n.getNavigationMode(m.resolutionResult)}D.resolve(T);jQuery.sap.log.debug("Tile Intent was resolved to the following target",JSON.stringify(T,null,3),"sap.ushell.services.ClientSideTargetResolution");}).fail(function(M){D.reject(M);});});return D.promise();};C.prototype._determineResultProcessor=function(m){var o=m.inbound,r=o&&o.resolutionResult;function a(P,R){jQuery.sap.log.debug("Resolution result will be constructed via "+P+" processor",R,"sap.ushell.services.ClientSideTargetResolution");}if(!o||!r){a("FALLBACK","the inbound or the inbound resolutionResult member was not available");return this._constructFallbackResolutionResult.bind(this);}if(r.applicationType==="SAPUI5"){a("SAPUI5","inbound resolutionResult had SAPUI5 applicationType");return this._constructSAPUI5ResolutionResult.bind(this);}var e=this._isFullLocalWDAResolution(m);if(e){a("WDA full url construction");return this._constructFullWDAResolutionResult.bind(this);}var g=this._isLocalWDAResolution(m);if(g){a("WDA");return this._constructWDAResolutionResult.bind(this);}var h=this._isFullLocalWebguiResolution(m);if(h){a("NON-WRAPPED WEBGUI full url construction");return this._constructFullWebguiResolutionResult.bind(this);}var j=this._isLocalWebguiNowrapResolution(m);if(j){a("NON-WRAPPED WEBGUI");return this._constructWebguiNowrapResult.bind(this);}var k=this._isLocalWebguiWrapResolution(m);if(k){a("WRAPPED WEBGUI");return this._constructWebguiWrapResult.bind(this);}var p=this._isLocalNativeWebguiNowrapResolution(m);if(p){a("NATIVE NON-WRAPPED WEBGUI");return this._constructNativeWebguiNowrapResult.bind(this);}var q=this._isLocalNativeWebguiWrapResolution(m);if(q){a("NATIVE WRAPPED WEBGUI");return this._constructNativeWebguiWrapResult.bind(this);}if(r.applicationType==="URL"){a("URL","inbound resolutionResult had URL applicationType");return this._constructURLResolutionResult.bind(this);}a("FALLBACK","could not apply any result processor to inbound resolutionResult: "+JSON.stringify(r,null,"   "));return this._constructFallbackResolutionResult.bind(this);};C.prototype._stripURI=function(U,a,e){var D=new jQuery.Deferred(),t=this;if(typeof a==="undefined"){this._stripURIWithSystemAlias(U,a,e,undefined).fail(function(E){D.reject(E);}).done(function(N){D.resolve(N);});return D.promise();}this._oAdapter.resolveSystemAlias(a).fail(function(E){D.reject(E);}).done(function(r){t._stripURIWithSystemAlias(U,a,e,r).fail(function(E){D.reject(E);}).done(function(N){D.resolve(N);});});return D.promise();};C.prototype._stripURIWithSystemAlias=function(U,a,e,r){var t=this,o,g,T,h,D=new jQuery.Deferred(),p=new jQuery.Deferred();U.protocol("");U.hostname("");U.port("");t._removeParametersFromURI(U,["sap-client","sap-language"]);if(!jQuery.isPlainObject(r)||typeof a!=="string"){return D.resolve(U).promise();}g=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol());o=r[g];h=(typeof o.pathPrefix==="string")&&o.pathPrefix;if(h!==""){p.resolve(h);}else{this._oAdapter.resolveSystemAlias("").fail(function(E){D.reject(E);}).done(function(R){var j=R[g];p.resolve(j.pathPrefix);});}p.fail(function(E){D.reject(E);}).done(function(h){if(h&&h.length>0){T=U.path();T=T.replace(h,"");if(T.indexOf("/")!==0){T="/"+T;}U.path(T);}if(e==="NATIVEWEBGUI"&&r.hasOwnProperty("rfc")){T=U.path();T=T.split(";").filter(function(P){return P.indexOf("~sysid=")!==0&&P.indexOf("~service=")!==0&&P.indexOf("~loginGroup=")!==0&&P.indexOf("~messageServer=")!==0&&P.indexOf("~sncNameR3=")!==0&&P.indexOf("~sncQoPR3=")!==0;}).join(";");U.path(T);}D.resolve(U);});return D.promise();};C.prototype._removeParametersFromURI=function(U,p){var B={},t;p.forEach(function(P){B[P]=true;});t=U.query();t=t.split("&").filter(function(P){var a=(P.split("=")[0]||"").toLowerCase();return!B.hasOwnProperty(a);}).join("&");U.query(t);};C.prototype._spliceSapSystemIntoUrlURI=function(U,a,e){var t=this,D=new jQuery.Deferred();if(typeof e==="undefined"||a===e){return D.resolve(U).promise();}if(a===""||typeof a==="undefined"){if(this._isAbsoluteURI(U)){return D.resolve(U);}t._applyAliasToURI(e,U,"URL").fail(function(E){D.reject(E);}).done(function(o){D.resolve(o);});return D.promise();}if(typeof this._oAdapter.resolveSystemAlias!=="function"){return D.reject("fallback: the adapter does not implement resolveSystemAlias").promise();}this._oAdapter.resolveSystemAlias(a).fail(function(E){D.reject(E);}).done(function(r){var g=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),o=r[g],h;if((U.protocol()||"").toLowerCase()===g&&(U.hostname()||"")===o.host&&(U.path().indexOf(o.pathPrefix)===0)){U.protocol("");U.hostname("");h=U.path().replace(o.pathPrefix,"");U.path(h);t._removeParametersFromURI(U,["sap-language","sap-client"]);t._applyAliasToURI(e,U,"URL").fail(function(E){D.reject(E);}).done(function(j){D.resolve(j);});}else{D.resolve(U);}});return D.promise();};C.prototype._spliceSapSystemIntoURI=function(U,a,e,g){var D=new jQuery.Deferred(),t=this;if(g==="URL"){return this._spliceSapSystemIntoUrlURI(U,a,e);}if(typeof e==="undefined"||a===e){return D.resolve(U).promise();}if(typeof this._oAdapter.resolveSystemAlias!=="function"){return D.reject("fallback: the adapter does not implement resolveSystemAlias").promise();}this._stripURI(U,a,g).fail(function(E){D.reject(E);}).done(function(o){t._applyAliasToURI(e,o,g).fail(function(E){D.reject(E);}).done(function(h){D.resolve(h);});});return D.promise();};C.prototype._applyAliasToURI=function(a,U,e){var t=this,N=U,D=new jQuery.Deferred();this._oAdapter.resolveSystemAlias(a).fail(function(E){D.reject(E);}).done(function(r){var g=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),o=r[g],q,L,h;N.protocol(g);N.hostname(o.host);N.port(o.port);t._interpolatePathPrefixIntoURI(N,e,o.pathPrefix).fail(function(E){D.reject(E);}).done(function(N){q=N.query();if(typeof r.client==="string"&&r.client!==""){q=q+(q.length>0?"&":"")+"sap-client="+r.client;}if(typeof r.language==="string"&&r.language!==""){L=r.language;}else{h=sap.ushell.Container.getUser();if(!h){jQuery.sap.log.error("Cannot retieve the User object via sap.ushell.Container while determining sap-language","will default to 'en' language","sap.ushell.services.ClientSideTargetResolution");L="en";}else{L=h.getLanguage();}}q=q+(q.length>0?"&":"")+"sap-language="+L;N.query(q);N=t._interpolateNativeWebguiDataIntoURI(r,N,e);D.resolve(N);});});return D.promise();};C.prototype._interpolateNativeWebguiDataIntoURI=function(a,U,e){var g,t,h,p;if(a.hasOwnProperty("rfc")&&e==="NATIVEWEBGUI"){h=a.rfc;g=!!h.systemId;if(g){t=[h.systemId&&("~sysid="+h.systemId),h.loginGroup&&("~loginGroup="+h.loginGroup),h.sncNameR3&&("~messageServer="+encodeURIComponent(h.sncNameR3)),h.sncNameR3&&("~sncNameR3="+encodeURIComponent(h.sncNameR3)),h.sncQoPR3&&("~sncQoPR3="+h.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}else{t=[h.service&&("~service="+h.service),h.sncNameR3&&("~sncNameR3="+encodeURIComponent(h.sncNameR3)),h.sncQoPR3&&("~sncQoPR3="+h.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}p=U.path()+";"+t.join(";").replace(/(%[A-F0-9]{2})/g,function(E){return E.toLowerCase();});U.path(p);U._parts.path=p;}return U;};C.prototype._interpolatePathPrefixIntoURI=function(U,a,p){var t=this,D=new jQuery.Deferred(),T;if(a==="URL"&&p.length===0){return D.resolve(U).promise();}function e(P){var r=P+U.path();U.path(r.replace(/\/+/g,"/"));D.resolve(U);}if(p.length>0){if((a==="WDA"||a==="WEBGUI")&&U.path().indexOf("~canvas")>=0){T=U.path();T="/~canvas"+T.split("~canvas")[1];U.path(T);}e(p);}else{this._oAdapter.resolveSystemAlias("").fail(function(E){D.reject(E);}).done(function(r){var g=t._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),P=r[g].pathPrefix;e(P);});}return D.promise();};C.prototype._selectSystemAliasDataName=function(o,B){if(o.hasOwnProperty("https")){return"https";}if(o.hasOwnProperty("http")){return"http";}jQuery.sap.log.error("Cannot select which system alias to pick between http/https","make sure they are provided in the given system alias collection","sap.ushell.services.ClientSideTargetResolution");return undefined;};C.prototype._getRenameParameterName=function(p,o,P){if(!P||!jQuery.isArray(P)){return p;}if(o&&o.parameters&&o.parameters[p]&&o.parameters[p].renameTo){return o.parameters[p].renameTo;}return p;};C.prototype._mapParameterNamesAndRemoveObjects=function(m){var t=this,N={},o=m.intentParamsPlusAllDefaults;Object.keys(o).sort().forEach(function(p){var r=t._getRenameParameterName(p,m.inbound.signature,o[p]);if(jQuery.isArray(m.intentParamsPlusAllDefaults[p])){if(N[r]){jQuery.sap.log.error("collision of values during parameter mapping : \""+p+"\" -> \""+r+"\"");}else{N[r]=m.intentParamsPlusAllDefaults[p];}}});m.mappedIntentParamsPlusSimpleDefaults=N;};C.prototype._constructFullWDAResolutionResult=function(m,B,F){var t=this,r=jQuery.sap.getObject("inbound.resolutionResult",undefined,m),D=new jQuery.Deferred();t._buildWdaURI(r["sap.wda"].applicationId,r["sap.wda"].configId,{"sap-system":[r.systemAlias]}).done(function(w){t._constructWDAResolutionResult(m,B,F,w.toString()).done(function(r){D.resolve(r);}).fail(function(e){D.reject(e);});}).fail(function(e){D.reject(e);});return D.promise();};C.prototype._constructFullWebguiResolutionResult=function(m,B,F){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();this._buildNativeWebGuiURI(o.resolutionResult["sap.gui"].transaction,r.systemAlias).done(function(U){t._mapParameterNamesAndRemoveObjects(m);t._blendParamsIntoNativeWebGUI(m,U);if(m.resolutionResult&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){m.resolutionResult["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}m.resolutionResult["sap-system"]=r.systemAlias;D.resolve(m);}).fail(function(M){D.reject(M);});return D.promise();};C.prototype._constructWDAResolutionResult=function(m,B,F,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();var w=new URI(a);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.mappedDefaultedParamNames.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m.mappedDefaultedParamNames)];}var g=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=g;delete e["sap-system"];t._spliceSapSystemIntoURI(w,r.systemAlias,g,"WDA").fail(D.reject.bind(D)).done(function(w){sap.ushell.Container.getService("ShellNavigation").compactParams(e,["sap-xapp-state","sap-ushell-defaultedParameterNames","sap-intent-params"],undefined,true).fail(D.reject.bind(D)).done(function(E){var h=t._getURLParsing().paramsToString(E);var p=w.search();if(h){p=p+((p.indexOf("?")<0)?"?":"&")+h;}w.search(p);["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=o.resolutionResult[P];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="NWBC";D.resolve(m);});});return D.promise();};C.prototype._constructWebguiNowrapResult=function(m,B,F,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();var w=new URI(a);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var g=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=g;delete e["sap-system"];t._adjustDYNP_OKCODE(e,m);t._spliceSapSystemIntoURI(w,r.systemAlias,g,"WEBGUI").fail(D.reject.bind(D)).done(function(w){var E=t._getURLParsing().paramsToString(e);var p=w.search();if(E){p=p+((p.indexOf("?")<0)?"?":"&")+E;}w.search(p);["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=o.resolutionResult[P];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="NWBC";D.resolve(m);});return D.promise();};C.prototype._constructWebguiWrapResult=function(m,B,F,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();var w=new URI(a);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var g=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=g;delete e["sap-system"];t._spliceSapSystemIntoURI(w,r.systemAlias,g,"WEBGUI").fail(D.reject.bind(D)).done(function(w){var p=w.search();p=t._injectEffectiveParametersIntoWebguiPobjectParam(p,e,"&","=");w.search(p);["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=o.resolutionResult[P];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="NWBC";D.resolve(m);});return D.promise();};C.prototype._injectEffectiveParametersIntoWebguiPobjectParam=function(q,p,Q,a){var e,P="P_OBJECT"+a,m=132;var g=this._getURLParsing().privparamsToString(p,"%25","%21");if(!g){return q;}var h="";this._amendGuiParam("P_OBJECT",q,Q,a,function(j){var k=j.replace(P,"");h=decodeURIComponent(k);if(h.length>0){h=h+"%25";}return P;});g=h+g;var o={pObjX:"",pObject:""};g.match(new RegExp(".{1,"+m+"}","g")).map(function(j){return encodeURIComponent(j);}).forEach(function(j,G){var k="P_OBJECT";var r="pObject";if(G>0){k="P_OBJ"+G;r="pObjX";}var t=o[r].length===0?"":Q;o[r]=o[r]+t+k+a+j;});e=[o.pObjX,o.pObject].filter(function(j){return j.length>0;}).join(Q);var A=this._amendGuiParam("P_OBJECT",q,Q,a,function(F){return e;});if(A.found){return A.query;}return q+(q.length===0?"":Q)+e;};C.prototype._amendGuiParam=function(t,q,Q,a,A){var F=false,p=t+a;var e=q.split(Q).map(function(P){if(P.indexOf(p)!==0){return P;}F=true;return A(P);}).filter(function(P){return typeof P!=="undefined";}).join(Q);return{found:F,query:e};};C.prototype._parseWebguiTransactionQueryParam=function(t){var T="^(.+?)(%20|(%20)(.+))?$",r=new RegExp(T,"i"),a,p={hasParameters:null,transactionParamName:"",transactionCode:"",parameters:[]};var P=t.split("=");if(P.length>2){return{"error":"Found more than one assignment ('=') in the transaction query parameter","details":"Only one '=' sign is expected in "+t};}if(P.length<2||typeof P[1]==="undefined"||P[1].length===0){return{"error":"The transaction query parameter must specify at least the transaction name","details":"Got "+t+" instead."};}p.transactionParamName=P[0];a=P[1];var m=a.match(r);if(!m){return{"error":"Cannot parse ~transaction query parameter value.","details":a+" should match /"+T+"/"};}p.transactionCode=m[1];if(m[2]&&m[2]!=="%20"){var e=m[4]||"";e.split("%3b").forEach(function(N){var g=N.split("%3d"),h=g[0];if(h&&typeof h==="string"&&h.length>0){p.parameters.push({name:h,value:g[1]});}});}p.hasParameters=false;if(p.parameters.length>0){p.hasParameters=true;p.transactionCode=p.transactionCode.replace(/^[*]/,"");}return p;};C.prototype._injectEffectiveParametersIntoWebguiQueryParam=function(t,p){var P=this._parseWebguiTransactionQueryParam(t);if(P.error){jQuery.sap.log.error(P.error,P.details,"sap.ushell.services.ClientSideTargetResolution");return t;}var a=P.parameters.map(function(g){return g.name.toUpperCase()+"%3d"+g.value;});var o={};Object.keys(p).forEach(function(k){o[k.toUpperCase()]=p[k];});var e=this._getURLParsing().privparamsToString(o,"%3b","%3d");if(e){a.push(e);}var h=a.length>0;return P.transactionParamName+"="+(h?"*":"")+P.transactionCode+(h?"%20":"")+a.join("%3b");};C.prototype._constructNativeWebguiWrapResult=function(m,B,F,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();var w=new URI(a);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var g=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=g;delete e["sap-system"];t._spliceSapSystemIntoURI(w,r.systemAlias,g,"NATIVEWEBGUI").fail(D.reject.bind(D)).done(function(w){var p=w.search();var P=p.split("&").map(function(q){var h;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){h=t._injectEffectiveParametersIntoWebguiPobjectParam(q,e,"%3b","%3d");return h;}return q;}).join("&");w.search(P);["additionalInformation","applicationDependencies"].forEach(function(h){if(o.resolutionResult.hasOwnProperty(h)){m.resolutionResult[h]=o.resolutionResult[h];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="TR";D.resolve(m);});return D.promise();};C.prototype._isWebguiBusinessParameter=function(N,v){var a;if(arguments.length===1){a=N.split(/[=](.+)?/);if(a.length>1){return this._isWebguiBusinessParameter.apply(this,a);}}return!(N.indexOf("sap-")===0||N.charAt(0)==="~");};C.prototype._extractWebguiNonBusinessParameters=function(p){var t=this,N={};Object.keys(p).forEach(function(P){var a=p[P];if(!t._isWebguiBusinessParameter(P,a)){N[P]=a;delete p[P];}});return N;};function i(o){return o&&o.signature&&o.signature&&o.signature.parameters&&o.signature.parameters.DYNP_OKCODE&&o.signature.parameters.DYNP_OKCODE.required===true;}C.prototype._adjustDYNP_OKCODE=function(e,m){var t=this;var a=i(m&&m.inbound);if(a){return e;}var g=Object.keys(e).reduce(function(p,P){if(!t._isWebguiBusinessParameter(P)){return p;}if(P.toUpperCase()==="DYNP_OKCODE"){return p;}return p+1;},0);if(g===0){Object.keys(e).forEach(function(p){if(p.toUpperCase()==="DYNP_OKCODE"){delete e[p];}});}return e;};C.prototype._constructNativeWebguiNowrapResult=function(m,B,F,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred(),e={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};var w=new URI(a);var E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var g=E["sap-system"]&&E["sap-system"][0];m.resolutionResult["sap-system"]=g;Object.keys(E).forEach(function(p){if(e[p.toLowerCase()]){delete E[p];}});t._spliceSapSystemIntoURI(w,r.systemAlias,g,"NATIVEWEBGUI").fail(D.reject.bind(D)).done(function(w){t._blendParamsIntoNativeWebGUI(m,w);D.resolve(m);});return D.promise();};C.prototype._blendParamsIntoNativeWebGUI=function(m,w){var t=this,o=m.inbound,F={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var a=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=a;Object.keys(e).forEach(function(h){if(F[h.toLowerCase()]){delete e[h];}});t._adjustDYNP_OKCODE(e,m);var E=this._extractWebguiNonBusinessParameters(e);var p=w.search();var P=p.split("&").map(function(q){var N;if(!t._isWebguiBusinessParameter(q)){if(q.indexOf("=")>=0){N=q.split("=");if(!E.hasOwnProperty(N[0])){E[N[0]]=N[1];}}else{jQuery.sap.log.error("Found no '=' separator of Webgui non-business parameter. Parameter will be skipped.","'"+q+"'","sap.ushell.services.ClientSideTargetResolution");}return undefined;}var h;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){h=t._injectEffectiveParametersIntoWebguiQueryParam(q,e,"%3b","%3d");return h;}return q;}).filter(function(h){return typeof h!=="undefined";}).join("&");var g=t._getURLParsing().paramsToString(E);P=[P,g.replace("~","%7e")].join("&");w.search(P);["additionalInformation","applicationDependencies","sap.platform.runtime"].forEach(function(h){if(o.resolutionResult.hasOwnProperty(h)){m.resolutionResult[h]=o.resolutionResult[h];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=o.title;m.resolutionResult.applicationType="TR";return m;};C.prototype._constructSAPUI5ResolutionResult=function(m,B,F,a){var o=m.inbound,D=new jQuery.Deferred(),U,e,E;["applicationType","additionalInformation","applicationDependencies"].forEach(function(p){if(o.resolutionResult.hasOwnProperty(p)){m.resolutionResult[p]=o.resolutionResult[p];}});m.resolutionResult.url=a;if(m.resolutionResult.applicationDependencies&&typeof m.resolutionResult.url==="undefined"){m.resolutionResult.url="";}if(typeof m.resolutionResult.url==="undefined"){return D.reject("Cannot resolve intent: url was not specified in matched inbound").promise();}E=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);m.resolutionResult.reservedParameters={};var r={"sap-ui-fl-max-layer":true};Object.keys(r).forEach(function(N){var v=E[N];if(v){delete E[N];m.resolutionResult.reservedParameters[N]=v;}});m.mappedDefaultedParamNames=m.mappedDefaultedParamNames.filter(function(g){return!r[g];});if(m.mappedDefaultedParamNames.length>0){E["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m.mappedDefaultedParamNames)];}e=E["sap-system"]&&E["sap-system"][0];m.resolutionResult["sap-system"]=e;m.effectiveParameters=E;U=this._getURLParsing().paramsToString(E);if(U){m.resolutionResult.url=a+((a.indexOf("?")<0)?"?":"&")+U;}if(typeof o.resolutionResult.ui5ComponentName!=="undefined"){m.resolutionResult.ui5ComponentName=o.resolutionResult.ui5ComponentName;}m.resolutionResult.text=o.title;D.resolve(m);return D.promise();};C.prototype._isAbsoluteURI=function(U){return(U.protocol()||"").length>0;};C.prototype._constructURLResolutionResult=function(m,B,F,a){var t=this,o=m.inbound,r=o&&o.resolutionResult,D=new jQuery.Deferred();var U=new URI(a);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.inbound&&m.inbound.action==="launchURL"&&m.inbound.semanticObject==="Shell"){delete e["sap-external-url"];}var g=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=g;delete e["sap-system"];t._spliceSapSystemIntoURI(U,r.systemAlias,g,"URL").fail(D.reject.bind(D)).done(function(h){var j=h.toString(),k,p,A;A=t._getURLParsing().paramsToString(e);if(A){if(h.fragment()){p="#"+h.fragment();k=j.replace(/#.*/,"");}else{k=j;p="";}j=k+((j.indexOf("?")<0)?"?":"&")+A+p;}["additionalInformation","applicationDependencies"].forEach(function(P){if(o.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=o.resolutionResult[P];}});m.resolutionResult.url=j;m.resolutionResult.text=o.title;m.resolutionResult.applicationType="URL";D.resolve(m);});return D.promise();};C.prototype._constructFallbackResolutionResult=function(m,B,F){var D=new jQuery.Deferred(),e={},a;Object.keys(m.intentParamsPlusAllDefaults).forEach(function(p){if(jQuery.isArray(m.intentParamsPlusAllDefaults[p])){e[p]=m.intentParamsPlusAllDefaults[p];}});a=m.mappedDefaultedParamNames||m.defaultedParamNames;if(a.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(a)];}if(typeof B!=="function"){jQuery.sap.log.error("Cannot resolve hash fragment",F+" has matched an inbound that cannot be resolved client side"+" and no resolveHashFragmentFallback method was implemented in ClientSideTargetResolutionAdapter","sap.ushell.services.ClientSideTargetResolution");D.reject("Cannot resolve hash fragment: no fallback provided.");return D.promise();}jQuery.sap.log.warning("Cannot resolve hash fragment client side",F+" has matched an inbound that cannot be resolved client side. Using fallback logic","sap.ushell.services.ClientSideTargetResolution");B(F,jQuery.extend(true,{},m.inbound),e).done(function(r){["applicationType","additionalInformation","url","applicationDependencies","text"].forEach(function(p){if(r.hasOwnProperty(p)){m.resolutionResult[p]=r[p];}});D.resolve(m);}).fail(D.reject.bind(D));return D.promise();};C.prototype.getDistinctSemanticObjects=function(){var D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(o){var a={};o.getAllInbounds().forEach(function(e){if(typeof e.semanticObject==="string"&&e.semanticObject!=="*"&&!e.hideIntentLink&&e.semanticObject.length>0){a[e.semanticObject]=true;}});D.resolve(Object.keys(a).sort());},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype.getLinks=function(a){var N,t=this,e,p,g,D=new jQuery.Deferred(),o;if(arguments.length===1&&jQuery.isPlainObject(arguments[0])){N=arguments[0];o=jQuery.extend(true,{},N);["action","semanticObject"].forEach(function(A){if(N.hasOwnProperty(A)){o[A]=N[A];}});if(o.appStateKey){o.params=o.params||{};o.params["sap-xapp-state"]=[o.appStateKey];delete o.appStateKey;}}else if(arguments.length<=3){jQuery.sap.log.warning("Passing positional arguments to getLinks is deprecated","Please use nominal arguments instead","sap.ushell.services.ClientSideTargetResolution");e=arguments[0];p=arguments[1];g=arguments[2];o={semanticObject:e,params:p,ignoreFormFactor:g};}else{return D.reject("invalid arguments for getLinks").promise();}this._oInboundProvider.getInbounds().then(function(h){t._getLinks(o,h).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype._validateGetSemanticObjectLinksArgs=function(a){var e=a.semanticObject,A=a.action,g=!a.hasOwnProperty("action");if(typeof e!=="undefined"||g){if(typeof e!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a string, got "+Object.prototype.toString.call(e)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(g&&e.match(/^\s+$/)){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a non-empty string, got '"+e+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(!g&&e.length===0){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must not be an empty string, got '"+e+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}}if(typeof A!=="undefined"){if(typeof A!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the action must be a string, got "+Object.prototype.toString.call(A)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}if(A.length===0){jQuery.sap.log.error("invalid input for _getLinks","the action must not be an empty string, got '"+A+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}}return undefined;};C.prototype._getLinks=function(a,o){var e=a.semanticObject,A=a.action,p=a.params,w=!!a.withAtLeastOneUsedParam,t=!!a.treatTechHintAsFilter,g=a.ignoreFormFactor,h=a.hasOwnProperty("sortResultsBy")?a.sortResultsBy:"intent";if(a.hasOwnProperty("sortResultOnTexts")){jQuery.sap.log.warning("the parameter 'sortResultOnTexts' was experimantal and is no longer supported","getLinks results will be sorted by '"+h+"'","sap.ushell.services.ClientsideTargetResolution");}var j={bExcludeTileInbounds:true};var E=this._validateGetSemanticObjectLinksArgs(a);if(a.tags){j.tags=a.tags;}if(E){return new jQuery.Deferred().reject(E).promise();}if(e==="*"){return jQuery.when([]);}function k(U,p){var B=U.paramsToString(p);return B?"?"+B:"";}var U=this._getURLParsing(),D=new jQuery.Deferred(),F=u.getFormFactor(),m=U.parseParameters(k(U,p)),q={semanticObject:(e===""?undefined:e),action:A,formFactor:(g?undefined:F),params:m};if(t){q.treatTechHintAsFilter=true;}this._getMatchingInbounds(q,o,j).done(function(M){var r={},R=M.map(function(x){var y=e||x.inbound.semanticObject,z="#"+y+"-"+x.inbound.action,N;if(y==="*"){return undefined;}if(x.inbound.action==="*"){return undefined;}if(x.inbound&&x.inbound.hasOwnProperty("hideIntentLink")&&x.inbound.hideIntentLink===true){return undefined;}if(!r.hasOwnProperty(z)){r[z]=1;if(x.inbound.signature.additionalParameters==="ignored"){N=c.filterObjectKeys(m,function(J){return(J.indexOf("sap-")===0)||x.inbound.signature.parameters.hasOwnProperty(J);},false);}else{N=m;}if(w){var B=Object.keys(N).some(function(J){return J.indexOf("sap-")!==0;});if(!B){return undefined;}}var G={"intent":z+k(U,N),"text":x.inbound.title};if(x.inbound.icon){G.icon=x.inbound.icon;}if(x.inbound.subTitle){G.subTitle=x.inbound.subTitle;}if(x.inbound.shortTitle){G.shortTitle=x.inbound.shortTitle;}var H=jQuery.sap.getObject('inbound.signature.parameters.sap-tag.defaultValue.value',undefined,x);if(H){G.tags=[H];}return G;}else{r[z]++;}return undefined;}).filter(function(x){return typeof x==="object";});if(h!=="priority"){R.sort(function(G,x){return G[h]<x[h]?-1:1;});}if(R.length===0){jQuery.sap.log.debug("_getLinks returned no results");}else if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.DEBUG){if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.TRACE){var v=[];R.forEach(function(x){var y=x.intent.split("?")[0],L="- "+y+" ("+r[y]+") "+"text: "+x.text+" "+"intent: "+x.intent;v.push(L);});jQuery.sap.log.debug("_getLinks filtered to the following unique intents:",v.join("\n"),"sap.ushell.services.ClientSideTargetResolution");}else{jQuery.sap.log.debug("_getLinks filtered to unique intents.","Reporting histogram: "+Object.keys(r).join(", "),"sap.ushell.services.ClientSideTargetResolution");}}D.resolve(R);}).fail(D.reject.bind(D));return D.promise();};C.prototype._getMatchingInbounds=function(o,a,e){var t=this,T,A,L,g,h,E,p,D=new jQuery.Deferred();if(e){T=e.tags;E=e.bExcludeTileInbounds;}c.whenDebugEnabled(function(){L=++t._iLogId;});l.begin(function(){function j(m){var q=m.action||(typeof m.action==="undefined"?"<any>":"<invalid-value>");var r=m.semanticObject||(typeof m.semanticObject==="undefined"?"<any>":"<invalid-value>");return t._getURLParsing().constructShellHash({semanticObject:r,action:q,params:m.params});}var k=j(o);return{logId:L,title:"Matching Intent '"+k+"' to inbounds (form factor: "+(o.formFactor||'<any>')+")",moduleName:"sap.ushell.services.ClientSideTargetResolution",stages:["STAGE1: Find matching inbounds","STAGE2: Resolve references","STAGE3: Rematch with references","STAGE4: Sort matched targets"]};});h=o.semanticObject;A=o.action;g=T?a.getSegmentByTags(T):a.getSegment(h,A);if(E){p=g.filter(function(j){return!j.tileResolutionResult||!j.tileResolutionResult.isCustomTile;});}else{p=g;}s.match(o,p,{},c.isDebugEnabled()).then(function(j){l.log(function(){return{logId:L,stage:1,prefix:"\u2718",lines:Object.keys(j.noMatchReasons||{}).map(function(k){return k+" "+j.noMatchReasons[k];})};});l.log(function(){var k=j.matchResults.map(function(M){return f.formatInbound(M.inbound);});return{logId:L,stage:1,prefix:k.length>0?"\u2705":"\u2718",lines:k.length>0?k:["No inbound was matched"]};});var m=Object.keys(j.missingReferences||[]);if(m.length===0){l.log(function(){return{logId:L,stage:2,prefix:"\u2705",line:"No need to resolve references"};});return new jQuery.Deferred().resolve({matchResults:j.matchResults,referencesToInclude:null}).promise();}l.log(function(){return{logId:L,stage:2,line:"@ Must resolve the following references:",prefix:"\u2022",lines:m};});var r=new jQuery.Deferred();sap.ushell.Container.getService("ReferenceResolver").resolveReferences(m).done(function(R){l.log(function(){return{logId:L,stage:2,line:"\u2705 resolved references with the following values:",prefix:"\u2022",lines:Object.keys(R).map(function(k){return k+": '"+R[k]+"'";})};});r.resolve({matchResults:j.matchResults,referencesToInclude:R});}).fail(function(k){l.log(function(){return{logId:L,stage:2,prefix:"\u274c",line:"Failed to resolve references: "+k};});D.resolve([]);});return r.promise();}).then(function(j){var m,M,r=j.referencesToInclude;if(!r){l.log(function(){return{logId:L,stage:3,line:"rematch was skipped (no references to resolve)",prefix:"\u2705"};});return new jQuery.Deferred().resolve(j).promise();}M=j.matchResults;m=M.map(function(k){return k.inbound;});return s.match(o,m,r,0).then(function(F){l.log(function(){var M=F.matchResults||[];if(M.length>=1){return{logId:L,stage:3,line:"The following inbounds re-matched:",lines:M.map(function(k){return f.formatInbound(k.inbound);}),prefix:"\u2705"};}return{logId:L,stage:3,line:"No inbounds re-matched",prefix:"-"};});return F;});}).then(function(F){var m=F.matchResults||[];if(m.length<=1){l.log(function(){return{logId:L,stage:4,line:"Nothing to sort"};});D.resolve(m);return;}var j=s.sortMatchingResultsDeterministic(F.matchResults||[]);l.log(function(){var k=j.map(function(M){return f.formatInbound(M.inbound||{})+(M.matchesVirtualInbound?" (virtual)":"")+"\n[ Sort Criteria ] "+"\n * 1 * sap-priority: '"+M["sap-priority"]+"'"+"\n * 2 * Sort string: '"+M.priorityString+"\n * 3 * Deterministic blob: '"+s.serializeMatchingResult(M)+"'";});return{logId:L,stage:4,line:"Sorted inbounds as follows:",lines:k,prefix:".",number:true};});D.resolve(j);});return D.promise().then(function(m){l.end(function(){return{logId:L};});return m;});};C.prototype._isIntentSupportedOne=function(a,o){var D=new jQuery.Deferred(),e=this._getURLParsing().parseShellHash(a);if(a==="#"){D.resolve(true);return D.promise();}if(e===undefined){return D.reject("Could not parse shell hash '"+a+"'").promise();}e.formFactor=u.getFormFactor();this._getMatchingInbounds(e,o,{bExcludeTileInbounds:true}).done(function(t){D.resolve(t.length>0);}).fail(function(){D.reject();});return D.promise();};C.prototype.isIntentSupported=function(a){var t=this,D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(o){t._isIntentSupported(a,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype._isIntentSupported=function(a,o){var t=this,D=new jQuery.Deferred(),m={};D.resolve();function e(g,h){m[g]={supported:h};}var r=[];a.forEach(function(g){var N=t._isIntentSupportedOne(g,o);N.fail(function(E){r.push(E);});N.done(function(h){e(g,h);});D=jQuery.when(D,N);});var R=new jQuery.Deferred();D.done(function(){R.resolve(m);}).fail(function(){R.reject("One or more input intents contain errors: "+r.join(", "));});return R.promise();};C.prototype.getUserDefaultParameterNames=function(){var t=this,D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(o){var r;try{r=t._getUserDefaultParameterNames(o.getAllInbounds());D.resolve(r);}catch(e){D.reject("Cannot get user default parameters from inbounds: "+e);}},function(){D.reject.apply(D,arguments);});return D.promise();};C.prototype._getUserDefaultParameterNames=function(a){var r={simple:{},extended:{}};a.forEach(function(t){var o=t.signature&&t.signature.parameters||[];Object.keys(o).forEach(function(p){var P=o[p],R,e,g,h;if(P){if(P.filter&&P.filter.format==="reference"){g=P.filter.value;}else if(P.defaultValue&&P.defaultValue.format==="reference"){g=P.defaultValue.value;}if(typeof g==="string"){h=sap.ushell.Container.getService("ReferenceResolver");R=h.extractUserDefaultReferenceName(g);if(typeof R==="string"){r.simple[R]={};}e=h.extractExtendedUserDefaultReferenceName(g);if(typeof e==="string"){r.extended[e]={};}}}});});return r;};C.prototype.getEasyAccessSystems=function(m){var r={},a,v,D;m=m||"sapMenu";if(this._oHaveEasyAccessSystemsDeferreds[m]){return this._oHaveEasyAccessSystemsDeferreds[m].promise();}this._oHaveEasyAccessSystemsDeferreds[m]=new jQuery.Deferred();D=this._oHaveEasyAccessSystemsDeferreds[m];function e(o,g,v){return o&&o.semanticObject&&o.semanticObject==="Shell"&&o.action&&v[m][o.action]&&o.deviceTypes&&g!==undefined&&o.deviceTypes[g];}a={startGUI:{priority:3,appType:"TR"},startWDA:{priority:2,appType:"WDA"},startURL:{priority:1,appType:"URL"}};v={userMenu:{startGUI:true,startWDA:true,startURL:true},sapMenu:{startGUI:true,startWDA:true,startURL:false}};this._oInboundProvider.getInbounds().then(function(o){var L={};o.getAllInbounds().filter(function(g){return e(g,u.getFormFactor(),v);}).forEach(function(E){var g;if(jQuery.isPlainObject(E.signature.parameters["sap-system"])&&E.signature.parameters["sap-system"].hasOwnProperty("filter")){g=jQuery.sap.getObject("signature.parameters.sap-system.filter.value",undefined,E);}if(typeof g==="string"){var h=a[E.action].priority;var j=a[E.action].appType;if(!r[g]){L[g]=-1;r[g]={appType:{}};}if(L[g]<h){r[g].text=E.title;L[g]=h;}r[g].appType[j]=true;}else{jQuery.sap.log.warning("Cannot extract sap-system from easy access menu inbound: "+f.formatInbound(E),"This parameter is supposed to be a string. Got '"+g+"' instead.","sap.ushell.services.ClientSideTargetResolution");}});D.resolve(r);},function(){D.reject.apply(D,arguments);});return D.promise();};C.hasNoAdapter=false;return C;},true);
