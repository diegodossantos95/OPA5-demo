// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils"],function(u){"use strict";function A(){var m={},a=true,c=null,C=null,I=[],b=[];sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",d,this);function d(f,E,D){a=false;C=D;if(b.length){for(var i=0;i<b.length;i++){b[i]();}b.length=0;}}this.addActivity=function(r){var U=sap.ushell.Container.getService("UserRecents");return U.addActivity(r);};this.setApplicationInInitMode=function(){a=true;};this.getApplicationRequestQueue=function(){return b;};this.getCurrentAppliction=function(o){return c;};this.getCurrentApplication=this.getCurrentAppliction;this.getMetadata=function(o){if(!o){o=c;}if(o){var h=hasher&&hasher.getHash?hasher.getHash():'',k=this._processKey(h);if(!(m.hasOwnProperty(k))||!m[k].complete){this.addMetadata(o,k);}if(!m[k]){m[k]={complete:false};}if(!m[k].title){m[k].title=o.text||sap.ushell.resources.i18n.getText("default_app_title");}return m[k];}return{};};this._processKey=function(f){var i=f.split('?')[0],p=f.split('?')[1],S,P={},g,h='',j='',o;if(p){S=p.split('&');S.forEach(function(k){var l=k.split('=');P[l[0]]=l[1];});g=Object.keys(P).sort();g.forEach(function(k,l){j=l?'&':'?';h+=j+k+'='+P[k];});return i+h;}o=sap.ushell.Container.getService("URLParsing").parseShellHash(f);i=o?o.semanticObject+"-"+o.action:"";return i;};this.setCurrentApplication=function(o){c=o;if(b.length){b.length=0;}};this.setHeaderHiding=function(h){if(sap.ui.Device.system.phone){if(c===C){s(h);}else{b.push(function(){s(h);});}}else{jQuery.sap.log.warning("Application configuration could not be trigger setHeaderHiding on Shell as the running device is not a phone");}};function s(h){var r=sap.ushell.Container.getRenderer("fiori2");if(r){r.setHeaderHiding(h);}}this.addApplicationSettingsButtons=function(B){if(a){b.push(function(){e(B);});}else{e(B);}};function e(B){var i,f=[],r=sap.ushell.Container.getRenderer("fiori2");for(i=0;i<B.length;i++){var o=B[i];f.push(o.getId());o.setIcon(o.getIcon()||sap.ui.core.IconPool.getIconURI('customize'));if(sap.ushell.resources.i18n.getText("userSettings")===o.getProperty("text")){o.setProperty("text",sap.ushell.resources.i18n.getText("userAppSettings"));}o.setType(sap.m.ButtonType.Unstyled);}if(sap.ushell.Container&&r){if(I.length){r.hideActionButton(I,true);}I=f;r.showActionButton(f,true,undefined,true);}}this.setWindowTitle=function(t){window.document.title=t;};this.setIcons=function(i){jQuery.sap.setIcons(i);};this.setApplicationFullWidth=function(v){var V=sap.ui.getCore().byId("viewPortContainer");V.setApplicationFullWidth(v);};this.getSettingsControlAsync=function(){var D=new jQuery.Deferred();sap.ui.require(["sap/ushell/ui/footerbar/SettingsButton"],function(S){D.resolve(new S());});return D.promise();};this.getSettingsControl=function(){var S="sap/ushell/ui/footerbar/SettingsButton",o="sap.ushell.ui.footerbar.SettingsButton",f=sap.ui.require(S);if(f){return new f();}jQuery.sap.require(o);f=jQuery.sap.getObject(o);return new f();};this.getApplicationName=function(o){var M,f=(o&&o.additionalInformation)||null;if(f){M=/^SAPUI5\.Component=(.+)$/i.exec(f);if(M){return M[1];}}return null;};this.getApplicationUrl=function(o){var U=(o&&o.url)||null,S="P_TCODE",i;if(U){if(o.applicationType==="NWBC"&&U.indexOf(S)){return U;}i=U.indexOf("?");if(i>=0){U=U.slice(0,i);}if(U.slice(-1)!=='/'){U+='/';}}return U;};this.getPropertyValueFromConfig=function(o,p,r){var v;if(r&&o.hasOwnProperty(p+"Resource")){v=r.getText(o[p+"Resource"]);}else if(o.hasOwnProperty(p)){v=o[p];}return v;};this.getPropertyValueFromManifest=function(l,p,P){var M=p[P].manifestEntryKey,f=p[P].path,o=l.getManifestEntry(M);return jQuery.sap.getObject(f,undefined,o);};this.addMetadata=function(o,k){try{var f=this.getApplicationName(o),U=this.getApplicationUrl(o),l,g,p={"fullWidth":{"manifestEntryKey":"sap.ui","path":"fullWidth"},"hideLightBackground":{"manifestEntryKey":"sap.ui","path":"hideLightBackground"},"title":{"manifestEntryKey":"sap.app","path":"title"},"icon":{"manifestEntryKey":"sap.ui","path":"icons.icon"},"favIcon":{"manifestEntryKey":"sap.ui","path":"icons.favIcon"},"homeScreenIconPhone":{"manifestEntryKey":"sap.ui","path":"icons.phone"},"homeScreenIconPhone@2":{"manifestEntryKey":"sap.ui","path":"icons.phone@2"},"homeScreenIconTablet":{"manifestEntryKey":"sap.ui","path":"icons.tablet"},"homeScreenIconTablet@2":{"manifestEntryKey":"sap.ui","path":"icons.tablet@2"},"startupImage320x460":{"manifestEntryKey":"sap.ui","path":"icons.startupImage640x920"},"startupImage640x920":{"manifestEntryKey":"sap.ui","path":"icons.startupImage640x920"},"startupImage640x1096":{"manifestEntryKey":"sap.ui","path":"icons.startupImage640x1096"},"startupImage768x1004":{"manifestEntryKey":"sap.ui","path":"icons.startupImage768x1004"},"startupImage748x1024":{"manifestEntryKey":"sap.ui","path":"icons.startupImage748x1024"},"startupImage1536x2008":{"manifestEntryKey":"sap.ui","path":"icons.startupImage1536x2008"},"startupImage1496x2048":{"manifestEntryKey":"sap.ui","path":"icons.startupImage1496x2048"},"compactContentDensity":{"manifestEntryKey":"sap.ui5","path":"contentDensities.compact"},"cozyContentDensity":{"manifestEntryKey":"sap.ui5","path":"contentDensities.cozy"}},h,i,j,M,P,n,r,q=o&&o.componentHandle;if(k){if(!(m.hasOwnProperty(k))){m[k]={complete:false};}if(!m[k].complete){if(q){l=q.getMetadata();}else if(f){jQuery.sap.log.warning("No component handle available for '"+f+"'; SAPUI5 component metadata is incomplete",null,"sap.ushell.services.AppConfiguration");return;}if(l){g=l.getConfig();M=(l.getManifest()!==undefined);m[k].complete=true;if(g){n=g.resourceBundle||"";if(n){if(n.slice(0,1)!=='/'){n=U+n;}r=jQuery.sap.resources({url:n,locale:sap.ui.getCore().getConfiguration().getLanguage()});}}for(P in p){if(p.hasOwnProperty(P)){if(M){m[k][P]=this.getPropertyValueFromManifest(l,p,P);}if(g&&m[k][P]===undefined){m[k][P]=this.getPropertyValueFromConfig(g,P,r);}}}m[k].version=l.getVersion();m[k].libraryName=l.getLibraryName();}else if(u.isApplicationTypeNWBCRelated(o.applicationType)){var w="/~canvas;window=app/wda/",t=o.url.indexOf(w),W="/bc/gui/sap/its/webgui",v=o.url.indexOf(W);if(t>=0){m[k].libraryName=o.url.substring((t+w.length),o.url.indexOf("/",(t+w.length)));}m[k].complete=true;if(v>=0){var E="etransaction=",x=o.url.indexOf(E,v+W.length),y=o.url.indexOf("&",x),z=(y>=0)?y:o.url.length;m[k].libraryName=o.url.substring(x+E.length,z)+" (TCODE)";}}else{jQuery.sap.log.warning("No technical information for the given application could be determined",null,"sap.ushell.services.AppConfiguration");}}h=["favIcon","homeScreenIconPhone","homeScreenIconPhone@2","homeScreenIconTablet","homeScreenIconTablet@2","startupImage320x460","startupImage640x920","startupImage640x1096","startupImage768x1004","startupImage748x1024","startupImage1536x2008","startupImage1496x2048"];i=(U&&U[U.length-1]==='/')?U.substring(0,U.length-1):U;j=function(U){if(U.match(/^https?:\/\/.*/)){return false;}return U&&U[0]!=='/';};h.forEach(function(D){var O=m[k][D],F=null;if(O){F=j(O)?i+"/"+O:O;}m[k][D]=F;});}}catch(B){jQuery.sap.log.warning("Application configuration could not be parsed");}};}return new A();},true);
