// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/utils','sap/ushell/System','sap/ushell/Ui5ServiceFactory','sap/ui/core/service/ServiceFactoryRegistry'],function(u,S,U,a){"use strict";var b="sap.ushell.services.Container",c="sap.ushell.Container.dirtyState.",C,p,f;function d(){close();}function r(){document.location="about:blank";}function g(P){if(p&&p[P]){return p[P];}return"sap.ushell.adapters."+P;}function h(s){return(C.services&&C.services[s])||{};}function j(n,s,P){var A=h(n).adapter||{},e=A.module||g(s.getPlatform())+"."+n+"Adapter";jQuery.sap.require(e);return new(jQuery.sap.getObject(e))(s,P,{config:A.config||{}});}function k(A){var E=new sap.ui.base.EventProvider(),m=false,R=[],o={},s="sap.ushell.Container."+A.getSystem().getPlatform()+".remoteSystem.",n={},G,q,L=u.getLocalStorage(),t=new u.Map(),v="sap.ushell.Container."+A.getSystem().getPlatform()+".sessionTermination",w=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelXHRLogon();}};this.createRenderer=function(e){var i,z,B,D,F;jQuery.sap.measure.start("FLP:Container.InitLoading","Initial Loading","FLP");e=e||C.defaultRenderer;if(!e){throw new Error("Missing renderer name");}F=(C.renderers&&C.renderers[e])||{};z=F.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);jQuery.sap.require(z);if(F.componentData&&F.componentData.config){i={config:F.componentData.config};}B=new(jQuery.sap.getObject(z))({componentData:i});if(B instanceof sap.ui.core.UIComponent){D=new sap.ui.core.ComponentContainer({component:B,height:"100%",width:"100%"});}else{D=B;}if(!(D instanceof sap.ui.core.Control)){throw new Error("Unsupported renderer type for name "+e);}o[e]=D;E.fireEvent("rendererCreated",{renderer:B});return D;};this.getRenderer=function(e){var i,z;e=e||C.defaultRenderer;if(e){i=o[e];}else{z=Object.keys(o);if(z.length===1){i=o[z[0]];}else{jQuery.sap.log.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",undefined,b);}}if(i instanceof sap.ui.core.ComponentContainer){return i.getComponentInstance();}return i;};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var i,D=new jQuery.Deferred(),z=jQuery.sap.uid(),B,P=0,F=this.DirtyState.CLEAN;function H(){if(P===0||F===w.DirtyState.DIRTY){D.resolve(F);jQuery.sap.log.debug("getGlobalDirty() Resolving: "+F,null,"sap.ushell.Container");}}function I(J){if(J.key.indexOf(c)===0&&J.newValue!==w.DirtyState.INITIAL&&J.newValue!==w.DirtyState.PENDING){jQuery.sap.log.debug("getGlobalDirty() Receiving event key: "+J.key+" value: "+J.newValue,null,"sap.ushell.Container");if(J.newValue===w.DirtyState.DIRTY||J.newValue===w.DirtyState.MAYBE_DIRTY){F=J.newValue;}P-=1;H();}}try{L.setItem(z,"CHECK");L.removeItem(z);}catch(e){jQuery.sap.log.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return D.resolve(this.DirtyState.MAYBE_DIRTY).promise();}if(G){throw new Error("getGlobalDirty already called!");}G=D;window.addEventListener('storage',I);D.always(function(){window.removeEventListener('storage',I);G=undefined;});for(i=L.length-1;i>=0;i-=1){B=L.key(i);if(B.indexOf(c)===0){if(L.getItem(B)==='PENDING'){L.removeItem(B);jQuery.sap.log.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+B,null,"sap.ushell.Container");}else{P+=1;u.localStorageSetItem(B,this.DirtyState.PENDING,true);jQuery.sap.log.debug("getGlobalDirty() Requesting status for: "+B,null,"sap.ushell.Container");}}}H();setTimeout(function(){if(D.state()!=="resolved"){D.resolve('MAYBE_DIRTY');jQuery.sap.log.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container");}},P*2000);return D.promise();};this.getLogonSystem=function(){return A.getSystem();};this.getUser=function(){return A.getUser();};this.getDirtyFlag=function(){for(var i=0;i<R.length;i++){m=m||R[i].call();}return m;};this.setDirtyFlag=function(i){m=i;};this.sessionKeepAlive=function(){if(A.sessionKeepAlive){A.sessionKeepAlive();}};this.registerDirtyStateProvider=function(D){if(typeof D!=="function"){throw new Error("fnDirty must be a function");}R.push(D);};this.getService=function(e,P){var i={},M,K,z,B,D,F,H,I;function J(N){var O=new jQuery.Deferred();if(!N){throw new Error("Missing system");}O.resolve(j(e,N,P));sap.ushell.Container.addRemoteSystem(N);return O.promise();}if(!e){throw new Error("Missing service name");}if(e.indexOf(".")>=0){throw new Error("Unsupported service name");}H=h(e);M=H.module||"sap.ushell.services."+e;K=M+"/"+(P||"");I={config:H.config||{}};if(!t.containsKey(K)){z=sap.ui.requireSync(M.replace(/[.]/g,"/"));if(z.hasNoAdapter){B=new z(i,P,I);}else{F=j(e,A.getSystem(),P);i.createAdapter=J;B=new z(F,i,P,I);}t.put(K,B);return B;}return t.get(K);};function x(){var z,B,i,K;for(i=L.length-1;i>=0;i-=1){K=L.key(i);if(K.indexOf(s)===0){try{z=K.substring(s.length);B=JSON.parse(L.getItem(K));n[z]=new S(B);}catch(e){L.removeItem(K);}}}return n;}function y(){function e(i,z,F){jQuery.sap.log.warning(i,null,"sap.ushell.Container");if(F){setTimeout(F.bind(null,i),5000);}return{abort:function(){return;}};}OData.read=function(i,z,F){return e("OData.read('"+(i&&i.Uri?i.requestUri:i)+"') disabled during logout processing",z,F);};OData.request=function(i,z,F){return e("OData.request('"+(i?i.requestUri:"")+"') disabled during logout processing",z,F);};}this.addRemoteSystem=function(e){var i=e.getAlias(),O=n[i];if(O){if(O.toString()===e.toString()){return;}jQuery.sap.log.warning("Replacing "+O+" by "+e,null,"sap.ushell.Container");}else{jQuery.sap.log.debug("Added "+e,null,"sap.ushell.Container");}n[i]=e;u.localStorageSetItem(s+i,e);};this.addRemoteSystemForServiceUrl=function(e){var M,i={baseUrl:";o="};if(!e||e.charAt(0)!=='/'||e.indexOf('//')===0){return;}M=/^[^?]*;o=([^\/;?]*)/.exec(e);if(M&&M.length>=2){i.alias=M[1];}e=e.replace(/;[^\/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){i.platform="hana";i.alias=i.alias||"hana";}else if(/^\/sap\/opu\//.test(e)){i.platform="abap";}if(i.alias&&i.platform){this.addRemoteSystem(new S(i));}};this.attachLogoutEvent=function(F){E.attachEvent("Logout",F);};this.detachLogoutEvent=function(F){E.detachEvent("Logout",F);};this.attachRendererCreatedEvent=function(F){E.attachEvent("rendererCreated",F);};this.detachRendererCreatedEvent=function(F){E.detachEvent("rendererCreated",F);};this.logout=function(){var D=new jQuery.Deferred();function i(){A.logout(true).always(function(){L.removeItem(v);D.resolve();});}function z(){if(E.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}function B(){var n,F=[];if(q){window.removeEventListener('storage',q);}u.localStorageSetItem(v,"pending");w._suppressOData();n=w._getRemoteSystems();Object.keys(n).forEach(function(H){try{F.push(j("Container",n[H]).logout(false));}catch(e){jQuery.sap.log.warning("Could not create adapter for "+H,e.toString(),"sap.ushell.Container");}L.removeItem(s+H);});jQuery.when.apply(jQuery,F).done(z);}if(typeof A.addFurtherRemoteSystems==='function'){A.addFurtherRemoteSystems().always(B);}else{B();}return D.promise();};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.setLogonFrameProvider(e);}};this.setXhrLogonTimeout=function(P,T){if(this.oFrameLogonManager){this.oFrameLogonManager.setTimeout(P,T);}};this._closeWindow=d;this._redirectWindow=r;this._getRemoteSystems=x;this._suppressOData=y;sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,i,D){w.addRemoteSystemForServiceUrl(D);});if(typeof A.logoutRedirect==='function'){q=function(e){function i(){w._closeWindow();w._redirectWindow();}if(sap.ushell.Container!==w){return;}if(e.key.indexOf(s)===0&&e.newValue&&e.newValue!==L.getItem(e.key)){u.localStorageSetItem(e.key,e.newValue);}if(e.key===v){if(e.newValue==="pending"){w._suppressOData();if(E.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}}};window.addEventListener('storage',q);}}function l(s){s.forEach(function(e){var o=U.createServiceFactory(e);a.register("sap.ushell.ui5service."+e,o);});}sap.ushell.bootstrap=function(P,A){var o,e;if(sap.ushell.Container!==undefined){e=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+f);jQuery.sap.log.error(e,e.stack,b);throw e;}sap.ushell.Container=null;f=(new Error()).stack;C=jQuery.extend({},true,window["sap-ushell-config"]||{});p=A;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"]);}if(C.modulePaths){Object.keys(C.modulePaths).forEach(function(m){jQuery.sap.registerModulePath(m,C.modulePaths[m]);});}o=j("Container",new S({alias:"",platform:C.platform||P}));l(["Personalization","URLParsing","CrossApplicationNavigation"]);return o.load().then(function(){var i,m,n;var D,L;sap.ushell.Container=new k(o);m=sap.ushell.Container;L=(function(){var q,s;var t=window["sap-ushell-config"];if(!t||!t.services){return false;}q=t.services.PluginManager;s=q&&q.config;return s&&s.loadPluginsFromSite;})();if(L){i=m.getService("CommonDataModel");D=i.getPlugins();}else{D=jQuery.when({});}return D.then(function(q){var s=jQuery.extend(true,{},C.bootstrapPlugins,q);n=m.getService("PluginManager");n.registerPlugins(s);});});};});
