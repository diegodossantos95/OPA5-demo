// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_CommonDataModel/PersonalizationProcessor","sap/ushell/services/ClientSideTargetResolution"],function(P){"use strict";var S="sap.ushell.services.CommonDataModel";function C(a,c,p,s){var t=this,o=new jQuery.Deferred();function f(m){o.reject(m);}this._oAdapter=a;this._oPersonalizationProcessor=new P();this._oSitePromise=o.promise();this._oContentProviderIndex={};a.getSite().done(function(b){t._oOriginalSite=jQuery.extend(true,{},b);a.getPersonalization().done(function(d){t._oPersonalizationProcessor.mixinPersonalization(b,d).done(function(e){t._oPersonalizedSite=t._ensureCompleteSite(e);o.resolve(t._oPersonalizedSite);}).fail(f);}).fail(f);}).fail(f);}C.prototype.getHomepageGroups=function(){var d=new jQuery.Deferred();this._oSitePromise.then(function(s){var g=(s&&s.site&&s.site.payload&&s.site.payload.groupsOrder)?s.site.payload.groupsOrder:[];d.resolve(g);});return d.promise();};C.prototype.getGroups=function(){var d=new jQuery.Deferred();this._oSitePromise.then(function(s){var g=[];Object.keys(s.groups).forEach(function(k){g.push(s.groups[k]);});d.resolve(g);});return d.promise();};C.prototype.getGroup=function(i){var d=new jQuery.Deferred();this._oSitePromise.then(function(s){var g=s.groups[i];if(g){d.resolve(g);}else{d.reject("Group "+i+" not found");}});return d.promise();};C.prototype.getSite=function(){return this._oSitePromise;};C.prototype.getGroupFromOriginalSite=function(g){var d=new jQuery.Deferred();if(typeof g==="string"&&this._oOriginalSite&&this._oOriginalSite.groups&&this._oOriginalSite.groups[g]){d.resolve(jQuery.extend(true,{},this._oOriginalSite.groups[g]));}else{d.reject("Group does not exist in original site.");}return d.promise();};C.prototype.save=function(){var d=new jQuery.Deferred(),t=this;this._oPersonalizationProcessor.extractPersonalization(this._oPersonalizedSite,this._oOriginalSite).done(function(e){if(e){t._oAdapter._storePersonalizationData(e).done(function(){d.resolve();}).fail(function(m){d.reject(m);});}else{d.resolve();}});return d.promise();};function l(){var p=sap.ushell.Container.getService("PluginManager");return p.loadPlugins("ContentProvider");}C.prototype._getUnreferencedCatalogApplications=function(e){var u={};var a=Object.keys(e.applications).map(function(A){return e.applications[A]["sap.app"].id;}).reduce(function(i,A){i[A]=true;return i;},{});var c=e.catalogs;Object.keys(c).forEach(function(s){var A=c[s].payload.appDescriptors;A.map(function(o){return o.id;}).filter(function(b){return!a[b];}).forEach(function(b){if(!u.hasOwnProperty(s)){u[s]={};}u[s][b]=true;});});return u;};C.prototype._formatUnreferencedApplications=function(c,u){return"One or more apps from "+c+" content provider are not listed among the applications section of the extended site and will be discarded - "+Object.keys(u).map(function(s){var b=Object.keys(u[s]).map(function(U){return"'"+U+"'";});return"From catalog '"+s+"': "+b.join(", ");}).join("; ");};C.prototype._removeUnreferencedApplications=function(e,u){Object.keys(e.catalogs).forEach(function(c){var o=e.catalogs[c].payload;var a=o.appDescriptors;o.appDescriptors=a.filter(function(A){return u[c]&&!u[c][A.id];});});};C.prototype.getExtensionSites=function(){var t=this;var d=new jQuery.Deferred();l().done(function(){var c=Object.keys(t._oContentProviderIndex),T=c.length;if(T===0){d.resolve([]);return;}var g=c.map(function(s,i){var o=t._oContentProviderIndex[s];var G;try{G=o.getSite();if(!G||typeof G.then!=="function"){throw"getSite does not return a Promise";}}catch(e){G=Promise.reject("call to getSite failed: "+e);}return G.then(function(s,E){var a=jQuery.extend(true,{},E);var u=t._getUnreferencedCatalogApplications(E);if(Object.keys(u).length>0){var b=t._formatUnreferencedApplications(s,u);jQuery.sap.log.error(b,null,S);t._removeUnreferencedApplications(a,u);}var L={providerId:s,success:true,site:a};d.notify(L);return L;}.bind(null,s),function(s,E){return{providerId:s,success:false,error:E};}.bind(null,s));});Promise.all(g).then(function(L){d.resolve(L);});});return d.promise();};C.prototype.registerContentProvider=function(i,s){if(this._oContentProviderIndex[i]){jQuery.sap.log.error("a content provider with ID '"+i+"' is already registered",null,S);return;}this._oContentProviderIndex[i]=s;jQuery.sap.log.debug("ContentProvider '"+i+"' was registered",null,S);};C.prototype._ensureCompleteSite=function(p){if(p.groups){var g=p.groups;Object.keys(g).forEach(function(k){if(!g[k]){delete g[k];}else{if(!g[k].payload){g[k].payload={};}if(!g[k].payload.links){g[k].payload.links=[];}if(!g[k].payload.tiles){g[k].payload.tiles=[];}if(!g[k].payload.groups){g[k].payload.groups=[];}}});}return p;};C.prototype.getPlugins=(function(){var d,e,p;e=function(s,o){var a,n=Object.keys(o).length;if(n===0){return{};}if(!o.hasOwnProperty("Shell-plugin")){jQuery.sap.log.error("Cannot find inbound with id 'Shell-plugin' for plugin '"+s+"'","plugin startup configuration cannot be determined correctly",S);return{};}if(n>1){jQuery.sap.log.warning("Multiple inbounds are defined for plugin '"+s+"'","plugin startup configuration will be determined using "+"the signature of 'Shell-plugin' inbound.",S);}a=jQuery.sap.getObject("signature.parameters",undefined,o["Shell-plugin"])||{};return Object.keys(a).reduce(function(r,N){var D=jQuery.sap.getObject(N+".defaultValue.value",undefined,a);if(typeof D==="string"){r[N]=D;}return r;},{});};d=function(o){Object.keys(o).filter(function(s){return typeof o[s]==="object";}).forEach(function(s){o[s]=d(o[s]);});return Object.freeze(o);};return function(o){if(o!==undefined){p=o;}if(p){return jQuery.when(p);}p={};return this.getSite().then(function(s){var a=s.applications||{};Object.keys(a).filter(function(A){return"plugin"===jQuery.sap.getObject("type",undefined,this[A]["sap.flp"]);},a).forEach(function(b){var c,f,g=this[b],h={};if(!jQuery.isPlainObject(g["sap.platform.runtime"])){jQuery.sap.log.error("Cannot find 'sap.platform.runtime' section for plugin '"+b+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel");}else if(!jQuery.isPlainObject(g["sap.platform.runtime"].componentProperties)){jQuery.sap.log.error("Cannot find 'sap.platform.runtime/componentProperties' section for plugin '"+b+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel");}else{h=g["sap.platform.runtime"].componentProperties;}p[b]={url:h.url,component:g["sap.ui5"].componentName};var i=jQuery.sap.getObject("crossNavigation.inbounds",undefined,g["sap.app"])||{};f=e(b,i);c=jQuery.extend(h.config||{},f);if(c){p[b].config=c;}if(h.asyncHints){p[b].asyncHints=h.asyncHints;}},a);return d(p);},function(E){return E;});};})();C.hasNoAdapter=false;return C;},true);
