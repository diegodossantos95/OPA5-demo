// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define([],function(){"use strict";var S="sap.ushell.services.PluginManager",a="sap-ushell-plugin-type",b="RendererExtensions",s=[b,"UserDefaults","UserImage","ContentProvider"];function P(){var t=this;this._oPluginCollection={};this._oCategoryLoadingProgress={};this._mInitializedComponentPromise={};s.forEach(function(p){t._oPluginCollection[p]={};t._oCategoryLoadingProgress[p]=new jQuery.Deferred();});this._handlePluginCreation=function(c,p,o){var t=this,d=(t._oPluginCollection[c])[p];try{if(d.hasOwnProperty("component")){if(t._mInitializedComponentPromise.hasOwnProperty(d.component)){t._mInitializedComponentPromise[d.component].then(function(){t._instantiateComponent(d,o);},function(){t._instantiateComponent(d,o);});}else{t._mInitializedComponentPromise[d.component]=t._instantiateComponent(d,o);}}else{jQuery.sap.log.error("Invalid plugin configuration. The plugin "+p+" must contain a <component> key",S);}}catch(e){jQuery.sap.log.error("Error while loading bootstrap plugin: "+d.component||"",S);if(o){o.reject(e);}}};this._getFileNameForXhrAuth=function(){return"Component-preload.js";};this._handleXhrAuthentication=function(A,c){var x;if(A&&["true",true,"X"].indexOf(A["sap-ushell-xhr-authentication"])>-1){if(!c){jQuery.sap.log.error(["Illegal state: configuration parameter 'sap-ushell-xhr-authentication-timeout' set, but no component URL specified.","XHR authentication request will not be sent. Please check the target mapping definitions for plug-ins","and the application index."].join(" "),undefined,S);return jQuery.when();}if(A.hasOwnProperty("sap-ushell-xhr-authentication-timeout")){x=parseInt(A["sap-ushell-xhr-authentication-timeout"],10);if(isNaN(x)){jQuery.sap.log.error(["Invalid value for configuration parameter 'sap-ushell-xhr-authentication-timeout' for plug-in component with URL '",c,"': '",A["sap-ushell-xhr-authentication-timeout"],"' is not a number. Timeout will be ignored."].join(""),undefined,S);}else{sap.ushell.Container.setXhrLogonTimeout(c,x);}}return jQuery.ajax(c+"/"+this._getFileNameForXhrAuth());}else{return jQuery.when();}};this._instantiateComponent=function(p,o){var d=new jQuery.Deferred(),c=jQuery.extend(true,{},p),A={ui5ComponentName:c.component,url:c.url};function g(e){return function(E){e=e||"Cannot create UI5 plugin component: (componentId/appdescrId :"+A.ui5ComponentName+")\n"+E+" properties "+JSON.stringify(A)+"\n This indicates a plugin misconfiguration, see e.g. Note 2316443.";E=E||"";jQuery.sap.log.error(e,E.stack,S);if(o){o.reject.apply(this,arguments);}d.reject.apply(this,arguments);};}function l(){sap.ushell.Container.getService("Ui5ComponentLoader").createComponent(A).done(function(L){if(o){o.resolve();}d.resolve.apply(this,arguments);}).fail(g());}c.name=c.component;delete c.component;A.applicationDependencies=c;if(c.config){A.applicationConfiguration=c.config;delete c.config;}A.loadDefaultDependencies=false;this._handleXhrAuthentication(A.applicationConfiguration,c.url).done(l).fail(g("XHR logon for FLP plugin failed"));return d.promise();};this.getSupportedPluginCategories=function(){return jQuery.extend(true,[],s);};this.getRegisteredPlugins=function(){return jQuery.extend(true,{},this._oPluginCollection);};this.registerPlugins=function(p){var t=this,c,o;if(!p){return;}sap.ushell.utils.addTime("PluginManager.registerPlugins");Object.keys(p).sort().forEach(function(d){c=p[d]||{};o=c.config||{};if(c.enabled===false){return;}if(c.enabled===undefined){c.enabled=true;}if(c&&c.hasOwnProperty("module")){jQuery.sap.log.error("Plugin "+d+" cannot get registered, because the module mechanism for plugins is not valid anymore. Plugins need to be defined as SAPUI5 components.",S);jQuery.sap.require(c.module);return;}if(o&&o.hasOwnProperty(a)){if(jQuery.inArray(o[a],s)!==-1){(t._oPluginCollection[o[a]])[d]=jQuery.extend(true,{},p[d]);}else{jQuery.sap.log.warning("Plugin "+d+" will not be inserted into the plugin collection of the PluginManager, because of unsupported category "+o[a],S);}}else{(t._oPluginCollection[b])[d]=jQuery.extend(true,{},p[d]);}});};this.getPluginLoadingPromise=function(p){if(this._oCategoryLoadingProgress.hasOwnProperty(p)){return this._oCategoryLoadingProgress[p].promise();}};this.loadPlugins=function(p){var t=this,c,o;sap.ushell.utils.addTime("PluginManager.startLoadPlugins["+p+"]");if(jQuery.inArray(p,s)!==-1){if(t._oCategoryLoadingProgress[p].pluginLoadingTriggered!==undefined){return t._oCategoryLoadingProgress[p].promise();}else{t._oCategoryLoadingProgress[p].pluginLoadingTriggered=true;}if(Object.keys(t._oPluginCollection[p]).length>0){c=[];Object.keys(t._oPluginCollection[p]).forEach(function(d){o=new jQuery.Deferred();c.push(o.promise());t._handlePluginCreation(p,d,o);});jQuery.when.apply(undefined,c).done(function(){sap.ushell.utils.addTime("PluginManager.endLoadPlugins["+p+"]");t._oCategoryLoadingProgress[p].resolve();}).fail(t._oCategoryLoadingProgress[p].reject.bind());}else{t._oCategoryLoadingProgress[p].resolve();}}else{jQuery.sap.log.error("Plugins with category "+p+" cannot be loaded by the PluginManager",S);t._oCategoryLoadingProgress[p].reject("Plugins with category "+p+" cannot be loaded by the PluginManager");}return t._oCategoryLoadingProgress[p].promise();};};P.hasNoAdapter=true;return P;},true);
