// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.ui5service.ShellUIService");jQuery.sap.require("sap.ui.core.service.ServiceFactoryRegistry");jQuery.sap.require("sap.ui.core.service.ServiceFactory");jQuery.sap.require("sap.ui.base.EventProvider");jQuery.sap.require("sap.ui.thirdparty.hasher");var l;var e=new sap.ui.base.EventProvider();var O={hierarchyChanged:"hierarchyChanged",relatedAppsChanged:"relatedAppsChanged",titleChanged:"titleChanged",backNavigationChanged:"backNavigationChanged"};var a;sap.ui.core.service.Service.extend("sap.ushell.ui5service.ShellUIService",{init:function(){var t=this,p=this.getInterface();p.init=function(){t._amendPublicServiceInstance.call(t,this);};sap.ui.core.service.ServiceFactoryRegistry.register("sap.ushell.ui5service.ShellUIService",new sap.ui.core.service.ServiceFactory(p));},_setActiveComponentId:function(i){a=i;},_getActiveComponentId:function(){return a;},_shouldEnableAutoHierarchy:function(A){return typeof A.getManifestEntry==="function"&&A.getManifestEntry("/sap.ui5/services/ShellUIService/settings/setHierarchy")==="auto";},_shouldEnableAutoTitle:function(A){return typeof A.getManifestEntry==="function"&&A.getManifestEntry("/sap.ui5/services/ShellUIService/settings/setTitle")==="auto";},_enableAutoHierarchy:function(A){var t=this;var r=A.getRouter&&A.getRouter();if(!r){jQuery.sap.log.error("Could not enable automatic setHierarchy on the current app","Router could not be obtained on the app root component via getRouter","sap.ushell.ui5service.ShellUIService");return;}r.attachTitleChanged(function(E){var h=E.getParameter("history");t.setHierarchy(h.reverse().map(function(u){var s=t._getCurrentShellHashWithoutAppRoute();return{title:u.title,intent:s+"&/"+u.hash};}));});},_enableAutoTitle:function(A){var t=this;var r=A.getRouter&&A.getRouter();if(!r){jQuery.sap.log.error("Could not enable automatic setTitle on the current app","Router could not be obtained on the app root component via getRouter","sap.ushell.ui5service.ShellUIService");return;}var T=r.getTitleHistory()[0];if(T&&T.title){setTimeout(function(){t.setTitle(T.title);},0);}r.attachTitleChanged(function(E){var s=E.getParameter("title");t.setTitle(s);});},_getCurrentShellHashWithoutAppRoute:function(){var f="#"+hasher.getHash();var u=sap.ushell.Container.getService("URLParsing");var U=u.getShellHash(f);if(!U){jQuery.sap.log.error("Cannot get the current shell hash","URLParsing service returned a falsy value for "+f,"sap.ushell.ui5service.ShellUIService");return"";}return"#"+U;},_getEventProvider:function(){return e;},_getLastSetTitle:function(){return l;},_ensureArrayOfObjectOfStrings:function(A,m){var v=jQuery.isArray(A)&&A.every(function(o){return jQuery.isPlainObject(o)&&Object.keys(o).length>0&&Object.keys(o).every(function(k){return typeof o[k]==="string";});});if(!v){jQuery.sap.log.error("'"+m+"' was called with invalid parameters","An array of non-empty objects with string values is expected","sap.ushell.ui5service.ShellUIService");}return v;},_ensureFunction:function(A,m){var t=typeof A;if(t!=="function"){jQuery.sap.log.error("'"+m+"' was called with invalid arguments","the parameter should be a function, got '"+t+"' instead","sap.ushell.ui5service.ShellUIService");return false;}return true;},_ensureString:function(A,m){var t=typeof A;if(t!=="string"){jQuery.sap.log.error("'"+m+"' was called with invalid arguments","the parameter should be a string, got '"+t+"' instead","sap.ushell.ui5service.ShellUIService");return false;}return true;},_addCallAllowedCheck:function(p,P){var t=this;p[P]=function(){var c=p.getContext();if(!c||c.scopeObject.getId()!==a){jQuery.sap.log.warning("Call to "+P+" is not allowed","This may be caused by an app component other than the active '"+a+"' that tries to call the method","sap.ushell.ui5service.ShellUIService");return undefined;}if(P==="setHierarchy"&&c.scopeType==="component"&&c.scopeObject&&t._shouldEnableAutoHierarchy(c.scopeObject)){jQuery.sap.log.warning("Call to "+P+" is not allowed","The app defines that setHierarchy should be called automatically","sap.ushell.ui5service.ShellUIService");return undefined;}if(P==="setTitle"&&c.scopeType==="component"&&c.scopeObject&&t._shouldEnableAutoTitle(c.scopeObject)){jQuery.sap.log.warning("Call to "+P+" is not allowed","The app defines that setTitle should be called automatically","sap.ushell.ui5service.ShellUIService");return undefined;}return t[P].apply(p,arguments);};},_amendPublicServiceInstance:function(p){var t=this,c;c=p.getContext();if(typeof c==="undefined"){return;}["setTitle","setHierarchy","setRelatedApps","setBackNavigation"].forEach(function(m){t._addCallAllowedCheck(p,m);});var A=c.scopeObject;if(c.scopeType==="component"&&A){this._setActiveComponentId(A.getId());if(this._shouldEnableAutoHierarchy(A)){this._enableAutoHierarchy(A);}if(this._shouldEnableAutoTitle(A)){this._enableAutoTitle(A);}return;}jQuery.sap.log.error("Invalid context for ShellUIService interface","The context must be empty or an object like { scopeType: ..., scopeObject: ... }","sap.ushell.ui5service.ShellUIService");},setHierarchy:function(h){if(typeof h!=="undefined"&&!sap.ushell.ui5service.ShellUIService.prototype._ensureArrayOfObjectOfStrings(h,"setHierarchy")){return;}var c=this.getContext().scopeObject;e.fireEvent(O.hierarchyChanged,{data:h,component:c});return;},setTitle:function(t){if(typeof t!=="undefined"&&!sap.ushell.ui5service.ShellUIService.prototype._ensureString(t,"setTitle")){return;}var c=this.getContext().scopeObject;l=t;e.fireEvent(O.titleChanged,{data:t,component:c});return;},setBackNavigation:function(c){if(typeof c!=="undefined"&&!sap.ushell.ui5service.ShellUIService.prototype._ensureFunction(c,"setBackNavigation")){return;}var C=this.getContext().scopeObject;e.fireEvent(O.backNavigationChanged,{data:c,component:C});return;},getTitle:function(){return this._getLastSetTitle();},setRelatedApps:function(r){if(typeof r!=="undefined"&&!sap.ushell.ui5service.ShellUIService.prototype._ensureArrayOfObjectOfStrings(r,"setRelatedApps")){return;}var c=this.getContext().scopeObject;e.fireEvent(O.relatedAppsChanged,{data:r,component:c});return;},getUxdVersion:function(){if((new jQuery.sap.Version(sap.ui.version).compareTo("1.37.0"))>=0){return 2;}return 1;},_attachHierarchyChanged:function(f){this._getEventProvider().attachEvent(O.hierarchyChanged,f);},_detachHierarchyChanged:function(f){this._getEventProvider().detachEvent(O.hierarchyChanged,f);},_attachTitleChanged:function(f){this._getEventProvider().attachEvent(O.titleChanged,f);},_attachBackNavigationChanged:function(f){this._getEventProvider().attachEvent(O.backNavigationChanged,f);},_detachBackNavigationChanged:function(f){this._getEventProvider().detachEvent(O.backNavigationChanged,f);},_detachTitleChanged:function(f){this._getEventProvider().detachEvent(O.titleChanged,f);},_attachRelatedAppsChanged:function(f){this._getEventProvider().attachEvent(O.relatedAppsChanged,f);},_detachRelatedAppsChanged:function(f){this._getEventProvider().detachEvent(O.relatedAppsChanged,f);}});}());
