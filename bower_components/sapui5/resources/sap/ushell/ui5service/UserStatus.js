// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.ui5service.UserStatus");jQuery.sap.require("sap.ui.core.service.ServiceFactoryRegistry");jQuery.sap.require("sap.ui.core.service.ServiceFactory");jQuery.sap.require("sap.ui.base.EventProvider");jQuery.sap.require('sap.ushell.ui.launchpad.UserStatusItem');var E=new sap.ui.base.EventProvider(),O={statusChanged:"statusChanged",serviceStateChanged:"serviceStateChanged"},a;sap.ui.core.service.Service.extend("sap.ushell.ui5service.UserStatus",{init:function(){var t=this,p=this.getInterface();sap.ushell.ui5service.UserStatus.prototype.isEnabled=false;p.init=function(){t._amendPublicServiceInstance.call(t,this);};sap.ui.core.service.ServiceFactoryRegistry.register("sap.ushell.ui5service.UserStatus",new sap.ui.core.service.ServiceFactory(p));sap.ushell.ui5service.UserStatus.prototype.AvailableStatus={AVAILABLE:"AVAILABLE",AWAY:"AWAY",BUSY:"BUSY",APPEAR_OFFLINE:"APPEAR_OFFLINE"};},_setActiveComponentId:function(i){a=i;},_getActiveComponentId:function(){return a;},_getEventProvider:function(){return E;},_ensureArrayOfObjectOfStrings:function(A,m){var v=jQuery.isArray(A)&&A.every(function(o){return jQuery.isPlainObject(o)&&Object.keys(o).length>0&&Object.keys(o).every(function(k){return typeof o[k]==="string";});});if(!v){jQuery.sap.log.error("'"+m+"' was called with invalid parameters","An array of non-empty objects with string values is expected","sap.ushell.ui5service.UserStatus");}return v;},_ensureFunction:function(A,m){var t=typeof A;if(t!=="function"){jQuery.sap.log.error("'"+m+"' was called with invalid arguments","the parameter should be a function, got '"+t+"' instead","sap.ushell.ui5service.UserStatus");return false;}return true;},_ensureString:function(A,m){var t=typeof A;if(t!=="string"){jQuery.sap.log.error("'"+m+"' was called with invalid arguments","the parameter should be a string, got '"+t+"' instead","sap.ushell.ui5service.UserStatus");return false;}return true;},_addCallAllowedCheck:function(p,P){var t=this;p[P]=function(){var c=p.getContext();if(!c||c.scopeObject.getId()!==a){jQuery.sap.log.warning("Call to "+P+" is not allowed","This may be caused by an app component other than the active '"+a+"' that tries to call the method","sap.ushell.ui5service.UserStatus");return undefined;}return t[P].apply(p,arguments);};},_amendPublicServiceInstance:function(p){var t=this,c;c=p.getContext();if(typeof c==="undefined"){return;}["setStatus","attachStatusChanged","detachStatusChanged"].forEach(function(m){t._addCallAllowedCheck(p,m);});if(c.scopeType==="component"){this._setActiveComponentId(c.scopeObject.getId());return;}jQuery.sap.log.error("Invalid context for UserStatus interface","The context must be empty or an object like { scopeType: ..., scopeObject: ... }","sap.ushell.ui5service.UserStatus");},setEnabled:function(e){E.fireEvent(O.serviceStateChanged,{data:e});sap.ushell.ui5service.UserStatus.prototype.isEnabled=e;this._getUserStatusSetting().then(function(u){if(u===undefined||u.userStatusEnabled===undefined){this._showLegalPopup();}else if(u.userStatusEnabled){this.setStatus(u.userStatusDefault);}else if(!u.userStatusEnabled){this.setStatus(null);}}.bind(this));return;},attachEnabledStatusChanged:function(f){this._getEventProvider().attachEvent(O.serviceStateChanged,f);},detachEnabledStatusChanged:function(f){this._getEventProvider().detachEvent(O.serviceStateChanged,f);},setStatus:function(n){if(!sap.ushell.ui5service.UserStatus.prototype.isEnabled){throw new Error("Unable to change status because the UserStatus service is disabled.");}if(!sap.ushell.ui5service.UserStatus.prototype.AvailableStatus[n]&&n!==null){throw new Error("Enter a valid status.");}this._getUserStatusSetting().then(function(u){if((n!==null)&&(u===undefined||u.userStatusEnabled===undefined||!u.userStatusEnabled)){throw new Error("Unable to change status; user has not explicitly opted-in to share their online status.");}E.fireEvent(O.statusChanged,{data:n});return;})},getUxdVersion:function(){if((new jQuery.sap.Version(sap.ui.version).compareTo("1.37.0"))>=0){return 2;}return 1;},attachStatusChanged:function(f){this._getEventProvider().attachEvent(O.statusChanged,f);},detachStatusChanged:function(f){this._getEventProvider().detachEvent(O.statusChanged,f);},_getOnlineStatusPopOver:function(u){var p=new sap.m.Popover({placement:sap.m.PlacementType.Bottom,showArrow:true,showHeader:false,content:[new sap.ushell.ui.launchpad.UserStatusItem({status:sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM.AVAILABLE,isOpener:false,press:function(e){U.setStatus(sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM.AVAILABLE);p.close();}}).addStyleClass('sapUserStatusContainer'),new sap.ushell.ui.launchpad.UserStatusItem({status:sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM.AWAY,isOpener:false,press:function(e){U.setStatus(sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM.AWAY);p.close();}}).addStyleClass('sapUserStatusContainer'),new sap.ushell.ui.launchpad.UserStatusItem({status:sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM.BUSY,isOpener:false,press:function(e){U.setStatus(sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM.BUSY);p.close();}}).addStyleClass('sapUserStatusContainer'),new sap.ushell.ui.launchpad.UserStatusItem({status:sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM.APPEAR_OFFLINE,isOpener:false,press:function(e){U.setStatus(sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM.APPEAR_OFFLINE);p.close();}}).addStyleClass('sapUserStatusContainer')]});var U=new sap.ushell.ui.launchpad.UserStatusItem({tooltip:"{i18n>headerActionsTooltip}",enabled:false,ariaLabel:sap.ushell.Container.getUser().getFullName(),image:sap.ui.core.IconPool.getIconURI("account"),status:u?sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM[u]:sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM["AVAILABLE"],press:function(e){var b=sap.ui.getCore().byId(e.mParameters.id);p.openBy(b);}.bind(this),contentList:p}).addStyleClass('sapUserStatusOpener');return U},_showLegalPopup:function(){var t=this;setTimeout(function(){var T=sap.ui.getCore().getConfiguration().getRTL()?'Left':'Right';var s=sap.ui.Device.system.phone?"auto":"14rem";var S=sap.ui.Device.system.phone?"auto":"10rem";var b=new sap.m.Label({text:sap.ushell.resources.i18n.getText("enableStatusMessageBoxFld")+":",width:s,textAlign:T});var c=new sap.m.Switch("enableStatusSwitch",{type:sap.m.SwitchType.Default,change:function(e){g.setEnabled(e.mParameters.state);jQuery("#"+g.getId()).attr("tabindex",e.mParameters.state?0:-1);}.bind(this)});var f=new sap.m.FlexBox({alignItems:'Center',direction:'Row',items:[b,c]}).addStyleClass('sapUshellUserStatusFlexBox');var d=new sap.m.Label({text:sap.ushell.resources.i18n.getText("userStatusMessageBoxDropdownLabelFld")+":",width:S,textAlign:T}).addStyleClass("sapUshellUserStatusSignInAsLabel");var g=t._getOnlineStatusPopOver(sap.ushell.ui.launchpad.UserStatusItem.prototype.STATUS_ENUM.AVAILABLE.status);jQuery("#"+g.getId()).attr("tabindex",g.getEnabled()?0:-1);var l=new sap.m.Text({text:sap.ushell.resources.i18n.getText("userStatusMessageBoxInfoTextLine1")}).addStyleClass('sapUshellUserStatusLegalTextLine').addStyleClass('sapUshellUserStatusLegalTextFirstLine');var h=new sap.m.Text({text:sap.ushell.resources.i18n.getText("userStatusMessageBoxInfoTextLine2")}).addStyleClass('sapUshellUserStatusLegalTextLine');var i=new sap.m.FlexBox({alignItems:'Center',direction:'Row',items:[d,g]}).addStyleClass('sapUshellUserStatusFlexBox');var j=new sap.ui.layout.VerticalLayout('userStatusDialogLayout',{content:[f,i,l,h]});var k=new sap.m.Button('saveButton',{text:sap.ushell.resources.i18n.getText("okBtn"),press:function(){t._writeUserStatusSettingToPersonalization({userStatusEnabled:c.getState(),userStatusDefault:c.getState()?g.getStatus().status:null});t.setStatus(c.getState()?g.getStatus().status:null);m.close();}});var m=new sap.m.Dialog('agreementMessageBox',{title:sap.ushell.resources.i18n.getText("userStatusAgreementMessageBoxTitle"),modal:true,stretch:sap.ui.Device.system.phone,buttons:[k],afterClose:function(e){t._getUserStatusSetting().then(function(u){if(u===undefined||u.userStatusEnabled===undefined){t._writeUserStatusSettingToPersonalization({userStatusEnabled:false,userStatusDefault:null});t.setStatus(null);}m.destroy();})}}).addStyleClass('sapUshellUserStatusDialog');m.addContent(j);m.open();},100);},_getUserStatusSetting:function(){var p=this._getUserSettingsPersonalizer();return p.getPersData();},_writeUserStatusSettingToPersonalization:function(u){var d,p;try{p=this._getUserSettingsPersonalizer().setPersData(u);}catch(e){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(e.name+": "+e.message);d=new jQuery.Deferred();d.reject(e);p=d.promise();}return p;},_getUserSettingsPersonalizer:function(){this.oUserPersonalizer=this._createUserPersonalizer();return this.oUserPersonalizer;},_createUserPersonalizer:function(){var p=sap.ushell.Container.getService("Personalization"),c,s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true},P={container:"sap.ushell.services.UserStatus",item:"userStatusData"},o=p.getPersonalizer(P,s,c);return o;}});}());
