sap.ui.define(['sap/ushell/components/tiles/generic'],function(g){"use strict";var C=g.extend("sap.ushell.components.tiles.indicatorcontribution.ContributionTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false;},_processDataForComparisonChart:function(d,m,a,u){var s=this.oConfig.TILE_PROPERTIES.semanticColorContribution;var f=[];var t;var b;for(var i=0;i<d.results.length;i++){var h=d.results[i];var j={};try{j.title=h[a].toString();}catch(e){j.title="";}j.value=Number(h[m]);var k=Number(h[m]);if(this.oConfig.EVALUATION.SCALING==-2){k*=100;}var c=this.isCurrencyMeasure(m);b=h[u];t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(k,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION,c,b);j.displayValue=t.toString();if(typeof s==='undefined'){j.color="Neutral";}else{j.color=s;}if(j&&u){j[u]=b;}f.push(j);}return f;},fetchChartData:function(r,i,s,E){var t=this;try{var u=this.oConfig.EVALUATION.ODATA_URL;var a=this.oConfig.EVALUATION.ODATA_ENTITYSET;t.setThresholdValues();if(this.oConfig.TILE_PROPERTIES.semanticMeasure){var m=this.oConfig.EVALUATION.COLUMN_NAME+","+this.oConfig.TILE_PROPERTIES.semanticMeasure;}else{var m=this.oConfig.EVALUATION.COLUMN_NAME;}var b=null;var d=this.oConfig.TILE_PROPERTIES.dimension;this.oConfig.EVALUATION_VALUES;var c=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(r);var f=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){if(f){var h=f.Data&&JSON.parse(f.Data);}}var j=t.oTileApi.configuration.getParameterValueAsString("timeStamp");var k=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(t.oConfig.TILE_PROPERTIES.id,j,t.chipCacheTime,t.chipCacheTimeUnit,t.tilePressed);if((h&&!h.rightData)||!f||(!k&&t.oTileApi.visible.isVisible())||c||(i&&t.oTileApi.visible.isVisible())||t.getView().getViewData().refresh){if(t.kpiValueFetchDeferred){t.kpiValueFetchDeferred=false;var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var o={};o["0"]=m+",asc";o["1"]=m+",desc";o["2"]=d+",asc";o["3"]=d+",desc";var l=o[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");var n=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oRunTimeODataModel,a,m,d,v,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure){n.uri+="&$top=3&$orderby="+l[0]+" "+l[2];}else{n.uri+="&$top=3&$orderby="+l[0]+" "+l[1];}this.comparisionChartODataRef=n.model.read(n.uri,null,null,true,function(w){t.kpiValueFetchDeferred=true;var x={};if(w&&w.results&&w.results.length){if(n.unit[0]){t._updateTileModel({unit:w.results[0][n.unit[0].name]});b=n.unit[0].name;x.unit=n.unit[0];x.unit.name=n.unit[0].name;}d=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(t.oTileApi.url.addSystemToServiceUrl(u),a,d);x.dimension=d;t.oConfig.TILE_PROPERTIES.FINALVALUE=w;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,m.split(",")[0],d,b);x.data=t.oConfig.TILE_PROPERTIES.FINALVALUE;x.isCurM=t.isACurrencyMeasure(t.oConfig.EVALUATION.COLUMN_NAME);var y={};t.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();y.ChipId=t.oConfig.TILE_PROPERTIES.id;y.Data=JSON.stringify(x);y.CacheMaxAge=Number(t.chipCacheTime);y.CacheMaxAgeUnit=t.chipCacheTimeUnit;y.CacheType=1;var z=t.getLocalCache(y);t.updateDatajobScheduled=false;var A=t.oConfig.TILE_PROPERTIES.id+"data";var B=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(A);if(B){clearTimeout(B);B=undefined;}if(!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,z);var U=false;if(f){U=true;}if(t.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(t.oTileApi,t.oConfig.TILE_PROPERTIES.id,y,U,function(w){if(w){t.cacheTime=w&&w.CachedTime;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,w);}if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){jQuery.proxy(t.setTimeStamp(t.cacheTime),t);}});}}else{var D=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(D){if(!D.CachedTime){D.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();}var F=D.Data;if(F){F=JSON.parse(F);if(t.oKpiTileView.getViewName()=="tiles.indicatornumeric.NumericTile"){F.leftData=x;}else{F.rightData=x;}}D.Data=JSON.stringify(F);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,D);}else{var F={};F.rightData=x;z.Data=JSON.stringify(F);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,z);}t.cacheWriteData=x;}s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(w.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=w;if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id)){x=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);x.data=w;}else{x.data=w;}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,x);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);t.setNoData();}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,{empty:"empty"});t.setNoData();}},function(w){t.kpiValueFetchDeferred=true;if(w&&w.response){jQuery.sap.log.error(w.message+" : "+w.request.requestUri);E.call(t,w);}});}}else{if(f&&f.Data){var p;var q=t.oConfig&&t.oConfig.TILE_PROPERTIES&&t.oConfig.TILE_PROPERTIES.tileType;if(q.indexOf("DT-")==-1){p=f.Data&&JSON.parse(f.Data);}else{p=f.Data&&JSON.parse(f.Data);p=p.rightData;}t.cacheTime=f.CachedTime;if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){jQuery.proxy(t.setTimeStamp(t.cacheTime),t);}if(p.data&&p.data.length){if(p.unit){t._updateTileModel({unit:p.data[0][p.unit.name]});}d=p.dimension;t.oConfig.TILE_PROPERTIES.FINALVALUE=p.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);}else if(p&&p.data&&p.data instanceof Array&&p.data.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=p.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE);t.setNoData();}else{t.setNoData();}}else{t.setNoData();}}}catch(e){t.kpiValueFetchDeferred=true;E.call(t,e);}},doProcess:function(r,i){var t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);this.setTextInTile();this.fetchChartData(r,i,function(k){this.CALCULATED_KPI_VALUE=k;this._updateTileModel({data:this.CALCULATED_KPI_VALUE});if(t.oConfig.TILE_PROPERTIES.frameType==sap.m.FrameType.TwoByOne){t.oKpiTileView.oGenericTile.setFrameType(sap.m.FrameType.TwoByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.getView().getViewData().parentController._updateTileModel(this.getTile().getModel().getData());t.getView().getViewData().deferredObj.resolve();}else{t.oKpiTileView.oGenericTile.setFrameType(sap.m.FrameType.OneByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.oKpiTileView.oGenericTile.addTileContent(t.oKpiTileView.oNVConfS);this.oKpiTileView.oGenericTile.setState(sap.m.LoadState.Loaded);}this.setToolTip(null,this.CALCULATED_KPI_VALUE,"CONT");if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible());}},this.logError);},doDummyProcess:function(){var t=this;t.setTextInTile();t._updateTileModel({value:8888,size:sap.m.Size.Auto,frameType:sap.m.FrameType.OneByOne,state:sap.m.LoadState.Loading,valueColor:sap.m.ValueColor.Error,indicator:sap.m.DeviationIndicator.None,title:"US Profit Margin",footer:"Current Quarter",description:"Maximum deviation",data:[{title:"Americas",value:10,color:"Neutral"},{title:"EMEA",value:50,color:"Neutral"},{title:"APAC",value:-20,color:"Neutral"}]});this.oKpiTileView.oGenericTile.setState(sap.m.LoadState.Loaded);}});return C;});
