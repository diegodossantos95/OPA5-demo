// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ui/core/IconPool','sap/ui/thirdparty/datajs','sap/ushell/components/tiles/utils','sap/ushell/components/tiles/utilsRT'],function(I,d,u,a){"use strict";sap.ui.getCore().loadLibrary("sap.m");sap.ui.controller("sap.ushell.components.tiles.applauncherdynamic.DynamicTile",{timer:null,oDataRequest:null,onInit:function(){var v=this.getView(),V=v.getViewData(),t=V.chip,c=a.getConfiguration(t,t.configurationUi.isEnabled(),false),m,k,K,b=this,N=c.navigation_target_url,s;this.bIsRequestCompleted=false;s=t.url.getApplicationSystem();if(s){N+=((N.indexOf("?")<0)?"?":"&")+"sap-system="+s;}this.navigationTargetUrl=N;m=new sap.ui.model.json.JSONModel({config:c,data:a.getDataToDisplay(c,{number:(t.configurationUi.isEnabled()?1234:"...")}),nav:{navigation_target_url:(t.configurationUi&&t.configurationUi.isEnabled()?"":N)},search:{display_highlight_terms:[]}});v.setModel(m);if(t.types){t.types.attachSetType(function(g){if(b.tileType!=g){if(g==='link'){b.getView().removeAllContent();var l=b.getView().getLinkControl();b.getView().addContent(l);}else{b.getView().removeAllContent();var T=b.getView().getTileControl();b.getView().addContent(T);}b.tileType=g;}});}if(!this.tileType){var T=this.getView().getTileControl();this.getView().addContent(T);this.tileType="tile";}if(t.search){k=v.getModel().getProperty("/config/display_search_keywords");K=jQuery.grep(k.split(/[, ]+/),function(n,i){return n&&n!=="";});if(c.display_title_text&&c.display_title_text!==""&&K.indexOf(c.display_title_text)===-1){K.push(c.display_title_text);}if(c.display_subtitle_text&&c.display_subtitle_text!==""&&K.indexOf(c.display_subtitle_text)===-1){K.push(c.display_subtitle_text);}if(c.display_info_text&&c.display_info_text!==""&&K.indexOf(c.display_info_text)===-1){K.push(c.display_info_text);}t.search.setKeywords(K);t.search.attachHighlight(function(h){v.getModel().setProperty("/search/display_highlight_terms",h);});}if(t.bag&&t.bag.attachBagsUpdated){t.bag.attachBagsUpdated(function(U){if(U.indexOf("tileProperties")>-1){u._updateTilePropertiesTexts(v,t.bag.getBag('tileProperties'));}});}if(t.configuration&&t.configuration.attachConfigurationUpdated){t.configuration.attachConfigurationUpdated(function(U){if(U.indexOf("tileConfiguration")>-1){u._updateTileConfiguration(v,t.configuration.getParameterValueAsString("tileConfiguration"));}});}if(t.preview){t.preview.setTargetUrl(N);t.preview.setPreviewIcon(c.display_icon_url);t.preview.setPreviewTitle(c.display_title_text);if(t.preview.setPreviewSubtitle&&typeof t.preview.setPreviewSubtitle==='function'){t.preview.setPreviewSubtitle(c.display_subtitle_text);}}if(t.refresh){t.refresh.attachRefresh(this.refreshHandler.bind(null,this));}if(t.visible){t.visible.attachVisible(this.visibleHandler.bind(this));}if(t.configurationUi.isEnabled()){t.configurationUi.setUiProvider(function(){var C=u.getConfigurationUi(v,"sap.ushell.components.tiles.applauncherdynamic.Configuration");t.configurationUi.attachCancel(b.onCancelConfiguration.bind(null,C));t.configurationUi.attachSave(b.onSaveConfiguration.bind(null,C));return C;});this.getView().getContent()[0].setTooltip(u.getResourceBundleModel().getResourceBundle().getText("edit_configuration.tooltip"));}else{if(!t.preview||!t.preview.isEnabled()){if(!s){sap.ushell.Container.addRemoteSystemForServiceUrl(c.service_url);}this.onUpdateDynamicData();}}if(t.actions){var A=c.actions,e;if(A){e=A.slice();}else{e=[];}var f=a.getTileSettingsAction(m,this.onSaveRuntimeSettings.bind(this));e.push(f);t.actions.setActionsProvider(function(){return e;});}sap.ui.getCore().getEventBus().subscribe("launchpad","sessionTimeout",this.stopRequests,this);},stopRequests:function(){if(this.timer){clearTimeout(this.timer);}if(this.oDataRequest){try{this.bIsAbortRequestFlow=true;this.oDataRequest.abort();}catch(e){jQuery.sap.log.warning(e.name,e.message);}this.bIsAbortRequestFlow=undefined;}},onExit:function(){this.stopRequests();sap.ui.getCore().getEventBus().unsubscribe("launchpad","sessionTimeout",this.stopRequests,this);},onPress:function(e){var v=this.getView(),V=v.getViewData(),m=v.getModel(),t=m.getProperty("/nav/navigation_target_url"),T=V.chip;if(e.getSource().getScope&&e.getSource().getScope()===sap.m.GenericTileScope.Display){if(T.configurationUi.isEnabled()){T.configurationUi.display();}else if(t){if(t[0]==='#'){hasher.setHash(t);}else{window.open(t,'_blank');}}}},onUpdateDynamicData:function(){var v=this.getView(),c=v.getModel().getProperty("/config"),n=c.service_refresh_interval;if(!n){n=0;}else if(n<10){jQuery.sap.log.warning("Refresh Interval "+n+" seconds for service URL "+c.service_url+" is less than 10 seconds, which is not supported. "+"Increased to 10 seconds automatically.",null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile.controller");n=10;}if(c.service_url){this.loadData(n);}},extractData:function(D){var n,k=["results","icon","title","number","numberUnit","info","infoState","infoStatus","targetParams","subtitle","stateArrow","numberState","numberDigits","numberFactor"];if(typeof D==="object"&&Object.keys(D).length===1){n=Object.keys(D)[0];if(jQuery.inArray(n,k)===-1){return D[n];}}return D;},onSaveRuntimeSettings:function(s){var v=s.getModel(),t=this.getView().getViewData().chip,c=this.getView().getModel().getProperty("/config");c.display_title_text=v.getProperty('/title');c.display_subtitle_text=v.getProperty('/subtitle');c.display_info_text=v.getProperty('/info');c.display_search_keywords=v.getProperty('/keywords');var b=t.bag.getBag('tileProperties');b.setText('display_title_text',c.display_title_text);b.setText('display_subtitle_text',c.display_subtitle_text);b.setText('display_info_text',c.display_info_text);b.setText('display_search_keywords',c.display_search_keywords);function l(e){jQuery.sap.log.error(e,null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile.controller");}b.save(function(){jQuery.sap.log.debug("property bag 'tileProperties' saved successfully");this.getView().getModel().setProperty("/config",c);this.getView().getModel().setProperty('/data/display_title_text',c.display_title_text);this.getView().getModel().setProperty('/data/display_subtitle_text',c.display_subtitle_text);this.getView().getModel().setProperty('/data/display_info_text',c.display_info_text);this.getView().getModel().refresh();}.bind(this),l);},onSaveConfiguration:function(c){var D=jQuery.Deferred(),m=c.getModel(),t=m.getProperty("/tileModel"),T=c.getViewData().chip,b=u.tileActionsRows2TileActionsArray(m.getProperty("/config/tile_actions_rows")),e={display_icon_url:m.getProperty("/config/display_icon_url"),display_number_unit:m.getProperty("/config/display_number_unit"),service_url:m.getProperty("/config/service_url"),service_refresh_interval:m.getProperty("/config/service_refresh_interval"),navigation_use_semantic_object:m.getProperty("/config/navigation_use_semantic_object"),navigation_target_url:m.getProperty("/config/navigation_target_url"),navigation_semantic_object:jQuery.trim(m.getProperty("/config/navigation_semantic_object"))||"",navigation_semantic_action:jQuery.trim(m.getProperty("/config/navigation_semantic_action"))||"",navigation_semantic_parameters:jQuery.trim(m.getProperty("/config/navigation_semantic_parameters")),display_search_keywords:m.getProperty("/config/display_search_keywords")};var r=u.checkInputOnSaveConfig(c);if(!r){r=u.checkTileActions(c);}if(r){D.reject("mandatory_fields_missing");return D.promise();}if(e.navigation_use_semantic_object){e.navigation_target_url=a.getSemanticNavigationUrl(e);m.setProperty("/config/navigation_target_url",e.navigation_target_url);}var f=T.bag.getBag('tileProperties');f.setText('display_title_text',m.getProperty("/config/display_title_text"));f.setText('display_subtitle_text',m.getProperty("/config/display_subtitle_text"));f.setText('display_info_text',m.getProperty("/config/display_info_text"));f.setText('display_search_keywords',e.display_search_keywords);var g=T.bag.getBag('tileNavigationActions');u.populateTileNavigationActionsBag(g,b);function l(E,o){jQuery.sap.log.error(E,null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile.controller");D.reject(E,o);}T.writeConfiguration.setParameterValues({tileConfiguration:JSON.stringify(e)},function(){var C=a.getConfiguration(T,false,false),o=a.getConfiguration(T,true,false),m=new sap.ui.model.json.JSONModel({config:C,tileModel:t});c.setModel(m);t.setData({data:o,nav:{navigation_target_url:""}},false);if(T.preview){T.preview.setTargetUrl(C.navigation_target_url);T.preview.setPreviewIcon(C.display_icon_url);T.preview.setPreviewTitle(C.display_title_text);if(T.preview.setPreviewSubtitle&&typeof T.preview.setPreviewSubtitle==='function'){T.preview.setPreviewSubtitle(C.display_subtitle_text);}}f.save(function(){jQuery.sap.log.debug("property bag 'tileProperties' saved successfully");if(T.title){T.title.setTitle(C.display_title_text,function(){D.resolve();},l);}else{D.resolve();}},l);g.save(function(){jQuery.sap.log.debug("property bag 'navigationProperties' saved successfully");},l);},l);return D.promise();},successHandleFn:function(r){this.bIsRequestCompleted=true;var c=this.getView().getModel().getProperty("/config");this.oDataRequest=undefined;var D=r,o,t;if(typeof r==="object"){var b=jQuery.sap.getUriParameters(c.service_url).get("$inlinecount");if(b&&b==="allpages"){D={number:r.__count};}else{D=this.extractData(D);}}else if(typeof r==="string"){D={number:r};}if((this.getView().getViewData().properties)&&(this.getView().getViewData().properties.info)){if(typeof D=="object"){t=this.getView().getViewData().properties.info;D.info=t;}}o=a.getDataToDisplay(c,D);this.getView().getModel().setProperty("/data",o);this.navigationTargetUrl=c.navigation_target_url;this.getView().getModel().setProperty("/nav/navigation_target_url",a.addParamsToUrl(this.navigationTargetUrl,o));},errorHandlerFn:function(m){if(!this.bIsAbortRequestFlow){this.bIsRequestCompleted=true;}var c=this.getView().getModel().getProperty("/config");this.oDataRequest=undefined;var M=m&&m.message?m.message:m,r=u.getResourceBundleModel().getResourceBundle();if(M==="Request aborted"){jQuery.sap.log.info("Data request from service "+c.service_url+" was aborted",null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile");}else{if(m.response){M+=" - "+m.response.statusCode+" "+m.response.statusText;}jQuery.sap.log.error("Failed to update data via service "+c.service_url+": "+M,null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile");}if(!this.bIsAbortRequestFlow){this.getView().getModel().setProperty("/data",a.getDataToDisplay(c,{number:"???",info:r.getText("dynamic_data.error"),infoState:"Critical"}));}},onCancelConfiguration:function(c,s,e){var v=c.getViewData(),m=c.getModel(),t=m.getProperty("/tileModel"),T=v.chip,C=a.getConfiguration(T,false,false);c.getModel().setData({config:C,tileModel:t},false);},loadData:function(n){var D=this.getView(),c=D.getModel().getProperty("/config"),U=c.service_url,t=this;var T=this.getView().getViewData().chip;if(!U){return;}if(/;o=([;\/?]|$)/.test(U)){U=T.url.addSystemToServiceUrl(U);}if(n>0){jQuery.sap.log.info("Wait "+n+" seconds before calling "+c.service_url+" again",null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile.controller");if(this.timer){clearTimeout(this.timer);}this.timer=setTimeout(t.loadData.bind(t,n,false),(n*1000));}if(T.visible.isVisible()&&!t.oDataRequest){t.oDataRequest=OData.read({requestUri:U,headers:{"Cache-Control":"no-cache, no-store, must-revalidate","Pragma":"no-cache","Expires":"0"}},this.successHandleFn.bind(this),this.errorHandlerFn.bind(this));}},refreshHandler:function(D,i){var t=D.getView().getViewData().chip;if(!t.configurationUi.isEnabled()){i=i?i:0;D.loadData(i);}else{D.stopRequests();}},visibleHandler:function(i){var v=this.getView(),c=v.getModel().getProperty("/config"),n=c.service_refresh_interval;if(i){if(n>0){this.refreshHandler(this,Math.max(n,10));}else{if(!this.bIsRequestCompleted){this.refreshHandler(this,Math.max(n,10));}}}else{this.stopRequests();}}});},false);
