sap.ui.define(['sap/ushell/components/tiles/generic'],function(g){"use strict";var A=g.extend("sap.ushell.components.tiles.indicatorArea.AreaChartTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false;},doProcess:function(r,i){this.onAfterFinalEvaluation(r,i);},doDummyProcess:function(){var t=this;this.setTextInTile();t._updateTileModel({footer:"",description:"",width:"100%",height:"100%",chart:{color:"Good",data:[{day:0,balance:0},{day:30,balance:20},{day:60,balance:20},{day:100,balance:80}]},target:{color:"Error",data:[{day:0,balance:0},{day:30,balance:30},{day:60,balance:40},{day:100,balance:90}]},maxThreshold:{color:"Good",data:[{day:0,balance:0},{day:30,balance:40},{day:60,balance:50},{day:100,balance:100}]},innerMaxThreshold:{color:"Error",data:[]},innerMinThreshold:{color:"Neutral",data:[]},minThreshold:{color:"Error",data:[{day:0,balance:0},{day:30,balance:20},{day:60,balance:30},{day:100,balance:70}]},minXValue:0,maxXValue:100,minYValue:0,maxYValue:100,firstXLabel:{label:"June 123",color:"Error"},lastXLabel:{label:"June 30",color:"Error"},firstYLabel:{label:"0M",color:"Good"},lastYLabel:{label:"80M",color:"Critical"},minLabel:{},maxLabel:{}});this.oKpiTileView.oGenericTile.setState(sap.m.LoadState.Loaded);},scheduleJob:function(d){if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible());}},onAfterFinalEvaluation:function(r,d){var t=this;var u=this.DEFINITION_DATA.EVALUATION.ODATA_URL;var E=this.DEFINITION_DATA.EVALUATION.ODATA_ENTITYSET;var m=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.DEFINITION_DATA.EVALUATION_FILTERS,this.DEFINITION_DATA.ADDITIONAL_FILTERS);var f=this.DEFINITION_DATA.TILE_PROPERTIES.dimension;if(f==undefined){this.logError();return;}var h=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;var j=this.DEFINITION_DATA.EVALUATION_VALUES;var k=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){if(k){var l=k.Data&&JSON.parse(k.Data);}}var n=t.oTileApi.configuration.getParameterValueAsString("timeStamp");var o=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(t.oConfig.TILE_PROPERTIES.id,n,t.chipCacheTime,t.chipCacheTimeUnit,t.tilePressed);var p=m;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(h){case"MI":t.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");t.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");t.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");t.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");if(t.sWarningHigh&&t.sCriticalHigh&&t.sTarget){p+=","+t.sWarningHigh+","+t.sCriticalHigh+","+t.sTarget;}break;case"MA":t.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");t.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");t.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");t.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");if(t.sWarningLow&&t.sCriticalLow&&t.sTarget){p+=","+t.sWarningLow+","+t.sCriticalLow+","+t.sTarget;}break;case"RA":t.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");t.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");t.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");t.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");t.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");t.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");if(t.sWarningLow&&t.sCriticalLow&&t.sTarget&&t.sWarningHigh&&t.sCriticalHigh){p+=","+t.sWarningLow+","+t.sCriticalLow+","+t.sTarget+","+t.sWarningHigh+","+t.sCriticalHigh;}break;}}var q=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(r);if((l&&!l.rightData)||!k||(!o&&t.oTileApi.visible.isVisible())||q||(d&&t.oTileApi.visible.isVisible())||t.getView().getViewData().refresh){if(t.kpiValueFetchDeferred){t.kpiValueFetchDeferred=false;var Q=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oTileApi.url.addSystemToServiceUrl(u),E,p,f,v);if(Q){this.queryUriForTrendChart=Q.uri;var w={};try{this.trendChartODataReadRef=Q.model.read(Q.uri,null,null,true,function(a){t.kpiValueFetchDeferred=true;if(a&&a.results&&a.results.length){if(Q.unit[0]){t.unit=a.results[0][Q.unit[0].name];t.CURRENCY_CODE=t.unit;w.unit=Q.unit[0];w.unit.name=Q.unit[0].name;}t.queryUriResponseForTrendChart=a;f=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(t.oTileApi.url.addSystemToServiceUrl(u),E,f);a.results.splice(10);a.firstXlabel=a.results[0][f];a.lastXlabel=a.results[a.results.length-1][f];w.data=a;if(w&&w.data&&w.data.results&&w.data.results.length){for(var i=0;i<w.data.results.length;i++){delete w.data.results[i].__metadata;}}w.isCurM=t.isCurrencyMeasure(t.oConfig.EVALUATION.COLUMN_NAME);w.dimensionName=f;_(a,t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE);var c={};t.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();c.ChipId=t.oConfig.TILE_PROPERTIES.id;c.Data=JSON.stringify(w);c.CacheMaxAge=Number(t.chipCacheTime);c.CacheMaxAgeUnit=t.chipCacheTimeUnit;c.CacheType=1;var b=t.getLocalCache(c);if(t.DEFINITION_DATA.TILE_PROPERTIES.frameType==sap.m.FrameType.TwoByOne){var y=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(y){if(!y.CachedTime){y.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();}var z=y.Data;if(z){z=JSON.parse(z);z.rightData=w;}y.Data=JSON.stringify(z);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,y);}else{var z={};z.rightData=w;b.Data=JSON.stringify(z);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,b);}t.cacheWriteData=w;t.getView().getViewData().deferredObj.resolve();}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,b);var U=false;if(k){U=true;}if(t.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(t.oTileApi,t.oConfig.TILE_PROPERTIES.id,c,U,function(a){if(a){t.cacheTime=a&&a.CachedTime;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,a);t.setTimeStamp();}if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){jQuery.proxy(t.setTimeStamp(t.cacheTime),t);}});}t.oKpiTileView.oGenericTile.setState(sap.m.LoadState.Loaded);t.updateDatajobScheduled=false;var B=t.oConfig.TILE_PROPERTIES.id+"data";var C=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(B);if(C){clearTimeout(C);C=undefined;}jQuery.proxy(t.scheduleJob(t.cacheTime),t);}}else{t.setNoData();}},function(a){t.kpiValueFetchDeferred=true;if(a&&a.response){t.logError("Data call failed");}});}catch(e){t.kpiValueFetchDeferred=true;t.logError(e);}}else{t.kpiValueFetchDeferred=true;t.logError();}}}else{if(k&&k.Data){try{var s;var x=t.oConfig&&t.oConfig.TILE_PROPERTIES&&t.oConfig.TILE_PROPERTIES.tileType;if(x.indexOf("DT-")==-1){s=k.Data&&JSON.parse(k.Data);}else{s=k.Data&&JSON.parse(k.Data);s=s.rightData;}if(s.unit){t.unit=s.data.results[0][s.unit.name];t.CURRENCY_CODE=t.unit;}t.cacheTime=k.CachedTime;if(t.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(t.oConfig)){jQuery.proxy(t.setTimeStamp(t.cacheTime),t);}t.queryUriResponseForTrendChart=s.data;f=s.dimensionName;_(s.data,t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE);if(t.oConfig.TILE_PROPERTIES.frameType==sap.m.FrameType.OneByOne){t.oKpiTileView.oGenericTile.setState(sap.m.LoadState.Loaded);}else{t.getView().getViewData().deferredObj.resolve();}jQuery.proxy(t.scheduleJob(t.cacheTime),t);}catch(e){t.logError(e);}}else{t.setNoData();}}function _(y,z){var B=[];var C=[];var D=[];var F=[];var G=[];var H=[];var I=y.firstXlabel;var J,K,L,M,N;var O=y.lastXlabel;var P=Number(y.results[0][m]);var R=Number(y.results[y.results.length-1][m]);var i;for(i in y.results){y.results[i][f]=Number(i);y.results[i][m]=Number(y.results[i][m]);t.sWarningHigh?y.results[i][t.sWarningHigh]=Number(y.results[i][t.sWarningHigh]):"";t.sCriticalHigh?y.results[i][t.sCriticalHigh]=Number(y.results[i][t.sCriticalHigh]):"";t.sCriticalLow?y.results[i][t.sCriticalLow]=Number(y.results[i][t.sCriticalLow]):"";t.sWarningLow?y.results[i][t.sWarningLow]=Number(y.results[i][t.sWarningLow]):"";t.sTarget?y.results[i][t.sTarget]=Number(y.results[i][t.sTarget]):"";t.sWarningHigh?D.push(y.results[i][t.sWarningHigh]):"";t.sCriticalHigh?F.push(y.results[i][t.sCriticalHigh]):"";t.sCriticalLow?G.push(y.results[i][t.sCriticalLow]):"";t.sWarningLow?H.push(y.results[i][t.sWarningLow]):"";B.push(y.results[i][f]);C.push(y.results[i][m]);}try{I=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(I);O=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(O);}catch(e){t.logError(e);}var S=Number(P);if(t.oConfig.EVALUATION.SCALING==-2){S*=100;}var T=Math.min.apply(Math,C);var c=t.isCurrencyMeasure(t.oConfig.EVALUATION.COLUMN_NAME);var U=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(S,t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION,c,t.CURRENCY_CODE);if(t.oConfig.EVALUATION.SCALING==-2){U+=" %";}var V=U.toString();var W=Number(R);if(t.oConfig.EVALUATION.SCALING==-2){W*=100;}var X=Math.max.apply(Math,C);c=t.isCurrencyMeasure(t.oConfig.EVALUATION.COLUMN_NAME);var Y=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(W,t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION,c,t.CURRENCY_CODE);if(t.oConfig.EVALUATION.SCALING==-2){Y+=" %";}var Z=Y.toString();try{var $=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(Math.min.apply(Math,B));var a1=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(Math.max.apply(Math,B));}catch(e){t.logError(e);}if(z=="MEASURE"){(D.length!=0)?(t.firstwH=D[$])&&(t.lastwH=D[a1]):"";(F.length!=0)?(t.firstcH=F[$])&&(t.lastcH=F[a1]):"";(G.length!=0)?(t.firstcL=G[$])&&(t.lastcL=G[a1]):"";(H.length!=0)?(t.firstwL=H[$])&&(t.lastwL=H[a1]):"";}var b1={width:"100%",height:"100%",unit:t.unit||"",chart:{color:"Neutral",data:y.results},size:"Auto",minXValue:$,maxXValue:a1,minYValue:T,maxYValue:X,firstXLabel:{label:I+"",color:"Neutral"},lastXLabel:{label:O+"",color:"Neutral"},firstYLabel:{label:V+"",color:"Neutral"},lastYLabel:{label:Z+"",color:"Neutral"},minLabel:{},maxLabel:{}};switch(h){case"MA":for(i in j){if(j[i].TYPE=="CL"){b1.minThreshold={color:"Error"};var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);t.cl=Number(j[i].FIXED);b1.minThreshold.data=(z=="MEASURE")?y.results:[c1];J=(z=="MEASURE")?t.sCriticalLow:m;}else if(j[i].TYPE=="WL"){b1.maxThreshold={color:"Good"};var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);b1.maxThreshold.data=(z=="MEASURE")?y.results:[c1];K=(z=="MEASURE")?t.sWarningLow:m;t.wl=Number(j[i].FIXED);}else if(j[i].TYPE=="TA"){var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);b1.target={color:"Neutral"};b1.target.data=(z=="MEASURE")?y.results:[c1];N=(z=="MEASURE")?t.sTarget:m;}}b1.innerMinThreshold={data:[]};b1.innerMaxThreshold={data:[]};if(z=="FIXED"){b1.firstYLabel.color=P<t.cl?"Error":((t.cl<=P)&&(P<=t.wl))?"Critical":(P>t.wl)?"Good":"Neutral";b1.lastYLabel.color=R<t.cl?"Error":((t.cl<=R)&&(R<=t.wl))?"Critical":(R>t.wl)?"Good":"Neutral";}else if(z=="MEASURE"&&t.firstwL&&t.lastwL&&t.firstcL&&t.lastcL){b1.firstYLabel.color=P<t.firstcL?"Error":((t.firstcL<=P)&&(P<=t.firstwL))?"Critical":(P>t.firstwL)?"Good":"Neutral";b1.lastYLabel.color=R<t.lastcL?"Error":((t.lastcL<=R)&&(R<=t.lastwL))?"Critical":(R>t.lastwL)?"Good":"Neutral";}break;case"MI":for(i in j){if(j[i].TYPE=="CH"){var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);t.ch=Number(j[i].FIXED);b1.maxThreshold={color:"Error"};b1.maxThreshold.data=(z=="MEASURE")?y.results:[c1];K=(z=="MEASURE")?t.sCriticalHigh:m;}else if(j[i].TYPE=="WH"){var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);t.wh=Number(j[i].FIXED);b1.minThreshold={color:"Good"};b1.minThreshold.data=(z=="MEASURE")?y.results:[c1];J=(z=="MEASURE")?t.sWarningHigh:m;}else if(j[i].TYPE=="TA"){var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);b1.target={color:"Neutral"};b1.target.data=(z=="MEASURE")?y.results:[c1];N=(z=="MEASURE")?t.sTarget:m;}}if(z=="FIXED"){b1.firstYLabel.color=P>t.ch?"Error":((t.wh<=P)&&(P<=t.ch))?"Critical":(P<t.wh)?"Good":"Neutral";b1.lastYLabel.color=R>t.ch?"Error":((t.wh<=R)&&(R<=t.ch))?"Critical":(R<t.wh)?"Good":"Neutral";}else if(z=="MEASURE"&&t.firstwH&&t.lastwH&&t.firstcH&&t.lastcH){b1.firstYLabel.color=P>t.firstcH?"Error":((t.firstwH<=P)&&(P<=t.firstcH))?"Critical":(P<t.firstwH)?"Good":"Neutral";b1.lastYLabel.color=R>t.lastcH?"Error":((t.lastwH<=R)&&(R<=t.lastcH))?"Critical":(R<t.lastwH)?"Good":"Neutral";}b1.innerMaxThreshold={data:[]};b1.innerMinThreshold={data:[]};break;case"RA":for(i in j){if(j[i].TYPE=="CH"){var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);t.ch=Number(j[i].FIXED);b1.maxThreshold={color:"Error"};b1.maxThreshold.data=(z=="MEASURE")?y.results:[c1];K=(z=="MEASURE")?t.sCriticalHigh:m;}else if(j[i].TYPE=="WH"){var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);t.wh=Number(j[i].FIXED);b1.innerMaxThreshold={color:"Good"};b1.innerMaxThreshold.data=(z=="MEASURE")?y.results:[c1];M=(z=="MEASURE")?t.sWarningHigh:m;}else if(j[i].TYPE=="WL"){var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);t.wl=Number(j[i].FIXED);b1.innerMinThreshold={color:"Good"};b1.innerMinThreshold.data=(z=="MEASURE")?y.results:[c1];L=(z=="MEASURE")?t.sWarningLow:m;}else if(j[i].TYPE=="CL"){var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);t.cl=Number(j[i].FIXED);b1.minThreshold={color:"Error"};b1.minThreshold.data=(z=="MEASURE")?y.results:[c1];J=(z=="MEASURE")?t.sCriticalLow:m;}else if(j[i].TYPE=="TA"){var c1={};c1[f]="";c1[m]=Number(j[i].FIXED);b1.target={color:"Neutral"};b1.target.data=(z=="MEASURE")?y.results:[c1];N=(z=="MEASURE")?t.sTarget:m;}}if(z=="FIXED"){b1.firstYLabel.color=(P>t.ch||P<t.cl)?"Error":((t.wh<=P)&&(P<=t.ch))||((t.cl<=P)&&(P<=t.wl))?"Critical":((P>=t.wl)&&(P<=t.wh))?"Good":"Neutral";b1.lastYLabel.color=(R>t.ch||R<t.cl)?"Error":((t.wh<=R)&&(R<=t.ch))||((t.cl<=R)&&(R<=t.wl))?"Critical":((R>=t.wl)&&(R<=t.wh))?"Good":"Neutral";}else if(z=="MEASURE"&&t.firstwL&&t.lastwL&&t.firstcL&&t.lastcL&&t.firstwH&&t.lastwH&&t.firstcH&&t.lastcH){b1.firstYLabel.color=(P>t.firstcH||P<t.firstcL)?"Error":((t.firstwH<=P)&&(P<=t.firstcH))||((t.firstcL<=P)&&(P<=t.firstwL))?"Critical":((P>=t.firstwL)&&(P<=t.firstwH))?"Good":"Neutral";b1.lastYLabel.color=(R>t.lastcH||R<t.lastcL)?"Error":((t.lastwH<=R)&&(R<=t.lastcH))||((t.lastcL<=R)&&(R<=t.lastwL))?"Critical":((R>=t.lastwL)&&(R<=t.lastwH))?"Good":"Neutral";}break;}var d1=function(f1,a,b,z){return new sap.suite.ui.microchart.AreaMicroChartItem({color:"{/"+f1+"/color}",points:{path:"/"+f1+"/data",template:new sap.suite.ui.microchart.AreaMicroChartPoint({x:"{"+a+"}",y:"{"+b+"}"})}});};var e1=t.getView().oNVConfContS;e1.setTarget(d1("target",f,N));e1.setInnerMinThreshold(d1("innerMinThreshold",f,L));e1.setInnerMaxThreshold(d1("innerMaxThreshold",f,M));e1.setMinThreshold(d1("minThreshold",f,J));e1.setMaxThreshold(d1("maxThreshold",f,K));e1.setChart(d1("chart",f,m));t.setTextInTile();if(t.getView().getViewData().parentController){t.getView().getViewData().parentController._updateTileModel(b1);}else{t._updateTileModel(b1);}}}});return A;});
