// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(function(){"use strict";sap.ui.controller("sap.ushell.components.flp.launchpad.appfinder.HierarchyFolders",{onInit:function(){this.oDialog=null;this.getView().setModel(this.getView().getViewData().easyAccessSystemsModel,"easyAccessSystems");this.getView().setModel(this.getView().getViewData().subHeaderModel,"subHeaderModel");this.getSelectedSystem().then(function(s){if(s){this.setSystemSelected(s);}else{this.setSystemSelected(undefined);this.onSystemSelectionPress();}}.bind(this),function(){this.setSystemSelected(undefined);this.onSystemSelectionPress();});},onExit:function(){if(this.oDialog){this.destroyDialog();}},onAfterRendering:function(){var j=jQuery('#'+this.getView().getId());j.on("click",function(e){this.exitSearchMode();}.bind(this));},getPersonalizer:function(){if(this.oPersonalizer){return this.oPersonalizer;}var p=sap.ushell.Container.getService("Personalization");var c=sap.ui.core.Component.getOwnerComponentFor(this);var s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true};var P={container:"flp.launchpad.appfinder.HierarchyFolders",item:"lastSelectedSystem"};this.oPersonalizer=p.getPersonalizer(P,s,c);return this.oPersonalizer;},getSelectedSystem:function(){var d=new jQuery.Deferred();var s=this.getView().getModel("easyAccessSystems").getProperty("/systemsList");if(s&&s.length&&s.length===1){var e=s[0];this.setSystemSelectedInPersonalization(e);d.resolve(e);}else{this.getSelectedSystemInPersonalization().then(function(p){if(p){var S=false;for(var i=0;i<s.length;i++){if((s[i].systemName&&s[i].systemName===p.systemName)||(s[i].systemId===p.systemId)){S=true;d.resolve(p);}}if(!S){d.resolve();this.setSystemSelectedInPersonalization();}}else{d.resolve();}}.bind(this));}return d.promise();},setSystemSelected:function(s){this.getView().getModel("easyAccessSystems").setProperty("/systemSelected",s);this.setSystemSelectedInPersonalization(s);},getSelectedSystemInPersonalization:function(){var d=new jQuery.Deferred();this.getPersonalizer().getPersData().then(function(p){if(p){d.resolve(p);}else{d.resolve();}},function(e){jQuery.sap.log.error("Failed to get selected system from the personalization",e,"sap.ushell.components.flp.launchpad.appfinder.HierarchyFolders");d.reject();});return d.promise();},setSystemSelectedInPersonalization:function(s){this.getPersonalizer().setPersData(s).fail(function(e){jQuery.sap.log.error("Failed to save selected system in the personalization",e,"sap.ushell.components.flp.launchpad.appfinder.HierarchyFolders");});},onSystemSelectionPress:function(){var s=this.getView().getModel("easyAccessSystems").getProperty("/systemsList");if(s&&s.length&&s.length<=1){return;}var d=this.createDialog();d.open();},createDialog:function(){var t=this;if(!this.oDialog){this.oDialog=new sap.m.SelectDialog({id:"systemSelectionDialog",title:t.getView().translationBundle.getText("easyAccessSelectSystemDialogTitle"),multiSelect:false,contentHeight:"20rem",items:{path:"/systemsList",template:new sap.m.StandardListItem({adaptTitleSize:false,title:{parts:["systemName","systemId"],formatter:t.titleFormatter},description:{parts:["systemName","systemId"],formatter:t.descriptionFormatter},selected:{parts:["systemName","systemId"],formatter:t.selectedFormatter.bind(this)}})},confirm:t.systemConfirmHandler.bind(t),search:t.systemSearchHandler.bind(t),cancel:t.destroyDialog.bind(t)});this.oDialog.setModel(this.getView().getModel("easyAccessSystems"));}return this.oDialog;},destroyDialog:function(){this.oDialog.destroyItems();this.oDialog.destroy();this.oDialog=null;},systemConfirmHandler:function(e){var i=e.getParameters().selectedItem;var s=i.getBindingContext().getObject();this.setSystemSelected(s);this.destroyDialog();},systemSearchHandler:function(e){var v=e.getParameter("value");var f=new sap.ui.model.Filter("systemName",sap.ui.model.FilterOperator.Contains,v);var F=new sap.ui.model.Filter("systemId",sap.ui.model.FilterOperator.Contains,v);var s=new sap.ui.model.Filter({filters:[F,f],and:false});var b=e.getSource().getBinding("items");b.filter(s);},titleFormatter:function(s,a){return s||a;},descriptionFormatter:function(s,a){if(s){return a;}return null;},selectedFormatter:function(s,a){var u=this.getView().getModel("easyAccessSystems").getProperty("/systemSelected");if(!u){return false;}if(s){return(u.systemName===s);}else{return(u.systemId===a);}},systemSelectorTextFormatter:function(s){if(s){if(s.systemName){return s.systemName;}else{return s.systemId;}}else{return this.getView().translationBundle.getText("easyAccessSelectSystemTextWithoutSystem");}},exitSearchMode:function(){var s=this.getView().getModel('subHeaderModel');s.setProperty('/search/searchMode',false);s.refresh(true);}});},true);
