// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/services/Message','sap/ui/base/EventProvider','sap/ushell/ui/launchpad/TileState',"sap/ushell/components/flp/launchpad/PagingManager","sap/ushell/components/flp/launchpad/DashboardLoadingManager"],function(M,E,T,P,D){"use strict";var g=function(m,p){return p?sap.ushell.resources.i18n.getText(m,p):sap.ushell.resources.i18n.getText(m);};var c=E.extend("sap.ushell.components.flp.launchpad.DashboardManager",{metadata:{publicMethods:["getModel","getDashboardView","loadPersonalizedGroups","attachEvent","detachEvent","attachEventOnce","createTile","deleteCatalogTileFromGroup","resetGroupsOnFailure","createGroupAndSaveTile"]},analyticsConstants:{PERSONALIZATION:"FLP: Personalization",RENAME_GROUP:"FLP: Rename Group",MOVE_GROUP:"FLP: Move Group",DELETE_GROUP:"FLP: Delete Group",RESET_GROUP:"FLP: Reset Group",DELETE_TILE:"FLP: Delete Tile",ADD_TILE:"FLP: Add Tile",MOVE_TILE:"FLP: Move Tile"},constructor:function(i,s){if(sap.ushell.components.flp.launchpad.getDashboardManager&&sap.ushell.components.flp.launchpad.getDashboardManager()){return sap.ushell.components.flp.launchpad.getDashboardManager();}sap.ushell.components.flp.launchpad.getDashboardManager=jQuery.sap.getter(this.getInterface());this.oPageBuilderService=sap.ushell.Container.getService("LaunchPage");this.oModel=s.model;this.oConfig=s.config;this.oRouter=s.router;this.oSortableDeferred=$.Deferred();this.oSortableDeferred.resolve();this.aRequestQueue=[];this.aPendingCatalogQueue=[];this.bRequestRunning=false;this.tagsPool=[];this.skippedProcessCatalogs=0;this.registerEvents();this.oTileCatalogToGroupsMap={};this.iTabSelected=0;this.tileViewUpdateQueue=[];this.tileViewUpdateTimeoutID=0;this.oSegmentedTabTileViewDB={};this.oPopover=null;this.tileUuid=null;this.segmentsStore=[];this.iMinNumOfBUForBlindLoading=1500;this.bIsScorllModeAccordingKPI=false;this.oGroupNotLockedFilter=new sap.ui.model.Filter("isGroupLocked",sap.ui.model.FilterOperator.EQ,false);this.bLinkPersonalizationSupported=this.oPageBuilderService.isLinkPersonalizationSupported();this.oDashboardLoadingManager=new D("loadingManager",{oDashboardManager:this});if(this.oRouter){var t=this.oRouter.getTarget('home');t.attachDisplay(function(e){this.oDashboardView=e.getParameter('view');}.bind(this));}this.oModel.bindProperty("/tileActionModeActive").attachChange(this._changeLinksScope.bind(this));},isBlindLoading:function(){var i=this.oModel.getProperty("/homePageGroupDisplay")==="scroll"&&this.bIsScorllModeAccordingKPI;return this.oModel.getProperty("/tileActionModeActive")||i;},createMoveActionDialog:function(i){var G=this.oGroupNotLockedFilter,m=new sap.m.SelectDialog(i,{title:sap.ushell.resources.i18n.getText('moveTileDialog_title'),rememberSelections:false,search:function(e){var v=e.getParameter("value"),f=new sap.ui.model.Filter("title",sap.ui.model.FilterOperator.Contains,v),b=e.getSource().getBinding("items");b.filter([f,G]);},contentWidth:'400px',contentHeight:"auto",confirm:function(e){var C=e.getParameter("selectedContexts");this.publishMoveActionEvents(e,C,"move"+this.tileType);}.bind(this),cancel:function(){var C=jQuery('.sapUshellTile[tabindex="0"]')[0];if(C){C.focus();}},items:{path:"/groups",filters:[G],template:new sap.m.StandardListItem({title:"{title}"})}});return m;},publishMoveActionEvents:function(e,C,m){var o=sap.ui.getCore().getEventBus();if(C.length){var s=this.tileType==="link"?"links":"tiles";o.publish("launchpad",m,{sTileId:this.tileUuid,sToItems:s,sFromItems:s,sTileType:s,toGroupId:C[0].getObject().groupId,toIndex:C[0].getObject()[this.tileType==="link"?"links":"tiles"].length,source:e.getSource().getId()});o.publish("launchpad","scrollToGroup",{groupId:C[0].getObject().groupId,groupChanged:false,focus:false});}},_changeLinksScope:function(e){var t=this;if(this.bLinkPersonalizationSupported){var i=e.getSource().getValue();this.oModel.getProperty("/groups").forEach(function(G,a){if(!G.isGroupLocked){t._changeGroupLinksScope(G,i?'Actions':'Display');}});}},_changeGroupLinksScope:function(G,s){var t=this;G.links.forEach(function(l,i){t._changeLinkScope(l.content[0],s);});},_changeLinkScope:function(l,s){var L=l.getScope?l:l.getContent()[0];if(this.bLinkPersonalizationSupported&&L.setScope){L.setScope(s);}},registerEvents:function(){var e=sap.ui.getCore().getEventBus();e.subscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.subscribe("launchpad","tabSelected",this.getSegmentTabContentViews,this);e.subscribe("sap.ushell.services.Bookmark","bookmarkTileAdded",this._addBookmarkToModel,this);e.subscribe("sap.ushell.services.Bookmark","catalogTileAdded",this._refreshGroupInModel,this);e.subscribe("sap.ushell.services.Bookmark","bookmarkTileDeleted",this.loadPersonalizedGroups,this);e.subscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.subscribe("launchpad","createGroupAt",this._createGroupAt,this);e.subscribe("launchpad","createGroup",this._createGroup,this);e.subscribe("launchpad","deleteGroup",this._deleteGroup,this);e.subscribe("launchpad","resetGroup",this._resetGroup,this);e.subscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.subscribe("launchpad","moveGroup",this._moveGroup,this);e.subscribe("launchpad","deleteTile",this._deleteTile,this);e.subscribe("launchpad","movetile",this._moveTile,this);e.subscribe("launchpad","movelink",this._moveLink,this);e.subscribe("launchpad","sortableStart",this._sortableStart,this);e.subscribe("launchpad","sortableStop",this._sortableStop,this);e.subscribe("renderCatalog",this.loadAllCatalogs,this);e.subscribe("showCatalog",this.updateTilesAssociation,this);e.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.subscribe("launchpad","convertTile",this._convertTile,this);this.oPageBuilderService.registerTileActionsProvider(this._addFLPActionsToTile.bind(this));},_addFLPActionsToTile:function(t){var l=this.bLinkPersonalizationSupported&&this.oPageBuilderService.isLinkPersonalizationSupported(t),a=[];a.push(this._getMoveTileAction(t));if(l){a.push(this._getConvertTileAction(t));}return a;},_getConvertTileAction:function(t){var e=sap.ui.getCore().getEventBus(),a=this,s=a.oPageBuilderService.getTileType(t);return{text:s==='link'?sap.ushell.resources.i18n.getText('ConvertToTile'):sap.ushell.resources.i18n.getText('ConvertToLink'),press:function(S){e.publish("launchpad","convertTile",S);}};},_getMoveTileAction:function(t){var a=this;return{text:sap.ushell.resources.i18n.getText('moveTileDialog_action'),press:function(){a.tileType=a.oPageBuilderService.getTileType(t);a.tileUuid=a.getModelTileById(a.oPageBuilderService.getTileId(t),a.tileType==="link"?"links":"tiles").uuid;var m=a.tileType==="tile"?a.moveTileDialog:a.moveLinkDialog;if(a.tileType==="tile"||(a.tileType==="link")){if(!m){m=a.createMoveActionDialog("move"+a.tileType+"Dialog");m.setModel(a.oModel);if(a.tileType==="tile"){a.moveTileDialog=m;}else{a.moveLinkDialog=m;}}else{m.getBinding("items").filter([a.oGroupNotLockedFilter]);}m.open();}}};},_handleTileAppearanceAnimation:function(s){if(!s){return;}var p=["webkit",""];function a(e,t){for(var i=0;i<p.length;i++){t=t.toLowerCase();s.attachBrowserEvent(p[i]+t,function(o){if(o.originalEvent&&o.originalEvent.animationName==="sapUshellTileEntranceAnimation"){s.removeStyleClass("sapUshellTileEntrance")}},false);}}a(s,"AnimationEnd");s.addStyleClass("sapUshellTileEntrance");},destroy:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.unsubscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.unsubscribe("launchpad","createGroupAt",this._createGroupAt,this);e.unsubscribe("launchpad","createGroup",this._createGroup,this);e.unsubscribe("launchpad","deleteGroup",this._deleteGroup,this);e.unsubscribe("launchpad","resetGroup",this._resetGroup,this);e.unsubscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.unsubscribe("launchpad","moveGroup",this._moveGroup,this);e.unsubscribe("launchpad","deleteTile",this._deleteTile,this);e.unsubscribe("launchpad","movetile",this._moveTile,this);e.unsubscribe("launchpad","movelink",this._moveLink,this);e.unsubscribe("launchpad","sortableStart",this._sortableStart,this);e.unsubscribe("launchpad","sortableStop",this._sortableStop,this);e.unsubscribe("renderCatalog",this.loadAllCatalogs,this);e.unsubscribe("showCatalog",this.updateTilesAssociation,this);e.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);sap.ushell.components.flp.launchpad.getDashboardManager=undefined;},_refreshTiles:function(){var t=this,G=this.oModel.getProperty("/groups");jQuery.each(G,function(n,o){jQuery.each(o.tiles,function(n,a){t.oPageBuilderService.refreshTile(a.object);});});},_sortableStart:function(){this.oSortableDeferred=$.Deferred();},_createBookmark:function(C,e,d){var t=d.group?d.group.object:"";delete d.group;this._addRequest($.proxy(function(){var r=sap.ushell.Container.getService("Bookmark").addBookmark(d,t),R=sap.ushell.resources.i18n;r.always($.proxy(this._checkRequestQueue,this));r.done(function(){if(sap.ushell.Container){sap.ushell.Container.getService('Message').info(R.getText('tile_created_msg'));}});r.fail(function(m){jQuery.sap.log.error("Failed to add bookmark",m,"sap.ushell.ui.footerbar.AddBookmarkButton");if(sap.ushell.Container){sap.ushell.Container.getService('Message').error(R.getText('fail_to_add_tile_msg'));}});},this));},_addBookmarkToModel:function(C,e,d){var t=d.tile,G,o=d.group,s,a,n,i,b,N,I;if(!d||!t){this.bIsGroupsModelDirty=true;if(!this.bGroupsModelLoadingInProcess){this._handleBookmarkModelUpdate();}return;}if(!o){G=this.getModel().getProperty("/groups");for(I=0;I<G.length;I++){if(G[I].isDefaultGroup===true){o=G[I].object;break;}}}s=this.oPageBuilderService;a=s.getTileType(t);n=this._getTileModel(t,s.isGroupLocked(o),a,this._addModelToTileViewUpdateQueue);this.getTileView(n);i=this._getIndexOfGroupByObject(o);b=this.oModel.getProperty("/groups/"+i);b.tiles.push(n);b.visibilityModes=sap.ushell.utils.calcVisibilityModes(b,true);N=b.tiles.length;this._updateModelWithTileView(i,N);this.oModel.setProperty("/groups/"+i,b);},_refreshGroupInModel:function(C,e,G){var l=sap.ushell.Container.getService("LaunchPage"),s='Failed to refresh group with id:'+G+' in the model',t=this;l.getGroups().fail(jQuery.sap.log.error(s,null,"sap.ushell.components.flp.launchpad.DashboardManager")).done(function(a){a.some(function(o){if(l.getGroupId(o)===G){l.getDefaultGroup().done(function(d){var i=G===d.getId()?true:false,b=t._getGroupModel(o,i),f=t._getIndexOfGroupByObject(b.object);t.oModel.setProperty("/groups/"+f,b);});return true;}});});},_sortableStop:function(){this.oSortableDeferred.resolve();},_handleAfterSortable:function(f){return $.proxy(function(){var o=Array.prototype.slice.call(arguments);this.oSortableDeferred.done(function(){f.apply(null,o);});},this);},_addRequest:function(r){this.aRequestQueue.push(r);if(!this.bRequestRunning){this.bRequestRunning=true;this.aRequestQueue.shift()();}},_checkRequestQueue:function(){if(this.aRequestQueue.length===0){this.bRequestRunning=false;}else{this.aRequestQueue.shift()();}},_requestFailed:function(){this.aRequestQueue=[];this.bRequestRunning=false;},_createGroup:function(C,e,d){var G=this._getGroupModel(null),a=this.oModel.getProperty("/groups"),m=this.oModel;m.setProperty("/groupList-skipScrollToGroup",true);window.setTimeout(function(){m.setProperty("/groups/"+a.length,G);},500);window.setTimeout(function(){m.setProperty("/groupList-skipScrollToGroup",false);},1000);},_createGroupAt:function(C,e,d){var n=parseInt(d.location,10),G=this.oModel.getProperty("/groups"),o=this._getGroupModel(null,false,n===G.length,d),m=this.oModel,i;o.index=n;G.splice(n,0,o);for(i=0;i<G.length-1;i++){G[i].isLastGroup=false;}for(i=n+1;i<G.length;i++){G[i].index++;}m.setProperty("/groups",G);},_getIndexOfGroup:function(G){var n=null,a=this.oModel.getProperty("/groups");jQuery.each(a,function(b,o){if(o.groupId===G){n=b;return false;}});return n;},_getIndexOfGroupByObject:function(G){var n=null,a=this.oModel.getProperty("/groups"),s=this.oPageBuilderService.getGroupId(G);a.every(function(m,b){var C=this.oPageBuilderService.getGroupId(m.object);if(C===s){n=b;return false;}return true;}.bind(this));return n;},_getPathOfGroup:function(G){return"/groups/"+this._getIndexOfGroup(G);},_getPathOfTile:function(t){var G=this.oModel.getProperty("/groups"),n=null,a=null,s,e=function(b,o){if(o.uuid===t){a=b;return false;}};jQuery.each(G,function(b,o){jQuery.each(o.tiles,e);if(a!==null){n=b;s="tiles";return false;}jQuery.each(o.links,e);if(a!==null){n=b;s="links";return false;}});return n!==null?"/groups/"+n+"/"+s+"/"+a:null;},_moveInArray:function(a,n,b){if(b>=a.length){var k=b-a.length;while((k--)+1){a.push(undefined);}}a.splice(b,0,a.splice(n,1)[0]);},_updateGroupIndices:function(a){var k;for(k=0;k<a.length;k++){a[k].index=k;}},_deleteGroup:function(C,e,d){var t=this,G=d.groupId,s,a=this.oModel.getProperty("/groups"),n=this._getIndexOfGroup(G),i=a.length-1===n,o=null,r,m,b,B;b=i?n-1:n;this._destroyGroupModel("/groups/"+n);o=a.splice(n,1)[0].object;if(i){this.oModel.setProperty("/groups/"+b+"/isLastGroup",i);}s=sap.ushell.Container.getService("LaunchPage").getGroupId(o);m=this.oModel;m.setProperty("/groupList-skipScrollToGroup",true);m.setProperty("/groups",a);this._updateGroupIndices(a);if(b>=0){B=sap.ui.getCore().getEventBus();window.setTimeout($.proxy(B.publish,B,"launchpad","scrollToGroup",{groupId:this.oModel.getProperty("/groups")[b].groupId}),200);}window.setTimeout(function(){m.setProperty("/groupList-skipScrollToGroup",false);},1000);this._addRequest($.proxy(function(){var f=sap.ushell.Container.getService("LaunchPage").getGroupTitle(o);try{r=this.oPageBuilderService.removeGroup(o);}catch(h){this._resetGroupsOnFailure("fail_to_delete_group_msg");return;}r.done(function(){sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(this.analyticsConstants.PERSONALIZATION,this.analyticsConstants.DELETE_GROUP,[f,s]);this._showLocalizedMessage("group_deleted_msg",[f]);}.bind(this));r.fail(this._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_delete_group_msg")));r.always($.proxy(this._checkRequestQueue,this));},this));},_resetGroup:function(C,e,d){var t=this,G=d.groupId,n=this._getIndexOfGroup(G),o=this.oModel.getProperty("/groups/"+n),s,a,r,b;this.oModel.setProperty("/groups/"+n+"/sortable",false);a=sap.ushell.Container.getService("LaunchPage").getGroupId(o.object);s=sap.ushell.Container.getService("LaunchPage").getGroupTitle(o.object);this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.resetGroup(o.object);}catch(f){this._resetGroupsOnFailure("fail_to_reset_group_msg");return;}r.done(this._handleAfterSortable($.proxy(function(G,o,R){sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(this.analyticsConstants.PERSONALIZATION,this.analyticsConstants.RESET_GROUP,[s,a]);var n=t._getIndexOfGroup(G);this._loadGroup(n,R||o.object,this._addAndUpdateModelWithTileView);this._showLocalizedMessage("group_reset_msg",[o.title]);this.oModel.setProperty("/groups/"+n+"/sortable",true);b=sap.ui.getCore().byId('dashboardGroups').getGroupControlByGroupId(G);if(b.getBindingContext().getObject().links&&b.getBindingContext().getObject().links.length&&!b.getIsGroupLocked()){this._changeGroupLinksScope(b.getBindingContext().getObject(),this.oModel.getProperty("/tileActionModeActive")?sap.m.GenericTileScope.Actions:sap.m.GenericTileScope.Display);}if(b){b.rerender();this.updateTilesAssociation();sap.ushell.utils.handleTilesVisibility();}},this,G,o)));r.fail(this._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_reset_group_msg")));r.always($.proxy(this._checkRequestQueue,this));},this));},_moveGroup:function(C,e,d){var f=d.fromIndex,t=d.toIndex,G=this.oModel.getProperty("/groups"),m=this.oModel,a=this.oModel.getProperty("/tileActionModeActive"),r,o,s,b=this,i,h;if(!a){f=this._adjustFromGroupIndex(f,G);}o=G[f];s=o.groupId;if(!a){t=this._adjustToGroupIndex(t,G,s);}h=G[t].object;this._moveInArray(G,f,t);this._updateGroupIndices(G);m.setProperty("/groupList-skipScrollToGroup",true);for(i=0;i<G.length-1;i++){G[i].isLastGroup=false;}G[G.length-1].isLastGroup=true;m.setProperty("/groups",G);window.setTimeout(function(){m.setProperty("/groupList-skipScrollToGroup",false);},1000);this._addRequest($.proxy(function(){var o=this.oModel.getProperty(this._getPathOfGroup(s));try{this._getOriginalGroupIndex(h).done(function(n){r=this.oPageBuilderService.moveGroup(o.object,n);r.done(function(){sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(b.analyticsConstants.PERSONALIZATION,b.analyticsConstants.MOVE_GROUP,[o.title,f,t,s]);});r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_move_group_msg")));r.always($.proxy(this._checkRequestQueue,this));}.bind(this));}catch(j){this._resetGroupsOnFailure("fail_to_move_group_msg");return;}},this));},_adjustToGroupIndex:function(t,a,b){var v=0,I=false,i=0;for(i=0;i<a.length&&v<t;i++){if(a[i].isGroupVisible){if(a[i].groupId===b){I=true;}else{v++;}}}if(I){return i-1;}return i;},_adjustFromGroupIndex:function(a,b){var v=0,i;for(i=0;i<b.length;i++){if(b[i].isGroupVisible){v++;}if(v===a+1){return i;}}return a;},_getOriginalGroupIndexByIndex:function(n){var G=this.oModel.getProperty("/groups"),s=G[n].object;return this._getOriginalGroupIndex(s);},_getOriginalGroupIndex:function(s){var a=this.oPageBuilderService,t=this,G=this.oPageBuilderService.getGroups(),d=new jQuery.Deferred();G.done(function(b){var n=null;jQuery.each(b,function(e,o){if(a.getGroupId(o)===a.getGroupId(s)){n=e;return false;}});d.resolve(n);});G.fail(function(){t._showLocalizedErrorHelper("fail_to_load_groups_msg")();d.reject();});return d;},_changeGroupTitle:function(C,e,d){var n=d.newTitle,G=this.oModel.getProperty("/groups"),s=d.groupId,a=d.groupId,b=this._getIndexOfGroup(s),o=this.oModel.getProperty("/groups/"+b),O=o.title,r,t=this;this.oModel.setProperty("/groups/"+b+"/title",n);if(!o.object){this._addRequest($.proxy(function(){try{if(b===G.length-1){r=this.oPageBuilderService.addGroup(n,b);r.done(this._handleAfterSortable($.proxy(function(s,N){var b=this._getIndexOfGroup(s);this._loadGroup(b,N);sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(t.analyticsConstants.PERSONALIZATION,t.analyticsConstants.RENAME_GROUP,[O,n,s]);},this,s)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_create_group_msg")));r.always($.proxy(this._checkRequestQueue,this));}else{this._getOriginalGroupIndexByIndex(b+1).done(function(h){r=this.oPageBuilderService.addGroupAt(n,h);r.done(this._handleAfterSortable($.proxy(function(s,N){var b=this._getIndexOfGroup(s);this._loadGroup(b,N);sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(t.analyticsConstants.PERSONALIZATION,t.analyticsConstants.RENAME_GROUP,[O,n,s]);},this,s)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_create_group_msg")));r.always($.proxy(this._checkRequestQueue,this));}.bind(this));}}catch(f){this._resetGroupsOnFailure("fail_to_create_group_msg");return;}},this));}else{this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.setGroupTitle(o.object,n);}catch(f){this._resetGroupsOnFailure("fail_to_rename_group_msg");return;}r.done(function(){a=sap.ushell.Container.getService("LaunchPage").getGroupId(o.object);sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(t.analyticsConstants.PERSONALIZATION,t.analyticsConstants.RENAME_GROUP,[O,n,a]);});r.fail(this._handleAfterSortable($.proxy(function(s,O){var h=this._getPathOfGroup(s);this._showLocalizedError("fail_to__msg");this.oModel.setProperty(h+"/title",O);this._requestFailed();},this,s)));r.always($.proxy(this._checkRequestQueue,this));},this));}},createTile:function(d){var C=d.catalogTileContext,o=d.groupContext,G=this.oModel.getProperty(o.getPath()),s=G.groupId,r,a=jQuery.Deferred(),R={},b;b=sap.ui.getCore().getEventBus();$.proxy(b.publish,b,"launchpad","addTile",{catalogTileContext:C,groupContext:o});if(!C){jQuery.sap.log.warning("DashboardManager: Did not receive catalog tile object. Abort.",this);return;}this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.addTile(C.getProperty("src"),o.getProperty("object"));}catch(e){this._resetGroupsOnFailure("fail_to_add_tile_msg");return;}var t=this;r.done(function(f){var h=t._getPathOfGroup(s),i=sap.ushell.Container.getService("LaunchPage").getTileTitle(f);t._addTileToGroup(h,f);R={group:G,status:1,action:'add'};sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(t.analyticsConstants.PERSONALIZATION,t.analyticsConstants.ADD_TILE,[G.title,i]);a.resolve(R);}).fail(function(){R={group:G,status:0,action:'add'};a.resolve(R);}).always(function(){t._checkRequestQueue();});},this));return a.promise();},createGroup:function(t){var d=jQuery.Deferred();if(!sap.ushell.utils.validHash(t)){return d.reject({status:0,action:'createNewGroup'});}var G=this._getGroupModel(null,false,true);var a=this.oModel.getProperty("/groups");var s=G.groupId;var i=a.length;if(i>0){a[i-1].isLastGroup=false;}G.title=t;G.index=i;G.editMode=false;a.push(G);this.oModel.setProperty("/groups/",a);this._addRequest(function(t){try{var r=this.oPageBuilderService.addGroup(t);}catch(e){this._resetGroupsOnFailure("fail_to_create_group_msg");return;}r.done(this._handleAfterSortable(function(s,n){var b=this._getIndexOfGroup(s);this._loadGroup(b,n);var C=new sap.ui.model.Context(this.oModel,"/groups/"+b);d.resolve(C);}.bind(this,s)));r.fail(function(b){this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_create_group_msg"));var R={group:b.group,status:0,action:'createNewGroup'};d.resolve(R);}.bind(this));r.always($.proxy(this._checkRequestQueue,this));}.bind(this,t));return d.promise();},createGroupAndSaveTile:function(d){var C=d.catalogTileContext,n=d.newGroupName,a=jQuery.Deferred(),r={};if(sap.ushell.utils.validHash(n)&&C){this.createGroup(n).then(function(o){var p=this.createTile({catalogTileContext:C,groupContext:o});p.done(function(b){r={group:b.group,status:1,action:'addTileToNewGroup'};a.resolve(r);}).fail(function(b){r={group:b.group,status:0,action:'addTileToNewGroup'};a.resolve(r);});}.bind(this));}return a.promise();},_deleteTile:function(C,e,d){var t=this,s=d.tileId||d.originalTileId,G=this.oModel.getProperty("/groups"),i=d.items||'tiles';jQuery.each(G,function(n,o){var f=false;jQuery.each(o[i],function(a,b){if(b.uuid===s||b.originalTileId===s){t._destroyTileModel("/groups/"+n+"/"+i+"/"+a);var h=o[i].splice(a,1)[0],r,j=sap.ushell.Container.getService("LaunchPage").getTileTitle(h.object),k=sap.ushell.Container.getService("LaunchPage").getCatalogTileId(h.object),l=sap.ushell.Container.getService("LaunchPage").getCatalogTileTitle(h.object),m=sap.ushell.Container.getService("LaunchPage").getTileId(h.object),p=t.oModel.getProperty("/personalization");o.visibilityModes=sap.ushell.utils.calcVisibilityModes(o,p);t.oModel.setProperty("/groups/"+n,o);t._addRequest(function(){try{r=t.oPageBuilderService.removeTile(o.object,h.object);}catch(q){this._resetGroupsOnFailure("fail_to_remove_tile_msg");return;}r.done(t._handleAfterSortable(function(){t._showLocalizedMessage("tile_deleted_msg",[j,o.title]);sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(t.analyticsConstants.PERSONALIZATION,t.analyticsConstants.DELETE_TILE,[j||m,k,l,o.title]);}));r.fail(t._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_remove_tile_msg")));r.always($.proxy(t._checkRequestQueue,t));});sap.ushell.utils.handleTilesVisibility();f=true;return false;}});if(f){return false;}});},_sendDeleteTileRequest:function(G,t){var r,a=sap.ushell.Container.getService('LaunchPage');try{r=a.removeTile(G,t.object);}catch(e){jQuery.sap.log.error("deleteCatalogTileFromGroup ; removeTile ; Exception occurred: "+e);}return r;},deleteCatalogTileFromGroup:function(d){var t=this,s=decodeURIComponent(d.tileId),G=d.groupIndex,o=this.oModel.getProperty("/groups/"+G),a=sap.ushell.Container.getService("LaunchPage"),b=jQuery.Deferred(),e=[],f,p,h;f=o.tiles.filter(function(i){var j=a.getCatalogTileId(i.object);if(j!==s){return true;}else{p=jQuery.Deferred();h=t._sendDeleteTileRequest(o.object,i);h.done((function(b){return function(){b.resolve({status:true});};})(p));h.fail((function(b){return function(){b.resolve({status:false});};})(p));e.push(p);return false;}});o.tiles=f;o.visibilityModes=sap.ushell.utils.calcVisibilityModes(o,true);jQuery.when.apply(jQuery,e).done(function(r){var S=true,i=0,j=e.length;for(i;i<j;i++){if(!r.status){S=false;break;}}if(S){t.oModel.setProperty("/groups/"+G,o);}b.resolve({group:o,status:S,action:'remove'});});return b.promise();},_getGroupIndex:function(i){var G=this.oModel.getProperty("/groups"),o=this._getNewGroupInfo(G,i);if(o){return o.newGroupIndex;}},_convertTile:function(C,e,d){var s=d.tile?d.tile:d,n=d.srcGroupId?this._getGroupIndex(d.srcGroupId):undefined,G=d.srcGroupId?this.oModel.getProperty("/groups/"+n):s.getParent().getBindingContext().getObject(),t=s.getBindingContext().sPath.split("/"),o=s.getBindingContext().getObject(),a=t[t.length-2],b=o.uuid,f=parseInt(t[t.length-1],10),h=d.toIndex!==undefined?d.toIndex:undefined,r,A=this.oModel.getProperty("/tileActionModeActive"),i=d.toGroupId?this._getGroupIndex(d.toGroupId):G.index,j=d.toGroupId?this.oModel.getProperty("/groups/"+i):G;var I=this._getIndexForConvert(a,f,h,G,j),k={"tileIndex":f,"groupIndex":n,"group":G};this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.moveTile(o.object,I.tileIndex,I.newTileIndex,G.object,j.object,a==="links"?"tile":"link");}catch(l){this._resetGroupsOnFailure("fail_to_move_tile_msg");return;}o.tileIsBeingMoved=true;r.done(this._handleAfterSortable($.proxy(function(b,m){var p=this._getPathOfTile(b);if(p){this._checkRequestQueue();this.oPageBuilderService.getTileView(m).done(function(v){if(a==="tiles"){this._attachLinkPressHandlers(v);this._addDraggableAttribute(v);this._changeLinkScope(v,A&&a!=='links'?'Actions':'Display');}var q={"tileIndex":h,"groupIndex":i,"group":j},u={"tile":o,"view":v,"type":a,"tileObj":m};this.replaceTileViewAfterConvert(k,q,u);this.updateTilesAssociation();sap.ushell.utils.handleTilesVisibility();if(d.callBack){d.callBack(v);}}.bind(this));}},this,b)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_move_tile_msg")));},this));},replaceTileViewAfterConvert:function(s,d,t){var o=t.tile,a=o.content;o.tileIsBeingMoved=false;o.content=[t.view];o.object=t.tileObj;o.originalTileId=this.oPageBuilderService.getTileId(t.tileObj);s.group[t.type].splice(s.tileIndex,1);if(d.tileIndex!==undefined){d.group[t.type==="tiles"?"links":"tiles"].splice(d.tileIndex,0,o);}else{d.group[t.type==="tiles"?"links":"tiles"].push(o);}this.oModel.setProperty("/groups/"+d.groupIndex,d.group);this.oModel.setProperty("/groups/"+s.groupIndex,s.group);if(t.type==="links"){this._handleTileAppearanceAnimation(o.content[0].getParent());}else{this._handleTileAppearanceAnimation(o.content[0]);}if(a&&a[0]){a[0].destroy();}},_getIndexForConvert:function(t,a,n,G,d){var b;if(t==="tiles"){if(n!==undefined){b=d[t].length+n;}else{b=d[t].length+d["links"].length;}if(G.groupId===d.groupId){b--;}}else{b=n?n:G['tiles'].length;a+=G["tiles"].length;}return{"tileIndex":a,"newTileIndex":b};},_getIndexForMove:function(t,a,n,d,s){var b;if(t==="tiles"){b=n!==undefined?n:d[t].length;}else{if(n!==undefined){b=d["tiles"].length+n;}else{b=d["tiles"].length+d["links"].length;}a+=s["tiles"].length;}return{"tileIndex":a,"newTileIndex":b};},_moveLink:function(C,e,d){this._moveTile(C,e,d);},_getTileInfo:function(G,t,i){var o;jQuery.each(G,function(n,a){var f=false;jQuery.each(a[i],function(b,d){if(d.uuid===t){o={"oTile":d,"tileIndex":b,"oGroup":a,"groupIndex":n};f=true;return false;}});return!f;});return o;},_getNewGroupInfo:function(G,n){var N;jQuery.each(G,function(a,t){if(t.groupId===n){N={"oNewGroup":t,"newGroupIndex":a};}});return N;},_moveTile:function(C,e,d){var n=d.toIndex,N=d.toGroupId,t=d.sTileId,s=d.source,a=d.sTileType==="tiles"||d.sTileType==="tile"?"tile":"link",b=d.sToItems,f=d.sFromItems,h=sap.ushell.Container.getService("LaunchPage"),A=this.oModel.getProperty("/tileActionModeActive"),G=this.oModel.getProperty("/groups"),S,o,r,p,i,j,I={};i=this._getTileInfo(G,t,f);j=this._getNewGroupInfo(G,N);if(i.oGroup.groupId==j.oNewGroup.groupId&&(s==="movetileDialog"||n===null||s==="movelinkDialog")){return;}if(a==="link"){i.oTile.content[0].addStyleClass("sapUshellZeroOpacity");}if(a==="tile"&&b==='tiles'){if(n&&n>j.oNewGroup[b].length){n=j.oNewGroup[b].length;}}if(i.oGroup.groupId===N&&b===f){if(n===null||n===undefined){i.oGroup[b].splice(i.tileIndex,1);n=i.oGroup[b].length;i.oGroup[b].push(i.oTile);}else{n=this._adjustTileIndex(n,i.oTile,i.oGroup,b);this._moveInArray(i.oGroup[b],i.tileIndex,n);}this.oModel.setProperty("/groups/"+i.groupIndex+"/"+b,i.oGroup[b]);}else{p=this.oModel.getProperty("/personalization");i.oGroup[f].splice(i.tileIndex,1);i.oGroup.visibilityModes=sap.ushell.utils.calcVisibilityModes(i.oGroup,p);this.oModel.setProperty("/groups/"+i.groupIndex+"/"+f,i.oGroup[f]);if(n===null||n===undefined){n=j.oNewGroup[b].length;j.oNewGroup[b].push(i.oTile);}else{n=this._adjustTileIndex(n,i.oTile,j.oNewGroup,b);j.oNewGroup[b].splice(n,0,i.oTile);}j.oNewGroup.visibilityModes=sap.ushell.utils.calcVisibilityModes(j.oNewGroup,p);this.oModel.setProperty("/groups/"+j.newGroupIndex+"/"+b,j.oNewGroup[b]);}this.updateTilesAssociation();sap.ushell.utils.handleTilesVisibility();S=this.oModel.getProperty("/groups/"+i.groupIndex);o=this.oModel.getProperty("/groups/"+j.newGroupIndex);I=this._getIndexForMove(f,i.tileIndex,n,j.oNewGroup,S);this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.moveTile(i.oTile.object,I.tileIndex,I.newTileIndex,S.object,o.object,a);}catch(k){this._resetGroupsOnFailure("fail_to_move_tile_msg");return;}i.oTile.tileIsBeingMoved=true;r.done(this._handleAfterSortable($.proxy(function(t,l){var m,u=[h.getTileTitle(i.oTile.object),h.getGroupTitle(S.object),h.getGroupTitle(o.object),t];sap.ushell.Container.getService("UsageAnalytics").logCustomEvent(this.analyticsConstants.PERSONALIZATION,this.analyticsConstants.MOVE_TILE,u);m=this._getPathOfTile(t);if(m){this.oModel.setProperty(m+"/object",l);this.oModel.setProperty(m+"/originalTileId",this.oPageBuilderService.getTileId(l));this._checkRequestQueue();this.oPageBuilderService.getTileView(l).done(function(v){var q=this.oModel.getProperty(m+"/content");if(b==='links'){this._changeLinkScope(v,A?"Actions":"Display");this._attachLinkPressHandlers(v);this._addDraggableAttribute(v);this._handleTileAppearanceAnimation(v);i.oTile.content=[v];this.oModel.setProperty(m,jQuery.extend({},i.oTile));this.oModel.setProperty("/groups/"+j.newGroupIndex+"/"+b,this.oModel.getProperty("/groups/"+j.newGroupIndex+"/"+b));}else{this.oModel.setProperty(m+"/content",[v]);}if(q&&q[0]){var w=v.onAfterRendering;v.onAfterRendering=function(){w.apply(this);q[0].destroy();v.onAfterRendering=w;}}this.oModel.setProperty(m+"/tileIsBeingMoved",false);if(d.callBack){d.callBack(v);}}.bind(this));}},this,t)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_move_tile_msg")));},this));},_adjustTileIndex:function(n,t,a,I){var v=0,b=false,i=0;for(i=0;i<a[I].length&&v<n;i++){if(a[I][i].isTileIntentSupported){if(a[I][i]===t){b=true;}else{v++;}}}if(b){return i-1;}return i;},getModel:function(){return this.oModel;},getDashboardView:function(){return this.oDashboardView;},updateTilesAssociation:function(){this.mapCatalogTilesToGroups();this.updateCatalogTilesToGroupsMap();},loadAllCatalogs:function(C,e,d){var G=new jQuery.Deferred(),t=this,s;G.resolve();s=function(){G.done(function(){var a=t.getModel().getProperty("/groups");if(a&&a.length!==0){t.updateTilesAssociation();}});};if(!this.oModel.getProperty("/catalogs")){if(!this.oModel.getProperty("/groups")||this.oModel.getProperty("/groups").length===0){G=this.loadPersonalizedGroups();}this._destroyAllGroupModels("/catalogs");this._destroyAllTileModels("/catalogTiles");this.oModel.setProperty("/catalogs",[]);this.oModel.setProperty("/catalogSearchEntity",{appBoxes:[],customTiles:[]});this.aPromises=[];jQuery.sap.measure.start("FLP:DashboardManager.GetCatalogsRequest","GetCatalogsRequest","FLP");jQuery.sap.measure.start("FLP:DashboardManager.getCatalogTiles","getCatalogTiles","FLP");jQuery.sap.measure.pause("FLP:DashboardManager.getCatalogTiles");jQuery.sap.measure.start("FLP:DashboardManager.BuildCatalogModelWithRendering","BuildCatalogModelWithRendering","FLP");jQuery.sap.measure.pause("FLP:DashboardManager.BuildCatalogModelWithRendering");sap.ushell.Container.getService("LaunchPage").getCatalogs().done(function(a){jQuery.sap.measure.end("FLP:DashboardManager.GetCatalogsRequest");jQuery.sap.measure.end("FLP:DashboardManager.getCatalogTiles");jQuery.when.apply(jQuery,this.aPromises).then(function(){t.onDoneLoadingCatalogs(a);});s();}.bind(this)).fail(t._showLocalizedErrorHelper("fail_to_load_catalog_msg")).progress(this.addCatalogToModel.bind(this));}else{s();}},updateCatalogTilesToGroupsMap:function(){var C=this.getModel().getProperty("/catalogs"),i,t,a,G,b,d,e,f,A,o,s=sap.ushell.Container.getService("LaunchPage");if(C){for(i=0;i<C.length;i++){d=C[i].appBoxes;if(d){for(f=0;f<d.length;f++){A=d[f];t=encodeURIComponent(s.getCatalogTileId(A.src));G=this.oTileCatalogToGroupsMap[t];a=G?G:[];A.associatedGroups=a;}}b=C[i].customTiles;if(b){for(e=0;e<b.length;e++){o=b[e];t=encodeURIComponent(s.getCatalogTileId(o.src));G=this.oTileCatalogToGroupsMap[t];a=G?G:[];o.associatedGroups=a;}}}}this.getModel().setProperty("/catalogs",C);},_getIsIntentSupported:function(C){var s=sap.ushell.Container.getService("LaunchPage"),i=!!(s.isTileIntentSupported(C));return i;},_getIsAppBox:function(C){if(!sap.ushell.Container){return false;}var s=sap.ushell.Container.getService("LaunchPage"),i=!!(s.getCatalogTileTargetURL(C)&&(s.getCatalogTilePreviewTitle(C)||s.getCatalogTilePreviewSubtitle(C)));return i;},createCatalogAppBoxes:function(C,G){var s=sap.ushell.Container.getService("LaunchPage"),a=encodeURIComponent(s.getCatalogTileId(C)),b=this.oTileCatalogToGroupsMap[a]||[],t=s.getCatalogTileTags(C)||[];if(t.length>0){this.tagsPool=this.tagsPool.concat(t);}var n=undefined;if(C.tileResolutionResult){n=C.tileResolutionResult.navigationMode;}if(G){s.getCatalogTileView(C);}return{id:a,associatedGroups:b,src:C,title:s.getCatalogTilePreviewTitle(C),subtitle:s.getCatalogTilePreviewSubtitle(C),icon:s.getCatalogTilePreviewIcon(C),keywords:G?(s.getCatalogTileKeywords(C)||[]).join(','):[],tags:t,navigationMode:n,url:s.getCatalogTileTargetURL(C)};},addCatalogToModel:function(C){var s=sap.ushell.Container.getService("LaunchPage"),o={title:s.getCatalogTitle(C),id:s.getCatalogId(C),numberTilesSupportedOnCurrectDevice:0,static:false,customTiles:[],appBoxes:[]},p;jQuery.sap.measure.resume("FLP:DashboardManager.getCatalogTiles");p=s.getCatalogTiles(C);this.aPromises.push(p);p.done(function(a){jQuery.sap.measure.pause("FLP:DashboardManager.getCatalogTiles");if(!a.length){return;}this.aPendingCatalogQueue.push({oCatalogEntry:a,oCatalogModel:o});if(this.skippedProcessCatalogs<10){clearTimeout(this.oprocessCatalogsTimer);this.skippedProcessCatalogs++;this.oprocessCatalogsTimer=setTimeout(function(){this.processPendingCatalogs();}.bind(this),20);}}.bind(this)).fail(this._showLocalizedErrorHelper("fail_to_load_catalog_tiles_msg"));},loadCustomTilesKeyWords:function(){var f;if(this.aFnToGetTileView){while(this.aFnToGetTileView.length>0){f=this.aFnToGetTileView.pop();f();}}},processPendingCatalogs:function(){var t=this,C=this.oModel.getProperty('/catalogs'),p,o,a,e,i,b,d,f,h=sap.ui.getCore().getEventBus(),A,j=this.oModel.getProperty('/masterCatalogs')||[{title:g("all")}];jQuery.sap.measure.resume("FLP:DashboardManager.BuildCatalogModelWithRendering");this.skippedProcessCatalogs=0;while(this.aPendingCatalogQueue.length>0){p=this.aPendingCatalogQueue.shift(),o=p.oCatalogEntry,a=p.oCatalogModel,e=this.searchModelCatalogByTitle(a.title),b=this.oModel.getProperty('/catalogSearchEntity');if(e.result){d=this.oModel.getProperty('/catalogs')[e.indexOfPreviousInstanceInModel];i=false;}else{i=true;d=a;}o.forEach(function(o,k){if(this._getIsIntentSupported(o)){if(this._getIsAppBox(o)){A=this.createCatalogAppBoxes(o,true);d.appBoxes.push(A);b.appBoxes.push(A);}else{f=this.createCatalogTiles(o);d.customTiles.push(f);if(!this.aFnToGetTileView){this.aFnToGetTileView=[];}this.aFnToGetTileView.push((function(o){return function(){var f=t.createCatalogTiles(o,true);b.customTiles.push(f);};})(o));}}}.bind(this));if(d.appBoxes.length>0||d.customTiles.length>0){if(i){C.push(a);j.push({title:a.title});}}}this.oModel.setProperty('/masterCatalogs',j);this.oModel.setProperty('/catalogs',C);h.publish("launchpad","afterCatalogSegment");jQuery.sap.measure.pause("FLP:DashboardManager.BuildCatalogModelWithRendering");},searchModelCatalogByTitle:function(a){var b=this.oModel.getProperty('/catalogs'),d=false,i,n=0,G=false;$.each(b,function(e,t){if(t.title===sap.ushell.resources.i18n.getText('catalogsLoading')){G=true;}else if(a==t.title){i=e;n=t.numberOfTiles;d=true;return false;}});return{result:d,indexOfPreviousInstanceInModel:i,indexOfPreviousInstanceInPage:G?i-1:i,numOfTilesInCatalog:n};},getTagList:function(m){var i={},d=0,t=[],e,o,s;for(d=0;d<this.tagsPool.length;d++){o=this.tagsPool[d];if(i[o]){i[o]++;}else{i[o]=1;}}for(e in i){t.push({tag:e,occ:i[e]});}s=t.sort(function(a,b){return b.occ-a.occ;});if(s.length===0){this.oModel.setProperty("/tagFiltering",false);}if(m){this.oModel.setProperty("/tagList",s.slice(0,m));}else{this.oModel.setProperty("/tagList",s);}},onDoneLoadingCatalogs:function(C){if(!C.length){this.oModel.setProperty("/catalogsNoDataText",sap.ushell.resources.i18n.getText('noCatalogs'));}var e=sap.ui.getCore().getEventBus();e.publish("launchpad","catalogContentLoaded");var s=sap.ushell.Container.getService("LaunchPage"),l=C.filter(function(o){return!s.getCatalogError(o);});if(l.length!==C.length){this._showLocalizedError("partialCatalogFail");}if(this.oModel.getProperty("/tagFiltering")===true){this.getTagList();}sap.ushell.utils.handleTilesVisibility();},createCatalogTiles:function(C,G){var s=sap.ushell.Container.getService("LaunchPage"),t,a=encodeURIComponent(s.getCatalogTileId(C)),b=this.oTileCatalogToGroupsMap[a]||[],d=s.getCatalogTileTags(C)||[];if(d.length>0){this.tagsPool=this.tagsPool.concat(d);}t=new T({state:"Loading"});if(G){s.getCatalogTileView(C);}return{associatedGroups:b,src:C,catalog:C.title,catalogId:C.id,title:s.getCatalogTileTitle(C),tags:d,keywords:G?(s.getCatalogTileKeywords(C)||[]).join(','):[],id:a,size:s.getCatalogTileSize(C),content:[t],isTileIntentSupported:s.isTileIntentSupported(C),tileType:C.tileType};},calculateCatalogTileIndex:function(a,n,t){var r=parseInt(a*100000,10);r+=(n!==undefined?n:0)+t;return r;},mapCatalogTilesToGroups:function(){this.oTileCatalogToGroupsMap={};var G=this.oModel.getProperty("/groups"),s=sap.ushell.Container.getService("LaunchPage"),i=0,o,t,a,b,d,e;for(i=0;i<G.length;i++){o=G[i];a=o.tiles;if(a){for(t=0;t<a.length;++t){b=encodeURIComponent(s.getCatalogTileId(a[t].object));d=this.oTileCatalogToGroupsMap[b]||[];e=s.getGroupId(o.object);if(d.indexOf(e)===-1&&(typeof(o.isGroupVisible)==='undefined'||o.isGroupVisible)&&!o.isGroupLocked){d.push(e);}this.oTileCatalogToGroupsMap[b]=d;}}}},_showLocalizedMessage:function(m,p,t){sap.ushell.Container.getService("Message").show(t||M.Type.INFO,g(m,p),p);},_showLocalizedError:function(m,p){this._showLocalizedMessage(m,p,M.Type.ERROR);},_showLocalizedErrorHelper:function(m,p){var t=this;return function(){t._showLocalizedError(m,p);};},_resetGroupsOnFailureHelper:function(m){var t=this;return function(G){t._showLocalizedError(m);t._requestFailed();setTimeout(function(){t.loadGroupsFromArray(G);});};},_resetGroupsOnFailure:function(m,p){this._requestFailed();this._showLocalizedError(m,p);this.loadPersonalizedGroups();this.oModel.updateBindings(true);},resetGroupsOnFailure:function(){this._resetGroupsOnFailure.apply(this,arguments);},_bindSegment:function(G,s){var a,o,S,b;for(a=0;a<s.length;a++){S=s[a];b=S.index;o=G[b];if(o){o.isRendered=true;o.tiles=o.tiles.concat(S.tiles);o.links=o.links.concat(S.links);}}return G;},createGroupsModelFrame:function(G,p){var a,C=[],o,f;f=function(b){var d=jQuery.extend({},b);d.tiles=[];d.pendingLinks=[];d.links=[];return d;};for(a=0;a<G.length;a++){o=G[a];C[a]=f(o);C[a].isRendered=false;C[a].visibilityModes=sap.ushell.utils.calcVisibilityModes(o,p);}return C;},_splitGroups:function(s,G,f){var a,t,b=s,p=f,d=[],e,h,i,j=["tiles","pendingLinks"],o=1,C,I=(this.oModel.getProperty("/homePageGroupDisplay")&&this.oModel.getProperty("/homePageGroupDisplay")==='tabs'),k;C=function(l){var m=jQuery.extend({},l);m.tiles=[];m.pendingLinks=[];return m;};for(a=0;a<G.length;a++){k=G[a];e=C(k);d.push(e);for(h=0;h<j.length;h++){i=j[h];o=this.PagingManager.getSizeofSupportedElementInUnits(i==='pendingLinks'?'link':'tile');for(t=0;t<k[i].length;t++){if(p<=0){p=b;if(d){if(I){d.iGroupIndex=a;}this.segmentsStore.push(d);}e=C(k);d=[];d.push(e);}e[i].push(k[i][t]);p-=o;}}if(I){if(d){d.iGroupIndex=a;this.segmentsStore.push(d);d=[];}}}if(d){if(!I){this.segmentsStore.push(d);}}},_processSegment:function(m){var e=sap.ui.getCore().getEventBus(),a,b,t;if(this.segmentsStore.length>0){a=this.segmentsStore.shift();b=a[0].index;t=m[b].tiles.length+m[b].pendingLinks.length;if(this.isBlindLoading()===false){if(this.oModel.getProperty("/homePageGroupDisplay")&&this.oModel.getProperty("/homePageGroupDisplay")==='tabs'){if(a.iGroupIndex===this.iTabSelected){this.getSegmentContentViews(a);}else{if(!this.oSegmentedTabTileViewDB[a.iGroupIndex]){this.oSegmentedTabTileViewDB[a.iGroupIndex]=[];}this.oSegmentedTabTileViewDB[a.iGroupIndex].push(a);}}else{this.getSegmentContentViews(a);}}m=this._bindSegment(m,a);this.oModel.setProperty('/groups',m);this._updateModelWithTileView(b,t);this._handleSegment();}else{this._updateModelWithTileView(0,0);sap.ushell.utils.handleTilesVisibility();e.publish("launchpad","dashboardModelContentLoaded");}},getSegmentContentViews:function(a){var n,b,s,S;for(n=0;n<a.length;n++){s=a[n];for(b=0;b<s.tiles.length;b++){S=s.tiles[b];this.getTileView(S);}for(b=0;b<s.links.length;b++){S=s.links[b];this.getTileView(S,s.index);}}},getSegmentTabContentViews:function(C,e,p){var n,s,S=p.iSelectedGroup,G;G=this.oModel.getProperty("/groups/"+S);for(n=0;n<G.tiles.length;n++){s=G.tiles[n];this.getTileView(s);}for(n=0;n<G.links.length;n++){s=G.links[n];this.getTileView(s,S);}this.oSegmentedTabTileViewDB[S]=[];},_handleBookmarkModelUpdate:function(){this.bIsGroupsModelDirty=false;this.bGroupsModelLoadingInProcess=true;this.loadPersonalizedGroups();},_modelLoaded:function(){this.bGroupsModelLoadingInProcess=false;if(this.bIsGroupsModelDirty){this._handleBookmarkModelUpdate();}},_handleSegment:function(){clearTimeout(this.oSegmentTimer);this.oSegmentTimer=setTimeout(function(){this._processSegment(this.oModel.getProperty('/groups'));}.bind(this),100);},loadGroupsFromArray:function(G){var t=this;jQuery.sap.measure.start("FLP:DashboardManager.loadGroupsFromArray","loadGroupsFromArray","FLP");this.oPageBuilderService.getDefaultGroup().done(function(d){if(G.length==0&&d==undefined){return;}var i=0,l=[],b,a=G.indexOf(d),n,N,e=[],o,f,h,s,m,j,k,p,q={desktop:5,tablet:10,phone:15},r=0,u=0,v,w=0,z,A=0,B;G.splice(a,1);while(i<G.length){o=G[i];f=t.oPageBuilderService.isGroupLocked(o);if(f){l.push(o);G.splice(i,1);}else{i++;}}n=l.length;if(!t.oModel.getProperty('/disableSortedLockedGroups')){l.sort(function(x,y){var C=t.oPageBuilderService.getGroupTitle(x).toLowerCase(),F=t.oPageBuilderService.getGroupTitle(y).toLowerCase();return C<F?-1:1;});}b=l;b.push(d);b.push.apply(b,G);G=b;h=G.length;m=t.oModel.getProperty("/groups/length");t.oModel.setProperty("/groups/indexOfDefaultGroup",n);for(i=h;i<m;++i){t._destroyGroupModel("/groups/"+i);}if(!t.PagingManager){t.PagingManager=new P('dashboardPaging',{supportedElements:{tile:{className:'sapUshellTile'},link:{className:'sapUshellLinkTile'}},containerHeight:window.innerHeight,containerWidth:window.innerWidth});}if(t.PagingManager.currentPageIndex===0){t.PagingManager.moveToNextPage();r=t.PagingManager._calcElementsPerPage();}k=t.PagingManager.getSizeofSupportedElementInUnits('link');p=t.PagingManager.getSizeofSupportedElementInUnits('tile');jQuery.sap.measure.start("FLP:DashboardManager._getGroupModel","_getGroupModel","FLP");for(i=0;i<h;++i){N=t._getGroupModel(G[i],i===n,i===h-1);N.index=i;w+=N.tiles.length*p+N.links.length*k;if(N.isGroupVisible){A+=N.tiles.length*p+N.links.length*k;}t.bIsScorllModeAccordingKPI=A>t.iMinNumOfBUForBlindLoading;e.push(N);}t.oModel.setProperty("/iSelectedGroup",s);jQuery.sap.measure.end("FLP:DashboardManager._getGroupModel");if(sap.ui.Device.system.desktop){u=q.desktop;}else if(sap.ui.Device.system.tablet){u=q.tablet;}else{u=q.phone;}j=(w-r)/u;if(j<14){j=14;}v=t.createGroupsModelFrame(e,t.oModel.getProperty("/personalization"));t._splitGroups(j,e,r);jQuery.sap.measure.start("FLP:DashboardManager._processSegment","_processSegment","FLP");t._processSegment(v);for(var i=0;i<v.length;i++){if(v[i].isGroupVisible&&v[i].visibilityModes[0]){t.oModel.setProperty("/groups/"+i+"/isGroupSelected",true);t.oModel.setProperty("/iSelectedGroup",i);t.iTabSelected=i;break;}}if(t.oModel.getProperty("/homePageGroupDisplay")&&t.oModel.getProperty("/homePageGroupDisplay")==='tabs'){z=t.getDashboardView();B=z.oDashboardGroupsBox;B.getBinding('groups').filter([z.oFilterSelectedGroup]);}jQuery.sap.measure.end("FLP:DashboardManager._processSegment");t.oModel.setProperty("/groups/length",v.length);if(t.oModel.getProperty('/currentState/stateName')==="catalog"){}jQuery.sap.measure.end("FLP:DashboardManager.loadGroupsFromArray");}).fail(t._resetGroupsOnFailureHelper("fail_to_get_default_group_msg"));},_loadGroup:function(n,G,h){var t=this,s="/groups/"+n,d=t.oModel.getProperty("/groups/indexOfDefaultGroup"),i=t.oModel.getProperty(s).isLastGroup,o,N;this._destroyGroupModel(s);o=this.oModel.getProperty(s+"/groupId");N=this._getGroupModel(G,n===d,i,undefined,h);if(o){N.groupId=o;}N.index=n;N.isRendered=true;this.oModel.setProperty(s,N);},_getGroupModel:function(G,d,l,o,h){var s=this.oPageBuilderService,a=(G&&s.getGroupTiles(G))||[],m=[],b=[],i,e,f=this.getModel();e=f.getProperty("/personalization");var j=G&&s.isGroupLocked(G)?true:false;for(i=0;i<a.length;++i){var t=a[i],k=s.getTileType(t).toLowerCase();if(k==="tile"){m.push(this._getTileModel(a[i],j,k,h));}else if(k==="link"){b.push(this._getTileModel(a[i],j,k,h));}else{jQuery.sap.log.error("Unknown tile type: '"+k+"'",undefined,"sap.ushell.components.flp.launchpad.DashboardManager");}}return{title:(d&&g("my_group"))||(G&&s.getGroupTitle(G))||(o&&o.title)||"",object:G,groupId:jQuery.sap.uid(),links:b,pendingLinks:[],tiles:m,isDefaultGroup:d||false,editMode:!G,isGroupLocked:j,visibilityModes:[true,true],removable:!G||s.isGroupRemovable(G),sortable:e,isGroupVisible:!G||s.isGroupVisible(G),isEnabled:!d,isLastGroup:l||false,isRendered:o?!!o.isRendered:false,isGroupSelected:false};},_hasPendingLinks:function(m){for(var i=0;i<m.length;i++){if(m[i].content[0]===undefined){return true;}}return false;},_addTileToGroup:function(G,t){var s=G+"/tiles",o=this.oModel.getProperty(G),n=this.oModel.getProperty(s).length,a=this.oPageBuilderService,b=a.getTileType(t);var i=this.oModel.getProperty(G+"/isGroupLocked"),p=this.oModel.getProperty("/personalization");o.tiles[n]=this._getTileModel(t,i,b,this._addModelToTileViewUpdateQueue);this.getTileView(o.tiles[n]);o.visibilityModes=sap.ushell.utils.calcVisibilityModes(o,p);this._updateModelWithTileView(o.index,n);this.oModel.setProperty(G,o);},_addAndUpdateModelWithTileView:function(t,o){this._addModelToTileViewUpdateQueue(t,o);this._updateModelWithTileView(0,0);},_addModelToTileViewUpdateQueue:function(t,o){this.tileViewUpdateQueue.push({uuid:t,view:o});},_updateModelWithTileView:function(s,a){var t=this;if(this.tileViewUpdateTimeoutID){clearTimeout(this.tileViewUpdateTimeoutID);}this.tileViewUpdateTimeoutID=setTimeout(function(){t.tileViewUpdateTimeoutID=undefined;t.oSortableDeferred.done(function(){t._updateModelWithTilesViews(s,a);});},50);},_updateGroupModelWithTilesViews:function(t,s,h,i){var o,u,S,l,a=s||0;for(var j=a;j<t.length;j=j+1){o=t[j];for(var q=0;q<this.tileViewUpdateQueue.length;q++){u=this.tileViewUpdateQueue[q];if(o.uuid==u.uuid){h.push(q);if(u.view){if(i){o.content=[u.view];}else{o.content[0].destroy();o.content=[u.view];}this.oDashboardLoadingManager.setTileResolved(o);S=this.oPageBuilderService.getTileSize(o.object);l=((S!==null)&&(S==="1x2"))||false;if(o['long']!==l){o['long']=l;}}else{o.content[0].setState("Failed");}break;}}}},_updateModelWithTilesViews:function(s,a){var G=this.oModel.getProperty("/groups"),b=s||0,h=[];if(!G||this.tileViewUpdateQueue.length===0){return;}for(var i=b;i<G.length;i=i+1){this._updateGroupModelWithTilesViews(G[i].tiles,a,h);if(G[i].links){this._updateGroupModelWithTilesViews(G[i].links,a,h,true);if(G[i].pendingLinks.length>0){if(!G[i].links){G[i].links=[];}G[i].links=G[i].links.concat(G[i].pendingLinks);G[i].pendingLinks=[];}}}var t=[],d;for(d=0;d<this.tileViewUpdateQueue.length;d++){if(h.indexOf(d)===-1){t.push(this.tileViewUpdateQueue[d]);}}this.tileViewUpdateQueue=t;this.oModel.setProperty("/groups",G);},getModelTileById:function(i,I){var G=this.oModel.getProperty('/groups'),m,f=false;G.every(function(o,a){o[I].every(function(t,a){if(t.uuid===i||t.originalTileId===i){m=t;f=true;}return!f;});return!f;});return m;},_addDraggableAttribute:function(v){if(this.isIeHtml5DnD()){v.addEventDelegate({onAfterRendering:function(){this.$().attr("draggable","true");}.bind(v)});}},_attachLinkPressHandlers:function(v){var e=sap.ui.getCore().getEventBus(),t=v.attachPress?v:v.getContent()[0];t.attachPress(function(o){var b=v.getBindingContext().getObject().tileIsBeingMoved;if(!b&&this.getScope&&this.getScope()==="Actions"){switch(o.getParameters().action){case"Press":sap.ushell.components.flp.ActionMode._openActionsMenu(o,v);break;case"Remove":var a=v.getBindingContext().getObject().uuid;e.publish("launchpad","deleteTile",{tileId:a,items:'links'});break;}}else{sap.ui.getCore().getEventBus().publish("launchpad","dashboardTileLinkClick");}});},getTileView:function(t,G){var d,a=this,s=this.oPageBuilderService,m,b,o,u=this._addModelToTileViewUpdateQueue,e,n=false,f=t.uuid;if(a.oDashboardLoadingManager.isTileViewRequestIssued(t)){return;}this.oDashboardLoadingManager.setTileInProgress(t);s.setTileVisible(t.object,false);d=s.getTileView(t.object);d.done(function(v){if(v.oController&&!t.isCustomTile){t.target=v.oController.navigationTargetUrl;}e=v;if(e.getComponentInstance){jQuery.sap.measure.average("FLP:getComponentInstance","get info for navMode","FLP1");var C=e.getComponentInstance().getComponentData();if(C&&C.properties){t.navigationMode=C.properties.navigationMode;}jQuery.sap.measure.end("FLP:getComponentInstance");}a.oDashboardLoadingManager.setTileResolved(t);m=v.getMode?v.getMode():"ContentMode";if(a.bLinkPersonalizationSupported&&m==="LineMode"){a._attachLinkPressHandlers(e);a._addDraggableAttribute(e);if(G!=undefined){b=a.oModel.getProperty("/groups");if(b[G]){t.content=[e];o=a.oModel.getProperty("/groups/"+G+"/links");a.oModel.setProperty("/groups/"+G+"/links",[]);a.oModel.setProperty("/groups/"+G+"/links",o);}}}else{if(a.isBlindLoading()){if(t.content.length>0){t.content[0].destroy();}t.content=[e];if(G){var h=a.oModel.getProperty("/groups/"+G);a.oModel.setProperty("/groups/"+G,h);}}}if(a.isBlindLoading()){var S=a.oPageBuilderService.getTileSize(t.object);var l=((S!==null)&&(S==="1x2"))||false;if(t['long']!==l){t['long']=l;}}else{if(m==="LineMode"){t.content=[e];if(n){o=a.oModel.getProperty("/groups/"+G+"/links");a.oModel.setProperty("/groups/"+G+"/links",[]);a.oModel.setProperty("/groups/"+G+"/links",o);}}else if(t.content.length===0){t.content=[e];}else{u.apply(a,[f,e]);a._updateModelWithTileView(0,0);}}});d.fail(function(){if(a.sTileType==="link"){if(!this.bLinkPersonalizationSupported){e=new T({state:"Failed"});}else{var L=sap.ushell.Container.getService("LaunchPage");var h=L.getCatalogTilePreviewSubtitle(t);h=(!h||!h.length)?undefined:h;var i=L.getCatalogTilePreviewTitle(t);i=((!i||!i.length)&&!h)?sap.ushell.resources.i18n.getText('cannotLoadLinkInformation'):i;e=new sap.m.GenericTile({mode:"LineMode",state:"Failed",header:i,subheader:h});}}else{e=new T({state:"Failed"});}t.content=[e];});if(!e){if(s.getTileType(t.object)==="link"){n=true;e=new sap.m.GenericTile({mode:"LineMode"});}else{e=new T();}t.content=[e];}},_getTileModel:function(t,i,s,u){var a=this.oPageBuilderService,b=jQuery.sap.uid(),o,d;this.sTileType=s;var S=a.getTileSize(t);var l=[];if(s==="link"){l=[new sap.m.GenericTile({mode:"LineMode"})];}d={"isCustomTile":!this._getIsAppBox(t),"object":t,"originalTileId":a.getTileId(t),"uuid":b,"tileCatalogId":encodeURIComponent(a.getCatalogTileId(t)),"content":l,"long":((S!==null)&&(S==="1x2"))||false,"target":a.getTileTarget(t)||"","debugInfo":a.getTileDebugInfo(t),"isTileIntentSupported":a.isTileIntentSupported(t),"rgba":"","isLocked":i,"showActionsIcon":this.oModel.getProperty("/tileActionsIconEnabled")||false,"navigationMode":this.navigationMode};return d;},isIeHtml5DnD:function(){return!!((sap.ui.Device.browser.msie||sap.ui.Device.browser.edge)&&sap.ui.Device.browser.version>=11&&(sap.ui.Device.system.combi||sap.ui.Device.system.tablet));},_destroyAllGroupModels:function(t){var G=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(G){for(i=0;i<G.length;i=i+1){this._destroyGroupModel(G[i]);}}},_destroyGroupModel:function(t){var G=(typeof t==="string")?this.oModel.getProperty(t):t;if(G){this._destroyAllTileModels(G.tiles);}},_destroyAllTileModels:function(t){var a=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(a){for(i=0;i<a.length;i=i+1){this._destroyTileModel(a[i]);}}},_destroyTileModel:function(t){var o=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(o&&o.content){for(i=0;i<o.content.length;i=i+1){o.content[i].destroy();}}},loadPersonalizedGroups:function(){var t=this,G=this.oPageBuilderService.getGroups(),d=new jQuery.Deferred();G.done(function(a){t.loadGroupsFromArray(a);d.resolve();});G.fail(function(){t._showLocalizedErrorHelper("fail_to_load_groups_msg")();d.reject();});return d;}});return c;});
