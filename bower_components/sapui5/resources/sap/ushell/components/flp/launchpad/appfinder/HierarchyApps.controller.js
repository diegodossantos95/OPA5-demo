// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(function(){"use strict";sap.ui.controller("sap.ushell.components.flp.launchpad.appfinder.HierarchyApps",{onInit:function(){var e=this.getView().getViewData().easyAccessSystemsModel;if(e){this.getView().setModel(e,"easyAccessSystems");}},getCrumbsData:function(p,m){var a=p.split("/");a.splice(a.length-2,2);var n=[];while(a.length){var P=a.join("/");var t=m.getProperty(P+"/text");n.unshift({text:t,path:P});a.splice(a.length-2,2);}return n;},_updateAppBoxedWithPinStatuses:function(p){var v=this.getView();if(!p){p=v.layout.getBinding("items").getPath();}var e=v.getModel("easyAccess");var a=e.getProperty(p)?e.getProperty(p):[];var b=sap.ushell.Container.getService("Bookmark");var c=a.map(function(d){return b.countBookmarks(d.url).then(function(f){d.bookmarkCount=f;return d;});});jQuery.when.apply(jQuery,c).then(function(){var a=Array.prototype.slice.call(arguments);e.setProperty(p,a);});},updatePageBindings:function(p){this.getView().layout.bindAggregation("items","easyAccess>"+p+"/apps",this.getView().oItemTemplate);this._updateAppBoxedWithPinStatuses(p+"/apps");this.getView().breadcrumbs.bindProperty("currentLocationText","easyAccess>"+p+"/text");var c=this.getCrumbsData(p,this.getView().getModel("easyAccess"));this.getView().crumbsModel.setProperty("/crumbs",c);var n=this.getView().getModel("easyAccess").getProperty(p+'/apps');this.getView().updateResultSetMessage(n.length,false);},onAppBoxPressed:function(e){if(e.mParameters.srcControl.$().closest(".sapUshellPinButton").length){return;}var u=e.getSource().getProperty("url");if(u&&u.indexOf("#")===0){hasher.setHash(u);}},_handleSuccessMessage:function(a,p){var m;var n=p.addToGroups?p.addToGroups.length:0;var b=p.newGroups?p.newGroups.length:0;var t=n+b;if(t===1){var g;if(n===1){g=p.addToGroups[0].title;}else{g=p.newGroups[0];}m=sap.ushell.resources.i18n.getText("appAddedToSingleGroup",[a.text,g]);}else{m=sap.ushell.resources.i18n.getText("appAddedToSeveralGroups",[a.text,t]);}if(t>0){sap.m.MessageToast.show(m,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});}return m;},_prepareErrorMessage:function(e,a){var g,A,f,n=0,c=false,m;for(var i in e){g=e[i].group;A=e[i].action;if(A=='addBookmark_ToExistingGroup'){n++;if(n==1){f=g.title;}}else if(A=='addBookmark_ToNewGroup'){n++;if(n==1){f=g;}}else{c=true;}}if(c){if(e.length==1){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_create_new_group"});}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_some_actions"});}}else if(e.length==1){m=sap.ushell.resources.i18n.getText({messageId:"fail_app_operation_add_to_group",parameters:[a,f]});}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_app_operation_add_to_several_groups",parameters:[a]});}return m;},_handleBookmarkAppPopoverResponse:function(a,p){var b=[];p.newGroups.forEach(function(g){b.push(this._createGroupAndAddBookmark(g,a));}.bind(this));p.addToGroups.forEach(function(g){b.push(this._addBookmark(g,a));}.bind(this));jQuery.when.apply(jQuery,b).then(function(){var r=Array.prototype.slice.call(arguments);this._handlePopoverGroupsActionPromises(a,p,r);}.bind(this));},_handlePopoverGroupsActionPromises:function(a,p,r){var e=r.filter(function(b,i,r){return!b.status;});if(e.length){var E=this._prepareErrorMessage(e,a.text);var d=sap.ushell.components.flp.launchpad.getDashboardManager();d.resetGroupsOnFailure(E.messageId,E.parameters);return;}this._updateAppBoxedWithPinStatuses();this._handleSuccessMessage(a,p);},_createGroupAndAddBookmark:function(n,a){var d=sap.ushell.components.flp.launchpad.getDashboardManager();var b=jQuery.Deferred(),r={};var c=d.createGroup(n);c.done(function(e){var f=this._addBookmark(e.getObject(),a,true);f.done(function(g){b.resolve(g);}).fail(function(){r={group:n,status:0,action:'addBookmark_ToNewGroup'};b.resolve(r);});}.bind(this)).fail(function(){r={group:n,status:0,action:'addBookmark_NewGroupCreation'};b.resolve(r);});return b.promise();},_addBookmark:function(g,a,i){var b=sap.ushell.Container.getService("Bookmark");var d=jQuery.Deferred(),r={};var c=b.addBookmark({url:a.url,title:a.text,subtitle:a.subtitle,icon:a.icon},g.object);var e=i?"addBookmark_ToNewGroup":"addBookmark_ToExistingGroup";c.done(function(){r={group:g,status:1,action:e};d.resolve(r);}).fail(function(){r={group:g,status:0,action:e};d.resolve(r);});return d.promise();},showSaveAppPopover:function(e){var m=this.getView().getModel();var a=e.oSource.getParent().getBinding("title").getContext().getObject();if(!!m.getProperty("/groupContext").path){var g=m.getProperty("/groupContext").path;var G=m.getProperty(g);var c={newGroups:[],addToGroups:[G]};this._handleBookmarkAppPopoverResponse(a,c);return;}var b=m.getProperty("/groups").map(function(f){return{selected:false,initiallySelected:false,oGroup:f};});var p=new sap.ui.view({type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.ushell.components.flp.launchpad.appfinder.GroupListPopover",viewData:{groupData:b,enableHideGroups:m.getProperty("/enableHideGroups"),enableHelp:m.getProperty("/enableHelp"),singleGroupSelection:true}});var d=p.open(e.oSource);d.then(this._handleBookmarkAppPopoverResponse.bind(this,a));},resultTextFormatter:function(s,t){var r=sap.ushell.resources.i18n;if(s){var S=s.systemName?s.systemName:s.systemId;var R="";if(t){R=r.getText('search_easy_access_results',[t,S]);}return R;}return"";},showMoreResultsVisibilityFormatter:function(a,t){if(a&&a.length<t){return true;}return false;},showMoreResultsTextFormatter:function(a,t){if(!a||!t){return"";}var c=a.length;return sap.ushell.resources.i18n.getText('EasyAccessSearchResults_ShowMoreResults',[c,t]);}});},true);
