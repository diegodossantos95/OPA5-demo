// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ui/core/support/Plugin','sap/ui/core/support/Support','sap/ui/model/json/JSONModel','sap/m/Button','sap/m/IconTabBar','sap/m/IconTabFilter','sap/m/Label','sap/m/Text','sap/m/MessageStrip','sap/m/FlexBox','sap/ui/model/resource/ResourceModel','sap/ui/model/Filter','sap/m/SearchField','sap/m/MessageBox'],function(P,S,J,B,I,a,L,T,M,F,R,b,c,d){"use strict";var t=this,o,f=P.extend("sap.ushell.support.plugins.flpConfig.FlpConfigurationPlugin",{constructor:function(s){o=new R({bundleName:"sap/ushell/support/plugins/flpConfig/i18n/FlpConfigurationPlugin"});P.apply(this,["sapUiFlpConfigurationPlugin",o.getResourceBundle().getText("PLUGIN_NAME"),s]);this._oStub=s;if(this.runsAsToolPlugin()){t=this;this._aEventIds=[this.getId()+"ReceiveData"];}else{this._aEventIds=[this.getId()+"RequestData"];};}});f.prototype.isToolPlugin=function(){return true;};f.prototype.isAppPlugin=function(){return true;};f.prototype.init=function(s){P.prototype.init.apply(this,arguments);if(this.runsAsToolPlugin()){var r;setTimeout(function(){t.requestData();},500);r=sap.ui.getCore().createRenderManager();r.write("<div id='"+this.getId()+"'</div>").flush(this.$().get(0));r.destroy();}else{}};f.prototype.exit=function(s){P.prototype.exit.apply(this,arguments);};f.prototype.requestData=function(){this._oStub.sendEvent(this.getId()+"RequestData",{eventData:{data:{}}});};f.prototype.onsapUiFlpConfigurationPluginRequestData=function(E){this._oStub.sendEvent(this.getId()+"ReceiveData",{eventData:{data:window["sap-ushell-config"]}});};f.prototype.onsapUiFlpConfigurationPluginReceiveData=function(E){var t=this;this.flpConfig=E.getParameter("eventData").data;sap.ui.getCore().loadLibraries(["sap.ui.table"],{async:true}).then(function(){sap.ui.require(["sap/ui/table/TreeTable","sap/ui/table/Column"],function(i,C){t.getFlpConfigurationPluginUI(null,i,C);});});};function _(E){var H=0,s=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getSelectedKey(),i=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel().getData();if(jQuery.isArray(i[s])){i[s].forEach(function(j,k){var r=g(i[s][k],s);if(H<r){H=r;}});if(H>0){sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+s).expandToLevel(H-1);}else{d.error(new L({text:sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel("i18n").getResourceBundle().getText("MISSING_HIERARCHY_LEVEL")}));}}}function e(E){var s=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getSelectedKey();sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+s).collapseAll();}f.prototype.onPressSearchNewModel=function(E){var r,s,u,A,v,w,x,y,V,z=[],C={},D="",G={},H={},K=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel("Full"),N=E.getParameter("query");if(!K){K=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel().getData();}else{K=K.getData();}Object.keys(K).forEach(function(O){C[O]=0;});if(N){for(var O in K){D=O;r=[];p(K[O],O,D,r,N);H[O]=r;};Object.keys(H).forEach(function(O){A=H[O];for(var i=0;i<A.length;i++){v=A[i].split(".");w=[];for(var j=0;j<v.length;j++){if(!isNaN(parseInt(v[j],10))){w.push(parseInt(v[j],10));}else{w.push(v[j]);};};for(var k=0;k<w.length;k+=2){x={"property":""};x[w[0]]=[];if(isNaN(parseInt(w[k],10))){s=w.slice(0,k+1);if(!h(G,s)&&typeof h(G,w.slice(0,w.length-2))!=='object'){n(G,s,[x],w[0],s.length);}V=h(K,w.slice(0,k+2));if(V&&h(G,w.slice(0,k+2))){m(G,V.property,w.slice(0,k+2).toString()+",property");}else if(k!==w.length-2){z.push(w.slice(0,k+2).toString());}}}u=w.slice(0);n(G,w,{'property':"",'value':""},w[0],s.length);V=h(K,u);if(V){m(G,V.value,u.toString()+",value");m(G,V.property,u.toString()+",property");}}z.forEach(function(D){V=h(K,D.split(","));if(V&&h(G,D.split(","))){m(G,V.property,D+",property");}});z=[];if(G[O]&&jQuery.isArray(G[O][0][O])&&G[O][0][O].length===0){G[O]=G[O].splice(1);}});sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(G));sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(K),"Full");var Q=0;Object.keys(C).forEach(function(O){y=O;if(G[y]&&jQuery.isArray(G[y])){G[y].forEach(function(i,j){var k=g(G[y][j],y);if(Q<k){Q=k;}});}sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+O).expandToLevel(Q-1);sap.ui.getCore().byId(O).setCount(l(G[O],O,0));});}else{Object.keys(C).forEach(function(O){sap.ui.getCore().byId(O).setCount(l(K[O],O,0));});sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(K));}};function g(C,s){var H=0;if(C[s]){C[s].forEach(function(i){var j=g(i,s);if(j>H){H=j;}});}return H+1;}function h(j,k){for(var i=0;i<k.length;i++){if(j){j=j[k[i]];}}return j;}function l(C,s,i){if(jQuery.isArray(C)){C.forEach(function(j){if(j[s]){i=l(j[s],s,i)}else{i+=1;}});return i;}else{return undefined}}function m(j,v,s){var k=s.split(',');for(var i=0;i<k.length-1;i++){j=j[k[i]];}j[k[k.length-1]]=v;}function n(i,j,v,s,k){if(j.length===1){i[j[0]]=v;}else{var r=j.shift();i[r]=n(typeof i[r]==='undefined'?{}:i[r],j,v,s,k);}if(i[s]&&i.property&&i.value){delete i.value;i.property="";}return i;}function p(C,s,i,j,k){C.forEach(function(r,u){if(r[s]){i=i+"."+u+"."+s;i=p(r[s],s,i,j,k);}else if(r.property.indexOf(k)>-1){i=i+"."+u;j.push(i);i=i.substring(0,i.lastIndexOf("."));}});i=i.substring(0,i.lastIndexOf("."));if(isNaN(parseInt(i.substr(i.lastIndexOf(".")+1),10))){return i;}else{return i.substring(0,i.lastIndexOf("."));}}function q(C,s){if(typeof C!=="object"){return[{property:s,value:C}];};return Object.keys(C).map(function(i){var r={property:i};if(typeof(C[i])==='object'&&Object.keys(C[i]).length!==0){r[s]=q(C[i],s);return r;}else{if(!jQuery.isEmptyObject(C[i])||typeof(C[i])!=='object'){r.value=C[i];}else{r.value="";}return r;}});}f.prototype.getNewConfigJSON=function(i){var N={};Object.keys(i).forEach(function(s){N[s]=q(i[s],s)});return N;};f.prototype.getFlpConfigurationPluginUI=function(i,j,C){var k,r,s,u={};s=this.getNewConfigJSON(this.flpConfig);k=new J(s);for(var v in s){u[v]=l(s[v],v,0);}if(!sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar")){if(!s||jQuery.isEmptyObject(s)){new M({text:o.getResourceBundle().getText("ERROR_MESSAGE"),type:"Warning",showIcon:true,showCloseButton:false}).placeAt(this.getId());}else{r=new I("sap-ui-support-flpConfigurationPlugin-TabBar",{headerMode:"Inline"});Object.keys(this.flpConfig).forEach(function(x,y){r.insertItem(new a(x,{key:x,text:x,count:u[x],content:[new j("sap-ui-support-flpConfigurationPlugin-TreeTable"+x,{rows:"{/"+x+"/}",selectionMode:sap.ui.table.SelectionMode.None,enableCellFilter:true,extension:[new F({items:[new B({icon:"sap-icon://expand",text:"{i18n>EXPAND_BUTTON}",press:_}),new B({icon:"sap-icon://collapse",text:"{i18n>COLLAPSE_BUTTON}",press:e})]})],columns:[new C({label:new L({text:"{i18n>COLUMN_PROPERTY}"}),template:new T({text:"{property}"})}),new C({label:new L({text:"{i18n>COLUMN_VALUE}"}),template:new T({text:"{value}"})})]})]}),y)});var w=new c({search:this.onPressSearchNewModel});w.placeAt(this.getId());r.setModel(k);r.setModel(o,"i18n");r.placeAt(this.getId());}}};return f;},true);
