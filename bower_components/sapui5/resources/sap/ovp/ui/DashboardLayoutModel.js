sap.ui.define(['sap/ovp/cards/CommonUtils'],function(C){"use strict";var L=function(u,c,r,i){this.uiModel=u;this.setColCount(c);this.aCards=[];this.oLayoutVars=null;this.oUndoBuffer={};this.bSequenceLayout=null;this.iDisplaceRow=null;this.iDummyRow=999;this.iRowHeightPx=r;this.iCardBorderPx=i;};L.prototype.setColCount=function(c){if(!c){this.iColCount=5;}else if(c!==this.iColCount){if(this.bLayoutChanged){this.oUndoBuffer={};this.bLayoutChanged=false;}this.iPreviousColCount=this.iColCount;this.iColCount=c;}};L.prototype.setLayoutVars=function(l){if(Array.isArray(l)&&l.length!==0){this.oLayoutVars=l;}this._buildGrid();};L.prototype.updateCardVisibility=function(c){var o;for(var i=0;i<c.length;i++){o=this.oLayoutVars.filter(function(a){return a.id===c[i].id;});if(o[0].visibility&&o[0].visibility!==c[i].visibility){o[0].dashboardLayout['C'+this.iColCount].row=this._findHighestOccupiedRow();}o[0].visibility=c[i].visibility;}this._setCardsLayoutFromVariant(this.aCards,this.oLayoutVars);};L.prototype.getColCount=function(){return this.iColCount;};L.prototype.getCards=function(c){if(this.aCards.length===0||c&&c!==this.iColCount){if(c){this.setColCount(c);}this._buildGrid();}return this.aCards;};L.prototype.getCardById=function(c){var o=null;var i=0;for(i=0;i<this.aCards.length;i++){o=this.aCards[i];if(o.id===c){break;}}return o;};L.prototype.getLayoutVariants4Pers=function(){return JSON.parse(JSON.stringify(this.oLayoutVars));};L.prototype._readVariants=function(){var v,l=this.uiModel.getProperty('/dashboardLayout');if(!!l){for(var a in l){if(l.hasOwnProperty(a)&&l[a]){v=l[a];v.id=a;for(var i in v){var o=this.oLayoutVars.filter(function(e){return e.id===i;});if(Array.isArray(o)&&o.length>0){var s='C'+ +v.id.replace(/[^0-9\.]/g,"");var c=o[0].dashboardLayout[s];var b=this.aCards.filter(function(e){return e.id===i;});if(Array.isArray(b)&&b.length>0){if(c){c.row=v[i].row;c.col=v[i].col;c.colSpan=b[0].template==='sap.ovp.cards.stack'?1:Math.min(v[i].colSpan,this.iColCount);c.maxColSpan=v[i].maxColSpan;c.noOfItems=v[i].rowSpan;}else{o[0].dashboardLayout[s]={row:v[i].row,col:v[i].col,colSpan:b[0].template==='sap.ovp.cards.stack'?1:Math.min(v[i].colSpan,this.iColCount),maxColSpan:v[i].maxColSpan,noOfItems:v[i].rowSpan,autoSpan:b[0].template==='sap.ovp.cards.stack'?false:true}}o[0].visibility=v[i].visible?v[i].visible:true;}}}}}}};L.prototype.resetToManifest=function(){this.oLayoutVars=null;for(var i=0;i<this.aCards.length;i++){this.aCards[i].dashboardLayout={};}this._buildGrid(true);};L.prototype._buildGrid=function(u){if(this.aCards.length===0){this.aCards=this.uiModel.getProperty("/cards");}if(!this.oLayoutVars||u){this.oLayoutVars=[];this.bSequenceLayout=true;}if(this.bSequenceLayout||this.oLayoutVars[0]&&!this.oLayoutVars[0].dashboardLayout){this._sliceSequenceSausage();this.bSequenceLayout=false;}else{this._sliceSequenceSausage(this.oLayoutVars);}this._readVariants();this._setCardsLayoutFromVariant(this.aCards,this.oLayoutVars);};L.prototype._setCardsLayoutFromVariant=function(c,l){var o={},a={},b={},d=null;for(var i=0;i<c.length;i++){o=c[i];a=l.filter(function(e){return e.id===o.id;});if(Array.isArray(a)&&a.length>0){o.dashboardLayout={};b=a[0].dashboardLayout["C"+this.iColCount];d=this._getDefaultCardItemHeightAndCount(o);o.dashboardLayout.colSpan=b.colSpan?b.colSpan:1;o.dashboardLayout.maxColSpan=b.maxColSpan;o.dashboardLayout.rowSpan=b.rowSpan?b.rowSpan:12;o.dashboardLayout.noOfItems=b.noOfItems?b.noOfItems:d.noOfItems;o.dashboardLayout.itemHeight=d.itemHeight;o.dashboardLayout.headerHeight=d.headerHeight;o.dashboardLayout.autoSpan=b.autoSpan;o.dashboardLayout.showOnlyHeader=b.showOnlyHeader;if(a[0].hasOwnProperty("visibility")&&a[0].visibility===false){o.dashboardLayout.visible=false;o.dashboardLayout.column=b.col;o.dashboardLayout.row=b.row;}else{o.dashboardLayout.visible=true;if(b.col===0||b.row===0){this._displaceCardToEnd(o);}else{o.dashboardLayout.column=b.col;o.dashboardLayout.row=b.row;}if(o.dashboardLayout.colSpan>this.iColCount){o.dashboardLayout.colSpan=this.iColCount;}}}if(o.dashboardLayout.column>this.iColCount){this._displaceCardToEnd(o);jQuery.sap.log.warning("DashboardLayout: card ("+o.id+") in invalid column -> moved to end");}if(o.dashboardLayout.column+o.dashboardLayout.colSpan-1>this.iColCount){o.dashboardLayout.colSpan=Math.min(o.dashboardLayout.colSpan,this.iColCount);this._displaceCardToEnd(o);jQuery.sap.log.warning("DashboardLayout: card ("+o.id+") too wide -> moved to end");}}this.validateGrid(true);};L.prototype._displaceCardToEnd=function(c){c.dashboardLayout.column=1;if(!this.iDisplaceRow){this.iDisplaceRow=this._findHighestOccupiedRow();}c.dashboardLayout.row=this.iDisplaceRow;this.iDisplaceRow+=c.dashboardLayout.rowSpan;var l=this.oLayoutVars.filter(function(i){return i.id===c.id;});if(Array.isArray(l)&&l.length>0){l[0].dashboardLayout["C"+this.iColCount].row=c.dashboardLayout.row;}};L.prototype._setCardSpanFromDefault=function(c){if(!c.dashboardLayout){c.dashboardLayout={};}var o=this._getDefaultCardItemHeightAndCount(c);if(!c.settings.defaultSpan){if(c.template==='sap.ovp.cards.linklist'){c.dashboardLayout.rowSpan=1;}else{c.dashboardLayout.rowSpan=12;}c.dashboardLayout.colSpan=1;c.dashboardLayout.noOfItems=o.noOfItems;c.dashboardLayout.autoSpan=true;c.dashboardLayout.showOnlyHeader=false;c.dashboardLayout.maxColSpan=c.dashboardLayout.colSpan;}else{if(c.settings.defaultSpan.showOnlyHeader){c.dashboardLayout.rowSpan=Math.ceil((o.headerHeight+2*this.iCardBorderPx)/this.iRowHeightPx);c.dashboardLayout.noOfItems=0;c.dashboardLayout.autoSpan=false;c.dashboardLayout.showOnlyHeader=true;}else{if(c.template==='sap.ovp.cards.linklist'){c.dashboardLayout.rowSpan=c.settings.defaultSpan.rows?c.settings.defaultSpan.rows:1;c.dashboardLayout.autoSpan=false;}else{c.dashboardLayout.rowSpan=12;c.dashboardLayout.autoSpan=true;}c.dashboardLayout.noOfItems=c.settings.defaultSpan.rows?c.settings.defaultSpan.rows:o.noOfItems;c.dashboardLayout.showOnlyHeader=false;}c.dashboardLayout.colSpan=c.template==='sap.ovp.cards.stack'?1:(c.settings.defaultSpan.cols?Math.min(c.settings.defaultSpan.cols,this.iColCount):1);c.dashboardLayout.maxColSpan=c.settings.defaultSpan.cols?c.settings.defaultSpan.cols:1;}c.dashboardLayout.visible=true;c.dashboardLayout.itemHeight=o.itemHeight;c.dashboardLayout.headerHeight=o.headerHeight;};L.prototype._sliceSequenceSausage=function(u){var i=0,j=0,c=0,a=0,m=0,o={},s=[];if(!u){this._sortCardsSausage(this.aCards);}for(i=0;i<this.iColCount;i++){s.push({col:i+1,rows:0});}for(i=0;i<this.aCards.length;i++){o=this.aCards[i];if(!o.dashboardLayout){o.dashboardLayout={};}if(!u){this._setCardSpanFromDefault(o);}else{var l=u.filter(function(g){return g.id===o.id;});if(Array.isArray(l)&&l.length>0){var b=l[0].dashboardLayout["C"+this.iColCount];if(!b){var d=Object.keys(l[0].dashboardLayout);if(d.length>0){var p=l[0].dashboardLayout[d[0]];if(!p){this._setCardSpanFromDefault(o);}else{o.dashboardLayout.rowSpan=p.rowSpan;o.dashboardLayout.colSpan=p.colSpan;o.dashboardLayout.maxColSpan=p.maxColSpan;o.dashboardLayout.noOfItems=p.noOfItems;o.dashboardLayout.autoSpan=p.autoSpan;o.dashboardLayout.showOnlyHeader=p.showOnlyHeader;}}}else{o.dashboardLayout.rowSpan=b.rowSpan;o.dashboardLayout.colSpan=b.colSpan;o.dashboardLayout.maxColSpan=b.maxColSpan;o.dashboardLayout.noOfItems=b.noOfItems;o.dashboardLayout.autoSpan=b.autoSpan;o.dashboardLayout.row=b.row;o.dashboardLayout.column=b.col;o.dashboardLayout.showOnlyHeader=b.showOnlyHeader;continue;}}else{o.dashboardLayout.row=this.iDummyRow;o.dashboardLayout.column=1;var e={};var f={row:o.dashboardLayout.row,col:o.dashboardLayout.column,rowSpan:o.dashboardLayout.rowSpan,colSpan:o.dashboardLayout.colSpan,maxColSpan:o.dashboardLayout.maxColSpan,noOfItems:o.dashboardLayout.noOfItems,autoSpan:o.dashboardLayout.autoSpan,showOnlyHeader:o.dashboardLayout.showOnlyHeader};e["C"+this.iColCount]=f;u.push({id:o.id,visibility:o.dashboardLayout.visible,selectedKey:o.settings.selectedKey,dashboardLayout:e});continue;}}o.dashboardLayout.colSpan=o.dashboardLayout.maxColSpan;o.dashboardLayout.colSpan=o.dashboardLayout.colSpan>this.iColCount?this.iColCount:o.dashboardLayout.colSpan;c=a<this.iColCount?a+1:1;if(c+o.dashboardLayout.colSpan-1>this.iColCount){o.dashboardLayout.colSpan=this.iColCount-c+1;}a=c+o.dashboardLayout.colSpan-1;o.dashboardLayout.column=c;m=0;for(j=o.dashboardLayout.column;j<o.dashboardLayout.column+o.dashboardLayout.colSpan;j++){if(s[j-1].rows>m){m=s[j-1].rows;}}o.dashboardLayout.row=m+1;for(j=o.dashboardLayout.column;j<o.dashboardLayout.column+o.dashboardLayout.colSpan;j++){s[j-1].rows=m+o.dashboardLayout.rowSpan;}}this.extractCurrentLayoutVariant();};L.prototype._sortCardsSausage=function(c){c.sort(function(a,b){if(a.sequencePos&&b.sequencePos){if(a.sequencePos<b.sequencePos){return-1;}else if(a.sequencePos>b.sequencePos){return 1;}else{return 0;}}else if(a.sequencePos&&!b.sequencePos){return-1;}else if(!a.sequencePos&&b.sequencePos){return 1;}else{if(a.id<b.id){return-1;}else if(a.id>b.id){return 1;}else{return 0;}}});};L.prototype._sortCardsByCol=function(c){c.sort(function(a,b){if(!a.dashboardLayout&&b.dashboardLayout){return 1;}else if(a.dashboardLayout&&!b.dashboardLayout){return-1;}if(a.dashboardLayout.column&&a.dashboardLayout.row&&a.dashboardLayout.column===b.dashboardLayout.column){if(a.dashboardLayout.row<b.dashboardLayout.row){return-1;}else if(a.dashboardLayout.row>b.dashboardLayout.row){return 1;}}else if(a.dashboardLayout.column){return a.dashboardLayout.column-b.dashboardLayout.column;}else{return 0;}});};L.prototype._sortCardsByRow=function(c){c.sort(function(a,b){if(!a.dashboardLayout&&b.dashboardLayout){return 1;}else if(a.dashboardLayout&&!b.dashboardLayout){return-1;}if(a.dashboardLayout.column&&a.dashboardLayout.row&&a.dashboardLayout.row===b.dashboardLayout.row){if(a.dashboardLayout.column<b.dashboardLayout.column){return-1;}else if(a.dashboardLayout.column>b.dashboardLayout.column){return 1;}}else if(a.dashboardLayout.row){return a.dashboardLayout.row-b.dashboardLayout.row;}else{return 0;}});};L.prototype.undoLastChange=function(){if(this.oUndoBuffer.layoutVariant){this.oLayoutVars=this.oUndoBuffer.layoutVariant;this.oUndoBuffer={};}};L.prototype.resizeCard=function(c,s,m){this._registerChange("resize");var r=this.getCardById(c);if(!r){return[];}var d=s.colSpan-r.dashboardLayout.colSpan;var a=s.rowSpan-r.dashboardLayout.rowSpan;if(d===0&&a===0){return{resizeCard:r,affectedCards:[]};}else if(m&&r.dashboardLayout.autoSpan){r.dashboardLayout.autoSpan=false;}if(!m||(a&&d===0)){this._arrangeCards(r,{"row":s.rowSpan,"column":r.dashboardLayout.colSpan,"showOnlyHeader":s.showOnlyHeader},'resize');}else{this._arrangeCards(r,{"row":s.rowSpan,"column":s.colSpan,"showOnlyHeader":s.showOnlyHeader},'resize');}return{resizeCard:r,affectedCards:this._removeSpaceBeforeCard()};};L.prototype._removeSpaceBeforeCard=function(){this._sortCardsByRow(this.aCards);var d={};for(var i=1;i<=this.iColCount;i++){d[i]=1;}for(var j=0;j<this.aCards.length;j++){var a=this.aCards[j].dashboardLayout.column;var u=this.aCards[j].dashboardLayout.column+this.aCards[j].dashboardLayout.colSpan-1;if(this.aCards[j].dashboardLayout.colSpan>1){var t=[];for(var k=a;k<=u;k++){t.push(d[k]);}var m=Math.max.apply(Math,t);for(var l=a;l<=u;l++){d[l]=m+this.aCards[j].dashboardLayout.rowSpan;}this.aCards[j].dashboardLayout.row=m;}else{if((this.aCards[j].dashboardLayout.row!==d[a])){this.aCards[j].dashboardLayout.row=d[a];}d[a]=this.aCards[j].dashboardLayout.row+this.aCards[j].dashboardLayout.rowSpan;}}return this.aCards;};L.prototype._arrangeCards=function(c,n,d){var o=jQuery.extend(true,{},c);var v=false;if('drag'===d&&c.dashboardLayout.column===n.column&&n.row!==c.dashboardLayout.row){v=true;}this._sortCardsByRow(this.aCards);var a=[];var f=false;if(d==="drag"){c.dashboardLayout.row=n.row;c.dashboardLayout.column=n.column;}else if(d==="resize"){c.dashboardLayout.rowSpan=n.row;c.dashboardLayout.colSpan=n.column;c.dashboardLayout.showOnlyHeader=n.showOnlyHeader;}a.push(c);for(var i=0;i<a.length;i++){for(var j=0;j<this.aCards.length;j++){if(a[i].id===this.aCards[j].id||!a[i].dashboardLayout.visible){continue;}else{f=this._checkOverlapOfCards(a[i],this.aCards[j]);if(f===true){if(v){if(n.row<o.dashboardLayout.row&&n.row===this.aCards[j].dashboardLayout.row){a[i].dashboardLayout.row=this.aCards[j].dashboardLayout.row;this.aCards[j].dashboardLayout.row=a[i].dashboardLayout.row+a[i].dashboardLayout.rowSpan;}else if(n.row>o.dashboardLayout.row+this.aCards[j].dashboardLayout.rowSpan){this.aCards[j].dashboardLayout.row=o.dashboardLayout.row;a[i].dashboardLayout.row=this.aCards[j].dashboardLayout.row+this.aCards[j].dashboardLayout.rowSpan;a.push(a[i]);}else{}}else{this.aCards[j].dashboardLayout.row=a[i].dashboardLayout.row+a[i].dashboardLayout.rowSpan;a.push(this.aCards[j]);}}}}}};L.prototype._checkOverlapOfCards=function(o,a){var b=o.dashboardLayout.row;var c=o.dashboardLayout.row+o.dashboardLayout.rowSpan;var d=o.dashboardLayout.column;var e=o.dashboardLayout.column+o.dashboardLayout.colSpan;var f=a.dashboardLayout.row;var g=a.dashboardLayout.row+a.dashboardLayout.rowSpan;var h=a.dashboardLayout.column;var i=a.dashboardLayout.column+a.dashboardLayout.colSpan;var j=false,k=false;if((h>=d&&h<e)||(i>d&&i<=e)||(h<=d&&i>=e)){j=true;}if((f>=b&&f<c)||(g>b&&g<=c)||(f<=b&&g>=c)){k=true;}return j&&k;};L.prototype.condenseCardArray=function(a){this._sortCardsByCol(a);return a.reduce(function(c,b){if(c.indexOf(b)<0){c.push(b);}return c;},[]);};L.prototype.extractCurrentLayoutVariant=function(){var i=0;var c={};var o=[];for(i=0;i<this.aCards.length;i++){c=this.aCards[i];o=this.oLayoutVars.filter(function(b){return b.id===c.id;});var d={};var a={row:c.dashboardLayout.row,col:c.dashboardLayout.column,rowSpan:c.dashboardLayout.rowSpan,colSpan:c.dashboardLayout.colSpan,maxColSpan:c.dashboardLayout.maxColSpan,noOfItems:c.dashboardLayout.noOfItems,autoSpan:c.dashboardLayout.autoSpan,showOnlyHeader:c.dashboardLayout.showOnlyHeader};d["C"+this.iColCount]=a;if(!(Array.isArray(o)&&o.length!==0)){this.oLayoutVars.push({id:c.id,visibility:c.dashboardLayout.visible,selectedKey:c.settings.selectedKey,dashboardLayout:d});}else{o[0].selectedKey=c.settings.selectedKey||o[0].selectedKey;o[0].dashboardLayout={};o[0].dashboardLayout["C"+this.iColCount]=a;}}};L.prototype._registerChange=function(a){this.bLayoutChanged=true;this.oUndoBuffer.action=a;this.extractCurrentLayoutVariant();this.oUndoBuffer.layoutVariant=this.oLayoutVars;};L.prototype._extractGrid=function(s){var f=s;var a="";if(f==="col"){a="row";}else if(f==="row"){a="col";}else{jQuery.sap.log.error("DashboardLayoutModel._getCurrentLayoutVariant: param sortBy has to be col or row!");}var c=[];var i=0;var r=0;var b=0;for(i=0;i<this.aCards.length;i++){var d=this.aCards[i].dashboardLayout;if(d.visible===false){continue;}for(r=d.row;r<d.row+d.rowSpan;r++){for(b=d.column;b<d.column+d.colSpan;b++){c.push({col:b,row:r,card:this.aCards[i]});}}}c.sort(function(e,g){if(e[f]===g[f]){if(e[a]<g[a]){return-1;}else if(e[a]>g[a]){return 1;}}else{return e[f]-g[f];}});return c;};L.prototype.validateGrid=function(r){var g=true;var i=0;var c=this._extractGrid("row");var p=c[0];var a={};var d=[];for(i=1;i<c.length;i++){a=c[i];if(a.col>this.iColCount||a.col<0){g=false;d.push(a.card);jQuery.sap.log.warning("DashboardLayout: Cell is outside (col/row): "+a.col+"/"+a.row);}if(a.col===p.col&&a.row===p.row){g=false;d.push(a.card);jQuery.sap.log.warning("DashboardLayout: Cell has two tenants (col/row//id1/id2: "+a.col+"/"+a.row+"//"+p.card.id+"/"+a.card.id);}p=a;}if(r&&d.length>0){d=this.condenseCardArray(d);for(i=0;i<d.length;i++){this._displaceCardToEnd(d[i]);}this._removeSpaceBeforeCard();g=true;jQuery.sap.log.info("DashboardLayout: invalid grid repaired");}return g;};L.prototype._findHighestOccupiedRow=function(){var m=[];var l='C'+this.iColCount;function f(e){return e.dashboardLayout[l].col===c;}function a(e,i,b){return e.dashboardLayout[l].row===Math.max.apply(Math,b.map(function(d){return d.dashboardLayout[l].row;}));}for(var c=1;c<=this.iColCount;c++){var A=this.oLayoutVars.filter(f);if(!!A){var o=A.filter(a)[0];if(!!o){m.push(+o.dashboardLayout[l].row+ +o.dashboardLayout[l].rowSpan);}}}var h=Math.max.apply(Math,m.map(function(e){return e;}));return h;};L.prototype._getDefaultCardItemHeightAndCount=function(c){var d=C._setCardpropertyDensityAttribute();var a={"List_condensed":{itemLength:5,itemHeight:64},"List_condensed_imageSupported_cozy":{itemLength:5,itemHeight:72},"List_condensed_imageSupported_compact":{itemLength:5,itemHeight:60},"List_extended":{itemLength:3,itemHeight:97},"List_condensed_bar":{itemLength:5,itemHeight:65},"List_extended_bar":{itemLength:3,itemHeight:95},"Table":{itemLength:5,itemHeight:62},"Linklist":{itemLength:6,itemHeight:0}};var h={"KPIHeader":{"1":{"1":158,"2":174},"2":{"1":179,"2":195},"3":{"1":201,"2":223}},"NormalHeader":{"1":{"1":82,"2":98},"2":{"1":103,"2":119},"3":{"1":125,"2":141}}};var S=22;var b=21;var H=0;if(c){var e=c.template,l=c.settings.listType,f=c.settings.listFlavor,i=c.settings.imageSupported,n=0,I=0;if(e=="sap.ovp.cards.list"){if(l=="extended"){if(f=="bar"){n=a["List_extended_bar"]["itemLength"];I=a["List_extended_bar"]["itemHeight"];}else{n=a["List_extended"]["itemLength"];I=a["List_extended"]["itemHeight"];}}else{if(f=="bar"){n=a["List_condensed_bar"]["itemLength"];I=a["List_condensed_bar"]["itemHeight"];}else{if(i==='true'){if(d==='cozy'){I=a["List_condensed_imageSupported_cozy"]["itemHeight"];}else{I=a["List_condensed_imageSupported_compact"]["itemHeight"];}}else{I=a["List_condensed"]["itemHeight"];}n=a["List_condensed"]["itemLength"];}}}else if(e=="sap.ovp.cards.table"){n=a["Table"]["itemLength"];I=a["Table"]["itemHeight"];}else if(e==="sap.ovp.cards.linklist"){n=a["Linklist"]["itemLength"];I=a["Linklist"]["itemHeight"];}var t=c.settings.defaultSpan&&c.settings.defaultSpan.minimumTitleRow?c.settings.defaultSpan.minimumTitleRow:1;var s=c.settings.defaultSpan&&c.settings.defaultSpan.minimumSubTitleRow?c.settings.defaultSpan.minimumSubTitleRow:1;var g=(c.settings.dataPointAnnotationPath||(c.settings.tabs&&c.settings.tabs[0].dataPointAnnotationPath))?"KPIHeader":"NormalHeader";H=h[g][t][s];if(g==="KPIHeader"){if(c.settings.showFilterInHeader===true){H+=S;}if(c.settings.showSortingInHeader===true){H+=b;}}return{noOfItems:n,itemHeight:I,headerHeight:H};}};return L;},true);
