sap.ui.define(['sap/ui/core/mvc/Controller','sap/ui/model/json/JSONModel','/sap/ui/fl/descriptorRelated/api/DescriptorChangeFactory','/sap/ui/fl/descriptorRelated/api/DescriptorInlineChangeFactory','sap/ovp/cards/CommonUtils','sap/ovp/cards/SettingsUtils','sap/m/Button','sap/m/Dialog','sap/m/Text','sap/ui/comp/valuehelpdialog/ValueHelpDialog'],function(C,J,D,a,c,s,B,b,T,V){'use strict';return C.extend('sap.ovp.cards.rta.SettingsDialog',{_oCardManifestSettings:{},_oManifest:{},_oFormContainer:{},_aRefreshNotRequired:[{"formElementId":"sapOvpSettingsTitle","cardElementId":"ovpHeaderTitle"},{"formElementId":"sapOvpSettingsSubTitle","cardElementId":"SubTitle-Text"},{"formElementId":"sapOvpSettingsLineItemTitle","cardElementId":"linkListTitleLabel"},{"formElementId":"sapOvpSettingsLineItemSubTitle","cardElementId":"linkListSubTitleLabel"},{"formElementId":"sapOvpSettingsValueSelectionInfo","cardElementId":"ovpValueSelectionInfo"},{"formElementId":"sapOvpSettingsIdentification","cardElementId":"","updateProperty":"identificationAnnotationPath"},{"formElementId":"sapOvpSettingsKPIHeaderSwitch","cardElementId":"kpiHeader","isKpiSwitch":true}],_aRefreshRequired:[{"formElementId":"sapOvpSettingsKPIHeaderSwitch","updateProperty":"kpiHeader"},{"formElementId":"sapOvpSettingsListType","updateProperty":"listType"},{"formElementId":"sapOvpSettingsListFlavor","updateProperty":"listFlavor"},{"formElementId":"sapOvpSettingsSortOrder","updateProperty":"sortOrder"},{"formElementId":"sapOvpSettingsSortBy","updateProperty":"sortBy"},{"formElementId":"sapOvpSettingsFilterBy","updateProperty":"selectionAnnotationPath"},{"formElementId":"sapOvpSettingsPresentedBy","updateProperty":"presentationAnnotationPath"},{"formElementId":"sapOvpSettingsDataPoint","updateProperty":"dataPointAnnotationPath"},{"formElementId":"sapOvpSettingsChart","updateProperty":"chartAnnotationPath"},{"formElementId":"sapOvpSettingsLineItem","updateProperty":"annotationPath"}],validateInputField:function(e){if(!e.getSource().getValue()){var d=new b({title:'Error',type:'Message',state:'Error',content:new T({text:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText('OVP_KEYUSER_INPUT_ERROR')}),beginButton:new B({text:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText('close'),press:function(){d.close();}}),afterClose:function(){d.destroy();}});d.open();}else{this.updateCard(e);}},onInit:function(){s.oSaveButton.attachPress(this.createAndSubmitChange,this);},onAfterRendering:function(){this._oCardManifestSettings=this.getView().getModel().getData();setTimeout(function(){this.getView().byId("dialogCard").setBusy(false);}.bind(this),2000);},setBusy:function(d){if(d){this.getView().addStyleClass("dialogContainerOverlay");this.getView().byId("dialogCard").getComponentInstance().getRootControl().setBusy(d);}else{this.getView().removeStyleClass("dialogContainerOverlay");setTimeout(function(){this.getView().byId("dialogCard").getComponentInstance().getRootControl().setBusy(d);}.bind(this),2000);}},_fCardWithoutRefresh:function(e,u){var v=this.getView();var o=v.byId("dialogCard").getComponentInstance(),r=o.getRootControl(),E;if(u.formElementId==="sapOvpSettingsLineItemTitle"||u.formElementId==="sapOvpSettingsLineItemSubTitle"){E=r.byId(u.cardElementId+"--"+v.getModel().getProperty("/lineItemId"));}else{E=r.byId(u.cardElementId);}switch(u.formElementId){case"sapOvpSettingsLineItemTitle":case"sapOvpSettingsLineItemSubTitle":case"sapOvpSettingsTitle":case"sapOvpSettingsSubTitle":case"sapOvpSettingsValueSelectionInfo":E.setText(e.getSource().getValue());break;case"sapOvpSettingsIdentification":var d=e.getParameters().selectedItem.getBindingContext(),m=d.getModel(),p=d.getPath(),A=m.getProperty(p).value;this._oCardManifestSettings[u.updateProperty]=A;break;case"sapOvpSettingsKPIHeaderSwitch":var f=v.getModel("visibility"),g=f.getData();g.dataPoint=false;g.valueSelectionInfo=false;var h=v.getModel(),i=h.getProperty("/dataPointAnnotationPath");if(i){h.setProperty("/prevDataPointAnnotationPath",i);}h.setProperty("/dataPointAnnotationPath",undefined);f.refresh(true);E.destroy();break;default:break;}},_fCardWithRefresh:function(e,u){var S=this.getView(),o=S.byId('dialogCard'),d=o.getComponentInstance().getComponentData(),f=d.cardId,m=d.manifest.cards[f].model,M={cards:{}};switch(u){case"kpiHeader":var v=this.getView(),g=v.getModel("visibility"),h=g.getData();h.dataPoint=true;h.valueSelectionInfo=true;var i=v.getModel(),p=i.getProperty("/prevDataPointAnnotationPath");this._oCardManifestSettings.valueSelectionInfo=" ";if(p){i.setProperty("/dataPointAnnotationPath",p);}else{i.setProperty("/dataPointAnnotationPath",i.getData().dataPoint[0].value);}g.refresh(true);break;case"listType":e.getSource().getState()===true?(this._oCardManifestSettings[u]="extended"):(this._oCardManifestSettings[u]="condensed");break;case"listFlavor":if(this._oCardManifestSettings["listFlavorName"]===s.FORM_ITEM_NAME_FOR_LIST_FLAVOR_IN_LINKLIST){e.getSource().getState()===true?(this._oCardManifestSettings[u]="carousel"):(this._oCardManifestSettings[u]="standard");}else{e.getSource().getState()===true?(this._oCardManifestSettings[u]="bar"):(this._oCardManifestSettings[u]="");}break;case"sortOrder":e.getSource().getSelectedKey()==="ascending"?(this._oCardManifestSettings[u]="ascending"):(this._oCardManifestSettings[u]="descending");break;case"sortBy":this._oCardManifestSettings[u]=e.getSource().getSelectedKey();break;case"annotationPath":break;case"chartAnnotationPath":case"dataPointAnnotationPath":case"presentationAnnotationPath":case"selectionAnnotationPath":var j=e.getParameters().selectedItem.getBindingContext(),k=j.getModel(),P=j.getPath(),A=k.getProperty(P).value;this._oCardManifestSettings[u]=A;break;default:break;}M.cards[f]={model:m,template:d.template,settings:this._oCardManifestSettings};var l=c.createCardComponent(S,M,'dialogCard');l.then(function(){this.setBusy(false);}.bind(this));l.catch(function(){this.setBusy(false);}.bind(this));},updateCard:function(e){var d=e.getSource().getId(),f=false;for(var i=0;i<this._aRefreshNotRequired.length;i++){if(d.indexOf(this._aRefreshNotRequired[i].formElementId)>-1){if(this._aRefreshNotRequired[i].isKpiSwitch&&e.getSource().getState()){break;}this._fCardWithoutRefresh(e,this._aRefreshNotRequired[i]);f=true;break;}}if(!f){for(var j=0;j<this._aRefreshRequired.length;j++){if(d.indexOf(this._aRefreshRequired[j].formElementId)>-1){this.setBusy(true);this._fCardWithRefresh(e,this._aRefreshRequired[j].updateProperty);break;}}}},onExit:function(){s.oSaveButton.detachPress(this.createAndSubmitChange,this);},updateTheLineItemSelected:function(e){var d=e.getSource().getSelectedItem().getBindingContext().getObject().Qualifier;this._oCardManifestSettings.lineItemQualifier=d;this._oCardManifestSettings.annotationPath='com.sap.vocabularies.UI.v1.LineItem#'+d;if(d==='Default'){this._oCardManifestSettings.annotationPath='com.sap.vocabularies.UI.v1.LineItem';}this.getView().byId("sapOvpSettingsLineItem").setValue(d);this._fCardWithRefresh(e,'annotationPath');this.valueHelpDialog.close();},getListItems:function(){var i=[],S=this.getView(),o=S.byId('dialogCard'),d=o.getComponentInstance().getComponentData(),l=this._oCardManifestSettings.entityType.$path+'/'+this._oCardManifestSettings.annotationPath,m=d.model.getMetaModel(),e=m.getContext(m.resolve(l,this.oView.getBindingContext()));var f=2,g=1,n=0;if(this._oCardManifestSettings.listFlavor==='bar'){f=1;g=2;}if(this._oCardManifestSettings.listType&&this._oCardManifestSettings.listType.toLowerCase()==='extended'){f=6;g=3;n=3;if(this._oCardManifestSettings.listFlavor==='bar'){f=5;}}else if(this._oCardManifestSettings.contentFragment==="sap.ovp.cards.table.Table"){f=3;g=1;n=1;}this._oCardManifestSettings.lineItem.forEach(function(h){var j=sap.ovp.cards.AnnotationHelper.getSortedDataPoints(e,h.fields),k=sap.ovp.cards.AnnotationHelper.getSortedDataFields(e,h.fields),p=[],q=[];j.forEach(function(u){if(u.Title){q.push(u.Title.String);}});k.forEach(function(u){if(u.Label){p.push(u.Label.String);}});var r=Math.min(q.length,g),t=Math.min(n,r),v=p.slice(0,f-t).concat(q.slice(0,r));v.map(function(u){return u.charAt(0).toUpperCase()+u.substr(1);});i.push({Qualifier:h.name,VisibleFields:v.toString()});});return i;},openLineItemValueHelpDialog:function(e){var t=new sap.m.Table({mode:sap.m.ListMode.SingleSelectLeft,inset:false,fixedLayout:false,columns:[new sap.m.Column({header:[new sap.m.Label({text:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText('OVP_KEYUSER_LINEITEM_QUAL')})]}),new sap.m.Column({header:[new sap.m.Label({text:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("OVP_KEYUSER_VISIBLE_FIELDS")})]})]});t.bindItems("/",new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{Qualifier}"}),new sap.m.Text({text:"{VisibleFields}"})]}));t.attachSelectionChange(this.updateTheLineItemSelected.bind(this));this.valueHelpDialog=new V({title:sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("OVP_KEYUSER_LINEITEM_ANNO"),contentWidth:"60%",supportMultiselect:false});this.valueHelpDialog.attachCancel(function(){this.valueHelpDialog.close();}.bind(this));this.valueHelpDialog.setTable(t);this.aItemList=this.getListItems();var r=new sap.ui.model.json.JSONModel();r.setData(this.aItemList);this.valueHelpDialog.getTable().setModel(r);t.getItems().forEach(function(i){if(i.getBindingContext().getObject().Qualifier===this._oCardManifestSettings.lineItemQualifier){i.setSelected(true);}}.bind(this));this.valueHelpDialog.open();},createAndSubmitChange:function(){var d=s.dialogBox,r='sap.ovp.app',l='VENDOR',e='ovp_removeCard',p={'cardId':'sap.card01'},t=null,f='create_'+e;if(!a[f]){return;}a[f](p,t).then(function(o){new D().createNew(r,o,l).then(function(g){g.submit().then(function(S){return;},function(E){return;});});});d.close();}});});
