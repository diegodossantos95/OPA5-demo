-sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/odata/ODataUtils","sap/ovp/cards/generic/Component","sap/ui/generic/app/navigation/service/NavigationHandler","sap/m/MessageBox","sap/ovp/cards/CommonUtils","sap/ushell/ui/footerbar/AddBookmarkButton","sap/m/BusyDialog","sap/ui/model/resource/ResourceModel","sap/ui/model/Filter","sap/ui/comp/smartvariants/SmartVariantManagement","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/m/ColumnListItem","sap/m/Text","sap/m/Switch","sap/m/Table","sap/m/Column","sap/m/Button","sap/m/Dialog","sap/ui/model/json/JSONModel"],function(C,O,a,N,M,b,A,B,R,F,S,P,c,U,d,T,f,g,h,m,D,J){"use strict";return C.extend("sap.ovp.app.Main",{getCustomAppStateDataExtension:function(o){},restoreCustomAppStateDataExtension:function(o){},getCustomFilters:function(){},onCustomActionPress:function(s){},onCustomParams:function(s){},oRefreshTimer:null,nRefreshInterval:0,filterItemInFocus:null,storeIncomingDeltaChanges:function(e){this.deltaCardsInfo=e?e:[];},onInit:function(){this.bDeltaChangesEnabled=false;this.oCardsModels={};this.aFilters=[];this.errorHandlingObject={atLeastOneRequestSuccess:false,errorLoadingTimeout:{}};this.sPreviousEntityType="";this.sCurrentEntityType="";this.oLoadedComponents={};this.bGlobalFilterLoaded=false;jQuery.sap.measure.start("ovp:GlobalFilter","Main Controller init -> Global Filter loaded","ovp");jQuery.sap.measure.start("ovp:Personalization","Main Controller init -> Personalization loaded","ovp");this.isInitialLoading=true;var u=this.getUIModel();this.oValueHelpMap=u&&u.getProperty("/ValueHelpEntityMap");this._initFlexibilityPersonalization();this.oFlexibilityPersonalizationPromise.then(function(){this._initSmartVariantManagement();}.bind(this));this.getLayout().addStyleClass("ovpLayoutElement");this.oState={};this.oState.oSmartFilterbar=this.byId("ovpGlobalFilter");this._initGlobalFilter();this._createModelForTile();},recreateCard:function(s){var o=this._getCardFromManifest(s.cardId);if(o.template=="sap.ovp.cards.charts.analytical"){o.settings.chartAnnotationPath=s.chartAnnotationPath;o.settings.navigation=s.navigation;}o.settings.annotationPath=s.annotationPath;o.settings.dynamicSubtitleAnnotationPath=s.dynamicSubtitleAnnotationPath;o.settings.presentationAnnotationPath=s.presentationAnnotationPath;o.settings.selectionAnnotationPath=s.selectionAnnotationPath;o.settings.selectionPresentationAnnotationPath=s.selectionPresentationAnnotationPath;o.settings.dataPointAnnotationPath=s.dataPointAnnotationPath;o.settings.identificationAnnotationPath=s.identificationAnnotationPath;o.settings.headerAnnotationPath=s.headerAnnotationPath;o.settings.selectedKey=s.selectedKey;if(o){this.createLoadingCard(o);o.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(o.model);this._loadCardComponent(o.template);this._createModelViewMap(o);jQuery.when(this.createCard(o)).then(function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var e=this.getLayout().getDashboardLayoutUtil();if(e){var i=e.getDashboardLayoutModel();var j=i.getCardById(o.id);j.dashboardLayout.autoSpan=false;e._sizeCard(j);i.extractCurrentLayoutVariant();}}}.bind(this));}this.savePersonalization();},onBeforeRendering:function(){},onAfterRendering:function(){this.oModelViewMap={};this.oAppStatePromise=null;if(this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes")){this.nRefreshInterval=this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes");this.nRefreshInterval=(this.nRefreshInterval<=1?1:this.nRefreshInterval)*60000;}if(this.getView()&&this.getView().byId('ovpErrorPage')){jQuery(this.getView().byId('ovpErrorPage').getDomRef()).hide();}if(this.initialized){return;}this.initialized=true;Promise.all([this.oFlexibilityPersonalizationPromise,this.oPersistencyVariantPromise]).then(function(v){jQuery.sap.measure.end("ovp:Personalization");this.persistencyVariantLoaded=true;var o;var e=[],i=[];this.aManifestOrderedCards=this._getCardArrayAsVariantFormat(this.getLayout().getContent());this.aOrderedCards=this._mergeLREPContent(this.aManifestOrderedCards,v[1]);for(var j=0;j<this.aOrderedCards.length;j++){o=this._getCardFromManifest(this.aOrderedCards[j].id);if(o&&o.settings&&o.settings.requireAppAuthorization){e.push({id:o.id,cardIntent:o.settings.requireAppAuthorization});i.push(o.settings.requireAppAuthorization);}}if(i.length>0){this._checkForAuthorization(e,i);}else{this.organizeCards(this.aOrderedCards);}}.bind(this),function(e){jQuery.sap.log.error("Could not load information from LREP Persistency");jQuery.sap.log.error(e);});if(sap.ui.Device.system.phone){jQuery.sap.require("sap.ovp.ui.SmartphoneHeaderToggle");sap.ovp.ui.SmartphoneHeaderToggle.enable(this);}setTimeout(function(){if(!this.persistencyVariantLoaded){this.busyDialog=new B({text:this._getLibraryResourceBundle().getText("loading_dialog_text")});this.busyDialog.open();this.busyDialog.addStyleClass('sapOVPBusyDialog');}}.bind(this),500);},organizeCards:function(o){var e;var v=[];this._updateLayoutWithOrderedCards();this._updateDashboardLayoutCards(o);if(this.isDragAndDropEnabled()){this._initShowHideCardsButton();}this._clearStoredEntities();for(var i=0;i<this.aOrderedCards.length;i++){if(this.aOrderedCards[i].visibility){e=this._getCardFromManifest(this.aOrderedCards[i].id);if(e){v.push(e);}}}for(var i=0;i<v.length;i++){this._initCardModel(v[i].model);this._loadCardComponent(v[i].template);this._createModelViewMap(v[i]);}jQuery.sap.measure.start("ovp:CreateLoadingCards","Create Loading cards","ovp");for(var i=0;i<v.length;i++){this.createLoadingCard(v[i]);}jQuery.sap.measure.end("ovp:CreateLoadingCards");setTimeout(function(){this.getLayout().addStyleClass("ovpLayoutElementShow");}.bind(this),0);setTimeout(function(){jQuery.sap.measure.start("ovp:CreateCards","Create cards loop","ovp");for(var i=0,j=0;j<v.length;i++,j++){while(v[j].id!==o[i].id){i++;}e=v[j];if(!e.settings.title){jQuery.sap.log.error("title is mandatory for card ID : "+e.id);}if(e.settings.tabs){var I=0;if(this.aOrderedCards[i].selectedKey){I=this.aOrderedCards[i].selectedKey-1;}this.initializeTabbedCard(e,I);}e.settings.baseUrl=this._getBaseUrl();this.createCard(e);}jQuery.sap.measure.end("ovp:CreateCards");}.bind(this),10);if(this.busyDialog){this.busyDialog.close();}},_createModelViewMap:function(o){if(!o||!o.settings||!o.model){return;}if(!o.settings.entitySet||o.settings.entitySet===""){return;}var s=o.model;if(!this.oModelViewMap[s]){this.oModelViewMap[s]={};}this.oModelViewMap[s][o.id]=true;},initializeTabbedCard:function(o,i){if(o.template=="sap.ovp.cards.charts.analytical"){o.settings.chartAnnotationPath=o.settings.tabs[i].chartAnnotationPath;o.settings.navigation=o.settings.tabs[i].navigation;}o.settings.annotationPath=o.settings.tabs[i].annotationPath;o.settings.dynamicSubtitleAnnotationPath=o.settings.tabs[i].dynamicSubtitleAnnotationPath;o.settings.presentationAnnotationPath=o.settings.tabs[i].presentationAnnotationPath;o.settings.selectionAnnotationPath=o.settings.tabs[i].selectionAnnotationPath;o.settings.selectionPresentationAnnotationPath=o.settings.tabs[i].selectionPresentationAnnotationPath;o.settings.dataPointAnnotationPath=o.settings.tabs[i].dataPointAnnotationPath;o.settings.identificationAnnotationPath=o.settings.tabs[i].identificationAnnotationPath;o.settings.params=o.settings.tabs[i].params;o.settings.selectedKey=i+1;},_getLibraryResourceBundle:function(){if(!this.oLibraryResourceBundle){this.oLibraryResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");}return this.oLibraryResourceBundle;},_getOvplibResourceBundle:function(){if(!this.ovplibResourceBundle){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");this.ovplibResourceBundle=r?new R({bundleUrl:r.oUrlInfo.url}):null;}return this.ovplibResourceBundle;},_getCardsModel:function(){if(!this.oCards){var u=this.getUIModel();this.oCards=u.getProperty("/cards");}return this.oCards;},_getBaseUrl:function(){var u=this.getUIModel();if(!this.sBaseUrl){this.sBaseUrl=u.getProperty("/baseUrl");}return this.sBaseUrl;},_getCardFromManifest:function(s){var e=this._getCardsModel();for(var i=0;i<e.length;i++){if(e[i].id===s){return e[i];}}return null;},_getCardArrayAsVariantFormat:function(e){var j=[];for(var i=0;i<e.length;i++){var I=this._getCardId(e[i].getId());j.push({id:I,visibility:e[i].getVisible()});var s;if(this.getView()&&this.getView().byId){if(this.getView().byId(I).getComponentInstance()){s=this.getView().byId(I).getComponentInstance().getComponentData().settings.selectedKey;}}if(s){j[j.length-1].selectedKey=s;}}return j;},_mergeCards:function(l,v){var e=(v&&v.cards)?v.cards:[];e=this.bDeltaChangesEnabled?(this.deltaCardsInfo?this.deltaCardsInfo:[]):e;var r=[];var s;var k;var n;var L=(l&&l.length)?l:[];for(var i=0;i<e.length;i++){k=e[i].visibility;n=e[i].selectedKey;for(var j=0;j<L.length;j++){s=L[j].id;if(e[i].id===s){r.push({id:s,visibility:k});if(n){r[r.length-1].selectedKey=n;}break;}}}for(var j=0;j<L.length;j++){var o=false;s=L[j].id;k=L[j].visibility;n=L[j].selectedKey;for(var i=0;!o&&i<r.length;i++){if(r[i].id===s){o=true;}}if(!o){r.push({id:s,visibility:k});if(n){r[r.length-1].selectedKey=n;}}}return r;},_checkForAuthorization:function(e,n){var t=this;var u=[];var o=sap.ovp.cards.CommonUtils.getNavigationHandler();if(o&&o.oCrossAppNavService){o.oCrossAppNavService.isIntentSupported(n).done(function(r){for(var i=0;i<e.length;i++){if(r[e[i].cardIntent].supported===false){u.push(e[i].id);for(var j=0;j<t.aOrderedCards.length;j++){if(e[i].id===t.aOrderedCards[j].id){t.aOrderedCards.splice(j,1);break;}}}}t.organizeCards(t.aOrderedCards);for(var k=0;k<u.length;k++){for(var l=0;l<t.aManifestOrderedCards.length;l++){if(t.aManifestOrderedCards[l].id==u[k]){t.aManifestOrderedCards.splice(l,1);if(t.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){t.getLayout().dashboardLayoutUtil.aCards.filter(function(p,q){if(p.id===u[k]){t.getLayout().dashboardLayoutUtil.aCards.splice(q,1);}});t.getLayout().dashboardLayoutUtil.dashboardLayoutModel.oLayoutVars.filter(function(p,q){if(p.id===u[k]){t.getLayout().dashboardLayoutUtil.dashboardLayoutModel.oLayoutVars.splice(q,1);}});}break;}}}}).fail(function(){jQuery.sap.log.error("Could not get authorization from isIntentSupported");t.organizeCards(t.aOrderedCards);});}},_mergeLREPContent:function(l,L){var e=[];var u=this.getUIModel();var o={};if(this.bDeltaChangesEnabled){L=this.deltaCardsInfo||[];}else{this.savePersonalization();}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){this._bDashboardLayoutLrepActive=true;if(L&&L.cards){o=L.cards;this.getLayout().getDashboardLayoutModel().setLayoutVars(o);var i=u.getProperty("/cards");if(i&&o){e=this._initDashboardLayoutCardVisibility(i,o,l);}u.setProperty("/initialDashboardLayout",[this.getLayout().getDashboardLayoutUtil().buildLayout(jQuery(window).width())]);}if(e.length===0){e=this._mergeCards(this.aManifestOrderedCards,[]);}}else{e=this._mergeCards(this.aManifestOrderedCards,L);}return e;},_initDashboardLayoutCardVisibility:function(e,l,L){var j=[],s,o=null,v=true;for(var i=0;i<e.length;i++){s=e[i].id;o=l.filter(function(k){return k.id===s;});if(Array.isArray(o)&&o.length>0){v=o[0].visibility;}j.push({id:s,visibility:v,selectedKey:o[0].selectedKey});}return j;},_updateLayoutWithOrderedCards:function(){var l=this.getLayout();var o=this.aOrderedCards;l.removeAllContent();var e,k=false;if(this.getView().getModel("ui")&&this.getView().getModel("ui").getProperty("/cards")){e=this.getView().getModel("ui").getProperty("/cards");for(var i=0;i<e.length;i++){k=false;for(var j=0;j<o.length;j++){if(e[i].id==o[j].id){k=true;break;}}if(!k&&this.getView().byId(e[i].id)){this.getView().byId(e[i].id).destroy();}}}for(var i=0;i<o.length;i++){var n=this.getView().byId(o[i].id);n.setVisible(o[i].visibility);l.addContent(n);}},_updateDashboardLayoutCards:function(e){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().updateCardVisibility(e);}}},_resetDashboardLayout:function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().resetToManifest();}this.getLayout().rerender();}},_getCardArrayAsVariantFormatDashboard:function(){var e=[];var l=this.getLayout();var i=l.dashboardLayoutUtil.aCards;l.dashboardLayoutUtil.dashboardLayoutModel._sortCardsByRow(i);i.forEach(function(j){e.push({id:j.id,visibility:j.dashboardLayout.visible});});return e;},verifyGlobalFilterLoaded:function(){var G=this.getGlobalFilter();if(G.search()){if(G.validateMandatoryFields()){return true;}}this.getView().byId("ovpMain").setHeaderExpanded(true);return false;},onGlobalFilterChange:function(){this.filterChanged=true;},onGlobalFilterSearch:function(){if(this.filterChanged){var G=this.getGlobalFilter();if(G&&!G.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}this._clearStoredEntities();var e=[];if(this.oGlobalFilter['_aFields'].length>0){e=this.oGlobalFilter["_aFields"];}else{var k=this.oGlobalFilter['_aFilterBarViewMetadata'];for(var i=0;i<k.length;i++){var l=k[i];for(var j=0;j<l.fields.length;j++){e.push(l.fields[j]);}}}for(var i=0;i<e.length;i++){if(e[i].control){var n=document.getElementById(e[i].control.sId);if(jQuery(n).hasClass('sapMFocus')){this.filterItemInFocus=e[i].control;break;}}}var s="ovp-"+new Date().getTime();for(var o in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(o)){try{this.oCardsModels[o].refresh(false,false,s);}catch(p){jQuery.sap.log.warning(p);}}}this.filterChanged=false;this._clearStoredEntities();}},_clearStoredEntities:function(){if(this.sPreviousEntityType){this.sPreviousEntityType="";}if(this.sCurrentEntityType){this.sCurrentEntityType="";}},_processFilters:function(){this.aFilters=[];var G=this.getGlobalFilter();if(!G){return;}var e=G.getFilters();var o=this.getCustomFilters();if(o&&(o instanceof sap.ui.model.Filter)){if(o){var i=[];if(e&&e.length>0){i.push(new F([e[0],o],true));}else{i.push(o);}if(i.length>0){e=i;}}}this.aFilters=e;},_initGlobalFilter:function(){var G=this.getGlobalFilter();if(!G){this.bGlobalFilterLoaded=true;this._parseNavigationVariant();jQuery.sap.measure.end("ovp:GlobalFilter");return;}G.attachFiltersDialogClosed(this._storeCurrentAppStateAndAdjustURL.bind(this));var v=G.getVariantManagement();if(v){v.attachAfterSave(function(e){this._storeCurrentAppStateAndAdjustURL();}.bind(this));}this.oGlobalFilterLoadedPromise=new Promise(function(r,e){G.attachInitialized(function(){this._parseNavigationVariant();if(this.oParseNavigationPromise){this.oParseNavigationPromise.done(function(o,u,n){if(o){this._setNavigationVariantToGlobalFilter(o,u,n);this.filterChanged=false;}}.bind(this));this.oParseNavigationPromise.fail(function(){jQuery.sap.log.error("Could not parse navigation variant from URL");});this.oParseNavigationPromise.always(function(){if(G&&this.verifyGlobalFilterLoaded()){r();}}.bind(this));}else{if(G&&this.verifyGlobalFilterLoaded()){r();}}},this);G.attachSearch(function(){if(!this.bGlobalFilterLoaded){r();this.bGlobalFilterLoaded=true;if(!G.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}return;}this.onGlobalFilterSearch();},this);G.attachFilterChange(this.onGlobalFilterChange,this);}.bind(this));this.oGlobalFilterLoadedPromise.then(function(V){this.bGlobalFilterLoaded=true;jQuery.sap.measure.end("ovp:GlobalFilter");}.bind(this));},onShareButtonPress:function(e){var l=this._getLibraryResourceBundle();var u=this.getUIModel();var t=u&&u.getProperty("/title");if(!this._oShareActionButton){this._oShareActionButton=sap.ui.xmlfragment("sap.ovp.app.SharePage",{shareEmailPressed:function(){sap.m.URLHelper.triggerEmail(null,l.getText("Email_Subject",[t]),document.URL);}.bind(this)});this.getView().addDependent(this._oShareActionButton);}this._oShareActionButton.openBy(e.getSource());},_createModelForTile:function(){var u=this.getUIModel();var H,t=u&&u.getProperty("/title");var o={tileTitle:t,tileCustomURL:function(){H=hasher.getHash();return H?("#"+H):window.location.href;}};if(u){u.setProperty("/tileInfo",o);}},_loadCardComponent:function(s){if(!this.oLoadedComponents[s]){jQuery.sap.measure.start("ovp:CardComponentLoad:"+s,"Card Component load","ovp");this.oLoadedComponents[s]=sap.ui.component.load({name:s,url:jQuery.sap.getModulePath(s),async:true});this.oLoadedComponents[s].then(function(){jQuery.sap.measure.end("ovp:CardComponentLoad:"+s);});}},_initCardModel:function(s){var e=false;if(this.oCardsModels[s]||!s){return;}this.oCardsModels[s]=this.getView().getModel(s);if(!this.oCardsModels[s].bUseBatch){this.oCardsModels[s].setUseBatch(false);}else{this.oCardsModels[s].setUseBatch(true);}if(this.getGlobalFilter()){e=true;}this._overrideCardModelRead(this.oCardsModels[s],e);},toggleFilterBar:function toggleFilterBar(){var G=this.getGlobalFilter();function t(k,l,n){l.height(n);k.css('top',0);}function i(k,l,n){l.height(0);k.css("top","-"+n+"px");}var j=G.getVisible();if((sap.ui.Device.system.phone)||(sap.ui.Device.system.tablet)){G.setVisible(!j);return;}if(toggleFilterBar.animationInProcess){return;}toggleFilterBar.animationInProcess=true;if(j){var k=jQuery(G.getDomRef());var l=jQuery(this.getView().byId("ovpGlobalFilterWrapper").getDomRef());var n=l.height();t(k,l,n);l.height();l.one('transitionend',function(e){G.setVisible(false);toggleFilterBar.animationInProcess=false;});i(k,l,n);}else{G.setVisible(true);setTimeout(function(){var k=jQuery(G.getDomRef());var l=jQuery(this.getView().byId("ovpGlobalFilterWrapper").getDomRef());var n=k.outerHeight();i(k,l,n);l.height();l.one('transitionend',function(e){l.css("height","auto");toggleFilterBar.animationInProcess=false;});t(k,l,n);}.bind(this));}},getVisibleCustomFields:function(){var G=this.getGlobalFilter();var e=G.getAllFilterItems(true);var l,i,v=[];if(e){l=e.length;while(l--){i=e[l];if(i&&i.getVisibleInFilterBar()){v.push(i.getName());}}}var j,k,n,o=G.getFilterBarViewMetadata();var p=[];if(o){j=o.length;while(j--){n=o[j].fields;if(n){k=n.length;while(k--){if(n[k].isCustomFilterField&&v.indexOf(n[k].fieldName)>-1){p.push({name:n[k].fieldName});}}}}}return p;},_showErrorPage:function(s){if(this.getView()&&this.getView().byId&&this.getView().byId('ovpErrorPage')){var o=jQuery(this.getView().byId('ovpErrorPage').getDomRef());var e=jQuery(this.getView().byId('ovpMain').getDomRef());if(s){o.show();e.hide();return;}o.hide();e.show();}},_overrideCardModelRead:function(o,s){var e=o.read;var t=this;o.read=function(){if(s){t._processFilters();var G=t.getGlobalFilter();if(!t.aFilters){t.aFilters=[];}var j=false;var p=arguments[1];if(!p){p={};Array.prototype.push.call(arguments,p);}var E=t._getEntityTypeFromPath(o,arguments[0],p.context,false);t.sCurrentEntityType=E.entityType;if(t.sPreviousEntityType!==t.sCurrentEntityType){t.sPreviousEntityType=t.sCurrentEntityType;j=true;}if(!t.aRelevantFilters){t.aRelevantFilters=[];j=true;}if(j){t.aRelevantFilters=[];var v=false;if(t.oValueHelpMap){if(t.oValueHelpMap.indexOf(E.entityType)!=-1){v=true;}}if(E&&!v){t.aRelevantFilters=t._getEntityRelevantFilters(E,t.aFilters,o,G.getModel());}}if(t.aRelevantFilters&&t.aRelevantFilters.length>0){var k=-1;var u=p.urlParameters;if(u){for(var l=0;l<u.length;l++){if((u[l]).lastIndexOf("$filter=",0)===0){k=l;break;}}}if(k>=0){u[k]=u[k]+"%20and%20"+sap.ui.model.odata.ODataUtils.createFilterParams(t.aRelevantFilters,o.oMetadata,E).substr(8);}else{p.filters=t.aRelevantFilters;}}if(G&&G.getConsiderAnalyticalParameters()){var n=G.getAnalyticBindingPath();var I,q,r;if(n&&n.length>0){if(E.name===G.getEntityType()){q=arguments[0];I=arguments[0].indexOf('$');if(I>0){q=arguments[0].substring(0,I-1);}r=n;if(q!==r){arguments[0]=arguments[0].replace(q,r);}}else{var w=t._getParametersFromEntityPath(arguments[0]);var x=t._getParametersFromEntityPath(n);var y,z,H;if(w&&w.length>0){var K=t._getEntityTypeFromPath(o,arguments[0],p.context,true);for(var i=0;i<x.length;i++){y=t._getPropertyMapping(w,x[i].name,K.name,G.getEntityType(),o,G.getModel());if(y){z=y+"=.*?,|"+y+"=.*?\\)";H=arguments[0].match(new RegExp(z));if(H&&H.length>0){q=H[0].slice(0,-1);r=y+"="+x[i].sValue;if(q!==r){arguments[0]=arguments[0].replace(q,r);}}}}}}}}}var L=arguments[1].success;arguments[1].success=(function(V,t){return function(){if(!t.errorHandlingObject.atLeastOneRequestSuccess){t.errorHandlingObject.atLeastOneRequestSuccess=true;t._showErrorPage(false);}if(t.filterItemInFocus!=null){t.filterItemInFocus.focus();t.filterItemInFocus=null;}if(t.nRefreshInterval!==0){if(t.oRefreshTimer!==null){clearTimeout(t.oRefreshTimer);}t.attachRefreshInterval(t.nRefreshInterval);}return V.apply(this,arguments);};})(L,t);var Q=arguments[1].error;arguments[1].error=(function(V,t){return function(){if(!t.errorHandlingObject.atLeastOneRequestSuccess){clearTimeout(t.errorHandlingObject.errorLoadingTimeout);t.errorHandlingObject.errorLoadingTimeout=setTimeout(function(){if(!t.errorHandlingObject.atLeastOneRequestSuccess){t._showErrorPage(true);}},9000);}return V.apply(this,arguments);};})(Q,t);e.apply(o,arguments);};},attachRefreshInterval:function(n){this.oRefreshTimer=setTimeout(function(){for(var e in this.oCardsModels){this.oCardsModels[e].refresh(false,false);}}.bind(this),n);},_getEntityTypeFromPath:function(o,p,e,i){var n=sap.ui.model.odata.v2.ODataModel.prototype._normalizePath.apply(o,[p,e]);if(i){n=p.replace(/^\/|\/$/g,"").split("/")[0];if(n.indexOf("(")!=-1){n=n.substring(0,n.indexOf("("));}}var E=sap.ui.model.odata.ODataMetadata.prototype._getEntityTypeByPath.apply(o.oMetadata,[n]);return E;},_getPropertyMapping:function(e,t,E,s,o,j){var i,k;for(i=0;i<e.length;i++){if(e[i].name===t){k=e[i].name;return k;}if((("P_"+e[i].name)===t)||(e[i].name===("P_"+t))){k=e[i].name;return k;}}if(!E||!s||!o||!j){return;}var l=o.oMetadata._getEntityTypeByName(E);var n=j.oMetadata._getEntityTypeByName(s);if(!l||!n){return;}var p="com.sap.vocabularies.Common.v1.SemanticObject";var q="com.sap.vocabularies.Common.v1.SemanticObjectMapping";var r=o.oAnnotations.getAnnotationsData();if(!r||!r.propertyAnnotations){return;}var u=r.propertyAnnotations[l.namespace+"."+l.name];var v=j.oAnnotations.getAnnotationsData();if(!v||!v.propertyAnnotations){return;}var w=v.propertyAnnotations[n.namespace+"."+n.name];var x=w&&w[t];if(!x||!x[p]){return;}var y,z,G,H,L;for(y in u){z=u[y];if(z[p]&&z[p].String===x[p].String){G=z[q];if(!G){continue;}H=G.length;L="";while(H--){if(G[H].SemanticObjectProperty.String===t){L=G[H].LocalProperty.PropertyPath;break;}}if(L!==""){for(i=0;i<e.length;i++){if(e[i].name===L){k=e[i].name;return k;}}}}}return k;},_getParametersFromEntityPath:function(e){var E=[];if(/\(.*\)/.test(e)){var p=e.match(/\(.*\)/)[0].slice(1,-1).trim().split(/\=|\,/);for(var i=0;i<p.length;i=i+2){E.push({name:p[i],sValue:p[i+1]});}}return E;},_checkRelevantFiltersRecursive:function(e,o,E,t,j,k){if(!o._bMultiFilter){o.sPath=o.sPath.split('/').pop();var s=this._getPropertyMapping(e,o.sPath,E,t,j,k);if(s){o.sPath=s;return o;}}else{var l=o.aFilters;var n,p=[];if(l){for(var i=0;i<l.length;i++){n=this._checkRelevantFiltersRecursive(e,l[i],E,t,j,k);if(n){p.push(n);}}if(p.length>0){return(new F(p,o.bAnd));}}}},_getEntityRelevantFilters:function(e,i,E,o){var r=[];if(i.length>0&&e){var j=this._checkRelevantFiltersRecursive(e.property,i[0],e.name,this.getGlobalFilter().getEntityType(),E,o);if(j){r.push(j);}}return r;},_checkIsCardValid:function(s){var e=s+".Component";var o,i;jQuery.sap.require(e);var j=jQuery.sap.getObject(e);if(!j){return false;}if((j!==sap.ovp.cards.generic.Component)&&!(j.prototype instanceof sap.ovp.cards.generic.Component)){return false;}if((o=j.getMetadata())&&(i=o.getCustomizing())){if(i["sap.ui.viewReplacements"]&&i["sap.ui.viewReplacements"]["sap.ovp.cards.generic.Card"]){return false;}}if(j.prototype.createContent!=sap.ovp.cards.generic.Component.prototype.createContent){return false;}if(j.prototype.getPreprocessors!=sap.ovp.cards.generic.Component.prototype.getPreprocessors){return false;}return true;},_createCardComponent:function(v,o,e){var i="ovp:CreateCard-"+e.template+":"+e.id;jQuery.sap.measure.start(i,"Create Card","ovp");var j=v.getModel("@i18n");if(e.template&&this._checkIsCardValid(e.template)){var k={async:true,name:e.template,componentData:{model:o,modelName:e.model,i18n:j,cardId:e.id,settings:e.settings,appComponent:this.getOwnerComponent(),mainComponent:this}};var G=this.getGlobalFilter();if(G){k.componentData.globalFilter={getUiState:G.getUiState.bind(G)};}var t=v;sap.ui.component(k).then(function(l){var n=t.byId(l.getComponentData().cardId);n.setPropagateModel(true);var p=n.getComponentInstance();n.setComponent(l);if(p){setTimeout(function(){p.destroy();},0);}});}else{jQuery.sap.log.error("Could not create Card from '"+e.template+"' template. Card is not valid.");}jQuery.sap.measure.end(i);},createLoadingCard:function(e){var l=jQuery.extend(true,{},e,{template:"sap.ovp.cards.loading"});this._createCardComponent(this.getView(),undefined,l);},createCard:function(e){var v=this.getView();var o=v.getModel(e.model);Promise.all([o.getMetaModel().loaded(),this.oGlobalFilterLoadedPromise,this.oLoadedComponents[e.template]]).then(function(){this._createCardComponent(v,o,e);}.bind(this),function(r){jQuery.sap.log.error("Can't load card with id:'"+e.id+"' and type:'"+e.template+"', reason:"+r);});},_getCardId:function(e){var i=this.getView().getId()+"--";if(e.indexOf(i)!=-1){var s=e.indexOf(i)+i.length;return e.substr(s);}return e;},_initFlexibilityPersonalization:function(){this.oFlexibilityPersonalizationPromise=new Promise(function(r,e){var l=this.getLayout();var o=sap.ui.fl.FlexControllerFactory;this.oFlexController=o.createForControl(l);this.oFlexController.getComponentChanges().then(function(i){if(i.length>0){this.bDeltaChangesEnabled=true;}r();}.bind(this),function(E){r();}.bind(this));}.bind(this));},_initSmartVariantManagement:function(){if(!this.bDeltaChangesEnabled){var p=this._createPersistencyControlForSmartVariantManagement();var o=new P({type:"OVPVariant",keyName:"persistencyKey",control:p});this.oPersistencyVariantPromise=new Promise(function(r,e){this.smartVariandManagement=new S({personalizableControls:o,initialise:function(E){var k=E.getParameters().variantKeys;if(k.length){r(this.smartVariandManagement.getVariantContent(p,k[0]));}else{r(null);}}.bind(this)});this.smartVariandManagement.initialise();}.bind(this));}else{this.oPersistencyVariantPromise=Promise.resolve();}},layoutChanged:function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this._bDashboardLayoutLrepActive){this.savePersonalization();}}else{var e=this.getLayout().getContent();this.aOrderedCards=this._getCardArrayAsVariantFormat(e);this.savePersonalization();}},saveVariant:function(e){var t=this;this.smartVariandManagement.getVariantsInfo(function(v){var p=null;if(v&&v.length>0){p=v[0].key;}var o=p!==null;var i={name:"Personalisation",global:false,overwrite:o,key:p,def:true};t.smartVariandManagement.fireSave(i);});},savePersonalization:function(){var l=this.getLayout();if(l){var e,s;if(l.getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){e={cards:l.getLayoutDataJSON()};s="manageCardsForDashboardLayout";}else{e=this._getCardArrayAsVariantFormat(l.getContent());s="manageCardsForEasyScanLayout";}this.oFlexController.createAndApplyChange({changeType:s,content:e,isUserDependent:true},l);this.oFlexController.saveAll();}},getLayout:function(){return this.getView()?this.getView().byId("ovpLayout"):null;},_createPersistencyControlForSmartVariantManagement:function(){var t=this;sap.ui.core.Control.extend("sap.ovp.app.PersistencyControl",{metadata:{properties:{persistencyKey:{type:"string",group:"Misc",defaultValue:null}}}});var p=new sap.ovp.app.PersistencyControl({persistencyKey:"ovpVariant"});p.fetchVariant=function(){if(t.isInitialLoading){t.isInitialLoading=false;return{};}var l=this.getLayout();if(!l){jQuery.sap.log.error("Could not save persistency variant - 'ovpLayout' does not exists");return;}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var v=this.getLayout().getLayoutDataJSON();return{cards:v};}else{var L=l.getContent();var e=this._getCardArrayAsVariantFormat(L);this.oOrderedCards=e;return{cards:e};}}.bind(this);return p;},_initShowHideCardsButton:function(){var r=sap.ushell.Container.getRenderer("fiori2"),e={controlType:"sap.ushell.ui.launchpad.ActionItem",bCurrentState:false,oControlProperties:{icon:"sap-icon://dimension",text:this._getLibraryResourceBundle().getText("hideCardsBtn_title"),tooltip:this._getLibraryResourceBundle().getText("hideCardsBtn_tooltip"),press:this._onCardMenuButtonPress.bind(this)},bIsVisible:true,aStates:["app"]};r.addUserAction(e);},_onCardMenuButtonPress:function(){var o;function e(u,v){for(var i=0;i<u.length;i++){if(u[i].id==v){return i;}}return-1;}function j(u,v){var w=-1;for(var i=0;i<v.length;i++){if(u[i].id==v[i].id){w=i;}else{w=e(u,v[i].id);}if(v[i].visibility!=u[w].visibility){if(v[i].visibility===true){var x=this._getCardFromManifest(v[i].id);if(x){this.createLoadingCard(x);x.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(x.model);this._loadCardComponent(x.template);this._createModelViewMap(x);if(x.settings.tabs){var I=0;if(this.aOrderedCards[i].selectedKey){I=this.aOrderedCards[i].selectedKey-1;}this.initializeTabbedCard(x,I);}this.createCard(x);}}else{var y=this.getView().byId(v[i].id);var z=y.getComponentInstance();if(z){z.destroy();}}}}}function k(i){var u=this._getCardFromManifest(i);var v=u.settings;if(v.title){return v.title;}else if(v.category){return(v.category);}else if(v.subTitle){return v.subTitle;}return i;}var l=new d({cells:[new T({text:{path:"id",formatter:k.bind(this)}}),new f({state:"{visibility}",customTextOff:" ",customTextOn:" ",change:function(i){var u=i.oSource.getParent();u.toggleStyleClass('sapOVPHideCardsTableItem');u.getCells()[0].toggleStyleClass('sapOVPHideCardsDisabledCell');},tooltip:this._getLibraryResourceBundle().getText("hideCards_switchTooltip")})]});var n=new g("sapOVPHideCardsTable",{backgroundDesign:sap.m.BackgroundDesign.Transparent,showSeparators:sap.m.ListSeparators.Inner,columns:[new h({vAlign:"Middle"}),new h({hAlign:sap.ui.core.TextAlign.Right,vAlign:"Middle",width:"4.94rem"})]});n.addStyleClass('sapOVPHideCardsTable');n.bindItems({path:"/cards",template:l});var p=n.onAfterRendering;n.onAfterRendering=function(u){p.apply(n,arguments);var v=u.srcControl.mAggregations.items;if(v){for(var i=0;i<v.length;i++){if(!v[i].getCells()[1].getState()){v[i].addStyleClass('sapOVPHideCardsTableItem');v[i].getCells()[0].addStyleClass('sapOVPHideCardsDisabledCell');}}}setTimeout(function(){jQuery('.sapMListTblRow').first().focus();},200);};var s=new m("manageCardsokBtn",{text:this._getLibraryResourceBundle().getText("okBtn"),press:function(){var i=this.oDialog.getModel().getProperty('/cards');j.apply(this,[this.aOrderedCards,i]);this.aOrderedCards=i;this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.savePersonalization();this.oDialog.close();}.bind(this)});var q=new m("manageCardsCancelBtn",{text:this._getLibraryResourceBundle().getText("cancelBtn"),press:function(){this.oDialog.close();}.bind(this)});var r=new m("manageCardsResetBtn",{text:this._getLibraryResourceBundle().getText("resetBtn"),enabled:((this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout")?true:this.isValidForReset()),press:function(){sap.m.MessageBox.show(this._getLibraryResourceBundle().getText("reset_cards_confirmation_msg"),{id:"resetCardsConfirmation",icon:sap.m.MessageBox.Icon.QUESTION,title:this._getLibraryResourceBundle().getText("reset_cards_confirmation_title"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(i){if(i===sap.m.MessageBox.Action.OK){j.apply(this,[this.aOrderedCards,this.aManifestOrderedCards]);this.aOrderedCards=this.aManifestOrderedCards;this._resetDashboardLayout();this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.oFlexController.discardChangesForId(this.getLayout().getId(),true);this.savePersonalization();this.oDialog.close();}}.bind(this)});}.bind(this)});this.oDialog=new D({title:this._getLibraryResourceBundle().getText("hideCardsBtn_title"),contentWidth:"29.6rem",contentHeight:"50%",stretch:sap.ui.Device.system.phone,content:n,buttons:[s,q,r],afterClose:function(){this.oDialog.destroy();}.bind(this)}).addStyleClass("sapOVPCardsVisibilityDialog");var t;if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){t=jQuery.extend(true,[],this._getCardArrayAsVariantFormatDashboard());}else{t=jQuery.extend(true,[],this.aOrderedCards);}o=new J({cards:t});this.oDialog.setModel(o);this.oDialog.open();},isValidForReset:function(){for(var i=0;i<this.aManifestOrderedCards.length;i++){if(this.aManifestOrderedCards[i].id!==this.aOrderedCards[i].id||this.aManifestOrderedCards[i].visibility!==this.aOrderedCards[i].visibility){return true;}}return false;},isDragAndDropEnabled:function(){return!sap.ui.Device.system.phone;},getGlobalFilter:function(){if(!this.oGlobalFilter){this.oGlobalFilter=this.getView().byId("ovpGlobalFilter");}return this.oGlobalFilter;},getUIModel:function(){if(!this.oUIModel){var o=this.getOwnerComponent();this.oUIModel=o&&o.getModel("ui");}return this.oUIModel;},_parseNavigationVariant:function(){this.oNavigationHandler=this.oNavigationHandler||new N(this);this.oParseNavigationPromise=this.oNavigationHandler.parseNavigation();sap.ovp.cards.CommonUtils.enable(this,this.oNavigationHandler);},_setNavigationVariantToGlobalFilter:function(o,u,n){var G=this.getGlobalFilter();if(!G){return;}switch(n){case"iAppState":if(o.selectionVariant){var e,s,j,k=false;var l,p,q,r;var t,v,w;G.clearVariantSelection();e=JSON.parse(o.selectionVariant);G.setCurrentVariantId(e.SelectionVariantID);v=G.getUiState({allFilters:false});p=v&&JSON.stringify(v.getSelectionVariant());r=G.getFilterData()._CUSTOM;r=((typeof r=='undefined')?{}:r);t=new U({selectionVariant:o.oSelectionVariant.toJSONObject()});G.setUiState(t,{replace:true,strictMode:false});s=new c(o.selectionVariant);j=s.getParameterNames().concat(s.getSelectOptionsPropertyNames());for(var i=0;i<j.length;i++){G.addFieldToAdvancedArea(j[i]);}w=G.getUiState({allFilters:false});l=w&&JSON.stringify(w.getSelectionVariant());if(p!==l){k=true;}if(o.customData&&Object.keys(o.customData).length>0){var q=o.customData;this.restoreCustomAppStateDataExtension(q);if(JSON.stringify(r)!==JSON.stringify(q)){k=true;}}G.getSmartVariant().currentVariantSetModified(k);G._updateToolbarText();}break;case"xAppState":case"URLParams":var t,x=[];var y=new c(o.oSelectionVariant.toJSONObject());var z=new c(o.oDefaultedSelectionVariant.toJSONObject());if(!o.bNavSelVarHasDefaultsOnly&&!y.isEmpty()){t=new U({selectionVariant:y.toJSONObject()});G.clearVariantSelection();G.clear();G.setUiState(t,{replace:true,strictMode:false});x=x.concat(y.getParameterNames().concat(y.getSelectOptionsPropertyNames()));}if(o.bNavSelVarHasDefaultsOnly&&!z.isEmpty()&&G.getCurrentVariantId()===""){t=new U({selectionVariant:z.toJSONObject()});G.setUiState(t,{replace:false,strictMode:false});x=x.concat(z.getParameterNames().concat(z.getSelectOptionsPropertyNames()));}var L;if(x&&x.length>0){L=x.length;while(L--){G.addFieldToAdvancedArea(x[L]);}}if(G.getCurrentVariantId()!==""){this._setDisplayCurrency(z);}break;}},_setDisplayCurrency:function(o){var G=this.getGlobalFilter();if(!G){return;}var l,e;var p=G.getAnalyticalParameters();if(p&&p.length>0){l=p.length;while(l--){if((p[l].name==="P_DisplayCurrency")||(p[l].name==="DisplayCurrency")){e=p[l];break;}}}if(!e){return;}var i=G.getFilters([e.fieldName]);var s=i&&i[0]&&i[0].oValue1;if(s&&s!==" "){return;}var n,j;if(e.name.indexOf("P_")===0){j=e.name;n=e.name.substr(2);}else{j="P_"+e.name;n=e.name;}if(o&&!o.isEmpty()){var k;s=o.getParameter(n);if(!s||s===" "){s=o.getParameter(j);}if(!s||s===" "){k=o.getSelectOption(n);s=k&&k[0]&&k[0].Low;}if(!s||s===" "){k=o.getSelectOption(j);s=k&&k[0]&&k[0].Low;}}if(!s||s===" "){s=e.defaultPropertyValue;}if(!s||s===" "){return;}var q=new c();q.addParameter(e.name,s);var u=new U({selectionVariant:q.toJSONObject()});G.setUiState(u,{replace:false,strictMode:false});},_enhanceVariant:function(v,o,n){var p=v.getParameter(o);var s=v.getSelectOption(o);if(p){v.renameParameter(o,n);}else if(s){var V=s[0]&&s[0].Low;if(V&&V!==""){V+="";v.addParameter(n,V);v.removeSelectOption(o);}}return v;},onBeforeSFBVariantSave:function(){var o={};this.getCustomAppStateDataExtension(o);this.getGlobalFilter().setFilterData({_CUSTOM:o});},onAfterSFBVariantLoad:function(){var o=this.getGlobalFilter().getFilterData();if(o._CUSTOM&&Object.keys(o._CUSTOM).length>0){this.restoreCustomAppStateDataExtension(o._CUSTOM);}},onAssignedFiltersChanged:function(e){if(e.getSource()&&this.getView().byId("ovpFilterText")){this.getView().byId("ovpFilterText").setText(e.getSource().retrieveFiltersWithValuesAsText());}},_getCurrentAppState:function(){var G=this.getGlobalFilter();var u=G.getUiState({allFilters:false});var s=u&&u.getSelectionVariant();if(G.getSmartVariant().currentVariantGetModified()){s.SelectionVariantID="";}var e=s&&JSON.stringify(s);var n=new c(e);var o={};this.getCustomAppStateDataExtension(o);return{selectionVariant:n.toJSONString(),customData:o};},_storeCurrentAppStateAndAdjustURL:function(e){if(e&&!e.oSource._bDirtyViaDialog){return;}if(!this.bGlobalFilterLoaded){return;}if(this.oAppStatePromise){this.rejectPreviousPromise&&this.rejectPreviousPromise("skip");}this.oAppStatePromise=new Promise(function(j,k){this.rejectPreviousPromise=k;var o=this._getCurrentAppState();var l=this.oNavigationHandler.storeInnerAppStateWithImmediateReturn(o);l.promise.then(function(s){j(s);},function(E){k(E.getErrorCode());});}.bind(this));var i=function(s){this.oAppStatePromise=null;if(s&&s.length>0){this.oNavigationHandler.replaceHash(s);return;}throw"AppState key is empty";};var r=function(E){this.oAppStatePromise=null;if(E==="skip"){throw E;}throw("Something went wrong while storing AppState - "+E);};this.oAppStatePromise.then(i.bind(this),r.bind(this)).catch(function(E){if(E==="skip"){return;}jQuery.sap.log.error(E);});}});});
