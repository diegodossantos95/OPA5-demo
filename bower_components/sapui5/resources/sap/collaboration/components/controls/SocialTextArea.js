/*
* ! SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2017 SAP SE. All rights reserved
*/
jQuery.sap.includeStyleSheet(jQuery.sap.getModulePath("sap.collaboration.components.resources.css.SocialTextArea",".css"));sap.ui.define(['jquery.sap.global','sap/ui/model/json/JSONModel','sap/m/TextArea','sap/m/InputBase','sap/m/Popover','sap/m/List','sap/m/StandardListItem','sap/collaboration/components/controls/SuggestionUtility','sap/collaboration/components/utils/LanguageBundle'],function(q,J,T,I,P,L,S,a,b){var c=T.extend("sap.collaboration.components.controls.SocialTextArea",{metadata:{library:"sap.collaboration",properties:{initialValue:{type:"string",group:"Data",defaultValue:null},enableNotifyAll:{type:"boolean",group:"Behavior",defaultValue:true},suggestionPlacement:{type:"sap.m.PlacementType",group:"Misc",defaultValue:sap.m.PlacementType.VerticalPreferedBottom},suggestionHeight:{type:"sap.ui.core.CSSSize",group:"Appearance"},},events:{suggest:{parameters:{value:{type:"string"}}},afterSuggestionClose:{}}},renderer:{}});c.prototype.init=function(){T.prototype.init.apply(this);this.addStyleClass("sapCollaborationSocialTextArea");this._sTextAreaOldValue="";this._sTextAreaCurrentValue="";this._aAtMentionBuffer=[];this._mCurrentAtMention=undefined;this._oModel=new J();var s=new S({title:"{fullName}",description:"{email}",icon:"{userImage}"});this._oList=new L(this.getId()+"-list",{mode:sap.m.ListMode.SingleSelectMaster,rememberSelections:false,showSeparators:sap.m.ListSeparators.None}).setModel(this._oModel).bindItems("/",s);this._oPop=new P(this.getId()+"-pop",{showHeader:false,showArrow:false,content:[this._oList],}).setInitialFocus(this);this._oSuggestionUtil=a;this._oLangBundle=new b();this._oList.attachSelectionChange(this.onSelectionChange.bind(this));};c.prototype.exit=function(){this._oPop.destroy();this._oPop=undefined;this._oSuggestionUtil=undefined;};c.prototype.onBeforeRendering=function(){this._oPop.setPlacement(this.getSuggestionPlacement());this.getEnableNotifyAll()?this._oList.setProperty("noDataText",this._oLangBundle.getText("ST_NO_SUGGESTIONS",["@@notify"])):this._oList.setProperty("noDataText",this._oLangBundle.getText("ST_ADD_POST_NO_SUGGESTIONS"));};c.prototype.onAfterRendering=function(){T.prototype.onAfterRendering.apply(this);this._oPop.setContentWidth((q(this.getDomRef()).width()).toString()+"px");var e=q("#"+this.getId()).children()[0];if(e){q("#"+e.id).css({'height':'100%'});}q("#"+this.getId()).css({'padding-top':'0','padding-bottom':'0'});};c.prototype.oninput=function(e){T.prototype.oninput.apply(this,[e]);if(e.isMarked("invalid")){return;}this._sTextAreaCurrentValue=this.getValue();if(this._sTextAreaCurrentValue.trim()===""){this._aAtMentionBuffer=[];this.closeSuggestionPopover();}else{this._triggerSuggestions(this._sTextAreaCurrentValue,this._sTextAreaOldValue);}this._sTextAreaOldValue=this._sTextAreaCurrentValue;};c.prototype.onSelectionChange=function(e){var l=e.getParameter("listItem");var f=l.getProperty("title");var E=l.getProperty("description");this._sTextAreaCurrentValue=this._oSuggestionUtil.getTextAreaValueAfterSuggestionSelected(f,E,this._mCurrentAtMention,this._aAtMentionBuffer,this._sTextAreaCurrentValue,f==="@@notify");this.setValue(this._sTextAreaCurrentValue);this._sTextAreaOldValue=this._sTextAreaCurrentValue;this.closeSuggestionPopover();this.selectText(this._mCurrentAtMention.endIndex+2,this._mCurrentAtMention.endIndex+2);this._oList.removeSelections();};c.prototype.showSuggestions=function(s){if(s.length!==0&&s[s.length-1].fullName!=="@@notify"&&this.getEnableNotifyAll()){s.push({fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"});}if(s.length!==0){this._oPop.close();}this._oModel.setData(s);this._oPop.openBy(this);return this;};c.prototype.setInitialValue=function(t){this.setProperty("initialValue",t,true);this.setValue(t);this._aAtMentionBuffer=[];this._sTextAreaCurrentValue=t;this._sTextAreaOldValue=t;return this;};c.prototype.setSuggestionHeight=function(h){this.setProperty("suggestionHeight",h,true);this._oPop.setContentHeight(h);return this;};c.prototype.closeSuggestionPopover=function(){this._oPop.close();this.fireAfterSuggestionClose();return this;};c.prototype.clearText=function(){this._sTextAreaCurrentValue="";this._sTextAreaOldValue="";this._aAtMentionBuffer=[];this.setValue("");return this;};c.prototype.convertTextWithFullNamesToEmailAliases=function(){return this._oSuggestionUtil.convertTextWithFullNamesToEmailAliases(this.getValue(),this._aAtMentionBuffer);};c.prototype.atMentionsButtonPressed=function(){var C=this.getDomRef("inner").selectionStart;var A=this._oSuggestionUtil.atMentionsButtonPressed(this.getValue(),C);this.setValue(A.newValue);this._sTextAreaCurrentValue=this.getValue();this.focus();this.selectText(A.cursorPosition,A.cursorPosition);this._triggerSuggestions(this._sTextAreaCurrentValue,this._sTextAreaOldValue);this._sTextAreaOldValue=this._sTextAreaCurrentValue;return this;};c.prototype._triggerSuggestions=function(t,d){if(!sap.ui.Device.system.phone){var o=this._oSuggestionUtil.getChangesInTextArea(t,d);if(o.operation==="addChar"){this._handleAddedCharacters(o,t);}else if(o.operation==="deleteChar"){this._handleDeletedCharacters(o,t,this._aAtMentionBuffer);}}};c.prototype._handleAddedCharacters=function(t,d){var e=t.changeIndex;var s=t.charactersChanged;var A=this._aAtMentionBuffer.length;var f=this.getEnableNotifyAll();if(f&&s[0]==="@"&&d[e-1]==="@"&&(d[e-2]===" "||d[e-2]==="\n"||d[e-2]===undefined)){this.showSuggestions([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}]);for(var i=0;i<A;i++){if(this._aAtMentionBuffer[i].startIndex===e-1){this._aAtMentionBuffer[i].endIndex+=s.length;}else if(e<this._aAtMentionBuffer[i].startIndex){this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[i],s.length);}}}else if(s[0]==="@"||(s[0]===" "&&s[1]==="@")){if(s[1]==="@"){e+=1;}var C=this._oSuggestionUtil.addToAtMentionBuffer(this._aAtMentionBuffer,e,s);this._mCurrentAtMention=this._aAtMentionBuffer[C];if(s==="@ "){this._mCurrentAtMention.endIndex-=1;}var g=d[this._mCurrentAtMention.startIndex-1];var n=this._mCurrentAtMention.endIndex+1;if(g===" "||g===undefined||g==='\n'){var N=d[n];while(N!==" "&&N!==undefined&&N!=='\n'){n+=1;N=d[n];}this._mCurrentAtMention.endIndex=n-1;this.fireSuggest({value:d.substring(e+1,n)});}else{this.closeSuggestionPopover();}}else{for(var i=A-1;i>=0;i--){if(e>this._aAtMentionBuffer[i].startIndex){var h=this._oSuggestionUtil.getStringAfterAtMention(e+s.length-1,d,this._aAtMentionBuffer[i]);var j=this._oSuggestionUtil.getStringBeforeAtMention(this._aAtMentionBuffer[i],d,e);var Q=j+s+h;var r=new RegExp("^"+Q);if(f&&r.test("@notify")){this._aAtMentionBuffer[i].endIndex=this._aAtMentionBuffer[i].endIndex+s.length;this._mCurrentAtMention=this._aAtMentionBuffer[i];this.showSuggestions([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}]);}else if(!Q.match(/ /g)||(Q.match(/ /g)&&Q.match(/ /g).length===1)){if((this._aAtMentionBuffer[i].atMentioned===true||this._aAtMentionBuffer[i].notifyAll===true)&&e<=this._aAtMentionBuffer[i].endIndex){var k=this._aAtMentionBuffer[i].startIndex;var l=d.slice(0,k)+" "+d.slice(k+1,d.length);this.setValue(l);this._sTextAreaCurrentValue=l;this._aAtMentionBuffer.splice(i,1);this.selectText(e+1,e+1);this.closeSuggestionPopover();}else if(Q.search("\n")===-1&&Q.search("@")===-1){this._aAtMentionBuffer[i].endIndex=this._aAtMentionBuffer[i].startIndex+Q.length;this._mCurrentAtMention=this._aAtMentionBuffer[i];var g=d[this._mCurrentAtMention.startIndex-1];if(g===" "||g===undefined||g==='\n'){this.fireSuggest({value:Q});}}else{this.closeSuggestionPopover();}}else{this.closeSuggestionPopover();}break;}this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[i],s.length);if(i===0){this.closeSuggestionPopover();}}}};c.prototype._handleDeletedCharacters=function(t,d){var i=t.changeIndex;var s=t.charactersChanged;var C=undefined;var A=this._oSuggestionUtil.isDeletedCharPartOfAtMentioned(this._aAtMentionBuffer,i);if(A!==undefined){if(this._aAtMentionBuffer[A].atMentioned===true||this._aAtMentionBuffer[A].notifyAll===true){this.closeSuggestionPopover();this._sTextAreaCurrentValue=this._sTextAreaCurrentValue.substr(0,this._aAtMentionBuffer[A].startIndex)+this._sTextAreaCurrentValue.substr(this._aAtMentionBuffer[A].endIndex-t.numberOfCharsChanged+1);this.setValue(this._sTextAreaCurrentValue);this.selectText(this._aAtMentionBuffer[A].startIndex,this._aAtMentionBuffer[A].startIndex);this._sTextAreaOldValue=this._sTextAreaCurrentValue;C=1+this._aAtMentionBuffer[A].endIndex-this._aAtMentionBuffer[A].startIndex;this._aAtMentionBuffer.splice(A,1);}else{C=t.numberOfCharsChanged;var e=d[this._aAtMentionBuffer[A].startIndex-1];if(s.search("@")!==-1&&d[t.changeIndex-1]!=="@"){this.closeSuggestionPopover();this._aAtMentionBuffer.splice(A,1);}else if(e===" "||e===undefined||e==='\n'){this._aAtMentionBuffer[A].endIndex-=C;var v=d.substring(this._aAtMentionBuffer[A].startIndex+1,this._aAtMentionBuffer[A].endIndex+1);var r=new RegExp("^"+v);if(v!==""&&r.test("@notify")){this.showSuggestions([{fullName:"@@notify",email:this._oLangBundle.getText("ST_ATATNOTIFY_DESCRIPTION"),userImage:"sap-icon://world"}]);}else{this.fireSuggest({value:v});}}}}A=A||0;C=C||t.numberOfCharsChanged;for(var j=A;j<this._aAtMentionBuffer.length;j++){if(i<this._aAtMentionBuffer[j].startIndex){this._oSuggestionUtil.maintainAtMentionIndices(this._aAtMentionBuffer[j],-C);}}};return c;},true);
