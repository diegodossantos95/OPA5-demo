/*
* ! SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2017 SAP SE. All rights reserved
*/
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/collaboration/components/utils/LanguageBundle','sap/collaboration/components/controls/PlaceholderUtility','sap/collaboration/components/utils/MediaTypeToSAPIcon'],function(q,C,L,P,M){"use strict";var F=C.extend("sap.collaboration.components.controls.FeedEntryEmbedded",{metadata:{interfaces:[],library:"sap.m",properties:{"feedEntry":{type:"object",group:"data"},"serviceUrl":{type:"string",group:"data"}},events:{"atMentionClick":{parameters:{link:{type:"object"}}},"expandCollapseClick":{},"previewLoad":{}},aggregations:{}}});F.prototype.init=function(){this.nMaxCollapsedLength=200;this.CONTENT_MAX_HEIGHT=128;this._oLangBundle=new L();this._oTimelineItemContent;q.sap.includeStyleSheet(q.sap.getModulePath("sap.collaboration.components.resources.css.EmbeddedControl",".css"));};F.prototype.onBeforeRendering=function(){};F.prototype.onAfterRendering=function(){this._$ExpandedTextDiv=q('#'+this.getId()+'-expanded-text');var e=this._$ExpandedTextDiv.html();if(e!=undefined){this._$ExpandedTextDiv.html(this._renderLinks(e));}if(this.oExpandLink&&this.oCollapseLink){this._$FeedEntryDiv=q('#'+this.getId());this._$CollapsedTextDiv=q('#'+this.getId()+'-collapsed-text');var c=this._$CollapsedTextDiv.html();if(c!=undefined){this._$CollapsedTextDiv.html(this._renderLinks(c));}q(this._$ExpandedTextDiv).detach();}if(this._oTimelineItemContent.getItems()[0]&&this._oTimelineItemContent.getItems()[0].getMetadata().getName()==='sap.m.Image'){var i=this._oTimelineItemContent.getItems()[0];i.getDomRef().addEventListener("load",function(){var m=this._oTimelineItemContent.getDomRef().clientWidth;var a=this.CONTENT_MAX_HEIGHT;var I=i.getDomRef().width;var b=i.getDomRef().height;var d=I/b;if(!(b<=a&&I<=m)){if(b>a){I=d*a;b=a;}if(I>m){b=m/d;I=m;}i.setWidth(I+"px");i.setHeight(b+"px");i.rerender();}this.firePreviewLoad();}.bind(this));}};F.prototype.exit=function(){this._destroyAtMentionLinks();if(this.oExpandLink){this.oExpandLink.destroy();}if(this.oCollapseLink){this.oCollapseLink.destroy();}if(this._oTimelineItemContent){this._oTimelineItemContent.destroy();}};F.prototype.setFeedEntry=function(f){this.setProperty("feedEntry",f);this._sText=f.Text;this._sTextWithPlaceholders=f.TextWithPlaceholders;this._destroyAtMentionLinks();this._mAtMentionsLinks={};var a=P.getAtMentionsValues(this._sText,this._sTextWithPlaceholders);for(var i=0;i<a.length;i++){this._mAtMentionsLinks[a[i].placeholder]=this._createAtMentionLink(a[i],f);}this._oTimelineItemContent=this._createTimelineItemContent();return this;};F.prototype.getCollapsedText=function(){this.oExpandLink;this.oCollapseLink;var t=0;var T=0;var i=0;var s="";var r=/@@.\{\d+\}/;var a=this._splitByPlaceholders(this._sTextWithPlaceholders);var b=P.getAtMentionsValues(this._sText,this._sTextWithPlaceholders);do{if(r.test(a[i])){if(b[T].placeholder===a[i]){t+=b[T].value.length;s+=b[T].placeholder;T++;}}else{t+=a[i].length;s+=a[i];}i++;}while(t<=this.nMaxCollapsedLength);s=s.substring(0,this.nMaxCollapsedLength);var n=s.lastIndexOf(" ");if(n>0){this._sCollapsedTextWithPlaceholders=s.substr(0,n);}else{this._sCollapsedTextWithPlaceholders=s;}};F.prototype.createExpandCollapseLink=function(l){var e=new sap.m.Link({id:this.getId()+"-"+l,text:this._oLangBundle.getText(l),press:[function(c){var s=c.getSource().getId();if(s.indexOf("-TE_MORE")>-1){q(this._$CollapsedTextDiv).detach();q(this._$ExpandedTextDiv).prependTo(this._$FeedEntryDiv);}else{q(this._$ExpandedTextDiv).detach();q(this._$CollapsedTextDiv).prependTo(this._$FeedEntryDiv);}this.fireExpandCollapseClick();},this]}).addStyleClass("alignMiddle");return e;};F.prototype._shouldTextBeRendered=function(){var f=this.getFeedEntry();if(f.Text==undefined||f.Text==""||f.ConsolidatedCount>1||((!q.isEmptyObject(f.TargetObjectReference))&&(f.TargetObjectReference.Type=="Task"||f.TargetObjectReference.Type=="ForumItem"||f.TargetObjectReference.Type=="Event"||f.TargetObjectReference.FullPath=="ContentItem/BlogEntry"||f.TargetObjectReference.FullPath=="ContentItem/Page"||f.TargetObjectReference.FullPath=="ContentItem/Poll"))){return false;}else{return true;}};F.prototype._shouldContentBeRendered=function(){return(this._oTimelineItemContent.getItems().length>0);};F.prototype._splitByPlaceholders=function(t){return P.splitByPlaceholders(t);};F.prototype._renderLinks=function(t){var r=/(^|[\s\n]|<br\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi;return t.replace(r,"$1<a href='$2' target='_blank'>$2</a>");};F.prototype._createAtMentionLink=function(p,f){var s=p.value.slice(1);var i=p.placeholder.replace(/[@a-z{}]/g,"");var m=new sap.ui.model.json.JSONModel({feedId:f.Id,placeholderIndex:i,placeholderValue:p.value});var l=new sap.m.Link({id:"at_mention_link-"+this.getId()+"-"+i,text:"{/placeholderValue}",press:[function(c){this.fireAtMentionClick({link:c.getSource()});},this]}).addStyleClass("sapCollaborationAtMentionLink");l.setModel(m);return l;};F.prototype._destroyAtMentionLinks=function(){if(this._mAtMentionsLinks){for(var p in this._mAtMentionsLinks){if(this._mAtMentionsLinks.hasOwnProperty(p)){this._mAtMentionsLinks[p].destroy();}}this._mAtMentionsLinks=undefined;}};F.prototype._createTimelineItemContent=function(){var t=new sap.m.VBox(this.getId()+"-content",{}).addStyleClass("sapUiTinyMarginTopBottom");var f=this.getFeedEntry();if((!q.isEmptyObject(f.TargetObjectReference)&&f.TargetObjectReference.Type!==undefined&&f.TargetObjectReference.Type!=="FeedEntry")||f.ConsolidatedCount>1){t.addItem(this._createFeedEntryContent(f));}return t;};F.prototype._createFeedEntryContent=function(f){var i="";var l="";var s="";if(f.ConsolidatedCount>1){i="sap-icon://documents";l=this._oLangBundle.getText("TE_CONSOLIDATED_FEED_TEXT");s=f.WebURL;}else{s=f.TargetObjectReference.WebURL;switch(f.TargetObjectReference.Type){case"ContentItem":if(f.TargetObjectReference.ContentType){if(f.TargetObjectReference.ContentType.indexOf('image')>-1){var p=new sap.m.Image(this.getId()+"-preview",{src:this.getServiceUrl()+"/FeedEntries('"+f.Id+"')/PreviewImage/$value",press:[function(c){window.open(s,'_blank');},this]});return p;}i=M.getSAPIconForMediaType(f.TargetObjectReference.ContentType);l=P.getContentItemName(f.Action,f.ActionWithPlaceholders);}else{switch(f.TargetObjectReference.FullPath){case"ContentItem/Poll":i="sap-icon://horizontal-bar-chart";break;case"ContentItem/Page":i="sap-icon://e-learning";break;case"ContentItem/BlogEntry":i="sap-icon://request";break;default:i="";break;}l=f.TargetObjectReference.Title;}break;case"ForumItem":i=this._getForumItemIconSrc(f.TargetObjectReference);l=f.TargetObjectReference.Title;break;case"Task":i="sap-icon://task";l=f.TargetObjectReference.Title;break;case"Event":i="sap-icon://calendar";l=f.TargetObjectReference.Title;break;default:i="sap-icon://action";l=f.TargetObjectReference.Title;break;}}var I="2.5em";var o=new sap.ui.core.Icon({src:i,size:I}).addStyleClass("sapUiTinyMarginBeginEnd");var a=new sap.m.Link({text:l,target:"_blank",href:s,tooltip:l,wrapping:true,width:"95%"}).addStyleClass("RightToLeftParenthesisStyling");var h=new sap.m.HBox({});h.addItem(o);var v=new sap.m.VBox({width:"100%"}).addStyleClass("sapUiTinyMarginBeginEnd");v.addItem(a);h.addItem(v);return h;};F.prototype._getForumItemIconSrc=function(f){var s=f.FullPath;switch(s){case"ForumItem/Inquiry":case"ForumItem/Question":return"sap-icon://question-mark";case"ForumItem/Idea":return"sap-icon://lightbulb";case"ForumItem/Discussion":return"sap-icon://discussion";default:return"";}};return F;},true);
