/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler");jQuery.sap.require("sap.collaboration.components.utils.OdataUtil");sap.ui.base.Object.extend("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler",{constructor:function(c){this._oLogger=jQuery.sap.log.getLogger("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler");this._oOdataUtil=new sap.collaboration.components.utils.OdataUtil();this._oCollabModel=c;this._oExternalBObuffer={};},_requestsData:{getGroups:{url:function(e){return"/ExternalObjects('"+jQuery.sap.encodeURL(e)+"')/Groups";},urlParameters:function(){return{};},successLog:function(d,r){return"Groups were successfully retrieved.";},errorLog:function(e){this._oLogger.error("Failed to retrieve groups: "+e.response.statusText);}},getExternalObjectByExidAndObjectType:{url:function(e,o,n){return n?n:"/ExternalObjects_FindByExidAndObjectType";},urlParameters:function(e,o){return{"Exid":"'"+e.replace(/'/g,"''")+"'","ObjectType":"'"+o.replace(/'/g,"''")+"'","$expand":"FeedEntries/Creator"};},successLog:function(d,r){return"External object found: "+d.results.Name;},errorLog:function(e){this._oLogger.error(e.response.statusText);}},getFeedEntries:{url:function(e,n){return n?n:"/ExternalObjects"+"('"+jQuery.sap.encodeURL(e)+"')/FeedEntries";},urlParameters:function(){return{"$expand":"Creator/MemberProfile"};},successLog:function(d,r){return"Feed entries were successfully retrieved.";},errorLog:function(e){this._oLogger.error("Failed to retrieve feed entries: "+e.response.statusText);}},getSuggestions:{url:function(){return"/Members_Autocomplete";},urlParameters:function(v,g){var u={"Query":"'"+v+"'","$top":"4"};if(g){u.GroupId="'"+g+"'";}return u;},successLog:function(d,r){return"";},errorLog:function(e){this._oLogger.error("");}},getAtMentions:{url:function(f){return"/FeedEntries('"+jQuery.sap.encodeURL(f)+"')/AtMentions";},urlParameters:function(){return{};},successLog:function(d,r){return"@mentions were successfully retrieved.";},errorLog:function(e){this._oLogger.error("Failed to retrieve the @mentions: "+e.response.statusText,e.stack);}},getReplies:{url:function(f,n){return n?n:"/FeedEntries('"+jQuery.sap.encodeURL(f)+"')/Replies";},urlParameters:function(){return{'$orderby':'CreatedAt desc','$expand':'Creator'};},successLog:function(d,r){return"Replies were successfully retrieved.";},errorLog:function(e){if(e.response){this._oLogger.error("Failed to retrieve replies: "+e.response.statusText,e.stack);}}}},_doAllTheThings:function(r,u){var t=this;var a=this._requestsData[r];var b=Array.prototype.slice.apply(arguments);b.shift();b.shift();var d=new jQuery.Deferred();var s=function(D,f){t._oLogger.info(a.successLog.apply(t,[D,f]));d.resolve(D,f);};var e=function(E){a.errorLog.apply(t,[E]);d.reject(E);};var c=a.urlParameters.apply(t,b);if(Object.prototype.toString.apply(u)==="[object Object]"){for(var U in u){c[U]=u[U];}}var p={context:null,urlParameters:c,async:true,filters:[],sorters:[],success:s,error:e};return{request:this._oCollabModel.read(a.url.apply(t,b),p),promise:d.promise()};},getGroups:function(e,n,u){return this._doAllTheThings("getGroups",u,e,n);},getExternalObjectByExidAndObjectType:function(e,n){var b=e.ObjectType+e.Exid;this._oExternalBObuffer[b]=e;return this._doAllTheThings("getExternalObjectByExidAndObjectType",null,e.Exid,e.ObjectType,n);},getFeedEntries:function(e,n){return this._doAllTheThings("getFeedEntries",null,e,n);},getSuggestions:function(v,g){return this._doAllTheThings("getSuggestions",null,v,g);},getAtMentions:function(f){return this._doAllTheThings("getAtMentions",null,f);},getReplies:function(f,n){return this._doAllTheThings("getReplies",null,f,n);},getExternalObject:function(e){var t=this;var b=e.ObjectType+e.Exid;var p=jQuery.Deferred();if(!this._oExternalBObuffer[b]){var c=this.postExternalObject(e);c.promise.done(function(d,r){var E=d.results;t._oExternalBObuffer[b]=E;p.resolve(E);});c.promise.fail(function(E){p.reject(E);});}else{p.resolve(this._oExternalBObuffer[b]);}return p.promise();},getFeedEntryFromActivity:function(a){var t=this;var e="/Activities('"+jQuery.sap.encodeURL(a)+"')/FeedEntry";var p=jQuery.Deferred();var s=function(d,r){p.resolve(d,r);};var E=function(o){t._oLogger.error("Failed to get the feed entry: "+o.response.statusText);p.reject(o);};var P={urlParameters:{$expand:"Creator"},async:true,success:s,error:E};this._oCollabModel.read(e,P);return p.promise();},getUserInfoBatch:function(u){var t=this;var b=[];u.forEach(function(U){var E="/Members_Autocomplete?Query='"+jQuery.sap.encodeURL(U)+"'&$expand=MemberProfile";var m="GET";var d=null;var P=null;b.push(t._oCollabModel.createBatchOperation(E,m,d,P));});this._oCollabModel.addBatchReadOperations(b);var a=true;var i=true;var p=jQuery.Deferred();var s=function(d,r){var R=t._oOdataUtil.parseBatchResponse(d.__batchResponses);p.resolve(R,r);};var e=function(E){if(E.response.statusCode===403&&i){t._oCollabModel.refreshSecurityToken(function(){i=false;t._oCollabModel.addBatchReadOperations(b);t._oCollabModel.submitBatch(s,e,a);},function(r){t._oLogger.error("Failed to get member information: "+r.response.statusText);p.reject(r);},true);}else{t._oLogger.error("Failed to get member information: "+E.response.statusText);p.reject(E);}};return{request:this._oCollabModel.submitBatch(s,e,a),promise:p.promise()};},getAtMentionsBatch:function(f){var t=this;var m=10;var b=[];f.forEach(function(F,c){if(c<m){var E="/FeedEntries('"+jQuery.sap.encodeURL(F)+"')/AtMentions";var M="GET";var d=null;var P=null;b.push(t._oCollabModel.createBatchOperation(E,M,d,P));}});this._oCollabModel.addBatchReadOperations(b);var a=true;var i=true;var p=new jQuery.Deferred();var s=function(d,r){var R=t._oOdataUtil.parseBatchResponse(d.__batchResponses);p.resolve(R,r);};var e=function(E){if(E.response.statusCode===403&&i){t._oCollabModel.refreshSecurityToken(function(){i=false;t._oCollabModel.addBatchReadOperations(b);t._oCollabModel.submitBatch(s,e,a);},function(r){t._oLogger.error("Failed to get the feeds @mentions: "+r.response.statusText);p.reject(r);},true);}else{t._oLogger.error("Failed to get the feeds @mentions: "+E.response.statusText);p.reject(E);}};return{request:this._oCollabModel.submitBatch(s,e,a),promise:p};},getSender:function(){var t=this;var e="/Self";var p=jQuery.Deferred();var s=function(d,r){t._oLogger.info("The reply was successfully posted.");p.resolve(d.results);};var E=function(o){t._oLogger.error("Failed to retrieve the sender: "+o.response.statusText,o.stack);p.reject(o);};var P={urlParameters:null,async:true,success:s,error:E};return{request:this._oCollabModel.read(e,P),promise:p.promise()};},getGroupFeedEntries:function(g,n){var t=this;var e="";if(n){e=n;}else{e="/Groups('"+jQuery.sap.encodeURL(g)+"')/FeedEntries";}var p=jQuery.Deferred();var s=function(d,r){t._oLogger.info("The feed entries for the group '"+g+"' were retrieved.");p.resolve(d,r);};var E=function(o){t._oLogger.error("Failed to get feed entries for the group '"+g+"'.");p.reject(o);};var P={context:null,urlParameters:{$expand:"Group,Creator,TargetObjectReference"},async:true,success:s,error:E};return{request:this._oCollabModel.read(e,P),promise:p.promise()};},getGroupExternalObjectFeedEntries:function(g,e,n){var t=this;var E="";var p=jQuery.Deferred();if(n){E=n;}else{E="/GroupExternalObjects(GroupId='"+jQuery.sap.encodeURL(g)+"',ExternalObjectId='"+jQuery.sap.encodeURL(e)+"')/FeedEntries";}var s=function(d,r){t._oLogger.info("The feed entries for the group object wall was retrieved. Group Id is:'"+g+"', External Object Id is:"+e+".");p.resolve(d,r);};var f=function(o){t._oLogger.error("Failed to get feed entries for the group object wall. Group Id is:'"+g+"', External Object Id is:"+e+".");p.reject(o);};var P={context:null,urlParameters:{$expand:"Group,Creator,TargetObjectReference"},async:true,success:s,error:f};return{request:this._oCollabModel.read(E,P),promise:p.promise()};},addPostToExternalObject:function(c,e){var t=this;var p=this.postFeedEntryToObject(e,c).promise.then(function(d,r){var a=d.results;return t.getFeedEntryFromActivity(a.Id);}).then(function(d,r){var f=d.results;return f;}).fail(function(E){return E;});return p.promise();},postExternalObject:function(e){var t=this;var E="/ExternalObjects";var d=e;var p=jQuery.Deferred();var a=function(D,r){t._oLogger.info("External object created. "+D.results.Name);p.resolve(D,r);};var b=function(o){t._oLogger.error("Failed to create external object: "+o.response.statusText);p.reject(o);};var P={context:null,urlParameters:null,async:true,success:a,error:b};return{request:this._oCollabModel.create(E,d,P),promise:p.promise()};},postFeedEntryToObject:function(e,c){var t=this;var E="/Activities";var o={};o.__metadata=e.__metadata;var d={"Content":c,"Object":o,"Verb":"comment"};var i=true;var p=jQuery.Deferred();var s=function(D,r){p.resolve(D,r);};var f=function(a){if(a.response.statusCode===403&&i){t._oCollabModel.refreshSecurityToken(function(){i=false;t._oCollabModel.create(E,d,P);},function(r){t._oLogger.error("Failed to get the activity: "+r.response.statusText);p.reject(r);},true);}else{t._oLogger.error("Failed to get the activity: "+a.response.statusText);p.reject(a);}};var P={context:null,urlParameters:null,async:true,success:s,error:f};return{request:this._oCollabModel.create(E,d,P),promise:p.promise()};},postReply:function(f,r){var t=this;var e="/FeedEntries('"+jQuery.sap.encodeURL(f)+"')/Replies";var d={"Text":r};var i=true;var p=jQuery.Deferred();var s=function(D,a){t._oLogger.info("The reply was successfully posted.");p.resolve(D);};var E=function(o){if(o.response.statusCode===403&&i){t._oCollabModel.refreshSecurityToken(function(){i=false;t._oCollabModel.create(e,d,P);},function(R){t._oLogger.error("Failed to post reply: "+R.response.statusText,R.stack);p.reject(R);},true);}else{t._oLogger.error("Failed to post reply: "+o.response.statusText,o.stack);p.reject(o);}};var P={context:null,urlParameters:null,async:true,success:s,error:E};return{request:this._oCollabModel.create(e,d,P),promise:p.promise()};},postGroupFeedEntry:function(g,t){var a=this;var e="/Groups('"+jQuery.sap.encodeURL(g)+"')/FeedEntries";var d={"Text":t};var p=jQuery.Deferred();var s=function(D,r){a._oLogger.info("Feed entry was successfully posted to Group '"+g+"'.");p.resolve(D,r);};var E=function(o){a._oLogger.error("Failed to post feed entry to group '"+g+"'.");p.reject(o);};var P={context:null,urlParameters:null,async:true,success:s,error:E};return{request:this._oCollabModel.create(e,d,P),promise:p.promise()};},postGroupExternalObjectFeedEntry:function(g,e,t){var a=this;var E="/GroupExternalObjects(GroupId='"+jQuery.sap.encodeURL(g)+"',ExternalObjectId='"+jQuery.sap.encodeURL(e)+"')/FeedEntries";var d={"Text":t};var p=jQuery.Deferred();var s=function(D,r){a._oLogger.info("Feed entry was successfully posted to group object wall. Group Id is:'"+g+"', External Object Id is:"+e+".");p.resolve(D,r);};var f=function(o){a._oLogger.error("Failed to post feed entry to group object wall. Group Id is:'"+g+"', External Object Id is:"+e+".");p.reject(o);};var P={context:null,urlParameters:null,async:true,success:s,error:f};return{request:this._oCollabModel.create(E,d,P),promise:p.promise()};},getFeedUpdatesLatestCount:function(L,E){var g=jQuery.Deferred();var p="/ExternalObject_FeedLatestCount";var P={"urlParameters":{LatestTopLevelId:"'"+L+"'",Id:"'"+E+"'"},"success":function(d,r){g.resolve(d,r);},"error":function(e){g.reject(e);}};return g.promise(this._oCollabModel.read(p,P));}});
