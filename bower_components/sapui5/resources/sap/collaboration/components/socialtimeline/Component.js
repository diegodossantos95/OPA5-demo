/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.ui.core.UIComponent");jQuery.sap.require("sap.suite.ui.commons.Timeline");jQuery.sap.require("sap.suite.ui.commons.TimelineItem");jQuery.sap.require("sap.collaboration.components.socialtimeline.validation.InputValidator");jQuery.sap.require("sap.collaboration.components.socialtimeline.controls.TimelineItemEmbedded");jQuery.sap.require("sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler");jQuery.sap.require("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler");jQuery.sap.require("sap.collaboration.components.socialtimeline.datahandlers.ServiceDataHandler");jQuery.sap.require("sap.collaboration.components.socialtimeline.datahandlers.SMIntegrationDataHandler");jQuery.sap.require("sap.collaboration.components.socialtimeline.annotations.TimelineTermsUtility");jQuery.sap.require("sap.collaboration.components.socialtimeline.filter.FilterType");jQuery.sap.require("sap.collaboration.components.controls.ReplyPopover");jQuery.sap.require("sap.collaboration.components.controls.SocialTextArea");jQuery.sap.require("sap.collaboration.components.controls.FilterPopover");jQuery.sap.require("sap.collaboration.components.utils.CommonUtil");jQuery.sap.require("sap.collaboration.components.utils.DateUtil");jQuery.sap.declare("sap.collaboration.components.socialtimeline.Component");sap.ui.core.UIComponent.extend("sap.collaboration.components.socialtimeline.Component",{metadata:{version:"1.0",includes:["../resources/css/SocialTimeline.css"],dependencies:{libs:["sap.collaboration"],components:[],ui5version:""},config:{},customizing:{},rootView:null,publicMethods:["setBusinessObject","setBusinessObjectKey","setBusinessObjectMap","updateTimelineEntry","deleteTimelineEntry"],aggregations:{},properties:{"enableSocial":{type:"boolean",group:"Social",defaultValue:true},"alignment":{type:"sap.suite.ui.commons.TimelineAlignment",group:"Misc",defaultValue:sap.suite.ui.commons.TimelineAlignment.Right},"axisOrientation":{type:"sap.suite.ui.commons.TimelineAxisOrientation",group:"Misc",defaultValue:sap.suite.ui.commons.TimelineAxisOrientation.Vertical},"noDataText":{type:"string",group:"Misc",defaultValue:null},"showIcons":{type:"boolean",group:"Misc",defaultValue:true},"visible":{type:"boolean",group:"Appearance",defaultValue:true},"width":{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:'100%'},"customFilter":{type:"object[]",group:"Social"}},events:{"customActionPress":{}}},_defaultAttributes:{collaborationHostServiceUrl:"/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData",smiServiceUrl:"/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV",pageSize:10,jamOnly:false},init:function(){this._oLogger=jQuery.sap.log.getLogger("sap.collaboration.components.socialtimeline.Component");this._oCollaborationHostModel;this._oSMIntegrationModel;this._oTimeline;this._oTimelineModelData={enableSocial:true,alignment:sap.suite.ui.commons.TimelineAlignment.Right,axisOrientation:sap.suite.ui.commons.TimelineAxisOrientation.Vertical,enableBackendFilter:true,enableScroll:true,forceGrowing:true,noDataText:null,showIcons:true,sort:true,visible:true,width:'100%',timelineData:[],suggestions:[]};this._oTimelineModel=new sap.ui.model.json.JSONModel(this._oTimelineModelData);this._oTimelineModel.setSizeLimit(10000);this._oTimelineModel.bindProperty("/enableSocial").attachChange(this._onEnableSocialChange,this);this._iGrowingThreshold=this._defaultAttributes.pageSize;this._oFilterIcon;this._oContextSelect;this._oAddPostButton;this._oBusinessObjectMap={};this._oBusinessObject={};this._oCommonUtil=new sap.collaboration.components.utils.CommonUtil();this._oDateUtil=new sap.collaboration.components.utils.DateUtil();this._oLanguageBundle=this._oCommonUtil.getLanguageBundle();this._oTimelineDataHandler;this._oJamDataHandler;this._oSMIntegrationDataHandler;this._oFilterPopover;this._oFilterConstants=new sap.collaboration.components.socialtimeline.filter.FilterType();this._oFilter={};this._oRepliesData;this._oReplyPopover;this._oAddPostPopover;this._oSocialProfile;this._oTimelineUser={};this._oInputValidator;this._oGettingTimelineData;this._initialize();this._oInputValidator=new sap.collaboration.components.socialtimeline.validation.InputValidator(this);sap.ui.core.UIComponent.prototype.init.apply(this);},exit:function(){if(this._oTimeline){this._oTimeline.destroy();}if(this._oAddPostPopover){this._oAddPostPopover.destroy();}if(this._oReplyPopover){this._oReplyPopover.destroy();}if(this._oFilterPopover){this._oFilterPopover.destroy();}if(this._oSocialProfile){this._oSocialProfile.destroy();}if(this._oInputValidator){this._oInputValidator.destroy();}if(this._oFilterIcon){this._oFilterIcon.destroy();}if(this._oContextSelect){this._oContextSelect.destroy();}if(this._oAddPostButton){this._oAddPostButton.destroy();}},onBeforeRendering:function(){if(this._oInputValidator.areSocialFeaturesEnabled()===true){if(!this._oBusinessObject.key||this._oBusinessObject.key===""){this._oTimeline._filterIcon.setEnabled(false);this._oContextSelect.setEnabled(false);}}else{if(!this._oBusinessObject.key||this._oBusinessObject.key===""){this._oTimeline._filterIcon.setEnabled(false);}this._oContextSelect.setVisible(false);this._oAddPostButton.setVisible(false);}this._getLoggedInUser();this._bindTemplates();},onAfterRendering:function(){},createContent:function(){return this._createTimeline();},setProperty:function(p,a){sap.ui.core.UIComponent.prototype.setProperty.call(this,p,a);this._oLogger.info(p+": "+a);switch(p){case'enableSocial':var e=a;if(e===true){e=this._oInputValidator.validateEnableSocial();}this._oTimelineModel.setProperty("/"+p,e);break;case'customFilter':var c=a;this._oInputValidator.validateCustomFilter();if(c&&c.length!==0){this._oTimeline.setCustomFilter(this._getFilter());this._oTimeline._filterIcon.setEnabled(true);}else{this._oTimeline._filterIcon.setEnabled(false);}break;default:this._oTimelineModel.setProperty("/"+p,a);break;}},setSettings:function(s){for(var k in s){if(s.hasOwnProperty(k)){this.setProperty(k,s[k]);}}},setBusinessObjectMap:function(b){this._oLogger.info("servicePath: "+b.servicePath);this._oLogger.info("collection: "+b.collection);this._oLogger.info("applicationContext: "+b.applicationContext);this._oBusinessObjectMap=b;this._validateBusinessObjectMap();this._defaultAttributes.jamOnly=jQuery.isEmptyObject(this._oBusinessObjectMap.serviceModel);var t;var s;if(this._defaultAttributes.jamOnly){this._oFilter={type:this._oFilterConstants.FILTER_TYPE.feedUpdates};this._oContextSelect.setVisible(false);this._oTimeline._filterIcon.setVisible(false);}else{this._oContextSelect.setVisible(true);this._oTimeline._filterIcon.setVisible(true);t=this._oInputValidator.createTermsUtilityForBackend(this._oBusinessObjectMap.serviceModel);s=new sap.collaboration.components.socialtimeline.datahandlers.ServiceDataHandler(this._oBusinessObjectMap.serviceModel,t);}this._oTimelineDataHandler=new sap.collaboration.components.socialtimeline.datahandlers.TimelineDataHandler(this._oBusinessObjectMap,this._oJamDataHandler,this._oSMIntegrationDataHandler,s,t,this._iGrowingThreshold,this._oInputValidator.areSocialFeaturesEnabled(),this._oInputValidator.areBackendFeaturesEnabled());},setBusinessObjectKey:function(k){this._oLogger.info("Business Object Key: "+k);if(!this._oTimelineDataHandler){this._oLogger.error("Function setBusinessObjectMap must be called before calling setBusinessObjectKey for the first time.");}this._oTimeline._filterIcon.setEnabled(true);this._oAddPostButton.setEnabled(false);this._oContextSelect.setEnabled(true);this._oBusinessObject={key:k,name:k};this._oTimelineDataHandler.setBusinessObject(this._oBusinessObject);if(!this._defaultAttributes.jamOnly){this._resetFilterAndContextSelector();}this._refreshTimelineModel();},setBusinessObject:function(o){this._oBusinessObject=o;this._oLogger.info("Business Object Key: "+this._oBusinessObject.key);this._oLogger.info("Business Object Name: "+this._oBusinessObject.name);if(!this._oTimelineDataHandler){this._oLogger.error("Function setBusinessObjectMap must be called before calling setBusinessObject for the first time.");}this._validateBusinessObject();if(this._defaultAttributes.jamOnly){this._oAddPostButton.setEnabled(true);}else{this._oTimeline._filterIcon.setEnabled(true);this._oAddPostButton.setEnabled(false);this._oContextSelect.setEnabled(true);this._oTimelineDataHandler.setBusinessObject(this._oBusinessObject);}if(!this._defaultAttributes.jamOnly){this._resetFilterAndContextSelector();}this._refreshTimelineModel();},updateTimelineEntry:function(t,I){var T=sap.ui.getCore().byId(I);var e=T.getAggregation('embeddedControl');var f=e._oFlexbox.getItems();f[0].setText(t);if(f.length>1){for(var i=1;i<f.length;i++){f[i].destroy();}}var o=T.getModel();var a=this._oTimeline.getContent().indexOf(T);o.getData().timelineData[a].timelineItemData.text=t;o.getData().timelineData[a].timelineItemData.timelineEntryDetails=[];},deleteTimelineEntry:function(i){var t=sap.ui.getCore().byId(i);var T=t.getModel();var a=this._oTimeline.getContent().indexOf(t);T.getData().timelineData.splice(a,1);t.destroy();},_initialize:function(){var a=true;if(!this._oCollaborationHostModel){this._oCollaborationHostModel=new sap.ui.model.odata.ODataModel(this._defaultAttributes.collaborationHostServiceUrl,a);}if(!this._oSMIntegrationModel){this._oSMIntegrationModel=new sap.ui.model.odata.ODataModel(this._defaultAttributes.smiServiceUrl,a);}if(!this._oJamDataHandler){this._oJamDataHandler=new sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler(this._oCollaborationHostModel);}if(!this._oSMIntegrationDataHandler){this._oSMIntegrationDataHandler=new sap.collaboration.components.socialtimeline.datahandlers.SMIntegrationDataHandler(this._oSMIntegrationModel);}},_createTimeline:function(){this._oTimeline=new sap.suite.ui.commons.Timeline(this.getId()+"_timeline",{enableSocial:"{/enableSocial}",alignment:"{/alignment}",axisOrientation:"{/axisOrientation}",enableBackendFilter:"{/enableBackendFilter}",enableScroll:"{/enableScroll}",forceGrowing:"{/forceGrowing}",noDataText:"{/noDataText}",showIcons:"{/showIcons}",visible:"{/visible}",width:"{/width}",sort:"{/sort}",data:[],grow:this._onGrow.bind(this),});this._modifyHeaderBar();this._oTimeline.setModel(this._oTimelineModel);return this._oTimeline;},_modifyHeaderBar:function(){var h=this._oTimeline.getHeaderBar();var c=h.getContent();this._oFilterIcon=c[c.length-1];this._oContextSelect=this._createContextSelector();h.insertContent(this._oContextSelect,0);this._oAddPostButton=this._createAddPostButton();h.insertContent(this._oAddPostButton,3);},_createContextSelector:function(){var o=function(e){var c=sap.ui.getCore().byId(this.getId()+"_context_select");var C=sap.ui.getCore().byId(this.getId()+"_context_select_popover");if(C==undefined){var t=[];t.push({context_type:this._oFilterConstants.FILTER_TYPE.systemUpdates,context_text:this._oLanguageBundle.getText("ST_CONTEXT_SYSTEM_UPDATES")});t.push({context_type:this._oFilterConstants.FILTER_TYPE.feedUpdates,context_text:this._oLanguageBundle.getText("ST_CONTEXT_DISCUSSION_POSTS")});var T=new sap.ui.model.json.JSONModel(t);this.setModel(T,"timeline_context");var a=new sap.ui.core.Item({key:"{context_type}",text:"{context_text}"});var b=new sap.m.SelectList(this.getId()+"_context_select_list",{selectedKey:this._oFilterConstants.FILTER_TYPE.systemUpdates,selectionChange:[this._onContextSelect,this],width:"15rem"});b.bindAggregation("items",{path:"/",template:a});b.setModel(T);C=new sap.m.Popover(this.getId()+"_context_select_popover",{placement:sap.m.PlacementType.VerticalPreferedBottom,title:this._oLanguageBundle.getText("ST_CONTEXT_SELECT_HEADER")});C.addContent(b);}C.getContent()[0].setSelectedKey(this._oFilter.type);C.openBy(c);};var c=new sap.m.Button(this.getId()+"_context_select",{icon:"sap-icon://navigation-down-arrow",iconFirst:false,text:this._oLanguageBundle.getText("ST_CONTEXT_SYSTEM_UPDATES"),type:sap.m.ButtonType.Transparent,press:[o,this]});return c;},_createAddPostButton:function(){if(this._oAddPostPopover===undefined){this._oAddPostPopover=new sap.m.ResponsivePopover(this.createId("_addPostPopover"),{placement:sap.m.PlacementType.Auto,title:this._oLanguageBundle.getText("ST_ADD_POST_TITLE"),contentWidth:"25rem",contentHeight:"10rem",content:new sap.collaboration.components.controls.SocialTextArea(this.createId("social_TextArea"),{height:"10rem",width:"100%",enableNotifyAll:false,liveChange:[function(e){e.getParameter("value").trim()!==""?this.byId("addPost_postButton").setEnabled(true):this.byId("addPost_postButton").setEnabled(false);},this],suggest:[this._onSuggest,this],afterSuggestionClose:[function(){if(this.gettingSuggestions){this.gettingSuggestions.request.abort();}},this]}),endButton:new sap.m.Button(this.createId("addPost_postButton"),{text:this._oLanguageBundle.getText("ST_ADD_POST_BUTTON"),enabled:false,press:[this._onAddPost,this],}),beginButton:new sap.m.Button(this.createId("addPost_atMentionButton"),{text:"@",press:[function(){this.byId("social_TextArea").atMentionsButtonPressed();},this]})}).setInitialFocus(this.byId("social_TextArea"));}var a=new sap.m.Button(this.createId("_addPostButton"),{icon:"sap-icon://add",type:sap.m.ButtonType.Transparent,enabled:false,press:[function(){this._oAddPostPopover.openBy(this.byId("_addPostButton"));},this]});return a;},_refreshTimelineModel:function(){var t=this;this._oTimeline.setBusyIndicatorDelay(0).setBusy(true);this._oGettingTimelineData=this._oTimelineDataHandler.getTimelineData(this._oFilter,this._defaultAttributes.jamOnly?this._oBusinessObject:null).then(function(T){t._oTimeline.setBusy(false);t._oFilter.text===undefined||t._oFilter.text===t._oLanguageBundle.getText("ST_FILTER_ALL")?t._oTimeline.setCustomMessage(""):t._oTimeline.setCustomMessage(t._oLanguageBundle.getText("ST_FILTER_TEXT")+" "+t._oFilter.text);t._oTimeline.destroyContent();t._oTimelineModelData.timelineData=T;t._oTimelineModel.setData(t._oTimelineModelData);t._setReplies();},function(e){t._oCommonUtil.displayError();t._oTimeline.setBusy(false);});},_bindTemplates:function(){if(this._oTimeline.getBinding("content").getPath()!=="/timelineData"){var c=new sap.ui.core.CustomData({key:"{key}",value:"{value}"});var t=new sap.suite.ui.commons.TimelineItem({dateTime:"{timelineItemData/dateTime}",userName:"{timelineItemData/userName}",title:"{timelineItemData/title}",icon:"{timelineItemData/icon}",filterValue:"{timelineItemData/filterValue}",userNameClickable:"{/enableSocial}",userNameClicked:this._onUserNameClicked,userPicture:"{timelineItemData/userPicture}",embeddedControl:this._createEmbeddedControl(),customAction:{template:c,path:"timelineItemData/customActionData"},customActionClicked:this._onCustomActionClicked.bind(this),replyCount:"{timelineItemData/replyCount}",replyListOpen:this._onReplyListOpen.bind(this)});this._oTimeline.bindAggregation("content",{path:"/timelineData",template:t});}},_createEmbeddedControl:function(t){var T=(t===undefined)?"{}":t;var e=new sap.collaboration.components.socialtimeline.controls.TimelineItemEmbedded({timelineItem:T,expandCollapseClick:[function(){this._oTimeline.adjustUI();},this],atMentionClick:[this._getAtMentionClicked,this]});return e;},_getFilter:function(){var c=this.getCustomFilter();var C=c.length;for(var i=0;i<C;i++){c[i].type=this._oFilterConstants.FILTER_TYPE.custom;}var f=[{text:this._oLanguageBundle.getText("ST_FILTER_ALL"),type:this._oFilterConstants.FILTER_TYPE.systemUpdates}].concat(c);if(!this._oFilterPopover){var j=new sap.ui.model.json.JSONModel({filter:f});var s=new sap.m.StandardListItem({title:"{text}"});this._oFilterPopover=new sap.collaboration.components.controls.FilterPopover(this.getId()+"_filterPopover",{title:this._oLanguageBundle.getText("ST_FILTER_HEADER"),selectionChange:[function(o){this._oFilter=o.getParameter("listItem").getBindingContext().getObject();this._oTimelineDataHandler.reset();this._refreshTimelineModel();},this]}).setModel(j).bindItems("/filter",s);this._oFilterPopover.setSelectedItem(this._oFilterPopover.getItems()[0]);}else{this._oFilterPopover.getModel().setProperty("/filter",f);}return this._oFilterPopover;},_resetFilterAndContextSelector:function(){this._resetFilter();this._oContextSelect.setText(this._oLanguageBundle.getText("ST_CONTEXT_SYSTEM_UPDATES"));},_resetFilter:function(){this._oTimelineModel.setProperty("/sort",true);this._oFilter={type:this._oFilterConstants.FILTER_TYPE.systemUpdates};if(this._oFilterPopover){this._oFilterPopover.setSelectedItem(this._oFilterPopover.getItems()[0]);}},_setReplies:function(){var t=this;var T=this._oTimeline.getContent();T.forEach(function(o){var a=o.getBindingContext().getObject();if(!a._feedEntryData){t._hideReply(o);}else{o.setCustomReply(t._createReplyPopover());}});},_hideReply:function(t){t._replyLink.setVisible(false);},_showSocialProfile:function(s,l,e){if(s){var S=s.getParent().getParent().getParent();if(!S._oSocialProfile){S._oSocialProfile=sap.ui.getCore().createComponent({name:"sap.collaboration.components.socialprofile",id:this.getId()+"_socialProfile"});S._oSocialProfile._defaultAttributes=S._defaultAttributes;}var o={openingControl:l,memberId:e};S._oSocialProfile.setSettings(o);S._oSocialProfile.open();}},_getFeedId:function(t){var p=t.getBindingContext().getPath();var P=p.split("/");var s=P[P.length-1];var f=t.getModel().getData().timelineData[s]._feedEntryData.Id;return f;},_getLoggedInUser:function(){var t=this;var g=this._oJamDataHandler.getSender();g.promise.done(function(j,r){t._oTimelineUser=j;});g.promise.fail(function(e){t._oLogger.error('Failed to get the sender',e.stack);});},_addTimelineItemToTimeline:function(t){var m=this._oTimeline.getModel().getData();m.timelineData.push(t);var T=new sap.suite.ui.commons.TimelineItem({dateTime:t.timelineItemData.dateTime,userName:t.timelineItemData.userName,title:t.timelineItemData.title,text:t.timelineItemData.text,icon:t.timelineItemData.icon,userNameClickable:true,userNameClicked:this._onUserNameClicked,userPicture:t.timelineItemData.userPicture,embeddedControl:this._createEmbeddedControl(t),replyCount:t.timelineItemData.replyCount,replyListOpen:this._onReplyListOpen.bind(this),customReply:this._createReplyPopover(),});this._oTimeline.insertContent(T,0);var f=m.timelineData.indexOf(t);var c=T.getParent().getModel().createBindingContext("/timelineData/"+f);T.setBindingContext(c);},_validateInputParameters:function(){this._oInputValidator=new sap.collaboration.components.socialtimeline.validation.InputValidator(this);if(!this._oInputValidator.areCustomFiltersValid()){this.destroy();}return this._oInputValidator;},_validateBusinessObjectMap:function(){if(!this._oInputValidator){this._validateInputParameters();}if(!this._oInputValidator.isBusinessObjectMapValid(this._oBusinessObjectMap)){this.destroy();}},_validateBusinessObject:function(){if(!this._oInputValidator){this._validateInputParameters();}if(!this._oInputValidator.isBusinessObjectValid(this._oBusinessObject)){this.destroy();}},_onContextSelect:function(e){var s=e.getParameter("selectedItem");this._oFilter={type:s.getKey()};if(s.getKey()==this._oFilterConstants.FILTER_TYPE.feedUpdates){this._oTimelineModel.setProperty("/sort",false);this._oFilterIcon.setEnabled(false);this._oAddPostButton.setEnabled(true);}else{if(!this._defaultAttributes.jamOnly){this._resetFilter();}this._oFilterIcon.setEnabled(true);this._oAddPostButton.setEnabled(false);}this._oTimelineDataHandler.reset();this._refreshTimelineModel();var c=sap.ui.getCore().byId(this.getId()+"_context_select_popover");c.close();this._oContextSelect.setText(s.getText());},_onGrow:function(){var t=this;if(!this._oGettingTimelineData||this._oGettingTimelineData.state()!="pending"){this._oGettingTimelineData=this._oTimelineDataHandler.getTimelineData(this._oFilter).then(function(T){var d=t._oTimelineModel.getData();d.timelineData=d.timelineData.concat(T);t._oTimelineModel.setData(d);t._setReplies();},function(e){t._oCommonUtil.displayError();});}else{this._oLogger.info("A previous request is still pending.");}},_onUserNameClicked:function(c){var s=c.getSource().getParent().getParent();var t=c.getSource().getParent();var T=c.getSource();if(!s._oSocialProfile){s._oSocialProfile=sap.ui.getCore().createComponent({name:"sap.collaboration.components.socialprofile",id:this.getId()+"_socialProfile"});s._oSocialProfile._defaultAttributes=s._defaultAttributes;}var i=t.getContent().indexOf(T);var S={openingControl:T._userNameLink,memberId:t.getModel().getData().timelineData[i].timelineItemData.userEmail};s._oSocialProfile.setSettings(S);s._oSocialProfile.open();},_onAddPost:function(c){var t=this;var C=this.byId("social_TextArea").convertTextWithFullNamesToEmailAliases();this.byId("_addPostPopover").close();if(C&&C.trim()!==""){this._oTimeline.setBusyIndicatorDelay(0).setBusy(true);this._oJamDataHandler.addPostToExternalObject(C,this._oTimelineDataHandler.getCurrentExternalBO()).then(function(f){t.byId("social_TextArea").clearText();t.byId("addPost_postButton").setEnabled(false);if(t._oFilter.type!==t._oFilterConstants.FILTER_TYPE.systemUpdates&&t._oFilter.type!==t._oFilterConstants.FILTER_TYPE.custom){var F=t._oTimelineDataHandler._mapFeedEntriesToTimelineItems([f])[0];t._addTimelineItemToTimeline(F);if(!t._oTimelineDataHandler.getUserInfoFromBuffer(f.Creator.Email)){t._oTimelineDataHandler.addUserInfoToBuffer(f.Creator);}}}).always(function(){t._oTimeline.setBusy(false);}).fail(function(){t._oCommonUtil.displayError(t._oLanguageBundle.getText("ST_POST_TO_JAM_FAILED"));});}else{this._oLogger.info('Posting an empty comment is not allowed, no feed entry will be created.');}},_onSuggest:function(e){var t=this;if(this.gettingSuggestions){this.gettingSuggestions.request.abort();}var s=e.getSource();var v=e.getParameter("value");if(v.trim()===""){s.showSuggestions([]);}else{this.gettingSuggestions=this._oJamDataHandler.getSuggestions(v);this.gettingSuggestions.promise.done(function(d,r){var j=d.results;if(j.length===0){s.closeSuggestionPopover();}else{var S=[];for(var i=0;i<j.length;i++){S.push({fullName:j[i].FullName,email:j[i].Email,userImage:t._buildThumbnailImageURL(j[i].Id)});}s.showSuggestions(S);}});this.gettingSuggestions.promise.fail(function(E){if(E.response&&E.response.statusCode){t._oCommonUtil.displayError(t._oLanguageBundle.getText("ST_GET_SUGGESTIONS_FAILED"));}});}},_onCustomActionClicked:function(c){var C={};var b=c.getSource().getBindingContext();var B=b.getPath();var o=c.getSource().getModel().getProperty(B+"/timelineItemData/customActionData/oDataEntry");C.oDataEntry=o;C.timelineEntryId=c.getParameters().id;C.key=c.getParameters().key;this.fireCustomActionPress(C);},_getAtMentionClicked:function(c){var t=this;var a=[];var s=c.getSource();var l=c.getParameter("link");var g=this._oJamDataHandler.getAtMentions(l.getModel().getData().feedId);g.promise.done(function(j,r){var p=l.getModel().getProperty("/placeholderIndex");a=j.results;t._showSocialProfile(s,l,a[p].Email);});g.promise.fail(function(){t._oLogger.error('Failed to retrieve the @mentions.');t._oCommonUtil.displayError(t._oCommonUtil.getLanguageBundle().getText('ST_GET_ATMENTIONS_FAILED'));});},_onReplyListOpen:function(e){if(!this._bReplyPopoverIsOpen){this._bReplyPopoverIsOpen=true;var t=e.getSource();try{var f=this._getFeedId(t);if(!f){throw new Error('Failed to get the feed entry ID.');}}catch(E){this._oLogger.error('Failed to get the feed entry ID');this._oCommonUtil.displayError(this._oLanguageBundle.getText('ST_GET_REPLIES_FAILED'));return;}this._getReplies(f,undefined,t);}},_getReplies:function(f,n,t){var a=this;t.getCustomReply().setBusyIndicatorDelay(0).setBusy(true);this.gettingReplies=this._oJamDataHandler.getReplies(f,n);this.gettingReplies.promise.done(function(j,r){a._oRepliesData=j;var R=j.results.reverse();R.forEach(function(o){o.Creator.ThumbnailImage=a._oTimelineDataHandler.buildImageUrl(o.Creator);o.CreatedAt=a._oDateUtil.formatDateToString(o.CreatedAt);});t.getCustomReply().addReplies({data:R,more:a._oRepliesData.__next?true:false});t.getCustomReply().setBusy(false);});this.gettingReplies.promise.fail(function(e){if(e.response&&e.response.statusCode){a._oCommonUtil.displayError(a._oCommonUtil.getLanguageBundle().getText('ST_GET_REPLIES_FAILED'));}});},_createReplyPopover:function(){this._oReplyPopover=new sap.collaboration.components.controls.ReplyPopover({socialTextArea:new sap.collaboration.components.controls.SocialTextArea({height:"80px",width:"100%",enableNotifyAll:false,suggestionPlacement:sap.m.PlacementType.Top,suggest:[this._onSuggest,this],afterSuggestionClose:[function(){if(this.gettingSuggestions){this.gettingSuggestions.request.abort();}},this]}),postReplyPress:[this._onPostReplyPress,this],moreRepliesPress:[function(e){var t=e.getSource().getParent();if(this._oRepliesData.__next){this._getReplies(undefined,this._oRepliesData.__next,t);}},this],afterClose:[function(e){if(this.gettingReplies){this.gettingReplies.request.abort();}this._bReplyPopoverIsOpen=false;},this],});this._oReplyPopover.getSocialTextArea().attachLiveChange(function(e){e.getParameter("value").trim()!==""?this.enableButton(true):this.enableButton(false);}.bind(this._oReplyPopover));return this._oReplyPopover;},_onPostReplyPress:function(e){var t=this;var v=e.getParameter("value");var T=e.getSource().getParent();var o=T.getBindingContext().getObject();var f=o.timelineItemData.feedId;var r=T.getCustomReply();r.setBusyIndicatorDelay(0).setBusy(true);var p=this._oJamDataHandler.postReply(f,v);r._oReplyTextArea.focus();p.promise.done(function(j,a){r.getTextArea().clearText();r.enableButton(false);var R={Text:j.results.Text,Creator:{Email:t._oTimelineUser.Email,FullName:t._oTimelineUser.FullName},CreatedAt:t._oDateUtil.formatDateToString(j.results.CreatedAt),};var u=t._oTimelineDataHandler.getUserPicture(t._oTimelineUser.Email);u?R.Creator.ThumbnailImage=u:R.Creator.ThumbnailImage=t._oTimelineDataHandler.buildImageUrl(j.results);r.addReply(R);r.setBusy(false);T.setReplyCount(T.getReplyCount()+1);});p.promise.fail(function(E){r.setBusy(false);t._oCommonUtil.displayError(t._oLanguageBundle.getText("ST_POST_REPLY_FAILED"));});},_onEnableSocialChange:function(e){var E=e.getSource().getValue();(E===true)?this._oAddPostButton.setVisible(true):this._oAddPostButton.setVisible(false)},_showFeedUpdatesInTimeline:function(n){var m=this._oTimeline.getMessageStrip();if(n>0){if(!this.byId("refreshLink")){var r=new sap.m.Link(this.createId("refreshLink"),{text:this._oLanguageBundle.getText("GF_REFRESH_FEED"),press:[function(){this._hideFeedUpdatesInTimeline();this._oTimelineDataHandler.reset();this._refreshTimelineModel();},this]});m.setLink(r);m.setType(sap.ui.core.MessageType.Information);m.setShowIcon(true);}n==1?m.setText(this._oLanguageBundle.getText("GF_NEW_FEED_UPDATE")):m.setText(this._oLanguageBundle.getText("GF_NEW_FEED_UPDATES",n));m.setVisible(true);this._oTimeline.rerender();}},_hideFeedUpdatesInTimeline:function(){var m=this._oTimeline.getMessageStrip();m.close();},_startAutoCheckingForNewUpdates:function(){this._iNewFeedUpdatesCheckerTimeDelay=120000;this._sNewFeedUpdatesCheckerTimeoutId=jQuery.sap.delayedCall(this._iNewFeedUpdatesCheckerTimeDelay,this,this._checkForNewFeedUpdates);},_stopAutoCheckingForNewUpdates:function(){jQuery.sap.clearDelayedCall(this._sNewFeedUpdatesCheckerTimeoutId);},_checkForNewFeedUpdates:function(){var s=function(d,r){this._showFeedUpdatesInTimeline(d);this._sNewFeedUpdatesCheckerTimeoutId=jQuery.sap.delayedCall(this._iNewFeedUpdatesCheckerTimeDelay,this,this._checkForNewFeedUpdates);};var e=function(o){this._oLogger.error("Failed to check for new feed updates.");this._sNewFeedUpdatesCheckerTimeoutId=jQuery.sap.delayedCall(this._iNewFeedUpdatesCheckerTimeDelay,this,this._checkForNewFeedUpdates);};var l=this._oTimeline.getContent()[0];var L=l?l.getBindingContext().getObject()._feedEntryData.TopLevelId:'';var E=this._oTimelineDataHandler.getCurrentExternalBO().Id;this._oJamDataHandler.getFeedUpdatesLatestCount(L,E).done(s.bind(this)).fail(e.bind(this));},_buildThumbnailImageURL:function(u){return this._defaultAttributes.collaborationHostServiceUrl+"/Members('"+u+"')/ThumbnailImage/$value";}});
