/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2017 SAP SE. All rights reserved
 */
jQuery.sap.require("sap.collaboration.library");jQuery.sap.require("sap.collaboration.components.utils.CommonUtil");jQuery.sap.require("sap.collaboration.components.utils.JamUtil");jQuery.sap.require("sap.collaboration.components.utils.OdataUtil");jQuery.sap.require("sap.ui.core.UIComponent");jQuery.sap.declare("sap.collaboration.components.fiori.feed.dialog.Component");sap.ui.core.UIComponent.extend("sap.collaboration.components.fiori.feed.dialog.Component",{metadata:{includes:["../../../resources/css/Sharing.css"],properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"575px"},height:{type:"sap.ui.core.CSSSize",defaultValue:"605px"},feedType:{type:"string",defaultValue:sap.collaboration.FeedType.object},groupIds:{type:"string"},object:{type:"object"},businessObject:{type:"object"}},aggregations:{},events:{}},systemSettings:{oDataServiceUrl:"/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV",oCollaborationHostRestService:"/sap/bc/ui2/smi/rest_tunnel/Jam//v1",oCollaborationHostODataService:"/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData"},init:function(){this.oCommonUtil=new sap.collaboration.components.utils.CommonUtil();this.oJamUtil=new sap.collaboration.components.utils.JamUtil();this.oLangBundle=this.oCommonUtil.getLanguageBundle();this.sJamUrl=undefined;this.sJamToken=undefined;this.oOdataModel=undefined;this.oODataUtil=undefined;this.oBusinessObject={};sap.ui.core.UIComponent.prototype.init.apply(this);},setSettings:function(s){if(s){this.setFeedType(s.feedType);this.setGroupIds(s.groupIds);this.setObject(s.object);this.setBusinessObject(s.businessObject);}else{var e=new Error("Settings object is undefined");jQuery.sap.log.error(e.stack);}},open:function(){this._logComponentProperties();try{this._validateInputParameters(this.mProperties);this._createFeedDialog();this._requestWidgetData();this.oFeedDialog.open();}catch(e){jQuery.sap.log.error(e.stack);this.oCommonUtil.displayError();}},onBeforeRendering:function(){},onAfterRendering:function(){},render:function(r){},_requestWidgetData:function(){var c=this._getCSRFToken();var s=this;var a=true;var C=this.systemSettings.oCollaborationHostRestService;this._initOData();if(this.getObject()){this._getObjectWithoutMapping();}else if(this.getBusinessObject()){this._getObjectWithMapping();}var A=function(){if(this.readyState==4){if(this.status==201){s.sJamToken=this.responseXML.getElementsByTagName('single_use_token')[0].attributes[0].value;if(s.sJamUrl&&s.oBusinessObject.odata_url&&s.oBusinessObject.metadata_url){s._createFeedView();s.oFeedDialog.addContent(s.oFeedView);setTimeout(function(){s.oFeedDialog.setBusy(false);},3000);}}else{var e="The single use token from SAP Jam was not returned successfully";jQuery.sap.log.error(e,"","sap.collaboration.components.utils.JamUtil.getJamSinglelUseTokens()");if(s.oFeedDialog.isOpen()===true){s.oFeedDialog.close();}s.oCommonUtil.displayError();}}};this.oJamUtil.getJamSinglelUseTokens(C,A,a,c);},_getObjectWithoutMapping:function(){var s=this;var a=true;var b=[];var p=function(c){s._parseBatchResults(c);if(s.sJamToken){s._createFeedView();s.oFeedDialog.addContent(s.oFeedView);setTimeout(function(){s.oFeedDialog.setBusy(false);},3000);}};var B=function(e){jQuery.sap.log.error(e,"","sap.collaboration.components.fiori.feed.dialog.Component._getObjectWithoutMapping(), fnBatchErrorCallback()");throw e;};b=this._createBatchRequests();this.oODataUtil.executeODataBatchRequest(this.oOdataModel,b,p,a,B);},_getObjectWithMapping:function(){var s=this;var g=new jQuery.Deferred();g.done(function(j){s.sJamUrl=j;});var a=new jQuery.Deferred();a.done(function(m){s._setMappedObject(m);});jQuery.when(g,a).fail(function(S){if(s.oFeedDialog&&s.oFeedDialog.isOpen()){s.oFeedDialog.close();}s.oCommonUtil.displayError();});this.oODataUtil.getJamUrl(this.oOdataModel,g);this.oODataUtil.getExternalObjectMapping(this.oOdataModel,this.getBusinessObject(),a);},_setMappedObject:function(m){var s=this;this.oBusinessObject.id=m.Exid;this.oBusinessObject.type=m.ObjectType;this.oBusinessObject.odata_url=this.oBusinessObject.id;this.oBusinessObject.metadata_url=this.oBusinessObject.type;if(this.sJamToken){this._createFeedView();this.oFeedDialog.addContent(this.oFeedView);setTimeout(function(){s.oFeedDialog.setBusy(false);},3000);}},_initOData:function(){var a=true;var o=this.systemSettings.oDataServiceUrl;if(!this.oOdataModel){this.oOdataModel=new sap.ui.model.odata.ODataModel(o,a);}if(!this.oOdataModel.oMetadata.oMetadata){var e=new Error("Metadata is undefined");jQuery.sap.log.error(e,"","sap.collaboration.components.fiori.feed.dialog.Component._requestWidgetData()");throw e;}if(!this.oODataUtil){this.oODataUtil=new sap.collaboration.components.utils.OdataUtil();}},_getCSRFToken:function(){var c="";var C=this.systemSettings.oCollaborationHostODataService;var a=function(d){if(this.readyState==4){if(this.status==200){c=this.getResponseHeader('x-csrf-token');}}};this.oJamUtil.getCSRFToken(C,a,false);return c;},_createBatchRequests:function(){var s=this;var b=[];if(!s.sJamUrl){b.push(s.oODataUtil.createJamUrlBatchOperation(s.oOdataModel));}b=b.concat(s._createExternalUrlBatchRequest(s.oODataUtil,s.getObject()));return b;},_createExternalUrlBatchRequest:function(o,b){var s=this;var B=[];if(o&&b){if(b.id){B.push(o.createExternalOdataUrlBatchOperation(s.oOdataModel,b.id));}if(b.type){B.push(o.createExternalOdataUrlBatchOperation(s.oOdataModel,b.type));}}return B;},_parseBatchResults:function(b){var s=this;var i=0;if(!s.sJamUrl){if(b[i].error){throw new Error(b[i].error);}else{s.sJamUrl=b[i][s.oODataUtil.OdataUtilConstants.EndPoint.GetCollaborationHostUrl].URL;}i++;}if(b[i].error){throw new Error(b[i].error);}else{s.oBusinessObject.id=b[i][s.oODataUtil.OdataUtilConstants.EndPoint.GetExternalODataURL].URL;s.oBusinessObject.odata_url=s.oBusinessObject.id;}i++;if(b[i].error){throw new Error(b[i].error);}else{s.oBusinessObject.type=b[i][s.oODataUtil.OdataUtilConstants.EndPoint.GetExternalODataURL].URL;s.oBusinessObject.metadata_url=s.oBusinessObject.type;}},_createFeedView:function(){var s=this;if(!s.oFeedView){s.oFeedView=sap.ui.view({id:s.getId()+"_FeedView",height:"100%",viewData:{controlId:s.getId(),jamURL:s.sJamUrl,jamToken:s.sJamToken,appType:sap.collaboration.AppType.widget,feedType:s.getFeedType(),groupIds:s.getGroupIds(),businessObject:s.oBusinessObject,langBundle:s.oLangBundle},type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.collaboration.components.fiori.feed.commons.Detail"});}else{s.oFeedView.getController().sFeedType=s.getFeedType();s.oFeedView.getViewData().groupIds=s.getGroupIds();s.oFeedView.getController().oBusinessObject=s.oBusinessObject;}},_createFeedDialog:function(){var s=this;if(!this.oFeedDialog){this.oFeedDialog=new sap.m.Dialog(this.getId()+"FeedDialog",{title:this.oLangBundle.getText("FEED_DIALOG_TITLE"),stretch:false,contentWidth:this.getWidth(),contentHeight:this.getHeight(),content:[],endButton:new sap.m.Button({text:this.oLangBundle.getText("CLOSE_BUTTON_TEXT"),press:function(){s.oFeedDialog.close();}})});if(sap.ui.Device.system.phone){this.oFeedDialog.setStretch(true);}}this.oFeedDialog.setBusy(true);},_validateInputParameters:function(i){var e;if(!i){e=new Error("Input paremeters are undefined");jQuery.sap.log.error(e.stack);throw e;}else if(i.businessObject){var b=i.businessObject;if(jQuery.isEmptyObject(b)){e=new Error("Business Object is empty");jQuery.sap.log.error(e.stack);throw e;}if(!b.appContext){e=new Error("Application context is undefined");jQuery.sap.log.error(e.stack);throw e;}if(!b.odataServicePath){e=new Error("OData Service Path is undefined");jQuery.sap.log.error(e.stack);throw e;}if(!b.collection){e=new Error("Collection is undefined");jQuery.sap.log.error(e.stack);throw e;}if(!b.key){e=new Error("Key is undefined");jQuery.sap.log.error(e.stack);throw e;}if(!b.name){e=new Error("Name is undefined");jQuery.sap.log.error(e.stack);throw e;}}else if(i.object){var o=i.object;if(jQuery.isEmptyObject(o)){e=new Error("Business Object is empty");jQuery.sap.log.error(e.stack);throw e;}if(!o.id){e=new Error("Object is undefined");jQuery.sap.log.error(e.stack);throw e;}if(!o.type){e=new Error("Missing Object Type");jQuery.sap.log.error(e.stack);throw e;}}else{e=new Error("Neither an Object nor a Business Object was passed");throw e;}},_logComponentProperties:function(){jQuery.sap.log.debug("Share Component properties:","","sap.collaboration.components.fiori.dialog.Component._logComponentProperties()");jQuery.sap.log.debug("width: "+this.getWidth());jQuery.sap.log.debug("height: "+this.getHeight());jQuery.sap.log.debug("oDataServiceUrl: "+this.systemSettings.oDataServiceUrl);jQuery.sap.log.debug("feedType: "+this.getFeedType());jQuery.sap.log.debug("groupIds: "+this.getGroupIds());jQuery.sap.log.debug("object: "+JSON.stringify(this.getObject()));jQuery.sap.log.debug("businessObject: "+JSON.stringify(this.getBusinessObject()));}});
