/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2017 SAP SE. All rights reserved
 */
jQuery.sap.require("sap.collaboration.components.utils.CommonUtil");jQuery.sap.require("sap.collaboration.components.utils.OdataUtil");jQuery.sap.require("sap.collaboration.components.fiori.sharing.helper.ShareUtil");jQuery.sap.require("sap.collaboration.components.fiori.sharing.helper.AttachmentsUtil");jQuery.sap.require("sap.m.MessageToast");sap.ui.controller("sap.collaboration.components.fiori.sharing.Sharing",{onInit:function(){this.oNoteTextArea=this.getView().oNoteTextArea;this.oAttachmentsInput=this.getView().oAttachmentsInput;this.oTargetFolderInput=this.getView().oTargetFolderInput;this.oODataUtil=undefined;this.sPrefixId=this.getView().getViewData().controlId;this.oLangBundle=this.getView().getViewData().langBundle;this.iJamGroupsCount=0;this.sObjectId=this.getView().getViewData().objectId;this.sObjectShare=this.getView().getViewData().objectShare;this.oObjectDisplay=this.getView().getViewData().objectDisplay;this.oExternalObject=undefined;this.oMappedExternalObject=undefined;this.sMemberEmail=undefined;this.oSharingDialog=this.getView().getViewData().sharingDialog;this.fNoGroupsCallBack=this.getView().getViewData().noGroupsCallBack;this.oCommonUtil=new sap.collaboration.components.utils.CommonUtil();this.oAttachments=this.getView().getViewData().attachments;this.bAttachmentsCB=false;this.aFiles=[];this.aSelectedFiles=[];this.sSelectedFolderId='';this.oItemTemplate=undefined;this.oSelectedGroup=undefined;this.gettingSuggestions=undefined;},onBeforeRendering:function(){try{this.sSelectedGroupId='';this.sSelectedGroupName='';if(!this.oSMIODataModel){this.initializeOdataModel();}if(!this.oODataUtil){this.initializeOdataUtils();}if(!this.oAttachmentsUtil){this.initializeAttachmentsUtil();}this.initializeShareUtil();this.preRenderSetup();this.fetchData();this.clearAttachmentsData();this.oAttachments=this.getView().getViewData().attachments;if(this.oAttachments&&this.oAttachments.attachmentsArray){this.aFiles=this.oAttachments.attachmentsArray;if(this.aFiles.length>0){this.getView().oAttachmentsInput.setEnabled(true);}else{this.getView().oAttachmentsInput.setEnabled(false);}if(this.oFileSelectionDialog){var a=this.oAttachmentsUtil.createAttachmentsModel(this.aFiles);this.oFileSelectionDialog.setModel(a);}this.showAttachmentsFields(true);}else{this.showAttachmentsFields(false);}if(this.sObjectId!=this.getView().getViewData().objectId){this.sObjectId=this.getView().getViewData().objectId;}if(this.sObjectShare!=this.getView().getViewData().objectShare||sap.ui.getCore().byId(this.sPrefixId+"_NoteTextArea").setValue!==this.getView().getViewData().objectShare){this.sObjectShare=this.getView().getViewData().objectShare;sap.ui.getCore().byId(this.sPrefixId+"_NoteTextArea").setInitialValue(this.sObjectShare);}if(this.oObjectDisplay!=this.getView().getViewData().objectDisplay){if(this.oObjectDisplay!=undefined){this.getView().oSharingVBox.removeItem(0);}this.oObjectDisplay=this.getView().getViewData().objectDisplay;this.getView().oSharingVBox.insertItem(this.oObjectDisplay,0);}}catch(e){if(this.oSharingDialog){throw e;}this.oCommonUtil.displayError(e);}},onAfterRendering:function(){setTimeout(function(){sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect").focus();}.bind(this),1);},onExit:function(){this.getView().destroyContent();},preRenderSetup:function(){this.getView().oGroupSelect.setEnabled(false);this.setGroupSelectionText("");if(this.oAttachments&&this.oAttachments.attachmentsArray){this.getView().oTargetFolderInput.setEnabled(false);}this.getView().oNoteTextArea.setEnabled(false);if(this.oSharingDialog){this.oSharingDialog.getButtons()[0].setEnabled(false);this.oSharingDialog.getButtons()[1].setEnabled(false);}},fetchData:function(){var s=this;var g=new jQuery.Deferred();g.done(function(c){s.iJamGroupsCount=c;if(s.iJamGroupsCount>0){s.postFetchSetup();setTimeout(function(){s.getView().getContent()[0].getItems()[1].getContent()[1].focus();},50);}else{if(s.fNoGroupsCallBack){s.fNoGroupsCallBack();}}});var a=new jQuery.Deferred();a.done(function(u){if(!s.sJamUrl){s.sJamUrl=u;}});var m=new jQuery.Deferred();m.done(function(e){s.oMappedExternalObject=e;});m.fail(function(){s.oMappedExternalObject=undefined;jQuery.sap.log.debug('Mapping Internal BO to External BO failed');});var b=new jQuery.Deferred();b.done(function(e){if(!s.sMemberEmail){s.sMemberEmail=e;}});jQuery.when(g,a,m).fail(function(e){if(s.oSharingDialog){s.oSharingDialog.close();}if(e.statusCode===401||e.statusCode===403){s.oCommonUtil.displayError(s.oLangBundle.getText("SHARE_AUTHORIZATION_FAILURE_MSG"));}else{s.oCommonUtil.displayError();}});this.oJamODataModel.read('/Groups/$count',{success:function(d,r){g.resolve(parseInt(r.body));},error:function(e){g.reject(e.response);}});this.oJamODataModel.read('/Self',{success:function(d,r){b.resolve(this.oCommonUtil.getODataResult(d).Email);}.bind(this),error:function(e){b.reject(e.response);}});if(!this.sJamUrl){this.oSMIODataModel.read('/GetCollaborationHostURL',{success:function(d,r){a.resolve(d.GetCollaborationHostURL.URL);},error:function(e){a.reject(e.response);}});}else{a.resolve();}this.oExternalObject=this.getView().getViewData().externalObject;if(this.oExternalObject){this.oSMIODataModel.read('/MapInternalBOToExternalBO',{urlParameters:{ApplicationContext:"'"+s.oExternalObject.appContext+"'",ODataCollection:"'"+s.oExternalObject.collection+"'",ODataKeyPredicate:"'"+s.oExternalObject.key+"'",ODataServicePath:"'"+s.oExternalObject.odataServicePath+"'"},success:function(d,r){m.resolve(d.MapInternalBOToExternalBO);},error:function(e){m.reject(e.response);}});}},postFetchSetup:function(){this.setGroupSelectionEnabled(true);},initializeOdataModel:function(){var a=true;this.sSMIODataServiceUrl=this.getView().getViewData().odataServiceUrl;this.oSMIODataModel=new sap.ui.model.odata.ODataModel(this.sSMIODataServiceUrl,a);this.sJamODataServiceUrl=this.getView().getViewData().collaborationHostODataServiceUrl;this.oJamODataModel=new sap.ui.model.odata.ODataModel(this.sJamODataServiceUrl,a);this.oJamODataModel.setDefaultCountMode(sap.ui.model.odata.CountMode.Inline);},initializeOdataUtils:function(){this.oODataUtil=new sap.collaboration.components.utils.OdataUtil();},initializeAttachmentsUtil:function(){this.oAttachmentsUtil=new sap.collaboration.components.fiori.sharing.helper.AttachmentsUtil(this.oLangBundle,this.oODataUtil,this.oJamODataModel);},initializeShareUtil:function(){this.oShareUtil=new sap.collaboration.components.fiori.sharing.helper.ShareUtil(this.oLangBundle,this.oODataUtil,this.oSMIODataModel,this.oCommonUtil,this.oJamODataModel,this.getView().getViewData().collaborationHostRestService);},setGroupSelectionText:function(t){var g=sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect");g.setValue(t);},setGroupSelectionEnabled:function(e){var g=sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect");g.setEnabled(e);},setFolderSelectionEnabled:function(e){this.oTargetFolderInput.setEnabled(e);},showAttachmentsFields:function(v){this.getView().AttachmentsInputLayout.setVisible(v);this.getView().oTargetFolderInputLayout.setVisible(v);this.getView().oAttachmentCB.setVisible(v);},clearAttachmentsData:function(){this.aFiles=[];this.aSelectedFiles=[];this.sSelectedFolderId='';this.bAttachmentsCB=false;this.oAttachmentsInput.setValue("");this.getView().oAttachmentCB.setSelected(this.bAttachmentsCB);this.getView().oAttachmentCB.setEnabled(false);this.oTargetFolderInput.setValue("");if(this.oFolderSelectionDialog){this.oAttachmentsUtil.resetFolderSelection(this.getSelectedGroupId());}},onAttachmentsValueHelpPress:function(c){if(this.oSharingDialog){var s=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var S=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth;}if(!this.oFileSelectionDialog){var a=this.oAttachmentsUtil.createAttachmentsModel(this.aFiles);this.oFileSelectionDialog=this.oAttachmentsUtil.createFileSelectionDialog(this.sPrefixId,a,this.onFileSelectionDialogConfirm(),S,s);}var b=this.oFileSelectionDialog.getBinding("items");b.filter([]);this.oFileSelectionDialog.open();},onFileSelectionDialogConfirm:function(){var s=this;return function(e){s.aSelectedFiles=[];var c=e.getParameter("selectedContexts");for(var i=0;i<c.length;i++){s.aSelectedFiles.push(c[i].getObject());}if(s.aSelectedFiles&&s.aSelectedFiles.length>0){s.postFileSelectionSetup(true);}else{s.postFileSelectionSetup(false);}};},postFileSelectionSetup:function(f){if(f===true){if(this.aSelectedFiles.length==1){this.oAttachmentsInput.setValue(this.oLangBundle.getText("SELECTED_ATTACHMENT_FIELD_TEXT",[this.aSelectedFiles.length]));}else{this.oAttachmentsInput.setValue(this.oLangBundle.getText("SELECTED_ATTACHMENTS_FIELD_TEXT",[this.aSelectedFiles.length]));}this.getView().oAttachmentCB.setEnabled(true);if(this.sSelectedGroupId!==''){this.setFolderSelectionEnabled(true);}}else{this.oAttachmentsInput.setValue("");this.bAttachmentsCB=false;this.getView().oAttachmentCB.setSelected(this.bAttachmentsCB);this.postAttachmentCheckBoxSelection();this.getView().oAttachmentCB.setEnabled(false);this.setFolderSelectionEnabled(false);}},onGroupSelectValueHelpPress:function(e){if(!this.oItemTemplate){this.oItemTemplate=new sap.m.StandardListItem({title:{parts:["Name","GroupType"],formatter:function(n,g){return n+" ("+g+")";}},type:sap.m.ListType.Active,tooltip:"{Name}"});}if(this.oSharingDialog){var s=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var S=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth;}if(!this.oGroupSelectionDialog){this.oGroupSelectionDialog=this.oShareUtil.createGroupSelectionDialog(this.sPrefixId,this.oItemTemplate,this._onGroupSelectionDialogConfirm(),S,s,this.oJamODataModel);}else{this.oGroupSelectionDialog.setModel(this.oJamODataModel);this.oGroupSelectionDialog.bindAggregation("items","/Groups",this.oItemTemplate);}this.oGroupSelectionDialog.open();},_onGroupSelectionDialogConfirm:function(){var s=this;return function(e){var c=e.getParameter("selectedContexts");for(var i=0;i<c.length;i++){s.oSelectedGroup=c[i].getObject();}if(s.oSelectedGroup){s.postGroupSelectionSetup(true);}else{s.postGroupSelectionSetup(false);}};},postGroupSelectionSetup:function(g){if(g===true){if(this.oSelectedGroup!==undefined){this.sSelectedGroupId=this.oSelectedGroup.Id.toString();this.sSelectedGroupName=this.oSelectedGroup.Name.toString();this.setGroupSelectionText(this.sSelectedGroupName);}if(this.oAttachments&&this.oAttachments.attachmentsArray){this.sSelectedFolderId='';this.oAttachmentsUtil.resetFolderSelection(this.getSelectedGroupId());var s=this.oAttachmentsUtil.getCurrentFolder();this.oTargetFolderInput.setValue(s.name);}if(this.aSelectedFiles&&this.aSelectedFiles.length>0){this.setFolderSelectionEnabled(true);}if(this.bAttachmentsCB===false){this.getView().oNoteTextArea.setEnabled(true);}if(this.oSharingDialog){this.oSharingDialog.getButtons()[0].setEnabled(true);this.oSharingDialog.getButtons()[1].setEnabled(true);}}else{this.setFolderSelectionEnabled(false);this.getView().oNoteTextArea.setEnabled(false);}},onTargetFolderValueHelpPress:function(c){if(this.oSharingDialog){var s=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var S=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth;}if(!this.oFolderSelectionDialog){this.oFolderSelectionDialog=this.oAttachmentsUtil.createFolderSelectionDialog(this.sPrefixId,this.getSelectedGroupId(),this.onFolderSelectionDialogConfirm(),this.onFolderSelectionDialogCancel(),S,s);this.sSelectedFolderId='';}this.oFolderSelectionDialog.getContent()[0].oController.setFolderSelectionDialogTitle(this.oTargetFolderInput.getValue());this.oFolderSelectionDialog.open();},onFolderSelectionDialogConfirm:function(e){var s=this;return function(){var S=s.oAttachmentsUtil.getCurrentFolder();s.sSelectedFolderId=S.id;s.oTargetFolderInput.setValue(S.name);};},onFolderSelectionDialogCancel:function(e){var s=this;return function(e){s.oAttachmentsUtil.setCurrentFolderId(s.sSelectedFolderId);};},onAttachmentCheckBoxSelected:function(){this.bAttachmentsCB=this.getView().oAttachmentCB.getSelected();this.postAttachmentCheckBoxSelection();},atMentionsButtonPressed:function(){this.getView().oNoteTextArea.atMentionsButtonPressed();},onSuggestion:function(e){if(this.gettingSuggestions){this.gettingSuggestions.abort();}var t=this;var v=e.getParameter("value");var n=this.getView().oNoteTextArea;if(v.trim()===""){n.showSuggestions([]);n.setSuggestionHeight(undefined);return;}var g=this.getSelectedGroupId();var p="/Members_Autocomplete";var P={"async":true,"urlParameters":{"Query":"'"+v+"'","GroupId":"'"+g+"'","$top":"4"},"success":function(d,r){var j=t.oCommonUtil.getODataResult(d);if(j.length===0){n.closeSuggestionPopover();n.setSuggestionHeight(undefined);}else{var s=[];var J=j.length;for(var i=0;i<J;i++){s.push({fullName:j[i].FullName,email:j[i].Email,userImage:t._buildThumbnailImageURL(j[i].Id)});}n.showSuggestions(s);J>=3?n.setSuggestionHeight("12rem"):n.setSuggestionHeight(undefined);}},"error":function(E){jQuery.sap.log.error("Failed to get suggestions: "+E.statusText);}};this.gettingSuggestions=this.oJamODataModel.read(p,P);},postAttachmentCheckBoxSelection:function(){if(this.bAttachmentsCB===true){this.getView().oNoteTextArea.setEnabled(false);}else{if(this.sSelectedGroupId!==''){this.getView().oNoteTextArea.setEnabled(true);}}},getSharingData:function(){var f;if((this.oNoteTextArea.getValue()!==undefined&&this.oNoteTextArea.getValue()!=="")||(this.sObjectId!==undefined&&this.sObjectId!=="")){f={note:this.oNoteTextArea.convertTextWithFullNamesToEmailAliases(),uiUrl:this.sObjectId};}if(JSON.stringify(this.oExternalObject)==='{}'){this.oExternalObject=undefined;}return{feedContent:f,groupId:this.getSelectedGroupId(),folderId:this.getSelectedFolderId(),aFilesToUpload:this.aSelectedFiles,externalObject:this.oExternalObject,mappedExternalObject:this.oMappedExternalObject,groupName:this.getSelectedGroupName(),memberEmail:this.sMemberEmail};},getSelectedGroupId:function(){return this.sSelectedGroupId;},getSelectedGroupName:function(){return this.sSelectedGroupName;},getSelectedFolderId:function(){return this.sSelectedFolderId;},shareToJam:function(){var s=this.getSharingData();var a=this;if(s.aFilesToUpload.length===0&&(!s.feedContent||(!s.feedContent.uiUrl&&s.feedContent.note.trim()===""))&&!s.externalObject){var r=a.oLangBundle.getText("SHARING_NOTHING_TO_SHARE_MSG");this.oCommonUtil.showMessage(r,{duration:3000,autoclose:false});}else{if(!this.bAttachmentsCB){this.oShareUtil.shareBusinessObject(s);}if(s.aFilesToUpload.length>0){this.oShareUtil.uploadAttachments(s);var r=this.oLangBundle.getText("SHARING_ACKNOWLEDGMENT_MSG");setTimeout(function(){a.oCommonUtil.showMessage(r,{duration:3000,width:"30em",autoClose:false});},500);}}},_buildThumbnailImageURL:function(u){return this.oJamODataModel.sServiceUrl+"/Members('"+jQuery.sap.encodeURL(u)+"')/ThumbnailImage/$value";}});
