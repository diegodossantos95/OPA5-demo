/*
* ! SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2017 SAP SE. All rights reserved
*/
sap.ui.define(["./Mode","sap/m/CustomListItem","sap/m/Label","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/collaboration/components/utils/PendingRequestsUtil"],function(M,C,L,F,a,P){var B=M.extend("sap.collaboration.components.feed.BOMode",{constructor:function(f){M.apply(this,[f]);this._sJamBOId=undefined;this._oPendingRequestsUtil=new P();this._oSMIModel=this._oFeedController.getModel("smi");this._oLanguageBundle=this._oFeedController.getLanguageBundle();this._oList.setModel(this._oJamModel);this.FILTER_CONSTANTS={GROUP_WALL:"Group Wall",GROUP_OBJECT_WALL:"Group Object Wall"};f.byId("filter_popover").attachSelectionChange(this.onFilterSelection,this);}});B._sSMIv2ServiceUrl="/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV";B.prototype.start=function(f){if(!(this._oCommonUtil.isObject(f)&&this._oCommonUtil.isString(f.appContext)&&this._oCommonUtil.isString(f.odataServicePath)&&this._oCommonUtil.isString(f.collection)&&this._oCommonUtil.isString(f.key)&&this._oCommonUtil.isString(f.name))){var e="The feedSources' data object is invalid.";this._oFeedController.logError(e);throw new Error(e);}this._sendRequestMapInternalBOToExternalBO(f.appContext,f.collection,f.key,f.odataServicePath).then((function(d,r){return this._sendRequestExternalObjects_FindByExidAndObjectType(d.MapInternalBOToExternalBO.Exid,d.MapInternalBOToExternalBO.ObjectType);}).bind(this),(function(E){this._oFeedController.logError("The internal to external mapping for the business object could not be performed.");this._oFeedController.displayErrorMessage(this._oLanguageBundle.getText("SMIV2_INTERNAL_TO_EXTERNAL_BO_MAPPING_COULD_NOT_BE_PERFORMED"));return null;}).bind(this)).then((function(d,r){this._sJamBOId=this._oCommonUtil.getODataResult(d).Id;this._oList.attachUpdateFinished(this.onGroupSelectorUpdateFinished,this);this._oList.bindItems({path:"/ExternalObjects('"+this._oCommonUtil.getODataResult(d).Id+"')/Groups",template:this._oListItemTemplate});}).bind(this),(function(E){if(E!==null){this._oFeedController.logError("An external object associated with the given Exid and ObjectType could not be found.");this._oFeedController.displayErrorMessage(this._oLanguageBundle.getText("JAM_EXTERNAL_OBJECT_COULD_NOT_BE_FOUND"));}}).bind(this));this._oFeedController.enableGroupFeed();this._oViewDataModel.setProperty("/filterEnabled",true);this._setFilterOptions(f.name);this._oList.attachUpdateFinished(this.onUpdateFinished,this);};B.prototype.stop=function(){this._oPendingRequestsUtil.abortAll();this._oViewDataModel.setProperty("/filterEnabled",false);this._oList.detachUpdateFinished(this.onUpdateFinished,this);};B.prototype._sendFunctionImportODataRequest=function(o,O,p){var d=jQuery.Deferred();var A=o.callFunction(O,{urlParameters:p,success:function(D,r){d.resolve(D,r);},error:function(e){d.reject(e);}});var b=d.promise(A);this._oPendingRequestsUtil.add(b);d.always((function(){this._oPendingRequestsUtil.remove(b);}).bind(this));return b;};B.prototype._sendRequestMapInternalBOToExternalBO=function(A,o,O,s){return this._sendFunctionImportODataRequest(this._oSMIModel,"/MapInternalBOToExternalBO",{ApplicationContext:A,ODataCollection:o,ODataKeyPredicate:O,ODataServicePath:s});};B.prototype._sendRequestExternalObjects_FindByExidAndObjectType=function(E,O){return this._sendFunctionImportODataRequest(this._oJamModel,"/ExternalObjects_FindByExidAndObjectType",{Exid:E,ObjectType:O});};B.prototype._setFilterOptions=function(b){var i;b?i=this._oLanguageBundle.getText("GF_FILTER_OBJECT",b):i=this._oLanguageBundle.getText("GF_FILTER_OBJECT_DEFAULT");var f=[{Name:this._oLanguageBundle.getText("GF_FILTER_GROUP"),key:this.FILTER_CONSTANTS.GROUP_WALL},{Name:i,key:this.FILTER_CONSTANTS.GROUP_OBJECT_WALL}];this._oViewDataModel.setProperty("/filter",f);var o=this._oFeedController.byId("filter_popover");o.setSelectedItem(o.getItems()[0]);};B.prototype.getAddPostPath=function(){var g=this._oViewDataModel.getProperty("/groupSelected/Id");return"/GroupExternalObjects(GroupId='"+g+"',ExternalObjectId='"+this._sJamBOId+"')/FeedEntries";};B.prototype.displayFeedSourceSelectorPopover=function(c){this._oList.setBusy(true);this._oJamModel.refresh(true);this._oGroupSelectPopover.openBy(c);};B.prototype.onGroupSelected=function(e){var g=e.getSource().getSelectedItem().getBindingContext().getObject();this._oViewDataModel.setProperty("/groupSelected",{Id:g.Id,Name:g.Name,WebURL:g.WebURL});this._oViewDataModel.setProperty("/feedEndpoint","/Groups('"+g.Id+"')/FeedEntries");this._oViewDataModel.setProperty("/filterMessage","");var f=this._oFeedController.byId("filter_popover");f.setSelectedItem(f.getItems()[0]);this._oGroupSelectPopover.close();};B.prototype.onBatchCompleted=function(e){};B.prototype.onGroupSelectorUpdateFinished=function(){var l=this._oList.getItems();var f;var o;if(l.length>0){f=l[0];this._oList.setSelectedItem(f);o=f.getBindingContext().getObject();this._oViewDataModel.setProperty("/groupSelected",o);this._oViewDataModel.setProperty("/feedEndpoint","/Groups('"+o.Id+"')/FeedEntries");}this._oList.detachUpdateFinished(this.onGroupSelectorUpdateFinished,this);};B.prototype.onUpdateFinished=function(){this._oList.setBusy(false);};B.prototype.onFilterSelection=function(c){var s=c.getParameter("listItem");var f=s.getBindingContext().getObject();var g=this._oViewDataModel.getProperty("/groupSelected/Id");switch(f.key){case this.FILTER_CONSTANTS.GROUP_WALL:this._oViewDataModel.setProperty("/filterMessage","");this._oViewDataModel.setProperty("/feedEndpoint","/Groups('"+g+"')/FeedEntries");break;case this.FILTER_CONSTANTS.GROUP_OBJECT_WALL:this._oViewDataModel.setProperty("/filterMessage",this._oLanguageBundle.getText("ST_FILTER_TEXT")+" "+f.Name);this._oViewDataModel.setProperty("/feedEndpoint","/GroupExternalObjects(GroupId='"+g+"',ExternalObjectId='"+this._sJamBOId+"')/FeedEntries");break;}};B.prototype.getFeedUpdatesLatestCount=function(){var l=this._oFeedController.byId("timeline").getContent()[0];var s=l?l.getModel().getProperty("/TopLevelId"):"";var g=this._oViewDataModel.getProperty("/groupSelected/Id");if(this._oViewDataModel.getProperty("/filterMessage")===""){return this._sendRequestGroup_SinceLatestCount(s,g);}else{var e=this._sJamBOId;return this._sendRequestGroupExternalObject_SinceLatestCount(s,g,e);}};B.prototype._sendRequestGroup_SinceLatestCount=function(b,G){return this._sendFunctionImportODataRequest(this._oJamModel,"/Group_FeedLatestCount",{LatestTopLevelId:b,Id:G});};B.prototype._sendRequestGroupExternalObject_SinceLatestCount=function(b,G,E){return this._sendFunctionImportODataRequest(this._oJamModel,"/GroupExternalObject_FeedLatestCount",{LatestTopLevelId:b,GroupId:G,ExternalObjectId:E});};B.prototype._initializeModels=function(){M.prototype._initializeModels.apply(this);var s=new sap.ui.model.odata.ODataModel(B._sSMIv2ServiceUrl,true);this._oFeedController.setSmiModel(s);};B.prototype.getSMIv2ServiceUrl=function(){return B._sSMIv2ServiceUrl;};return B;},true);
