/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2017 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.collaboration.components.utils.OdataUtil");jQuery.sap.require("sap.collaboration.components.utils.CommonUtil");sap.ui.base.Object.extend("sap.collaboration.components.utils.OdataUtil",{OdataUtilConstants:{HttpStatusCode:{success:200,created:201},EndPoint:{AssignedGroups:"AssignedGroups",BusinessObjects:"BusinessObjects",ContentItems:"ContentItems",PostContentItem:"PostContentItem",Feed:"Feed",Folders:"Folders",GetCollaborationHostUrl:"GetCollaborationHostURL",MapInternalBOToExternalBO:"MapInternalBOToExternalBO",GetExternalODataURL:"GetExternalODataURL",GetSingleUseToken:"GetSingleUseToken",Groups:"Groups",GroupsCount:"Groups/$count",GetNotificationUnreadCount:"GetNoticeUnreadCount",Notifications:"Notices",FeaturedExternalObjects:"FeaturedExternalObjects",GroupsAsFeatured:"GroupsAsFeatured",ExternalObjects:"ExternalObjects",Activities:"Activities",ExternalObjects_FindByExidAndObjectType:"ExternalObjects_FindByExidAndObjectType"},HttpMethod:{GET:"GET",POST:"POST"},ResponseType:{blob:"blob",arraybuffer:"arraybuffer"}},constructor:function(){this.oCommonUtil=new sap.collaboration.components.utils.CommonUtil();this.bError=false;},getJamUrl:function(o,p,a){var e="";var j="";var s=function(d,r){if(p){p.resolve(d.GetCollaborationHostURL.URL);}else{j=d.GetCollaborationHostURL.URL;}};var E=function(b){jQuery.sap.log.error(JSON.stringify(b));e=b.response.statusCode;if(p){p.reject(e);}};o.read("/"+this.OdataUtilConstants.EndPoint.GetCollaborationHostUrl,{success:s,error:E,async:a});if(!p){return j;}},createJamUrlBatchOperation:function(o){var d=null;var p=null;var b;try{b=o.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.GetCollaborationHostUrl,this.OdataUtilConstants.HttpMethod.GET,d,p);}catch(e){jQuery.sap.log.error(e,"","sap.collaboration.components.utils.OdataUtil.createJamUrlBatchOperation()");throw e;}return b;},getJamToken:function(o){var j="";var e="";var s=function(d,r){j=d.GetSingleUseToken.Id;};var E=function(a){jQuery.sap.log.error(JSON.stringify(a));e=a.response.statusCode;};o.read("/"+this.OdataUtilConstants.EndPoint.GetSingleUseToken,null,null,false,s,E);if(e){throw new Error(e);}return j;},createJamTokenBatchOperation:function(o){var d=null;var p=null;var b;try{b=o.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.GetSingleUseToken,this.OdataUtilConstants.HttpMethod.GET,d,p);}catch(e){jQuery.sap.log.error(e,"","sap.collaboration.components.utils.OdataUtil.createJamTokenBatchOperation()");throw e;}return b;},getGroupsData:function(o,O){var g;var e="";var s=function(d,r){g=this.oCommonUtil.getODataResult(d);}.bind(this);var E=function(a){jQuery.sap.log.error(JSON.stringify(a));e=a.response.statusCode;};o.read(O,null,null,false,s,E);if(e){throw new Error(e);}return g;},createGetGroupsDataBatchOperation:function(o){var d=null;var p=null;var b;try{b=o.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.Groups,this.OdataUtilConstants.HttpMethod.GET,d,p);}catch(e){jQuery.sap.log.error(e,"","sap.collaboration.components.utils.OdataUtil.createGetGroupsDataBatchOperation()");throw e;}return b;},createGetGroupsCountBatchOperation:function(o){var d=null;var p=null;var b;try{b=o.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.GroupsCount,this.OdataUtilConstants.HttpMethod.GET,d,p);}catch(e){jQuery.sap.log.error(e,"","sap.collaboration.components.utils.OdataUtil.createGetGroupsCountDataBatchOperation()");throw e;}return b;},createGetGroupsLinkedToBOBatchOperation:function(o,e){var d=null;var p=null;var b;var O="/"+this.OdataUtilConstants.EndPoint.ExternalObjects+"(ApplicationContext='"+jQuery.sap.encodeURL(e.appContext.replace(/'/g,"''"))+"',"+"OdataServicePath='"+jQuery.sap.encodeURL(e.odataServicePath.replace(/'/g,"''"))+"',"+"OdataCollection='"+jQuery.sap.encodeURL(e.collection.replace(/'/g,"''"))+"',"+"OdataKey='"+jQuery.sap.encodeURL(e.key.replace(/'/g,"''"))+"')/"+this.OdataUtilConstants.EndPoint.GroupsAsFeatured;b=o.createBatchOperation(O,this.OdataUtilConstants.HttpMethod.GET,d,p);return b;},createGetObjectGroupsBatchOperation:function(o,b){var d=null;var p=null;var B;try{B=o.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.BusinessObjects+"('"+jQuery.sap.encodeURL(b)+"')/"+this.OdataUtilConstants.EndPoint.AssignedGroups,this.OdataUtilConstants.HttpMethod.GET,d,p);}catch(e){jQuery.sap.log.error(e,"","sap.collaboration.components.utils.OdataUtil.createGetObjectGroupsBatchOperation()");throw e;}return B;},getGroupIds:function(g){var G="";for(var i=0;i<g.length;i++){if(i==0){G+=g[i].Id;}else{G+=","+g[i].Id;}}return G;},createGroupFeed:function(o,g,f){var O="/"+this.OdataUtilConstants.EndPoint.Groups+"("+jQuery.sap.encodeURL(g)+")/"+this.OdataUtilConstants.EndPoint.Feed;var p={"Text":f};var s=undefined;var S=function(){s=true;};var e=function(E){jQuery.sap.log.error(JSON.stringify(E.response.body));s=false;};o.create(O,p,null,S,e);return s;},executeODataBatchRequest:function(o,r,p,a,e){var s=this;var R;var S=function(d){R=s.parseBatchResponse(d.__batchResponses);p(R);};var E=function(d){if(d.response){jQuery.sap.log.error(JSON.stringify(d.response.body));}else{jQuery.sap.log.error(JSON.stringify(d.message));}e(d);};var b=[];var c=[];for(var i in r){if(r[i].method==this.OdataUtilConstants.HttpMethod.GET){b.push(r[i]);}else if(r[i].method==this.OdataUtilConstants.HttpMethod.POST){c.push(r[i]);}}if(b.length>0){o.addBatchReadOperations(b);}for(var i=0;i<c.length;i++){o.addBatchChangeOperations([c[i]]);}if(a===true){o.submitBatch(S,E,true);}else{o.submitBatch(S,E,false);}},parseBatchResponse:function(b){var s=this;var r=[];jQuery.sap.each(b,function(i,R){if(R.statusCode&&R.statusCode.match(s.OdataUtilConstants.HttpStatusCode.success)){r.push(R.data);}else if(R.__changeResponses){for(var i=0;i<R.__changeResponses.length;i++){if(R.__changeResponses[i].statusCode&&(R.__changeResponses[i].statusCode.match(s.OdataUtilConstants.HttpStatusCode.created)||R.__changeResponses[i].statusCode.match(s.OdataUtilConstants.HttpStatusCode.success))){r.push(R.__changeResponses[i].data);}else{r.push({error:R.__changeResponses[i].response.body});jQuery.sap.log.error(JSON.stringify(R.__changeResponses[i].response.body),"sap.collaboration.components.utils.OdataUtil.parseBatchResponse()");}}}else{r.push({error:R.response.body});jQuery.sap.log.error(JSON.stringify(R.response.body),"sap.collaboration.components.utils.OdataUtil.parseBatchResponse()");}});return r;},createExternalOdataUrlBatchOperation:function(o,r){var p=null;var d=null;var b;try{b=o.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.GetExternalODataURL+"/?RelativePath='"+jQuery.sap.encodeURL(r)+"'",this.OdataUtilConstants.HttpMethod.GET,d,p);}catch(e){jQuery.sap.log.error(e,"","sap.collaboration.components.utils.OdataUtil.createExternalOdataUrlBatchOperation()");throw e;}return b;},getExternalOdataUrl:function(o,r){var e="";var E="";var u={};u["RelativePath"]="'"+r+"'";var s=function(d,a){e=d.GetExternalODataURL.URL;};var f=function(a){jQuery.sap.log.error(JSON.stringify(a));E=a.response.statusCode;};o.read("/"+this.OdataUtilConstants.EndPoint.GetExternalODataURL,null,u,false,s,f);if(E){throw new Error(E);}return e;},createNotificationUnreadCountBatchOperation:function(o){var d=null;var p=null;var b;try{b=o.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.GetNotificationUnreadCount,this.OdataUtilConstants.HttpMethod.GET,d,p);}catch(e){jQuery.sap.log.error(e,"","sap.collaboration.components.utils.OdataUtil.createNotificationUnreadCountBatchOperation()");throw e;}return b;},createNotificationBatchOperation:function(o,n){var d=null;var p=null;var b;try{b=o.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.Notifications+"?$top="+jQuery.sap.encodeURL(n.toString()),this.OdataUtilConstants.HttpMethod.GET,d,p);}catch(e){jQuery.sap.log.error(e,"","sap.collaboration.components.utils.OdataUtil.createNotificationBatchOperation()");throw e;}return b;},createGroupFeedBatchOperation:function(o,g,f){var O="/"+this.OdataUtilConstants.EndPoint.Groups+"("+jQuery.sap.encodeURL(g)+")/"+this.OdataUtilConstants.EndPoint.Feed;var d={"Text":f.note,"UiUrl":f.uiUrl};var p=null;var b;try{b=o.createBatchOperation(O,this.OdataUtilConstants.HttpMethod.POST,d,p);}catch(e){jQuery.sap.log.error(e,"","sap.collaboration.components.utils.OdataUtil.createGroupFeedBatchOperation()");throw e;}return b;},createUploadFileBatchOperation:function(o,a,g,f){var d=null;var p=null;var b;b=o.createBatchOperation("/"+this.OdataUtilConstants.EndPoint.PostContentItem+"/?name='"+jQuery.sap.encodeURL(a.name)+"'&"+"groupId='"+jQuery.sap.encodeURL(g)+"'&"+"mimeType='"+jQuery.sap.encodeURL(a.mimeType)+"'&"+"folderId='"+jQuery.sap.encodeURL(f)+"'&"+"url='"+jQuery.sap.encodeURL(a.url)+"'",this.OdataUtilConstants.HttpMethod.POST,d,p);return b;},uploadFile:function(o,a,g,f,s,e,A){var O=this.OdataUtilConstants.EndPoint.PostContentItem;var u=function(){s();};var U=function(){jQuery.sap.log.error(a.name+" was not uploaded","","sap.collaboration.components.utils.OdataUtil.uploadFile()");e();};o.callFunction(O,'POST',{name:a.name,groupId:g,mimeType:a.mimeType,url:a.url,folderId:f},null,u,U,A);},getSubFolders:function(o,g,f,s,t){var O;if(!f&&g){O="/"+this.OdataUtilConstants.EndPoint.Groups+"('"+jQuery.sap.encodeURL(g)+"')/"+this.OdataUtilConstants.EndPoint.Folders;}else{O="/"+this.OdataUtilConstants.EndPoint.Folders+"(Id='"+jQuery.sap.encodeURL(f)+"',FolderType='Folder')/"+this.OdataUtilConstants.EndPoint.Folders;}O=O+'?$skip='+s+'&$top='+t+'&$inlinecount=allpages';var F=[];var c=0;var e="";var S=function(d,r){if(d){F=this.oCommonUtil.getODataResult(d);c=parseInt(JSON.parse(r.body).d.__count);}}.bind(this);var E=function(a){jQuery.sap.log.error(JSON.stringify(a));e=a.response.statusCode;};o.read(O,null,null,false,S,E);if(e){throw new Error(e);}return{folders:F,count:c};},createShareFeaturedObjectBatchOperation:function(o,e,g){var O="/"+this.OdataUtilConstants.EndPoint.Groups+"("+jQuery.sap.encodeURL(g)+")/"+this.OdataUtilConstants.EndPoint.FeaturedExternalObjects;var d={"ApplicationContext":e.appContext,"OdataServicePath":e.odataServicePath,"OdataCollection":e.collection,"OdataKey":e.key,"Name":e.name,"Summary":e.summary,"UiUrl":e.uiUrl,"Comment":e.note};var p=null;var b;b=o.createBatchOperation(O,this.OdataUtilConstants.HttpMethod.POST,d,p);return b;},getExternalObjectMapping:function(o,i,p){var O="/"+this.OdataUtilConstants.EndPoint.MapInternalBOToExternalBO;var u={};u["ApplicationContext"]="'"+i.appContext+"'";u["ODataCollection"]="'"+i.collection+"'";u["ODataKeyPredicate"]="'"+i.key+"'";u["ODataServicePath"]="'"+i.odataServicePath+"'";var e="";var s=function(d,r){p.resolve(d.MapInternalBOToExternalBO);};var E=function(a){jQuery.sap.log.error(JSON.stringify(a));e=a.response.statusCode;p.reject(e);};o.read(O,null,u,true,s,E);},_GetJamExternalObject:function(o,e,E,s,f){var O="/"+this.OdataUtilConstants.EndPoint.ExternalObjects_FindByExidAndObjectType+"/?Exid='"+jQuery.sap.encodeURL(e)+"'&"+"ObjectType='"+jQuery.sap.encodeURL(E);var S=function(){s();};var a=function(b){jQuery.sap.log.error(JSON.stringify(b.response.body));f();};o.read(O,null,null,false,S,a);}});
