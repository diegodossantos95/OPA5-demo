sap.ui.define(["sap/suite/ui/commons/library","./ElementBase","./layout/Geometry","./Coordinate","./Utils"],function(l,E,G,C,U){var A=l.networkgraph.LineArrowPosition,L=l.networkgraph.LineType,a=l.networkgraph.LineArrowOrientation,O=l.networkgraph.Orientation,S=l.networkgraph.ElementStatus;var c=15,B=10,F=5;var r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var d=E.extend("sap.suite.ui.commons.networkgraph.Line",{metadata:{library:"sap.suite.ui.commons",properties:{selected:{type:"boolean",group:"Misc",defaultValue:false},from:{type:"string",group:"Misc",defaultValue:null},to:{type:"string",group:"Misc",defaultValue:null},status:{type:"sap.suite.ui.commons.networkgraph.ElementStatus",group:"Appearance",defaultValue:S.Standard},lineType:{type:"sap.suite.ui.commons.networkgraph.LineType",group:"Appearance",defaultValue:L.Solid},arrowPosition:{type:"sap.suite.ui.commons.networkgraph.LineArrowPosition",group:"Appearance",defaultValue:A.End},arrowOrientation:{type:"sap.suite.ui.commons.networkgraph.LineArrowOrientation",group:"Appearance",defaultValue:a.ParentOf}},aggregations:{coordinates:{type:"sap.suite.ui.commons.networkgraph.Coordinate",multiple:true,singularName:"coordinate"}},events:{press:{}}},renderer:function(R,o){R.write(o._render());},onAfterRendering:function(){this._afterRenderingBase();},init:function(){this._oFrom=null;this._oTo=null;this._bFocusRendered=false;this._sKey="";this._bIsHidden=false;}});d.prototype.aProcessRequiredProperties=["from","to"];d.prototype._afterRendering=function(){this._setupEvents();if(this.getFromNode()._bIsHidden||this.getToNode()._bIsHidden){this.$().hide();}};d.prototype._render=function(o){var s="",b=this.getSelected()?" "+this.SELECT_CLASS+" ":"",R;var f=function(g,i){return this._renderControl("path",{d:R,"class":g||this._getLineClass(),from:this.getFromNode().getKey(),to:this.getToNode().getKey(),id:i?this._getDomId(i):""});}.bind(this);var e=function(){var g=this._getArrowPosition(),h={p1:g.arrowFrom,p2:g.arrowTo,"class":"sapSuiteUiCommonsNetworkLineArrow",width:12,height:8,invert:this.getArrowOrientation()===a.ChildOf,absolutePosition:c};if(this.getArrowPosition()===A.Middle){h.relativePosition=0.5;}return this._renderControl("path",this._createArrow(h));}.bind(this);this._bFocusRendered=false;if(this._isIgnored()){return"";}R=this._createPath();s+=this._renderControl("g",{"class":"sapSuiteUiCommonsNetworkLine "+this._getStatusClass()+b,id:this.getId()},false);s+=f("sapSuiteUiCommonsNetworkLineInvisibleWrapper","invisibleWrapper");s+=f();if(this.getArrowOrientation()!==a.None){s+=e();}s+="</g>";return s;};d.prototype._renderFocusWrapper=function(){var f=function(s){var p=this._createElement("path",{d:this._createPath(s),"class":"sapSuiteUiCommonsNetworkLineFocus"});this.$()[0].appendChild(p);}.bind(this);if(!this._bFocusRendered){f(F);f(-F);this._bFocusRendered=true;}};d.prototype._createArrow=function(m){var y=m.p2.y-m.p1.y,x=m.p2.x-m.p1.x,R=Math.atan2(y,x),f=R*180/Math.PI,h=m.height/2,t,o,s,D,i;var g=function(e){return{x:e*Math.cos(R),y:e*Math.sin(R)};};var b=function(){var e;if(!this.getParent()._isLayered()){e=g(this.getFromNode()._iHeight/2);return{x:o.x+(e.x*i),y:o.y+(e.y*i)};}return{x:o.x,y:o.y};}.bind(this);if(m.invert){f+=180;}if(m.relativePosition){t="translate("+(m.p1.x+(x*m.relativePosition))+" "+(m.p1.y+y*m.relativePosition)+")"+" rotate("+f+")";}else{o=this._isEndPosition()?m.p2:m.p1;i=this._isEndPosition()?-1:1;s=b();D=g(m.absolutePosition);t="translate("+(s.x+(D.x*i))+" "+(s.y+(D.y*i))+")"+" rotate("+f+")";}m.d="M "+m.width/2+",0"+" L "+(-1*m.width/2)+","+h+" L "+(-1*m.width/2)+","+(-1*h)+" Z";m.transform=t;return m;};d.prototype._createPath=function(s){var p="M"+this.getSource().getX()+","+this.getSource().getY();for(var i=0;i<this.getBends().length;i++){p+=" L"+this.getBends()[i].getX()+","+this.getBends()[i].getY();}p+=" L"+this.getTarget().getX()+","+this.getTarget().getY();return G.getBezierPathCorners(p,B,s);};d.prototype._getLineClass=function(){var g=function(){switch(this.getLineType()){case L.Dashed:return"sapSuiteUiCommonsNetworkDashedLine";case L.Dotted:return"sapSuiteUiCommonsNetworkDottedLine";default:return"";}}.bind(this);return"sapSuiteUiCommonsNetworkLinePath "+g();};d.prototype._getArrowPosition=function(){var f=function(n,o,g){var v=this._isTopBottom()?"y":"x",V=this._isTopBottom()?"x":"y",m;if(g[V]!==o[V]){return;}if(!n._isBox()&&!(n._oGroup&&n._oGroup.getCollapsed())){m=o[v]>g[v];o[v]=m?n._getCirclePosition()[v]:n._getCircleSize()+n._getCirclePosition()[v];}}.bind(this);var p=this.getParent(),b=5,s={x:this.getSource().getX(),y:this.getSource().getY()},t={x:this.getTarget().getX(),y:this.getTarget().getY()},e=this.getBends();if(e.length>0){if(this._moveToEnd()){s.x=e[e.length-1].getX()+(this._isTopBottom()?0:b);s.y=e[e.length-1].getY()+(this._isTopBottom()?b:0);}else{t.x=e[0].getX()+(this._isTopBottom()?0:b);t.y=e[0].getY()+(this._isTopBottom()?b:0);}}if(p&&p._isLayered()){if(e.length===0){f(this._oTo,t,s);f(this._oFrom,s,t);}else if(this._moveToEnd()){f(this._oTo,t,s);}else{f(this._oFrom,s,t);}}return{arrowFrom:{x:s.x,y:s.y},arrowTo:{x:t.x,y:t.y}};};d.prototype._getAccessibilityLabel=function(){return r.getText("NETWORK_GRAPH_ACCESSIBILITY_LINE_LABEL",[this.getFromNode().getTitle(),this.getToNode().getTitle()])+" "+this.getTitle();};d.prototype.getFromNode=function(){this._checkForProcessData();if(!this._oFrom&&this.getParent()){this._oFrom=this.getParent().getNodeByKey(this.getFrom());}return this._oFrom;};d.prototype.getToNode=function(){this._checkForProcessData();if(!this._oTo&&this.getParent()){this._oTo=this.getParent().getNodeByKey(this.getTo());}return this._oTo;};d.prototype.setSource=function(m){var o;if(this.getCoordinates().length===0){o=new C();this.addAggregation("coordinates",o,true);}o=this.getCoordinates()[0];if(m.x||m.x===0){o.setX(m.x);}if(m.y||m.y===0){o.setY(m.y);}};d.prototype.getSource=function(){return this.getCoordinates()[0];};d.prototype.getTarget=function(){return this.getCoordinates().length>0?this.getCoordinates()[this.getCoordinates().length-1]:null;};d.prototype.setTarget=function(m){var o;if(this.getCoordinates().length<2){o=new C();this.addAggregation("coordinates",o,true);}o=this.getCoordinates()[this.getCoordinates().length-1];if(m.x||m.x===0){o.setX(m.x);}if(m.y||m.y===0){o.setY(m.y);}};d.prototype.getBends=function(){return this.getCoordinates().filter(function(o,i){return(i>0)&&(i<(this.getCoordinates().length-1));},this);};d.prototype.clearBends=function(){this.getBends().forEach(function(b){this.removeAggregation("coordinates",b,true);},this);};d.prototype.addBend=function(p){var n=new C();n.setX(p.x);n.setY(p.y);this.insertAggregation("coordinates",n,this.getCoordinates().length-1,true);return n;};d.prototype.isHidden=function(){return this._bIsHidden;};d.prototype.getKey=function(){return this._getLineId();};d.prototype._isIgnored=function(){var f=this.getFromNode(),t=this.getToNode(),i=f._oGroup&&f._oGroup.getCollapsed()&&t._oGroup&&t._oGroup.getCollapsed()&&f._oGroup===t._oGroup;return i||this._isLoop();};d.prototype._isLoop=function(){return this.getFromNode().getId()===this.getToNode().getId();};d.prototype._getLineId=function(){return this._sKey?this._sKey:"line_"+this.getFrom()+"-"+this.getTo();};d.prototype._setupEvents=function(){var $=this.$().find(".sapSuiteUiCommonsNetworkLineInvisibleWrapper");$.click(function(e){this._click({ctrlKey:e.ctrlKey,clientX:e.clientX,clientY:e.clientY});}.bind(this));$.mouseover(function(e){this._mouseOver();}.bind(this));$.mouseout(function(e){this._mouseOut();}.bind(this));};d.prototype._mouseOut=function(){this.$().removeClass(this.HIGHLIGHT_CLASS);};d.prototype._mouseOver=function(){this.$().addClass(this.HIGHLIGHT_CLASS);};d.prototype._click=function(m){var p=this.getParent(),P=p.getCorrectMousePosition({x:m.clientX+10,y:m.clientY}),e=this.fireEvent("press",{point:P},true);p._selectLine({element:this,preventDeselect:m.ctrlKey});if(this.getSelected()&&e){p._tooltip.openDetail({item:this,point:P});}};d.prototype._setFocus=function(f){E.prototype._setFocus.call(this,f);if(f){this._renderFocusWrapper();}};d.prototype._isEndPosition=function(){return((this.getArrowPosition()===A.End&&this.getArrowOrientation()===a.ParentOf)||(this.getArrowPosition()===A.Start&&this.getArrowOrientation()===a.ChildOf));};d.prototype._moveToEnd=function(){return this._isEndPosition()||(this.getArrowPosition()===A.Middle&&this.getArrowOrientation()===a.ParentOf);};d.prototype._hideShow=function(b){if(b){this.$().hide();this._bIsHidden=true;}else if(!this.getToNode()._bIsHidden&&!this.getFromNode()._bIsHidden){this.$().show();this._bIsHidden=false;}};d.prototype._shift=function(p){this.getBends().forEach(function(b){b.setX(b.getX()+p.x);b.setY(b.getY()+p.y);});if(this.getSource()){this.setSource({x:this.getSource().getX()+p.x,y:this.getSource().getY()+p.y});}if(this.getTarget()){this.setTarget({x:this.getTarget().getX()+p.x,y:this.getTarget().getY()+p.y});}};d.prototype._validateLayout=function(){return isFinite(this.getSource().getX())&&isFinite(this.getSource().getY())&&isFinite(this.getTarget().getX())&&isFinite(this.getTarget().getY())&&!this.getBends().some(function(b){return!isFinite(b.getX())||!isFinite(b.getY());});};d.prototype.setSelected=function(s){var p=this.getParent(),f=s?"addClass":"removeClass";this.setProperty("selected",s,true);this.$()[f](this.SELECT_CLASS);if(p){if(s){p._mSelectedLines[this._getLineId()]=this;}else{delete p._mSelectedLines[this._getLineId()];}}return this;};d.prototype.setFrom=function(f){var p=this.getParent();this.setProperty("from",f,true);if(p){p.invalidate();}return this;};d.prototype.setTo=function(t){var p=this.getParent();this.setProperty("to",t,true);if(p){p.invalidate();}return this;};d.prototype._isTopBottom=function(){var p=this.getParent();return p.getOrientation()===O.TopBottom||p.getOrientation()===O.BottomTop;};d.prototype._useAbsoluteArrowPosition=function(){return this.getArrowPosition()!==A.MIDDLE;};d.prototype.getFocusDomRef=function(){return this.getDomRef("invisibleWrapper");};d.prototype._createSuggestionHelpText=function(){var b=25;var t=this.getTitle()?(this.getTitle()+" "):"";return t+"("+U.trimText(this.getFromNode().getTitle(),b)+" -> "+U.trimText(this.getToNode().getTitle(),b)+")";};d.prototype._isInCollapsedGroup=function(){var f=this.getFromNode(),t=this.getToNode();return(f._oGroup===t._oGroup)&&f._isInCollapsedGroup();};return d;});
