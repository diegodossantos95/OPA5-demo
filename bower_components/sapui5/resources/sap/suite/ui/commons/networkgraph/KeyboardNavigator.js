sap.ui.define(["jquery.sap.global","sap/ui/base/Object","./Group","./Node","./Line"],function(q,B,G,N,L){var d={LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down"};var r=/^on.*|setFocus|setItems$/;function w(k){var s,p=k.prototype;for(s in p){if(p.hasOwnProperty(s)&&(typeof p[s]==="function")&&r.test(s)){p[s]=b(p[s]);}}}function b(o){return function(){try{return o.apply(this,arguments);}catch(e){this._handleError(e);}return undefined;};}var K=B.extend("sap.suite.ui.commons.networkgraph.KeyboardNavigator",{constructor:function(g){B.apply(this,arguments);this._oGraph=g;this._aItems=[[]];this._iRows=0;this._iColumns=0;this._iPageSize=5;this._oFocus=null;this._oFocusPosition=null;this._oWrapperDom=null;}});K.prototype.getFocus=function(){var g=this._oGraph.getFocus();if(this._oFocus!==g){this._oFocus=g?{item:g.item,button:g.button}:null;this._oFocusPosition=null;}return this._oFocus?{item:this._oFocus.item,button:this._oFocus.button}:null;};K.prototype.getFocusPosition=function(){var f=this.getFocus();if(!this._oFocusPosition){var x,y;this._oFocusPosition={iX:null,iY:null};if(!f){return this._oFocusPosition;}for(y=0;y<this._aItems.length;y++){for(x=0;x<this._aItems[y].length;x++){if(this._aItems[y][x]===f.item){this._oFocusPosition={iX:x,iY:y};return this._oFocusPosition;}}}}return this._oFocusPosition;};K.prototype.setItems=function(i){this._aItems=i;this._iRows=i.length;this._iColumns=0;i.forEach(function(R){if(this._iColumns<R.length){this._iColumns=R.length;}},this);};K.prototype.setWrapperDom=function(D){this._oWrapperDom=D;};K.prototype.setPageSize=function(s){this._iPageSize=s;};K.prototype.onfocusout=function(e){if(this._ignoreEvent(e)){return;}this._oGraph.defocus();this._oGraph._updateAccessibility(null);};K.prototype.onsapend=function(e){this._moveThroughMatrix(e,true,true);};K.prototype.onsaphome=function(e){this._moveThroughMatrix(e,true,false);};K.prototype.onsapendmodifiers=function(e){if(e.ctrlKey){this._moveThroughMatrix(e,false,true);}};K.prototype.onsaphomemodifiers=function(e){if(e.ctrlKey){this._moveThroughMatrix(e,false,false);}};K.prototype.onsappagedown=function(e){this._moveThroughMatrix(e,false,true,this._iPageSize);};K.prototype.onsappageup=function(e){this._moveThroughMatrix(e,false,false,this._iPageSize);};K.prototype.onsappagedownmodifiers=function(e){if(e.altKey){this._moveThroughMatrix(e,true,true,this._iPageSize);}};K.prototype.onsappageupmodifiers=function(e){if(e.altKey){this._moveThroughMatrix(e,true,false,this._iPageSize);}};K.prototype.onsapspace=function(e){this._selectElement(false);e.stopPropagation();};K.prototype.onsapspacemodifiers=function(e){if(e.ctrlKey){this._selectElement(true);e.stopPropagation();}};K.prototype.onsapenter=function(e){this._handleEnter();};K.prototype.onsaptabnext=function(e){this._handleTab(e,d.RIGHT);};K.prototype.onsaptabprevious=function(e){this._handleTab(e,d.LEFT);};K.prototype.onsapleft=function(e){this._handleArrow(e,d.LEFT);};K.prototype.onsapright=function(e){this._handleArrow(e,d.RIGHT);};K.prototype.onsapup=function(e){this._handleArrow(e,d.UP);};K.prototype.onsapdown=function(e){this._handleArrow(e,d.DOWN);};K.prototype.onkeydown=function(e){var i,o,f=this.getFocus();if(!f){return;}i=f.item;o=f.button;if(e.ctrlKey&&e.keyCode===q.sap.KeyCodes.A){this._onCtrlA(e);}else if(e.keyCode===q.sap.KeyCodes.F2){if(i instanceof N){if(i.hasVisibleActionButtons()){i._detailClick();}}else if(i instanceof G){i._openDetail();}e.stopPropagation();}else if(e.keyCode===q.sap.KeyCodes.F6){if(i&&o){f.button=null;this._oGraph.setFocus(f);}this._handleArrow(e,e.shiftKey?d.LEFT:d.RIGHT);}else if(e.keyCode===q.sap.KeyCodes.F7&&!e.shiftKey){if(i&&o){f.button=null;this._oGraph.setFocus(f);}}else if(e.ctrlKey&&e.keyCode===q.sap.KeyCodes.DIGIT_0){this._onCtrl0(e);}else if(e.ctrlKey&&(e.keyCode===q.sap.KeyCodes.PLUS||e.keyCode===q.sap.KeyCodes.NUMPAD_PLUS)){this._onCtrlPlus(e);}else if(e.ctrlKey&&(e.keyCode===q.sap.KeyCodes.SLASH||e.keyCode===q.sap.KeyCodes.NUMPAD_MINUS)){this._onCtrlMinus(e);}};K.prototype._handleEnter=function(){var i,o,f=this.getFocus(),a;if(!f){return;}i=f.item;o=f.button;if(i instanceof N){if(o){a=i.getEnabledActionButtons().indexOf(o);i._aActionButtonsClicks[a].call();}else{i.showActionButtons(!i.hasVisibleActionButtons());}}else if(i instanceof L){i.getParent()._tooltip.openDetail({item:i,point:i._getArrowPosition().arrowTo});}else if(i instanceof G){if(o===G.BUTTONS.MENU){i._openDetail();}else if(o===G.BUTTONS.COLLAPSE){i._collapse();}}};K.prototype._handleTab=function(e,D){if(this._ignoreEvent(e)){return;}if(this._handleTabOverNodeWithButtons(e,D)||this._handleTabOverGroupWithButtons(e,D)){e.preventDefault();e.stopPropagation();return;}this._moveItemFocus(e,D);};K.prototype._handleTabOverNodeWithButtons=function(e,D){var f=this.getFocus(),i,o,a,A=false,c;if(!f){return false;}i=f.item;o=f.button;a=i&&i.getEnabledActionButtons?i.getEnabledActionButtons():[];if(!(i instanceof N)||!i.hasVisibleActionButtons()||a.length===0){return false;}if(o){c=a.indexOf(o);if(D===d.RIGHT){if(c===(a.length-1)){this._moveItemFocus(e,D);}else{this._setActionButtonFocus(a[c+1]);}A=true;}else if(D===d.LEFT){if(c===0){this._moveItemFocus(e,this.getFocusPosition());}else{this._setActionButtonFocus(a[c-1]);}A=true;}}else if(D===d.RIGHT){this._setActionButtonFocus(a[0]);A=true;}return A;};K.prototype._handleTabOverGroupWithButtons=function(e,D){var f=this.getFocus(),i,o;if(!f){return false;}i=f.item;o=f.button;if(i instanceof G){if(o){if(o===G.BUTTONS.MENU){if(D===d.RIGHT){f.button=G.BUTTONS.COLLAPSE;this._oGraph.setFocus(f);return true;}else if(D===d.LEFT){f.button=null;this._oGraph.setFocus(f);return true;}}else if(o===G.BUTTONS.COLLAPSE){if(D===d.RIGHT){this._moveItemFocus(e,D);f=this.getFocus();f.button=null;this._oGraph.setFocus(f);return true;}else if(D===d.LEFT){f.button=G.BUTTONS.MENU;this._oGraph.setFocus(f);return true;}}}else{if(D===d.RIGHT){f.button=G.BUTTONS.MENU;this._oGraph.setFocus(f);return true;}else if(D===d.LEFT){this._moveItemFocus(e,D);return true;}}}return false;};K.prototype._setActionButtonFocus=function(a){var f=this.getFocus();if(!f){return;}f.button=a;this._oGraph.setFocus(f);};K.prototype._selectElement=function(c){var f=this.getFocus(),i;if(!f){return;}i=f.item;if(i instanceof N){i.getParent()._selectNode({element:i,setFocus:false,renderActionButtons:false,preventDeselect:c});}else if(i instanceof L){i.getParent()._selectLine({element:i,setFocus:false,preventDeselect:c});}};K.prototype._moveThroughMatrix=function(e,R,t,T){var f=this.getFocus(),I,c,C,n;if(this._ignoreEvent(e)||!f){return;}I=f.item;C=0;T=T||Number.POSITIVE_INFINITY;for(var i=(R?this.getFocusPosition().iX:this.getFocusPosition().iY)+(t?1:-1);(t&&i<(R?this._iColumns:this._iRows))||(!t&&i>=0);i+=(t?1:-1)){c=this._aItems[R?this.getFocusPosition().iY:i][R?i:this.getFocusPosition().iX];if(c&&C<T){n=c;C++;}}if(n!==I){f.item=n;f.button=null;this._oGraph.setFocus(f);e.stopPropagation();}};K.prototype._handleArrow=function(e,D){if(this._ignoreEvent(e)||!this.getFocus()){return;}this._moveItemFocus(e,D);};K.prototype._moveItemFocus=function(e,D){var f,a=(D===d.LEFT&&e.key==="Tab"),p,n,c;if(typeof D==="string"){p=this._findNextPosition(D);}else{p=D;}n=this._getItemAtPosition(p);f={item:n,button:null};if(a&&n!==null){if(n instanceof N&&n.hasVisibleActionButtons()){c=n.getEnabledActionButtons();if(c.length>0){f.button=c[c.length-1];}}else if(n instanceof G){f.button=G.BUTTONS.COLLAPSE;}}this._oGraph.setFocus(f);if(e&&n){e.preventDefault();e.stopPropagation();}};K.prototype._getItemAtPosition=function(p){var a;if(!p||p.iX===null){return null;}else{a=this._aItems[p.iY];return a?a[p.iX]:null;}};K.prototype._findNextPosition=function(D){var x,y;if(this.getFocusPosition().iX===null){if(D===d.LEFT){x=this._iColumns-1;y=this._iRows-1;}else{x=0;y=0;}if(this._aItems[y][x]!==null){return{iX:x,iY:y};}}else{x=this.getFocusPosition().iX;y=this.getFocusPosition().iY;}do{switch(D){case d.RIGHT:x+=1;if(x>=this._iColumns){y+=1;x=0;}break;case d.LEFT:x-=1;if(x<0){y-=1;x=this._iColumns-1;}break;case d.UP:y-=1;if(y<0&&x>0){x-=1;y=this._iRows-1;}break;case d.DOWN:y+=1;if(y>=this._iRows&&x<this._iColumns-1){x+=1;y=0;}break;default:throw new Error("Unexpected direction: "+D);}}while(y>=0&&y<this._iRows&&this._aItems[y][x]===null);if(y<0||y>=this._iRows){return null;}else{return{iX:x,iY:y};}};K.prototype._onCtrlA=function(e){if(this._ignoreEvent(e)){return;}var a=true;this._forEach(function(i){if(i instanceof G){return false;}if(!i.getSelected()){a=false;return true;}return false;});a=!a;this._forEach(function(i){if(!(i instanceof G)){i.setSelected(a);}});e.preventDefault();e.stopPropagation();};K.prototype._forEach=function(c){var x,y,i,a;for(y=0;y<this._iRows;y++){for(x=0;x<this._iColumns;x++){i=this._aItems[y][x];if(i){a=c.call(this,i,x,y);if(a){return;}}}}};K.prototype._onCtrl0=function(e){this._oGraph._zoom({newIndex:this._oGraph.ZOOM_100_INDEX});e.preventDefault();e.stopPropagation();};K.prototype._onCtrlPlus=function(e){this._oGraph._zoom({deltaY:1});e.preventDefault();e.stopPropagation();};K.prototype._onCtrlMinus=function(e){this._oGraph._zoom({deltaY:-1});e.preventDefault();e.stopPropagation();};K.prototype._ignoreEvent=function(e){return!q.sap.containsOrEquals(this._oWrapperDom,e.target);};K.prototype._handleError=function(e){q.sap.log.error("An error in KeyboardNavigator: "+e);};w(K);return K;});
