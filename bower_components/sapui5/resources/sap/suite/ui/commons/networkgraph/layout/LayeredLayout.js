sap.ui.define(["jquery.sap.global","sap/suite/ui/commons/library","./LayoutAlgorithm","./Geometry","./KlayWrapper","./LayoutTask"],function(q,l,L,G,K,a){var O=l.networkgraph.Orientation,N=l.networkgraph.NodePlacement;var b=30,c=34,d=25,e=17,f=4,g="N_",h="G_",i=2;var n=(function(){var m={};m[N.BrandesKoepf]="BRANDES_KOEPF";m[N.LinearSegments]="LINEAR_SEGMENTS";m[N.Simple]="SIMPLE";return Object.freeze(m);})();var j=L.extend("sap.suite.ui.commons.networkgraph.layout.LayeredLayout",{metadata:{library:"sap.suite.ui.commons",properties:{nodeSpacing:{type:"float",group:"Behavior",defaultValue:55},lineSpacingFactor:{type:"float",group:"Behavior",defaultValue:0.25},nodePlacement:{type:"sap.suite.ui.commons.networkgraph.NodePlacement",group:"Behavior",defaultValue:N.BrandesKoepf},mergeEdges:{type:"boolean",group:"Behavior",defaultValue:false}}}});j.prototype.isLayered=function(){return true;};j.prototype.layout=function(){return new a(function(r,R,o){var k=this.getParent();if(!k){R("The algorithm must be associated with a graph.");return;}this.oGraph=k;this.oKGraph={children:[],edges:[]};this.mLineMap={};q.sap.measure.start("NetworkGraph - LayeredLayout","Layouting of a graph "+k.getId());k.getGroups().forEach(this._addGroupToKlay,this);k.getNodes().forEach(this._addNodeToKlay,this);k.getLines().forEach(this._addLineToKlay,this);K.layout({graph:this.oKGraph,options:this._getOptions(),success:function(m){if(o.isTerminated()){r();return;}this._copyStuffWithoutPrefixes(m);m.children.forEach(function(p){this._extractNodeFromKlay(p);},this);m.edges.forEach(function(p){this._extractLineFromKlay(p);},this);this._makeExpandedGroupsBoxesAroundNodes();this._assertPositiveCoordinates();this._shrinkGroupsDownward();this._stretchLinesToCircleAxes();if((!this.oGraph._bIsRtl&&this.oGraph.getOrientation()===O.RightLeft)||(this.oGraph._bIsRtl&&this.oGraph.getOrientation()!==O.RightLeft)){this._verticalMirror();}q.sap.measure.end("NetworkGraph - LayeredLayout");r();}.bind(this),error:function(m){R(m);}});}.bind(this));};j.prototype._buildNodeForKlay=function(o){var p={};if(!o._isBox()){if(this.oGraph.getOrientation()!==O.TopBottom){var B=o._iHeight-o._getCircleSize()+f;p={additionalPortSpace:"top="+f+", bottom="+B};}else{var s=(o._iWidth-o._getCircleSize())/2+f;p={additionalPortSpace:"top="+s+", bottom="+s};}}return{id:g+o.getKey(),width:o._iWidth,height:o._iHeight,properties:p};};j.prototype._addGroupToKlay=function(o){if(o.aNodes.length===0){return;}var k={id:h+o.getKey(),width:o._iWidth,height:o._iHeight};this.oKGraph.children.push(k);if(!o.getCollapsed()){o.aNodes.forEach(function(m){if(!k.children){k.children=[];}k.children.push(this._buildNodeForKlay(m));},this);}};j.prototype._addNodeToKlay=function(o){if(!o._oGroup){this.oKGraph.children.push(this._buildNodeForKlay(o));}};j.prototype._addLineToKlay=function(o){var s,t,k;if(!o._isIgnored()){s=o.getFromNode()._oGroup&&o.getFromNode()._oGroup.getCollapsed()?h+o.getFromNode()._oGroup.getKey():g+o.getFrom();t=o.getToNode()._oGroup&&o.getToNode()._oGroup.getCollapsed()?h+o.getToNode()._oGroup.getKey():g+o.getTo();k=s+"->"+t+"["+this.oKGraph.edges.length+"]";this.oKGraph.edges.push({id:k,source:s,target:t});this.mLineMap[k]=o;}};j.prototype._getOptions=function(){var o=this.oGraph.getOrientation(),D;switch(o){case O.LeftRight:case O.RightLeft:D="RIGHT";break;case O.TopBottom:D="DOWN";break;default:D="RIGHT";}return{direction:D,spacing:this.getNodeSpacing(),nodePlace:n[this.getNodePlacement()],edgeSpacingFactor:this.getLineSpacingFactor(),mergeEdges:this.getMergeEdges()};};j.prototype._verticalMirror=function(){var p=this._getNodesPoints(this.oGraph.getNodes()).concat(this._getNodesPoints(this.oGraph.getGroups())).concat(this._getLinesPoints()),B=G.getBoundingBox(p),A=(B.p1.x+B.p2.x);this.oGraph.getNodes().forEach(function(o){o.setX(A-(o.getX()+o._iWidth));});this.oGraph.getGroups().forEach(function(o){o.setX(A-(o.getX()+o._iWidth));});this.oGraph.getLines().forEach(function(o){if(o._isIgnored()){return;}o.setSource({x:A-o.getSource().getX()});o.setTarget({x:A-o.getTarget().getX()});o.getBends().forEach(function(k){k.setX(A-k.getX());});});};j.prototype._extractNodeFromKlay=function(k){var I=k.id.substring(0,i)===g?this.oGraph.getNodeByKey(k.originalId):undefined,o;if(!I){I=this.oGraph.mGroups[k.originalId];if(I&&!I.getCollapsed()&&k.children){k.children.forEach(function(m){o=this.oGraph.getNodeByKey(m.originalId);if(o){o.setX(m.x+k.x);o.setY(m.y+k.y);}},this);}}if(I){I.setX(k.x);I.setY(k.y);}};j.prototype._extractLineFromKlay=function(k){var o=this.mLineMap[k.id];o.setSource({x:k.sourcePoint.x,y:k.sourcePoint.y});o.setTarget({x:k.targetPoint.x,y:k.targetPoint.y});o.clearBends();if(k.bendPoints){k.bendPoints.forEach(function(m){o.addBend(m);});}if(o.getFromNode()._oGroup&&!o.getFromNode()._oGroup.getCollapsed()){o._shift({x:o.getFromNode()._oGroup.getX(),y:o.getFromNode()._oGroup.getY()});}};j.prototype._stretchLinesToCircleAxes=function(){var H=this.oGraph.getOrientation()!=O.TopBottom,F,t;this.oGraph.getLines().forEach(function(o){if(o._isIgnored()){return;}F=o.getFromNode();t=o.getToNode();if(H){if(!F._isBox()&&!F._isIgnored()){o.getSource().setX(F.getX()+F._iWidth/2);}if(!t._isBox()&&!t._isIgnored()){o.getTarget().setX(t.getX()+t._iWidth/2);}}else{if(!F._isBox()&&!F._isIgnored()){o.getSource().setY(F.getY()+F._getCircleSize()/2);}if(!t._isBox()&&!t._isIgnored()){o.getTarget().setY(t.getY()+t._getCircleSize()/2);}}});};j.prototype._getNodesPoints=function(k){var p=[];k.forEach(function(o){p.push({x:o.getX(),y:o.getY()});p.push({x:o.getX()+o._iWidth,y:o.getY()+o._iHeight});});return p;};j.prototype._getLinesPoints=function(){var p=[];this.oGraph.getLines().forEach(function(o){if(o._isIgnored()){return;}p.push({x:o.getSource().getX(),y:o.getSource().getY()});p.push({x:o.getTarget().getX(),y:o.getTarget().getY()});o.getBends().forEach(function(B){p.push({x:B.getX(),y:B.getY()});});});return p;};j.prototype._makeExpandedGroupsBoxesAroundNodes=function(){var p=[],B;this.oGraph.getGroups().forEach(function(o){if(o.getCollapsed()||o.aNodes.length===0){return;}p=this._getNodesPoints(o.aNodes);B=G.getBoundingBox(p);G.enlargeBox(B,d);o.setX(B.p1.x);o.setY(B.p1.y-c);o._iWidth=B.p2.x-B.p1.x;o._iHeight=B.p2.y-B.p1.y+c;},this);};j.prototype._assertPositiveCoordinates=function(){var x=b,y=b;this.oGraph.getNodes().forEach(function(o){if(o.getX()<x){x=o.getX();}if(o.getY()<y){y=o.getY();}});this.oGraph.getGroups().forEach(function(o){if(o.getX()<x){x=o.getX();}if(o.getY()<y){y=o.getY();}});if(x<b||y<b){x-=b;y-=b;this.oGraph.getGroups().forEach(function(o){o.setX(o.getX()-x);o.setY(o.getY()-y);});this.oGraph.getNodes().forEach(function(o){o.setX(o.getX()-x);o.setY(o.getY()-y);o.aLines.forEach(function(k){k._shift({x:-x,y:-y});});});}};j.prototype._shrinkGroupsDownward=function(){var k;this.oGraph.getGroups().forEach(function(o){if(o.getCollapsed()){return;}o.aNodes.forEach(function(m){k=(o.getY()+o._iHeight-m.getY())/o._iHeight;m.setY(m.getY()+k);});o.setY(o.getY()+e);o._iHeight-=e;});};j.prototype._copyStuffWithoutPrefixes=function(k){k.children.forEach(function(o){o.originalId=o.id.substring(i);if(o.children){o.children.forEach(function(m){m.originalId=m.id.substring(i);});}});k.edges.forEach(function(o){o.originalSource=o.source.substring(i);o.originalTarget=o.target.substring(i);});};return j;});
