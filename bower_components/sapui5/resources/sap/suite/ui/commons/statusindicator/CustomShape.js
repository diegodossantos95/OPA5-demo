/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","../library","sap/suite/ui/commons/statusindicator/ShapeGroup","sap/suite/ui/commons/statusindicator/Shape","sap/suite/ui/commons/statusindicator/Path","sap/suite/ui/commons/statusindicator/Circle","sap/suite/ui/commons/statusindicator/Rectangle","sap/suite/ui/commons/util/HtmlElement"],function(q,l,S,a,P,C,R,H){"use strict";var F=l.statusindicator.FillingType;var b=a.extend("sap.suite.ui.commons.statusindicator.CustomShape",{metadata:{library:"sap.suite.ui.commons",properties:{definition:{type:"string",defaultValue:null}},defaultAggregation:"shapes",aggregations:{shapes:{type:"sap.suite.ui.commons.statusindicator.SimpleShape",multiple:true,defaultValue:null},fillingOptions:{type:"sap.suite.ui.commons.statusindicator.FillingOption",multiple:true,defaultValue:null}}}});b.prototype.init=function(){if(a.prototype.init){a.prototype.init.apply(this,arguments);}this._initShapeState();};b.prototype.addFillingOption=function(n){var f=typeof n.getOrder()==="undefined";if(f){q.sap.log.fatal("The passed FillingOption has to have set its order property.");return this;}var h=this.getFillingOptions().length>0&&this.getFillingOptions().filter(function(o){return o.getOrder()===n.getOrder();}).length>0;if(h){q.sap.log.fatal("The property 'order' has to be unique within the FillingOptions aggregation, but option"+" with order: "+n.getOrder()+" is already inserted. No FillingOption added.");return this;}return this.addAggregation("fillingOptions",n,true);};b.prototype._initShapeState=function(){this._aFillableSubShapes=[];this.oDefinition=[];this._sViewBox=null;};b.prototype._refreshInternalStructure=function(){this._initShapeState();this._aFillableSubShapes.forEach(function(i){if(i.fillingOption){i.fillingOption.destroy();}i.shape.destroy();});if(!this.getDefinition()){q.sap.log.fatal("Definition has to be specified.");return;}var $=q(this.getDefinition());this.oDefinition=q.map($.children(),this._preprocessNode.bind(this));this._sViewBox=$[0].getAttribute("viewBox");};b.prototype._preprocessNode=function(n){var $=q(n),t=$.prop("tagName"),c=this,r=null;switch(t){case"g":r=q.map($.children(),function(o){return c._preprocessLeafNode.call(c,q(o));});break;default:r=this._preprocessLeafNode($);}return r;};b.prototype._preprocessLeafNode=function($){var t=$.prop("tagName");var r=null;switch(t){case"path":r=this._preprocessPathNode($);break;case"circle":r=this._preprocessCircleNode($);break;case"rect":r=this._preprocessRectangleNode($);break;case"defs":r=this._preprocessDefinitionsNode($[0]);break;default:q.sap.log.fatal("Unsupported node tag name ('"+t+"')");}return r;};b.prototype._preprocessPathNode=function($){var p=new P({d:$.attr("d")});this._prepareShape(p,$);return p._getHtmlElements();};b.prototype._preprocessCircleNode=function($){var c=new C({cx:Number($.attr("cx")),cy:Number($.attr("cy")),r:Number($.attr("r"))});this._prepareShape(c,$);return c._getHtmlElements();};b.prototype._preprocessRectangleNode=function($){var r=new R({x:Number($.attr("x")),y:Number($.attr("y")),width:Number($.attr("width")),height:Number($.attr("height"))});this._prepareShape(r,$);return r._getHtmlElements();};b.prototype._preprocessDefinitionsNode=function(d){var D=new H("defs");D.addChild(d.innerHTML);return D;};b.prototype._getHtmlElements=function(d){this._refreshInternalStructure();var s=new H("svg");s.addControlData(this);if(this._sViewBox){s.setAttribute("viewBox",this._sViewBox);}this.oDefinition.forEach(function(i){s.addChild(i);});return s;};b.prototype._setInitialValue=function(i){this._iDisplayedValue=i;};b.prototype.getDisplayedValue=function(){return this._iDisplayedValue;};b.prototype._prepareShape=function(s,$){var c=$.attr("style");this.addShape(s);s._injectAnimationPropertiesResolver(this._oAnimationPropertiesResolver);if(!c){s.setFillingDirection(this.getFillingDirection());s.setFillColor(this.getFillColor());s.setFillingType(this.getFillingType());var d=$.data("shape-id");var f={shape:s,fillingOption:d?this._getFillingOptionById(d):null};this._aFillableSubShapes.push(f);if(f.fillingOption){this._aFillableSubShapes.sort(function(A,B){var o=A.fillingOption;var e=B.fillingOption;if(!o){return-1;}if(!e){return 1;}return o.getOrder()-e.getOrder();});}}else{s.setFillingType(F.None);s._setStyle(c);}};b.prototype._updateDom=function(d){function g(s){var f=s.fillingOption;return f&&f.getWeight()!==0?f.getWeight():1;}this._iDisplayedValue=d;if(this._aFillableSubShapes.length===0){q.sap.log.info("Update of DOM skipped. No shape for update found");return;}var t=this._aFillableSubShapes.reduce(function(c,s){return c+g(s);},0);try{var v=this._oAnimationPropertiesResolver.getValue(this,d);this._aFillableSubShapes.forEach(function(f){var s=g(f);var G=s/t;var i;if(v===0){i=0;}else if(v>=100*G){i=100;}else{i=v/G;}v-=i*G;f.shape._updateDom(i,true);});}catch(e){q.sap.log.fatal("Update of DOM failed. Reason: "+e.message);return;}};b.prototype._getFillingOptionById=function(i){var r=null;this.getFillingOptions().some(function(f){if(f.getShapeId()===i){r=f;return true;}return false;});return r;};return b;});
