/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Control','sap/m/Size','sap/ui/Device','sap/m/FlexBox'],function(q,l,C,S,D,F){"use strict";var a=C.extend("sap.suite.ui.microchart.ComparisonMicroChart",{metadata:{library:"sap.suite.ui.microchart",properties:{size:{type:"sap.m.Size",group:"Misc",defaultValue:"Auto"},scale:{type:"string",group:"Misc",defaultValue:""},minValue:{type:"float",group:"Appearance",defaultValue:null},maxValue:{type:"float",group:"Appearance",defaultValue:null},view:{type:"sap.suite.ui.microchart.ComparisonMicroChartViewType",group:"Appearance",defaultValue:"Normal"},colorPalette:{type:"string[]",group:"Appearance",defaultValue:[]},shrinkable:{type:"boolean",group:"Misc",defaultValue:false},width:{type:"sap.ui.core.CSSSize",group:"Misc"},height:{type:"sap.ui.core.CSSSize",group:"Appearance"},isResponsive:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"data",aggregations:{data:{type:"sap.suite.ui.microchart.ComparisonMicroChartData",multiple:true,bindable:"bindable"}},events:{press:{}}}});a.WIDTH_FONT_THRESHOLD=168;a.HEIGHT_PER_CHART_DISAPPEAR_THRESHOLD=16;a.EDGE_CASE_WIDTH_HIDE_CHART=32;a.prototype.attachEvent=function(e,d,f,L){C.prototype.attachEvent.call(this,e,d,f,L);if(this.hasListeners("press")){this.$().attr("tabindex",0).addClass("sapSuiteUiMicroChartPointer");}return this;};a.prototype.detachEvent=function(e,f,L){C.prototype.detachEvent.call(this,e,f,L);if(!this.hasListeners("press")){this.$().removeAttr("tabindex").removeClass("sapSuiteUiMicroChartPointer");}return this;};a.prototype.ontap=function(e){if(D.browser.edge){this.onclick(e);}};a.prototype.onclick=function(e){if(!this.fireBarPress(e)){this.firePress();if(D.browser.msie||D.browser.edge){this.$().focus();e.preventDefault();}}};a.prototype.fireBarPress=function(e){var b=q(e.target);if(b&&b.attr("data-bar-index")){var i=parseInt(b.attr("data-bar-index"),10);var c=this.getData()[i];if(c&&c.hasListeners("press")){c.firePress();e.preventDefault();e.stopImmediatePropagation();if(D.browser.msie){q.sap.byId(this.getId()+"-chart-item-bar-"+i).focus();}var B=this.$().find(".sapSuiteCpMCChartBar");var d=B.index(this.$().find(".sapSuiteCpMCChartBar[tabindex='0']"));this._switchTabindex(d,i,B);return true;}}return false;};a.prototype.onsaptabprevious=function(){this.$().css("outline-color","");};a.prototype.onsaptabnext=function(){var n=this.$().next();if(n.hasClass("sapSuiteCpMC")&&n.attr("tabindex")){n.css("outline-color","");}};a.prototype.onsapenter=function(e){if(!this.fireBarPress(e)){this.firePress();e.preventDefault();e.stopImmediatePropagation();}};a.prototype.onsapspace=a.prototype.onsapenter;a.prototype.onsapup=function(e){var b=this.$().find(".sapSuiteUiMicroChartPointer");if(b.length>0){var i=b.index(e.target);this._switchTabindex(i,i-1,b);}e.preventDefault();e.stopImmediatePropagation();};a.prototype.onsapdown=function(e){var b=this.$().find(".sapSuiteUiMicroChartPointer");if(b.length>0){var i=b.index(e.target);this._switchTabindex(i,i+1,b);}e.preventDefault();e.stopImmediatePropagation();};a.prototype.onsaphome=function(e){var b=this.$().find(".sapSuiteUiMicroChartPointer");var i=b.index(e.target);if(i!==0&&b.length>0){this._switchTabindex(i,0,b);}e.preventDefault();e.stopImmediatePropagation();};a.prototype.onsapend=function(e){var b=this.$().find(".sapSuiteUiMicroChartPointer");var i=b.index(e.target),L=b.length;if(i!==L-1&&L>0){this._switchTabindex(i,L-1,b);}e.preventDefault();e.stopImmediatePropagation();};a.prototype.onsapleft=a.prototype.onsapup;a.prototype.onsapright=a.prototype.onsapdown;a.prototype.setMinValue=function(m){this._isMinValueSet=q.isNumeric(m);return this.setProperty("minValue",this._isMinValueSet?m:NaN);};a.prototype.setMaxValue=function(m){this._isMaxValueSet=q.isNumeric(m);return this.setProperty("maxValue",this._isMaxValueSet?m:NaN);};a.prototype.setSize=function(s){if(this.getSize()!==s){if(s===S.Responsive){this.setProperty("isResponsive",true,true);}else{this.setProperty("isResponsive",false,true);}this.setProperty("size",s,false);}return this;};a.prototype.init=function(){this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.microchart");this.setAggregation("tooltip","{AltText}",true);this._isMinValueSet=false;this._isMaxValueSet=false;this._bThemeApplied=true;if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this));}else{this._handleCoreInitialized();}};a.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();if(!this._bThemeApplied){sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this);}};a.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this.invalidate();sap.ui.getCore().detachThemeChanged(this._handleThemeApplied,this);};a.prototype.onBeforeRendering=function(){if(l._isInGenericTile(this)){this.setIsResponsive(true);l._removeStandardMargins(this);}this._unbindMouseEnterLeaveHandler();};a.prototype.onAfterRendering=function(){if(this.getIsResponsive()){this._adjustToParent();}l._checkControlIsVisible(this,this._onControlIsVisible);this._bindMouseEnterLeaveHandler();};a.prototype._onControlIsVisible=function(){if(this.getHeight()!==""||this.getIsResponsive()){D.media.attachHandler(this._onResize,this);this._onResize();}};a.prototype.setBarPressable=function(b,p){if(p){var B=this._getBarAltText(b);q.sap.byId(this.getId()+"-chart-item-bar-"+b).addClass("sapSuiteUiMicroChartPointer").attr("tabindex",0).attr("title",B).attr("role","presentation").attr("aria-label",B);}else{q.sap.byId(this.getId()+"-chart-item-bar-"+b).removeAttr("tabindex").removeClass("sapSuiteUiMicroChartPointer").removeAttr("title").removeAttr("role").removeAttr("aria-label");}};a.prototype.getAltText=function(){var A="",b;for(var i=0;i<this.getData().length;i++){b=this._getBarAltText(i);if(!l._isTooltipSuppressed(b)){if(!l._isTooltipSuppressed(A)){A+="\n";}A+=b;}}return A;};a.prototype.getTooltip_AsString=function(){var t=this.getTooltip();var T=this.getAltText();if(typeof t==="string"||t instanceof String){T=t.split("{AltText}").join(T).split("((AltText))").join(T);return T;}else if(this.isBound("tooltip")&&!t){return T;}return t?t:"";};a.prototype._calculateChartData=function(){var r=[];var d=this.getData();var c=d.length;var m=0;var M=0;var t;var b;var e;var i;for(i=0;i<c;i++){var f=isNaN(d[i].getValue())?0:d[i].getValue();m=Math.max(m,f);M=Math.min(M,f);}if(this._isMinValueSet){M=Math.min(M,this.getMinValue());}if(this._isMaxValueSet){m=Math.max(m,this.getMaxValue());}t=m-M;b=(t==0)?0:Math.round(m*100/t);if(b==0&&m!=0){b=1;}else if(b==100&&M!=0){b=99;}e=100-b;for(i=0;i<c;i++){var I={};var g=isNaN(d[i].getValue())?0:d[i].getValue();I.value=(t==0)?0:Math.round(g*100/t);if(I.value==0&&g!=0){I.value=(g>0)?1:-1;}else if(I.value==100){I.value=b;}else if(I.value==-100){I.value=-e;}if(I.value>=0){I.negativeNoValue=e;I.positiveNoValue=b-I.value;}else{I.value=-I.value;I.negativeNoValue=e-I.value;I.positiveNoValue=b;}r.push(I);}return r;};a.prototype._getLocalizedColorMeaning=function(c){return this._oRb.getText(("SEMANTIC_COLOR_"+c).toUpperCase());};a.prototype._getBarAltText=function(b){var B=this.getData()[b];var o=this.getData()[b].getTooltip();if(o){return o;}else{var m=this.getColorPalette().length?"":this._getLocalizedColorMeaning(B.getColor());return B.getTitle()+" "+(B.getDisplayValue()?B.getDisplayValue():B.getValue())+this.getScale()+" "+m;}};a.prototype._adjustBars=function(){var b;var h=parseFloat(this.$().find(".sapSuiteCpMCVerticalAlignmentContainer").css("height"));var B=this.getData().length;var c=this.$().find(".sapSuiteCpMCChartItem");var m=parseFloat(c.css("min-height"));var M=parseFloat(c.css("max-height"));if(B!==0){b=this._calculateBarContainerHeight(D.browser.firefox,h,B);if(b>M){b=M;}else if(b<m){b=m;}c.css("height",b);var i=(h-b*B)/2;if(i>0){q(c[0]).css("margin-top",i+"px");}}};a.prototype._calculateBarContainerHeight=function(f,h,b){if(f&&!this.getIsResponsive()&&this.getView()!=="Wide"){var H=this.$().find(".sapSuiteCpMCChartItemHeader").outerHeight(true);var B=this.$().find(".sapSuiteCpMCChartBar").outerHeight(true);return H+B;}else{return h/b;}};a.prototype._onResize=function(){if(this.getIsResponsive()){this._adjustBars();this._resizeVertically();this._resizeHorizontally();}else{this._adjustBars();}};a.prototype._adjustToParent=function(){if(q.isFunction(this.getParent)&&this.getParent()instanceof F){var p=parseInt(this.getParent().$().height(),10);var P=parseInt(this.getParent().$().width(),10);var $=this.$();$.outerHeight(p-parseInt($.css("margin-top"),10)-parseInt($.css("margin-bottom"),10));$.outerWidth(P-parseInt($.css("margin-left"),10)-parseInt($.css("margin-right"),10));}};a.prototype._resizeVertically=function(){var $=this.$();var o=$.find(".sapSuiteCpMCVerticalAlignmentContainer");var m=parseInt(o.css("max-height"),10);var c=parseInt($.css("height"),10);var i=parseInt(o.css("height"),10);var b=this.$().find(".sapSuiteCpMCChartBar").outerHeight();var B=this.getData().length;if(c<=m){$.addClass("sapSuiteCpMCSmallFont");}if(this.getView()==="Normal"&&i<(a.HEIGHT_PER_CHART_DISAPPEAR_THRESHOLD+b)*B){$.find(".sapSuiteCpMCChartBar>div").hide();}if(i<a.HEIGHT_PER_CHART_DISAPPEAR_THRESHOLD*B){$.hide();}};a.prototype._resizeHorizontally=function(){var $=this.$();var b=$.find(".sapSuiteCpMCChartBar");var B=parseInt(b.width(),10);var w=parseInt($.width(),10);if(this.getView()==="Wide"&&B<a.EDGE_CASE_WIDTH_HIDE_CHART){b.hide();}if(w<a.WIDTH_FONT_THRESHOLD||this._isTruncatedLabel(".sapSuiteCpMCChartItemTitle, .sapSuiteCpMCChartItemValue")){$.addClass("sapSuiteCpMCSmallFont");}if(w<a.EDGE_CASE_WIDTH_HIDE_CHART){$.hide();}if(this._isTruncatedLabel(".sapSuiteCpMCChartItemValue")){$.hide();}};a.prototype._isTruncatedLabel=function(c){var L=this.$().find(c);for(var i=0;i<L.length;i++){if(L[i].offsetWidth<L[i].scrollWidth-1){return true;}}return false;};a.prototype._addTitleAttribute=function(){var t=this.getTooltip_AsString();if(!l._isTooltipSuppressed(t)){if(this.getIsResponsive()){this.$().find(".sapSuiteCpMCVerticalAlignmentContainer").attr("title",t);}else{this.$().attr("title",t);}}};a.prototype._removeTitleAttribute=function(){if(this.getIsResponsive()){this.$().find(".sapSuiteCpMCVerticalAlignmentContainer").removeAttr("title");}else{this.$().removeAttr("title");}};a.prototype._resolveFocus=function(e){var b=q(e.target);if(b&&b.attr("data-bar-index")){var i=parseInt(b.attr("data-bar-index"),10);var d=this.getData()[i];if(d&&d.hasListeners("press")){this.$().css("outline-color","transparent");}else{this.$().css("outline-color","");}}else{this.$().css("outline-color","");}};a.prototype._switchTabindex=function(o,n,b){if(o>=0&&o<b.length&&n>=0&&n<b.length){b.eq(o).removeAttr("tabindex");b.eq(n).attr("tabindex","0").focus();}};a.prototype._bindMouseEnterLeaveHandler=function(){if(!this._oMouseEnterLeaveHandler){this._oMouseEnterLeaveHandler={mouseEnterChart:this._addTitleAttribute.bind(this),mouseLeaveChart:this._removeTitleAttribute.bind(this),mouseDownChart:this._resolveFocus.bind(this)};}this.$().bind("mouseenter",this._oMouseEnterLeaveHandler.mouseEnterChart);this.$().bind("mouseleave",this._oMouseEnterLeaveHandler.mouseLeaveChart);this.$().bind("mousedown",this._oMouseEnterLeaveHandler.mouseDownChart);};a.prototype._unbindMouseEnterLeaveHandler=function(){if(this._oMouseEnterLeaveHandler){this.$().unbind("mouseenter",this._oMouseEnterLeaveHandler.mouseEnterChart);this.$().unbind("mouseleave",this._oMouseEnterLeaveHandler.mouseLeaveChart);this.$().unbind("mousedown",this._oMouseEnterLeaveHandler.mouseDownChart);}};return a;});
