sap.ui.define(["sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/routing/Targets","sap/ui/generic/app/util/ModelUtil","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/FlexibleColumnLayoutHandler","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/js/AnnotationHelperReuseComponents","sap/m/MessageBox"],function(F,a,b,J,T,M,C,c,t,A,d){"use strict";var p="---";function e(i,j,V,N,O){var Q={};Q={viewName:V,controlId:j,controlAggregation:O};var U=i.getTargets();U.addTarget(N,Q);}function f(N,i){if(N.oTemplateContract.oFlexibleColumnLayoutHandler){N.oTemplateContract.oFlexibleColumnLayoutHandler.createMessagePageTargets(e.bind(null,N.oRouter,i,"sap.suite.ui.generic.template.fragments.MessagePage"));}else{e(N.oRouter,i,"sap.suite.ui.generic.template.fragments.MessagePage","messagePage","pages");}}function E(i,j,N){var O=i[j];if(!O){O={draftSpec:"OData",level:0,children:[]};for(var Q in i){var U=i[Q];if(U.level===1){O.children.push(Q);break;}}i[j]=O;}if(O.hasOwnProperty("isDraft")){return;}if(O.draftSpec==="parent"){if(O.parent){E(i,O.parent,N);var V=i[O.parent];O.isDraft=V.isDraft;}else if(O.level===1){for(var W in i){var X=i[W];if(X.level===0){O.isDraft=X.isDraft;return;}}}return;}if(O.draftSpec==="OData"){var Y=N.getDraftContext();O.isDraft=Y.isDraftEnabled(j);return;}O.isDraft=O.draftSpec;}function g(N,i){var j=N.oAppComponent.getModel();var O=j.getMetaModel();O.loaded().then(function(){var Q=N.oTemplateContract.mEntityTree;var U=N.oAppComponent.getTransactionController().getDraftController();E(Q,i.entitySet,U);for(var V in Q){E(Q,V,U);}});}function h(N){var i=N.oTemplateContract.oNavigationHost.getId();var j=N.oAppComponent.getConfig();if(!j.pages||!j.pages.length){throw new Error("Route Configuration missing");}if(j.pages.length>1){throw new Error("Currently only one Top route supported");}var O=j.pages[0];N.oTemplateContract.mEntityTree={};var Q=s([],O,"root",0,null,N,i);N.oRouter.addRoute(Q);o(Q,N);k(Q.target,O,0,null,N,i);f(N,i);g(N,Q);return O.entitySet;}function k(j,N,O,Q,U,V,W,X,Y){var i,Z;if(N.pages){Z=N.pages.length;for(i=0;i<Z;i++){n(j,N.pages[i],(O+1),Q,U,V,W,X,Y);}}}function H(i,j,N,O,Q,U,V,W){var X=N.target;var Y={pages:i.pages};var Z={pattern:N.pattern+"/"+i.id,entitySet:N.entitySet,name:N.name+"/"+i.id,contextPath:N.contextPath,patternDelimiter:p,embeddedComponent:i.id};k(X,Y,j,Z,O,Q,U,V,W);}function l(i,j,N,O,Q,U,V,W){var X=new J();var Y={};i.embeddedComponents[V]={key:V||"implementation",componentName:W.componentName,containerId:V?A.formatIdComponentContainer(W):"template::ImplementingComponent",pages:W.pages||[],communicationModel:X,communicationObject:Y};if(W.pages){H(W,j,N,O,Q,U,X,Y);}}function m(i,j,N,O,Q,U,V){i.embeddedComponents={};if(j.implementingComponent){l(i,N,O,Q,U,V,null,j.implementingComponent);}else if(j.embeddedComponents){for(var W in j.embeddedComponents){var X=j.embeddedComponents[W];l(i,N,O,Q,U,V,W,X);}}}function n(i,j,N,O,Q,U,V,W,X){if(j.component){var Y={parent:O&&O.entitySet,parentEmbeddedComponent:O&&O.embeddedComponent,navigationProperty:j.navigationProperty,level:N,children:[],communicationModel:W,communicationObject:X,noKey:j.routingSpec&&j.routingSpec.noKey,draftSpec:j.routingSpec?j.routingSpec.draftSpec||"parent":"OData"};var Z=s(i,j,j.component.list?"aggregation":"detail",N,O,Q,U);Y.sRouteName=Z.name;Y.entitySet=Z.entitySet;if(V){V.push(Z.entitySet);}var $=Q.oTemplateContract.mEntityTree[Z.entitySet];if(!$||$.level>Y.level){Q.oTemplateContract.mEntityTree[Z.entitySet]=Y;}Q.oRouter.addRoute(Z);o(Z,Q);q(Q,Z);k(Z.target,j,N,Z,Q,U,Y.children,W,X);m(Y,j,N,Z,Q,U,V);}}function o(i,N){var Q=jQuery.extend({},i);Q.name=i.name+"query";Q.pattern=i.pattern+"{?query}";N.oRouter.addRoute(Q);}function q(N,i){var j=N.oTemplateContract.mEntityTree[i.entitySet];if(i.routingSpec&&i.routingSpec.noOData){j.headerTitle=i.routingSpec.headerTitle;j.titleIconUrl=i.routingSpec.titleIconUrl;}else{var O=N.oAppComponent.getModel();var Q=O.getMetaModel();Q.loaded().then(function(){var U=Q.getODataEntitySet(i.entitySet);var V=Q.getODataEntityType(U.entityType);var W=V["com.sap.vocabularies.UI.v1.HeaderInfo"];var X=(W&&W.TypeName&&W.TypeName.String)||"";if(X.substr(0,7)==="{@i18n>"){var Y=X.substring(1,X.length-1);var Z=Y.split(">");X=N.oAppComponent.getModel(Z[0]).getResourceBundle().getText(Z[1]);}j.headerTitle=X;var $=(W&&W.Title&&W.Title.IconUrl&&W.Title.IconUrl.String)||"";j.titleIconUrl=$;});}}function D(i){var j,N,O;if(i){j=i.pattern;N=i.navigationProperty||i.entitySet;if(j&&N){O=j.indexOf("{?query}");if(O>0){j=j.substring(0,O);}O=-1;N+="({keys";O=j.indexOf(N);if(O>0){j=j.substring(O);}if(i.navigationProperty){j=j.replace(i.navigationProperty,i.entitySet);}j="/"+j;}}return j;}function r(i,j){return j?j.contextPath+(i.routingSpec.binding?("/"+i.routingSpec.binding):""):"";}function s(i,j,O,N,Q,U,V){var W=jQuery.isArray(i)?i:[i];var X,Y;X=(N===1)?j.entitySet:j.navigationProperty;Y=jQuery.extend({},j);Y.path="/"+j.entitySet;Y.operation=O;Y.viewLevel=N;Y.template=j.component?(j.component.name||j.component):j.template;switch(O){case"root":Y.name="root";Y.pattern="";break;case"aggregation":Y.name=X+"~aggregation";Y.pattern=X;break;default:Y.name=X;var Z=j.routingSpec&&j.routingSpec.noKey?"":"({keys"+N+"})";Y.pattern=X+Z;break;}if(Q){Y.name=Q.name+"/"+Y.name;Y.pattern=Q.pattern+(Q.patternDelimiter||"/")+Y.pattern;Y.parentEntitySet=Q.entitySet;}if(Y.viewLevel===1){U.oTemplateContract.routeViewLevel1={pattern:Y.pattern,name:Y.name};}var $;var _=Y.name;if(U.oTemplateContract.oFlexibleColumnLayoutHandler){$=U.oTemplateContract.oFlexibleColumnLayoutHandler.adaptRoutingInfo(Y,_,W);}else{$="pages";Y.target=_;}e(U.oRouter,V,Y.name,_,$);var a1=new Promise(function(b1){U.mRouteToComponentResolve[Y.name]=b1;});U.oTemplateContract.mRouteToTemplateComponentPromise[Y.name]=a1;Y.contextPath=(j.routingSpec&&j.routingSpec.noOData)?r(j,Q):D(Y);return Y;}function I(N,i){var j;if(!N.oHashChanger.getHash()){j="";if(i&&i.route&&i.route.length===1){j=i.route[0];N.navigate(j,true);}}N.oRouter.initialize();N.fnInitializationResolve();}function R(N,j,O,Q,U,V){var i,W,X,Y,Z=[],$=[];if(O&&Q&&U){W=O.length;for(i=0;i<W;i++){X=O[i].PropertyPath;Y=Q[X][0];Z.push(new a(X,b.EQ,Y));}if(N.oAppComponent.getTransactionController().getDraftController().getDraftContext().isDraftEnabled(j)){var _=new a({filters:[new a("IsActiveEntity","EQ",false),new a("SiblingEntity/IsActiveEntity","EQ",null)],and:false});Z.push(_);}var a1=new a(Z,true);var b1=new Promise(function(e1,f1){U.read("/"+j,{filters:[a1],success:function(g1){var h1=u(g1,U,Q);if(h1){var i1=U.getKey(h1);if(i1){e1(i1);}}f1();},error:function(g1){f1();}});});if(V.bNavigationToSubPageWithSemanticKeyPossible){W=V.aSubPageSemanticKey.length;for(i=0;i<W;i++){X=V.aSubPageSemanticKey[i].PropertyPath;Y=Q[X][0];$.push(new a(X,b.EQ,Y));}if(N.oAppComponent.getTransactionController().getDraftController().getDraftContext().isDraftEnabled(V.sSemanticKeySubPageEntitySetName)){var _=new a({filters:[new a("IsActiveEntity","EQ",false),new a("SiblingEntity/IsActiveEntity","EQ",null)],and:false});$.push(_);}var c1=new a($,true);var d1=new Promise(function(e1,f1){U.read("/"+V.sSemanticKeySubPageEntitySetName,{filters:[c1],success:function(g1){var h1=u(g1,U,Q);if(h1){var i1=U.getKey(h1);if(i1){e1(i1);}}f1();},error:function(g1){f1();}});});}b1.then(function(e1){if(d1){d1.then(function(g1){e1='/'+e1;g1=g1.replace(V.sSemanticKeySubPageEntitySetName,V.sSemanticKeySubPageNavigationProperty);g1='/'+g1;e1=e1.concat(g1);N.navigate(e1,true);},function(g1){N.navigate(e1,true);});}else{if(V.bNavigationToSubPageWithTechnicalKeyPossible){var f1=U.createKey(V.sSubPageEntitySetName,Q);if(f1){e1='/'+e1;f1=f1.replace(V.sSubPageEntitySetName,V.sSubPageNavigationProperty);f1='/'+f1;e1=e1.concat(f1);N.navigate(e1,true);}N.navigate(e1,true);}N.navigate(e1,true);}I(N,Q);},function(e1){I(N,Q);});}return[b1,d1];}function u(N,O,Q){var U,i,V,W;if(N&&N.results){V=N.results.length;if(V==0){W=null;}else if(V==1){W=N.results[0];}else if(V>=1){var X=[];var Y=[];for(i=0;i<V;i++){U=N.results[i];if(U&&U.IsActiveEntity){Y.push(U);}else if(U&&U.IsActiveEntity==false){X.push(U);}}if(Y.length==0&&X.length>=2){var Z;for(var j=0;j<X.length;j++){Z=X[j];if(Z.DraftUUID==Q.DraftUUID){W=Z;break;}}if(!W){W=X[0];}}else if(Y.length==1&&X.length==1){W=Y[0];}else if(Y.length==1&&X.length>=2){W=Y[0];}}}return W;}function v(i,j){if((i&&j)||(j==="display")){return{mode:"unsupported"};}var N={mode:"display",force:"false"};N.mode=j||i||N.mode;N.force=!!j;return N;}function w(j,N,O,Q,U){var V=y(j,N,O,Q,U);var W,X;if(V.bNavigationWithSemanticKeyPossible){R(N,O,V.aSemanticKey,Q,j,V);return;}else if(V.bNavigationWithTechnicalKeyPossible){if(Q.IsActiveEntity&&Q.IsActiveEntity[0]==="false"&&Q.DraftUUID&&Q.DraftUUID[0]!==""){var Y=[];for(var i=0;i<V.aTechnicalKey.length;i++){var Z=V.aTechnicalKey[i]&&V.aTechnicalKey[i].name;if(Z==="DraftUUID"||Z==="IsActiveEntity"){continue;}if(Q.hasOwnProperty(Z)){Y.push({PropertyPath:Z});}}R(N,O,Y,Q,j,V);return;}W=j.createKey(O,Q);if(W){if(V.bNavigationToSubPageWithSemanticKeyPossible){var Y=[];for(var i=0;i<V.aTechnicalKey.length;i++){var Z=V.aTechnicalKey[i]&&V.aTechnicalKey[i].name;if(Z==="DraftUUID"||Z==="IsActiveEntity"){continue;}if(Q.hasOwnProperty(Z)){Y.push({PropertyPath:Z});}}R(N,O,Y,Q,j,V);return;}else if(V.bNavigationToSubPageWithTechnicalKeyPossible){X=j.createKey(V.sSubPageEntitySetName,Q);if(X){X=X.replace(V.sSubPageEntitySetName,V.sSubPageNavigationProperty);X='/'+X;W=W.concat(X);N.navigate(W,true);}}N.navigate(W,true);}}I(N,Q);}function x(j,N){var i,O,Q=false,U,V;if(N&&j){O=j.length;for(i=0;i<O;i++){Q=true;U=j[i];V=U.name||U.PropertyPath;if(!N[V]||N[V].length>1){Q=false;break;}}}return Q;}function y(j,N,O,Q,U){var V={};var W=N.oAppComponent.getConfig();var X=W.pages&&W.pages[0]&&W.pages[0].pages&&W.pages[0].pages[0];if(!X||(X.navigation&&X.navigation[U.mode])){return{};}var Y=j.getMetaModel().getODataEntitySet(O);if(!Y){return{};}var Z=j.getMetaModel().getODataEntityType(Y.entityType);var $=Z["com.sap.vocabularies.Common.v1.SemanticKey"];if($){V={bNavigationWithSemanticKeyPossible:x($,Q),aSemanticKey:$};}if(Z.key.propertyRef){V.bNavigationWithTechnicalKeyPossible=x(Z.key.propertyRef,Q);V.aTechnicalKey=Z.key.propertyRef;}var _=X&&X.pages;if(_){var i,a1,b1,c1,d1,e1,f1;for(i=0;i<_.length;i++){a1=_[i];if(a1.routingSpec&&a1.routingSpec.noOData){continue;}b1=a1.entitySet;e1=j.getMetaModel().getODataEntitySet(b1);f1=a1.component&&a1.component.settings&&a1.component.settings.allowDeepLinking;if(!a1.navigationProperty||!e1||!f1){continue;}c1=j.getMetaModel().getODataEntityType(e1.entityType);d1=c1["com.sap.vocabularies.Common.v1.SemanticKey"];if(d1&&x(d1,Q)){V.sSemanticKeySubPageEntitySetName=e1.name;V.bNavigationToSubPageWithSemanticKeyPossible=x(d1,Q);V.aSubPageSemanticKey=d1;V.sSemanticKeySubPageNavigationProperty=a1.navigationProperty;break;}}for(i=0;i<_.length;i++){a1=_[i];if(a1.routingSpec&&a1.routingSpec.noOData){continue;}b1=a1.entitySet;e1=j.getMetaModel().getODataEntitySet(b1);f1=a1.component&&a1.component.settings&&a1.component.settings.allowDeepLinking;if(!a1.navigationProperty||!e1||!f1){continue;}c1=j.getMetaModel().getODataEntityType(e1.entityType);if(x(c1.key.propertyRef,Q)){V.bNavigationToSubPageWithTechnicalKeyPossible=true;V.sSubPageEntitySetName=e1.name;V.sSubPageNavigationProperty=a1.navigationProperty;V.aSubPageTechnicalKeys=c1.key.propertyRef;break;}}}return V;}function P(N){var i=N.oAppComponent.getModel("_templPrivGlobal");i.setProperty("/generic/forceFullscreenCreate",true);}function z(N,O,Q){var U,V,W,X,Y,Z,i,$,j,_,a1;if(jQuery.isEmptyObject(Q)){return;}U=N&&N.getMetaModel();V=U&&U.getODataEntitySet(O);W=V&&V.entityType;X=U&&U.getODataEntityType(W);Y=X&&X.property;Z=[];a1=Y&&Y.length;for(i=0;i<a1;i++){$=Y[i];if($["type"]==="Edm.Guid"){Z.push($["name"]);}}for(j=0;j<Z.length;j++){if(!Q[Z[j]]){continue;}_=Q[Z[j]][0];_=_.toLowerCase().replace(/(guid')([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(')/,"$2");if(!_.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/)){_=_.replace(/([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})/,"$1-$2-$3-$4-$5");}Q[Z[j]][0]=_;}}function B(N,j,O){var Q;Q=N.oAppComponent.getModel();Q.attachMetadataFailed(N.fnInitializationResolve);Q.getMetaModel().loaded().then(function(){var U;z(Q,j,O);var V=O.preferredMode&&O.preferredMode[0];var W=O.mode&&O.mode[0];var X=v(V,W);switch(X.mode){case"create":P(N);var Y=C.create(N.oAppComponent.getTransactionController().getDraftController(),j,"/"+j,Q,N.oTemplateContract.oApplicationProxy.setEditableNDC);Y.then(function(d1){N.navigateToContext(d1,"",true,4).then(I.bind(null,N,O));},function(d1){I(N,O);N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:d1.messageText,description:"",icon:"sap-icon://message-error",replaceURL:true});});N.oTemplateContract.oBusyHelper.setBusy(Y,true);break;case"createWithContext":P(N);U=Q.getMetaModel().getODataEntitySet(j);var Z=U["com.sap.vocabularies.Common.v1.DraftRoot"];if(Z&&Z.NewAction){var $=Q.getMetaModel().getODataFunctionImport(Z.NewAction.String.split("/")[1]);var _={};if($&&$.parameter){for(var i=0;i<$.parameter.length;i++){if($.parameter[i].mode==="In"&&O[$.parameter[i].name][0]){_[$.parameter[i].name]=O[$.parameter[i].name][0];}}sap.ui.core.BusyIndicator.show();Q.callFunction("/"+$.name,{success:function(d1,e1){I(N,O);sap.ui.core.BusyIndicator.hide();var f1=new M(Q);var g1=f1.getContextFromResponse(d1);if(g1){N.navigateToContext(g1,null,true,4).then(I.bind(null,N,O));}else{I(N,O);N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_ERROR"),text:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:"",replaceURL:true});}},error:function(d1){sap.ui.core.BusyIndicator.hide();N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_ERROR"),text:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:"",replaceURL:true});},method:"POST",urlParameters:_});}else{N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_ERROR"),text:N.oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:"",replaceURL:true});}}break;case"edit":var a1=y(Q,N,j,O,X);if(a1.bNavigationWithTechnicalKeyPossible||a1.bNavigationWithSemanticKeyPossible){var b1="";var c1;if(a1.bNavigationWithTechnicalKeyPossible){b1=Q.createKey(j,O);c1=C.edit(N.oAppComponent.getTransactionController(),j,"/"+b1,Q,N.oTemplateContract,N.fnInitializationResolve);}else if(a1.bNavigationWithSemanticKeyPossible){b1="";c1=C.edit(N.oAppComponent.getTransactionController(),j,b1,Q,N.oTemplateContract,N.fnInitializationResolve,a1.aSemanticKey,O);}c1.then(function(d1){N.navigate(d1.context.getPath(),true);I(N);},function(d1){if(d1.lockedByUser){if(!X.force){w(Q,N,j,O,X);}else{N.fnInitializationResolve();N.navigateToMessagePage({title:N.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),text:N.oTemplateContract.getText("LOCKED_OBJECT_POPOVER_TITLE"),description:N.oTemplateContract.getText("ST_GENERIC_LOCKED_OBJECT_POPOVER_TEXT",[d1.lockedByUser]),icon:"sap-icon://message-error",replaceURL:true});}}else if(d1.draftAdminReadResponse){I(N,O);}else{var e1=N.oTemplateContract.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_EDIT");d.warning(e1,{onClose:function(f1){w(Q,N,j,O,{mode:"display",force:false});}});}});}else{I(N,O);}break;case"display":w(Q,N,j,O,X);break;default:N.fnInitializationResolve();N.navigateToMessagePage({title:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),text:N.oTemplateContract.getText("ST_GENERIC_ERROR_TITLE"),description:N.oTemplateContract.getText("PARAMETER_COMBINATION_NOT_SUPPORTED",[W,V]),icon:"sap-icon://message-error",replaceURL:true});}});}function S(N){var i=N.oAppComponent.getConfig();if(i.settings&&i.settings.flexibleColumnLayout){N.oTemplateContract.oFlexibleColumnLayoutHandler=new c(N.oTemplateContract.oNavigationHost,N);}var j=h(N);var O=N.oAppComponent.getComponentData();var Q=O&&O.startupParameters;if(j&&Q&&!N.oHashChanger.getHash()){B(N,j,Q);}else{I(N);}}function G(i,j,N){var O,Q,U;if(i.operation==="root"){return null;}if(i.operation==="aggregation"){O=i.pattern;}else if(N){O=N;}else{O=i.contextPath;}if(!O){return"";}if(O.indexOf("/")!==0){O="/"+O;}Q=j.getParameter("arguments");if(Q){for(U in Q){if(U!=="?query"){O=O.replace("{"+U+"}",Q[U]);}}return O;}}function K(i,N){var j,O,Q;j=i.getPath().substring(1);O=j.split("(");if(O[0]){Q=O[0];}if(N){j=j.replace(Q,N);if(j.indexOf("/")===0){j=j.substring(1);}}return{entitySet:Q,path:j};}function L(){return p;}var h=t.testableStatic(h,"routingHelpergenerateRoutingMetadataAndGetRootEntitySet");var I=t.testableStatic(I,"routingHelper_initialiseRouting");var R=t.testableStatic(R,"routingHelper_readObject");var B=t.testableStatic(B,"routingHelper_processStartupParameters");var z=t.testableStatic(z,"routingHelper_transformStartupGuidParameters");return{startupRouter:S,determinePath:G,determineNavigationPath:K,getPatternDelimiter:L,readObjectProcessResults:u};});
