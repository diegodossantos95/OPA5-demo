/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/UIComponent","sap/m/NavContainer","sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/generic/app/ApplicationController","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/BusyHelper","sap/suite/ui/generic/template/lib/NavigationController","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/TemplateAssembler","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/library"],function(q,U,N,F,a,b,J,R,A,c,B,d,P,T,C,V,t){"use strict";A=t.observableConstructor(A);var D=sap.m.DraftIndicatorState;var r=T.getRegisterAppComponent();var o;function g(){o=o||new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"}).getResourceBundle();return o.getText.apply(o,arguments);}function e(){return new P({processObservers:[]});}var m=sap.ui.getCore().getMessageManager().getMessageModel();var v=new a({path:"validation",operator:b.EQ,value1:true});function f(h,j){var k={oAppComponent:h,componentRegistry:{},aRunningSideEffectExecutions:[],getText:g,mRouteToTemplateComponentPromise:{},oTemplatePrivateGlobalModel:(new J()).setDefaultBindingMode("TwoWay"),aStateChangers:[],oValidationMessageBinding:m.bindList("/",null,null,v)};k.oValidationMessageBinding.attachChange(q.noop);var l;var n;var p;function s(){k.oTemplatePrivateGlobalModel.setProperty("/generic",{draftIndicatorState:D.Clear,shellServiceUnavailable:false,paginatorInfo:{},forceFullscreenCreate:false});h.setModel(k.oTemplatePrivateGlobalModel,"_templPrivGlobal");k.oShellServicePromise.catch(function(){k.oTemplatePrivateGlobalModel.setProperty("/generic/shellServiceUnavailable",true);});}function u(){l.attachEvent("beforeSideEffectExecution",function(Q){if(Q.getParameter("valueChange")||Q.getParameter("fieldControl")){var S=Q.getParameter("promise");k.oBusyHelper.setBusy(S);var i=0;for(;k.aRunningSideEffectExecutions[i];){i++;}k.aRunningSideEffectExecutions[i]=S;var W=function(){k.aRunningSideEffectExecutions[i]=null;};S.then(W,W);}});var M=h.getModel("_templPrivGlobal");var O="/generic/draftIndicatorState";l.attachBeforeQueueItemProcess(function(i){if(i.draftSave){M.setProperty(O,D.Saving);}});l.attachOnQueueCompleted(function(){if(M.getProperty(O)===D.Saving){M.setProperty(O,D.Saved);}});l.attachOnQueueFailed(function(){if(M.getProperty(O)===D.Saving){M.setProperty(O,D.Clear);}});M.setProperty("/generic/appComponentName",h.getMetadata().getComponentName());}function w(){var i={appComponent:h,oTemplateContract:k,application:new c(k),oViewDependencyHelper:new V(k)};var S=sap.ui.core.service.ServiceFactoryRegistry.get("sap.ushell.ui5service.ShellUIService");k.oShellServicePromise=(S&&S.createInstance())||Promise.reject();k.oShellServicePromise.catch(function(){q.sap.log.warning("No ShellService available");});(U.prototype.init||q.noop).apply(h,arguments);k.oBusyHelper.setBusy(k.oShellServicePromise);p=r(i);var M=h.getModel();l=new A(M);s();n=new d(k);u();C.enableAutomaticDraftSaving(k);if((!M.oMetadata||!M.oMetadata.isLoaded())||M.oMetadata.isFailed()){M.attachMetadataFailed(function(){n.navigateToMessagePage({title:g("ST_GENERIC_ERROR_TITLE"),text:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),icon:"sap-icon://message-error",description:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC")});for(var O in k.componentRegistry){k.componentRegistry[O].fnViewRegisteredResolve();}});}k.oBusyHelper.setBusyReason("initAppComponent",false);}function x(){if(k.oNavigationHost){return"";}if(k.sRoutingType==="f"){var i=new F();k.oNavigationHost=i;k.aNavigationObservers=[new P({processName:"BeginColumnNavigation",eventHandlers:{attachProcessStart:i.attachBeginColumnNavigate.bind(i),attachProcessStop:i.attachAfterBeginColumnNavigate.bind(i)}}),new P({processName:"MidColumnNavigation",eventHandlers:{attachProcessStart:i.attachMidColumnNavigate.bind(i),attachProcessStop:i.attachAfterMidColumnNavigate.bind(i)}}),new P({processName:"EndColumnNavigation",eventHandlers:{attachProcessStart:i.attachEndColumnNavigate.bind(i),attachProcessStop:i.attachAfterEndColumnNavigate.bind(i)}})];k.oNavigationObserver=new P({processObservers:k.aNavigationObservers});k.aHeaderLoadingObservers=[e(),e(),e()];}else{var M=new N({id:h.getId()+"-appContent"});k.oNavigationHost=M;k.oNavigationObserver=new P({processName:"Navigation",eventHandlers:{attachProcessStart:M.attachNavigate.bind(M),attachProcessStop:M.attachAfterNavigate.bind(M)}});}k.oHeaderLoadingObserver=new P({processObservers:k.aHeaderLoadingObservers||[]});k.oPagesDataLoadedObserver=new P({processObservers:[k.oHeaderLoadingObserver,k.oNavigationObserver]});k.oNavigationHost.addStyleClass(k.oApplicationProxy.getContentDensityClass());k.oBusyHelper=new B(k);k.oBusyHelper.setBusyReason("initAppComponent",true,true);return k.oNavigationHost;}function y(){if(k.oNavigationHost){k.oNavigationHost.destroy();}if(l){l.destroy();}if(n){n.destroy();}if(k.oValidationMessageBinding){k.oValidationMessageBinding.destroy();}(U.prototype.exit||q.noop).apply(h,arguments);p();t.endApp(j);}function z(i){var M=Object.keys(i).map(function(O){var Q=i[O];if(Q.pages){Q.pages=z(Q.pages);}return i[O];});return M;}function E(M){if(!M){return;}for(var i=0;i<M.length;i++){var O=M[i];if(O.routingSpec&&O.routingSpec.noOData){O.entitySet=O.routingSpec.routeName;O.navigationProperty=O.routingSpec.routeName;}E(O.pages);if(O.embeddedComponents){for(var Q in O.embeddedComponents){var S=O.embeddedComponents[Q];E(S.pages);}}E(O.implementingComponent&&O.implementingComponent.pages);}}var G;function H(){if(!G){var M=h.getMetadata();G=M.getManifestEntry("sap.ui.generic.app");if(G._version==="1.3.0"&&G.pages&&q.isPlainObject(G.pages)){G.pages=z(G.pages);}E(G.pages);}return G;}var I;function K(){if(!I){I=q.extend({},h.getMetadata().getManifest());I["sap.ui.generic.app"]=H();}return I;}function L(){var M=h.getManifestObject();var S=M.getEntry("sap.ui.generic.app").settings;k.sRoutingType=(S&&S.flexibleColumnLayout)?"f":"m";return"sap."+k.sRoutingType+".routing.Router";}return{init:w,createContent:x,exit:y,_getRouterClassName:L,getConfig:H,getInternalManifest:K,getTransactionController:function(){return l.getTransactionController();},getApplicationController:function(){return l;},getNavigationController:function(){return n;}};}return U.extend("sap.suite.ui.generic.template.lib.AppComponent",{metadata:{config:{title:"SAP UI Application Component",fullWidth:true},properties:{forceGlobalRefresh:{type:"boolean",defaultValue:true}},events:{pageDataLoaded:{}},routing:{config:{async:true,viewType:"XML",viewPath:"",clearTarget:false},routes:[],targets:[]},library:"sap.suite.ui.generic.template"},constructor:function(){var h=t.startApp();q.extend(this,f(this,h));(U.prototype.constructor||q.noop).apply(this,arguments);}});});
