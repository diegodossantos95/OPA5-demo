/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/core/ComponentContainer","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/core/routing/HistoryDirection","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/m/MessagePage","sap/m/Link","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/routingHelper","sap/suite/ui/generic/template/lib/TemplateComponent","sap/suite/ui/generic/template/lib/testableHelper"],function(q,B,C,H,a,b,F,c,M,d,L,P,r,T,t){"use strict";var h=a.getInstance();function n(s){if(s.indexOf("/")===0){return s;}return"/"+s;}function f(o,R,i){var s=R.template;var E=R.entitySet;var v=R.viewLevel;var O=-1;if(o.oFlexibleColumnLayoutHandler){O=v<3?v:0;}var j=O<0?o.oNavigationObserver:o.aNavigationObservers[O];var k=new P();var m=O<0?o.oHeaderLoadingObserver:o.aHeaderLoadingObservers[O];m.addObserver(k);var p={};var S={appComponent:o.oAppComponent,isLeaf:!R.pages||!R.pages.length,entitySet:E,navigationProperty:R.navigationProperty,componentData:{registryEntry:{componentCreateResolve:i,route:R.name,routeConfig:R,viewLevel:v,routingSpec:R.routingSpec,oNavigationObserver:j,oHeaderLoadingObserver:k,preprocessorsData:p}}};if(R.component.settings){q.extend(S,R.component.settings);}var u;o.oAppComponent.runAsOwner(function(){try{var w=sap.ui.component({name:s,settings:S,handleValidation:true,async:true});var x;u=new C({propagateModel:true,width:"100%",height:"100%",settings:S});x=w.then(function(y){u.setComponent(y);return u;});u.loaded=function(){return x;};}catch(e){throw new Error("Component "+s+" could not be loaded");}});return u;}function g(o,e){t.testable(f,"fnCreateComponentInstance");var m={};var p={iHashChangeCount:0,backTarget:0};var s=[];var A=Promise.resolve();var u=[];var v=[];var w=[];function G(){var i=e.oRouter,j=i.getTargets()._mTargets,k=[];Object.keys(j).forEach(function(y1){var z1=j[y1],A1=z1._oOptions,B1=i.getRoute(A1.viewName),C1=B1&&B1._oConfig;if(C1&&(!C1.navigation||!C1.navigation.display)){k.push({oConfig:C1});}});return k;}t.testable(G,"fnGetAllPages");function x(i){var j=i||G();if(!Array.isArray(j)){j=[j];}j.forEach(function(k){k.oComponentContainer=f(o,k.oConfig,function(){});});return j;}t.testable(x,"fnCreatePages");function y(){var i=e.oRouter.getViews();i.getView({viewName:"root"});return o.mRouteToTemplateComponentPromise.root;}function z(){return e.oAppComponent.getManifestEntry("sap.app").title;}function D(){return p.iHashChangeCount;}function E(i,j,k){var y1=function(C1){q.extend(j,C1);};for(var z1 in o.componentRegistry){var A1=o.componentRegistry[z1];if(A1.route===i){var B1=A1.methods.getUrlParameterInfo;return B1?B1(k).then(y1):Promise.resolve();}}return Promise.resolve();}function I(j,k){var y1=k?E("root",j):Promise.resolve();return y1.then(function(){var z1="";var A1="";for(var B1 in j){var C1=j[B1];for(var i=0;i<C1.length;i++){var D1=C1[i];A1=A1+z1+B1+"="+D1;z1="&";}}return A1;});}function J(i,j){var y1=location.hash.split("&")[0]+"&/";for(var k=0;k<j;k++){y1=y1+i[k];if(k<(j-1)){y1=y1+"/";}}return y1;}function K(j){for(var i=0;i<j.length;i++){if(j[i].title!==u[j.length-i-1]||""){j[i].subtitle=u[j.length-i-1]||"";}}v=j;o.oShellServicePromise.then(function(k){k.setHierarchy(j);});}function S(i,j){u[i]=j;var k=v[v.length-i-1];if(k){if(k.title!==j){k.subtitle=j;}o.oShellServicePromise.then(function(y1){y1.setHierarchy(v);});}}function O(i,j,k){var y1=j.headerTitle;var z1=j.titleIconUrl;var A1=o.oFlexibleColumnLayoutHandler.getFullscreenLayout(j.level);var B1=J(k,j.level)+"?"+"FCLLayout="+A1;var C1={title:y1,icon:z1,intent:B1};var D1=o.oTemplatePrivateGlobalModel.getProperty("/generic/FCL/isVisuallyFullScreen");if(j.level<3&&!D1){i.push(C1);}}var Q;function R(){var i,k,y1,z1;var A1=o.oApplicationProxy.getHierarchySectionsFromCurrentHash();if(Q&&Q instanceof T){var B1=Q.getProperty("entitySet");z1=e.oTemplateContract.mEntityTree[B1];}else{return;}var C1=[];var D1,E1;if(o.oFlexibleColumnLayoutHandler){D1=z1;}if(A1.length>0){if(o.oFlexibleColumnLayoutHandler){O(C1,D1,A1);}for(var j=0;j<A1.length-1;j++){if(z1.parent){var F1=e.oTemplateContract.mEntityTree[z1.parent];if(o.oFlexibleColumnLayoutHandler){E1=J(A1,F1.level)+"?"+"FCLLayout="+o.oFlexibleColumnLayoutHandler.getFullscreenLayout(F1.level);}else{E1=J(A1,F1.level);}i=F1.headerTitle;y1=F1.titleIconUrl;z1=F1;}else{if(o.oFlexibleColumnLayoutHandler){E1=J(A1,z1.level)+"?"+"FCLLayout="+o.oFlexibleColumnLayoutHandler.getFullscreenLayout(z1.level);}else{E1=J(A1,z1.level);}i=e.oTemplateContract.mEntityTree[z1.entitySet].headerTitle;y1=e.oTemplateContract.mEntityTree[z1.entitySet].titleIconUrl;}k={title:i,icon:y1,intent:E1};C1.push(k);}k={title:z()};k.intent=location.hash.split("&")[0];if(o.oFlexibleColumnLayoutHandler&&o.oFlexibleColumnLayoutHandler.isListAndFirstEntryLoadedOnStartup()){k.intent=k.intent+"&/?"+"FCLLayout="+o.oFlexibleColumnLayoutHandler.getFullscreenLayout(0);}I({},true).then(function(G1){if(G1){if(o.oFlexibleColumnLayoutHandler&&o.oFlexibleColumnLayoutHandler.isListAndFirstEntryLoadedOnStartup()){k.intent=k.intent+"&"+G1;}else{k.intent=k.intent+"&/?"+G1;}}C1.push(k);K(C1);});}}function U(i,j){var k;if(!i&&j instanceof T){var y1=j&&o.componentRegistry[j.getId()];var z1=y1&&y1.methods.getTitle;k=z1&&z1();}else if(!i&&j&&j.title){k=j.title;}k=k||z();Q=j;o.oShellServicePromise.then(function(A1){A1.setTitle(k);R();});}function V(j,k){var y1;var z1=[];for(var i=0;i<=k;i++){var A1=j[i];if(A1){if(y1){z1.push(A1);}else{y1=A1;}}}if(y1){y1.resume(z1);}}function W(i){var j=[o.oPagesDataLoadedObserver.getProcessFinished(true)];var k=null;var y1=p.iHashChangeCount;var z1=-1;var A1={};for(var B1 in o.componentRegistry){var C1=o.componentRegistry[B1];var D1=C1.oControllerRegistryEntry&&C1.oControllerRegistryEntry.oTemplateUtils.oServices.oTemplateCapabilities.oMessageButtonHelper;if(C1.activationTakt<y1){C1.utils.suspendBinding();if(D1){D1.suspend();}}else{j.push(C1.oViewRenderdPromise);if(C1.viewLevel>z1){z1=C1.viewLevel;k=C1.oComponent;}A1[C1.viewLevel]=D1;}}V(A1,z1);var E1=o.oFlexibleColumnLayoutHandler&&o.oFlexibleColumnLayoutHandler.isAppTitlePrefered();U(E1,i||k);Promise.all(j).then(function(){if(y1===p.iHashChangeCount&&q.isEmptyObject(m)){o.oAppComponent.firePageDataLoaded();}});}var X=W.bind(null,null);function Y(){q.sap.log.info("Navigate back");if(p.backTarget&&n(h.getPreviousHash()||"")!==n(p.hash)){o.oBusyHelper.setBusyReason("HashChange",true);}p.LeaveByBack=true;window.history.back();}function Z(i,j){i=n(i||"");q.sap.log.info("Navigate to hash: "+i);if(i===p.hash){q.sap.log.info("Navigation suppressed since hash is the current hash");return;}o.oBusyHelper.setBusyReason("HashChange",true);p.targetHash=i;if(p.backTarget&&n(h.getPreviousHash()||"")===i){Y();return;}p.LeaveByReplace=j;if(j){e.oHashChanger.replaceHash(i);}else{e.oHashChanger.setHash(i);}}function $(i,j,k,y1){var z1=j.then(function(A1){if(A1){i=i+"?"+A1;}if(y1){p.backwardingInfo={backCount:y1.backCount,targetViewLevel:y1.targetViewLevel,targetHash:n(i)};Y();}else{Z(i,k);}return i;});o.oBusyHelper.setBusy(z1);return z1;}function _(i){var j=0;for(var k=p;k.oEvent;){var y1=k.oEvent.getParameter("config").viewLevel;if(y1===0){return j;}if(i&&j>0){return-1;}j++;k=s[k.backTarget];}return-1;}function a1(i,j,k){if(k===0){var y1=_(!i);return(y1>0)&&{backCount:y1,targetViewLevel:0};}var z1=s[p.backTarget];return z1&&z1.hash&&n(z1.hash.split("?")[0])===n(j)&&{backCount:1};}function b1(i){if(o.oFlexibleColumnLayoutHandler){o.oFlexibleColumnLayoutHandler.setStoredTargetLayoutToOneColumn();}g1("root","",0,i);}function c1(i){var j=o.mEntityTree[i.entitySet].sRouteName;var k=o.mRouteToTemplateComponentPromise[j];return[k];}function d1(j,k){var y1=p.iHashChangeCount;var z1=function(B1){var C1=o.componentRegistry[B1.getId()];(C1.methods.presetDisplayMode||q.noop)(k,y1===C1.activationTakt);};for(var i=0;i<j.length;i++){var A1=j[i];A1.then(z1);}}function e1(i){var j=i&&o.mEntityTree[i.entitySet];var k=j?j.level:1;return k;}function f1(j,k){var y1=o.oApplicationProxy.getHierarchySectionsFromCurrentHash();var z1=j;for(var i=k-2;i>=0;i--){z1=y1[i]+"/"+z1;}return"/"+z1;}function g1(i,j,k,y1){var z1={};var A1=new Promise(function(B1){E(i,z1,j).then(function(){var C1=o.oFlexibleColumnLayoutHandler?o.oFlexibleColumnLayoutHandler.getAppStateParStringForNavigation(k,z1):I(z1,false);var D1=a1(y1,j,k);$(j,C1,y1,D1).then(B1);});});o.oBusyHelper.setBusy(A1);return A1;}function h1(i,j,k,y1){var z1=f1(i,j);g1(k,z1,j,y1);}function i1(i,j,k,y1,z1){var A1;var B1,C1;var D1=[];if(typeof i==="string"){A1=i;C1=n(A1).split("/").length-1;}else{B1=r.determineNavigationPath(i,j);C1=e1(B1);A1=B1.path;D1=c1(B1);}if(A1){if(j){A1=f1(A1,C1);}d1(D1,y1||0);if(z1){var E1="";var F1="&";for(var G1 in z1){E1=E1+F1+G1+"="+z1[G1];F1="&";}if(E1){A1=A1+"?"+E1;}Z(A1,k);return Promise.resolve(A1);}else{var H1=B1&&o.mEntityTree[B1.entitySet].sRouteName;return g1(H1,A1,C1,k);}}}function j1(i,j,k,y1){return i1(i,j,k,y1);}function k1(i){var j=p.iHashChangeCount;p.iHashChangeCount++;s.push(null);if(i){for(var k in o.componentRegistry){var y1=o.componentRegistry[k];if(y1.activationTakt===j&&i[y1.viewLevel]){y1.activationTakt=p.iHashChangeCount;}}}return{iHashChangeCount:p.iHashChangeCount};}function l1(i){var j,k,y1,z1,A1,B1=null,C1,D1;if(i){j=i.entitySet;k=i.text;B1=i.icon;D1=i.description;}if(j){C1=o.oAppComponent.getModel().getMetaModel();if(C1){y1=C1.getODataEntitySet(j);z1=C1.getODataEntityType(y1.entityType);A1=z1["com.sap.vocabularies.UI.v1.HeaderInfo"];}if(A1&&A1.TypeImageUrl&&A1.TypeImageUrl.String){B1=A1.TypeImageUrl.String;}}o.oShellServicePromise.then(function(G1){if(G1.setBackNavigation){G1.setBackNavigation(undefined);}});o.oTemplatePrivateGlobalModel.setProperty("/generic/messagePage",{text:k,icon:B1,description:D1});var E1;if(e.oTemplateContract.oFlexibleColumnLayoutHandler){E1=e.oTemplateContract.oFlexibleColumnLayoutHandler.displayMessagePage(i);}else{var F1=e.oRouter.getTargets();F1.display("messagePage");}k1(E1);W(i);}function m1(){if(!q.isEmptyObject(m)){var j=null;for(var i=0;!j;i++){j=m[i];}m={};l1(j);}}function n1(i){if(e.oTemplateContract.oFlexibleColumnLayoutHandler){i.viewLevel=i.viewLevel||0;m[i.viewLevel]=i;var j=Promise.all([A,e.oTemplateContract.oPagesDataLoadedObserver.getProcessFinished(true)]);j.then(m1);return;}l1(i);}function o1(){var i=[];var j=p.iHashChangeCount;for(var k in o.componentRegistry){var y1=o.componentRegistry[k];if(y1.activationTakt===j){i.push(k);}}return i;}function p1(i){return w.slice(0,i+1);}function q1(i,j,k){var y1=o.componentRegistry[k.getId()]||{};var z1=(y1.activationTakt===j.iHashChangeCount-1);y1.activationTakt=j.iHashChangeCount;var A1;if(k&&k.onActivate){A1=k.onActivate(i,z1);}return A1||y1.viewRegisterd;}function r1(i,j,k){return q1(i,j,k).then(X);}function s1(i,j,k){var y1={};if(j||k){var z1=i.getParameter("config").viewLevel;var A1=o.oTemplatePrivateGlobalModel.getProperty("/generic/paginatorInfo");for(var B1=0;B1<z1;B1++){y1[B1]=A1[B1];}}o.oTemplatePrivateGlobalModel.setProperty("/generic/paginatorInfo",y1);}function t1(i){return o.oApplicationProxy.getAlternativeContextPromise(i);}function u1(i){if(o.oFlexibleColumnLayoutHandler){o.oFlexibleColumnLayoutHandler.handleBeforeRouteMatched(i);}}function v1(k,i){w=[""];for(var j=1;j<=i;j++){var y1="keys"+j;w.push(k[y1]);}}function w1(j){j=q.extend({},j);var k=j.getParameter("config").viewLevel;var y1=n(e.oHashChanger.getHash()||"");q.sap.log.info("Route matched with hash "+y1);var z1;if(p.backwardingInfo){z1=p;s.push(z1);var A1=z1.iHashChangeCount+1;p={iHashChangeCount:A1,forwardingInfo:{bIsProgrammatic:true,bIsBack:true,iHashChangeCount:A1,backCount:z1.backwardingInfo.backCount,targetHash:z1.backwardingInfo.targetHash,targetViewLevel:z1.backwardingInfo.targetViewLevel},backTarget:z1.backTarget};}if(p.forwardingInfo){if(p.forwardingInfo.backCount){p.backTarget=s[p.backTarget].backTarget;p.forwardingInfo.backCount--;if(p.forwardingInfo.backCount&&k!==p.forwardingInfo.targetViewLevel){p.hash=y1;Y();return;}delete p.forwardingInfo.backCount;}if(p.forwardingInfo.targetHash&&p.forwardingInfo.targetHash!==y1){p.hash=y1;var B1=p.forwardingInfo.targetHash;delete p.forwardingInfo.targetHash;Z(B1,true);return;}}var C1=false;for(var i=0;i<o.aStateChangers.length;i++){var D1=o.aStateChangers[i];if(D1.isStateChange(j)){C1=true;}}if(C1){p.hash=y1;R();return;}o.oTemplatePrivateGlobalModel.setProperty("/generic/routeLevel",k);var E1=p.forwardingInfo;delete p.forwardingInfo;if(!E1){E1={};var F1=p.iHashChangeCount;E1.iHashChangeCount=F1+1;E1.bIsProgrammatic=(y1===p.targetHash);E1.bIsBack=!!(p.LeaveByBack||(!E1.bIsProgrammatic&&(h.getDirection()===b.Backwards)));p.LeaveByBack=E1.bIsBack;p.LeaveByReplace=E1.bIsProgrammatic&&p.LeaveByReplace;z1=p;s.push(z1);p={iHashChangeCount:E1.iHashChangeCount};if(z1.LeaveByReplace){p.backTarget=z1.backTarget;}else if(E1.bIsBack){p.backTarget=s[z1.backTarget].backTarget;}else{p.backTarget=F1;}}p.oEvent=j;p.hash=y1;var G1=j.getParameter("config");var H1=r.determinePath(G1,j);var I1=k<2?H1:r.determinePath(G1,j,o.routeViewLevel1.pattern);t1(I1).then(function(J1){var K1=j.getParameter("arguments");if(J1){var L1=K1["?query"];p.forwardingInfo=E1;i1(J1.context,null,true,J1.iDisplayMode,L1||{});return;}v1(K1,k);K([]);s1(j,E1.bIsProgrammatic,E1.bIsBack);if(o.oFlexibleColumnLayoutHandler){A=o.oFlexibleColumnLayoutHandler.handleRouteMatched(j,G1,H1,E1);}else{if(G1.viewLevel===0||!(E1.bIsProgrammatic||E1.bIsBack)){o.oApplicationProxy.setEditableNDC(false);}var M1=G1.target;var N1=o.mRouteToTemplateComponentPromise[M1];A=new Promise(function(O1){N1.then(function(P1){r1(H1,E1,P1).then(O1);});});}A.then(o.oBusyHelper.setBusyReason.bind(null,"HashChange",false));});}function x1(){n1({title:o.getText("ST_ERROR"),text:o.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),description:"",replaceURL:true});}if(o.sRoutingType==="f"){e.oRouter.attachBeforeRouteMatched(u1);}e.oRouter.attachRouteMatched(w1);e.oRouter.attachBypassed(x1);e.navigate=Z;e.navigateToParStringPromise=$;e.activateOneComponent=q1;e.afterActivation=X;e.addUrlParameterInfoForRoute=E;e.getParStringPromise=I;e.performPseudoHashChange=k1;e.getActiveComponents=o1;e.getRootComponentPromise=y;e.getCurrenActivationTakt=D;e.getCurrentKeys=p1;e.getTargetLevel=e1;e.getAppTitle=z;e.subTitleForViewLevelChanged=S;e.navigateToSuffix=h1;return{navigateToRoot:b1,navigateToContext:j1,navigateToMessagePage:n1,navigateBack:Y};}function l(o,e){var i={oAppComponent:e.oAppComponent,oRouter:e.oAppComponent.getRouter(),oTemplateContract:e,oHashChanger:H.getInstance(),mRouteToComponentResolve:{}};e.oNavigationControllerProxy=i;var j=new Promise(function(R){i.fnInitializationResolve=R;});e.oBusyHelper.setBusy(j);q.extend(o,g(e,i));q.extend(i,o);var v={};i.oRouter._oViews._getViewWithGlobalId=function(V){if(!v[V.viewName]){var R=i.oRouter.getRoute(V.viewName);var k;if(R&&R._oConfig){k=f(e,R._oConfig,i.mRouteToComponentResolve[V.viewName]);}else{k=sap.ui.view({viewName:V.viewName,type:V.type,height:"100%"});}v[V.viewName]=k;if(V.viewName==="root"){e.rootContainer=k;}}return v[V.viewName];};r.startupRouter(i);}var N=B.extend("sap.suite.ui.generic.template.lib.NavigationController",{metadata:{library:"sap.suite.ui.generic.template"},constructor:function(o){B.apply(this,arguments);t.testableStatic(l,"NavigationController")(this,o);}});N._sChanges="Changes";return N;});
