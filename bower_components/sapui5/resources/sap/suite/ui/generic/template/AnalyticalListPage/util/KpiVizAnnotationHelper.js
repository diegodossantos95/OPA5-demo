sap.ui.define(["sap/ui/base/Object","sap/ui/model/Context","sap/ui/model/odata/AnnotationHelper","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms"],function(B,C,O,V){"use strict";var A=B.extend("sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper");sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper.constants={LABEL_KEY:"sap:label",TEXT_KEY:"sap:text",TYPE_KEY:"type"};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper.config={"Line":{"type":"line","dimensions":{"min":1,"defaultRole":"Category"},"measures":{"min":1},"feeds":[{"uid":"valueAxis","type":"measure"},{"uid":"categoryAxis","min":1,"type":"dimension","role":"Category"},{"uid":"color","type":"dimension","role":"Series"}]},"Column":{"type":"column","dimensions":{"min":1,"defaultRole":"Category"},"measures":{"min":1,"defaultRole":"Axis1"},"feeds":[{"uid":"valueAxis","min":1,"type":"measure"},{"uid":"categoryAxis","min":1,"type":"dimension"}]},"Donut":{"type":"donut","dimensions":{"min":1},"measures":{"min":1,"max":1},"feeds":[{"uid":"size","min":1,"max":1,"type":"measure"},{"uid":"color","min":1,"type":"dimension"}]},"Bar":{"type":"bar","dimensions":{"min":1,"defaultRole":"Category"},"measures":{"min":1,"defaultRole":"Axis1"},"feeds":[{"uid":"valueAxis","min":1,"type":"measure"},{"uid":"categoryAxis","min":1,"type":"dimension"}]}};A._createSortObject=function(d,m,c){var s="";if(c.EnumMember=="com.sap.vocabularies.UI.v1.ChartType/Line"){s=d[0].Dimension.PropertyPath;}else{s=m[0].Measure.PropertyPath;}return s;};A.formatItems=function(c,e,s,p,D,M,o,S){var a=c.getSetting("dataModel");var r="{";var b=[];var f=[];var g=[];var F=s&&s.SelectOptions;var P=s&&s.Parameters;var h=p&&p.SortOrder;var j=p&&p.MaxItems,k=null;var t;var l=null;var n=sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper;var q="sap:text";if(j){k=j.Int32?j.Int32:j.Int;}if(k){if(k=="0"){jQuery.sap.log.error("maxItems is configured as "+k);r+="}";return r;}if(!/^\d+$/.test(k)){jQuery.sap.log.error("maxItems is Invalid. "+"Please enter an Integer.");r+="}";return r;}}if(P){var u=sap.suite.ui.generic.template.AnalyticalListPage.util.KpiAnnotationHelper.resolveParameterizedEntitySet(a,e,s);r+="path: '"+u+"'";}else{r+="path: '"+S.model+">/"+e.name+"'";}var v=[];if(!S){jQuery.sap.log.error("NO KPI card settings in card formmater");r+="}";return r;}l=S.entitySet;if(!a||!l){return r;}var w=n.getMetadata(a,l);if(F){F.forEach(function(d){var m=d.PropertyName.PropertyPath;d[m].forEach(function(R){if(R.Sign.EnumMember===V.SelectionRangeSignType+"/I"){var I={path:m,operator:R.Option.EnumMember.split("/")[1],value1:R.Low.String,value2:R.High?R.High.String:""};v.push(I);}});});}if(v.length>0){r+=", filters: "+JSON.stringify(v);}if(h){var x=p.SortOrder;if(x.length<1){jQuery.sap.log.warning("Kpi Card no Sort annotaion defined");}else{var y="";var z;var E;var G;for(var i=0;i<x.length;i++){z=x[i];G=z.Property.PropertyPath;if(!G||!w[G]){G=n._createSortObject(D,M,o);}g.push(G);if(typeof z.Descending=="undefined"){E="true";}else{var H=z.Descending.Bool;if(!H){jQuery.sap.log.warning(n.errorMessages.CARD_WARNING+n.errorMessages.BOOLEAN_ERROR);E="true";}else{E=H.toLowerCase()==="true";}}y=y+"{path: '"+G+"',descending: "+E+"},";}r+=", sorter: ["+y.substring(0,y.length-1)+"]";}}jQuery.each(M,function(i,m){t=m.Measure.PropertyPath;f.push(t);if(w&&w[t]&&w[t][q]&&t!=w[t][q]){f.push(w[t][q]?w[t][q]:t);}});jQuery.each(D,function(i,d){t=d.Dimension.PropertyPath;b.push(t);if(w&&w[t]&&w[t][q]&&t!=w[t][q]){b.push(w[t][q]?w[t][q]:t);}});r+=", parameters: {select:'"+[].concat(b,f).join(",");if(g.length>0){r+=","+g.join(",");}r+="'}";if(k){r+=", length: "+k;}r+="}";return r;};A.getChartType=function(c){var a=[];if(!c.EnumMember||!(a=c.EnumMember.split("/"))||a.length<2){jQuery.sap.log.error("KPI Card M - wrong or missing chart type");return"";}else{return A.config[a[1]].type;}};A.setupChartAttributes=function(v,s){var c,e,a;var o,b,d,D,m;var f;var q,Q,g;var p,h=[],M=[];d=A.config;var l=sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper;if(!(c=s)){jQuery.sap.log.error("KPI Card no card settings");return;}var n=v.getModel();var r=n.getMetaModel();var t=c.entitySet;var E=r.getODataEntitySet(t);if(!n||!t){return;}e=r.getODataEntityType(E.entityType,false);if(!e){jQuery.sap.log.error("KPI Card no entityType");return;}var u=l.getMetadata(n,t);var w="com.sap.vocabularies.UI.v1.Chart#"+c.qualifier;if(!w||!(a=e[w])){jQuery.sap.log.error("KPI Card no chart annotations");return;}if(!(D=a.DimensionAttributes)||!D.length){jQuery.sap.log.error("KPI Card no dimension annotations defined");return;}if(!(m=a.MeasureAttributes)||!m.length){jQuery.sap.log.error("KPI Card no measure annotations defined");return;}var x=[];o=a.ChartType;if(!o.EnumMember||!(x=o.EnumMember.split("/"))||x.length<2){jQuery.sap.log.error("KPI Card M - wrong or missing chart type");}else{b=x[1];}var H=true;v.removeAllAggregation();f={legend:{isScrollable:false},general:{background:{color:"transparent"},layout:{padding:15},groupData:false},title:{visible:false},interaction:{noninteractiveMode:false,selectability:{legendSelection:false,axisLabelSelection:false,mode:"NONE",plotLassoSelection:false,plotStdSelection:true}},plotArea:{window:{start:"firstDataPoint",end:"lastDataPoint"},background:{color:"transparent"}}};Q=D.slice();g=m.slice();jQuery.each(d[b].feeds,function(i,y){var z=y.uid;var F=[];if(y.type){var P,G,I;if(y.type==="dimension"){P=D.length;G="Dimension";I="dimensions";q=Q;p=h;}else{P=m.length;G="Measure";I="measures";q=g;p=M;}var J=0,K=P;if(y.min){J=J>y.min?J:y.min;}if(y.max){K=K<y.max?K:y.max;}if(!y.role){var L=q.length;for(var j=0;j<L&&F.length<K;++j){var N=q[j];q.splice(j,1);--L;--j;F.push(N);}}else{var R=y.role.split("|");jQuery.each(R,function(j,W){if(F.length==K){return false;}var L=q.length;for(var k=0;k<L&&F.length<K;++k){var N=q[k];if(N&&N.Role&&N.Role.EnumMember&&N.Role.EnumMember.split("/")&&N.Role.EnumMember.split("/")[1]){var X=N.Role.EnumMember.split("/")[1];if(X==W){q.splice(k,1);--L;--k;F.push(N);}}else if(jQuery.inArray(N,p)==-1){p.push(N);}}});if(F.length<K){jQuery.each(p,function(k,N){var W;var X;if((W=d[I].defaultRole)&&(jQuery.inArray(W,R)!==-1)&&(X=jQuery.inArray(N,q))!==-1){q.splice(X,1);F.push(N);if(F.length==K){return false;}}});}if(F.length<J){jQuery.sap.log.error("KPI card feed propperties < min");return false;}}if(F.length){var S=[];var T;if(!(T=v.getDataset())){jQuery.sap.log.error("KPI Card Viz framework no Dataset");return false;}jQuery.each(F,function(i,N){if(!N||!N[G]||!N[G].PropertyPath){jQuery.sap.log.error("KPI Card invalid chart annotations - propertypath");return false;}var k=N[G].PropertyPath;var W=k;var X=k;if(u&&u[k]){W=u[k][l.constants.LABEL_KEY]||k;X=u[k][l.constants.TEXT_KEY]||k;}var Y="{"+X+"}";S.push(W);if(G=="Dimension"){T.addDimension(new sap.viz.ui5.data.DimensionDefinition({name:W,value:"{"+k+"}",displayValue:Y}));}else{T.addMeasure(new sap.viz.ui5.data.MeasureDefinition({name:W,value:"{"+k+"}"}));}});var U=new sap.viz.ui5.controls.common.feeds.FeedItem({"uid":z,"type":G,"values":S});v.addFeed(U);f[z]={title:{visible:H?false:true,text:S.join(", ")},label:{formatString:"axisFormatter"}};if(z=="valueAxis"){f[z].layout={maxWidth:0.4};}}}});v.setVizProperties(f);};A.formatByType=function(m,p,v){var s=sap.ovp.cards.charts.VizAnnotationManager;var t=s.constants.TYPE_KEY;if(!m||!m[p]||!m[p][t]){return v;}var n=["Edm.Int","Edmt.Int16","Edm.Int32","Edm.Int64","Edm.Decimal"];var c=m[p][t];if(jQuery.inArray(c,n)!==-1){return Number(v);}return v;};A.getMetadata=function(m,e){var a=this.cacheODataMetadata(m);if(!a){return undefined;}return a[e];};A.cacheODataMetadata=function(m){var s=sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper;if(m){if(!jQuery.sap.getObject("sap.suite.ui.generic.template.AnalyticalListPage.kpi.cachedMetaModel")){s.cachedMetaModel={};}var a=s.cachedMetaModel[m.getId()];if(!a){var b=m.getMetaModel();a={};var c=b.getODataEntityContainer();jQuery.each(c.entitySet,function(d,e){var f=b.getODataEntityType(e.entityType);var g={};jQuery.each(f.property,function(p,h){g[h.name]=h;});a[e.name]=g;});s.cachedMetaModel[m.getId()]=a;}return a;}else{jQuery.sap.log.error(s.errorMessages.CARD_ERROR+s.errorMessages.CACHING_ERROR);}};A.formatChartAxes=function(s){jQuery.sap.require("sap.viz.ui5.format.ChartFormatter");jQuery.sap.require("sap.ui.core.format.NumberFormat");jQuery.sap.require("sap.viz.ui5.api.env.Format");var c=sap.viz.ui5.format.ChartFormatter.getInstance();var S=true;if(!s){s=undefined;}else{S=false;}if(c!=null){c.registerCustomFormatter("axisFormatter",function(v){var n=sap.ui.core.format.NumberFormat.getFloatInstance({style:"short",minFractionDigits:0,maxFractionDigits:1,decimals:2,showScale:S,shortRefNumber:s});return n.format(Number(v));});sap.viz.ui5.api.env.Format.numericFormatter(c);}};sap.suite.ui.generic.template.AnalyticalListPage.util.KpiVizAnnotationHelper.formatItems.requiresIContext=true;return A;},true);
