sap.ui.define(["sap/ui/base/EventProvider","sap/ui/comp/personalization/Util","sap/ui/table/AnalyticalTable","sap/ui/core/mvc/Controller","sap/ui/model/FilterType","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil"],function(E,P,A,C,F,a){"use strict";var b=new E();var t=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.DetailController",{setState:function(s){var m=this;this.oState=s;this._enableExpandByFilter=true;this._enableUpdateExpandLevelInfo=false;var c=this.oState.oSmartTable;var d=c.getTable();d.attachEvent("_rowsUpdated",function(e){if(m.oState.oSmartChart){m._updateRows("_rowsUpdated");}});var o=this.oState.oController.getOwnerComponent();var T=this.oState.oController.getOwnerComponent().getModel("_templPriv");T.setProperty('/alp/autoHide',o.getAutoHide()?"filter":"highlight");c.attachInitialise(this._onSmartTableInit,this);c.attachBeforeRebindTable(this._onBeforeRebindTable,this);},_onSmartTableInit:function(){var s=this.oState.oSmartTable,c=s.getCustomToolbar(),T=c.getContent(),n;if(this.oState._pendingTableToolbarInit){c.insertContent(this.oState.alr_viewSwitchButtonOnTable,T.length);}if(this.oState._pendingTableToolbarInit){for(var i=0;i<T.length;i++){if(T[i].mProperties.text==="Settings"){n=i;}}c.insertContent(this.oState._autoHideToggleBtn,n);}delete this.oState._pendingTableToolbarInit;this.oState.oSmartTable.attachShowOverlay(function(e){this.oState.oSmartTable.getCustomToolbar().setEnabled(!e.getParameter("overlay").show);},this);},_onBindingDataReceived:function(){var c=this.oState.oSmartTable.getTable();if(c instanceof A){this._expandByFilter("bindingDataReceived");}if(!this.isFilter()&&this.oState.oSmartChart){this._applyParamsToTableAsHighlight("bindingDataReceived");}},_onBeforeRebindTable:function(o){var v=this.oState.oSmartTable.fetchVariant(),l=v,c={};if(!v){return;}var T=this.oState.oController.getOwnerComponent().getModel("_templPriv");var _=T.getProperty('/alp/_ignoreChartSelections');if(this.isFilter()&&this.oState.oSmartChart&&!_){this._applyChartSelectionOnTableAsFilter(o);}var g=[];var d=this.oState.oSmartTable.getTable().getColumns();for(var i=0;i<d.length;i++){var f=d[i];if(f.getGrouped&&f.getGrouped()){g.push(f.getLeadingProperty?f.getLeadingProperty():P.getColumnKey(f));}}this._updateExpandLevelInfo(g);var s=[];if(v.sort&&v.sort.sortItems){for(var i=0;i<v.sort.sortItems.length;i++){var h=v.sort.sortItems[i].operation==="Descending"?true:false;s.push(new sap.ui.model.Sorter(v.sort.sortItems[i].columnKey,h));}}else if(!l.sort){c.allTableSortRemoved=true;}T.setProperty('/alp/_ignoreChartSelections',false);if(this.oState.oSmartFilterbar&&this.oState.oSmartFilterbar.getAnalyticBindingPath&&this.oState.oSmartFilterbar.getConsiderAnalyticalParameters()){try{var j=this.oState.oSmartFilterbar.getAnalyticBindingPath();if(j){this.oState.oSmartTable.setTableBindingPath(j);}}catch(e){jQuery.sap.log.warning("Mandatory parameters have no values","","AnalyticalListPage");}}if(this.oState.oController.getOwnerComponent().getModel().getDefaultCountMode()==="None"&&this.oState.oSmartTable._isAnalyticalTable){o.mParameters.bindingParams.parameters.provideTotalResultSize=false;this.oState.oSmartTable.setShowRowCount(false);}this.oState.oController.onBeforeRebindTableExtension(o);},attachTableChange:function(d,f,l){return b.attachEvent("TableChange",d,f,l);},detachTableChange:function(f,l){return b.detachEvent("TableChange",f,l);},isFilter:function(){var T=this.oState.oController.getOwnerComponent().getModel("_templPriv");return T.getProperty("/alp/autoHide")==="filter";},applyParamsToTable:function(){this.oState.oController.getOwnerComponent().getModel("_templPriv").setProperty('/alp/_ignoreChartSelections',false);this.oState.oSmartTable.rebindTable();},_getBindingProperty:function(c,n){if(c.getProperty){return c.getProperty(n);}else{var p=c.oEntityType.property;for(var i=0;i<p.length;i++){if(p[i].name==n){return p[i];}}return null;}},_getPageFilters:function(B){var p=this.oState.oSmartFilterbar.getFilters();for(var i=0;i<p.length;i++){if(p[i].aFilters!==undefined){var f=p[i].aFilters;for(var j=0;j<f.length;j++){var c=f[j];var n=c.sPath;if(!B.getProperty(n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}c.sPath=n;}}else{var c=p[i];var n=c.sPath;if(!B.getProperty(n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}c.sPath=n;}}return p;},_applyParamsToTableAsHighlight:function(u){if(!this.oState){return;}var c=this.oState.oSmartChart.getChart();if(!c){return;}var p=this._getSelParamsFromChart(c);var d=c.getVisibleDimensions();var l=this.oState.oSmartChart._lastSelected;var e=this.oState.oSmartTable.getTable();var f=this._getTableBinding(e);if(!f){jQuery.sap.log.error("No table binding to apply the selection(s) to");return;}var g=[];for(var i=0;i<p.length;i++){var h=p[i];var j={};for(var n in h){if(d.indexOf(n)==-1||!this._getBindingProperty(f,n)){continue;}j[n]=h[n];}g.push(j);}var k=this.oState.oSmartChart.getDrillStackFilters();k.forEach(function(o){var n=o.sPath,m={};m[n]=o.oValue1;g.push(m);});var j={};g.forEach(function(o){for(var m in o){if(!j.hasOwnProperty(m)){j[m]=[o[m]];}else{j[m].push(o[m]);}}});this._paramListFiltered=g;this._lastSelected=l;this._paramMap=j;this._updateRows(u);},_expandByFilter:function(u){if(!this._enableExpandByFilter){return;}var c=this.oState.oSmartTable.getTable();var d=this._getTableBinding(c);if(d&&this._lastBinding!=d){var m=this;d.attachDataReceived(this._onBindingDataReceived,this);d.attachEvent("change",function(h){if(m._expandingProgrammatically){return;}var j=h.getParameter("reason");if(j=="expand"||j=="collapse"){m._inUserChartSelectMode=false;}});this._lastBinding=d;}if(u=="selection"||u=="bindingDataReceived"){this._firstVisibleRelevantEventTS=new Date().getTime();}if(u=="selection"){this._inUserChartSelectMode=true;}if(!this._inUserChartSelectMode){return;}var r=this._getTableRows();for(var i=0;i<r.length;i++){var e=r[i];var f=e.getBindingContext();if(!f){continue;}var g=c.getFirstVisibleRow()+i;if(this._isRowHighlighted(f.getObject())){if(c.isExpanded(g)){continue;}if(!e._bHasChildren){continue;}if(!d.findNode(g)){continue;}this._expandingProgrammatically=true;c.expand(g);this._expandingProgrammatically=false;}else{if(!c.isExpanded(g)){continue;}if(!e._bHasChildren){continue;}if(!d.findNode(g)){continue;}this._expandingProgrammatically=true;c.collapse(g);this._expandingProgrammatically=false;}}this._updateFirstVisibleRow(u);},_updateFirstVisibleRow:function(u){var c=this.oState.oSmartTable.getTable();var d=this._getTableBinding(c);var e=d.getTotalSize();if(e==0||(new Date().getTime()-this._firstVisibleRelevantEventTS)>250){return;}var c=this.oState.oSmartTable.getTable();if(u=="selection"&&(!this._paramListFiltered||this._paramListFiltered.length==0)){c.setFirstVisibleRow(0);return;}var f=d.getContexts(0,e);for(var i=0;i<f.length;i++){var r=f[i].getObject();if(!this._isRowHighlighted(r)){continue;}if(this._lastSelected&&!this._rowMatch(this._lastSelected,r)){continue;}var l=c.getFirstVisibleRow();if(u=="selection"||this.isFilter()){c.setFirstVisibleRow(i);}else{if(i>l){c.setFirstVisibleRow(i);}}break;}},_rowMatch:function(s,r){for(var n in s){if(n.indexOf("__")!=-1){continue;}if(!r.hasOwnProperty(n)){continue;}if(s[n]!=r[n]){return false;}}return true;},_updateExpandLevelInfo:function(g){if(!this._enableUpdateExpandLevelInfo){return false;}var T=this.oState.oSmartTable.getTable();if(!T.getNumberOfExpandedLevels){return false;}var B=T.getBinding();if(!B){return false;}var e=g.length;var l=false;if(e>=B.aMaxAggregationLevel.length){l=true;e=B.aMaxAggregationLevel.length-1;this.wasAtMaxLevel=true;}else{l=T.getNumberOfExpandedLevels()!=e||this.wasAtMaxLevel;this.wasAtMaxLevel=false;}if(l){if(e>=0){T.setNumberOfExpandedLevels(e);T.bindRows(T.getBindingInfo("rows"));}var c=T.getGroupedColumns();T.fireGroup({column:c[0],groupedColumns:c,type:sap.ui.table.GroupEventType.group});}return l;},_updateRows:function(u){var c=this.oState.oSmartChart.getChart();var p=this._getSelParamsFromChart(c);this._latestUpdateRow(p.length);var d=this.oState.oSmartTable.getTable();if(d instanceof A){this._expandByFilter(u);}},_getTableRows:function(){var c=this.oState.oSmartTable.getTable();if(c.getRows){return c.getRows();}else{return c.getItems();}},_isRowHighlighted:function(r){var p=this._paramMap;if(!p||jQuery.isEmptyObject(p)){return false;}var m=true;for(var n in p){if(!r.hasOwnProperty(n)){continue;}if(p[n].indexOf(r[n])==-1){m=false;}}return m;},_getTableBinding:function(c){return c.getBinding()?c.getBinding():c.getBinding("items");},_applyChartSelectionOnTableAsFilter:function(e){var f=this.oState.oSmartChart.getDrillStackFilters();e.mParameters.bindingParams.filters.push.apply(e.mParameters.bindingParams.filters,f);var c=this.oState.oSmartChart.getChart();if(!c){return;}var p=this._getSelParamsFromChart(c);if(p.length>0){var d=c.getVisibleDimensions();for(var i=0;i<p.length;i++){var g=p[i];for(var n in g){if(d.indexOf(n)==-1){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}var h=false;var o=e.mParameters.bindingParams.filters;if(o.length>0){var o=o[0].aFilters?o[0].aFilters:o;for(var j=0;j<o.length;j++){var D=o[j].aFilters?o[j].aFilters:o;if(D.length==1){if(D[0].sPath===n&&D[0].oValue1===g[n]){h=true;}}}}if(!h){e.mParameters.bindingParams.filters.push(new sap.ui.model.Filter({path:n,operator:sap.ui.model.FilterOperator.EQ,value1:g[n]}));}}}}this._latestUpdateRow(p.length);},_latestUpdateRow:function(p){var c=this.isFilter();var r=this._getTableRows();var d=false;for(var i=0;i<r.length;i++){var e=r[i];if(!c){if(e.getBindingContext()){var f=e.getBindingContext().getObject();d=this._isRowHighlighted(f);}}var g=e.getDomRefs?e.getDomRefs(true):e.getDomRef();if(!g){continue;}if(g.row){g.row.toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(c&&p)?c:d);}else{$(g).toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(c&&p)?c:d);}}},_getSelParamsFromChart:function(c){var d=[];if(c._getVizFrame().vizSelection()){d=c.getSelectedDataPoints().dataPoints;}return this._getSelParamsFromDPList(d);},_getSelParamsFromDPList:function(d){if(!d){return[];}var p=[];for(var i=0;i<d.length;i++){var c=d[i];var e=c.context;if(!e){continue;}var f=e.getProperty(e.sPath);var g={};if(this._selectFilterByMeasure){for(var j=0;j<c.measures.length;j++){var n=c.measures[j];var v=f[n];g[n]=v;}}else{for(var n in f){g[n]=f[n];}}p.push(g);}return p;}});return t;});
