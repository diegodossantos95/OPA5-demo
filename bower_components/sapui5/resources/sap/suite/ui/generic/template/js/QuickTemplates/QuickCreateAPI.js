sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/generic/app/transaction/DraftContext","sap/m/MessageToast"],function(M,D,a){"use strict";var Q=M.extend("sap.suite.ui.generic.template.js.QuickTemplates.QuickCreateAPI",{metadata:{library:"sap.suite.ui.generic.template",properties:{},events:{objectCreated:{parameters:{context:{type:"sap.ui.model.Context"}}},destroyed:{parameters:{collectionItemGuid:{type:"String"}}},autofillLineItems:{parameters:{numberOfLineItems:{type:"Number"}}}}}});Q.EVENT_CONSTANTS={EventChannel:"sap.fiori.cp.quickactions.EventChannel",QUICKCREATE_LINE_ITEMS_FOUND:"LineItemsFound",QUICKCREATE_VIEW_CREATED:"QuickCreateViewCreated"};var A="items",b="participants";Q.CopilotModelName="FioriCopilotODataModel";Q._Instances={};Q.getInstance=function(c){if(!c){return undefined;}if(c.copilotEntity){return Q._Instances[c.copilotEntity.getODataKey()];}else{return Q._Instances[c];}};Q.createAPI=function(c,C,o){function g(){return o.getView().getBindingContext().getObject();}function d(){return o.getQuickCreateItem();}function e(){return C;}function f(){return c;}function h(){return sap.ui.getCore().getModel(Q.CopilotModelName);}function u(i){if(this._bDestroyed){return;}var L=this.getQuickCreateItem();if(L.draftid===i){return;}L.draftid=i;L.copilotEntity.update(L,{error:jQuery.proxy(function(N){jQuery.sap.log.error(N,"","QuickCreateAPI");},this)});}function j(){return C.getAggregation("rootControl");}function k(){return this.oRootView;}function s(i){this.oRootView=i;this.calculateViewHeight(this.oRootView,true);}function l(){if(this.oRootView&&this.oRootView.getController()&&this.oRootView.getController().bDraftEnabled!==undefined){return this.oRootView.getController().bDraftEnabled;}if(!this.oRootView||!this.oRootView.getBindingContext()){return undefined;}var i=new D(this.getQuickCreateModel());return i.hasDraft(this.oRootView.getBindingContext());}function m(){var i=this.getComponentInstance().getModel();if(!i&&this.oRootView){i=this.oRootView.getModel();}return i;}function n(){return o.isCurrentUserCreator();}function p(){if(!this.oRootView){return undefined;}return this.oRootView.getBindingContext();}function q(){var i=this.getQuickCreateRootBindingContext();if(i&&i.getObject()){return i.getObject().__metadata.type;}return undefined;}function _(i,L,P){var N=P.numberOfLineItems;if(N<=0){return;}this.fireAutofillLineItems({numberOfLineItems:N});}function r(){this._attachToModelBindingChanges();if(!this.oRootView){var V=o.oViewUtils.findFirstViewFromControlHierarchy(this.getRootControl());if(V){this.setRootView(V);}}}function t(){if(!this._bBindingChangeAttached){var i=C.getModel();if(i){var L=i.addBinding.bind(i);var N=this;i.addBinding=function(O){L(O);O.attachEvent("change",N._onDataBindingChanged);};this._bBindingChangeAttached=true;}}}function v(){return new Promise(jQuery.proxy(function(i,L){var N=this.getCopilotModel();N.read("/"+N.getKey(this.getQuickCreateItem()),{success:jQuery.proxy(function(O,R){if(O.modeljson){var P=this.getQuickCreateModel();this._loadingJSON=true;if(this.isDraftEnabled()){P.oData=JSON.parse(O.modeljson);}else{var S=JSON.parse(O.modeljson);P.mChangedEntities=S.mChangedEntities;P.mChangeHandles=S.mChangeHandles;P.mDeferredRequests=S.mDeferredRequests;P.oData=S.oData;}P.updateBindings();}if(i){i();}delete this._loadingJSON;},this),error:jQuery.proxy(function(O){if(L){L(O);}},this)});},this));}function w(){if(!this._oUpdateModelJSONTimer){this._oUpdateModelJSONTimer=setTimeout(this._updateModelJSON,2000);}}function x(){if(this._loadingJSON||this._bDestroyed||!this.isCurrentUserCreator()){return;}this._oUpdateModelJSONTimer=null;var L=this.getQuickCreateItem();var N=this.getQuickCreateModel();var O="";if(this.isDraftEnabled()){var P={};var R=Object.keys(N.mChangedEntities);var S=Object.keys(N.oData);var T={};jQuery.each(S,jQuery.proxy(function(i,V){if(N.mChangedEntities[V]){T={};jQuery.extend(T,N.oData[V]);jQuery.extend(T,N.mChangedEntities[V]);P[V]=T;}else{P[V]=N.oData[V];}},this));jQuery.each(R,jQuery.proxy(function(i,V){if(!P[V]){P[V]=N.mChangedEntities[V];}},this));O=JSON.stringify(P);}else{var U={};U.mChangedEntities=N.mChangedEntities;U.mChangeHandles=N.mChangeHandles;U.mDeferredRequests=N.mDeferredRequests;U.oData=N.oData;O=JSON.stringify(U);}if(O===L.modeljson){return;}L.modeljson=O;L.copilotEntity.update(L,{error:jQuery.proxy(function(i){jQuery.sap.log.error(i,"","QuickCreateAPI");},this)});}function y(){return new Promise(jQuery.proxy(function(i,L){var N=this.getQuickCreateModel();if(this.oRootView&&this.oRootView.getBindingContext()){if(this.isDraftEnabled()){N.remove(this.oRootView.getBindingContext().getPath(),{success:function(){a.show("Draft has been discarded");i();},error:function(O){L(O);}});}else{N.resetChanges();i();}}else{i();}},this));}function z(V,i){if(V){o.calculateViewHeight(V,i);}}function B(i){o.setComponentContainerHeight(i);}function E(i){if(this._bDestroyed){return;}this.fireObjectCreated({context:i});}function F(){sap.ui.getCore().getEventBus().publish(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_VIEW_CREATED,{api:this});}function G(){if(this._bDestroyed){return;}if(this._oUpdateModelJSONTimer){clearTimeout(this._oUpdateModelJSONTimer);this._oUpdateModelJSONTimer=null;}delete Q._Instances[this._InstanceKey];if(c&&!c._bIsBeingDestroyed&&!c.bIsDestroyed){c.destroy();}this.oRootView=undefined;sap.ui.getCore().getEventBus().unsubscribe(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_LINE_ITEMS_FOUND,this._onLineItemsFound,this);this.fireDestroyed({collectionItemGuid:this._InstanceKey});M.prototype.destroy.call(this);this._bDestroyed=true;}function H(P,i){if(this.getCollectionItem()&&this.getCollectionItem().copilotEntity&&this.getCollectionItem().copilotEntity.getParentEntity()&&this.getCollectionItem().copilotEntity.getParentEntity().copilotEntity){if(P===A){return this.getCollectionItem().copilotEntity.getParentEntity().copilotEntity.getItemsPublic(i);}else if(P===b){return this.getCollectionItem().copilotEntity.getParentEntity().copilotEntity.getParticipantsPublic();}else{return new Promise(function(L,N){if(N){N("Error: "+P+" is not a valid part of a collection.");}else{L([]);}});}}return new Promise(function(L,N){if(N){N("Error: Cannot load collection "+P+". Copilot collection entity cannot be accessed");}else{L([]);}});}function I(i){return H.call(this,A,i);}function J(){return H.call(this,b);}var K=new Q();K.COLLECTION_ITEM_TYPES={};K.COLLECTION_ITEM_TYPES.ITEM_TYPE_NOTE="NOTE";K.COLLECTION_ITEM_TYPES.ITEM_TYPE_RELOBJ="RO";K.COLLECTION_ITEM_TYPES.ITEM_TYPE_SCREENSHOT="SCRS";K.COLLECTION_ITEM_TYPES.ITEM_TYPE_IMAGE="IMG";K.COLLECTION_ITEM_TYPES.ITEM_TYPE_DOCUMENT="DOC";K.COLLECTION_ITEM_TYPES=Object.freeze(K.COLLECTION_ITEM_TYPES);jQuery.extend(K,{getCollectionItem:g.bind(K),getQuickCreateItem:d.bind(K),updateDraftID:u.bind(K),getRootControl:j.bind(K),isDraftEnabled:l.bind(K),isCurrentUserCreator:n.bind(K),getQuickCreateRootBindingContext:p.bind(K),getQuickCreateRootEntityType:q.bind(K),_onComponentContainerAfterRendering:r.bind(K),calculateViewHeight:z.bind(K),setComponentContainerHeight:B.bind(K),getQuickCreateModel:m.bind(K),objectCreated:E.bind(K),destroy:G.bind(K),getRootView:k.bind(K),setRootView:s.bind(K),getComponentInstance:e.bind(K),getComponentContainer:f.bind(K),_onDataBindingChanged:w.bind(K),_attachToModelBindingChanges:t.bind(K),loadQuickCreateModelFromJSON:v.bind(K),_updateModelJSON:x.bind(K),getCopilotModel:h.bind(K),discardQuickCreateDraft:y.bind(K),_onLineItemsFound:_.bind(K),fireQuickCreateViewCreated:F.bind(K),getCollectionItems:I.bind(K),getCollectionParticipants:J.bind(K)});c.addEventDelegate({onAfterRendering:K._onComponentContainerAfterRendering});K._InstanceKey=K.getCollectionItem().copilotEntity.getODataKey();if(Q._Instances[K._InstanceKey]){Q._Instances[K._InstanceKey].destroy();}delete Q._Instances[K._InstanceKey];Q._Instances[K._InstanceKey]=K;sap.ui.getCore().getEventBus().subscribe(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_LINE_ITEMS_FOUND,K._onLineItemsFound,K);C.oQuickCreateAPI=K;return C.oQuickCreateAPI;};return Q;},true);
