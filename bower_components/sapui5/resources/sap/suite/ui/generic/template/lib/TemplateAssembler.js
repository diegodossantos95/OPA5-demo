sap.ui.define(["jquery.sap.global","sap/ui/core/mvc/View","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/suite/ui/generic/template/lib/TemplateViewController","sap/suite/ui/generic/template/lib/TemplateComponent","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/CRUDManager","sap/suite/ui/generic/template/lib/CommonUtils","sap/suite/ui/generic/template/lib/ComponentUtils","sap/suite/ui/generic/template/lib/CommonEventHandlers","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/routingHelper","sap/suite/ui/generic/template/lib/testableHelper"],function(q,V,J,R,T,a,A,C,b,c,d,e,r,t){"use strict";var m=Object.create(null);var f=Object.create(null);var g=function(o){var s=o.appComponent.getId();m[s]=o;return function(){delete m[s];};};function h(o){var s=o.getId();var n=m[s];return n;}function i(o){return h(o.getAppComponent()).oTemplateContract.componentRegistry[o.getId()];}function F(o){while(o&&!(o instanceof V)){o=o.getParent();}return o;}function G(o){while(o){var v=F(o);var n=v&&v.getController();var p=n&&n.getOwnerComponent();if(p instanceof a){var s=i(p);return s;}else{o=p&&p.oContainer;}}}function j(n,s,o,p,u){o=o||{};o.constructor=function(){T.prototype.constructor.apply(this,arguments);var M=n(p,this);this._templateEventHandlers=Object.freeze(M.handlers||{});this._templateFormatters=Object.freeze(M.formatters||{});this.extensionAPI=Object.freeze(M.extensionAPI||{});this.fnGenericOnInit=function(v){var w=v.getView();var x=w.getId();q.sap.log.info("Init view "+x+" of template "+s);var y=v.getOwnerComponent();var z=i(y);z.oControllerRegistryEntry={onExit:M.onExit||q.noop,oTemplateUtils:p,oAppRegistryEntry:u};f[x]=z.oControllerRegistryEntry;p.oServices.oApplicationController.registerView(w);p.oCommonUtils=new b(v,p.oServices,p.oComponentUtils);p.oServices.oCRUDManager=new C(v,p.oComponentUtils,p.oServices,p.oCommonUtils,u.oTemplateContract.oBusyHelper);p.oCommonEventHandlers=new d(v,p.oComponentUtils,p.oServices,p.oCommonUtils);(M.onInit||q.noop)();z.oController=this;z.fnViewRegisteredResolve();delete z.fnViewRegisteredResolve;};};o.onInit=function(){this.fnGenericOnInit(this);delete this.fnGenericOnInit;};o.onExit=function(){var v=this.getView().getId();var w=f[v];w.oAppRegistryEntry.oTemplateContract.oApplicationProxy.destroyView(v);w.onExit();delete f[v];q.sap.log.info("View "+v+" of template "+s+" exited");};return T.extend(s,o);}function k(o){var n=o.methods.oControllerSpecification;return n&&function(){var p=o.oComponent.getAppComponent();var s=h(p);var u=p.getTransactionController();var v={oComponentUtils:o.utils,oServices:{oTemplateCapabilities:{},oApplicationController:p.getApplicationController(),oTransactionController:u,oNavigationController:p.getNavigationController(),oDraftController:u.getDraftController(),oApplication:s.application,oViewDependencyHelper:s.oViewDependencyHelper}};return j(n.getMethods,o.oComponent.getTemplateName(),n.oControllerDefinition,v,s);};}function l(o,n){var s=o.oComponent.getEntitySet();var p=h(o.oComponent.getAppComponent()).oTemplateContract;var u=p.mEntityTree[s];var v=u.embeddedComponents;for(var w in v){var x=v[w];if(o.oController.byId(x.containerId)===n){var y=n.getComponentInstance();o.reuseComponentProxies.push(y._stProxy);var z=o.utils.getTemplatePrivateModel();z.setProperty("/generic/embeddedComponents/"+w,{});return{embeddedKey:w,embeddedComponent:x,templateContract:p,reuseComponent:y};}}}function E(o,n){var p=o.oController.extensionAPI;var s=q.extend({},p);if(p.getNavigationController){var N=q.extend({},p.getNavigationController());var u=N.navigateInternal;N.navigateInternal=function(v,w){var x=w&&w.routeName;if(x){o.utils.navigateRoute(x,v,n.embeddedKey,w&&w.replaceInHistory);}else{u(v,w);}};s.getNavigationController=function(){return N;};N.getSubCommunicationModel=function(){return n.embeddedComponent.communicationModel;};}s.getCommunicationObject=function(L){return L===1?n.embeddedComponent.communicationObject:o.utils.getCommunicationObject(L);};(o.methods.enhanceExtensionAPI4Reuse||q.noop)(s,n);return s;}g=t.testableStatic(g,"TemplateComponent_RegisterAppComponent");return{getTemplateComponent:function(n,s,o){var p=s+".Component";o=o||{};o.init=function(){var u=this.getComponentData().registryEntry;u.viewRegisterd=new Promise(function(v){u.fnViewRegisteredResolve=v;});u.oViewRenderdPromise=new Promise(function(v){u.fnViewRenderdResolve=v;});u.reuseComponentProxies=[];(a.prototype.init||q.noop).apply(this,arguments);u.componentName=p;u.oComponent=this;u.activationTakt=0;u.utils=new c(this,u);u.methods=n(this,u.utils)||{};u.oGenericData={mRefreshInfos:{}};(u.methods.init||q.noop)();};o.exit=function(){var I=this.getId();var u=i(this);var v=h(this.getAppComponent());var M=u.methods;(M.exit||q.noop)();delete v.oTemplateContract.componentRegistry[I];(a.prototype.exit||q.noop).apply(this,arguments);};o.onBeforeRendering=function(){var u=i(this);if(!u.oTemplateContract){var v=h(this.getAppComponent());u.oTemplateContract=v.oTemplateContract;}(a.prototype.onBeforeRendering||q.noop).bind(this,u).apply(this,arguments);var M=u.methods;(M.onBeforeRendering||q.noop)();};o.onAfterRendering=function(){var u=i(this);if(u.fnViewRenderdResolve&&!u.fnViewRegisteredResolve){u.fnViewRenderdResolve();delete u.fnViewRenderdResolve;}(a.prototype.onAfterRendering||q.noop).bind(this,u).apply(this,arguments);var M=u.methods;(M.onAftereRendering||q.noop)();};o.onActivate=function(B,I){var u=i(this);u.sCurrentBindingPath=B;var v=function(){u.utils.bindComponent(u.sCurrentBindingPath,I);var U=this.getIsRefreshRequired();if(U||!q.isEmptyObject(u.oGenericData.mRefreshInfos)){(u.methods.refreshBinding||q.noop)(U,U?{}:u.oGenericData.mRefreshInfos);this.setIsRefreshRequired(false);u.oGenericData.mRefreshInfos={};}return(u.methods.onActivate||q.noop)(B);}.bind(this);return u.fnViewRegisteredResolve?u.viewRegisterd.then(v):(v()||Promise.resolve());};o.setContainer=function(){a.prototype.setContainer.apply(this,arguments);var I=this.getId();var u=this.getAppComponent();var v=h(u);if(!v.oTemplateContract.componentRegistry[I]){var w=this.getComponentData();var x=w.registryEntry;delete w.registryEntry;x.componentCreateResolve(this);delete x.componentCreateResolve;v.oTemplateContract.componentRegistry[I]=x;v.oTemplateContract.oBusyHelper.setBusy(x.viewRegisterd,true);x.oApplication=v.application;x.createViewController=k(x);(x.methods.setContainer||q.noop)();}};o.setIsRefreshRequired=function(I){if(I){var u=i(this);if(u.methods.refreshBinding&&u.utils.isComponentActive()){u.viewRegisterd.then(u.methods.refreshBinding.bind(null,true,{}));I=false;}}this.setProperty("isRefreshRequired",I);};o.onDeactivate=q.noop;return a.extend(p,o);},getRegisterAppComponent:function(){var n=g;g=null;return n;},getExtensionAPIPromise:function(o){var n=G(o);if(!n){return Promise.reject();}return n.viewRegisterd.then(function(){var p=l(n,o);if(p){return E(n,p);}return n.oController.extensionAPI;});},getExtensionAPI:function(o){var n=G(o);return n&&n.oController&&n.oController.extensionAPI;}};});
