sap.ui.define(["sap/suite/ui/generic/template/AnalyticalListPage/controller/KpiCardController","sap/ui/model/json/JSONModel","sap/ui/model/json/JSONModel","sap/ui/core/mvc/ViewType","sap/m/Popover"],function(K,J,F,V,P){"use strict";var O;jQuery.sap.declare("sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiTagController");sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiTagController={_kpiCards:[],init:function(s){var m=this;m.oState=s;m.oGenericModel=new J();var g={header:"Some Header",title:"Some Title",titleUrl:"",icon:"sap-icon://camera"};m.oGenericModel.setData(g);if(O===undefined){O=sap.ui.getCore().loadLibrary("sap.ovp",{async:true});}},openKpiCard:function(e){var m=this;var s;if(typeof e.currentTarget!="undefined"){s=sap.ui.getCore().byId(e.currentTarget.id);}else{s=e.getSource();}O.then(function(){m.createPopover(function(){m._openCard(s);}.bind(m,s),s);});},_openCard:function(s){var m=this;jQuery.sap.delayedCall(0,this,function(){m._kpiCards[s.getQualifier()].openBy(s);});},handleKpiPress:function(e){this.openKpiCard(e);},createPopover:function(o,s){var m=this;var q=s.getQualifier();var c=m.oState.oController.getOwnerComponent();var S=c.getComponentContainer().getSettings();var k=S.keyPerformanceIndicators;var Q;for(var a in k){if(k[a].hasOwnProperty("qualifier")&&k[a].qualifier===q){Q=k[a];break;}}if(!Q){jQuery.sap.log.error("KPI settings not found with qualifier.");return;}var b=S.appComponent.getManifestEntry("/sap.app/crossNavigation/outbounds/"+Q.detailNavigation);var M=c.getModel(Q.model);M.getMetaModel().loaded().then(function(){var m=this;var d;m._oCardController=new K();var c=m.oState.oController.getOwnerComponent();var p=new J();var Q=arguments[0];var M=c.getModel(Q.model);var e=M.getMetaModel();var E=e.getODataEntitySet(Q.entitySet);var f=e.getODataEntityType(E.entityType);var g=f["com.sap.vocabularies.UI.v1.SelectionPresentationVariant#"+q];var h=g.PresentationVariant&&g.PresentationVariant.Path;if(!h){jQuery.sap.log.error("PresentationVariant does not have Path.");return;}var v=f[h.split("@")[1]].Visualizations;v.forEach(function(A){if(A.AnnotationPath.indexOf("DataPoint")>0){d=A.AnnotationPath.split("@")[1];}});var D=f[d];var i=e.getODataProperty(f,D.Value.Path);var j;var C=f["com.sap.vocabularies.UI.v1.Chart#"+q];if(C.MeasureAttributes[0]&&C.MeasureAttributes[0].DataPoint){j=f[(C.MeasureAttributes[0].DataPoint.AnnotationPath).toString().substring(1)];}Q.metaModel=e;p.setData(Q);var l=sap.ui.view({async:false,preprocessors:{xml:{bindingContexts:{entityType:e.createBindingContext(e.getODataEntityType(E.entityType,true)),entitySet:e.createBindingContext(e.getODataEntitySet(Q.entitySet,true))},models:{entitySet:e,entityType:e,parameter:p},dataModel:M,settings:p,preprocessorsData:c.getComponentData().preprocessorsData}},type:V.XML,viewName:"sap.suite.ui.generic.template.AnalyticalListPage.view.KpiCardSizeM",height:"100%"});l.data({"qualifierSettings":Q,"dataPoint":D,"dataPointMeasure":j,"chart":C,"entityTypeProperty":i});l.setModel(c.getModel(Q.model));var n=new sap.ui.model.json.JSONModel();var r={"visible":Q.detailNavigation?true:false};if(Q.detailNavigation&&b){r.target=b.semanticObject;r.action=b.action;r.parameters=JSON.stringify(b.parameters?b.parameters:{});}else{r.visible=false;}n.setData(r);l.setModel(n,"detailNavigation");if(typeof m._kpiCards[q]!="undefined"){m._kpiCards[q].destroy();}m._kpiCards[q]=new P();m._kpiCards[q].setShowHeader(false);m._kpiCards[q].addContent(l);m._oKpiCardController=l.getController();m._oKpiCardController._assignCommonUtils(m.oState.oTemplateUtils.oCommonUtils);m.oState.oController.getView().addDependent(m._kpiCards[q]);o();}.bind(this,Q));},onExit:function(){if(this._oKpiCard){this._oKpiCard.destroy();}},_setModel:function(m){this._oKpiCard.setModel(m);}};return sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiTagController;});
