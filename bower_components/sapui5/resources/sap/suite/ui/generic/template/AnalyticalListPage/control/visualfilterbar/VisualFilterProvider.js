sap.ui.define(["sap/ui/comp/odata/MetadataAnalyser","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms"],function(M,F,V){"use strict";var c=function(f){this._filter=f;this._oMetadataAnalyser=new M(f.getModel());this._groupList=[];this._groupListByName={};this._groupMap={};this._measureList=[];this._measureMap={};this._dimensionMap={};this._selectionFieldsLength=0;this._selectionFieldsParsed=0;this._annotationData={Filters:[]};this._allSelectionFields;this._initMetadata();};c.prototype._initMetadata=function(){var e=this._filter.getEntitySet();var a=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);this._getFieldAnnotations(e,a);this._getVisualFilterAnnotation(a);};c.prototype.getVisualFilterConfig=function(){return this._filterConfig;};c.prototype.getMetadataAnalyser=function(){return this._oMetadataAnalyser;};c.prototype._getFieldAnnotations=function(e,a){if(!e){return;}var b=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);if(!b){return;}var m=this._filter.getModel();var d=m.getMetaModel();if(!a||!d){return;}var g={};var f={};var h=this._oMetadataAnalyser.getFieldGroupAnnotation(b);for(var i=0;i<h.length;i++){var k=h[i];var l={name:k.groupName,label:k.groupLabel,fieldList:k.fields};f[l.name]=l;for(var j=0;j<k.fields.length;j++){g[k.fields[j]]=l;}}var n=d.getODataEntityType(a);var s=n[V.SelectionFields];var o={};if(s){for(var i=0;i<s.length;i++){var p=s[i];o[p.PropertyPath]=p;}}var u={};var q=this._oMetadataAnalyser.getFieldsByEntityTypeName(b);for(var i=0;i<q.length;i++){var r=q[i];var t=r.name;var v=d.getODataProperty(n,t);var w=v["sap:aggregation-role"];if(w=="dimension"){var x={name:t,fieldInfo:r,propInfo:v};var l=g[t];if(l){for(var j=0;j<l.fieldList.length;j++){if(l.fieldList[j]==t){l.fieldList[j]=x;break;}}}else{var L=n[V.Label]?n[V.Label].String:undefined;var y=o[t]?"_BASIC":(n[L]||n.name);var l=f[y];if(!l){l={name:y,label:y=="_BASIC"?this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE"):y,fieldList:[]};f[y]=l;}l.fieldList.push(x);g[t]=l;}u[l.name]=true;}}var z=[];if(u["_BASIC"]){z.push(f["_BASIC"]);delete f["_BASIC"];}for(var i=0;i<h.length;i++){var y=h[i].groupName;if(y=="_BASIC"){continue;}if(u[y]){z.push(f[y]);}delete f[y];}for(var y in f){if(u[y]){z.push(f[y]);}delete f[y];}f={};for(var i=0;i<z.length;i++){var l=z[i];f[l.name]=l;}};c.prototype.getGroupList=function(){return this._groupList?this._groupList:[];};c.prototype.getGroupMap=function(){return this._groupMap?this._groupMap:{};};c.prototype.getMeasureMap=function(){return this._measureMap;};c.prototype.getDimensionMap=function(){return this._dimensionMap;};c.prototype.getEntityType=function(e){return this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);};c.prototype._updateGroupList=function(e,a,p,d){var i=function(g){return g.PropertyPath===p;};var b;if(this._allSelectionFields){b=this._allSelectionFields.filter(i);}b=(b&&b.length)?true:false;var m=this._filter.getModel().getMetaModel();var f=m.getODataEntityType(e);f=f[V.Label]?f[V.Label].String:f.name;var u=function(g,h){for(var k in h._groupList){var j=h._groupList[k],l=false;if(j.name===g){var n=j.fieldList;for(var o in n){if(n[o].name===d){l=true;}else{continue;}}if(!l){var q=m.getODataEntityType(a);var r=h._oMetadataAnalyser.getFieldsByEntityTypeName(a);for(var k in r){if(r[k].name===d){var s=m.getODataProperty(q,r[k].name);n.push({name:r[k].name,fieldInfo:r[k],propInfo:s});}}}}else{continue;}}};if(b){u('_BASIC',this);}else{u(f,this);}};c.prototype._createDimensionMap=function(e,a){var b,m=this._filter.getModel(),d=m.getMetaModel(),f,g={},p,h,i,j={};if(!d){return false;}f=d.getODataEntityType(a);b=this._oMetadataAnalyser.getFieldsByEntityTypeName(a);for(var k in b){p=d.getODataProperty(f,b[k].name);if(b[k]['aggregationRole']==='dimension'){h={name:b[k].name,fieldInfo:b[k],propInfo:p};g[b[k].name]=h;}else if(b[k]['aggregationRole']==='measure'){i={name:b[k].name,label:b[k].fieldLabel,fieldInfo:b[k],propInfo:p};j[b[k].name]=i;}}if(Object.keys(g).length){this._dimensionMap[e]=g;}if(Object.keys(j).length){this._measureMap[e]=j;}};c.prototype._createGroupList=function(f,p,i,g){var a;if(i){a=this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE");this._addToGroupListByName('_BASIC',a,f,p);}else{a=f.groupTitle;this._addToGroupListByName(g,a,f,p);}};c.prototype._addToGroupListByName=function(g,a,f,p){if(this._groupListByName[g]===undefined){this._groupListByName[g]=[];this._groupListByName[g].push({name:g,label:a,fieldList:[]});this._groupListByName[g][0].fieldList.push({name:f.name,fieldInfo:f,propInfo:p});}else{this._groupListByName[g][0].fieldList.push({name:f.name,fieldInfo:f,propInfo:p});}};c.prototype._setGroupListForDialog=function(){if(Object.keys(this._groupListByName).length){for(var k in this._groupListByName){this._groupList.push(this._groupListByName[k][0]);}}var g={};for(var i=0;i<this._groupList.length;i++){var a=this._groupList[i];g[a.name]=a;}this._groupMap=g;};c.prototype._sortVisualFilter=function(d,e){if(e.filterList){e.filterList.sort(function(a,b){var I,f;if(d){for(var i=0;i<d.length;i++){if(d[i].PropertyPath===a.parentProperty){I=i;}if(d[i].PropertyPath===b.parentProperty){f=i;}if(I&&f){break;}}}if((I<f)||(!I&&a.isMandatory)){return-1;}if((I>f)||(!f&&b.isMandatory)){return 1;}return 0;});}return e;};c.prototype._getScaleFactor=function(e,a){if(!a){return"";}if(a.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){a=a.toString();if(a.charAt(0)==="@"){a=a.slice(1);}var E=e[a];if(E&&E.ValueFormat&&E.ValueFormat.ScaleFactor){return F.getPathOrPrimitiveValue(E.ValueFormat.ScaleFactor);}else{return"";}}};c.prototype._getNumberOfFractionalDigits=function(e,a){if(!a){return"";}if(a.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){a=a.toString();if(a.charAt(0)==="@"){a=a.slice(1);}var E=e[a];if(E&&E.ValueFormat&&E.ValueFormat.NumberOfFractionalDigits){return F.getPathOrPrimitiveValue(E.ValueFormat.NumberOfFractionalDigits);}else{return"";}}};c.prototype._getVisualFilterAnnotation=function(e){var m=this._filter.getModel();var a=m.getMetaModel();if(!e||!a){return null;}var b=a.getODataEntityType(e);if(!b){return null;}this._allSelectionFields=b[V.SelectionFields];var d=this._filter._smartFilterContext.getFilterBarViewMetadata(),i,f,g,G,h,v,j,k,l=[],n,p;for(var o in d){l=d[o].fields;G=d[o].groupName;for(var P in l){i=l[P].filterable;f=l[P].filterRestriction;if(f==="auto"){f="multiple";}if(f!=="interval"&&i!=="false"){n=l[P];j=l[P].fieldName;g=l[P].isMandatory;h=l[P].requiredFilterField;for(var q in l[P]){if(q.indexOf(V.ValueList)>-1&&l[P][q].PresentationVariantQualifier){k=(G==="_BASIC")||g||h;p=a.getODataProperty(b,j);v=l[P][q];this._createGroupList(n,p,k,G);this._getAnnotationFromValueList(e,k,v,j,f,g);}}}}}this._setGroupListForDialog();this._filterConfig=this._getConfig(this._annotationData);};c.prototype._getAnnotationFromValueList=function(e,i,v,p,f,I,a){var P=e;if(v!==undefined){var b={Filters:[]},d=F.readProperty(v,"PresentationVariantQualifier.String"),g=F.readProperty(v,"CollectionPath"),h=F.readProperty(v,"Parameters"),j=F.readProperty(g,"String"),P=this.getEntityType(j),m=this._filter.getModel(),k=m.getMetaModel(),l=k.getODataEntityType(P);if(d){var q=d,n=this._oMetadataAnalyser.getPresentationVariantAnnotation(P,q),o={},r=F.readProperty(n,"chartAnnotation.annotation.Dimensions.0.PropertyPath");if(r){this._createDimensionMap(g.String,P);this._updateGroupList(e,P,p,r);o=this._createConsumeableObjectFromAnnotation(n,g,i,h,p,f,I,l);b.Filters.push(o);this._annotationData.Filters.push(o);}}}};c.prototype._createSortObject=function(C,m,d,D){var s=m,S=true;if(C==="Line"){s=d;if(!D){S=false;}}var o={};o.Field={"String":s};o.Descending={"Boolean":S};return o;};c.prototype._createSortOrderFromAnnotation=function(p,m,d,C,a,D){a.SortOrder=[];var s=p.annotation.SortOrder,S,b;if(s!==undefined&&s.length){for(var i=0;i<s.length;i++){var e=F.readProperty(s,i+".Property.PropertyPath"),I=F.readProperty(s,i+".Descending.Bool");if(e&&I){if(C==="Line"){if(!D){if(e===d){b=d;S=!(I==="false");break;}}}else if(e===m){b=m;S=!(I==="false");break;}}}if(b){var o={};o.Field={"String":b};o.Descending={"Boolean":S};a.SortOrder.push(o);}}if(!a.SortOrder.length){a.SortOrder.push(this._createSortObject(C,m,d,D));}return a;};c.prototype._getChartQualifier=function(p){var v=p.annotation.Visualizations,a;a=v?(v[0].AnnotationPath).substring(1):undefined;return a;};c.prototype._IsDimensionDateTime=function(e,d){var D=this.getDimensionMap(),o=F.readProperty(D,e+"."+d+".fieldInfo"),b=false,f;if(o.type==="Edm.DateTime"||o.type==="Edm.Time"){b=true;}else{f=o[V.CalendarYear]||o[V.CalendarYearMonth]||o[V.CalendarYearMonthDay];if(f&&f.Bool&&f.Bool==="true"){b=true;}}return b;};c.prototype._createConsumeableObjectFromAnnotation=function(p,a,i,b,d,f,I,e){var g={},E=this._oMetadataAnalyser.getEntitySetNameFromEntityTypeName(this.getEntityType(a.String)),h=p.chartAnnotation.annotation.ChartType.EnumMember.split("/"),j=h[h.length-1],D;if(j){g.Type={"String":j};}var k=F.readProperty(p,"chartAnnotation.annotation.Dimensions.0.PropertyPath");var m=F.readProperty(p,"chartAnnotation.annotation.Measures.0.PropertyPath");if(m&&k){D=this._IsDimensionDateTime(E,k);g.dimensionFieldIsDateTime=D;g=this._createSortOrderFromAnnotation(p,m,k,j,g,D);}var s="";if(m&&p.chartAnnotation.measureAttributes[m]){s=p.chartAnnotation.measureAttributes[m].dataPoint;}var l=this._getScaleFactor(e,s);var n=this._getNumberOfFractionalDigits(e,s);var o=this._getChartQualifier(p);g.scaleFactor={"String":l};g.numberOfFractionalDigits={"String":n};g.chartQualifier=o;if(f){g.filterRestriction={"String":f};}else{g.filterRestriction={"String":undefined};}if(k){g.Dimensions=[];var q={};q.Field={"String":k};g.Dimensions.push(q);}if(m){g.Measures=[];var r={};r.Field={"String":m};g.Measures.push(r);}if(i){g.Selected={"Boolean":"true"};}else{g.Selected={"Boolean":"false"};}if(a){g.CollectionPath=a;}if(b&&b.length){g.InParameters=[];for(var t in b){var u=b[t]?b[t]:undefined,v=(u&&u.RecordType)?u.RecordType:undefined,w=(u.ValueListProperty&&u.ValueListProperty.String)?u.ValueListProperty.String:undefined,x=(u.LocalDataProperty&&u.LocalDataProperty.PropertyPath)?u.LocalDataProperty.PropertyPath:undefined;if(u&&v&&w&&x){if(g.OutParameter===undefined&&(v===V.ValueListParameterOut||v===V.ValueListParameterInOut)&&w===k&&x===d){g.OutParameter=x;}if(x!==d&&(v===V.ValueListParameterIn||v===V.ValueListParameterInOut)){var y=this._filter.getModel().getMetaModel(),z=this.getEntityType(a.String),A=y.getODataEntityType(z),B=y.getODataProperty(A,w);if(B['sap:filterable']===undefined||B['sap:filterable']=="true"){g.InParameters.push({localDataProperty:x,valueListProperty:w});}else{jQuery.sap.log.error('IN Parameter valueListProperty: '+w+' is not sap:filterable');}}}}if(g.InParameters.length===0){g.InParameters=undefined;}}if(d){g.ParentProperty=d;}g.isMandatoryProperty=I;return g;};c.prototype._getConfig=function(a){var b={filterList:[]};if(!a){return b;}var f={};var d={};var e=a.Filters;for(var i=0;i<e.length;i++){var g=e[i];var p=g.ParentProperty;var h=g.Dimensions[0].Field.String;var l=g.CollectionPath.String;var m=this._dimensionMap[l][h];if(!m){jQuery.sap.log.error("Unknown Dimension :"+h);continue;}var n=g.Measures[0].Field.String;var o=this._measureMap[l][n];if(!o){jQuery.sap.log.error("Unknown Measure :"+n);continue;}var q=m.fieldInfo.description;if(!q){q=h;}if(!f[h]){f[h]=[];}if(!d[p]){d[p]=[];}var r={type:g.Type.String,selected:g.Selected.Boolean=="true",dimension:{field:h,fieldDisplay:q},measure:{field:g.Measures[0].Field.String},sortOrder:g.SortOrder,scaleFactor:g.scaleFactor.String,numberOfFractionalDigits:g.numberOfFractionalDigits.String,chartQualifier:g.chartQualifier,dimensionFieldIsDateTime:g.dimensionFieldIsDateTime};r.collectionPath=g.CollectionPath.String;r.outParameter=g.OutParameter;r.inParameters=g.InParameters;r.parentProperty=g.ParentProperty;r.filterRestriction=g.filterRestriction.String;r.isMandatory=g.isMandatoryProperty;d[p].push(r);f[h].push(r);}var u={};for(var i=0;i<this._groupList.length;i++){var s=this._groupList[i];for(var j=0;j<s.fieldList.length;j++){var t=s.fieldList[j];var e=d[t.name];if(!e){continue;}u[s.name]=true;for(var k=0;k<e.length;k++){b.filterList.push(e[k]);}}}for(var i=this._groupList.length-1;i>=0;i--){var s=this._groupList[i];if(u[s.name]){continue;}this._groupList.splice(i,1);delete this._groupMap[s.name];}b=this._sortVisualFilter(this._allSelectionFields,b);return b;};return c;},true);
