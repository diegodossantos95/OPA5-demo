sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant"],function(q,B,N,S){"use strict";var d="sap.suite.ui.generic.template.customData",a="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function g(s,c,o){var b=c.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var e=false;var h=null;var A=Promise.resolve();var D=false;var k=false;var E=c.byId("editStateFilter");var l;var m=null;var p=null;s.oSmartFilterbar.setSuppressSelection(true);var t=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function u(){return D;}function v(){var j={};j[d]={};var V=[];var U=t();for(var i=0;i<U.length;i++){var W=U[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(W)){V.push(W);}}j[a]={suppressDataSelection:!D,visibleCustomFields:V};if(E){j[a].editStateFilter=E.getSelectedKey();}if(s.oIconTabBar){j[a].tableTabData={selectedTab:s.oIconTabBar.getSelectedKey(),tableVariantIds:{}};for(var i in s.aSmartTables){var X=s.aSmartTables[i];if(!j[a].tableTabData.tableVariantIds){j[a].tableTabData.tableVariantIds={};}j[a].tableTabData.tableVariantIds[X.getId()]=X.getCurrentVariantId()||"";}}var Y=s.oMultipleViewsSingleTableModeHelper&&s.oMultipleViewsSingleTableModeHelper.getState();if(Y){j[a].tableViewData=Y;}c.getCustomAppStateDataExtension(j[d]);return j;}function w(){var j=s.oSmartFilterbar.getDataSuiteFormat();var U=new S(j);var V=c.getVisibleSelectionsWithDefaults();for(var i=0;i<V.length;i++){if(!U.getValue(V[i])){U.addSelectOption(V[i],"I","EQ","");}}if(c.byId('template::PageVariant')&&c.byId('template::PageVariant').currentVariantGetModified()&&U.getID()){U.setID("");}var W={selectionVariant:U.toJSONString(),tableVariantId:(!b&&s.oSmartTable.getCurrentVariantId())||"",customData:v()};return W;}function x(){if(!k){return;}k=false;try{m=o.storeInnerAppStateWithImmediateReturn(w(),true);}catch(i){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(m instanceof N){k=true;m=null;return;}m.promise.fail(function(j){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+j);});if(p!==m.appStateKey){o.replaceHash(m.appStateKey);}}function R(j,U){if(j&&j.editStateFilter!==undefined){if(E){E.setSelectedKey((j.editStateFilter===null)?0:j.editStateFilter);}}var V=j&&j.visibleCustomFields;if(V&&V.length>0){var W=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<W.length;i++){var X=W[i];var Y=X.getName();if(V.indexOf(Y)!==-1){X.setVisibleInFilterBar(true);}}}D=U&&!(j&&j.suppressDataSelection);if(D){s.oSmartFilterbar.search();T(D);}}function y(i){c.restoreCustomAppStateDataExtension(i||{});}function z(i,j){i=i||{};if(i.hasOwnProperty(d)&&i.hasOwnProperty(a)){y(i[d]);R(i[a],j);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}y(i);}}function C(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":[r.appStateKey]};}return r.urlParams;});}function F(i,j){if(e){return;}if(i||j!==D){D=j;if(!k){k=true;if(!s.oSmartFilterbar.isDialogOpen()){if(h){x();}else{setTimeout(x,0);}}}}}function G(U,V,W,X){s.oSmartFilterbar.setSuppressSelection(false);var Y=V.appStateKey||"";if(e){return;}if(p===null){p=Y;}else if(Y!==p){return;}e=true;var Z;var $=V.selectionVariant||"";var _=(!b&&V.tableVariantId)||"";var a1=(!Y&&W)||{};if(!s.bWorkListEnabled){if((r.appStateKey!==Y||r.selectionVariant!==$||r.tableVariantId!==_||f(r.urlParams,a1))&&X!==sap.ui.generic.app.navigation.service.NavType.initial){if(!m||m.appStateKey!==Y){var b1=V&&V.bNavSelVarHasDefaultsOnly;if(V.oSelectionVariant&&r.selectionVariant!==$){var c1=V.oSelectionVariant.getParameterNames().concat(V.oSelectionVariant.getSelectOptionsPropertyNames());for(var i=0;i<c1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(c1[i]);}}if(b1&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.setDataSuiteFormat($);}else if(!b1||s.oSmartFilterbar.isCurrentVariantStandard()){s.oSmartFilterbar.clearVariantSelection();s.oSmartFilterbar.clear();s.oSmartFilterbar.setDataSuiteFormat($,true);}if(_!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(_);}V.customData=V.customData||{};if(V.customData[a]&&V.customData[a].tableTabData){Z=V.customData[a].tableTabData.selectedTab;}if(s.oIconTabBar&&Z){s.oIconTabBar.setSelectedKey(Z);var d1,e1;d1=s.oSmartTable;e1=c.byId("listReport-"+Z);if(e1){s.oSmartTable=e1;d1.setVisible(false);s.oSmartTable.setVisible(true);}if(V.customData[a].tableTabData.tableVariantIds){for(var j in s.aSmartTables){var f1=s.aSmartTables[j];var g1=V.customData[a].tableTabData.tableVariantIds[f1.getId()];if(g1){f1.setCurrentVariantId(g1);}}}}if(V.customData[a]&&V.customData[a].tableViewData){s.oMultipleViewsSingleTableModeHelper.restoreState(V.customData[a].tableViewData);}z(V.customData,true);}r={appStateKey:Y,urlParams:a1,selectionVariant:$,tableVariantId:_};}}if(h){h();h=null;}if(X!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var h1=(X===sap.ui.generic.app.navigation.service.NavType.xAppState||X===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!V.bNavSelVarHasDefaultsOnly;D=h1||s.bLoadListAndFirstEntryOnStartup||l||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();if(D){s.oSmartFilterbar.search();T(D);}}m=null;U();e=false;}function P(){if(!h){A=new Promise(function(j){h=j;});}var i=new Promise(function(j,U){var V=o.parseNavigation();V.done(G.bind(null,j));V.fail(U);});return i;}function H(){var i=w();s.oSmartFilterbar.setFilterData({_CUSTOM:i.customData});}function J(){F(true,D);}function K(i){var j=i.getParameter("context");var U=s.oSmartFilterbar.getFilterData();if(U._CUSTOM!==undefined){z(U._CUSTOM);}else{var V=v();n(V[d]);n(V[a]);z(V);}if(I.indexOf(j)<0){D=i.getParameter("executeOnSelect");F(true,D);}}function L(){if(!b){F(true,D);}}function M(){if(!b){F(true,D);}}function O(i){var j=i.getParameter("arguments");var U=j&&j["?query"];p=(U&&U["sap-iapp-state"])||"";if(m){if(m.appStateKey!==p){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+p+" expected "+m.appStateKey);return false;}P();return true;}return false;}function Q(){l=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(x);}function T(D){if(c&&c.getOwnerComponent&&c.getOwnerComponent().getModel){var i=c.getOwnerComponent().getModel("_templPriv");if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}}s.getCurrentAppState=w;return{areDataShownInTable:u,parseUrlAndApplyAppState:P,getUrlParameterInfo:C,changeIappState:F,onSmartFilterBarInitialise:Q,onBeforeSFBVariantFetch:H,onAfterSFBVariantSave:J,onAfterSFBVariantLoad:K,onAfterTableVariantSave:L,onAfterApplyTableVariant:M,isStateChange:O};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,c,o){q.extend(this,g(s,c,o));}});});
