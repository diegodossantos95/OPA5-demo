sap.ui.define(["sap/suite/ui/microchart/InteractiveBarChart","sap/suite/ui/microchart/InteractiveBarChartBar","sap/ui/model/json/JSONModel","sap/suite/ui/generic/template/AnalyticalListPage/control/visualfilterbar/FilterItemMicroChart","sap/suite/ui/generic/template/AnalyticalListPage/util/CriticalityUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil"],function(I,a,J,F,C,b){"use strict";var c=F.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroBar",{metadata:{properties:{fixedCount:{type:"int",defaultValue:3},labelWidthPercent:{type:"float",group:"Misc",defaultValue:1/3}},aggregations:{control:{type:"sap.suite.ui.microchart.InteractiveBarChart",multiple:false}}},renderer:{}});c.prototype.init=function(){this._chart=new sap.suite.ui.microchart.InteractiveBarChart({maxDisplayedBars:3,selectionEnabled:true,bars:[]});this.setControl(this._chart);this.setModel(new J(),'__alp_chartJSONModel');this._sorters=[];F.prototype.init.apply(this,arguments);};c.prototype._updateBinding=function(){this.applyOverlay();this._chart.setBusyIndicatorDelay(0);this._chart.setBusy(true);this._chart.unbindBars();var d=this.getEntitySet(),f=this.getDimensionField(),g=this.getDimensionFieldDisplay(),m=this.getMeasureField(),u=this.getUnitField(),h=this.getDimensionFilterExternal(),s=[],S=this.getSortOrder(),o=F._getSorter(S);this._sorters=o.sorter;s=o.sortFields;if(!d||!m||!f||!g){return;}var i=[m,f,s];if(f!=g){i.push(g);}if(u){i.push(u);}var j=[];if(h&&h.aFilters&&h.aFilters.length){j=[h];}var k=this;var l=this.getFixedCount();var M=this.getModel();var B="/"+d;if(M){var D=C.getDataPoint(M,this);if(D){(D.ValueFormat&&D.ValueFormat.ScaleFactor)?this.setScaleFactor(b.getPrimitiveValue(D.ValueFormat.ScaleFactor)):this.setScaleFactor(null);(D.ValueFormat&&D.ValueFormat.NumberOfFractionalDigits)?this.setNumberOfFractionalDigits(b.getPrimitiveValue(D.ValueFormat.NumberOfFractionalDigits)):this.setNumberOfFractionalDigits(null);var r=C.getCriticalityRefProperties(D);}if(this.getSmartFilterId()){var n=sap.ui.getCore().byId(this.getSmartFilterId());if(n&&n.getEntitySet()===d){var t=this.getModel("_templPriv"),p=t.getProperty('/alp/searchable');if(p){if(n&&n.getAnalyticBindingPath&&n.getConsiderAnalyticalParameters()){try{var A=n.getAnalyticBindingPath();if(A){B=A;}}catch(e){jQuery.sap.log.warning("Mandatory parameters have no values","","AnalyticalListPage");}}}else{this.applyOverlay(this.requiredFilterMessage);return;}}}M.read(B,{async:true,filters:j,sorters:this._sorters,urlParameters:{"$select":r?[r].concat(i).join(","):i.join(","),"$top":l},success:function(q,v){q=D?C.CalculateCriticality(D,q,k.getMeasureField()):q;k._onDataReceived(q);},error:function(q){jQuery.sap.log.error("Error reading URL:"+q);k.applyOverlay(k.technicalIssueMessage);}});}};c.prototype._onDataReceived=function(d){if(!d||!d.results||!d.results.length){this.applyOverlay(this.noDataIssueMessage);return;}F.prototype._onDataReceived.call(this,d.results);this.getModel('__alp_chartJSONModel').setData(d.results);this._chart.setModel(this.getModel('__alp_chartJSONModel'));var e=this.getFixedCount(),f={path:'/',template:new a(this._getChartAggregationSettings()),startIndex:0,length:e};this._chart.bindBars(f);this._chart.setBusy(false);};return c;},true);
